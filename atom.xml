<?xml version="1.0" encoding="utf-8"?> 
<feed xmlns="http://www.w3.org/2005/Atom" xml:lang="en">
    <title>Shagun Jhaver</title>
    <link href="https://www.shagunjhaver.com/" rel="alternate" />
    <link href="https://www.shagunjhaver.com/atom.xml" rel="self" />
    <id>https://www.shagunjhaver.com/</id>
    <updated>2023-11-02T10:41:28-04:00</updated>
    <entry>
        <title type="html"><![CDATA[Marginal structural models for panel data with GEE and multilevel models]]></title>
        <link href="https://www.shagunjhaver.com/blog/2021/01/15/msm-gee-multilevel/" rel="alternate" />
        <published>2021-01-15T00:00:00+00:00</published>
        <updated>2021-01-15T00:00:00+00:00</updated>
        <author>
            <name>Shagun Jhaver</name>
        </author>
        <id>https://www.shagunjhaver.com/blog/2021/01/15/msm-gee-multilevel/</id>
        <summary type="html"><![CDATA[Use R to correctly close backdoor confounding in panel data with marginal structural models and inverse probability weights with both GEE and multilevel models]]></summary>
        <content type="html"><![CDATA[<script src="/blog/2021/01/15/msm-gee-multilevel/index_files/kePrint-0.0.1/kePrint.js"></script>
<link href="/blog/2021/01/15/msm-gee-multilevel/index_files/lightable-0.0.1/lightable.css" rel="stylesheet" />
<script src="/blog/2021/01/15/msm-gee-multilevel/index_files/kePrint-0.0.1/kePrint.js"></script>
<link href="/blog/2021/01/15/msm-gee-multilevel/index_files/lightable-0.0.1/lightable.css" rel="stylesheet" />
<script src="/blog/2021/01/15/msm-gee-multilevel/index_files/kePrint-0.0.1/kePrint.js"></script>
<link href="/blog/2021/01/15/msm-gee-multilevel/index_files/lightable-0.0.1/lightable.css" rel="stylesheet" />
<p>Since my last two blog posts on <a href="https://www.andrewheiss.com/blog/2020/12/01/ipw-binary-continuous/">binary and continuous inverse probability weights (IPWs)</a> and <a href="https://www.andrewheiss.com/blog/2020/12/03/ipw-tscs-msm/">marginal structural models (MSMs) for time-series cross-sectional (TSCS) panel data</a>, I’ve spent a ton of time trying to figure out why I couldn’t recover the exact causal effect I had built in to those examples when using panel data. It was a mystery, and it took weeks to figure out what was happening.</p>
<p>After poring through all sorts of articles on MSMs and TSCS data like <a href="#ref-ThoemmesOng:2016">Thoemmes and Ong</a> (<a href="#ref-ThoemmesOng:2016">2016</a>) and <a href="#ref-BlackwellGlynn:2018">Blackwell and Glynn</a> (<a href="#ref-BlackwellGlynn:2018">2018</a>), along with all sorts of articles on the differences between <a href="https://en.wikipedia.org/wiki/Generalized_estimating_equation">generalized estimating equations (GEEs)</a>, which the epidemiology world (and everyone who does MSMs) seems to love, and multilevel models (which I find a lot more intuitive, and which can be done Bayesianly with <strong>brms</strong>), I <em>finally</em> figured out what was wrong and how to calculate correct IPWs for panel data.</p>
<p>The main issue lies in the synthetic data I had created for those earlier blog posts. <a href="https://www.andrewheiss.com/blog/2020/12/03/ipw-tscs-msm/#simulated-time-series-cross-sectional-data">There, I used the <strong>fabricatr</strong> package to create a country-year panel</a>, which seemed correct and great. However, it didn’t exactly match the data-generating process in situations where the value in one time period (like <code>\(X_t\)</code>) depends on the value from the previous time period (or <code>\(X_{t-1}\)</code>), or autocorrelation. As such, I couldn’t quite get the correct causal effects out (since the data didn’t show interdepdency across time).</p>
<p>After lots of struggle, though, I finally figured out a way to explicitly build this autocorrelation in. And thanks to this delightfully accessible article by <a href="#ref-ThoemmesOng:2016">Thoemmes and Ong</a> (<a href="#ref-ThoemmesOng:2016">2016</a>) (<a href="https://anthonyongphd.files.wordpress.com/2016/02/emerging-adulthood-2016-thoemmes-40-59.pdf">ungated free version here</a>), I found clear code for MSMs that I could expand to test on more complex panel data.</p>
<p>In this post, I’ll do a few things: (1) recreate the two-time-period example from Thoemmes and Ong’s appendix (which is stuck in a PDF and really hard to copy/paste out), (2) redo their two-period example with a tidier approach, and (3) expand their two-period approach to multiple years and replace GEEs with multilevel models.</p>
<p>Here we go!</p>
<h2 id="contents----omit-in-toc---">Contents <!-- omit in toc --></h2>
<ul>
<li><a href="#synthetic-data-overview">Synthetic data overview</a></li>
<li><a href="#original-two-period-thoemmes-and-ong-results">Original two-period Thoemmes and Ong results</a></li>
<li><a href="#tidier-two-period-results">Tidier two-period results</a></li>
<li><a href="#expansion-to-multiple-period-data">Expansion to multiple-period data</a>
<ul>
<li><a href="#tricky-interdependent-data-generating-process">Tricky interdependent data generating process</a></li>
<li><a href="#multiple-period-marginal-structural-models">Multiple-period marginal structural models</a></li>
</ul>
</li>
<li><a href="#questions-for-the-future">Questions for the future</a></li>
<li><a href="#references">References</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(tidyverse)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(broom)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(ggdag)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(dagitty)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(ipw)  <span style="color:#75715e"># For automatically calculating IPWs</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(geepack)  <span style="color:#75715e"># For GEE models</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(lme4)  <span style="color:#75715e"># For mixed/multilevel models</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(broom.mixed)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">library</span>(kableExtra)
</span></span></code></pre></div><h2 id="synthetic-data-overview">Synthetic data overview</h2>
<p>In their paper, Thoemmes and Ong create simulated data based on this DAG, with a time-varying treatment, a non-time-varying confounder, and a time-varying outcome (depression):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#75715e"># I generally prefer the easier-to-read formula syntax in dagify() (i.e. D1 ~ T1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># + C, etc.), but it doesn&#39;t work with subscripted numbers like T[1], so we have</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># to use this dagitty syntax instead</span>
</span></span><span style="display:flex;"><span>depression_dag <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dagitty</span>(<span style="color:#e6db74">&#39;dag {
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;C&#34; [pos=&#34;2.5,2&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;T[1]&#34; [pos=&#34;1,1&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;D[1]&#34; [pos=&#34;2,1&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;T[2]&#34; [pos=&#34;3,1&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;D[2]&#34; [pos=&#34;4,1&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;C&#34; -&gt; &#34;D[1]&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;C&#34; -&gt; &#34;D[2]&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;C&#34; -&gt; &#34;T[1]&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;C&#34; -&gt; &#34;T[2]&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;D[1]&#34; -&gt; &#34;T[2]&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;T[1]&#34; -&gt; &#34;D[1]&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">&#34;T[2]&#34; -&gt; &#34;D[2]&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">}&#39;</span>) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">tidy_dagitty</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">ggplot</span>(depression_dag, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> x, y <span style="color:#f92672">=</span> y, xend <span style="color:#f92672">=</span> xend, yend <span style="color:#f92672">=</span> yend)) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">geom_dag_edges</span>() <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">geom_dag_point</span>(color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;grey80&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">12</span>) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">geom_dag_text</span>(color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;black&#34;</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>, parse <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>) <span style="color:#f92672">+</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">theme_dag</span>()
</span></span></code></pre></div><img src="/blog/2021/01/15/msm-gee-multilevel/index_files/figure-html/depression-dag-1.png" width="75%" style="display: block; margin: auto;" />
<p>Essentially earlier treatment ($T_1$) causes some level of depression ($D_1$), which causes later treatment ($T_2$), which causes later depression ($D_2$). This whole chain is influenced by some non-varying confounder ($C$).</p>
<h2 id="original-two-period-thoemmes-and-ong-results">Original two-period Thoemmes and Ong results</h2>
<p>Here’s the original code from the appendix of <a href="#ref-ThoemmesOng:2016">Thoemmes and Ong</a> (<a href="#ref-ThoemmesOng:2016">2016</a>) for data with a time-varying continuous treatment and a confounder. It explicitly creates columns for <code>t1</code>, <code>d1</code>, <code>t2</code>, and <code>d2</code>, so it is easy to mathematically make it so that <code>t2</code> is caused by <code>d1</code>.</p>
<p>Because it’s only two time periods, they calculate the inverse probability weights in two formulas and then multiply them together:</p>
<ul>
<li>
<p>Weights for the first time period:</p>
<p>$$
w_1 = \frac{\phi(T_{i1})}{\phi(T_{i1}\ |\ C)}
$$</p>
</li>
<li>
<p>Weights for the second time period:</p>
<p>$$
w_2 = \frac{\phi(T_{i2}\ |\ T_{i1})}{\phi(T_{i2}\ |\ C, T_{i1}, D_{i1})}
$$</p>
</li>
<li>
<p>Final weights:</p>
<p>$$
w = w_1 \cdot w_2
$$</p>
</li>
</ul>
<p>Here’s their code:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#75715e">##################################################################### </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># iptw demo with time-varying continuous treatment and confounder</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#####################################################################</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Felix Thoemmes, October, 2015 </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#####################################################################</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#set seed to replicate results</span>
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">12345</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define sample size</span>
</span></span><span style="display:flex;"><span>n <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">2000</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define confounder c</span>
</span></span><span style="display:flex;"><span>c <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rnorm</span>(n,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define treatment at time 1 as function of confounder</span>
</span></span><span style="display:flex;"><span>t1 <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">.1</span><span style="color:#f92672">*</span>c <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(n,<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">sqrt</span>(<span style="color:#ae81ff">.99</span>))
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define depression at time 1 as function of confounder and treat1</span>
</span></span><span style="display:flex;"><span>d1 <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">.1</span><span style="color:#f92672">*</span>c <span style="color:#f92672">+</span> <span style="color:#ae81ff">.4</span><span style="color:#f92672">*</span>t1 <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(n,<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">sqrt</span>(<span style="color:#ae81ff">.822</span>))
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define treatment at time 2 as function of confounder and dep1</span>
</span></span><span style="display:flex;"><span>t2 <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">.1</span><span style="color:#f92672">*</span>c <span style="color:#f92672">+</span> <span style="color:#ae81ff">.4</span><span style="color:#f92672">*</span>d1 <span style="color:#f92672">+</span> <span style="color:#ae81ff">.4</span><span style="color:#f92672">*</span>t1 <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(n,<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">sqrt</span>(<span style="color:#ae81ff">.5196</span>))
</span></span><span style="display:flex;"><span><span style="color:#75715e">#define outcome depression at time 2 as function of confounder, treat1, and dep1 </span>
</span></span><span style="display:flex;"><span>d2 <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">.1</span><span style="color:#f92672">*</span>c <span style="color:#f92672">+</span> <span style="color:#ae81ff">.4</span><span style="color:#f92672">*</span>t2 <span style="color:#f92672">+</span> <span style="color:#ae81ff">.4</span><span style="color:#f92672">*</span>d1 <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(n,<span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">sqrt</span>(<span style="color:#ae81ff">.4582</span>))
</span></span><span style="display:flex;"><span><span style="color:#75715e">#add ID variable to do mixed effects models later</span>
</span></span><span style="display:flex;"><span>id <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">rep</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#a6e22e">length</span>(c))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>df1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">data.frame</span>(id, c, t1, d1, t2, d2)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#compute the weights for timepoint 1</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#this is a continuous treatment</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#therefore we use densities of normal distributions</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#weights at time 1</span>
</span></span><span style="display:flex;"><span>w1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dnorm</span>(df1<span style="color:#f92672">$</span>t1, <span style="color:#a6e22e">predict</span>(<span style="color:#a6e22e">lm</span>(t1 <span style="color:#f92672">~</span> <span style="color:#ae81ff">1</span>)), <span style="color:#a6e22e">sd</span>(<span style="color:#a6e22e">lm</span>(t1 <span style="color:#f92672">~</span> <span style="color:#ae81ff">1</span>)<span style="color:#f92672">$</span>residuals)) <span style="color:#f92672">/</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">dnorm</span>(df1<span style="color:#f92672">$</span>t1, <span style="color:#a6e22e">predict</span>(<span style="color:#a6e22e">lm</span>(t1 <span style="color:#f92672">~</span> c)), <span style="color:#a6e22e">sd</span>(<span style="color:#a6e22e">lm</span>(t1 <span style="color:#f92672">~</span> c)<span style="color:#f92672">$</span>residuals))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#weights at time 2</span>
</span></span><span style="display:flex;"><span>w2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dnorm</span>(df1<span style="color:#f92672">$</span>t2, <span style="color:#a6e22e">predict</span>(<span style="color:#a6e22e">lm</span>(t2 <span style="color:#f92672">~</span> t1)), <span style="color:#a6e22e">sd</span>(<span style="color:#a6e22e">lm</span>(t2 <span style="color:#f92672">~</span> t1)<span style="color:#f92672">$</span>residuals)) <span style="color:#f92672">/</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">dnorm</span>(df1<span style="color:#f92672">$</span>t2, <span style="color:#a6e22e">predict</span>(<span style="color:#a6e22e">lm</span>(t2 <span style="color:#f92672">~</span> c <span style="color:#f92672">+</span> d1 <span style="color:#f92672">+</span> t1)), <span style="color:#a6e22e">sd</span>(<span style="color:#a6e22e">lm</span>(t2 <span style="color:#f92672">~</span> c <span style="color:#f92672">+</span> d1 <span style="color:#f92672">+</span> t1)<span style="color:#f92672">$</span>residuals)) 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#total weights are a product of all time-varying weights</span>
</span></span><span style="display:flex;"><span>w <span style="color:#f92672">&lt;-</span> w1<span style="color:#f92672">*</span>w2
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#truncate weights at 5%</span>
</span></span><span style="display:flex;"><span>tw1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ifelse</span>(w <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">quantile</span>(w, probs <span style="color:#f92672">=</span> <span style="color:#ae81ff">.05</span>), <span style="color:#a6e22e">quantile</span>(w, probs <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.05</span>), w)
</span></span><span style="display:flex;"><span>tw1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ifelse</span>(w <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">quantile</span>(w, probs <span style="color:#f92672">=</span> <span style="color:#ae81ff">.95</span>), <span style="color:#a6e22e">quantile</span>(w, probs <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.95</span>), tw1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#truncate weights at 1%</span>
</span></span><span style="display:flex;"><span>tw2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ifelse</span>(w <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">quantile</span>(w, probs <span style="color:#f92672">=</span> <span style="color:#ae81ff">.01</span>), <span style="color:#a6e22e">quantile</span>(w, probs <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.01</span>), w)
</span></span><span style="display:flex;"><span>tw2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ifelse</span>(w <span style="color:#f92672">&gt;</span> <span style="color:#a6e22e">quantile</span>(w, probs <span style="color:#f92672">=</span> <span style="color:#ae81ff">.99</span>), <span style="color:#a6e22e">quantile</span>(w, probs <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.99</span>), tw2)
</span></span></code></pre></div><p>They they run a bunch of different outcome models with <code>geeglm()</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>only_t1 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">geeglm</span>(d2 <span style="color:#f92672">~</span> t1, data <span style="color:#f92672">=</span> df1, id <span style="color:#f92672">=</span> <span style="color:#a6e22e">rownames</span>(df1))
</span></span><span style="display:flex;"><span>only_t2 <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">geeglm</span>(d2 <span style="color:#f92672">~</span> t2, data <span style="color:#f92672">=</span> df1, id <span style="color:#f92672">=</span> <span style="color:#a6e22e">rownames</span>(df1))
</span></span><span style="display:flex;"><span>both_t <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">geeglm</span>(d2 <span style="color:#f92672">~</span> t1 <span style="color:#f92672">+</span> t2, data <span style="color:#f92672">=</span> df1, id <span style="color:#f92672">=</span> <span style="color:#a6e22e">rownames</span>(df1))
</span></span><span style="display:flex;"><span>both_t_c <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">geeglm</span>(d2 <span style="color:#f92672">~</span> t1 <span style="color:#f92672">+</span> t2 <span style="color:#f92672">+</span> c <span style="color:#f92672">+</span> d1, data <span style="color:#f92672">=</span> df1, id <span style="color:#f92672">=</span> <span style="color:#a6e22e">rownames</span>(df1))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>stab_ipw <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">geeglm</span>(d2 <span style="color:#f92672">~</span> t1 <span style="color:#f92672">+</span> t2, data <span style="color:#f92672">=</span> df1, id <span style="color:#f92672">=</span> <span style="color:#a6e22e">rownames</span>(df1), weights <span style="color:#f92672">=</span> w)
</span></span><span style="display:flex;"><span>stab_ipw_1p <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">geeglm</span>(d2 <span style="color:#f92672">~</span> t1 <span style="color:#f92672">+</span> t2, data <span style="color:#f92672">=</span> df1, id <span style="color:#f92672">=</span> <span style="color:#a6e22e">rownames</span>(df1), weights <span style="color:#f92672">=</span> tw2)
</span></span><span style="display:flex;"><span>stab_ipw_5p <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">geeglm</span>(d2 <span style="color:#f92672">~</span> t1 <span style="color:#f92672">+</span> t2, data <span style="color:#f92672">=</span> df1, id <span style="color:#f92672">=</span> <span style="color:#a6e22e">rownames</span>(df1), weights <span style="color:#f92672">=</span> tw1)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>results <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tribble</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">~</span>`Method`, <span style="color:#f92672">~</span>`T&lt;sub&gt;1&lt;/sub&gt; effect`, <span style="color:#f92672">~</span>`T&lt;sub&gt;2&lt;/sub&gt; effect`,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;True effect&#34;</span>, <span style="color:#ae81ff">0.160</span>, <span style="color:#ae81ff">0.400</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Naive, only T1&#34;</span>, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(only_t1), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t1&#34;</span>)<span style="color:#f92672">$</span>estimate, <span style="color:#66d9ef">NA</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Naive, only T2&#34;</span>, <span style="color:#66d9ef">NA</span>, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(only_t2), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t2&#34;</span>)<span style="color:#f92672">$</span>estimate,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Naive, both&#34;</span>, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(both_t), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t1&#34;</span>)<span style="color:#f92672">$</span>estimate, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(both_t), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t2&#34;</span>)<span style="color:#f92672">$</span>estimate,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Naive, both + controls&#34;</span>, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(both_t_c), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t1&#34;</span>)<span style="color:#f92672">$</span>estimate, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(both_t_c), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t2&#34;</span>)<span style="color:#f92672">$</span>estimate,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;IPW&#34;</span>, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(stab_ipw), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t1&#34;</span>)<span style="color:#f92672">$</span>estimate, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(stab_ipw), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t2&#34;</span>)<span style="color:#f92672">$</span>estimate,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;IPW, 1% truncated&#34;</span>, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(stab_ipw_1p), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t1&#34;</span>)<span style="color:#f92672">$</span>estimate, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(stab_ipw_1p), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t2&#34;</span>)<span style="color:#f92672">$</span>estimate,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;IPW, 5% truncated&#34;</span>, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(stab_ipw_5p), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t1&#34;</span>)<span style="color:#f92672">$</span>estimate, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(stab_ipw_5p), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t2&#34;</span>)<span style="color:#f92672">$</span>estimate
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><table style="width:70%; margin-left: auto; margin-right: auto;" class=" pure-table pure-table-horizontal">
<thead>
<tr>
<th style="text-align:left;">
Method
</th>
<th style="text-align:right;">
T<sub>1</sub> effect
</th>
<th style="text-align:right;">
T<sub>2</sub> effect
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
True effect
</td>
<td style="text-align:right;">
0.160
</td>
<td style="text-align:right;">
0.400
</td>
</tr>
<tr>
<td style="text-align:left;">
Naive, only T1
</td>
<td style="text-align:right;">
0.423
</td>
<td style="text-align:right;">
—
</td>
</tr>
<tr>
<td style="text-align:left;">
Naive, only T2
</td>
<td style="text-align:right;">
—
</td>
<td style="text-align:right;">
0.649
</td>
</tr>
<tr>
<td style="text-align:left;">
Naive, both
</td>
<td style="text-align:right;">
0.048
</td>
<td style="text-align:right;">
0.623
</td>
</tr>
<tr>
<td style="text-align:left;">
Naive, both + controls
</td>
<td style="text-align:right;">
0.011
</td>
<td style="text-align:right;">
0.399
</td>
</tr>
<tr>
<td style="text-align:left;">
IPW
</td>
<td style="text-align:right;">
0.157
</td>
<td style="text-align:right;">
0.421
</td>
</tr>
<tr>
<td style="text-align:left;">
IPW, 1% truncated
</td>
<td style="text-align:right;">
0.154
</td>
<td style="text-align:right;">
0.434
</td>
</tr>
<tr>
<td style="text-align:left;">
IPW, 5% truncated
</td>
<td style="text-align:right;">
0.131
</td>
<td style="text-align:right;">
0.480
</td>
</tr>
</tbody>
</table>
<p>And here’s all that compared to what they have in the paper:</p>
<img src="ThoemmesOng-Table2.png" width="50%" style="display: block; margin: auto;" />
<p>It’s identical! I’m chalking any tiny differences up to the fact that <code>set.seed()</code> changed with R 4.0 and they used R 3.x in their paper. (Also the T2-only model is wrong, but that’s probably a typo—the “estimated scale parameter” from that model is 0.574 with an sd of 0.018, which lines up perfectly with the coefficient in the published table, so I think maybe the published paper has the wrong number in the table.)</p>
<p>Also, there seems to be another typo in that table. The true effect of T1 in the table is 0.140, but in the text of the paper, it says the effect should be 0.160, which makes sense—that’s the product of 0.4 × 0.4, or each of the treatment coefficients ($0.4 \times 0.4 = 0.16$).</p>
<p>Regardless of those super tiny insignificant typos, we did it! We have their exact results using marginal structural models and inverse probability weights.</p>
<h2 id="tidier-two-period-results">Tidier two-period results</h2>
<p>The code to generate that data isn’t very tidyverse-friendly and it creates a ton of intermediate vectors. Here’s a cleaner version with <strong>dplyr</strong>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">12345</span>)
</span></span><span style="display:flex;"><span>n <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">2000</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>df_nice <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tibble</span>(id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>n,
</span></span><span style="display:flex;"><span>                  c <span style="color:#f92672">=</span> <span style="color:#a6e22e">rnorm</span>(n, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>)) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mutate</span>(t1 <span style="color:#f92672">=</span> (<span style="color:#ae81ff">0.1</span> <span style="color:#f92672">*</span> c) <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(n, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">sqrt</span>(<span style="color:#ae81ff">0.99</span>)),
</span></span><span style="display:flex;"><span>         d1 <span style="color:#f92672">=</span> (<span style="color:#ae81ff">0.1</span> <span style="color:#f92672">*</span> c) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.4</span> <span style="color:#f92672">*</span> t1) <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(n, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">sqrt</span>(<span style="color:#ae81ff">0.822</span>)),
</span></span><span style="display:flex;"><span>         t2 <span style="color:#f92672">=</span> (<span style="color:#ae81ff">0.1</span> <span style="color:#f92672">*</span> c) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.4</span> <span style="color:#f92672">*</span> d1) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.4</span> <span style="color:#f92672">*</span> t1) <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(n, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">sqrt</span>(<span style="color:#ae81ff">0.5196</span>)),
</span></span><span style="display:flex;"><span>         d2 <span style="color:#f92672">=</span> (<span style="color:#ae81ff">0.1</span> <span style="color:#f92672">*</span> c) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.4</span> <span style="color:#f92672">*</span> t2) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.4</span> <span style="color:#f92672">*</span> d1) <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(n, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">sqrt</span>(<span style="color:#ae81ff">0.4582</span>)))
</span></span></code></pre></div><p>Also, this original data is wide, with explicit columns for each time period. Let’s make it tidy and pretend the time periods are years (<code>y</code>) and add some lagged columns:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>df_tidy <span style="color:#f92672">&lt;-</span> df_nice <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">pivot_longer</span>(cols <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(t1, d1, t2, d2)) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">separate</span>(name, into <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;variable&#34;</span>, <span style="color:#e6db74">&#34;y&#34;</span>), sep <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">pivot_wider</span>(names_from <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;variable&#34;</span>, values_from <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;value&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">group_by</span>(id) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mutate</span>(<span style="color:#a6e22e">across</span>(<span style="color:#a6e22e">c</span>(t, d), <span style="color:#a6e22e">list</span>(lag <span style="color:#f92672">=</span> lag))) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ungroup</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">head</span>(df_tidy)
</span></span><span style="display:flex;"><span><span style="color:#75715e">## # A tibble: 6 x 7</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##      id      c y           t       d  t_lag   d_lag</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##   &lt;int&gt;  &lt;dbl&gt; &lt;chr&gt;   &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 1     1  0.586 1     -0.546  -1.11   NA     NA     </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 2     1  0.586 2     -0.853  -1.73   -0.546 -1.11  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 3     2  0.709 1      1.14    0.361  NA     NA     </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 4     2  0.709 2     -0.0673 -1.30    1.14   0.361 </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 5     3 -0.109 1     -0.584  -0.0822 NA     NA     </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 6     3 -0.109 2     -0.932   0.535  -0.584 -0.0822</span>
</span></span></code></pre></div><p>This is how panel data is typically structured, with rows repeated for each time period. This is good because we can figure out how to structure the weight models and outcome model in a way that uses this structure and compare it to the original <code>t1</code>, <code>d1</code>, etc. models.</p>
<p>Because there are only two time periods, the lagged columns here are missing a ton of data (since you can’t see what the value is for year 0), but it’ll still work.</p>
<p>With the data like this, we can find the weights. We’ll do it both manually and with the <strong>ipw</strong> package.</p>
<p>Manually, we need to fit two models (a numerator and denominator) and then take the cumulative product of their probability distributions:</p>
<p>$$
w = \prod^t_{t = 1} \frac{\phi(T_{it} | T_{i, t-1}, C_i)}{\phi(T_{it} | T_{i, t-1}, D_{i, t-1}, C_i)}
$$</p>
<p>Here we go!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#75715e"># Remove NAs since ipwpoint() will complain</span>
</span></span><span style="display:flex;"><span>df_tidy_sans_na <span style="color:#f92672">&lt;-</span> df_tidy <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">filter</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">is.na</span>(t_lag))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Manually</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Numerator is lagged treatment + non-varying confounders</span>
</span></span><span style="display:flex;"><span>model_num <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(t <span style="color:#f92672">~</span> t_lag <span style="color:#f92672">+</span> c,
</span></span><span style="display:flex;"><span>                data <span style="color:#f92672">=</span> df_tidy_sans_na)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Denominator is lagged treatment, lagged outcome, time-varying confounders +</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># non-varying confounders</span>
</span></span><span style="display:flex;"><span>model_denom <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(t <span style="color:#f92672">~</span> t_lag <span style="color:#f92672">+</span> d_lag <span style="color:#f92672">+</span> c, 
</span></span><span style="display:flex;"><span>                  data <span style="color:#f92672">=</span> df_tidy_sans_na)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Probability distributions</span>
</span></span><span style="display:flex;"><span>num <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dnorm</span>(df_tidy_sans_na<span style="color:#f92672">$</span>t,
</span></span><span style="display:flex;"><span>             <span style="color:#a6e22e">predict</span>(model_num),
</span></span><span style="display:flex;"><span>             <span style="color:#a6e22e">sd</span>(<span style="color:#a6e22e">residuals</span>(model_num)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>den <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dnorm</span>(df_tidy_sans_na<span style="color:#f92672">$</span>t,
</span></span><span style="display:flex;"><span>             <span style="color:#a6e22e">predict</span>(model_denom),
</span></span><span style="display:flex;"><span>             <span style="color:#a6e22e">sd</span>(<span style="color:#a6e22e">residuals</span>(model_denom)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Make num/den fraction and find cumulative product within each id</span>
</span></span><span style="display:flex;"><span>df_weights_manual <span style="color:#f92672">&lt;-</span> df_tidy_sans_na <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mutate</span>(weights_no_time <span style="color:#f92672">=</span> num <span style="color:#f92672">/</span> den) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">group_by</span>(id) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mutate</span>(ipw <span style="color:#f92672">=</span> <span style="color:#a6e22e">cumprod</span>(weights_no_time)) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ungroup</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Automatically find weights with ipw::ipwpoint()</span>
</span></span><span style="display:flex;"><span>tidy_weights_auto <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ipwpoint</span>(
</span></span><span style="display:flex;"><span>  exposure <span style="color:#f92672">=</span> t,
</span></span><span style="display:flex;"><span>  family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gaussian&#34;</span>, 
</span></span><span style="display:flex;"><span>  numerator <span style="color:#f92672">=</span> <span style="color:#f92672">~</span> t_lag <span style="color:#f92672">+</span> c, 
</span></span><span style="display:flex;"><span>  denominator <span style="color:#f92672">=</span> <span style="color:#f92672">~</span> t_lag <span style="color:#f92672">+</span> d_lag <span style="color:#f92672">+</span> c, 
</span></span><span style="display:flex;"><span>  data <span style="color:#f92672">=</span> <span style="color:#a6e22e">as.data.frame</span>(df_tidy_sans_na))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>df_weights_auto <span style="color:#f92672">&lt;-</span> df_tidy_sans_na <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mutate</span>(ipw <span style="color:#f92672">=</span> tidy_weights_auto<span style="color:#f92672">$</span>ipw.weights)
</span></span></code></pre></div><p>Now we can use these new weights in the outcome model:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>model_lags_manual <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">geeglm</span>(d <span style="color:#f92672">~</span> t <span style="color:#f92672">+</span> t_lag, data <span style="color:#f92672">=</span> df_weights_manual,
</span></span><span style="display:flex;"><span>                            id <span style="color:#f92672">=</span> id, weights <span style="color:#f92672">=</span> ipw)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model_lags_auto <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">geeglm</span>(d <span style="color:#f92672">~</span> t <span style="color:#f92672">+</span> t_lag, data <span style="color:#f92672">=</span> df_weights_auto, 
</span></span><span style="display:flex;"><span>                          id <span style="color:#f92672">=</span> id, weights <span style="color:#f92672">=</span> ipw)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>results <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tribble</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">~</span>`Method`, <span style="color:#f92672">~</span>`T&lt;sub&gt;1&lt;/sub&gt; effect`, <span style="color:#f92672">~</span>`T&lt;sub&gt;2&lt;/sub&gt; effect`,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;True effect&#34;</span>, <span style="color:#ae81ff">0.160</span>, <span style="color:#ae81ff">0.400</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;IPW, original&#34;</span>, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(stab_ipw), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t1&#34;</span>)<span style="color:#f92672">$</span>estimate, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(stab_ipw), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t2&#34;</span>)<span style="color:#f92672">$</span>estimate,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;IPW, lagged, manual&#34;</span>, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(model_lags_manual), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t_lag&#34;</span>)<span style="color:#f92672">$</span>estimate, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(model_lags_manual), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t&#34;</span>)<span style="color:#f92672">$</span>estimate,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;IPW, lagged, automatic&#34;</span>, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(model_lags_auto), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t_lag&#34;</span>)<span style="color:#f92672">$</span>estimate, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(model_lags_auto), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t&#34;</span>)<span style="color:#f92672">$</span>estimate
</span></span><span style="display:flex;"><span>) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mutate</span>(<span style="color:#a6e22e">across</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">:</span><span style="color:#ae81ff">3</span>, <span style="color:#f92672">~</span><span style="color:#a6e22e">sprintf</span>(<span style="color:#e6db74">&#34;%.3f&#34;</span>, <span style="color:#a6e22e">round</span>(., <span style="color:#ae81ff">3</span>)))) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">add_row</span>(`T&lt;sub&gt;1&lt;/sub&gt; effect` <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;b&gt;lag(T) effect&lt;/b&gt;&#34;</span>, 
</span></span><span style="display:flex;"><span>          `T&lt;sub&gt;2&lt;/sub&gt; effect` <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;b&gt;T effect&lt;/b&gt;&#34;</span>, 
</span></span><span style="display:flex;"><span>          .after <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)
</span></span></code></pre></div><table style="width:70%; margin-left: auto; margin-right: auto;" class=" pure-table pure-table-horizontal">
<thead>
<tr>
<th style="text-align:left;">
Method
</th>
<th style="text-align:left;">
T<sub>1</sub> effect
</th>
<th style="text-align:left;">
T<sub>2</sub> effect
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
True effect
</td>
<td style="text-align:left;">
0.160
</td>
<td style="text-align:left;">
0.400
</td>
</tr>
<tr>
<td style="text-align:left;">
IPW, original
</td>
<td style="text-align:left;">
0.157
</td>
<td style="text-align:left;">
0.421
</td>
</tr>
<tr>
<td style="text-align:left;">
—
</td>
<td style="text-align:left;">
<b>lag(T) effect</b>
</td>
<td style="text-align:left;">
<b>T effect</b>
</td>
</tr>
<tr>
<td style="text-align:left;">
IPW, lagged, manual
</td>
<td style="text-align:left;">
0.150
</td>
<td style="text-align:left;">
0.441
</td>
</tr>
<tr>
<td style="text-align:left;">
IPW, lagged, automatic
</td>
<td style="text-align:left;">
0.150
</td>
<td style="text-align:left;">
0.441
</td>
</tr>
</tbody>
</table>
<p>Those results aren’t identical (I don’t know why!), but they’re close-ish, so whatever. It worked! Instead of using explicit <code>t1</code>, <code>d1</code>, etc. columns, we can do the same marginal structural model with just <code>t</code> and <code>d</code> in a long data frame.</p>
<h2 id="expansion-to-multiple-period-data">Expansion to multiple-period data</h2>
<p>Since that’s all working, now we can do something a little/lot trickier—instead of manually specifying <code>\(T_1\)</code> and <code>\(T_2\)</code>, which isn’t really easily scalable to more time periods, we’ll construct the data more generally for any number of years</p>
<h3 id="tricky-interdependent-data-generating-process">Tricky interdependent data generating process</h3>
<p>The trick here is that we want to have any number of time periods, but also maintain the same DAG relationships. In the small data, these are the two general relationships:</p>
<ul>
<li><code>\(\text{treatment}_t = (0.1 \cdot \text{confounder}) + (0.4 \cdot \text{depression}_{t-1}) + (0.4 \cdot \text{treatment}_{t-1}) + \text{noise}\)</code></li>
<li><code>\(\text{depression}_t = (0.1 \cdot \text{confounder}) + (0.4 \cdot \text{treatment}_{t}) + (0.4 \cdot \text{depression}_{t-1}) + \text{noise}\)</code></li>
</ul>
<p>Or in code:</p>
<ul>
<li><code>t = (0.1 * c) + (0.4 * lag(d)) + (0.4 * lag(t)) + rnorm(n, 0, sqrt(0.5196))</code></li>
<li><code>d = (0.1 * c) + (0.4 * t) + (0.4 * lag(d)) + rnorm(n, 0, sqrt(0.4582))</code></li>
</ul>
<p>Generating this data in a tidy <strong>dplyr</strong> way is super tricky, since the <code>t</code> and <code>d</code> columns are interdependent—the data has to be generated rowwise, but we also have to be able to look back a row to get the lagged values of <code>t</code> and <code>d</code>. I’ve seen people like <a href="#ref-BlackwellGlynn:2018">Blackwell and Glynn</a> (<a href="#ref-BlackwellGlynn:2018">2018</a>) get around this by using a <code>for</code> loop to build the data, but I have an aversion to for loops in R <a href="https://r4ds.had.co.nz/iteration.html#for-loops-vs.-functionals">since <strong>purrr</strong> exists</a>, so I spent way too much time trying to figure out a <strong>purrr</strong>-based way to do this. Others have tried this (like <a href="https://community.rstudio.com/t/row-wise-iteration-in-a-dataframe-with-interdependent-variables/38778">this RStudio Community post</a>), and I <a href="https://twitter.com/andrewheiss/status/1347780639714664448">asked about it on Twitter</a>, where I got a few cool solutions using <code>purrr::accumulate()</code> and <code>purrr::reduce()</code>, like <a href="https://twitter.com/ianmoran011/status/1347849678696574977">this fancy <code>accumutate()</code> function from Ian Moran</a> and <a href="https://gist.github.com/andrewheiss/89ae26a7a4682aff0ee9b7db1e92c326#gistcomment-3587810">these solutions from Miles McBain</a>.</p>
<p>There are no loops involved in those solutions, but phew that accumulate/reduce syntax is wonky and I can’t fully wrap my head around it (plus it makes it hard to carry over non-accumulated variables). So I resorted to a loop. Oooof.</p>
<p>It works, though! Let’s test it on just one ID. We’ll generate just one row with <code>t1</code>, <code>t2</code>, <code>d1</code>, and <code>d2</code>, and we’ll remove the noise from each of the columns:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">12345</span>)
</span></span><span style="display:flex;"><span>n <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Remove all noise so that we can compare this with the function version</span>
</span></span><span style="display:flex;"><span>df_example <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tibble</span>(id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>n,
</span></span><span style="display:flex;"><span>                     c <span style="color:#f92672">=</span> <span style="color:#a6e22e">rnorm</span>(n, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>)) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mutate</span>(t1 <span style="color:#f92672">=</span> (<span style="color:#ae81ff">0.1</span> <span style="color:#f92672">*</span> c),
</span></span><span style="display:flex;"><span>         d1 <span style="color:#f92672">=</span> (<span style="color:#ae81ff">0.1</span> <span style="color:#f92672">*</span> c) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.4</span> <span style="color:#f92672">*</span> t1),
</span></span><span style="display:flex;"><span>         t2 <span style="color:#f92672">=</span> (<span style="color:#ae81ff">0.1</span> <span style="color:#f92672">*</span> c) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.4</span> <span style="color:#f92672">*</span> d1) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.4</span> <span style="color:#f92672">*</span> t1),
</span></span><span style="display:flex;"><span>         d2 <span style="color:#f92672">=</span> (<span style="color:#ae81ff">0.1</span> <span style="color:#f92672">*</span> c) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.4</span> <span style="color:#f92672">*</span> t2) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.4</span> <span style="color:#f92672">*</span> d1))
</span></span><span style="display:flex;"><span>df_example
</span></span><span style="display:flex;"><span><span style="color:#75715e">## # A tibble: 1 x 6</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##      id     c     t1     d1    t2    d2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##   &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 1     1 0.586 0.0586 0.0820 0.115 0.137</span>
</span></span></code></pre></div><p>This isn’t tidy data, so technically there are two years here. We’ll keep <code>t1</code> and <code>d1</code> as the initial values for year 1, then generate values for 5 years. If we do this right, the <code>t</code> and <code>d</code> values for year 2 should be identical to <code>t2</code> and <code>d2</code> here.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#75715e"># Add a bunch of extra years with empty cells for t and d</span>
</span></span><span style="display:flex;"><span>df_multiple_years_empty <span style="color:#f92672">&lt;-</span> df_example <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mutate</span>(y <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">select</span>(id, y, t <span style="color:#f92672">=</span> t1, d <span style="color:#f92672">=</span> d1, c) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">add_row</span>(y <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span><span style="color:#ae81ff">5</span>) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># c doesn&#39;t vary across time</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mutate</span>(id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, 
</span></span><span style="display:flex;"><span>         c <span style="color:#f92672">=</span> df_example<span style="color:#f92672">$</span>c[1])
</span></span><span style="display:flex;"><span>df_multiple_years_empty
</span></span><span style="display:flex;"><span><span style="color:#75715e">## # A tibble: 5 x 5</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##      id     y       t       d     c</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##   &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;   &lt;dbl&gt; &lt;dbl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 1     1     1  0.0586  0.0820 0.586</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 2     1     2 NA      NA      0.586</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 3     1     3 NA      NA      0.586</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 4     1     4 NA      NA      0.586</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 5     1     5 NA      NA      0.586</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Now we need to build the interdependent values for t and d with &lt;gasp&gt; a loop</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># The loop is inside this function---it skips the initial row and then</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># iteratively adds new rows. We can&#39;t use neat things like lag(t), so instead</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># we use df$t[i - 1]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># We omit the extra noise for now</span>
</span></span><span style="display:flex;"><span>dgp <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(df) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">for </span>(i in <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span><span style="color:#a6e22e">nrow</span>(df)) {
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">$</span>t[i] <span style="color:#f92672">&lt;-</span> (<span style="color:#ae81ff">0.1</span> <span style="color:#f92672">*</span> df<span style="color:#f92672">$</span>c[i]) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.4</span> <span style="color:#f92672">*</span> df<span style="color:#f92672">$</span>d[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>]) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.4</span> <span style="color:#f92672">*</span> df<span style="color:#f92672">$</span>t[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">$</span>d[i] <span style="color:#f92672">&lt;-</span> (<span style="color:#ae81ff">0.1</span> <span style="color:#f92672">*</span> df<span style="color:#f92672">$</span>c[i]) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.4</span> <span style="color:#f92672">*</span> df<span style="color:#f92672">$</span>t[i]) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.4</span> <span style="color:#f92672">*</span> df<span style="color:#f92672">$</span>d[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>])
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  df
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Generate all 5 years</span>
</span></span><span style="display:flex;"><span>df_multiple_years_empty <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">dgp</span>()
</span></span><span style="display:flex;"><span><span style="color:#75715e">## # A tibble: 5 x 5</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##      id     y      t      d     c</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##   &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 1     1     1 0.0586 0.0820 0.586</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 2     1     2 0.115  0.137  0.586</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 3     1     3 0.159  0.177  0.586</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 4     1     4 0.193  0.207  0.586</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 5     1     5 0.219  0.229  0.586</span>
</span></span></code></pre></div><p>If this worked, the <code>t</code> and <code>d</code> values for year 2 should be the same as <code>t2</code> and <code>d2</code> here:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>df_example
</span></span><span style="display:flex;"><span><span style="color:#75715e">## # A tibble: 1 x 6</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##      id     c     t1     d1    t2    d2</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##   &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 1     1 0.586 0.0586 0.0820 0.115 0.137</span>
</span></span></code></pre></div><p>They are!</p>
<p>Since we know it works, let’s generate a big dataset for playing with multi-year MSMs, this time with noise:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">1234</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Make data for the first year</span>
</span></span><span style="display:flex;"><span>df_first_year <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">expand_grid</span>(id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">2000</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mutate</span>(c <span style="color:#f92672">=</span> <span style="color:#a6e22e">rnorm</span>(<span style="color:#a6e22e">n</span>(), <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">1</span>),
</span></span><span style="display:flex;"><span>         t <span style="color:#f92672">=</span> (<span style="color:#ae81ff">0.1</span> <span style="color:#f92672">*</span> c) <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(<span style="color:#a6e22e">n</span>(), <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">sqrt</span>(<span style="color:#ae81ff">0.99</span>)),
</span></span><span style="display:flex;"><span>         d <span style="color:#f92672">=</span> (<span style="color:#ae81ff">0.1</span> <span style="color:#f92672">*</span> c) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.4</span> <span style="color:#f92672">*</span> t) <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(<span style="color:#a6e22e">n</span>(), <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">sqrt</span>(<span style="color:#ae81ff">0.822</span>)))
</span></span><span style="display:flex;"><span>df_first_year
</span></span><span style="display:flex;"><span><span style="color:#75715e">## # A tibble: 2,000 x 5</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##       id     y      c        t       d</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##    &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;    &lt;dbl&gt;   &lt;dbl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  1     1     1 -1.21  -1.09    -1.43  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  2     2     1  0.277 -0.0714  -0.739 </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  3     3     1  1.08  -0.00174 -0.0686</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  4     4     1 -2.35   0.952    1.88  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  5     5     1  0.429 -1.60     0.0373</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  6     6     1  0.506 -0.990    0.535 </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  7     7     1 -0.575 -1.79    -0.889 </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  8     8     1 -0.547  0.456   -1.14  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  9     9     1 -0.564 -0.500    0.386 </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 10    10     1 -0.890 -1.92    -1.04  </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## # … with 1,990 more rows</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add empty years 2-5</span>
</span></span><span style="display:flex;"><span>df_panel_empty <span style="color:#f92672">&lt;-</span> df_first_year <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">bind_rows</span>(<span style="color:#a6e22e">expand_grid</span>(id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">2000</span>, y <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span><span style="color:#ae81ff">5</span>)) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">arrange</span>(id, y)
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">head</span>(df_panel_empty, <span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">## # A tibble: 10 x 5</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##       id     y      c       t      d</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##    &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  1     1     1 -1.21  -1.09   -1.43 </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  2     1     2 NA     NA      NA    </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  3     1     3 NA     NA      NA    </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  4     1     4 NA     NA      NA    </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  5     1     5 NA     NA      NA    </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  6     2     1  0.277 -0.0714 -0.739</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  7     2     2 NA     NA      NA    </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  8     2     3 NA     NA      NA    </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  9     2     4 NA     NA      NA    </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 10     2     5 NA     NA      NA</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Add noise to the fancy dgp() function</span>
</span></span><span style="display:flex;"><span>dgp <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(df) {
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">for </span>(i in <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span><span style="color:#a6e22e">nrow</span>(df)) {
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">$</span>t[i] <span style="color:#f92672">&lt;-</span> (<span style="color:#ae81ff">0.1</span> <span style="color:#f92672">*</span> df<span style="color:#f92672">$</span>c[i]) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.4</span> <span style="color:#f92672">*</span> df<span style="color:#f92672">$</span>d[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>]) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.4</span> <span style="color:#f92672">*</span> df<span style="color:#f92672">$</span>t[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>]) <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">sqrt</span>(<span style="color:#ae81ff">0.5196</span>))
</span></span><span style="display:flex;"><span>    df<span style="color:#f92672">$</span>d[i] <span style="color:#f92672">&lt;-</span> (<span style="color:#ae81ff">0.1</span> <span style="color:#f92672">*</span> df<span style="color:#f92672">$</span>c[i]) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.4</span> <span style="color:#f92672">*</span> df<span style="color:#f92672">$</span>t[i]) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.4</span> <span style="color:#f92672">*</span> df<span style="color:#f92672">$</span>d[i <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>]) <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, <span style="color:#a6e22e">sqrt</span>(<span style="color:#ae81ff">0.4582</span>))
</span></span><span style="display:flex;"><span>  }
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  df
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Run dgp() within each id</span>
</span></span><span style="display:flex;"><span>df_panel <span style="color:#f92672">&lt;-</span> df_panel_empty <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">group_by</span>(id) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># This doesn&#39;t vary with time, so repeat it across all the years</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mutate</span>(c <span style="color:#f92672">=</span> c[1]) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Nest the data into a single cell in each row</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">nest</span>() <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Run dgp() on the nested cell (in a column named &#34;data&#34;)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mutate</span>(dgp <span style="color:#f92672">=</span> <span style="color:#a6e22e">map</span>(data, dgp)) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">select</span>(<span style="color:#f92672">-</span>data) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Unnest the nested dgp()-ed cells</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">unnest</span>(dgp) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Add some lags</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mutate</span>(<span style="color:#a6e22e">across</span>(<span style="color:#a6e22e">c</span>(t, d), <span style="color:#a6e22e">list</span>(lag <span style="color:#f92672">=</span> lag))) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ungroup</span>()
</span></span><span style="display:flex;"><span><span style="color:#a6e22e">head</span>(df_panel, <span style="color:#ae81ff">10</span>)
</span></span><span style="display:flex;"><span><span style="color:#75715e">## # A tibble: 10 x 7</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##       id     y      c       t      d   t_lag  d_lag</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##    &lt;int&gt; &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  1     1     1 -1.21  -1.09   -1.43  NA      NA    </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  2     1     2 -1.21  -1.11   -1.28  -1.09   -1.43 </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  3     1     3 -1.21  -1.83   -1.35  -1.11   -1.28 </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  4     1     4 -1.21  -1.62   -1.20  -1.83   -1.35 </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  5     1     5 -1.21  -1.62   -0.981 -1.62   -1.20 </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  6     2     1  0.277 -0.0714 -0.739 NA      NA    </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  7     2     2  0.277  1.09    0.116 -0.0714 -0.739</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  8     2     3  0.277  1.43    0.562  1.09    0.116</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">##  9     2     4  0.277  0.584  -0.606  1.43    0.562</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">## 10     2     5  0.277 -0.881   0.603  0.584  -0.606</span>
</span></span></code></pre></div><h3 id="multiple-period-marginal-structural-models">Multiple-period marginal structural models</h3>
<p>Cool cool cool. We have multi-period data where variables depend on their lagged values and other interdependent columns. Let’s build some MSMs!</p>
<p>We’re going to build weights two different ways here. Because the data has a time-series cross-sectional structure (with multiple individuals across multiple years), the weight models need to account for that structure. Everywhere I’ve seen elsewhere uses generalized estimating equations (GEEs) for these models (and that’s what the <strong>ipw</strong> package uses behind the scenes), but I’m a fan of multilevel models, so I’ll make weights with both to compare their results.</p>
<p>We’ll use the same equation as before—the cumulative product of the ratio of two probability distributions:</p>
<p>$$
w = \prod^t_{t = 1} \frac{\phi(T_{it} | T_{i, t-1}, C_i)}{\phi(T_{it} | T_{i, t-1}, D_{i, t-1}, C_i)}
$$</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span><span style="color:#75715e"># Again, ipw complains about missing values, so get rid of them (i.e. all year 1)</span>
</span></span><span style="display:flex;"><span>df_panel_sans_na <span style="color:#f92672">&lt;-</span> df_panel <span style="color:#f92672">%&gt;%</span>
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">filter</span>(<span style="color:#f92672">!</span><span style="color:#a6e22e">is.na</span>(t_lag)) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mutate</span>(y <span style="color:#f92672">=</span> <span style="color:#a6e22e">as.numeric</span>(y))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Manually</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Numerator is lagged treatment + non-varying confounders</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># ipw uses GEE models to account for panel structure, so use them here too</span>
</span></span><span style="display:flex;"><span>model_num_gee <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">geeglm</span>(t <span style="color:#f92672">~</span> t_lag <span style="color:#f92672">+</span> c, 
</span></span><span style="display:flex;"><span>                        id <span style="color:#f92672">=</span> id, waves <span style="color:#f92672">=</span> y, corstr <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ar1&#34;</span>,
</span></span><span style="display:flex;"><span>                        data <span style="color:#f92672">=</span> df_panel_sans_na)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># But we can also use mixed models with lmer</span>
</span></span><span style="display:flex;"><span>model_num_multi <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lmer</span>(t <span style="color:#f92672">~</span> t_lag <span style="color:#f92672">+</span> c <span style="color:#f92672">+</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> id),
</span></span><span style="display:flex;"><span>                        data <span style="color:#f92672">=</span> df_panel_sans_na)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Denominator is lagged treatment, lagged outcome, time-varying confounders +</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># non-varying confounders</span>
</span></span><span style="display:flex;"><span>model_denom_gee <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">geeglm</span>(t <span style="color:#f92672">~</span> t_lag <span style="color:#f92672">+</span> d_lag <span style="color:#f92672">+</span> c, 
</span></span><span style="display:flex;"><span>                          id <span style="color:#f92672">=</span> id, waves <span style="color:#f92672">=</span> y, corstr <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ar1&#34;</span>,
</span></span><span style="display:flex;"><span>                          data <span style="color:#f92672">=</span> df_panel_sans_na)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>model_denom_multi <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lmer</span>(t <span style="color:#f92672">~</span> t_lag <span style="color:#f92672">+</span> d_lag <span style="color:#f92672">+</span> c <span style="color:#f92672">+</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> id),
</span></span><span style="display:flex;"><span>                          data <span style="color:#f92672">=</span> df_panel_sans_na)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Probability distributions</span>
</span></span><span style="display:flex;"><span>num_gee <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dnorm</span>(df_panel_sans_na<span style="color:#f92672">$</span>t,
</span></span><span style="display:flex;"><span>             <span style="color:#a6e22e">predict</span>(model_num_gee),
</span></span><span style="display:flex;"><span>             <span style="color:#a6e22e">sd</span>(<span style="color:#a6e22e">residuals</span>(model_num_gee)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>den_gee <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dnorm</span>(df_panel_sans_na<span style="color:#f92672">$</span>t,
</span></span><span style="display:flex;"><span>                 <span style="color:#a6e22e">predict</span>(model_denom_gee),
</span></span><span style="display:flex;"><span>                 <span style="color:#a6e22e">sd</span>(<span style="color:#a6e22e">residuals</span>(model_denom_gee)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>num_multi <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dnorm</span>(df_panel_sans_na<span style="color:#f92672">$</span>t,
</span></span><span style="display:flex;"><span>                   <span style="color:#a6e22e">predict</span>(model_num_multi),
</span></span><span style="display:flex;"><span>                   <span style="color:#a6e22e">sd</span>(<span style="color:#a6e22e">residuals</span>(model_num_multi)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>den_multi <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dnorm</span>(df_panel_sans_na<span style="color:#f92672">$</span>t,
</span></span><span style="display:flex;"><span>                   <span style="color:#a6e22e">predict</span>(model_denom_multi),
</span></span><span style="display:flex;"><span>                   <span style="color:#a6e22e">sd</span>(<span style="color:#a6e22e">residuals</span>(model_denom_multi)))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>df_panel_weights_manual <span style="color:#f92672">&lt;-</span> df_panel_sans_na <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mutate</span>(weights_no_time_gee <span style="color:#f92672">=</span> num_gee <span style="color:#f92672">/</span> den_gee,
</span></span><span style="display:flex;"><span>         weights_no_time_multi <span style="color:#f92672">=</span> num_multi <span style="color:#f92672">/</span> den_multi) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">group_by</span>(id) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mutate</span>(ipw_gee <span style="color:#f92672">=</span> <span style="color:#a6e22e">cumprod</span>(weights_no_time_gee),
</span></span><span style="display:flex;"><span>         ipw_multi <span style="color:#f92672">=</span> <span style="color:#a6e22e">cumprod</span>(weights_no_time_multi)) <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">ungroup</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Automatically with ipwtm()</span>
</span></span><span style="display:flex;"><span>panel_weights_auto <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ipwtm</span>(
</span></span><span style="display:flex;"><span>  exposure <span style="color:#f92672">=</span> t,
</span></span><span style="display:flex;"><span>  family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gaussian&#34;</span>, 
</span></span><span style="display:flex;"><span>  numerator <span style="color:#f92672">=</span> <span style="color:#f92672">~</span> t_lag <span style="color:#f92672">+</span> c, 
</span></span><span style="display:flex;"><span>  denominator <span style="color:#f92672">=</span> <span style="color:#f92672">~</span> t_lag <span style="color:#f92672">+</span> d_lag <span style="color:#f92672">+</span> c, 
</span></span><span style="display:flex;"><span>  id <span style="color:#f92672">=</span> id,
</span></span><span style="display:flex;"><span>  timevar <span style="color:#f92672">=</span> y,
</span></span><span style="display:flex;"><span>  type <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;all&#34;</span>,
</span></span><span style="display:flex;"><span>  corstr <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ar1&#34;</span>,
</span></span><span style="display:flex;"><span>  data <span style="color:#f92672">=</span> <span style="color:#a6e22e">as.data.frame</span>(df_panel_sans_na))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>df_panel_weights_auto <span style="color:#f92672">&lt;-</span> df_panel_sans_na <span style="color:#f92672">%&gt;%</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#a6e22e">mutate</span>(ipw <span style="color:#f92672">=</span> panel_weights_auto<span style="color:#f92672">$</span>ipw.weights)
</span></span></code></pre></div><p>Now we can build the outcome models, using both GEE and multilevel models.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-r" data-lang="r"><span style="display:flex;"><span>m_manual_gee <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">geeglm</span>(d <span style="color:#f92672">~</span> t <span style="color:#f92672">+</span> t_lag, 
</span></span><span style="display:flex;"><span>                       data <span style="color:#f92672">=</span> df_panel_weights_manual,
</span></span><span style="display:flex;"><span>                       id <span style="color:#f92672">=</span> id, waves <span style="color:#f92672">=</span> y, 
</span></span><span style="display:flex;"><span>                       weights <span style="color:#f92672">=</span> ipw_gee)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>m_auto_gee <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">geeglm</span>(d <span style="color:#f92672">~</span> t <span style="color:#f92672">+</span> t_lag, 
</span></span><span style="display:flex;"><span>                     data <span style="color:#f92672">=</span> df_panel_weights_auto, 
</span></span><span style="display:flex;"><span>                     id <span style="color:#f92672">=</span> id, waves <span style="color:#f92672">=</span> y, 
</span></span><span style="display:flex;"><span>                     weights <span style="color:#f92672">=</span> ipw)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>m_lmer_manual_gee_wt <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lmer</span>(d <span style="color:#f92672">~</span> t <span style="color:#f92672">+</span> t_lag <span style="color:#f92672">+</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> id), 
</span></span><span style="display:flex;"><span>                             data <span style="color:#f92672">=</span> df_panel_weights_manual, 
</span></span><span style="display:flex;"><span>                             weights <span style="color:#f92672">=</span> ipw_gee)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>m_lmer_auto_gee_wt <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lmer</span>(d <span style="color:#f92672">~</span> t <span style="color:#f92672">+</span> t_lag <span style="color:#f92672">+</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> id), 
</span></span><span style="display:flex;"><span>                           data <span style="color:#f92672">=</span> df_panel_weights_auto, 
</span></span><span style="display:flex;"><span>                           weights <span style="color:#f92672">=</span> ipw)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>m_lmer_manual_multi_wt <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lmer</span>(d <span style="color:#f92672">~</span> t <span style="color:#f92672">+</span> t_lag <span style="color:#f92672">+</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">|</span> id), 
</span></span><span style="display:flex;"><span>                               data <span style="color:#f92672">=</span> df_panel_weights_manual, 
</span></span><span style="display:flex;"><span>                               weights <span style="color:#f92672">=</span> ipw_multi)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>results <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tribble</span>(
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">~</span>`Method`, <span style="color:#f92672">~</span>`Weights`, <span style="color:#f92672">~</span><span style="color:#a6e22e">`lag</span>(T) effect`, ~`T effect`,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;True effect&#34;</span>, <span style="color:#66d9ef">NA</span>, <span style="color:#ae81ff">0.160</span>, <span style="color:#ae81ff">0.400</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Panel with GEE&#34;</span>, <span style="color:#e6db74">&#34;Manual GEE weights&#34;</span>, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(m_manual_gee), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t_lag&#34;</span>)<span style="color:#f92672">$</span>estimate, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(m_manual_gee), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t&#34;</span>)<span style="color:#f92672">$</span>estimate,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Panel with GEE&#34;</span>, <span style="color:#e6db74">&#34;Automatic GEE weights&#34;</span>, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(m_auto_gee), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t_lag&#34;</span>)<span style="color:#f92672">$</span>estimate, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(m_auto_gee), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t&#34;</span>)<span style="color:#f92672">$</span>estimate,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Panel with multilevel model&#34;</span>, <span style="color:#e6db74">&#34;Manual GEE weights&#34;</span>, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(m_lmer_manual_gee_wt), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t_lag&#34;</span>)<span style="color:#f92672">$</span>estimate, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(m_lmer_manual_gee_wt), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t&#34;</span>)<span style="color:#f92672">$</span>estimate,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Panel with multilevel model&#34;</span>, <span style="color:#e6db74">&#34;Automatic GEE weights&#34;</span>, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(m_lmer_auto_gee_wt), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t_lag&#34;</span>)<span style="color:#f92672">$</span>estimate, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(m_lmer_auto_gee_wt), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t&#34;</span>)<span style="color:#f92672">$</span>estimate,
</span></span><span style="display:flex;"><span>  <span style="color:#e6db74">&#34;Panel with multilevel model&#34;</span>, <span style="color:#e6db74">&#34;Manual multilevel weights&#34;</span>, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(m_lmer_manual_multi_wt), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t_lag&#34;</span>)<span style="color:#f92672">$</span>estimate, <span style="color:#a6e22e">filter</span>(<span style="color:#a6e22e">tidy</span>(m_lmer_manual_multi_wt), term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;t&#34;</span>)<span style="color:#f92672">$</span>estimate
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><table style="width:90%; margin-left: auto; margin-right: auto;" class=" pure-table pure-table-horizontal">
<thead>
<tr>
<th style="text-align:left;">
Method
</th>
<th style="text-align:left;">
Weights
</th>
<th style="text-align:right;">
lag(T) effect
</th>
<th style="text-align:right;">
T effect
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
True effect
</td>
<td style="text-align:left;">
—
</td>
<td style="text-align:right;">
0.160
</td>
<td style="text-align:right;">
0.400
</td>
</tr>
<tr>
<td style="text-align:left;">
Panel with GEE
</td>
<td style="text-align:left;">
Manual GEE weights
</td>
<td style="text-align:right;">
0.230
</td>
<td style="text-align:right;">
0.429
</td>
</tr>
<tr>
<td style="text-align:left;">
Panel with GEE
</td>
<td style="text-align:left;">
Automatic GEE weights
</td>
<td style="text-align:right;">
0.230
</td>
<td style="text-align:right;">
0.429
</td>
</tr>
<tr>
<td style="text-align:left;">
Panel with multilevel model
</td>
<td style="text-align:left;">
Manual GEE weights
</td>
<td style="text-align:right;">
0.195
</td>
<td style="text-align:right;">
0.408
</td>
</tr>
<tr>
<td style="text-align:left;">
Panel with multilevel model
</td>
<td style="text-align:left;">
Automatic GEE weights
</td>
<td style="text-align:right;">
0.195
</td>
<td style="text-align:right;">
0.408
</td>
</tr>
<tr>
<td style="text-align:left;">
Panel with multilevel model
</td>
<td style="text-align:left;">
Manual multilevel weights
</td>
<td style="text-align:right;">
0.196
</td>
<td style="text-align:right;">
0.414
</td>
</tr>
</tbody>
</table>
<p>Phew.</p>
<p>All of the models here are relatively close to the true effect for <code>\(T_t\)</code>! (Though they’re all sizably off for <code>\(T_{t-1}\)</code>, but I don’t know why).</p>
<p>Importantly, it seems that mixed models work just fine for both weights and outcome models, which means there’s probably no need to use GEE (and this can all be done Bayesianly with <code>brms()</code>!).</p>
<p>It works!</p>
<h2 id="questions-for-the-future">Questions for the future</h2>
<p>I still have some lingering things to check (forthcoming in a future blog post):</p>
<ul>
<li>
<p><code>y</code> isn’t any any of the models: weights numerator, weights denominator, or outcome. If I include it in any of the models, the there’s perfect fit. That may be because there are no time-varying confounders? I think year might need to be in there somewhere, but I’m not sure. <a href="#ref-BlackwellGlynn:2018">Blackwell and Glynn</a> (<a href="#ref-BlackwellGlynn:2018">2018</a>) include year in the numerator and denominator for weights in their Swank Steinmo replication, but not in their Burgoon replication.</p>
</li>
<li>
<p>This example has no time-varying confounders. I need to see how this all works with those.</p>
</li>
<li>
<p>This DAG for this example is pretty simple. I need to see what happens when there are <em>also</em> direct arrows from <code>\(T_{t-1} \rightarrow T_{t}\)</code> and <code>\(D_{t-1} \rightarrow D_{t}\)</code>.</p>
</li>
</ul>
<h2 id="references">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-BlackwellGlynn:2018" class="csl-entry">
<p>Blackwell, Matthew, and Adam N. Glynn. 2018. “How to Make Causal Inferences with Time-Series Cross-Sectional Data Under Selection on Observables.” <em>American Political Science Review</em> 112 (4): 1067–82. <a href="https://doi.org/10.1017/s0003055418000357">https://doi.org/10.1017/s0003055418000357</a>.</p>
</div>
<div id="ref-ThoemmesOng:2016" class="csl-entry">
<p>Thoemmes, Felix, and Anthony D. Ong. 2016. “A Primer on Inverse Probability of Treatment Weighting and Marginal Structural Models.” <em>Emerging Adulthood</em> 4 (1): 40–59. <a href="https://doi.org/10.1177/2167696815621645">https://doi.org/10.1177/2167696815621645</a>.</p>
</div>
</div>
%!s(MISSING)]]></content>
        <category term="r" />
        <category term="tidyverse" />
        <category term="causal inference" />
        <category term="DAGs" />
        <category term="do calculus" />
        <category term="inverse probability weighting" />
    </entry>
</feed>

{
    "version": "https://jsonfeed.org/version/1",
    "title": "Shagun Jhaver",
    "home_page_url": "https://www.shagunjhaver.com/",
    "feed_url": "https://www.shagunjhaver.com/feed.json",
    "description": "Shagun Jhaver is an assistant professor at Rutgers University, researching content moderation and online harassment.",
    "icon": "https://www.shagunjhaver.com/profiles/square-bg.png",
    "items": [
        {
            "id": "https://www.shagunjhaver.com/blog/2021/09/07/do-calculus-backdoors/",
            "url": "https://www.shagunjhaver.com/blog/2021/09/07/do-calculus-backdoors/",
            "title": "Do-calculus adventures! Exploring the three rules of do-calculus in plain language and deriving the backdoor adjustment formula by hand",
            "summary": "Use R to explore the three rules of *do*-calculus in plain language and derive the backdoor adjustment formula by hand",
            "content_html": "\u003ch2 id=\"contents----omit-in-toc---\"\u003eContents \u003c!-- omit in toc --\u003e\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#exploring-the-rules-of-do-calculus\"\u003eExploring the rules of \u003cem\u003edo\u003c/em\u003e-calculus\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#rule-1-ignoring-observations\"\u003eRule 1: Ignoring observations\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#rule-2-treating-interventions-as-observations\"\u003eRule 2: Treating interventions as observations\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#rule-3-ignoring-interventions\"\u003eRule 3: Ignoring interventions\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#summary\"\u003eSummary\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#deriving-the-backdoor-adjustment-formula-from-do-calculus-rules\"\u003eDeriving the backdoor adjustment formula from \u003cem\u003edo\u003c/em\u003e-calculus rules\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#marginalizing-across-z\"\u003eMarginalizing across \u003ccode\u003e\\(z\\)\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#applying-rule-2\"\u003eApplying Rule 2\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#applying-rule-3\"\u003eApplying Rule 3\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#final-equation\"\u003eFinal equation\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#references\"\u003eReferences\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003cp\u003eI’ve been teaching \u003ca href=\"https://evalf21.classes.andrewheiss.com/\"\u003ea course on program evaluation\u003c/a\u003e since Fall 2019, and while part of the class is focused on logic models and the more managerial aspects of evaluation, the bulk of the class is focused on causal inference. Ever since reading \u003ca href=\"http://bayes.cs.ucla.edu/WHY/\"\u003eJudea Pearl’s \u003cem\u003eThe Book of Why\u003c/em\u003e\u003c/a\u003e in 2019, I’ve thrown myself into the world of DAGs, econometrics, and general causal inference, and I’ve been both teaching it and using it in research ever since. I’ve even \u003ca href=\"https://www.andrewheiss.com/research/chapters/heiss-causal-inference-2021/\"\u003epublished a book chapter on it\u003c/a\u003e. Fun stuff.\u003c/p\u003e\n\u003cp\u003eThis post assumes you have a general knowledge of DAGs and backdoor confounding. Read \u003ca href=\"https://www.andrewheiss.com/blog/2020/02/25/closing-backdoors-dags/\"\u003ethis post\u003c/a\u003e or \u003ca href=\"https://www.andrewheiss.com/research/chapters/heiss-causal-inference-2021/\"\u003ethis chapter\u003c/a\u003e if you haven’t heard about those things yet.\u003c/p\u003e\n\u003cp\u003eDAGs are a powerful tool for causal inference because they let you map out all your assumptions of the data generating process for some treatment and some outcome. Importantly, these causal graphs help you determine what statistical approaches you need to use to isolate or identify the causal arrow between treatment and outcome. One of the more common (and intuitive) methods for idenfifying causal effects with DAGs is to close back doors, or adjust for nodes in a DAG that open up unwanted causal associtions between treatment and control. By properly closing backdoors, you can estimate a causal quantity using observational data. There’s even a special formula called the backdoor adjustment formula that takes an equation with a \u003ccode\u003e\\(\\operatorname{do}(\\cdot)\\)\u003c/code\u003e operator (a \u003ca href=\"https://stats.stackexchange.com/questions/211008/dox-operator-meaning\"\u003especial mathematical function\u003c/a\u003e representing a direct experimental intervention in a graph) and allows you to estimate the effect with \u003cem\u003edo\u003c/em\u003e-free quantities:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$P(y \\mid \\operatorname{do}(x)) = \\sum_z P(y \\mid x, z) \\times P(z)$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eWhen I teach this stuff, I show that formula on a slide, tell students they don’t need to worry about it too much, and then show how actually do it using regression, inverse probability weighting, and matching (\u003ca href=\"https://evalf21.classes.andrewheiss.com/example/matching-ipw/\"\u003ewith this guide\u003c/a\u003e). For my MPA and MPP students, the math isn’t as important as the actual application of these principles, so that’s what I focus on.\u003c/p\u003e\n\u003cp\u003eHowever—confession time—that math is also a bit of a magic black box for me too. I’ve read it in books and assume that it’s correct, but I never really fully understood why.\u003c/p\u003e\n\u003cp\u003eCompounding my confusion is the fact that the foundation of Judea Pearl-style DAG-based causal inference is the idea of \u003cem\u003edo\u003c/em\u003e-calculus (\u003ca href=\"#ref-Pearl:2012\"\u003ePearl 2012\u003c/a\u003e): a set of three mathematical rules that can be applied to a causal graph to identify causal relationships. Part of my confusion stems from the fact that most textbooks and courses (including mine!) explain that you can identify causal relationships in DAGs using backdoor adjustment, frontdoor adjustment, or the fancy application of \u003cem\u003edo\u003c/em\u003e-calculus rules. When framed like this, it seems like backdoor and frontdoor adjustment are separate things from \u003cem\u003edo\u003c/em\u003e-calculus, and that \u003cem\u003edo\u003c/em\u003e-calculus is something you do when backdoor and frontdoor adjustments don’t work.\u003c/p\u003e\n\u003cp\u003eBut that’s not the case! In 2020, \u003ca href=\"https://twitter.com/@andrewheiss\"\u003eI asked Twitter\u003c/a\u003e if backdoor and frontdoor adjustment were connected to \u003cem\u003edo\u003c/em\u003e-calculus, and surprisingly \u003ca href=\"https://twitter.com/yudapearl/status/1252462516468240390\"\u003eJudea Pearl himself answered\u003c/a\u003e that they are!\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"pearl-tweet.png\" width=\"70%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eThey’re both specific consequences of the application of the rules of \u003cem\u003edo\u003c/em\u003e-calculus—they just have special names because they’re easy to see in a graph.\u003c/p\u003e\n\u003cp\u003eBut how? How do people apply these strange rules of \u003cem\u003edo\u003c/em\u003e-calculus to derive these magical backdoor and frontdoor adjustment formulas? The question has haunted me since April 2020.\u003c/p\u003e\n\u003cp\u003eBut in the past couple days, I’ve stumbled across a couple excellent resources (\u003ca href=\"https://www.bradyneal.com/causal-inference-course\"\u003ethis course\u003c/a\u003e and \u003ca href=\"https://www.youtube.com/playlist?list=PLoazKTcS0Rzb6bb9L508cyJ1z-U9iWkA0\"\u003ethese videos\u003c/a\u003e + \u003ca href=\"https://stephenmalina.com/post/2020-03-09-front-door-do-calc-derivation/\"\u003ethis blog post\u003c/a\u003e) that explained \u003cem\u003edo\u003c/em\u003e-calculus really well, so I figured I’d finally tackle this question and figure out how exactly \u003cem\u003edo\u003c/em\u003e-calculus is used to derive the backdoor adjustment formula. I won’t show the derivation of the frontdoor formula—smarter people than me have done that (\u003ca href=\"https://stephenmalina.com/post/2020-03-09-front-door-do-calc-derivation/\"\u003ehere\u003c/a\u003e and \u003ca href=\"https://www.bradyneal.com/Introduction_to_Causal_Inference-Dec17_2020-Neal.pdf\"\u003eSection 6.2.1 here\u003c/a\u003e, for instance), but I can do the backdoor one now!\u003c/p\u003e\n\u003cp\u003eFirst, I’ll explain and illustrate how each of the three rules of \u003cem\u003edo\u003c/em\u003e-calculus as plain-language-y as possible, and then I’ll apply those rules to show how the backdoor adjustment formula is created.\u003c/p\u003e\n\u003cp\u003eI use the \u003cstrong\u003eggdag\u003c/strong\u003e and \u003cstrong\u003edagitty\u003c/strong\u003e packages in R for all this, so you can follow along too. Here we go!\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)  \u003cspan style=\"color:#75715e\"\u003e# For ggplot2 and friends\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(patchwork)  \u003cspan style=\"color:#75715e\"\u003e# For combining plots\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(ggdag)      \u003cspan style=\"color:#75715e\"\u003e# For making DAGs with ggplot\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(dagitty)    \u003cspan style=\"color:#75715e\"\u003e# For dealing with DAG math\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(latex2exp)  \u003cspan style=\"color:#75715e\"\u003e# Easily convert LaTeX into arcane plotmath expressions\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(ggtext)     \u003cspan style=\"color:#75715e\"\u003e# Use markdown in ggplot labels\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Create a cleaner serifed theme to use throughout\u003c/span\u003e\ntheme_do_calc \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e() {\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_dag\u003c/span\u003e(base_family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Linux Libertine O\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n    \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(plot.title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erel\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e)),\n        plot.subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_markdown\u003c/span\u003e())\n}\n\n\u003cspan style=\"color:#75715e\"\u003e# Make all geom_dag_text() layers use these settings automatically\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eupdate_geom_defaults\u003c/span\u003e(ggdag\u003cspan style=\"color:#f92672\"\u003e:::\u003c/span\u003eGeomDagText, \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Linux Libertine O\u0026#34;\u003c/span\u003e, \n                                               fontface \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bold\u0026#34;\u003c/span\u003e,\n                                               color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;black\u0026#34;\u003c/span\u003e))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"exploring-the-rules-of-do-calculus\"\u003eExploring the rules of \u003cem\u003edo\u003c/em\u003e-calculus\u003c/h2\u003e\n\u003cp\u003eThe three rules of \u003cem\u003edo\u003c/em\u003e-calculus have always been confusing to me since they are typically written as pure math equations and not in plain understandable language. For instance, \u003ca href=\"https://ftp.cs.ucla.edu/pub/stat_ser/r402.pdf\"\u003ehere’s Judea Pearl’s canonical primer on \u003cem\u003edo\u003c/em\u003e-calculus\u003c/a\u003e—a short PDF with lots of math and proofs (\u003ca href=\"#ref-Pearl:2012\"\u003ePearl 2012\u003c/a\u003e). In basically everything I’ve read about \u003cem\u003edo\u003c/em\u003e-calculus, there’s inevitably a listing of these three very mathy rules, written for people much smarter than me:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"do-calculus-math.png\" width=\"100%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003e(\u003cem\u003eFrom left to right: \u003ca href=\"#ref-LattimoreRohde:2019\"\u003eLattimore and Rohde\u003c/a\u003e (\u003ca href=\"#ref-LattimoreRohde:2019\"\u003e2019\u003c/a\u003e), \u003ca href=\"https://plato.stanford.edu/entries/causal-models/do-calculus.html\"\u003eThe Stanford Encyclopedia of Philosophy\u003c/a\u003e, \u003ca href=\"#ref-Pearl:2012\"\u003ePearl\u003c/a\u003e (\u003ca href=\"#ref-Pearl:2012\"\u003e2012\u003c/a\u003e), \u003ca href=\"#ref-Neal:2020\"\u003eNeal\u003c/a\u003e (\u003ca href=\"#ref-Neal:2020\"\u003e2020\u003c/a\u003e)\u003c/em\u003e)\u003c/p\u003e\n\u003cp\u003eHowever, beneath this scary math, each rule has specific intuition and purpose behind it—I just didn’t understand the plain-language reasons for each rule until reading \u003ca href=\"https://stephenmalina.com/post/2020-03-09-front-door-do-calc-derivation/\"\u003ethis really neat blog post\u003c/a\u003e. Here’s what each rule actually does:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eRule 1\u003c/strong\u003e: Decide if we can ignore an observation\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eRule 2\u003c/strong\u003e: Decide if we can treat an intervention as an observation\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eRule 3\u003c/strong\u003e: Decide if we can ignore an intervention\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eWhoa! That’s exceptionally logical. Each rule is designed to help simplify and reduce nodes in a DAG by either ignoring them (Rules 1 and 3) or making it so interventions like \u003ccode\u003e\\(\\operatorname{do}(\\cdot)\\)\u003c/code\u003e can be treated like observations instead (Rule 2).\u003c/p\u003e\n\u003cp\u003eLet’s explore each of these rules in detail. In all these situations, we’re assuming that there’s a DAG with 4 nodes: W, X, Y, and Z. Y is always the outcome; X is always the main treatment. In each rule, our goal is to get rid of Z by applying the rule. When talking about interventions in a graph, there’s a special notation with overlines and underlines:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAn overline like \u003ccode\u003e\\(G_{\\overline{X}}\\)\u003c/code\u003e means that you delete all the arrows \u003cem\u003egoing into\u003c/em\u003e X\u003c/li\u003e\n\u003cli\u003eAn underline like \u003ccode\u003e\\(G_{\\underline{X}}\\)\u003c/code\u003e means that you delete all the arrows \u003cem\u003ecoming out of\u003c/em\u003e X\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eI imagine this line like a wall:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eIf the wall is on top of X like \u003ccode\u003e\\(\\overline{X}\\)\u003c/code\u003e, you can’t draw any arrows going into it, so you delete anything going in\u003c/li\u003e\n\u003cli\u003eIf the wall is on the bottom of X like \u003ccode\u003e\\(\\underline{X}\\)\u003c/code\u003e, you can’t draw any arrows going out of it, so you delete anything going out\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"rule-1-ignoring-observations\"\u003eRule 1: Ignoring observations\u003c/h3\u003e\n\u003cp\u003eAccording to Rule 1, we can ignore any observational node if it doesn’t influence the outcome through any path, or if it is d-separated from the outcome. Here’s the formal definition:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$P(y \\mid z, \\operatorname{do}(x), w) = P(y \\mid \\operatorname{do}(x), w) \\qquad \\text{ if } (Y \\perp Z \\mid W, X)_{G_{\\overline{X}}}$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eThere are a lot of moving parts here, but remember, the focus in this equation is \u003ccode\u003e\\(z\\)\u003c/code\u003e. Our goal here is to remove or ignore \u003ccode\u003e\\(z\\)\u003c/code\u003e. Notice how \u003ccode\u003e\\(z\\)\u003c/code\u003e exists on the left-hand side of the equation and how it is gone on the right-hand side. As long as we meet the cryptic conditions of \u003ccode\u003e\\((Y \\perp Z \\mid W, X)_{G_{\\overline{X}}}\\)\u003c/code\u003e, we can get rid of it. But what the heck does that even mean?\u003c/p\u003e\n\u003cp\u003eHere, \u003ccode\u003e\\(G_{\\overline{X}}\\)\u003c/code\u003e means “the original causal graph with all arrows into X removed,” while the \u003ccode\u003e\\(Y \\perp Z \\mid W, X\\)\u003c/code\u003e part means “Y is independent of Z, given W and X” in the new modified graph. If the Y and Z nodes are d-separated from each other after we account for both W and X, we can get rid of Z and ignore it.\u003c/p\u003e\n\u003cp\u003eLet’s look at this graphically to help make better sense of this. We’ll use the \u003ccode\u003edagify()\u003c/code\u003e function from \u003cstrong\u003eggdag\u003c/strong\u003e to build a couple DAGs: one complete one ($G$) and one with all the arrows into X deleted ($G_{\\overline{X}}$). X causes both X and Y, while W confounds X, Y, and Z.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003erule1_g \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edagify\u003c/span\u003e(\n  Y \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e X \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e W,\n  X \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e W,\n  Z \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e X \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e W,\n  coords \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(X \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.25\u003c/span\u003e, W \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e),\n                y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(X \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, W \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e))\n)\n\nrule1_g_x_over \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edagify\u003c/span\u003e(\n  Y \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e X \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e W,\n  Z \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e X \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e W,\n  coords \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(X \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.25\u003c/span\u003e, W \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e),\n                y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(X \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, W \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e))\n) \n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eplot_rule1_g \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(rule1_g, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, \n                                    xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e xend, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e yend)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_edges\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_point\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey80\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_text\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eTeX\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;$G$\u0026#34;\u003c/span\u003e),\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Original DAG\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_do_calc\u003c/span\u003e()\n\nplot_rule1_g_x_over \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(rule1_g_x_over, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, \n                                                  xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e xend, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e yend)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_edges\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_point\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey80\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_text\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eTeX\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;$G_\\\\bar{x}$\u0026#34;\u003c/span\u003e),\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;DAG with arrows *into* X deleted\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_do_calc\u003c/span\u003e()\n\nplot_rule1_g \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e plot_rule1_g_x_over\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/09/07/do-calculus-backdoors/index_files/figure-html/plot-rule1-1.png\" width=\"100%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eIf we want to calculate the causal effect of X on Y, do we need to worry about Z here, or can we ignore it? Let’s apply Rule 1. If we look at the modified \u003ccode\u003e\\(G_{\\overline{X}}\\)\u003c/code\u003e, Y and Z are completely d-separated if we account for both W and X—there’s no direct arrow between them, and there’s no active path connecting them through W or X, since we’re accounting for (or condition on) those nodes. Y and Z are thus d-separated and \u003ccode\u003e\\(Y \\perp Z \\mid W, X\\)\u003c/code\u003e. We can confirm this with the \u003ccode\u003eimpliedConditionalIndependencies()\u003c/code\u003e function from the \u003cstrong\u003edagitty\u003c/strong\u003e package:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eimpliedConditionalIndependencies\u003c/span\u003e(rule1_g_x_over)\n\u003cspan style=\"color:#75715e\"\u003e## W _||_ X\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Y _||_ Z | W, X\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAnd there it is! The second independency there is \u003ccode\u003e\\(Y \\perp Z \\mid W, X\\)\u003c/code\u003e. That means that we can apply Rule 1 and ignore Z, meaning that\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$P(y \\mid z, \\operatorname{do}(x), w) = P(y \\mid \\operatorname{do}(x), w)$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eThis makes sense but is a little too complicated for me, since we’re working with four different nodes. We can simplify this and pretend that \u003ccode\u003e\\(\\operatorname{do}(x)\\)\u003c/code\u003e is nothing and that X doesn’t exist. That leaves us with just three nodes—W, Y, and Z—and this DAG:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003erule1_g_simple \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edagify\u003c/span\u003e(\n  Y \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e W,\n  Z \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e W,\n  coords \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, W \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e),\n                y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, W \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e))\n)\n\nplot_rule1_g_simple \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(rule1_g_simple, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, \n                                                  xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e xend, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e yend)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_edges\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_point\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey80\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_text\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eTeX\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;$G$\u0026#34;\u003c/span\u003e),\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Simplified DAG without X\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_do_calc\u003c/span\u003e()\nplot_rule1_g_simple\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/09/07/do-calculus-backdoors/index_files/figure-html/plot-rule1-simple-1.png\" width=\"50%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eThe simplified X-free version of Rule 1 looks like this:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$P(y \\mid z, w) = P(y \\mid w) \\qquad \\text{ if } (Y \\perp Z \\mid W)_{G}$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eIn other words, we can ignore Z and remove it from the \u003ccode\u003e\\(P(y \\mid z, w)\\)\u003c/code\u003e equation if Y and Z are d-separated (or independent of each other) after accounting for W. Once we account for W, there’s no possible connection between Y and Z, so they really are d-separated. We can again confirm this with code:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eimpliedConditionalIndependencies\u003c/span\u003e(rule1_g_simple)\n\u003cspan style=\"color:#75715e\"\u003e## Y _||_ Z | W\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThere we go. Because \u003ccode\u003e\\(Y \\perp Z \\mid W\\)\u003c/code\u003e we can safely ignore Z.\u003c/p\u003e\n\u003ch3 id=\"rule-2-treating-interventions-as-observations\"\u003eRule 2: Treating interventions as observations\u003c/h3\u003e\n\u003cp\u003eRule 1 is neat, but it has nothing to do with causal interventions or the \u003ccode\u003e\\(\\operatorname{do}(\\cdot)\\)\u003c/code\u003e operator. It feels more like a housekeeping rule—it’s a way of simplifying and removing unnecessary nodes that don’t have to do with the main treatment → outcome relationship.\u003c/p\u003e\n\u003cp\u003eWith Rule 2, we start messing with interventions. In an experiment like a randomized controlled trial, a researcher has the ability to assign treatment and either \u003ccode\u003e\\(\\operatorname{do}(x)\\)\u003c/code\u003e or not \u003ccode\u003e\\(\\operatorname{do}(x)\\)\u003c/code\u003e. With observational data, though, it’s not possible to \u003ccode\u003e\\(\\operatorname{do}(x)\\)\u003c/code\u003e directly. It would be fantastic if we could take an intervention like \u003ccode\u003e\\(\\operatorname{do}(x)\\)\u003c/code\u003e and treat it like regular non-interventional observational data. Rule 2 lets us do this.\u003c/p\u003e\n\u003cp\u003eAccording to Rule 2, interventions (or \u003ccode\u003e\\(do(x)\\)\u003c/code\u003e) can be treated as observations (or \u003ccode\u003e\\(x\\)\u003c/code\u003e) when the causal effect of a variable on the outcome ($X \\rightarrow Y$) only influences the outcome through directed paths. The official math for this is this complicated thing:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$P(y \\mid \\operatorname{do}(z), \\operatorname{do}(x), w) = P(y \\mid z, \\operatorname{do}(x), w) \\qquad \\text{ if } (Y \\perp Z \\mid W, X)_{G_{\\overline{X}, \\underline{Z}}}$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eFor me, this is super confusing, since there are two different \u003ccode\u003e\\(\\operatorname{do}(\\cdot)\\)\u003c/code\u003e operators here and when I think of causal graphs, I think of single interventions. Like we did with Rule 1, we can simplify this and pretend that there’s no intervention \u003ccode\u003e\\(\\operatorname{do}(x)\\)\u003c/code\u003e (we’ll do the full rule in a minute, don’t worry). Again, this is legal because each of these rules are focused on messing with the Z variable: ignoring it or treating it as an observation. That leaves us with this slightly simpler (though still cryptic) equation:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$P(y \\mid \\operatorname{do}(z), w) = P(y \\mid z, w) \\qquad \\text{ if } (Y \\perp Z \\mid W)_{G_{\\underline{Z}}}$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eNotice how the left-hand side has the interventional \u003ccode\u003e\\(\\operatorname{do}(z)\\)\u003c/code\u003e, while the right-hand side has the observed \u003ccode\u003e\\(z\\)\u003c/code\u003e. As long as we meet the condition \u003ccode\u003e\\((Y \\perp Z \\mid W)_{G_{\\underline{Z}}}\\)\u003c/code\u003e, we can transform \u003ccode\u003e\\(\\operatorname{do}(z)\\)\u003c/code\u003e into \u003ccode\u003e\\(z\\)\u003c/code\u003e and work only with observational data. Once again, though, what does this \u003ccode\u003e\\((Y \\perp Z \\mid W)_{G_{\\underline{Z}}}\\)\u003c/code\u003e condition even mean?\u003c/p\u003e\n\u003cp\u003eHere, \u003ccode\u003e\\(G_{\\underline{Z}}\\)\u003c/code\u003e means “the original causal graph with all arrows out of Z removed,” while the \u003ccode\u003e\\(Y \\perp Z \\mid W\\)\u003c/code\u003e part means “Y is independent of Z, given W” in the new modified graph. Similar to Rule 1, if the Y and Z nodes are d-separated from each other after we account for W, we can legally treat \u003ccode\u003e\\(\\operatorname{do}(z)\\)\u003c/code\u003e like \u003ccode\u003e\\(z\\)\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eAs we did with Rule 1, we’ll build a couple basic DAGs: a complete one ($G$) and one with all the arrows \u003cem\u003eout of\u003c/em\u003e Z deleted ($G_{\\underline{Z}}$).\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003erule2_g_simple \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edagify\u003c/span\u003e(\n  Y \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e Z \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e W,\n  Z \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e W,\n  coords \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, W \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e),\n                y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, W \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e))\n)\n\nrule2_g_simple_z_under \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edagify\u003c/span\u003e(\n  Y \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e W,\n  Z \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e W,\n  coords \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, W \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e),\n                y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, W \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e))\n) \n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eplot_rule2_g_simple \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(rule2_g_simple, \n                              \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, \n                                  xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e xend, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e yend)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_edges\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_point\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey80\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_text\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eTeX\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;$G$\u0026#34;\u003c/span\u003e),\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Original DAG\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_do_calc\u003c/span\u003e()\n\nplot_rule2_g_simple_z_under \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(rule2_g_simple_z_under, \n                                      \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, \n                                          xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e xend, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e yend)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_edges\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_point\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey80\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_text\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eTeX\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;$G_\\\\underline{Z}$\u0026#34;\u003c/span\u003e),\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;DAG with arrows *out of* Z deleted\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_do_calc\u003c/span\u003e()\n\nplot_rule2_g_simple \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e plot_rule2_g_simple_z_under\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/09/07/do-calculus-backdoors/index_files/figure-html/plot-rule2-simple-1.png\" width=\"100%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eSo, can we treat Z here like an observational node instead of a interventional \u003ccode\u003e\\(\\operatorname{do}(\\cdot)\\)\u003c/code\u003e node? Let’s apply Rule 2. If we look at the modified \u003ccode\u003e\\(G_{\\underline{Z}}\\)\u003c/code\u003e graph, Z and Y are completely d-separated if we account for W—there’s no direct arrow between them, and there’s no active path connecting them through W since we’re conditioning on W. We can thus say that \u003ccode\u003e\\(Y \\perp Z \\mid W\\)\u003c/code\u003e. We can confirm this with code too:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eimpliedConditionalIndependencies\u003c/span\u003e(rule2_g_simple_z_under)\n\u003cspan style=\"color:#75715e\"\u003e## Y _||_ Z | W\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWoohoo! Because \u003ccode\u003e\\(Y \\perp Z \\mid W\\)\u003c/code\u003e in that modified \u003ccode\u003e\\(G_{\\underline{Z}}\\)\u003c/code\u003e graph, we can legally convert the interventional \u003ccode\u003e\\(\\operatorname{do}(z)\\)\u003c/code\u003e to just a regular old observational \u003ccode\u003e\\(z\\)\u003c/code\u003e:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$P(y \\mid \\operatorname{do}(z), w) = P(y \\mid z, w)$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eSo far we’ve applied Rule 2 to a simplified DAG with three nodes, but what does it look like if we’re using the full four-node graph that is used in the formal definition of Rule 2?\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$P(y \\mid \\operatorname{do}(z), \\operatorname{do}(x), w) = P(y \\mid z, \\operatorname{do}(x), w) \\qquad \\text{ if } (Y \\perp Z \\mid W, X)_{G_{\\overline{X}, \\underline{Z}}}$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eHere’s one graphical representation of a graph with the four nodes W, X, Y, and Z (but it’s definitely not the only possible graph! These \u003cem\u003edo\u003c/em\u003e-calculus rules don’t assume any specific relationships between the nodes). Here, Y is caused by both X and Z, and we’ll pretend that they’re both interventions (so \u003ccode\u003e\\(\\operatorname{do}(x)\\)\u003c/code\u003e and \u003ccode\u003e\\(\\operatorname{do}(z)\\)\u003c/code\u003e). X is causally linked to Z, and W confounds all three: X, Y, and Z. Graph \u003ccode\u003e\\(G\\)\u003c/code\u003e shows the complete DAG; Graph \u003ccode\u003e\\(G_{\\overline{X}, \\underline{Z}}\\)\u003c/code\u003e shows a modified DAG with all arrows \u003cem\u003einto\u003c/em\u003e X deleted ($\\overline{X}$) and all arrows \u003cem\u003eout of\u003c/em\u003e Z deleted ($\\underline{Z}$).\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003erule2_g \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edagify\u003c/span\u003e(\n  Y \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e X \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e W \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e Z,\n  X \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e W,\n  Z \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e X \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e W,\n  coords \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(X \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.25\u003c/span\u003e, W \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e),\n                y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(X \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, W \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e))\n)\n\nrule2_g_modified \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edagify\u003c/span\u003e(\n  Y \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e X \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e W,\n  Z \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e X \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e W,\n  coords \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(X \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.25\u003c/span\u003e, W \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e),\n                y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(X \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, W \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e))\n) \n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eplot_rule2_g \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(rule2_g, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, \n                                    xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e xend, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e yend)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_edges\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_point\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey80\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_text\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eTeX\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;$G$\u0026#34;\u003c/span\u003e),\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Original DAG\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_do_calc\u003c/span\u003e()\n\nplot_rule2_modified \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(rule2_g_modified, \n                              \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, \n                                  xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e xend, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e yend)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_edges\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_point\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey80\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_text\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eTeX\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;$G_{\\\\bar{X}, \\\\underline{Z}}$\u0026#34;\u003c/span\u003e),\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;DAG with arrows *into* X and *out of* Z deleted\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_do_calc\u003c/span\u003e()\n\nplot_rule2_g \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e plot_rule2_modified\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/09/07/do-calculus-backdoors/index_files/figure-html/plot-rule2-1.png\" width=\"100%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eOkay. Our goal here is to check if we can treat \u003ccode\u003e\\(\\operatorname{do}(z)\\)\u003c/code\u003e like a regular observational \u003ccode\u003e\\(z\\)\u003c/code\u003e. We can legally do this if Y and Z are d-separated in that modified graph, after accounting for both W and X, or \u003ccode\u003e\\(Y \\perp Z \\mid W, X\\)\u003c/code\u003e. And that is indeed the case! There’s no direct arrow connecting Y and Z in the modified graph, and once we condition on (or account for) W and X, no pathways between Y and Z are active—Y and Z are independent and d-separated. We can confirm this with code:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eimpliedConditionalIndependencies\u003c/span\u003e(rule2_g_modified)\n\u003cspan style=\"color:#75715e\"\u003e## W _||_ X\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Y _||_ Z | W, X\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe second independency there is that \u003ccode\u003e\\(Y \\perp Z \\mid W, X\\)\u003c/code\u003e, which is exactly what we want to see. We can thus legally transform \u003ccode\u003e\\(\\operatorname{do}(z)\\)\u003c/code\u003e to \u003ccode\u003e\\(z\\)\u003c/code\u003e:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$P(y \\mid \\operatorname{do}(z), \\operatorname{do}(x), w) = P(y \\mid z, \\operatorname{do}(x), w)$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eWhat’s really neat is that Rule 2 is a generalized version of the backdoor criterion. More on that below after we explore Rule 3.\u003c/p\u003e\n\u003ch3 id=\"rule-3-ignoring-interventions\"\u003eRule 3: Ignoring interventions\u003c/h3\u003e\n\u003cp\u003eRule 3 is the trickiest of the three, conceptually. It tells us when we can completely remove a \u003ccode\u003e\\(\\operatorname{do}(\\cdot)\\)\u003c/code\u003e expression rather than converting it to an observed quantity. Here it is in all its mathy glory:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$P(y \\mid \\operatorname{do}(z), \\operatorname{do}(x), w) = P(y \\mid \\operatorname{do}(x), w) \\qquad \\text{ if } (Y \\perp Z \\mid W, X)_{G_{\\overline{X}, \\overline{Z(W)}}}$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eIn simpler language, this means that we can ignore an intervention (or a \u003ccode\u003e\\(\\operatorname{do}(\\cdot)\\)\u003c/code\u003e expression) if it doesn’t influence the outcome through any uncontrolled path—we can remove \u003ccode\u003e\\(\\operatorname{do}(z)\\)\u003c/code\u003e if there is no causal association (or no unblocked causal paths) flowing from Z to Y.\u003c/p\u003e\n\u003cp\u003eThis rule is tricky, though, because it depends on where the Z node (i.e. the intervention we want to get rid of) appears in the graph. Note the notation for the modified graph here. With the other rules, we used things like \u003ccode\u003e\\(G_{\\overline{X}}\\)\u003c/code\u003e or \u003ccode\u003e\\(G_{\\underline{Z}}\\)\u003c/code\u003e to remove arrows into and out of specific nodes in the modified graph. Here, though, we have the strange \u003ccode\u003e\\(G_{\\overline{Z(W)}}\\)\u003c/code\u003e. This Z(W) is weird! It means “any Z node that isn’t an ancestor of W.” We thus only delete arrows going into a Z node in the modified graph if that Z node doesn’t precede W.\u003c/p\u003e\n\u003cp\u003eHere’s one version of what that could look like graphically:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003erule3_g \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edagify\u003c/span\u003e(\n  Y \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e X \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e W,\n  W \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e Z,\n  Z \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e X,\n  coords \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(X \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.25\u003c/span\u003e, W \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e),\n                y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(X \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, W \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.75\u003c/span\u003e))\n)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eplot_rule3_g \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(rule3_g, \n                       \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, \n                           xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e xend, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e yend)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_edges\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_point\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey80\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_text\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eTeX\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;$G$\u0026#34;\u003c/span\u003e),\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Original DAG\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_do_calc\u003c/span\u003e()\n\nplot_rule3_g_modified \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(rule3_g, \n                                \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, \n                                    xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e xend, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e yend)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_edges\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_point\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey80\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_text\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eTeX\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;$G_{\\\\bar{X}, \\\\bar{Z(W)}}$\u0026#34;\u003c/span\u003e),\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;DAG with arrows *into* Z deleted as long as Z isn\u0026#39;t an\u0026lt;br\u0026gt;ancestor of W + all arrows *into* X deleted\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_do_calc\u003c/span\u003e()\n\nplot_rule3_g \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e plot_rule3_g_modified\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/09/07/do-calculus-backdoors/index_files/figure-html/plot-rule3-1.png\" width=\"100%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eNotice how these two graphs are identical. Because we only delete arrows going into Z if Z is not an ancestor of W, in this case \u003ccode\u003e\\(G = G_{\\overline{X}, \\overline{Z(W)}}\\)\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eRemember that our original goal is to get rid of \u003ccode\u003e\\(\\operatorname{do}(z)\\)\u003c/code\u003e, which we can legally do if Y and Z are d-separated and independent in our modified graph, or if \u003ccode\u003e\\(Y \\perp Z \\mid W, X\\)\u003c/code\u003e. That is once again indeed the case here: there’s no direct arrow between Y and Z, and if we condition on W and X, there’s no way to pass association between Y and Z, meaning that Y and Z are d-separated. Let’s confirm it with code:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eimpliedConditionalIndependencies\u003c/span\u003e(rule3_g)\n\u003cspan style=\"color:#75715e\"\u003e## W _||_ X | Z\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Y _||_ Z | W, X\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThat second independency is our \u003ccode\u003e\\(Y \\perp Z \\mid W, X\\)\u003c/code\u003e, so we can safely eliminate \u003ccode\u003e\\(\\operatorname{do}(z)\\)\u003c/code\u003e from the equation. We can ignore it because it doesn’t influence the outcome \u003ccode\u003e\\(Y\\)\u003c/code\u003e through any possible path. Goodbye \u003ccode\u003e\\(\\operatorname{do}(z)\\)\u003c/code\u003e!:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$P(y \\mid \\operatorname{do}(z), \\operatorname{do}(x), w) = P(y \\mid \\operatorname{do}(x), w)$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eIn this case, the alternative graph \u003ccode\u003e\\(G_{\\overline{X}, \\overline{Z(W)}}\\)\u003c/code\u003e was the same as the original graph because of the location of Z—Z was an ancestor of W, so we didn’t delete any arrows. If Z is \u003cem\u003enot\u003c/em\u003e an ancestor, though, we get to actually modify the graph. For instance, consider this DAG:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003erule3_g_alt \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edagify\u003c/span\u003e(\n  Y \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e X \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e W,\n  Z \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e W,\n  X \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e Z,\n  coords \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(X \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.25\u003c/span\u003e, W \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e),\n                y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(X \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, W \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.75\u003c/span\u003e))\n)\n\nrule3_g_alt_modified \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edagify\u003c/span\u003e(\n  Y \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e X \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e W,\n  Z \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e,\n  X \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e,\n  coords \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(X \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.25\u003c/span\u003e, W \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e),\n                y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(X \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, W \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.75\u003c/span\u003e))\n) \n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eplot_rule3_g_alt \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(rule3_g_alt, \n                           \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, \n                               xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e xend, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e yend)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_edges\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_point\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey80\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_text\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eTeX\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;$G$\u0026#34;\u003c/span\u003e),\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Original DAG\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_do_calc\u003c/span\u003e()\n\nplot_rule3_g_alt_modified \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(rule3_g_alt_modified, \n                                    \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, \n                                        xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e xend, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e yend)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_edges\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_point\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey80\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_text\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eTeX\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;$G_{\\\\bar{X}, \\\\bar{Z(W)}}$\u0026#34;\u003c/span\u003e),\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;DAG with arrows *into* Z deleted as long as Z isn\u0026#39;t an\u0026lt;br\u0026gt;ancestor of W + all arrows *into* X deleted\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_do_calc\u003c/span\u003e()\n\nplot_rule3_g_alt \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e plot_rule3_g_alt_modified\n\u003cspan style=\"color:#75715e\"\u003e## Warning: Removed 1 rows containing missing values (geom_dag_point).\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Warning: Removed 1 rows containing missing values (geom_dag_text).\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/09/07/do-calculus-backdoors/index_files/figure-html/plot-rule3-alt-1.png\" width=\"100%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003ePhew. In this case, our DAG surgery for making the modified graph \u003ccode\u003e\\(G_{\\overline{X}, \\overline{Z(W)}}\\)\u003c/code\u003e actually ended up completely d-separating Z from all nodes. Because Z isn’t an ancestor of W (but is instead a descendant), we get to delete arrows going into it, and we get to delete arrows going into X as well. We can remove \u003ccode\u003e\\(\\operatorname{do}(z)\\)\u003c/code\u003e from the equation as long as \u003ccode\u003e\\(Y \\perp Z \\mid W, X\\)\u003c/code\u003e in this modified graph. That is most definitely the case here. And once again, code confirms it (ignore the 0s here—they’re only there so that the DAG plots correctly):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eimpliedConditionalIndependencies\u003c/span\u003e(rule3_g_alt_modified)\n\u003cspan style=\"color:#75715e\"\u003e## 0 _||_ W\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 0 _||_ Y | X\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## W _||_ X\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## W _||_ Z\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## X _||_ Z | 0\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Y _||_ Z | 0\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Y _||_ Z | X\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAnd once again, we can legally get rid of \u003ccode\u003e\\(\\operatorname{do}(z)\\)\u003c/code\u003e:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$P(y \\mid \\operatorname{do}(z), \\operatorname{do}(x), w) = P(y \\mid \\operatorname{do}(x), w)$$\u003c/code\u003e\u003c/p\u003e\n\u003ch3 id=\"summary\"\u003eSummary\u003c/h3\u003e\n\u003cp\u003ePhew. Let’s look back at the three main rules and add their corresponding mathy versions, which should make more sense now:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eRule 1\u003c/strong\u003e: Decide if we can ignore an observation\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$P(y \\mid z, \\operatorname{do}(x), w) = P(y \\mid \\operatorname{do}(x), w) \\qquad \\text{ if } (Y \\perp Z \\mid W, X)_{G_{\\overline{X}}}$$\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eRule 2\u003c/strong\u003e: Decide if we can treat an intervention as an observation\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$P(y \\mid \\operatorname{do}(z), \\operatorname{do}(x), w) = P(y \\mid z, \\operatorname{do}(x), w) \\qquad \\text{ if } (Y \\perp Z \\mid W, X)_{G_{\\overline{X}, \\underline{Z}}}$$\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eRule 3\u003c/strong\u003e: Decide if we can ignore an intervention\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$P(y \\mid \\operatorname{do}(z), \\operatorname{do}(x), w) = P(y \\mid \\operatorname{do}(x), w) \\qquad \\text{ if } (Y \\perp Z \\mid W, X)_{G_{\\overline{X}, \\overline{Z(W)}}}$$\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"deriving-the-backdoor-adjustment-formula-from-do-calculus-rules\"\u003eDeriving the backdoor adjustment formula from \u003cem\u003edo\u003c/em\u003e-calculus rules\u003c/h2\u003e\n\u003cp\u003eThat was a lot of math, but hopefully each of these \u003cem\u003edo\u003c/em\u003e-calculus rules make sense in isolation now. Now that I finally understand what each of these are doing, we can apply these rules to see where the pre-derived / canned backdoor adjustment formula comes from. Somehow by applying these rules, we can transform the left-hand side of this formula into the \u003cem\u003edo\u003c/em\u003e-free right-hand side:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$P(y \\mid \\operatorname{do}(x)) = \\sum_z P(y \\mid x, z) \\times P(z)$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eLet’s go through the derivation of the backdoor adjustment formula step-by-step to see how it works. We’ll use this super simple DAG that shows the causal effect of treatment X on outcome Y, confounded by Z:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ebackdoor_g \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edagify\u003c/span\u003e(\n  Y \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e X \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e Z,\n  X \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e Z,\n  coords \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, X \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e),\n                y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, X \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e))\n)\n\nplot_backdoor_g \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(backdoor_g, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, \n                                          xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e xend, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e yend)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_edges\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_point\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey80\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_text\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eTeX\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;$G$\u0026#34;\u003c/span\u003e),\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Basic backdoor confounding\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_do_calc\u003c/span\u003e()\nplot_backdoor_g\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/09/07/do-calculus-backdoors/index_files/figure-html/basic-backdoor-dag-1.png\" width=\"50%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003ch3 id=\"marginalizing-across-z\"\u003eMarginalizing across \u003ccode\u003e\\(z\\)\u003c/code\u003e\u003c/h3\u003e\n\u003cp\u003eWe’re interested in the causal effect of X on Y, or \u003ccode\u003e\\(P(y \\mid \\operatorname{do}(x))\\)\u003c/code\u003e. If this were an experiment like a randomized controlled trial, we’d be able to delete all arrows going into X, which would remove all confounding from Z and allow us to measure the exact causal effect of X on Y. However, with observational data, we can’t delete arrows like that. But, we can condition the X → Y relationship on Z, given that it influences both X and Y.\u003c/p\u003e\n\u003cp\u003eWe thus need to calculate the joint probability of \u003ccode\u003e\\(P(y \\mid \\operatorname{do}(x))\\)\u003c/code\u003e across all values of Z. Using the rules of \u003ca href=\"https://en.wikipedia.org/wiki/Marginal_distribution\"\u003eprobability marginalization\u003c/a\u003e and \u003ca href=\"https://en.wikipedia.org/wiki/Chain_rule_(probability)\"\u003ethe chain rule for joint probabilities\u003c/a\u003e, we can write this joint probability like so:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$P(y \\mid \\operatorname{do}(x)) = \\sum_z P(y \\mid \\operatorname{do}(x), z) \\times P(z \\mid \\operatorname{do}(x))$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eThe right-hand side of that equation is what we want to be able to estimate using only observational data, but right now it has two \u003ccode\u003e\\(\\operatorname{do}(\\cdot)\\)\u003c/code\u003e operators in it, marked in \u003cspan style=\"color:#FF4136;\"\u003ered\u003c/span\u003e and \u003cspan style=\"color:#B10DC9;\"\u003epurple\u003c/span\u003e:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$\\sum_z P(y \\mid {\\color{#FF4136} \\operatorname{do}(x)}, z) \\times P(z \\mid {\\color{#B10DC9} \\operatorname{do}(x)})$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eWe need to get rid of those.\u003c/p\u003e\n\u003ch3 id=\"applying-rule-2\"\u003eApplying Rule 2\u003c/h3\u003e\n\u003cp\u003eFirst let’s get rid of the \u003cspan style=\"color:#FF4136;\"\u003ered\u003c/span\u003e \u003ccode\u003e\\(\\color{#FF4136} \\operatorname{do}(x)\\)\u003c/code\u003e that’s in \u003ccode\u003e\\(P(y \\mid {\\color{#FF4136} \\operatorname{do}(x)}, z)\\)\u003c/code\u003e. This chunk of the equation involves all three variables: treatment, outcome, and confounder. Accordingly, we don’t really want to ignore any of these variables by using something like Rule 1 or Rule 3. Instead, we can try to treat that \u003ccode\u003e\\(\\color{#FF4136} \\operatorname{do}(x)\\)\u003c/code\u003e as an observational \u003ccode\u003e\\(\\color{#FF4136} x\\)\u003c/code\u003e using Rule 2.\u003c/p\u003e\n\u003cp\u003eAccording to Rule 2, we can treat an interventional \u003ccode\u003e\\(\\operatorname{do}(\\cdot)\\)\u003c/code\u003e operator as observational if we meet specific criteria in a modified graph where we remove all arrows out of X:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$P(y \\mid {\\color{#FF4136} \\operatorname{do}(x)}, z) = P(y \\mid {\\color{#FF4136} x}, z) \\qquad \\text{ if } (Y \\perp X \\mid Z)_{G_{\\underline{X}}}$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eHere’s the modified \u003ccode\u003e\\(G_{\\underline{X}}\\)\u003c/code\u003e graph:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ebackdoor_g_underline_x \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edagify\u003c/span\u003e(\n  Y \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e Z,\n  X \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e Z,\n  coords \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, X \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e),\n                y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, X \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e))\n)\n\nplot_backdoor_g_underline_x \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(backdoor_g_underline_x, \n                                      \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, \n                                          xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e xend, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e yend)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_edges\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_point\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey80\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_text\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eTeX\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;$G_\\\\underline{X}$\u0026#34;\u003c/span\u003e),\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;DAG with arrows *out of* X deleted\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_do_calc\u003c/span\u003e()\n\nplot_backdoor_g \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e plot_backdoor_g_underline_x\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/09/07/do-calculus-backdoors/index_files/figure-html/backdoor-rule2-1.png\" width=\"100%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eFollowing Rule 2, we can treat \u003ccode\u003e\\(\\color{#FF4136} \\operatorname{do}(x)\\)\u003c/code\u003e like a regular observational \u003ccode\u003e\\(\\color{#FF4136} x\\)\u003c/code\u003e as long as X and Y are d-separated in this modified \u003ccode\u003e\\(G_{\\underline{X}}\\)\u003c/code\u003e graph when conditioning on Z. And that is indeed the case: there’s no direct arrow between X and Y, and by conditioning on Z, there’s no active pathway between X and Y through Z. Let’s see if code backs us up:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eimpliedConditionalIndependencies\u003c/span\u003e(backdoor_g_underline_x)\n\u003cspan style=\"color:#75715e\"\u003e## X _||_ Y | Z\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003ePerfect! Because \u003ccode\u003e\\(Y \\perp X \\mid Z\\)\u003c/code\u003e, we can treat \u003ccode\u003e\\(\\color{#FF4136} \\operatorname{do}(x)\\)\u003c/code\u003e like \u003ccode\u003e\\(\\color{#FF4136} x\\)\u003c/code\u003e.\u003c/p\u003e\n\u003ch3 id=\"applying-rule-3\"\u003eApplying Rule 3\u003c/h3\u003e\n\u003cp\u003eAfter applying Rule 2 to the first chunk of the equation, we’re still left with the \u003cspan style=\"color:#B10DC9;\"\u003epurple\u003c/span\u003e \u003ccode\u003e\\(\\color{#B10DC9} \\operatorname{do}(x)\\)\u003c/code\u003e in the second chunk:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$\\sum_z P(y \\mid {\\color{#FF4136} x}, z) \\times P(z \\mid {\\color{#B10DC9} \\operatorname{do}(x)})$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eThis second chunk doesn’t have the outcome \u003ccode\u003e\\(y\\)\u003c/code\u003e in it and instead refers only to the treatment and confounder. Since it’s not connected with the outcome, it would be neat if we could get rid of that \u003ccode\u003e\\(\\color{#B10DC9} \\operatorname{do}(x)\\)\u003c/code\u003e altogether. That’s what Rule 3 is for—ignoring interventions.\u003c/p\u003e\n\u003cp\u003eAccording to Rule 3, we can remove a \u003ccode\u003e\\(\\operatorname{do}(\\cdot)\\)\u003c/code\u003e operator as long as it doesn’t influence the outcome through any uncontrolled or unconditioned path in a modified graph. Because we’re dealing with a smaller number of variables here, the math for Rule 3 is a lot simpler:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$P(z \\mid {\\color{#B10DC9} \\operatorname{do}(x)}) = P(y \\mid {\\color{#B10DC9} \\text{nothing!}}) \\qquad \\text{ if } (X \\perp Z)_{G_{\\overline{X}}}$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eHere’s the simplified \u003ccode\u003e\\(G_{\\overline{X}}\\)\u003c/code\u003e graph:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ebackdoor_g_overline_x \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edagify\u003c/span\u003e(\n  Y \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e X \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e Z,\n  coords \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, X \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e),\n                y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, X \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e))\n)\n\nplot_backdoor_g_overline_x \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(backdoor_g_overline_x, \n                                     \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, \n                                         xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e xend, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e yend)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_edges\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_point\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey80\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_text\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eTeX\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;$G_\\\\bar{X}$\u0026#34;\u003c/span\u003e),\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;DAG with arrows *into* X deleted\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_do_calc\u003c/span\u003e()\n\nplot_backdoor_g \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e plot_backdoor_g_overline_x\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/09/07/do-calculus-backdoors/index_files/figure-html/backdoor-rule3-1.png\" width=\"100%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eAs long as X and Z are d-separated and independent, we can remove that \u003ccode\u003e\\(\\color{#B10DC9} \\operatorname{do}(x)\\)\u003c/code\u003e completely. According to this graph, there’s no direct arrow connecting them, and there’s no active pathway through Y, since Y is a collider in this case and doesn’t pass on causal association. As always, let’s verify with code:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eimpliedConditionalIndependencies\u003c/span\u003e(backdoor_g_overline_x)\n\u003cspan style=\"color:#75715e\"\u003e## X _||_ Z\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eHuzzah! \u003ccode\u003e\\(X \\perp Z\\)\u003c/code\u003e, which means we can nuke the \u003ccode\u003e\\(\\color{#B10DC9} \\operatorname{do}(x)\\)\u003c/code\u003e.\u003c/p\u003e\n\u003ch3 id=\"final-equation\"\u003eFinal equation\u003c/h3\u003e\n\u003cp\u003eAfter marginalizing across \u003ccode\u003e\\(z\\)\u003c/code\u003e, applying Rule 2, and applying Rule 3, we’re left with the following formula for backdoor adjustment:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$P(y \\mid \\operatorname{do}(x)) = \\sum_z P(y \\mid x, z) \\times P(z)$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eThat’s exactly the same formula as the general backdoor adjustment formula—we successfully derived it using \u003cem\u003edo\u003c/em\u003e-calculus rules!\u003c/p\u003e\n\u003cp\u003eMost importantly, there are no \u003ccode\u003e\\(\\operatorname{do}(\\cdot)\\)\u003c/code\u003e operators anywhere in this equation, making this estimand completely \u003cem\u003edo\u003c/em\u003e-free and estimable using non-interventional observational data! As long as we close the backdoor confounding by adjusting for Z (however you want, like through inverse probability weighting, matching, fancy machine learning stuff, or whatever else—see \u003ca href=\"https://www.andrewheiss.com/research/chapters/heiss-causal-inference-2021/\"\u003ethis chapter\u003c/a\u003e, or \u003ca href=\"https://www.andrewheiss.com/blog/2020/02/25/closing-backdoors-dags/\"\u003ethis blog post\u003c/a\u003e, or \u003ca href=\"https://evalf21.classes.andrewheiss.com/example/matching-ipw/\"\u003ethis guide\u003c/a\u003e for examples of how to do this), we can estimate the causal effect of X on Y (or \u003ccode\u003e\\(P(y \\mid \\operatorname{do}(x))\\)\u003c/code\u003e) with only observational data.\u003c/p\u003e\n\u003cp\u003eHere’s the derivation all at once:\u003c/p\u003e\n\u003cp\u003e$$\n\u003ccode\u003e\\begin{aligned} \u0026amp; [\\text{Marginalization across } z + \\text{chain rule for conditional probabilities}] \\\\ P(y \\mid \\operatorname{do}(x)) =\u0026amp; \\sum_z P(y \\mid {\\color{#FF4136} \\operatorname{do}(x)}, z) \\times P(z \\mid {\\color{#B10DC9} \\operatorname{do}(x)}) \\\\ \u0026amp; [\\text{Use Rule 2 to treat } {\\color{#FF4136} \\operatorname{do}(x)} \\text{ as } {\\color{#FF4136} x}] \\\\ =\u0026amp; \\sum_z P(y \\mid {\\color{#FF4136} x}, z) \\times P(z \\mid {\\color{#B10DC9} \\operatorname{do}(x)}) \\\\ \u0026amp; [\\text{Use Rule 3 to nuke } {\\color{#B10DC9} \\operatorname{do}(x)}] \\\\ =\u0026amp; \\sum_z P(y \\mid {\\color{#FF4136} x}, z) \\times P(z \\mid {\\color{#B10DC9} \\text{nothing!}}) \\\\ \u0026amp; [\\text{Final backdoor adjustment formula!}] \\\\ =\u0026amp; \\sum_z P(y \\mid x, z) \\times P(z) \\end{aligned}\u003c/code\u003e\n$$\u003c/p\u003e\n\u003cp\u003eThat’s so so cool!\u003c/p\u003e\n\u003cp\u003eThe frontdoor adjustment formula can be derived in a similar process—see \u003ca href=\"https://stephenmalina.com/post/2020-03-09-front-door-do-calc-derivation/#fn:1\"\u003ethe end of this post for an example\u003c/a\u003e (with that, you apply Rules 2 and 3 repeatedly until all the \u003ccode\u003e\\(\\operatorname{do}(\\cdot)\\)\u003c/code\u003e operators disappear)\u003c/p\u003e\n\u003cp\u003eAnd in cases where there’s no pre-derived backdoor or frontdoor adjustment formula, you can still apply these three \u003cem\u003edo\u003c/em\u003e-calculus rules to attempt to identify the relationship between X and Y. Not all DAGs are fully estimable, but if they are estimable, the rules of \u003cem\u003edo\u003c/em\u003e-calculus can be applied to derive the estimate. Fancier tools like \u003ca href=\"https://causalfusion.net/\"\u003eCausal Fusion\u003c/a\u003e help with this and automate the process.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003cdiv id=\"refs\" class=\"references csl-bib-body hanging-indent\"\u003e\n\u003cdiv id=\"ref-LattimoreRohde:2019\" class=\"csl-entry\"\u003e\n\u003cp\u003eLattimore, Finnian, and David Rohde. 2019. “Replacing the Do-Calculus with Bayes Rule,” December. \u003ca href=\"https://arxiv.org/abs/1906.07125\"\u003ehttps://arxiv.org/abs/1906.07125\u003c/a\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv id=\"ref-Neal:2020\" class=\"csl-entry\"\u003e\n\u003cp\u003eNeal, Brady. 2020. \u003cem\u003eIntroduction to Causal Inference from a Machine Learning Perspective\u003c/em\u003e. \u003ca href=\"https://www.bradyneal.com/causal-inference-course\"\u003ehttps://www.bradyneal.com/causal-inference-course\u003c/a\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv id=\"ref-Pearl:2012\" class=\"csl-entry\"\u003e\n\u003cp\u003ePearl, Judea. 2012. “The \u003cem\u003eDo\u003c/em\u003e-Calculus Revisited.” In \u003cem\u003eProceedings of the Twenty-Eighth Conference on Uncertainty in Artificial Intelligence\u003c/em\u003e, 3–11. UAI’12. Arlington, Virginia: AUAI Press. \u003ca href=\"https://dl.acm.org/doi/10.5555/3020652.3020654\"\u003ehttps://dl.acm.org/doi/10.5555/3020652.3020654\u003c/a\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n",
            "date_published": "2021-09-07T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2021/08/27/tikz-knitr-html-svg-fun/",
            "url": "https://www.shagunjhaver.com/blog/2021/08/27/tikz-knitr-html-svg-fun/",
            "title": "How to automatically convert TikZ images to SVG (with fonts!) from knitr",
            "summary": "Make knitr and R Markdown convert TikZ graphics to font-embedded SVG files when knitting to HTML",
            "content_html": "\u003clink rel=\"stylesheet\" href=\"gist_stuff.css\"\u003e\n\u003cdiv class=\"alert alert-success\"\u003eAn update to knitr has made it a ton easier to embed fonts in SVG files from R. \u003ca href=\"#update-easier-font-embedding\"\u003eJump to the update\u003c/a\u003e to see how.\u003c/div\u003e\n\u003cdiv class=\"alert alert-success\"\u003eAlso, it's possible to change TikZ fonts and not use Computer Modern for everything! \u003ca href=\"#another-update-changing-fonts\"\u003eJump to the second update\u003c/a\u003e to see how.\u003c/div\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cstrong\u003eContents\u003c/strong\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#knitting-tikz-chunks-to-pdf\"\u003eKnitting TikZ chunks to PDF\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#knitting-tikz-chunks-to-html-as-pngs\"\u003eKnitting TikZ chunks to HTML as PNGs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#knitting-tikz-chunks-to-html-as-svgs\"\u003eKnitting TikZ chunks to HTML as SVGs\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#connecting-dvisvgm-to-ghostscript-on-macos\"\u003eConnecting \u003ccode\u003edvisvgm\u003c/code\u003e to Ghostscript on macOS\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#connecting-dvisvgm-to-ghostscript-within-r\"\u003eConnecting \u003ccode\u003edvisvgm\u003c/code\u003e to Ghostscript within R\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#choosing-the-tikz-output-format-based-on-the-knitted-output\"\u003eChoosing the TikZ output format based on the knitted output\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#font-issues\"\u003eFont issues\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#font-solutions\"\u003eFont solutions\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tldr-final-working-version\"\u003etl;dr: Final working version\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#update-easier-font-embedding\"\u003eUPDATE: Easier font embedding!\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#another-update-changing-fonts\"\u003eANOTHER UPDATE: Changing fonts!\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#knitting-only-to-pdf\"\u003eKnitting only to PDF\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#knitting-to-pdf-and-html\"\u003eKnitting to PDF and HTML\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cstrong\u003eknitr\u003c/strong\u003e and R Markdown are essential parts of my academic writing workflow, and they make it really easy to write in one file format and then convert it to whatever output I need. When knitting to PDF, plots are all vector-based with selectable text, and math equations are all done in beautiful LaTeX. When knitting to HTML, plots are PNG files (since HTML struggles with cross-browser vector image support), and math equations are all done in beautiful MathJax. It\u0026rsquo;s a wonderful system.\u003c/p\u003e\n\u003cp\u003eOne place where the system struggles, though, is with more complex types of content like TikZ figures. TikZ lets you make all sorts of fancy diagrams and equations, but it\u0026rsquo;s a tricky language and I barely understand it, lol. There are some helpful resources about it, though:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://rmwu.github.io/\"\u003eRachel Menghua Wu\u003c/a\u003e\u0026rsquo;s crash course to TikZ (\u003ca href=\"https://rmwu.github.io/tutorial/latex/2019/08/27/intro/\"\u003epart 1\u003c/a\u003e and \u003ca href=\"https://rmwu.github.io/tutorial/latex/2019/11/21/positioning/\"\u003epart 2\u003c/a\u003e)\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.overleaf.com/learn/latex/TikZ_package\"\u003eOverleaf\u0026rsquo;s guide\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.overleaf.com/learn/latex/LaTeX_Graphics_using_TikZ:_A_Tutorial_for_Beginners_(Part_1)%E2%80%94Basic_Drawing\"\u003eOverleaf\u0026rsquo;s tutorial series\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.mathcha.io/\"\u003eMathcha\u003c/a\u003e can draw and export diagrams as TikZ, as can \u003ca href=\"http://dagitty.net/\"\u003eDAGitty\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThrough the magic of \u003cstrong\u003eknitr\u003c/strong\u003e and R Markdown, it\u0026rsquo;s actually possible to use TikZ chunks directly in an R Markdown document and have them knit to both PDF \u003cem\u003eand\u003c/em\u003e vector-based SVG files in HTML. Magic!\u003c/p\u003e\n\u003ch2 id=\"knitting-tikz-chunks-to-pdf\"\u003eKnitting TikZ chunks to PDF\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eknitr\u003c/strong\u003e has the ability to \u003ca href=\"https://yihui.org/knitr/demo/engines/\"\u003euse custom engines for rendering other languages\u003c/a\u003e, including TikZ, by including a \u003ccode\u003etikz\u003c/code\u003e chunk like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e```{tikz}\n\\begin{tikzpicture}\n% TikZ code here\n\\end{tikzpicture}\n```\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eTo try this out, make a new blank .Rmd file and put this in it:\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e(Side note: Syntax highlighting R Markdown files is tricky because they involve so many different possible languages (YAML, Markdown, R, Python, tikz, etc.), but GitHub Gists can highlight them just fine. So all these code chunks here are actually embedded Gists. If you have JavaScript enabled, or if GitHub shuts down Gist some day, or if you otherwise can\u0026rsquo;t see them, you can \u003ca href=\"https://gist.github.com/andrewheiss/55f06b079cb7064f2de5b2c174546fae\"\u003esee the original gists here\u003c/a\u003e), or you can see them in \u003ca href=\"https://github.com/andrewheiss/ath-hugo/tree/main/content/blog/2021-08-27_tikz-knitr-html-svg-fun\"\u003ethe GitHub repository for this website here\u003c/a\u003e)\u003c/em\u003e\u003c/p\u003e\n\u003cscript src=\"https://gist.github.com/andrewheiss/55f06b079cb7064f2de5b2c174546fae.js?file=example-1.Rmd\"\u003e\u003c/script\u003e\n\u003cp\u003eKnit that to PDF and you\u0026rsquo;ll see a neat little diagram of a \u003ca href=\"https://cran.r-project.org/web/packages/ggdag/vignettes/intro-to-dags.html\"\u003edirected acyclic graph\u003c/a\u003e (or DAG) (\u003ca href=\"example-1.pdf\"\u003esee full PDF here\u003c/a\u003e):\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"example-1.png\" width=\"100%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003ch2 id=\"knitting-tikz-chunks-to-html-as-pngs\"\u003eKnitting TikZ chunks to HTML as PNGs\u003c/h2\u003e\n\u003cp\u003eIf you knit that document to HTML, you\u0026rsquo;ll also see the same diagram, but it will be a low resolution PNG and will look huge and pixelated. Behind the scenes, \u003cstrong\u003eknitr\u003c/strong\u003e converts the TikZ chunk to PDF and then converts that PDF to PNG and includes it in the HTML file (\u003ca href=\"example-1.html\"\u003esee full HTML file here\u003c/a\u003e).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"example-1-pixelated.png\" width=\"70%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eThere\u0026rsquo;s theoretically a way to change the DPI of this PNG file using the \u003ccode\u003eengine.opts\u003c/code\u003e chunk option and passing additional arguments to ImageMagick, which handles the conversion, but it only causes errors for me (\u003ccode\u003eError in magick_image_format(image, toupper(format), type, colorspace, : Invalid ImageType value: -density 300\u003c/code\u003e) and I can\u0026rsquo;t figure out why (see \u003ca href=\"https://stackoverflow.com/questions/51735831/is-it-possible-to-increase-resolution-of-image-inserted-to-word-document-from-rm\"\u003ethis StackOverflow post too\u003c/a\u003e) :\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e```{tikz, engine.opts = list(convert.opts = \u0026#39;-density 300\u0026#39;), fig.ext=\u0026#34;png\u0026#34;}\n% Stuff here\n```\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"knitting-tikz-chunks-to-html-as-svgs\"\u003eKnitting TikZ chunks to HTML as SVGs\u003c/h2\u003e\n\u003cp\u003eBut even if I could get it to work, PNG files aren\u0026rsquo;t great for vector-like things like TikZ diagrams. It would be great if instead I could convert these diagrams to vector-based SVG files.\u003c/p\u003e\n\u003cp\u003eFortunately \u003cstrong\u003eknitr\u003c/strong\u003e handles that too! Try this! (Note the \u003ccode\u003eself_contained: no\u003c/code\u003e in the YAML metadata—this will create a standalone DVI and SVG file in a folder named \u003ccode\u003e\u0026lt;NAME_OF_RMD\u0026gt;_files/html-figures/\u003c/code\u003e. You don\u0026rsquo;t technically need this—without it, R will embed the images as base64-encoded text—but to make it easier to see the files R makes, we\u0026rsquo;ll disable it)\u003c/p\u003e\n\u003cscript src=\"https://gist.github.com/andrewheiss/55f06b079cb7064f2de5b2c174546fae.js?file=example-2.Rmd\"\u003e\u003c/script\u003e\n\u003cp\u003eYou\u0026rsquo;ll most likely get an error about Ghostscript:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-Text\" data-lang=\"Text\"\u003eprocessing of PostScript specials is disabled (Ghostscript not found)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"connecting-dvisvgm-to-ghostscript-on-macos\"\u003eConnecting \u003ccode\u003edvisvgm\u003c/code\u003e to Ghostscript on macOS\u003c/h3\u003e\n\u003cp\u003eUnfortunately it takes a little bit of initial setup to get all the moving pieces working for it to happen. To go from TikZ to SVG, \u003cstrong\u003eknitr\u003c/strong\u003e first converts the \u003ccode\u003etikz\u003c/code\u003e chunk to DVI and then uses the terminal program \u003ccode\u003edvisvgm\u003c/code\u003e to convert the DVI to SVG. Getting \u003ccode\u003edvisvgm\u003c/code\u003e working on macOS is tricky though (and presumably it\u0026rsquo;s tricky on Windows too, but I don\u0026rsquo;t have a Windows machine to test it on).\u003c/p\u003e\n\u003cp\u003eThe most typical way of installing the LaTeX ecosystem on macOS is to install \u003ca href=\"https://www.tug.org/mactex/\"\u003eMacTeX\u003c/a\u003e, which comes with all the dozens of special utilities TeX uses for typesetting. MacTeX comes with both \u003ccode\u003edvisvgm\u003c/code\u003e and a special program called Ghostscript that handles text in DVI files. HOWEVER, by default it does not provide a way to have \u003ccode\u003edvisvgm\u003c/code\u003e and Ghostscript talk to each other (there\u0026rsquo;s \u003ca href=\"https://tex.stackexchange.com/questions/559640/making-dvisvgm-and-ghostscript-from-mactex-talk-to-each-other\"\u003ea whole post about it here\u003c/a\u003e). Ghostscript really is installed, though—\u003ccode\u003edvisvgm\u003c/code\u003e just can\u0026rsquo;t see it.\u003c/p\u003e\n\u003cp\u003eTo fix it, you actually need to reinstall MacTex and choose a custom installation option. When you get to the \u0026ldquo;Installation Type\u0026rdquo; section in the package installation dialog box, click on \u0026ldquo;Customize\u0026rdquo; and then make sure the box is checked for \u0026ldquo;Ghostscript Dynamic Library\u0026rdquo;. By default this is not checked, and I have no clue why, since this is the bridge that you need to get \u003ccode\u003edvisvgm\u003c/code\u003e and Ghostscript to talk to each other.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"install-mactex.png\" width=\"70%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eInstall MacTeX with that option enabled and you\u0026rsquo;ll have a special new file nested deep within your filesystem at \u003ccode\u003e/usr/local/share/ghostscript/9.53.3/lib/libgs.dylib.9.53\u003c/code\u003e. This \u003ccode\u003elibgs.dylib.**\u003c/code\u003e file is the dynamic library that \u003ccode\u003edvisvgm\u003c/code\u003e needs to know about to work. MacTex 2021 installs Ghostscript 9.53.3, so later versions of MacTex will place \u003ccode\u003elibgs.dylib\u003c/code\u003e somewhere else.\u003c/p\u003e\n\u003cp\u003eTo tell \u003ccode\u003edvisvgm\u003c/code\u003e where this dynamic library is, you then need to set an environment variable. Open \u003ccode\u003e~/.bash_profile\u003c/code\u003e or \u003ccode\u003e~/.zshrc\u003c/code\u003e or whatever you use for setting your PATH and other terminal settings and add this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003eexport LIBGS\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e/usr/local/share/ghostscript/9.53.3/lib/libgs.dylib.9.53\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eOpen a new terminal window and type \u003ccode\u003eprint $LIBGS\u003c/code\u003e to verify that the environment variable was actually set. Now you should be able to run \u003ccode\u003edvisvgm -l\u003c/code\u003e and see an entry for \u003ccode\u003eps\u003c/code\u003e in it (see \u003ca href=\"https://dvisvgm.de/FAQ/\"\u003ethis FAQ page\u003c/a\u003e for lots of other details and help for troubleshooting this):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e$ dvisvgm -l\n...\nps         dvips PostScript specials\n...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThat means everything\u0026rsquo;s working and you should now be able to convert from DVI to SVG!\u003c/p\u003e\n\u003ch3 id=\"connecting-dvisvgm-to-ghostscript-within-r\"\u003eConnecting \u003ccode\u003edvisvgm\u003c/code\u003e to Ghostscript within R\u003c/h3\u003e\n\u003cp\u003eHowever, RStudio doesn\u0026rsquo;t pick up your shell\u0026rsquo;s environment variables when knitting files, so if you knit the document with \u003ccode\u003efix.ext='svg'\u003c/code\u003e enabled, you\u0026rsquo;ll still get an error about Ghostscript not being found.\u003c/p\u003e\n\u003cp\u003eTo get around this, you can actually set environment variables from within the R Markdown document itself. Add \u003ccode\u003eSys.setenv()\u003c/code\u003e to an invisible chunk like this:\u003c/p\u003e\n\u003cscript src=\"https://gist.github.com/andrewheiss/55f06b079cb7064f2de5b2c174546fae.js?file=example-3.Rmd\"\u003e\u003c/script\u003e\n\u003cp\u003eAnd now everything should work! You\u0026rsquo;ll get an HTML file with a vector-based SVG version of the TikZ figure (\u003ca href=\"example-2.html\"\u003esee full HTML file here\u003c/a\u003e):\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"example-2.png\" width=\"70%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003ch3 id=\"choosing-the-tikz-output-format-based-on-the-knitted-output\"\u003eChoosing the TikZ output format based on the knitted output\u003c/h3\u003e\n\u003cp\u003eWe can now knit this TikZ chunk to PDF if we use \u003ccode\u003efig.ext=\u0026quot;pdf\u0026quot;\u003c/code\u003e and to SVG if we use \u003ccode\u003efig.ext=\u0026quot;svg\u0026quot;\u003c/code\u003e in the chunk options. Remembering to switch these extensions manually, though, is tedious. To make life a little easier, we can create some conditional output types using \u003cstrong\u003eknitr\u003c/strong\u003e\u0026rsquo;s (newer?) \u003ccode\u003eopts-template\u003c/code\u003e ability, which lets you create chunk option templates that you can reuse throughout the document. Here, we\u0026rsquo;ll use \u003ccode\u003efig.ext=\u0026quot;pdf\u0026quot;\u003c/code\u003e when knitting to PDF, and \u003ccode\u003efig.ext=\u0026quot;svg\u0026quot;\u003c/code\u003e otherwise. If I could get the TikZ → PNG conversion working nicely, I\u0026rsquo;d make it use \u003ccode\u003efig.ext=\u0026quot;png\u0026quot;\u003c/code\u003e when knitting to Word, too.\u003c/p\u003e\n\u003cscript src=\"https://gist.github.com/andrewheiss/55f06b079cb7064f2de5b2c174546fae.js?file=example-4.Rmd\"\u003e\u003c/script\u003e\n\u003cp\u003eNow if you knit that file ↑ to PDF, it will create a PDF TikZ image; if you knit to HTML, it will create an SVG image through \u003ccode\u003edvisvgm\u003c/code\u003e. Magic!\u003c/p\u003e\n\u003ch3 id=\"font-issues\"\u003eFont issues\u003c/h3\u003e\n\u003cp\u003eYou\u0026rsquo;ll notice that we\u0026rsquo;ve only been using text-less TikZ figures as an example so far. TikZ handles text just fine—it processes it through LaTeX and lets you do everything regular LaTeX typesetting does, so you can add fancy equations and Greek letters, etc. to diagrams. Let\u0026rsquo;s add some letters with subscripts:\u003c/p\u003e\n\u003cscript src=\"https://gist.github.com/andrewheiss/55f06b079cb7064f2de5b2c174546fae.js?file=example-5.Rmd\"\u003e\u003c/script\u003e\n\u003cp\u003eWhen knitting to PDF, this diagram looks great, typeset in Computer Modern like any standard LaTeX document(\u003ca href=\"example-5.pdf\"\u003esee full PDF here\u003c/a\u003e):\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"example-5-pdf.png\" width=\"100%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eWhen knitting to HTML, the SVG version of the diagram also works, except for the fonts, since \u003ccode\u003edvisvgm\u003c/code\u003e doesn\u0026rsquo;t embed the fonts by default (\u003ca href=\"example-5.html\"\u003esee full HTML file here\u003c/a\u003e):\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"example-5.png\" width=\"70%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eIf you open the SVG file that R generates (find it at \u003ccode\u003e\u0026lt;RMD_filename\u0026gt;_files/figure-html/unnamed-chunk-1-1.svg\u003c/code\u003e) in something like Illustrator, it will complain about font references that are missing, like \u003ccode\u003ecmmi10\u003c/code\u003e and \u003ccode\u003ecmmi7\u003c/code\u003e:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"illustrator.png\" width=\"50%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eAnd if you open the SVG file in a text editor you\u0026rsquo;ll notice references to font names, but those assume that you have fonts named \u0026ldquo;cmmi7\u0026rdquo; and \u0026ldquo;cmmi10\u0026rdquo; on your computer, which is doubtful:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-xml\" data-lang=\"xml\"\u003e...\n\u003cspan style=\"color:#f92672\"\u003e\u0026lt;font\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eid=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;cmmi7\u0026#39;\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ehoriz-adv-x=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;0\u0026#39;\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#f92672\"\u003e\u0026lt;font-face\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efont-family=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;cmmi7\u0026#39;\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eunits-per-em=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;1000\u0026#39;\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eascent=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;750\u0026#39;\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edescent=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;250\u0026#39;\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u0026gt;\u003c/span\u003e\n...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"font-solutions\"\u003eFont solutions\u003c/h3\u003e\n\u003cp\u003eFortunately there\u0026rsquo;s a solution! \u003ccode\u003edvisvgm\u003c/code\u003e has an optional flag (\u003ccode\u003e--font-format=woff\u003c/code\u003e) that will embed the special LaTeX fonts using a base64-encoded web-optimized WOFF file, which means the SVG file should show the correct fonts in any modern browser or editor.\u003c/p\u003e\n\u003cp\u003eHowever, there\u0026rsquo;s currently not a direct way to use that flag with \u003cstrong\u003eknitr\u003c/strong\u003e. The command for \u003ccode\u003edvisvgm\u003c/code\u003e is hardcoded into \u003cstrong\u003eknitr\u003c/strong\u003e\u0026rsquo;s code and you can\u0026rsquo;t add any extra arguments (though \u003ca href=\"https://github.com/yihui/knitr/issues/2038\"\u003eI\u0026rsquo;ve opened an issue at GitHub\u003c/a\u003e about this).\u003c/p\u003e\n\u003cp\u003eBut never fear! There\u0026rsquo;s a neat roundabout way around this!\u003c/p\u003e\n\u003cp\u003eYou can use \u003ca href=\"https://bookdown.org/yihui/rmarkdown-cookbook/chunk-hooks.html\"\u003especial chunk hooks\u003c/a\u003e in \u003cstrong\u003eknitr\u003c/strong\u003e to run functions before or after chunks are rendered. We can create a function that runs after a TikZ chunk is rendered that takes the temporary DVI file that \u003cstrong\u003eknitr\u003c/strong\u003e creates and then runs \u003ccode\u003edvisvgm --font-format=woff\u003c/code\u003e on it, thus overwriting the non-embedded SVG file that \u003cstrong\u003eknitr\u003c/strong\u003e makes with its hardcoded \u003ccode\u003edvisvgm\u003c/code\u003e command. Here\u0026rsquo;s one way to do it (which I adapted from \u003ca href=\"https://github.com/yihui/knitr/blob/3237add034368a3018ff26fa9f4d0ca89a4afd78/R/hooks-extra.R#L74\"\u003ethe built-in \u003ccode\u003ehook_png()\u003c/code\u003e function\u003c/a\u003e):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eembed_svg_fonts \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(before, options, envir) {\n  \u003cspan style=\"color:#75715e\"\u003e# !before means after the chunk is run\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eif \u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e!\u003c/span\u003ebefore) {\n    \u003cspan style=\"color:#75715e\"\u003e# Get a list of all the plot files this chunk makes\u003c/span\u003e\n    paths \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e knitr\u003cspan style=\"color:#f92672\"\u003e:::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eget_plot_files\u003c/span\u003e()\n\n    \u003cspan style=\"color:#75715e\"\u003e# Loop through all the plot files. When dealing with SVG, knitr actually\u003c/span\u003e\n    \u003cspan style=\"color:#75715e\"\u003e# creates two different files: an initial DVI and the converted SVG. We\u0026#39;ll\u003c/span\u003e\n    \u003cspan style=\"color:#75715e\"\u003e# use the original DVI and pass it through dvisvgm again, this time with\u003c/span\u003e\n    \u003cspan style=\"color:#75715e\"\u003e# --font-format=woff enabled. This will overwrite the SVG that knitr makes\u003c/span\u003e\n    knitr\u003cspan style=\"color:#f92672\"\u003e:::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ein_base_dir\u003c/span\u003e(\n      \u003cspan style=\"color:#a6e22e\"\u003elapply\u003c/span\u003e(paths, \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(x) {\n        \u003cspan style=\"color:#a6e22e\"\u003emessage\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Embedding fonts in \u0026#34;\u003c/span\u003e, x)\n        path_svg \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e xfun\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ewith_ext\u003c/span\u003e(x, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;svg\u0026#34;\u003c/span\u003e)\n        path_dvi \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e xfun\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ewith_ext\u003c/span\u003e(x, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;dvi\u0026#34;\u003c/span\u003e)\n        \n        \u003cspan style=\"color:#a6e22e\"\u003eif \u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003esystem2\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;dvisvgm\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;--font-format=woff\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;-o\u0026#39;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eshQuote\u003c/span\u003e(path_svg), \u003cspan style=\"color:#a6e22e\"\u003eshQuote\u003c/span\u003e(path_dvi))) \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)\n          \u003cspan style=\"color:#a6e22e\"\u003estop\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;Failed to convert \u0026#39;\u003c/span\u003e, path_dvi, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39; to \u0026#39;\u003c/span\u003e, path_svg)\n      })\n    )\n  }\n}\n\n\u003cspan style=\"color:#75715e\"\u003e# Register the function as a possible hook\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# Use this in a chunk by setting embed_svg_fonts=TRUE in the chunk options\u003c/span\u003e\nknitr\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003eknit_hooks\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eset\u003c/span\u003e(embed_svg_fonts \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e embed_svg_fonts)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eStick that ↑ in an invisible chunk (probably in the same one with \u003ccode\u003eSys.setenv(LIBGS = \u0026quot;blah\u0026quot;)\u003c/code\u003e), and then add \u003ccode\u003eembed_svg_fonts=TRUE\u003c/code\u003e to the chunk options of the TikZ chunk, and it should work. When you knit, you\u0026rsquo;ll see two messages about converting DVI to SVG. We don\u0026rsquo;t care about the first—that\u0026rsquo;s \u003cstrong\u003eknitr\u003c/strong\u003e\u0026rsquo;s basic version without embedded fonts. The second message corresponds to the command we created with the hook, which includes \u003ccode\u003e--font-format=woff\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s what the SVG file looks like now with the fonts embedded in it (\u003ca href=\"dag-text-1.svg\"\u003esee full SVG file here\u003c/a\u003e):\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"dag-text-1.svg\" width=\"40%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003ch2 id=\"tldr-final-working-version\"\u003etl;dr: Final working version\u003c/h2\u003e\n\u003cp\u003eHere\u0026rsquo;s what your final R Markdown file should look like:\u003c/p\u003e\n\u003cscript src=\"https://gist.github.com/andrewheiss/55f06b079cb7064f2de5b2c174546fae.js?file=example-final.Rmd\"\u003e\u003c/script\u003e\n\u003cp\u003eWhen knitting to PDF, the TikZ figure will show up as a regular PDF image, as excepted. When knitting to HTML, though, \u003cstrong\u003eknitr\u003c/strong\u003e will create a DVI version of the image and then convert that to SVG (but without font embedding enabled in \u003ccode\u003edvisvgm\u003c/code\u003e). Then finally, because of the post-rendering hook, \u003cstrong\u003eknitr\u003c/strong\u003e will run the \u003ccode\u003eembed_svg_fonts()\u003c/code\u003e function on the DVI and create a new SVG with fonts embedded that will overwrite the original SVG file.\u003c/p\u003e\n\u003cp\u003eLook at that! So great! (\u003ca href=\"example-final.html\"\u003esee full HTML file here\u003c/a\u003e):\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"example-final.png\" width=\"70%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003ch2 id=\"update-easier-font-embedding\"\u003eUPDATE: Easier font embedding!\u003c/h2\u003e\n\u003cp\u003eI submitted \u003ca href=\"https://github.com/yihui/knitr/pull/2039\"\u003ea pull request to \u003cstrong\u003eknitr\u003c/strong\u003e\u003c/a\u003e that would allow users to specify additional arguments to \u003ccode\u003edvisvgm\u003c/code\u003e from a chunk, and it was just merged in, so with the development version of \u003cstrong\u003eknitr\u003c/strong\u003e (and someday with the CRAN version, once a new version is eventually submitted), you can use the \u003ccode\u003edvisvgm.opts\u003c/code\u003e option in the \u003ccode\u003eengine.opts\u003c/code\u003e chunk options like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e```{tikz, fig.ext=\u0026#34;svg\u0026#34;, engine.opts=list(dvisvgm.opts = \u0026#34;--font-format=woff\u0026#34;)}\n% Stuff here\n```\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eSo now there\u0026rsquo;s no need for the \u003ccode\u003eembed_svg_fonts()\u003c/code\u003e hook function! This should work now for the complete DAG example:\u003c/p\u003e\n\u003cscript src=\"https://gist.github.com/andrewheiss/55f06b079cb7064f2de5b2c174546fae.js?file=example-final-new.Rmd\"\u003e\u003c/script\u003e\n\u003ch2 id=\"another-update-changing-fonts\"\u003eANOTHER UPDATE: Changing fonts!\u003c/h2\u003e\n\u003cp\u003eYou\u0026rsquo;re not limited to the default (and kinda ugly) Computer Modern font with TikZ chunks, but changing the font is a little tricky becuase each TikZ chunk in \u003cstrong\u003eknitr\u003c/strong\u003e is treated as a standalone LaTeX document, so you need to adjust the fonts in each chunk.\u003c/p\u003e\n\u003ch3 id=\"knitting-only-to-pdf\"\u003eKnitting only to PDF\u003c/h3\u003e\n\u003cp\u003eIf you\u0026rsquo;re \u003cem\u003eonly\u003c/em\u003e interested in knitting to PDF, you can use XeTeX to embed any font you want in the diagram. When using XeTeX, you\u0026rsquo;d typically add something like this to the preamble of your document to change the document font:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-latex\" data-lang=\"latex\"\u003e\u003cspan style=\"color:#66d9ef\"\u003e\\usepackage\u003c/span\u003e{fontspec}\n\u003cspan style=\"color:#66d9ef\"\u003e\\setmainfont\u003c/span\u003e{Comic Sans MS}  \u003cspan style=\"color:#75715e\"\u003e% ew\n\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eEach standalone TikZ knitr chunk gets passed to \u003ca href=\"https://github.com/yihui/knitr/blob/master/inst/misc/tikz2pdf.tex\"\u003ea special \u003ccode\u003etikz2pdf.tex\u003c/code\u003e template\u003c/a\u003e. The content of the chunk is inserted in the \u003ccode\u003e%% TIKZ_CODE %%\u003c/code\u003e area, and there\u0026rsquo;s a space in the template for preamble things at \u003ccode\u003e%% EXTRA_TIKZ_PREAMBLE_CODE %%\u003c/code\u003e. To get content inserted there, you can use the \u003ccode\u003eextra.preamble\u003c/code\u003e option in \u003ccode\u003eengine.opts\u003c/code\u003e like so:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e```{tikz, engine.opts=list(extra.preamble=c(\u0026#34;\\\\usepackage{fontspec}\u0026#34;, \u0026#34;\\\\setmainfont{Comic Sans MS}\u0026#34;))}\n% Stuff here\n```\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThat won\u0026rsquo;t work right away though. When you knit, \u003cstrong\u003eknitr\u003c/strong\u003e uses the default \u003ccode\u003epdflatex\u003c/code\u003e LaTeX engine to render each TikZ chunk, and you\u0026rsquo;ll get an error because \u003ccode\u003efontspec\u003c/code\u003e only works with XeTeX. You can tell \u003cstrong\u003eknitr\u003c/strong\u003e to use \u003ccode\u003exelatex\u003c/code\u003e to render those chunks if you set the \u003ccode\u003etinytex.engine\u003c/code\u003e option:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eoptions\u003c/span\u003e(tinytex.engine \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;xelatex\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eOnce you set \u003ccode\u003exelatex\u003c/code\u003e as the default LaTeX engine for the document, all TikZ chunks will render correctly. Here\u0026rsquo;s a complete example (note that I moved the \u003ccode\u003eextra.preamble\u003c/code\u003e stuff to a separate variable so that it\u0026rsquo;s easier to reuse) (\u003ca href=\"example-xelatex.pdf\"\u003esee full PDF here\u003c/a\u003e):\u003c/p\u003e\n\u003cscript src=\"https://gist.github.com/andrewheiss/55f06b079cb7064f2de5b2c174546fae.js?file=example-xelatex.Rmd\"\u003e\u003c/script\u003e\n\u003cp\u003e\u003cimg src=\"example-xelatex.png\" width=\"70%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003ch3 id=\"knitting-to-pdf-and-html\"\u003eKnitting to PDF and HTML\u003c/h3\u003e\n\u003cp\u003eThis is a little trickier if you want to convert these TikZ chunks to SVG when knitting to HTML. \u003cstrong\u003eknitr\u003c/strong\u003e ignores the \u003ccode\u003etinytex.engine\u003c/code\u003e option when you knit to HTML, so there\u0026rsquo;s no way to tell TikZ chunks to get processed through \u003ccode\u003exelatex\u003c/code\u003e. Additionally, \u003ccode\u003exelatex\u003c/code\u003e does not produce .dvi files, which \u003ccode\u003edvisvgm\u003c/code\u003e uses to convert to SVG. \u003ccode\u003exelatex\u003c/code\u003e instead creates its own special .xdv files. In theory, newer versions of \u003ccode\u003edvisvgm\u003c/code\u003e should work with XDV files, but \u003cstrong\u003eknitr\u003c/strong\u003e is hard-coded to pass DVI files to \u003ccode\u003edvisvgm\u003c/code\u003e, not XDV files. So even if we could force TikZ chunks to go through \u003ccode\u003exelatex\u003c/code\u003e, they wouldn\u0026rsquo;t be converted to SVG. Alas.\u003c/p\u003e\n\u003cp\u003eBut all is not lost! It\u0026rsquo;s possible to change fonts in non-XeTeX documents. Because you\u0026rsquo;re limited to whatever \u003ccode\u003epdflatex\u003c/code\u003e can support, you can only use specific font packages instead of whatever font you want. For instance, to use \u003ca href=\"https://ctan.org/pkg/tex-gyre-pagella\"\u003eTEX Gyre Pagella\u003c/a\u003e, include \u003ccode\u003e\\usepackage{tgpagella}\u003c/code\u003e in your preamble. \u003ca href=\"https://www.overleaf.com/learn/latex/Font_typefaces\"\u003eSee this\u003c/a\u003e for a basic list of possible font packages, or \u003ca href=\"https://tug.org/FontCatalogue/\"\u003ethis for a pretty complete catalogue\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eFor instance, here\u0026rsquo;s how to use \u003ca href=\"https://tug.org/FontCatalogue/linuxlibertine/\"\u003eLinux Libertine\u003c/a\u003e for text and \u003ca href=\"https://github.com/alerque/libertinus\"\u003eLibertinus Math\u003c/a\u003e for math \u003cem\u003ewith\u003c/em\u003e embedded SVG fonts when knitting to HTML (\u003ca href=\"example-svg-libertine.html\"\u003esee full HTML file here\u003c/a\u003e):\u003c/p\u003e\n\u003cscript src=\"https://gist.github.com/andrewheiss/55f06b079cb7064f2de5b2c174546fae.js?file=example-svg-libertine.Rmd\"\u003e\u003c/script\u003e\n\u003cp\u003e\u003cimg src=\"example-svg-libertine.png\" width=\"70%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eOr with \u003ca href=\"https://tug.org/FontCatalogue/gfsartemisiaeulermath/\"\u003eGFS Artemisia with Euler for math\u003c/a\u003e (\u003ca href=\"example-svg-artemisia.html\"\u003esee full HTML file here\u003c/a\u003e):\u003c/p\u003e\n\u003cscript src=\"https://gist.github.com/andrewheiss/55f06b079cb7064f2de5b2c174546fae.js?file=example-svg-artemisia.Rmd\"\u003e\u003c/script\u003e\n\u003cp\u003e\u003cimg src=\"example-svg-artemisia.png\" width=\"70%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n",
            "date_published": "2021-08-27T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2021/08/25/twfe-diagnostics/",
            "url": "https://www.shagunjhaver.com/blog/2021/08/25/twfe-diagnostics/",
            "title": "Exploring Pamela Jakiela's simple TWFE diagnostics with R",
            "summary": "Use R to explore possible biases that come from differential treatment timing in two-way fixed effects (TWFE) regression models",
            "content_html": "\u003cscript src=\"https://www.shagunjhaver.com/blog/2021/08/25/twfe-diagnostics/index_files/kePrint/kePrint.js\"\u003e\u003c/script\u003e\n\u003clink href=\"https://www.shagunjhaver.com/blog/2021/08/25/twfe-diagnostics/index_files/lightable/lightable.css\" rel=\"stylesheet\" /\u003e\n\u003cscript src=\"https://www.shagunjhaver.com/blog/2021/08/25/twfe-diagnostics/index_files/kePrint/kePrint.js\"\u003e\u003c/script\u003e\n\u003clink href=\"https://www.shagunjhaver.com/blog/2021/08/25/twfe-diagnostics/index_files/lightable/lightable.css\" rel=\"stylesheet\" /\u003e\n\u003ch2 id=\"contents----omit-in-toc---\"\u003eContents \u003c!-- omit in toc --\u003e\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#a-different-way-of-thinking-about-ols-coefficients\"\u003eA different way of thinking about OLS coefficients\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#residualized-weights-with-twfe-models\"\u003eResidualized weights with TWFE models\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#load-and-clean-data\"\u003eLoad and clean data\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#model-specification\"\u003eModel specification\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#twfe-models-with-r\"\u003eTWFE models with R\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#twfe-estimate-with-residualized-treatment-weights\"\u003eTWFE estimate with residualized treatment weights\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#jakielas-diagnostics\"\u003eJakiela’s diagnostics\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#31-do-treated-observations-receive-negative-weights\"\u003e3.1: Do treated observations receive negative weights?\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#32-testing-the-homogeneity-assumption-directly\"\u003e3.2: Testing the homogeneity assumption directly\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#jakielas-robustness-checks\"\u003eJakiela’s robustness checks\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#exclude-later-years\"\u003eExclude later years\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#change-how-many-post-treatment-years-are-kept\"\u003eChange how many post-treatment years are kept\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#exclude-individual-countries\"\u003eExclude individual countries\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tldr-conclusion\"\u003etl;dr: Conclusion\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#references\"\u003eReferences\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003cp\u003eThe world of econometrics has been roiled over the past couple years with a bunch of new papers showing how two-way fixed effects (TWFE; situations with nested levels of observations, like country-year, state-month, etc.) estimates of causal effects from difference-in-differences-based natural experiments can be biased when treatment is applied at different times. There are a ton of these papers, like \u003ca href=\"#ref-de-ChaisemartindHaultfoeuille:2020\"\u003ede Chaisemartin and d’Haultfoeuille\u003c/a\u003e (\u003ca href=\"#ref-de-ChaisemartindHaultfoeuille:2020\"\u003e2020\u003c/a\u003e), \u003ca href=\"#ref-Goodman-Bacon:2021\"\u003eGoodman-Bacon\u003c/a\u003e (\u003ca href=\"#ref-Goodman-Bacon:2021\"\u003e2021\u003c/a\u003e), \u003ca href=\"#ref-SunAbraham:2020\"\u003eSun and Abraham\u003c/a\u003e (\u003ca href=\"#ref-SunAbraham:2020\"\u003e2020\u003c/a\u003e), \u003ca href=\"#ref-CallawaySantAnna:2020\"\u003eCallaway and Sant’Anna\u003c/a\u003e (\u003ca href=\"#ref-CallawaySantAnna:2020\"\u003e2020\u003c/a\u003e), and \u003ca href=\"#ref-BakerLarckerWang:2021\"\u003eBaker, Larcker, and Wang\u003c/a\u003e (\u003ca href=\"#ref-BakerLarckerWang:2021\"\u003e2021\u003c/a\u003e). And they’re all really technical and scary.\u003c/p\u003e\n\u003cp\u003eI’ve been peripherally following these discussions on Twitter, since I teach a class on causal inference and include \u003ca href=\"https://evalf21.classes.andrewheiss.com/example/diff-in-diff/\"\u003ea couple sessions and assignments on difference-in-differences approaches\u003c/a\u003e, and since I do lots of \u003ca href=\"https://www.andrewheiss.com/research/articles/chaudhry-heiss-ngos-aid/\"\u003eresearch with country-year panel data\u003c/a\u003e (see \u003ca href=\"https://www.andrewheiss.com/blog/tags/inverse-probability-weighting/\"\u003eall my posts on marginal structural models\u003c/a\u003e for more on that), but I’ve admittedly been lost in the mathy details of all these papers and I’ve been slightly terrified of trying to work through these papers and figuring out what this differential timing bias actually looks like in real life. I’m not a real economist or econometrician (I just teach microeconomics and econometrics lolz), so this world is still pretty intimidating for me.\u003c/p\u003e\n\u003cp\u003eBut \u003ca href=\"https://pjakiela.github.io/\"\u003ePamela Jakiela\u003c/a\u003e recently posted \u003ca href=\"https://arxiv.org/abs/2103.13229\"\u003ea working paper called “Simple Diagnostics for Two-Way Fixed Effects”\u003c/a\u003e (\u003ca href=\"#ref-Jakiela:2021\"\u003eJakiela 2021\u003c/a\u003e) where she presents an easy-to-follow example of all this newfangled TWFE work, so I figured I’d finally officially plunge into this new TWFE world and try to figure out what it all means. Her paper is fantastic—you should read it if you want a quick introduction to the issues of differential timing and TWFE and if you want some easy ways to see how bad these situations might bias causal estimates.\u003c/p\u003e\n\u003cp\u003eIn the spirit of \u003ca href=\"http://arelbundock.com/\"\u003eVincent Arel-Bundock\u003c/a\u003e, who publicly codes through more technical papers to understand them better (see \u003ca href=\"http://arelbundock.com/posts/frontdoor/\"\u003ethis\u003c/a\u003e or \u003ca href=\"http://arelbundock.com/posts/robustness_values/\"\u003ethis\u003c/a\u003e or \u003ca href=\"http://arelbundock.com/posts/marginal_structural_models/\"\u003ethis\u003c/a\u003e), this post is my attempt at translating Jakiela’s paper from conceptual math and Stata code into R. Here we go!\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)     \u003cspan style=\"color:#75715e\"\u003e# For ggplot2, dplyr, and friends\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(haven)         \u003cspan style=\"color:#75715e\"\u003e# For reading Stata files\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(fixest)        \u003cspan style=\"color:#75715e\"\u003e# One way of doing fixed effects regression\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(estimatr)      \u003cspan style=\"color:#75715e\"\u003e# Another way of doing fixed effects regression\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(broom)         \u003cspan style=\"color:#75715e\"\u003e# For converting model objects to data frames\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(kableExtra)    \u003cspan style=\"color:#75715e\"\u003e# For pretty tables\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(modelsummary)  \u003cspan style=\"color:#75715e\"\u003e# For pretty regression tables\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(patchwork)     \u003cspan style=\"color:#75715e\"\u003e# For combining plots\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(scales)        \u003cspan style=\"color:#75715e\"\u003e# For nice formatting functions\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Custom ggplot theme to make pretty plots\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# Get the font at https://fonts.google.com/specimen/Barlow+Semi+Condensed\u003c/span\u003e\ntheme_clean \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e() {\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_minimal\u003c/span\u003e(base_family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Barlow Semi Condensed\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n    \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(panel.grid.minor \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e(),\n          plot.title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(face \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bold\u0026#34;\u003c/span\u003e),\n          axis.title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Barlow Semi Condensed Medium\u0026#34;\u003c/span\u003e),\n          strip.text \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Barlow Semi Condensed\u0026#34;\u003c/span\u003e,\n                                    face \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bold\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erel\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e), hjust \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e),\n          strip.background \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_rect\u003c/span\u003e(fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey80\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNA\u003c/span\u003e),\n          plot.caption \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(hjust \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e))\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"a-different-way-of-thinking-about-ols-coefficients\"\u003eA different way of thinking about OLS coefficients\u003c/h2\u003e\n\u003cp\u003eBefore diving into the issues that come with TWFE estimation (and Jakiela’s proposed diagnostics), we first have to think about regression coefficients in a slightly different way (that was completely new to me!)\u003c/p\u003e\n\u003cp\u003eTo do this, let’s make some simulated data to play with. We have two variables: (1) an outcome that ranges from ≈400–2000, and (2) a continuous treatment that ranges from ≈2–70. For the sake of simplicity, we’ll pretend that the outcome represents weekly income, and the treatment is some sort of social policy (test scores from some job training program? idk—imagine something neat here). We’ll also pretend that this treatment is experimental so we can talk about causation here.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eset.seed\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1234\u003c/span\u003e)  \u003cspan style=\"color:#75715e\"\u003e# For reproducibility\u003c/span\u003e\n\nn_rows \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e500\u003c/span\u003e\nfake_data \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(treatment \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erbeta\u003c/span\u003e(n_rows, shape1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, shape2 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e7\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(treatment \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eround\u003c/span\u003e(treatment \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Build the outcome based on some baseline level of outcome + a boost in\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# outcome that happens because of the treatment + some noise\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(outcome_baseline \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n_rows, mean \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e800\u003c/span\u003e, sd \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e200\u003c/span\u003e),\n         treatment_boost \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e treatment,\n         outcome \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e outcome_baseline \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e treatment_boost \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n_rows, \u003cspan style=\"color:#ae81ff\"\u003e200\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(outcome, treatment)\n\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(fake_data)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 × 2\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   outcome treatment\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1    514.        13\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2   1550.        35\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3   1562.        52\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4   1037.         4\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5   1137.        38\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6   1277.        39\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor reference, here’s what the distributions of these variables look like, along with the relationship between treatment and outcome:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ehist_out \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(fake_data, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e outcome)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_histogram\u003c/span\u003e(binwidth \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;white\u0026#34;\u003c/span\u003e,\n                 boundary \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FFA615\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_x_continuous\u003c/span\u003e(labels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edollar_format\u003c/span\u003e()) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Distribution of outcome\u0026#34;\u003c/span\u003e,\n       x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Outcome\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Count\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_cartesian\u003c/span\u003e(ylim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e80\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_clean\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(panel.grid.major.x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e())\n\nhist_trt \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(fake_data, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e treatment)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_histogram\u003c/span\u003e(binwidth \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;white\u0026#34;\u003c/span\u003e,\n                 boundary \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#A4BD0A\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Distribution of treatment\u0026#34;\u003c/span\u003e,\n       x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Treatment\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Count\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_cartesian\u003c/span\u003e(ylim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e80\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_clean\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(panel.grid.major.x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e())\n\nplot_trt_out \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(fake_data, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e treatment, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e outcome)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_point\u003c/span\u003e(size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.75\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_smooth\u003c/span\u003e(method \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;lm\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#0599B0\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_y_continuous\u003c/span\u003e(labels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edollar_format\u003c/span\u003e()) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Effect of treatment on outcome\u0026#34;\u003c/span\u003e,\n       x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Treatment\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Outcome\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_clean\u003c/span\u003e()\n\n(hist_out \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e hist_trt) \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eplot_spacer\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e plot_trt_out \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eplot_layout\u003c/span\u003e(heights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.28\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.02\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.7\u003c/span\u003e))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/08/25/twfe-diagnostics/index_files/figure-html/show-fake-data-1.png\" width=\"75%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eWe can find the average treatment effect (ATE) of this imaginary program on the outcome using a simple univariate regression model:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$\\color{gray}{\\overbrace{\\color{#FFA615}{Y}}^{\\text{Outcome}}_{\\underbrace{\\color{#FFA615}{i}}_{\\text{An individual}}}} \\color{black}{=} \\color{gray}{\\overbrace{\\color{black}{\\alpha}}^{\\text{Intercept}}} \\color{black}{+} \\color{gray}{\\underbrace{\\color{#0599B0}{\\beta}}_{\\text{ATE}}} \\color{gray}{\\overbrace{\\color{#A4BD0A}{D_i}}^{\\text{Treatment}}} \\color{black}{+} \\color{gray}{\\overbrace{\\color{black}{\\epsilon_i}}^{\\text{Error}}}$$\u003c/code\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emodel_effect \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(outcome \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e treatment, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e fake_data)\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_effect)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 2 × 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term        estimate std.error statistic   p.value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;          \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 (Intercept)  1001.      22.5        44.6 5.70e-176\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 treatment       9.69     0.672      14.4 1.26e- 39\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThis is just regular old OLS regression. Based on this model, a 1-unit increase in treatment causes a $9.69 increase in the outcome. Lovely.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"#ref-Jakiela:2021\"\u003eJakiela\u003c/a\u003e (\u003ca href=\"#ref-Jakiela:2021\"\u003e2021, 4\u003c/a\u003e) shows an alternate way of calculating \u003ccode\u003e\\(\\beta\\)\u003c/code\u003e, though, based on the \u003ca href=\"https://en.wikipedia.org/wiki/Frisch%E2%80%93Waugh%E2%80%93Lovell_theorem\"\u003eFrisch-Waugh-Lovell theorem\u003c/a\u003e, which is an econometrics idea that I’ve never heard of (since I’m defs not an economist). According to this theorem, we can rewrite the OLS estimate of \u003ccode\u003e\\(\\beta\\)\u003c/code\u003e based on the residuals ($\\tilde{D}_i$) of a model that predicts treatment:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$\\color{#0599B0}{\\beta}\\ \\color{black}{=}\\ \\sum_i \\color{#FFA615}{Y_i} \\color{black}\\left( \\frac{\\color{#353D03}{\\tilde{D}_i}}{\\sum_i \\color{#353D03}{\\tilde{D}_i}^2} \\right)$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eSince this is a univariate model, the residuals here are really just the deviations from the average value of the treatment, or \u003ccode\u003e\\(D_i - \\bar{D}\\)\u003c/code\u003e. We can confirm this by running an intercept-only model and comparing it to \u003ccode\u003e\\(D_i - \\bar{D}\\)\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003etrt_resid \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(treatment \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e fake_data)\n\nfake_data_resid \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fake_data \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(treatment_resid \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eresiduals\u003c/span\u003e(trt_resid)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(mean_treat \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emean\u003c/span\u003e(treatment),\n         diff \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e treatment \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e mean_treat)\n\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(fake_data_resid)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 × 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   outcome treatment treatment_resid mean_treat   diff\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;           \u0026lt;dbl\u0026gt;      \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1    514.        13          -17.2        30.2 -17.2 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2   1550.        35            4.82       30.2   4.82\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3   1562.        52           21.8        30.2  21.8 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4   1037.         4          -26.2        30.2 -26.2 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5   1137.        38            7.82       30.2   7.82\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6   1277.        39            8.82       30.2   8.82\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe \u003ccode\u003etreatment_resid\u003c/code\u003e and \u003ccode\u003ediff\u003c/code\u003e columns here are identical. Now that we have \u003ccode\u003e\\(\\tilde{D}_i\\)\u003c/code\u003e, we can use that fancy rewritten formula and calculate \u003ccode\u003e\\(\\beta\\)\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003efake_data_resid \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003esummarize\u003c/span\u003e(beta \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(outcome \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e (treatment_resid \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(treatment_resid^2))))\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 1 × 1\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##    beta\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1  9.69\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWHAAAAAT it’s the same ATE that we get from running a regular OLS model! That’s magical!\u003c/p\u003e\n\u003cp\u003eThe reason Jakiela reparameterizes \u003ccode\u003e\\(\\beta\\)\u003c/code\u003e this way is because looking at residuals like this creates inherent weights for each observation. Essentially, \u003ccode\u003e\\(\\beta\\)\u003c/code\u003e is a \u003cstrong\u003eweighted sum of the outcome variable\u003c/strong\u003e, with the weights calculated with \u003ccode\u003e\\(\\frac{\\tilde{D}_{it}}{\\sum_{it} \\tilde{D}_{it}^2}\\)\u003c/code\u003e, or \u003ccode\u003e(treatment_resid / sum(treatment_resid^2))\u003c/code\u003e. We can calculate the weights for each observation:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003efake_data_with_weights \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fake_data_resid \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(treatment_weight \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e treatment_resid \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(treatment_resid^2))\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(fake_data_with_weights)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 × 6\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   outcome treatment treatment_resid mean_treat   diff treatment_weight\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;           \u0026lt;dbl\u0026gt;      \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;            \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1    514.        13          -17.2        30.2 -17.2        -0.000168 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2   1550.        35            4.82       30.2   4.82        0.0000471\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3   1562.        52           21.8        30.2  21.8         0.000213 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4   1037.         4          -26.2        30.2 -26.2        -0.000255 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5   1137.        38            7.82       30.2   7.82        0.0000764\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6   1277.        39            8.82       30.2   8.82        0.0000861\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIn this case, given that this is overly perfect simulated data, the weights are really small. In theory, the weights should sum up to 0. Let’s check that really quick:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003efake_data_with_weights \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003esummarize\u003c/span\u003e(total_weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(treatment_weight))\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 1 × 1\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   total_weights\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##           \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1     -1.28e-18\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe can visualize the distribution of weights too:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(fake_data_with_weights, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e treatment_weight)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_histogram\u003c/span\u003e(binwidth \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.00005\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;white\u0026#34;\u003c/span\u003e,\n                 boundary \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#F6C848\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_vline\u003c/span\u003e(xintercept \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF2E00\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Residualized treatment weight\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Count\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_x_continuous\u003c/span\u003e(labels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecomma_format\u003c/span\u003e()) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_clean\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(panel.grid.major.x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e())\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/08/25/twfe-diagnostics/index_files/figure-html/show-weights-fake-data-1.png\" width=\"75%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eThere’s a pattern to which observations get positive or negative weights. According to \u003ca href=\"#ref-Jakiela:2021\"\u003eJakiela\u003c/a\u003e (\u003ca href=\"#ref-Jakiela:2021\"\u003e2021, 4\u003c/a\u003e),\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eAs in any univariate OLS regression of an outcome on a continuous measure of treatment intensity, observations with below mean treatment intensity receive negative weight, and may be thought of as part of the comparison group.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eSince treatment here is continuous, there’s no clear division between treatment and control groups, so mathematically, that threshold becomes the average value of treatment: observations where the treatment value is less than the average (or \u003ccode\u003e\\(D_i \u0026lt; \\bar{D}\\)\u003c/code\u003e) receive negative weight and can conceptually be considered part of the control/comparison group, while observations where \u003ccode\u003e\\(D_i \u0026gt; \\bar{D}\\)\u003c/code\u003e are in the treatment group. That’s apparent in the data too. Look at the first few rows of \u003ccode\u003efake_data_with_weights\u003c/code\u003e above—observations where \u003ccode\u003etreatment_resid\u003c/code\u003e is negative have negative weights.\u003c/p\u003e\n\u003ch2 id=\"residualized-weights-with-twfe-models\"\u003eResidualized weights with TWFE models\u003c/h2\u003e\n\u003cp\u003eThis idea of weighting the outcome variable by treatment status (with treated units getting positive weight and untreated units getting negative weight) is central to the rest of Jakiela’s argument and diagnostics (as well as all the other neat new diff-in-diff papers). Fundamentally, the main reason TWFE estimates get weird and biased with differently-timed treatments is because of issues with weights—in TWFE settings, treated observations often get negative weights and vice versa. This isn’t always bad, and Jakiela explains why and when it’s okay. That’s essentially the whole point of her paper—she provides diagnostics to help determine if there are serious issues with these residualized treatment weights.\u003c/p\u003e\n\u003ch3 id=\"load-and-clean-data\"\u003eLoad and clean data\u003c/h3\u003e\n\u003cp\u003eTo demonstrate issues with TWFE models, weights, and differential timing, Jakiela looks at the effect of eliminating primary school fees on school enrollment in 15 African countries, based on data from the World Bank. You can get \u003ca href=\"https://pjakiela.github.io/TWFE/\"\u003eher data and Stata code at GitHub\u003c/a\u003e. First let’s load the data and clean it up a little.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003efpe_raw \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eread_dta\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;WDI-FPE-data.dta\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Remove rows where primary school enrollment is missing\u003c/span\u003e\nfpe_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fpe_raw \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e!\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eis.na\u003c/span\u003e(primary))\n\n\u003cspan style=\"color:#75715e\"\u003e# Remove rows where secondary school enrollment is missing\u003c/span\u003e\nfpe_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fpe_raw \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e!\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eis.na\u003c/span\u003e(secondary))\n\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(fpe_primary)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 × 8\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##    year country ccode primary    id secondary fpe_year treatment\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;dbl\u0026gt; \u0026lt;chr\u0026gt;   \u0026lt;chr\u0026gt;   \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1  1981 Benin   BEN      60.3     2      15.5     2006         0\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2  1982 Benin   BEN      64.7     2      18.5     2006         0\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3  1983 Benin   BEN      66.2     2      21.2     2006         0\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4  1984 Benin   BEN      64.2     2      20.1     2006         0\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5  1985 Benin   BEN      64.3     2      19.0     2006         0\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6  1986 Benin   BEN      62.4     2      16.3     2006         0\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe have 8 columns to work with:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eyear\u003c/code\u003e: The year of the observation\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ecountry\u003c/code\u003e \u0026amp; \u003ccode\u003eccode\u003c/code\u003e \u0026amp; \u003ccode\u003eid\u003c/code\u003e: The country name, ISO3 country code, and id number for each country (Stata apparently struggles with string-based variables, so \u003ccode\u003eid\u003c/code\u003e works better as a country identifier there)\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eprimary\u003c/code\u003e: Gross enrollment in primary schools\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003esecondary\u003c/code\u003e: Gross enrollment in secondary schools\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003efpe_year\u003c/code\u003e: Year the country eliminated fees for primary schools\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003etreatment\u003c/code\u003e: Indicator variable that is \u003ccode\u003e1\u003c/code\u003e when \u003ccode\u003eyear \u0026gt; fpe_year\u003c/code\u003e and \u003ccode\u003e0\u003c/code\u003e otherwise\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"model-specification\"\u003eModel specification\u003c/h3\u003e\n\u003cp\u003eWe can estimate the causal effect of eliminating primary school fees (\u003ccode\u003etreatment\u003c/code\u003e) on primary and secondary school enrollment (\u003ccode\u003eprimary\u003c/code\u003e and \u003ccode\u003esecondary\u003c/code\u003e) treatment with a TWFE diff-in-diff model:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$\\color{gray}{\\overbrace{\\color{#FFA615}{Y}}^{\\text{Outcome}}_{\\underbrace{\\color{#FFA615}{it}}_{\\substack{i: \\text{ country} \\\\ t: \\text{ year}}}}} \\color{black} = \\color{gray}{\\overbrace{\\color{black}{\\alpha}}^{\\text{Intercept}}} + \\color{gray}{\\overbrace{\\color{black}{\\lambda_i}}^{\\substack{\\text{Country} \\\\ \\text{fixed} \\\\ \\text{effects}}}} + \\color{gray}{\\overbrace{\\color{black}{\\gamma_t}}^{\\substack{\\text{Year} \\\\ \\text{fixed} \\\\ \\text{effects}}}} + \\color{gray}{\\underbrace{\\color{#0599B0}{\\beta}}_{\\text{ATE}}} \\color{gray}{\\overbrace{\\color{#A4BD0A}{D_{it}}}^{\\text{Treatment}}} + \\color{gray}{\\overbrace{\\color{black}{\\epsilon_{it}}}^{\\text{Error}}}$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eOr without all the annotations:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$\\color{#FFA615}{Y_{it}} \\color{black}{\\ = \\alpha + \\lambda_i + \\gamma_t +} \\color{#0599B0}{\\beta} \\color{#A4BD0A}{D_{it}} \\color{black}{\\ + \\epsilon_{it}}$$\u003c/code\u003e\u003c/p\u003e\n\u003ch3 id=\"twfe-models-with-r\"\u003eTWFE models with R\u003c/h3\u003e\n\u003cp\u003eThere are a few different ways to do fixed effects regression with clustered robust standard errors in R. In Stata you do this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003ereg primary treatment i.year i.id, cluster(id)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIn R, you can use the standard \u003ccode\u003elm()\u003c/code\u003e function, but it treats country and year as regular explanatory variables, so it includes them in the results from \u003ccode\u003esummary()\u003c/code\u003e or \u003ccode\u003etidy()\u003c/code\u003e. If you don’t want overly long and detailed results tables, you have to filter those results out.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emodel_lm \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(primary \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e treatment \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e country \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efactor\u003c/span\u003e(year),\n               data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e fpe_primary)\n\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_lm) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e!\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003estr_detect\u003c/span\u003e(term, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;country\u0026#34;\u003c/span\u003e), \u003cspan style=\"color:#f92672\"\u003e!\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003estr_detect\u003c/span\u003e(term, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;year\u0026#34;\u003c/span\u003e))\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 2 × 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term        estimate std.error statistic  p.value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;          \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 (Intercept)     72.4      4.63     15.6  4.23e-44\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 treatment       20.4      2.75      7.43 5.82e-13\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eglance\u003c/span\u003e(model_lm)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 1 × 12\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   r.squared adj.r.squared sigma statistic   p.value    df logLik   AIC   BIC deviance\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##       \u0026lt;dbl\u0026gt;         \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1     0.768         0.742  14.7      29.8 1.30e-110    49 -1985. 4073. 4287.   94828.\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## # … with 2 more variables: df.residual \u0026lt;int\u0026gt;, nobs \u0026lt;int\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThese observations are clustered by country, so we should probably \u003ca href=\"https://theeffectbook.net/ch-StatisticalAdjustment.html#your-standard-errors-are-probably-wrong\"\u003ecluster our standard errors to capture within-country errors\u003c/a\u003e. Using \u003ccode\u003elm()\u003c/code\u003e doesn’t let you automatically create robust or clustered standard errors. You can use \u003ccode\u003elmtest::coeftest()\u003c/code\u003e to do that after the fact, though. We can copy Stata’s standard errors precisely if we (1) specify the variance-covariance matrix using the \u003ccode\u003evcovCl()\u003c/code\u003e function from the \u003cstrong\u003esandwich\u003c/strong\u003e library, and (2) specify the degrees of freedom to use, based on the number of countries in the data, minus 1.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003edf_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fpe_primary \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edistinct\u003c/span\u003e(country) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003enrow\u003c/span\u003e()\n\nmodel_lm_clustered \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e lmtest\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ecoeftest\u003c/span\u003e(model_lm,\n                                       vcov \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e sandwich\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003evcovCL,\n                                       cluster \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003ecountry,\n                                       df \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_primary \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e,\n                                       \u003cspan style=\"color:#75715e\"\u003e# Keep original model so modelsummary shows R2\u003c/span\u003e\n                                       save \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e)\n\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_lm_clustered) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e!\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003estr_detect\u003c/span\u003e(term, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;country\u0026#34;\u003c/span\u003e), \u003cspan style=\"color:#f92672\"\u003e!\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003estr_detect\u003c/span\u003e(term, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;year\u0026#34;\u003c/span\u003e))\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 2 × 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term        estimate std.error statistic       p.value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;          \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;         \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 (Intercept)     72.4      5.83     12.4  0.00000000601\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 treatment       20.4      9.12      2.24 0.0418\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eYou can also use fancier regression functions that can handle fixed effects more systematically. The \u003ccode\u003elm_robust()\u003c/code\u003e function from \u003ca href=\"https://declaredesign.org/r/estimatr/\"\u003ethe \u003cstrong\u003eestimatr\u003c/strong\u003e package\u003c/a\u003e works really well for defining special fixed effects that are automatically omitted from results tables \u003cem\u003eand\u003c/em\u003e returning robust and optionally clustered standard errors:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emodel_lm_robust \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm_robust\u003c/span\u003e(primary \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e treatment,\n                             fixed_effects \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e country \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e year,\n                             data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e fpe_primary,\n                             clusters \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e country, se_type \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;stata\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_lm_robust)\n\u003cspan style=\"color:#75715e\"\u003e##        term estimate std.error statistic p.value conf.low conf.high df outcome\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 treatment     20.4      9.12      2.24  0.0418    0.867        40 14 primary\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eglance\u003c/span\u003e(model_lm_robust)\n\u003cspan style=\"color:#75715e\"\u003e##   r.squared adj.r.squared statistic p.value df.residual nobs se_type\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1     0.768         0.742        NA      NA          14  490   stata\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe \u003ccode\u003efeols()\u003c/code\u003e function from \u003ca href=\"https://lrberge.github.io/fixest/\"\u003ethe \u003cstrong\u003efixest\u003c/strong\u003e package\u003c/a\u003e also works well, though you need to change one of the default settings to get the same SEs as Stata when you have a small sample with nested fixed effects like we have here. By default, \u003ccode\u003efeols()\u003c/code\u003e will nest the fixed effect errors (which is also what \u003ca href=\"http://scorreia.com/software/reghdfe/\"\u003eStata’s \u003ccode\u003ereghdfe\u003c/code\u003e package\u003c/a\u003e does), but you can tell it to use the full set of country and year fixed effect errors with the \u003ccode\u003edof\u003c/code\u003e argument (thanks to \u003ca href=\"https://grantmcdermott.com/\"\u003eGrant McDermott\u003c/a\u003e for pointing this out!):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emodel_feols \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efeols\u003c/span\u003e(primary \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e treatment \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e country \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e year,\n                     data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e fpe_primary,\n                     cluster \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e country,\n                     dof \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edof\u003c/span\u003e(fixef.K \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;full\u0026#34;\u003c/span\u003e))\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_feols)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 1 × 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term      estimate std.error statistic p.value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;        \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;   \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 treatment     20.4      9.12      2.24  0.0418\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eglance\u003c/span\u003e(model_feols)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 1 × 9\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   r.squared adj.r.squared within.r.squared pseudo.r.squared sigma  nobs   AIC   BIC logLik\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##       \u0026lt;dbl\u0026gt;         \u0026lt;dbl\u0026gt;            \u0026lt;dbl\u0026gt;            \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;int\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1     0.768         0.742            0.111               NA  14.7   490 4071. 4280. -1985.\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe can show these all in a side-by-side table using \u003ca href=\"https://vincentarelbundock.github.io/modelsummary/\"\u003ethe \u003cstrong\u003emodelsummary\u003c/strong\u003e package\u003c/a\u003e. Conveniently, \u003ccode\u003emodelsummary()\u003c/code\u003e also lets you \u003ca href=\"https://grantmcdermott.com/better-way-adjust-SEs/\"\u003eadjust standard errors on the fly\u003c/a\u003e with the \u003ccode\u003evcov\u003c/code\u003e argument, so we could theoretically handle all the clustering here instead of inside \u003ccode\u003elmtest::coeftest()\u003c/code\u003e, \u003ccode\u003elm_robust()\u003c/code\u003e, or \u003ccode\u003efeols()\u003c/code\u003e. But since we already specified the clusters above, we’ll just use those.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Look at secondary schools too\u003c/span\u003e\nmodel_lm_sec \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(secondary \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e treatment \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e country \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efactor\u003c/span\u003e(year),\n                   data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e fpe_secondary)\n\ndf_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fpe_secondary \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edistinct\u003c/span\u003e(country) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003enrow\u003c/span\u003e()\n\nmodel_lm_clustered_sec \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e lmtest\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ecoeftest\u003c/span\u003e(model_lm_sec,\n                                           vcov \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e sandwich\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003evcovCL,\n                                           cluster \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003ecountry,\n                                           df \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_secondary \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e,\n                                           save \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e)\n\nmodel_lm_robust_sec \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm_robust\u003c/span\u003e(secondary \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e treatment,\n                                 fixed_effects \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e country \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e year,\n                                 data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e fpe_secondary,\n                                 clusters \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e country, se_type \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;stata\u0026#34;\u003c/span\u003e)\n\nmodel_feols_sec \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efeols\u003c/span\u003e(secondary \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e treatment \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e country \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e year,\n                         data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e fpe_secondary,\n                         cluster \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e country,\n                         dof \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edof\u003c/span\u003e(fixef.K \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;full\u0026#34;\u003c/span\u003e))\n\n\u003cspan style=\"color:#75715e\"\u003e# Define the goodness-of-fit stats to include\u003c/span\u003e\ngof_stuff \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etribble\u003c/span\u003e(\n  \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003eraw, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003eclean, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003efmt,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;nobs\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;N\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;r.squared\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;R²\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e\n)\n\n\u003cspan style=\"color:#75715e\"\u003e# Define extra rows at the end of the table\u003c/span\u003e\nextra_rows \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etribble\u003c/span\u003e(\n  \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003eterm, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003ea, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003eb, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003ec, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003ed, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003ee, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003ef,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Country fixed effects\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;•\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;•\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;•\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;•\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;•\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;•\u0026#34;\u003c/span\u003e,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Year fixed effects\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;•\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;•\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;•\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;•\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;•\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;•\u0026#34;\u003c/span\u003e\n)\n\n\u003cspan style=\"color:#a6e22e\"\u003emodelsummary\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u0026lt;code\u0026gt;lm()\u0026lt;/code\u0026gt;\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e model_lm_clustered,\n                  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u0026lt;code\u0026gt;lm_robust()\u0026lt;/code\u0026gt;\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e model_lm_robust,\n                  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u0026lt;code\u0026gt;feols()\u0026lt;/code\u0026gt;\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e model_feols,\n                  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u0026lt;code\u0026gt;lm()\u0026lt;/code\u0026gt;\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e model_lm_clustered_sec,\n                  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u0026lt;code\u0026gt;lm_robust()\u0026lt;/code\u0026gt;\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e model_lm_robust_sec,\n                  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u0026lt;code\u0026gt;feols()\u0026lt;/code\u0026gt;\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e model_feols_sec),\n             coef_rename \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;treatment\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Treatment\u0026#34;\u003c/span\u003e),\n             estimate \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;{estimate}\u0026#34;\u003c/span\u003e,\n             statistic \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;s.e. = {std.error}\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;p = {p.value}\u0026#34;\u003c/span\u003e),\n             coef_omit \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;^country|^factor|Intercept\u0026#34;\u003c/span\u003e,\n             gof_map \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e gof_stuff,\n             add_rows \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e extra_rows,\n             table.attr \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;style=\u0026#39;font-size:80%;\u0026#39;\u0026#34;\u003c/span\u003e, escape \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e, output \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;kableExtra\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eadd_header_above\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34; \u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Primary enrollment\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Secondary enrollment\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ekable_styling\u003c/span\u003e(htmltable_class \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;pure-table\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ctable style=\"font-size:80%; width: auto !important; margin-left: auto; margin-right: auto; margin-left: auto; margin-right: auto;\" class=\"table pure-table\"\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"empty-cells: hide;border-bottom:hidden;\" colspan=\"1\"\u003e\n\u003c/th\u003e\n\u003cth style=\"border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; \" colspan=\"3\"\u003e\n\u003cdiv style=\"border-bottom: 1px solid #ddd; padding-bottom: 5px; \"\u003e\n\u003cp\u003ePrimary enrollment\u003c/p\u003e\n\u003c/div\u003e\n\u003c/th\u003e\n\u003cth style=\"border-bottom:hidden;padding-bottom:0; padding-left:3px;padding-right:3px;text-align: center; \" colspan=\"3\"\u003e\n\u003cdiv style=\"border-bottom: 1px solid #ddd; padding-bottom: 5px; \"\u003e\n\u003cp\u003eSecondary enrollment\u003c/p\u003e\n\u003c/div\u003e\n\u003c/th\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align:left;\"\u003e\n\u003c/th\u003e\n\u003cth style=\"text-align:center;\"\u003e\n\u003ccode\u003elm()\u003c/code\u003e\n\u003c/th\u003e\n\u003cth style=\"text-align:center;\"\u003e\n\u003ccode\u003elm\\_robust()\u003c/code\u003e\n\u003c/th\u003e\n\u003cth style=\"text-align:center;\"\u003e\n\u003ccode\u003efeols()\u003c/code\u003e\n\u003c/th\u003e\n\u003cth style=\"text-align:center;\"\u003e\n\u003ccode\u003elm()\u003c/code\u003e\n\u003c/th\u003e\n\u003cth style=\"text-align:center;\"\u003e\n\u003ccode\u003elm\\_robust()\u003c/code\u003e\n\u003c/th\u003e\n\u003cth style=\"text-align:center;\"\u003e\n\u003ccode\u003efeols()\u003c/code\u003e\n\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nTreatment\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n20.428\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n20.428\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n20.428\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n−0.468\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n−0.468\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n−0.468\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\ns.e. = 9.120\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\ns.e. = 9.120\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\ns.e. = 9.120\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\ns.e. = 3.081\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\ns.e. = 3.081\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\ns.e. = 3.081\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;box-shadow: 0px 1px\"\u003e\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;box-shadow: 0px 1px\"\u003e\np = 0.042\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;box-shadow: 0px 1px\"\u003e\np = 0.042\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;box-shadow: 0px 1px\"\u003e\np = 0.042\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;box-shadow: 0px 1px\"\u003e\np = 0.881\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;box-shadow: 0px 1px\"\u003e\np = 0.881\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;box-shadow: 0px 1px\"\u003e\np = 0.881\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nN\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n490\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n490\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n490\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n369\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n369\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n369\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nR²\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n0.768\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n0.768\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n0.768\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n0.942\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n0.942\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n0.942\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nCountry fixed effects\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n•\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n•\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n•\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n•\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n•\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n•\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nYear fixed effects\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n•\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n•\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n•\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n•\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n•\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n•\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003eAll these models show the same result: \u003cstrong\u003eeliminating primary school fees caused primary school enrollment to increase by 20.4 percentage points.\u003c/strong\u003e That’s astounding! Removing these fees doesn’t have any effect on secondary enrollment though.\u003c/p\u003e\n\u003ch3 id=\"twfe-estimate-with-residualized-treatment-weights\"\u003eTWFE estimate with residualized treatment weights\u003c/h3\u003e\n\u003cp\u003eThese regressions are simple enough to run with \u003ccode\u003elm()\u003c/code\u003e or \u003ccode\u003elm_robust()\u003c/code\u003e, but there’s an issue with differential timing here. These 15 countries each passed laws eliminating fees in different years:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eplot_fpe_start \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fpe_raw \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(year \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e fpe_year) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003earrange\u003c/span\u003e(fpe_year, country) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(country \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_inorder\u003c/span\u003e(country))\n\n\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(plot_fpe_start, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_rev\u003c/span\u003e(country))) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_segment\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e fpe_year, xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2015\u003c/span\u003e, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e country),\n               size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#D6EB52\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_text\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e fpe_year \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.2\u003c/span\u003e), label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;▶\u0026#34;\u003c/span\u003e, family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Arial Unicode MS\u0026#34;\u003c/span\u003e,\n            size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e8\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#A4BD0A\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Year free primary education implemented\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_clean\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/08/25/twfe-diagnostics/index_files/figure-html/show-fpe-start-1.png\" width=\"75%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eThis timing could cause problems. To see these issues, let’s calculate the ATE ($\\beta$) with that fancy schmancy Frisch-Waugh-Lovell theorem with residualized treatment weights. There’s one key difference here when calculating the residuals though. With the simple model earlier, the treatment residuals were just \u003ccode\u003e\\(D_i - \\bar{D}\\)\u003c/code\u003e, or the residuals from \u003ccode\u003elm(treatment ~ 1)\u003c/code\u003e. In TWFE situations, though, treatment residuals need to account for both country and year fixed effects, or \u003ccode\u003elm(treatment ~ country + year)\u003c/code\u003e:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$\\color{#0599B0}{\\beta^{\\text{TWFE}}} \\color{black}{= \\sum_{it}} \\color{#FFA615}{Y_{it}} \\color{black} \\left( \\frac{\\color{#353D03}{\\tilde{D}_{it}}}{\\sum_{it} \\color{#353D03}{\\tilde{D}_{it}}^2} \\right)$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eOr, with code:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003etrt_resid_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(treatment \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e country \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efactor\u003c/span\u003e(year), data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e fpe_primary)\ntrt_resid_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(treatment \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e country \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efactor\u003c/span\u003e(year), data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e fpe_secondary)\n\nfpe_primary_weights \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fpe_primary \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(treatment_resid \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eresiduals\u003c/span\u003e(trt_resid_primary)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(treatment_weight \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e treatment_resid \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(treatment_resid^2))\n\nfpe_secondary_weights \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fpe_secondary \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(treatment_resid \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eresiduals\u003c/span\u003e(trt_resid_secondary)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(treatment_weight \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e treatment_resid \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(treatment_resid^2))\n\nfpe_primary_weights \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003esummarize\u003c/span\u003e(twfe_beta_primary \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(primary \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e treatment_weight))\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 1 × 1\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   twfe_beta_primary\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##               \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1              20.4\u003c/span\u003e\n\nfpe_secondary_weights \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003esummarize\u003c/span\u003e(twfe_beta_secondary \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(secondary \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e treatment_weight))\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 1 × 1\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   twfe_beta_secondary\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                 \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1              -0.468\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWhoa! It still works this way. This still blows my mind every time.\u003c/p\u003e\n\u003ch2 id=\"jakielas-diagnostics\"\u003eJakiela’s diagnostics\u003c/h2\u003e\n\u003cp\u003eHowever, because of the differential treatment timing, there are some issues with weighting. Remember from the simple example with fake data that observations in the treatment group typically have positive treatment weights, while those in the comparison/control group have negative weights. With TWFE, some observations’ weights switch directions. There are systematic reasons for this. According to \u003ca href=\"#ref-Jakiela:2021\"\u003eJakiela\u003c/a\u003e (\u003ca href=\"#ref-Jakiela:2021\"\u003e2021, 5\u003c/a\u003e), negative weights in treated observations are more likely in (1) early adopter countries, since the country-level treatment mean is high, and (2) later years, since the year-level treatment mean is higher.\u003c/p\u003e\n\u003cp\u003eHaving negative weights on treated observations isn’t necessarily bad! It’s often just a mathematical artefact, and if you have (1) enough never-treated observations and (2) enough pre-treatment data, and if (3) the treatment effects are homogenous across all countries, it won’t be a problem. But if you don’t have enough data, your results will be biased and distorted for later years and for early adopters.\u003c/p\u003e\n\u003cp\u003eStarting in section 3 of her paper, Jakiela presents a set of diagnostics to see how bad these distortions might be. We need to answer two questions:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eDo any treated units get negative weight when calculating \u003ccode\u003e\\(\\beta^{\\text{TWFE}}\\)\u003c/code\u003e? Check this by looking at the weights\u003c/li\u003e\n\u003cli\u003eCan we reject the hypothesis that the treatment effects are homogenous? Check this by looking at the relationship between \u003ccode\u003e\\(\\tilde{Y}_{it}\\)\u003c/code\u003e and \u003ccode\u003e\\(\\tilde{D}_{it}\\)\u003c/code\u003e. The slope shouldn’t be different.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"31-do-treated-observations-receive-negative-weights\"\u003e3.1: Do treated observations receive negative weights?\u003c/h3\u003e\n\u003cp\u003eFor this first diagnostic, we need to investigate patterns in the residualized weights. Some of the treated country-year observations have negative weight:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Total treated in primary data\u003c/span\u003e\nn_treated_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fpe_primary_weights \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(treatment \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003enrow\u003c/span\u003e()\n\n\u003cspan style=\"color:#75715e\"\u003e# Total treated in secondary data\u003c/span\u003e\nn_treated_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fpe_secondary_weights \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(treatment \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003enrow\u003c/span\u003e()\n\n\u003cspan style=\"color:#75715e\"\u003e# Negatively weighted treated observations in the primary data\u003c/span\u003e\nn_treated_negative_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fpe_primary_weights \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(treatment_weight \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e treatment \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003enrow\u003c/span\u003e()\n\nn_treated_negative_primary\n\u003cspan style=\"color:#75715e\"\u003e## [1] 50\u003c/span\u003e\nn_treated_negative_primary \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e n_treated_primary\n\u003cspan style=\"color:#75715e\"\u003e## [1] 0.259\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Negatively weighted treated observations in the secondary data\u003c/span\u003e\nn_treated_negative_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fpe_secondary_weights \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(treatment_weight \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e treatment \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003enrow\u003c/span\u003e()\n\nn_treated_negative_secondary\n\u003cspan style=\"color:#75715e\"\u003e## [1] 36\u003c/span\u003e\nn_treated_negative_secondary \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e n_treated_secondary\n\u003cspan style=\"color:#75715e\"\u003e## [1] 0.261\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eRoughly a quarter of the treated observations in both the primary and secondary enrollment data are negatively weighted. That might be bad.\u003c/p\u003e\n\u003cp\u003eWe can look at the distribution of these weights too:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eplot_weights_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fpe_primary_weights \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(treatment_fct \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efactor\u003c/span\u003e(treatment, labels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Untreated\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Treated\u0026#34;\u003c/span\u003e), ordered \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(oh_no \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (treatment \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e treatment_weight \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e (treatment \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e treatment_weight \u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e))\n\nplot_weights_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fpe_secondary_weights \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(treatment_fct \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efactor\u003c/span\u003e(treatment, labels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Untreated\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Treated\u0026#34;\u003c/span\u003e), ordered \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(oh_no \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (treatment \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e treatment_weight \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e (treatment \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e treatment_weight \u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e))\n\nhist_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(plot_weights_primary,\n                       \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e treatment_weight, fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e treatment_fct, alpha \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e oh_no)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_histogram\u003c/span\u003e(binwidth \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.002\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;white\u0026#34;\u003c/span\u003e, boundary \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e,\n                 position \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eposition_identity\u003c/span\u003e()) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_vline\u003c/span\u003e(xintercept \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4136\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_alpha_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.6\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_fill_viridis_d\u003c/span\u003e(option \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;rocket\u0026#34;\u003c/span\u003e, begin \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.2\u003c/span\u003e, end \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.8\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Residualized treatment\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Count\u0026#34;\u003c/span\u003e,\n       title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Primary school enrollment\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eguides\u003c/span\u003e(fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;none\u0026#34;\u003c/span\u003e, alpha \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;none\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efacet_wrap\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003evars\u003c/span\u003e(treatment_fct), ncol \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_clean\u003c/span\u003e()\n\nhist_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(plot_weights_secondary,\n                         \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e treatment_weight, fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e treatment_fct, alpha \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e oh_no)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_histogram\u003c/span\u003e(binwidth \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.002\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;white\u0026#34;\u003c/span\u003e, boundary \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e,\n                 position \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eposition_identity\u003c/span\u003e()) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_vline\u003c/span\u003e(xintercept \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4136\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_alpha_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.6\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_fill_viridis_d\u003c/span\u003e(option \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;rocket\u0026#34;\u003c/span\u003e, begin \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.2\u003c/span\u003e, end \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.8\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Residualized treatment\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Count\u0026#34;\u003c/span\u003e,\n       title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Secondary school enrollment\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eguides\u003c/span\u003e(fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;none\u0026#34;\u003c/span\u003e, alpha \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;none\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efacet_wrap\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003evars\u003c/span\u003e(treatment_fct), ncol \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_clean\u003c/span\u003e()\n\nhist_primary \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e hist_secondary\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/08/25/twfe-diagnostics/index_files/figure-html/show-weights-hist-1.png\" width=\"100%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eThese histograms confirm the proportions we found earlier—about 25% of the treated observations have negative weights.\u003c/p\u003e\n\u003cp\u003eWhich treated country-years are getting these negative weights, though? According to Jakiela, early adopters and later years are more likely to have this switch happen. Let’s make another plot:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eplot_waffle_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fpe_primary_weights \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(weight_fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecase_when\u003c/span\u003e(\n    treatment_resid \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e treatment \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Treatment observations, negative weight\u0026#34;\u003c/span\u003e,\n    treatment_resid \u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e treatment \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Treatment observations, positive weight\u0026#34;\u003c/span\u003e,\n    \u003cspan style=\"color:#f92672\"\u003e!\u003c/span\u003etreatment \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Comparison observations\u0026#34;\u003c/span\u003e\n  )) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003earrange\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003edesc\u003c/span\u003e(fpe_year), \u003cspan style=\"color:#a6e22e\"\u003edesc\u003c/span\u003e(country)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(country \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_inorder\u003c/span\u003e(country)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(weight_fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_inorder\u003c/span\u003e(weight_fill))\n\nplot_waffle_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fpe_secondary_weights \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(weight_fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecase_when\u003c/span\u003e(\n    treatment_resid \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e treatment \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Treatment observations, negative weight\u0026#34;\u003c/span\u003e,\n    treatment_resid \u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e treatment \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Treatment observations, positive weight\u0026#34;\u003c/span\u003e,\n    \u003cspan style=\"color:#f92672\"\u003e!\u003c/span\u003etreatment \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Comparison observations\u0026#34;\u003c/span\u003e\n  )) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003earrange\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003edesc\u003c/span\u003e(fpe_year), \u003cspan style=\"color:#a6e22e\"\u003edesc\u003c/span\u003e(country)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(country \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_inorder\u003c/span\u003e(country)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(weight_fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_inorder\u003c/span\u003e(weight_fill))\n\nwaffle_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(plot_waffle_primary,\n                         \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e year, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e country, fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e weight_fill)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_tile\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;white\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_fill_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey50\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#0074D9\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4136\u0026#34;\u003c/span\u003e),\n                    guide \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eguide_legend\u003c/span\u003e(reverse \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e),\n                    name \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_x_continuous\u003c/span\u003e(expand \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eexpansion\u003c/span\u003e(add \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e),\n                     breaks \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eseq\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1980\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2015\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Primary school enrollment\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_equal\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_clean\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(legend.position \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bottom\u0026#34;\u003c/span\u003e,\n        panel.grid \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e(),\n        legend.key.size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eunit\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.8\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;lines\u0026#34;\u003c/span\u003e))\n\nwaffle_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(plot_waffle_secondary,\n                         \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e year, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e country, fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e weight_fill)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_tile\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;white\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_fill_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey50\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#0074D9\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4136\u0026#34;\u003c/span\u003e),\n                    guide \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eguide_legend\u003c/span\u003e(reverse \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e),\n                    name \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_x_continuous\u003c/span\u003e(expand \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eexpansion\u003c/span\u003e(add \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e),\n                     breaks \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eseq\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1980\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2015\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Secondary school enrollment\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_equal\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_clean\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(legend.position \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bottom\u0026#34;\u003c/span\u003e,\n        panel.grid \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e(),\n        legend.key.size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eunit\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.8\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;lines\u0026#34;\u003c/span\u003e))\n\nwaffle_primary \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e waffle_secondary\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/08/25/twfe-diagnostics/index_files/figure-html/show-weight-waffle-1.png\" width=\"100%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eAnd that is indeed the case! Malawi, Ethiopia, Ghana, Uganda, and Cameroon all eliminated fees before 2000, and they start getting negative weights after 2005.\u003c/p\u003e\n\u003ch3 id=\"32-testing-the-homogeneity-assumption-directly\"\u003e3.2: Testing the homogeneity assumption directly\u003c/h3\u003e\n\u003cp\u003eWe thus have issues with negative weighting here for early adopting countries and later country-years. However, as long as the treatment effects are homogenous—or that the elimination of school fees has the same effect across time and country—this negative weighting isn’t an issue. If treatment effects are heterogenous—especially if the effects change over time within treated countries—the TWFE estimate will be severely biased.\u003c/p\u003e\n\u003cp\u003eJakiela’s second diagnostic tests this assumption of homogeneity based on the mathematical relationship between the residuals of the outcome variable (\u003ccode\u003e$\\tilde{Y}_{it}$\u003c/code\u003e) and the residuals of the treatment variable (\u003ccode\u003e$\\tilde{D}_{it}$\u003c/code\u003e). Essentially, if there’s no difference in slopes across treated and untreated observations in a regression of \u003ccode\u003e$\\tilde{Y}_{it} = \\tilde{D}_{it}$\u003c/code\u003e, there’s no evidence for heterogeneity and all is well.\u003c/p\u003e\n\u003cp\u003eThis wasn’t intuitive for me since I’m not a real econometrician, so I had to dig into the math to try to wrap my head around it, and I’m still only like 80% sure I’ve got it :)\u003c/p\u003e\n\u003cp\u003eWe can think of the outcome \u003ccode\u003e\\(Y_{it}\\)\u003c/code\u003e as a combination of three different moving parts: (1) an initial baseline value for each country, or \u003ccode\u003e\\(\\mu_{i}\\)\u003c/code\u003e, (2) a constant change in each additional year in the absence of treatment (i.e. what would naturally happen over time regardless of an intervention), or \u003ccode\u003e\\(\\eta_t\\)\u003c/code\u003e, and (3) a homogenous treatment effect, or \u003ccode\u003e\\(\\delta\\)\u003c/code\u003e (doesn’t have subscripts for \u003ccode\u003e\\(i\\)\u003c/code\u003e or \u003ccode\u003e\\(t\\)\u003c/code\u003e—it’s the same across year and country):\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$\\color{gray}{\\overbrace{\\color{#FFA615}{Y_{it}}}^{\\text{Outcome}}} = \\color{gray}{\\overbrace{\\color{black}{\\mu_i}}^{\\substack{\\text{Baseline} \\\\ \\text{outcome} \\\\ \\text{at } t = 1}}} + \\color{black} \\sum_{\\tau = 1}^t  \\color{gray}{\\overbrace{\\color{black}{\\eta_t}}^{\\substack{\\text{Global} \\\\ \\text{time} \\\\ \\text{trend}}}} + \\color{gray}{\\overbrace{\\color{black}{\\delta}}^{\\substack{\\text{Homogenous} \\\\ \\text{treatment} \\\\ \\text{effect}}}} \\color{#A4BD0A}{D_{it}}$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eThis all makes perfect sense is is nice and intuitive. It’s how I typically generate fake data too (see the \u003ccode\u003eoutcome_baseline\u003c/code\u003e up at the beginning of this post, for instance) and it’s a neat way of thinking about the separate components of a data generating process.\u003c/p\u003e\n\u003cp\u003eAccording to Jakiela, if the treatment effect \u003ccode\u003e\\(\\delta\\)\u003c/code\u003e is truly homogenous over time and country, the residuals of the outcome (i.e. the residuals from a model like \u003ccode\u003elm(outcome ~ country + year)\u003c/code\u003e, or \u003ccode\u003e\\(\\tilde{Y}_{it}\\)\u003c/code\u003e) should have a linear relationship to the residualized treatment (i.e. the residuals from a model like \u003ccode\u003elm(treatment ~ country + year)\u003c/code\u003e, or \u003ccode\u003e\\(\\delta\\tilde{D}_{it}\\)\u003c/code\u003e).\u003c/p\u003e\n\u003cp\u003eAgain, due to my non-econometricianness, this idea that \u003ccode\u003e\\(\\tilde{Y}_{it}\\)\u003c/code\u003e should be related to \u003ccode\u003e\\(\\delta\\tilde{D}_{it}\\)\u003c/code\u003e didn’t click for me until I thought about this formula in more regression-y terms. Consider this pseudo-regression equation:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$\\overbrace{Y_{it}}^{\\text{Outcome}} = \\overbrace{\\alpha_i}^{\\text{Intercept}} + \\overbrace{\\beta_t}^{\\text{Slope / trend}} + \\overbrace{\\epsilon_{it}}^{\\text{Residuals}}$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eHere, if we run a regression like \u003ccode\u003elm(outcome ~ country + year)\u003c/code\u003e, the intercept \u003ccode\u003e\\(\\alpha_i\\)\u003c/code\u003e is analogous to \u003ccode\u003e\\(\\mu_i\\)\u003c/code\u003e, the slope \u003ccode\u003e\\(\\beta_t\\)\u003c/code\u003e is like \u003ccode\u003e\\(\\eta_t\\)\u003c/code\u003e, and whatever’s leftover (i.e. \u003ccode\u003e\\(\\epsilon_{it}\\)\u003c/code\u003e, or the residualized outcome \u003ccode\u003e\\(\\tilde{Y}_{it}\\)\u003c/code\u003e) is similar to \u003ccode\u003e\\(\\delta D_{it}\\)\u003c/code\u003e. \u003ccode\u003e\\(\\delta D_{it}\\)\u003c/code\u003e isn’t the same as \u003ccode\u003e\\(\\delta \\tilde{D}_{it}\\)\u003c/code\u003e, but we can calculate the residualized treatment the same way by removing country and year effects (like \u003ccode\u003elm(treatment ~ country + year)\u003c/code\u003e). Basically, by residualizing both the treatment and outcome, and thus removing country and time effects (or the baseline country effect \u003ccode\u003e\\(\\mu_i\\)\u003c/code\u003e and the time trend \u003ccode\u003e\\(\\eta_t\\)\u003c/code\u003e) from each, the residuals that remain are related to \u003ccode\u003e\\(\\delta\\)\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eAs long as \u003ccode\u003e\\(\\delta\\)\u003c/code\u003e is constant across time and country—or as long as the effect is homogenous—it should show up equally in the residuals for both the outcome and treatment for both treated and untreated observations. (I THINK! I’M NOT SURE ABOUT THIS)\u003c/p\u003e\n\u003cp\u003eWe already calculated the treatment residuals (or \u003ccode\u003e\\(\\tilde{D}_{it}\\)\u003c/code\u003e) when we looked at treatment weights earlier, so now we just need to calculate the outcome residuals ($\\tilde{Y}_{it}$). We can then see if the relationship between \u003ccode\u003e\\(\\tilde{D}_{it}\\)\u003c/code\u003e and \u003ccode\u003e\\(\\tilde{D}_{it}\\)\u003c/code\u003e looks the same for treated and untreated observations—the slopes in the two groups should be statistically indistinguishable from each other.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Build models for the residualized outcomes\u003c/span\u003e\nout_resid_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(primary \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e country \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efactor\u003c/span\u003e(year), data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e fpe_primary)\nout_resid_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(secondary \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e country \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efactor\u003c/span\u003e(year), data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e fpe_secondary)\n\n\u003cspan style=\"color:#75715e\"\u003e# Add residuals to data with weights\u003c/span\u003e\nfpe_primary_weights \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fpe_primary_weights \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(out_resid \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eresiduals\u003c/span\u003e(out_resid_primary))\n\nfpe_secondary_weights \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fpe_secondary_weights \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(out_resid \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eresiduals\u003c/span\u003e(out_resid_secondary))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe can check the similarity of these slopes a couple different ways. First, let’s plot the residuals:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eplot_out_trt_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(fpe_primary_weights,\n                               \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e treatment_resid, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e out_resid, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efactor\u003c/span\u003e(treatment))) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_point\u003c/span\u003e(size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.75\u003c/span\u003e, alpha \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_smooth\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(linetype \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Loess\u0026#34;\u003c/span\u003e), method \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;loess\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, se \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e, alpha \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_smooth\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(linetype \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;OLS\u0026#34;\u003c/span\u003e), method \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;lm\u0026#34;\u003c/span\u003e, se \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_color_viridis_d\u003c/span\u003e(option \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;rocket\u0026#34;\u003c/span\u003e, begin \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.2\u003c/span\u003e, end \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.8\u003c/span\u003e,\n                        labels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Untreated\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Treated\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_linetype_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;OLS\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;solid\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Loess\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;21\u0026#34;\u003c/span\u003e),\n                        guide \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eguide_legend\u003c/span\u003e(override.aes \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey30\u0026#34;\u003c/span\u003e))) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Residualized treatment\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Residualized outcome\u0026#34;\u003c/span\u003e,\n       title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Primary school enrollment\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, linetype \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_clean\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(legend.position \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bottom\u0026#34;\u003c/span\u003e)\n\nplot_out_trt_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(fpe_secondary_weights,\n                                 \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e treatment_resid, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e out_resid, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efactor\u003c/span\u003e(treatment))) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_point\u003c/span\u003e(size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.75\u003c/span\u003e, alpha \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_smooth\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(linetype \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Loess\u0026#34;\u003c/span\u003e), method \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;loess\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, se \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e, alpha \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_smooth\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(linetype \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;OLS\u0026#34;\u003c/span\u003e), method \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;lm\u0026#34;\u003c/span\u003e, se \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_color_viridis_d\u003c/span\u003e(option \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;rocket\u0026#34;\u003c/span\u003e, begin \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.2\u003c/span\u003e, end \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.8\u003c/span\u003e,\n                        labels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Untreated\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Treated\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_linetype_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;OLS\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;solid\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Loess\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;21\u0026#34;\u003c/span\u003e),\n                        guide \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eguide_legend\u003c/span\u003e(override.aes \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey30\u0026#34;\u003c/span\u003e))) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Residualized treatment\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Residualized outcome\u0026#34;\u003c/span\u003e,\n       title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Secondary school enrollment\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, linetype \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_clean\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(legend.position \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bottom\u0026#34;\u003c/span\u003e)\n\nplot_out_trt_primary \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e plot_out_trt_secondary\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/08/25/twfe-diagnostics/index_files/figure-html/show-outcome-trt-resid-1.png\" width=\"100%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eFor primary enrollment, the lines for treated and untreated observations look like they have similar slopes. When using Loess lines, the two groups don’t align perfectly, and the relationship between residualized treatment and residualized outcome doesn’t look perfectly linear. When secondary enrollment is the outcome, the lines for the treated and untreated groups seem to switch directions—the slope is negative for untreated observations but positive for treated. This is a bad sign for the homogeneity assumption.\u003c/p\u003e\n\u003cp\u003eWe can statistically test if the slopes in two groups are the same or not by using an interaction term in a regression model:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003echeck_slopes_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(out_resid \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e treatment_resid \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efactor\u003c/span\u003e(treatment),\n                           data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e fpe_primary_weights)\n\ncheck_slopes_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(out_resid \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e treatment_resid \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efactor\u003c/span\u003e(treatment),\n                           data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e fpe_secondary_weights)\n\n\u003cspan style=\"color:#a6e22e\"\u003emodelsummary\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Primary enrollment\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e check_slopes_primary,\n                  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Secondary enrollment\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e check_slopes_secondary),\n             coef_rename \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;treatment_resid\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Residualized treatment\u0026#34;\u003c/span\u003e,\n                             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;factor(treatment)1\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Treatment group\u0026#34;\u003c/span\u003e,\n                             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;treatment_resid:factor(treatment)1\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Treatment group × residualized treatment\u0026#34;\u003c/span\u003e,\n                             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;(Intercept)\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Intercept\u0026#34;\u003c/span\u003e),\n             estimate \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;{estimate}\u0026#34;\u003c/span\u003e,\n             statistic \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;s.e. = {std.error}\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;p = {p.value}\u0026#34;\u003c/span\u003e),\n             gof_map \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etribble\u003c/span\u003e(\n               \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003eraw, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003eclean, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003efmt,\n               \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;nobs\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;N\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e,\n               \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;r.squared\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;R²\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e\n             ),\n             table.attr \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;style=\u0026#39;font-size:80%;\u0026#39;\u0026#34;\u003c/span\u003e, escape \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e, output \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;kableExtra\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ekable_styling\u003c/span\u003e(htmltable_class \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;pure-table\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ctable style=\"font-size:80%; width: auto !important; margin-left: auto; margin-right: auto; margin-left: auto; margin-right: auto;\" class=\"table pure-table\"\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align:left;\"\u003e\n\u003c/th\u003e\n\u003cth style=\"text-align:center;\"\u003e\nPrimary enrollment\n\u003c/th\u003e\n\u003cth style=\"text-align:center;\"\u003e\nSecondary enrollment\n\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nIntercept\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n0.320\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n−0.202\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\ns.e. = 0.894\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\ns.e. = 0.276\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\np = 0.721\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\np = 0.466\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nResidualized treatment\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n23.761\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n−2.902\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\ns.e. = 3.968\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\ns.e. = 1.357\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\np = 0.000\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\np = 0.033\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nTreatment group\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n0.341\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n−0.189\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\ns.e. = 1.506\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\ns.e. = 0.473\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\np = 0.821\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\np = 0.690\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nTreatment group × residualized treatment\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n−7.806\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n5.248\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\ns.e. = 6.073\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\ns.e. = 1.993\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;box-shadow: 0px 1px\"\u003e\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;box-shadow: 0px 1px\"\u003e\np = 0.199\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;box-shadow: 0px 1px\"\u003e\np = 0.009\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nN\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n490\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n369\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nR²\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n0.114\n\u003c/td\u003e\n\u003ctd style=\"text-align:center;\"\u003e\n0.019\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003eThe coefficient for “Treatment group × residualized treatment” shows the change in slope between the two groups. For primary enrollment, being in the treatment group reduces the slope by 7.8 (so from 23.761 to 15.961), but the standard errors around that change are huge and the p-value is not significant (p = 0.199). For secondary enrollment, though, being in the treatment group increases the slope by 5.3 (from -2.9 to positive 2.4), and that change is statistically significant (p = 0.009).\u003c/p\u003e\n\u003cp\u003eSo for primary enrollment, there’s not enough evidence to reject the hypothesis that the slopes are the same (or the hypothesis that the effect is homogenous), so we’ll treat the effect as homogenous. Yay! That means we don’t need to worry so much about the negatively-weighted treated country-years. For secondary enrollment, though, there’s pretty strong evidence that the slopes aren’t the same, which means the treatment effect is likely heterogenous, which also means that the treated country-years with negative weights are biasing the results substantially and we should thus be worried.\u003c/p\u003e\n\u003cp\u003eWhen there are heterogenous treatment effects, we don’t need to give up! This is what \u003ca href=\"#ref-CallawaySantAnna:2020\"\u003eCallaway and Sant’Anna\u003c/a\u003e (\u003ca href=\"#ref-CallawaySantAnna:2020\"\u003e2020\u003c/a\u003e) and \u003ca href=\"#ref-SunAbraham:2020\"\u003eSun and Abraham\u003c/a\u003e (\u003ca href=\"#ref-SunAbraham:2020\"\u003e2020\u003c/a\u003e) show how to do in their papers (and see \u003ca href=\"#ref-BakerLarckerWang:2021\"\u003eBaker, Larcker, and Wang\u003c/a\u003e (\u003ca href=\"#ref-BakerLarckerWang:2021\"\u003e2021\u003c/a\u003e) for a general overview of those approaches). If treatment effects are indeed homogenous, there’s no need to turn to these fancier TWFE estimators—but if they are heterogenous, there are new tools that help.\u003c/p\u003e\n\u003ch2 id=\"jakielas-robustness-checks\"\u003eJakiela’s robustness checks\u003c/h2\u003e\n\u003cp\u003eNow that we’ve run those two diagnostics (checked for negative weights in treated units and checked for treatment effect homogeneity), we can do some neat robustness checks to see how badly these negative weight issues bias the TWFE estimate.\u003c/p\u003e\n\u003cp\u003eAs long as we assume that treatment effects are homogenous (remember that \u003ccode\u003e\\(\\delta\\)\u003c/code\u003e in the equation above doesn’t have subscripts for country or year), we can safely drop some observations from the data and still find the same result. We can also strategically drop observations to check if negative treatment weights influence the results. Jakiela presents three different robustness checks that all involve dropping different categories of observations:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eExclude later years\u003c/li\u003e\n\u003cli\u003eLimit how many post-treatment years are kept\u003c/li\u003e\n\u003cli\u003eExclude individual countries\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch3 id=\"exclude-later-years\"\u003eExclude later years\u003c/h3\u003e\n\u003cp\u003eSince negative treatment weights for treated country-years are more likely to appear in later years in the data, we can drop those later years and see how the treatment effect changes.\u003c/p\u003e\n\u003cp\u003eFor primary schools, if we cut the data off at 2000, the treatment effect is 31.8 instead of the 20.4 we’ve been seeing with the full data. That estimate is higher, but it also has wider errors. Both the coefficient and the errors shrink as we add more years to the data, and the estimate eventually settles on ≈20 by 2005, which is also when negatively weighted treated rows start appearing.\u003c/p\u003e\n\u003cp\u003eFor secondary schools, the treatment effect hovers around 0 is never statistically significant regardless of the cutoff year.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003edifferent_max_years_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(end_year \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2000\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e2015\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Nest a filtered dataset in a cell for each year\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(end_year, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(fpe_primary, year \u003cspan style=\"color:#f92672\"\u003e\u0026lt;=\u003c/span\u003e .))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Calculate the TWFE estimate for each dataset\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(model \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(data, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003elm_robust\u003c/span\u003e(primary \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e treatment,\n                                      fixed_effects \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e country \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e year,\n                                      data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e .,\n                                      clusters \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e country, se_type \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;stata\u0026#34;\u003c/span\u003e))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Extract a data frame of the results\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(tidied \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(model, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(., conf.int \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Calculate residuals and treatment weights\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(model_resid \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(data, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(treatment \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e country \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efactor\u003c/span\u003e(year), data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e .)),\n         treatment_resid \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(model_resid, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eresiduals\u003c/span\u003e(.)),\n         treatment_weight \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(treatment_resid, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e . \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(.^2)))\n\n\u003cspan style=\"color:#75715e\"\u003e# Calculate how many treated observations have negative weights\u003c/span\u003e\nprop_negative_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e different_max_years_primary \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eunnest\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(data, treatment_resid, treatment_weight)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(end_year) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003esummarize\u003c/span\u003e(n_treated_negative_weight \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(treatment_weight \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e treatment \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e),\n            n_treated \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(treatment \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e),\n            prop_treated_negative_weight \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e n_treated_negative_weight \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e n_treated) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(prop_nice \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epercent\u003c/span\u003e(prop_treated_negative_weight, accuracy \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e))\n\n\u003cspan style=\"color:#75715e\"\u003e# Extract tidied results for plotting\u003c/span\u003e\ncoefs_to_plot_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e different_max_years_primary \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eunnest\u003c/span\u003e(tidied)\n\ndifferent_max_years_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(end_year \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2000\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e2015\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(end_year, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(fpe_secondary, year \u003cspan style=\"color:#f92672\"\u003e\u0026lt;=\u003c/span\u003e .))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(model \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(data, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003elm_robust\u003c/span\u003e(secondary \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e treatment,\n                                      fixed_effects \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e country \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e year,\n                                      data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e .,\n                                      clusters \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e country, se_type \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;stata\u0026#34;\u003c/span\u003e))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(tidied \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(model, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(., conf.int \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(model_resid \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(data, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(treatment \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e country \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efactor\u003c/span\u003e(year), data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e .)),\n         treatment_resid \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(model_resid, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eresiduals\u003c/span\u003e(.)),\n         treatment_weight \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(treatment_resid, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e . \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(.^2)))\n\nprop_negative_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e different_max_years_secondary \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eunnest\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(data, treatment_resid, treatment_weight)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(end_year) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003esummarize\u003c/span\u003e(n_treated_negative_weight \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(treatment_weight \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e treatment \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e),\n            n_treated \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(treatment \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e),\n            prop_treated_negative_weight \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e n_treated_negative_weight \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e n_treated) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(prop_nice \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epercent\u003c/span\u003e(prop_treated_negative_weight, accuracy \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e))\n\ncoefs_to_plot_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e different_max_years_secondary \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eunnest\u003c/span\u003e(tidied)\n\n\u003cspan style=\"color:#75715e\"\u003e# Coefficient plot\u003c/span\u003e\nate_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(coefs_to_plot_primary, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e end_year, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e estimate)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_hline\u003c/span\u003e(yintercept \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF2E00\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_pointrange\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(ymin \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e conf.low, ymax \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e conf.high),\n                  color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#0599B0\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, fatten \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;TWFE-based treatment effect\u0026#34;\u003c/span\u003e,\n       title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Primary school enrollment\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_clean\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(axis.title.x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e(),\n        axis.text.x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e())\n\nate_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(coefs_to_plot_secondary, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e end_year, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e estimate)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_hline\u003c/span\u003e(yintercept \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF2E00\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_pointrange\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(ymin \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e conf.low, ymax \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e conf.high),\n                  color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#0599B0\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, fatten \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;TWFE-based treatment effect\u0026#34;\u003c/span\u003e,\n       title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Secondary school enrollment\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_clean\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(axis.title.x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e(),\n        axis.text.x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e())\n\n\u003cspan style=\"color:#75715e\"\u003e# Bar plot\u003c/span\u003e\nprop_neg_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(prop_negative_primary,\n                                  prop_treated_negative_weight \u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e),\n                           \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e end_year, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e prop_treated_negative_weight)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_col\u003c/span\u003e(fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4136\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_text\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e prop_nice),\n            nudge_y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.02\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2.5\u003c/span\u003e,\n            family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Barlow Semi Condensed Bold\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4136\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_cartesian\u003c/span\u003e(xlim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e2000\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2015\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Last year included in data\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e,\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;% of treated observations with negative weight\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_clean\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(panel.grid.major.y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e(),\n        axis.text.y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e())\n\nprop_neg_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(prop_negative_secondary,\n                                    prop_treated_negative_weight \u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e),\n                             \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e end_year, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e prop_treated_negative_weight)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_col\u003c/span\u003e(fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4136\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_text\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e prop_nice),\n            nudge_y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.02\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2.5\u003c/span\u003e,\n            family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Barlow Semi Condensed Bold\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4136\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_cartesian\u003c/span\u003e(xlim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e2000\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2015\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Last year included in data\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e,\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;% of treated observations with negative weight\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_clean\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(panel.grid.major.y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e(),\n        axis.text.y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e())\n\n((ate_primary \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e prop_neg_primary) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eplot_layout\u003c/span\u003e(heights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.8\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.2\u003c/span\u003e))) \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e\n  ((ate_secondary \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e prop_neg_secondary) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eplot_layout\u003c/span\u003e(heights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.8\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.2\u003c/span\u003e)))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/08/25/twfe-diagnostics/index_files/figure-html/robust-exclude-later-years-1.png\" width=\"100%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003ch3 id=\"change-how-many-post-treatment-years-are-kept\"\u003eChange how many post-treatment years are kept\u003c/h3\u003e\n\u003cp\u003eDropping rows based on end years like this is neat, but it doesn’t take into account the differential treatment timing. Countries like Mozambique, which eliminated its fees in 2005, don’t even show up in the first few models of exclude-later-years robustness check, since those models end in 2000–2004. As an alternative, we can keep specific numbers of years post-treatment for each country. For instance, we can look at Mozambique 2, 3, 4, or 5 (and so on) years after treatment. Doing this centers all countries at \u003ccode\u003e\\(t = 0\\)\u003c/code\u003e, rather than \u003ccode\u003e\\(t = \\text{start year}\\)\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eFor primary schools in this situation, the effect is smaller and not significant when only a few post-treatment years are kept, but it stabilizes at around 20 after only 5 post-treatment years, which suggests that \u003ccode\u003e\\(\\delta\\)\u003c/code\u003e is indeed homogenous—we don’t need a ton of post-treatment data to find it. For secondary schools, though, the effect remains negative and insigificant throughout every specification.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003efpe_primary_years_since \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fpe_primary \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(years_after \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e year \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e fpe_year)\n\nfpe_secondary_years_since \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fpe_secondary \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(years_after \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e year \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e fpe_year)\n\ndifferent_years_after_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(post_trt_years \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e22\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Nest a filtered dataset in a cell for each year\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(post_trt_years, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(fpe_primary_years_since, years_after \u003cspan style=\"color:#f92672\"\u003e\u0026lt;=\u003c/span\u003e .))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Calculate the TWFE estimate for each dataset\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(model \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(data, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003elm_robust\u003c/span\u003e(primary \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e treatment,\n                                      fixed_effects \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e country \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e year,\n                                      data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e .,\n                                      clusters \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e country, se_type \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;stata\u0026#34;\u003c/span\u003e))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Extract a data frame of the results\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(tidied \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(model, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(., conf.int \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Calculate residuals and treatment weights\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(model_resid \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(data, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(treatment \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e country \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efactor\u003c/span\u003e(year), data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e .)),\n         treatment_resid \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(model_resid, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eresiduals\u003c/span\u003e(.)),\n         treatment_weight \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(treatment_resid, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e . \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(.^2)))\n\n\u003cspan style=\"color:#75715e\"\u003e# Calculate how many treated observations have negative weights\u003c/span\u003e\nprop_negative_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e different_years_after_primary \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eunnest\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(data, treatment_resid, treatment_weight)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(post_trt_years) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003esummarize\u003c/span\u003e(n_treated_negative_weight \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(treatment_weight \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e treatment \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e),\n            n_treated \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(treatment \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e),\n            prop_treated_negative_weight \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e n_treated_negative_weight \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e n_treated) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(prop_nice \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epercent\u003c/span\u003e(prop_treated_negative_weight, accuracy \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e))\n\n\u003cspan style=\"color:#75715e\"\u003e# Extract tidied results for plotting\u003c/span\u003e\ncoefs_to_plot_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e different_years_after_primary \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eunnest\u003c/span\u003e(tidied)\n\ndifferent_years_after_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(post_trt_years \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e22\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(post_trt_years, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(fpe_secondary_years_since, years_after \u003cspan style=\"color:#f92672\"\u003e\u0026lt;=\u003c/span\u003e .))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(model \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(data, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003elm_robust\u003c/span\u003e(secondary \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e treatment,\n                                      fixed_effects \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e country \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e year,\n                                      data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e .,\n                                      clusters \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e country, se_type \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;stata\u0026#34;\u003c/span\u003e))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(tidied \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(model, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(., conf.int \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(model_resid \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(data, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(treatment \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e country \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efactor\u003c/span\u003e(year), data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e .)),\n         treatment_resid \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(model_resid, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eresiduals\u003c/span\u003e(.)),\n         treatment_weight \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(treatment_resid, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e . \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(.^2)))\n\nprop_negative_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e different_years_after_secondary \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eunnest\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(data, treatment_resid, treatment_weight)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(post_trt_years) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003esummarize\u003c/span\u003e(n_treated_negative_weight \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(treatment_weight \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e treatment \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e),\n            n_treated \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(treatment \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e),\n            prop_treated_negative_weight \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e n_treated_negative_weight \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e n_treated) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(prop_nice \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epercent\u003c/span\u003e(prop_treated_negative_weight, accuracy \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e))\n\ncoefs_to_plot_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e different_years_after_secondary \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eunnest\u003c/span\u003e(tidied)\n\n\u003cspan style=\"color:#75715e\"\u003e# Coefficient plot\u003c/span\u003e\nate_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(coefs_to_plot_primary, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e post_trt_years, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e estimate)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_hline\u003c/span\u003e(yintercept \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF2E00\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_pointrange\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(ymin \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e conf.low, ymax \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e conf.high),\n                  color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#0599B0\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, fatten \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;TWFE-based treatment effect\u0026#34;\u003c/span\u003e,\n       title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Primary school enrollment\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_clean\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(axis.title.x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e(),\n        axis.text.x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e())\n\nate_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(coefs_to_plot_secondary, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e post_trt_years, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e estimate)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_hline\u003c/span\u003e(yintercept \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF2E00\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_pointrange\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(ymin \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e conf.low, ymax \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e conf.high),\n                  color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#0599B0\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, fatten \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;TWFE-based treatment effect\u0026#34;\u003c/span\u003e,\n       title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Secondary school enrollment\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_clean\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(axis.title.x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e(),\n        axis.text.x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e())\n\n\u003cspan style=\"color:#75715e\"\u003e# Bar plot\u003c/span\u003e\nprop_neg_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(prop_negative_primary,\n                                  prop_treated_negative_weight \u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e),\n                           \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e post_trt_years, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e prop_treated_negative_weight)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_col\u003c/span\u003e(fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4136\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_text\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e prop_nice),\n            nudge_y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.02\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2.5\u003c/span\u003e,\n            family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Barlow Semi Condensed Bold\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4136\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_cartesian\u003c/span\u003e(xlim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e22\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Post-treatment years included\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e,\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;% of treated observations with negative weight\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_clean\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(panel.grid.major.y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e(),\n        axis.text.y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e())\n\nprop_neg_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(prop_negative_secondary,\n                                    prop_treated_negative_weight \u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e),\n                             \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e post_trt_years, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e prop_treated_negative_weight)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_col\u003c/span\u003e(fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4136\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_text\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e prop_nice),\n            nudge_y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.02\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2.5\u003c/span\u003e,\n            family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Barlow Semi Condensed Bold\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4136\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_cartesian\u003c/span\u003e(xlim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e22\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Last year included in data\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e,\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;% of treated observations with negative weight\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_clean\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(panel.grid.major.y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e(),\n        axis.text.y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e())\n\n((ate_primary \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e prop_neg_primary) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eplot_layout\u003c/span\u003e(heights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.8\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.2\u003c/span\u003e))) \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e\n  ((ate_secondary \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e prop_neg_secondary) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eplot_layout\u003c/span\u003e(heights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.8\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.2\u003c/span\u003e)))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/08/25/twfe-diagnostics/index_files/figure-html/robust-post-treatment-years-1.png\" width=\"100%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003ch3 id=\"exclude-individual-countries\"\u003eExclude individual countries\u003c/h3\u003e\n\u003cp\u003eFinally, since early adopter countries are more likely to have negative treatment weights, we can remove individual countries from the panel to see what their omission does to the overall TWFE estimate. For primary school enrollment, the ATE remains positive and significant across most specifications, except when Malawi, Uganda, or Namibia are excluded. But Malawi and Uganda were early adopters and thus have negatively weighted treatment observations in later years, as we saw earlier, which give them strange leverage in the the overall TWFE ATE calculation. For secondary schools, the effect remains basically zero and insignificant across all specifications except when Malawi is omitted, but that’s again because Malawi was an early adopter.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003efpe_omit_countries_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fpe_primary \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003earrange\u003c/span\u003e(fpe_year, country) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(country_start \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epaste0\u003c/span\u003e(country, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34; (\u0026#34;\u003c/span\u003e, fpe_year, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;)\u0026#34;\u003c/span\u003e),\n         country_start \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_inorder\u003c/span\u003e(country_start)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003edistinct\u003c/span\u003e(country, country_start) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(country, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(fpe_primary, country \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e .))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(model \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(data, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003elm_robust\u003c/span\u003e(primary \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e treatment,\n                                      fixed_effects \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e country \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e year,\n                                      data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e .,\n                                      clusters \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e country, se_type \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;stata\u0026#34;\u003c/span\u003e))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(tidied \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(model, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(., conf.int \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e)))\n\ncoefs_to_plot_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fpe_omit_countries_primary \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eunnest\u003c/span\u003e(tidied)\n\nfpe_omit_countries_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fpe_secondary \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003earrange\u003c/span\u003e(fpe_year, country) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(country_start \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epaste0\u003c/span\u003e(country, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34; (\u0026#34;\u003c/span\u003e, fpe_year, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;)\u0026#34;\u003c/span\u003e),\n         country_start \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_inorder\u003c/span\u003e(country_start)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003edistinct\u003c/span\u003e(country, country_start)  \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(country, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(fpe_secondary, country \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e .))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(model \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(data, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003elm_robust\u003c/span\u003e(secondary \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e treatment,\n                                      fixed_effects \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e country \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e year,\n                                      data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e .,\n                                      clusters \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e country, se_type \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;stata\u0026#34;\u003c/span\u003e))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(tidied \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(model, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(., conf.int \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e)))\n\ncoefs_to_plot_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fpe_omit_countries_secondary \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eunnest\u003c/span\u003e(tidied)\n\nate_primary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(coefs_to_plot_primary, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e estimate, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_rev\u003c/span\u003e(country_start))) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_vline\u003c/span\u003e(xintercept \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF2E00\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_pointrange\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(xmin \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e conf.low, xmax \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e conf.high),\n                  color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#0599B0\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, fatten \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;TWFE-based treatment effect\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e,\n       title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Primary school enrollment\u0026#34;\u003c/span\u003e,\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Each point represents the ATE when omitting the specified country\u0026#34;\u003c/span\u003e,\n       caption \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Year that fees were eliminated is shown in parentheses\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_cartesian\u003c/span\u003e(xlim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e-10\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e50\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_clean\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(panel.grid.major.y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e())\n\nate_secondary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(coefs_to_plot_secondary, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e estimate, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_rev\u003c/span\u003e(country_start))) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_vline\u003c/span\u003e(xintercept \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF2E00\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_pointrange\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(xmin \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e conf.low, xmax \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e conf.high),\n                  color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#0599B0\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, fatten \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;TWFE-based treatment effect\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e,\n       title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Secondary school enrollment\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_cartesian\u003c/span\u003e(xlim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e-10\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e50\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_clean\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(panel.grid.major.y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e())\n\nate_primary \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e ate_secondary\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/08/25/twfe-diagnostics/index_files/figure-html/robust-drop-countries-1.png\" width=\"100%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003ch2 id=\"tldr-conclusion\"\u003etl;dr: Conclusion\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003e\u003cstrong\u003ePhew.\u003c/strong\u003e\u003c/em\u003e That was a ton of code, but coding my way through this paper and translating Jakiela’s diagnostics and robustness checks from math into R was incredibly helpful for me to start understanding all this new TWFE stuff.\u003c/p\u003e\n\u003cp\u003eHere are the main tl;dr takeaways from her paper:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eWe can think of OLS as a weighted sum of outcome values - these weights are typically negative for untreated observations and positive for treated observations\u003c/li\u003e\n\u003cli\u003eIn TWFE situations, these weights take country and year into account\u003c/li\u003e\n\u003cli\u003eBecause of mathy reasons, treated observations can actually get negative weights—especially countries that are early adopters, and country-year observations in later years\u003c/li\u003e\n\u003cli\u003eWe can see if these negative weights on treated observations are an issue by using a couple simple diagnostics: see how many and which treated observations have negative weights, and see if the treatment effect is homogenous across treated countries\u003c/li\u003e\n\u003cli\u003eWe can look at which treated observations have negative weights by making some plots and exploring the data\u003c/li\u003e\n\u003cli\u003eWe can check for the homogeniety of the treatment effect by running a regression that uses the residualized treatment and treatment status to\nexplain the residualized outcome. If the slopes for treated and comparison observations are indistinguishable, we can safely assume treatment homogeneity.\u003c/li\u003e\n\u003cli\u003eFinally, we can check how robust the TWFE estimate is to negative treatment weights and the assumption of homogeneity by dropping specific types of observations and checking the ATE across these modified datasets\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003cdiv id=\"refs\" class=\"references csl-bib-body hanging-indent\"\u003e\n\u003cdiv id=\"ref-BakerLarckerWang:2021\" class=\"csl-entry\"\u003e\n\u003cp\u003eBaker, Andrew, David F. Larcker, and Charles C. Y. Wang. 2021. “How Much Should We Trust Staggered Difference-in-Differences Estimates?” Working paper 246. Rock Center for Corporate Governance at Stanford University. \u003ca href=\"https://doi.org/10.2139/ssrn.3794018\"\u003ehttps://doi.org/10.2139/ssrn.3794018\u003c/a\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv id=\"ref-CallawaySantAnna:2020\" class=\"csl-entry\"\u003e\n\u003cp\u003eCallaway, Brantly, and Pedro H. C. Sant’Anna. 2020. “Difference-in-Differences with Multiple Time Periods.” \u003cem\u003eJournal of Econometrics\u003c/em\u003e, December. \u003ca href=\"https://doi.org/10.1016/j.jeconom.2020.12.001\"\u003ehttps://doi.org/10.1016/j.jeconom.2020.12.001\u003c/a\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv id=\"ref-de-ChaisemartindHaultfoeuille:2020\" class=\"csl-entry\"\u003e\n\u003cp\u003ede Chaisemartin, Clément, and Xavier d’Haultfoeuille. 2020. “Two-Way Fixed Effects Estimators with Heterogeneous Treatment Effects.” \u003cem\u003eAmerican Economic Review\u003c/em\u003e 110 (9): 2964–96. \u003ca href=\"https://doi.org/10.1257/aer.20181169\"\u003ehttps://doi.org/10.1257/aer.20181169\u003c/a\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv id=\"ref-Goodman-Bacon:2021\" class=\"csl-entry\"\u003e\n\u003cp\u003eGoodman-Bacon, Andrew. 2021. “Difference-in-Differences with Variation in Treatment Timing.” \u003cem\u003eJournal of Econometrics\u003c/em\u003e, June. \u003ca href=\"https://doi.org/10.1016/j.jeconom.2021.03.014\"\u003ehttps://doi.org/10.1016/j.jeconom.2021.03.014\u003c/a\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv id=\"ref-Jakiela:2021\" class=\"csl-entry\"\u003e\n\u003cp\u003eJakiela, Pamela. 2021. “Simple Diagnostics for Two-Way Fixed Effects,” March. \u003ca href=\"https://arxiv.org/abs/2103.13229\"\u003ehttps://arxiv.org/abs/2103.13229\u003c/a\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv id=\"ref-SunAbraham:2020\" class=\"csl-entry\"\u003e\n\u003cp\u003eSun, Liyang, and Sarah Abraham. 2020. “Estimating Dynamic Treatment Effects in Event Studies with Heterogeneous Treatment Effects.” \u003cem\u003eJournal of Econometrics\u003c/em\u003e, December. \u003ca href=\"https://doi.org/10.1016/j.jeconom.2020.09.006\"\u003ehttps://doi.org/10.1016/j.jeconom.2020.09.006\u003c/a\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n",
            "date_published": "2021-08-25T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2021/08/21/r2-euler/",
            "url": "https://www.shagunjhaver.com/blog/2021/08/21/r2-euler/",
            "title": "Exploring R² and regression variance with Euler/Venn diagrams",
            "summary": "Use R to correctly close backdoor confounding in panel data with marginal structural models and inverse probability weights with both GEE and multilevel models",
            "content_html": "\u003ch2 id=\"contents----omit-in-toc---\"\u003eContents \u003c!-- omit in toc --\u003e\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#regression-as-overlapping-circles\"\u003eRegression as overlapping circles\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#relationship-between-two-variables\"\u003eRelationship between two variables\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#relationship-between-three-variables\"\u003eRelationship between three variables\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#nicer-plot\"\u003eNicer plot\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#multicollinearity\"\u003eMulticollinearity\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#why-this-matters\"\u003eWhy this matters\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#caveats\"\u003eCaveats\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#references\"\u003eReferences\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003cp\u003eRegression is the core of my \u003ca href=\"https://statsf18.classes.andrewheiss.com/\"\u003estatistics\u003c/a\u003e and \u003ca href=\"https://evalf21.classes.andrewheiss.com/\"\u003eprogram evaluation/causal inference\u003c/a\u003e courses. As I’ve taught different stats classes, I’ve found that one of the regression diagnostic statistics that students really glom onto is \u003ccode\u003e\\(R^2\\)\u003c/code\u003e. Unlike lots of regression diagnostics like AIC, BIC, and the joint F-statistic, \u003ccode\u003e\\(R^2\\)\u003c/code\u003e has a really intuitive interpretation—it’s the percent of variation in the outcome variable explained by all the explanatory variables. For instance, let’s explain global life expectancy using GDP per capita, based on data from \u003ca href=\"https://www.gapminder.org/\"\u003ethe Gapminder project\u003c/a\u003e. Here’s the basic model:\u003c/p\u003e\n\u003cp\u003e$$\n\\widehat{\\text{Life expectancy}} = \\beta_0 + \\beta_1 \\text{GDP per capita} + \\epsilon\n$$\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)     \u003cspan style=\"color:#75715e\"\u003e# For ggplot, dplyr, and friends\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(broom)         \u003cspan style=\"color:#75715e\"\u003e# For converting models into data frames\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(gapminder)     \u003cspan style=\"color:#75715e\"\u003e# For health and wealth data\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(faux)          \u003cspan style=\"color:#75715e\"\u003e# For generating fake data\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(eulerr)        \u003cspan style=\"color:#75715e\"\u003e# For creating Euler and Venn diagrams\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Just look at 2007\u003c/span\u003e\ngapminder_2007 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e gapminder \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(year \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2007\u003c/span\u003e)\n\nsuper_naive_model \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(lifeExp \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e gdpPercap, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e gapminder_2007)\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(super_naive_model)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 2 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term         estimate std.error statistic   p.value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;           \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 (Intercept) 59.6      1.01           59.0 9.89e-101\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 gdpPercap    0.000637 0.0000583      10.9 1.69e- 20\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eglance\u003c/span\u003e(super_naive_model)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 1 x 12\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   r.squared adj.r.squared sigma statistic  p.value    df logLik   AIC   BIC deviance\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##       \u0026lt;dbl\u0026gt;         \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1     0.461         0.457  8.90      120. 1.69e-20     1  -511. 1028. 1037.   11086.\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## # … with 2 more variables: df.residual \u0026lt;int\u0026gt;, nobs \u0026lt;int\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThis is an awful model on theoretical grounds, but whatever. A $1 increase in GDP per capita is associated with a 0.001 year increase in life expectancy, on average. Look at all those diagnostics though—AIC? BIC? LogLik? Those are important, but definitely not intuitive. The \u003ccode\u003e\\(R^2\\)\u003c/code\u003e value, on the other hand, is nice and interpretable. GDP per capita explains 46.1% of the variation in life expectancy. That’s soundbite-worthy. Students love it.\u003c/p\u003e\n\u003cp\u003ePeople also love to critique models based on it. In my program evaluation class, a model in one of my problem sets has an \u003ccode\u003e\\(R^2\\)\u003c/code\u003e of 0.02, and without fail, a majority of students dismiss it because of its low explanatory power. It only explains 2% of the variation in the outcome! It must be junk!\u003c/p\u003e\n\u003cp\u003eBut low \u003ccode\u003e\\(R^2\\)\u003c/code\u003es aren’t necessarily bad. And while saying that a model explains X% of the variation in an outcome, what does that even mean in practice?\u003c/p\u003e\n\u003cp\u003eSo how the heck does \u003ccode\u003e\\(R^2\\)\u003c/code\u003e work anyway? I’ve struggled teaching this, but recently a friend mentioned that she teaches students to imagine \u003ccode\u003e\\(R^2\\)\u003c/code\u003e as a combination of overlapping circles, or a type of Venn diagram. I’d never heard of this approach before, so I went down a really interesting rabbit hole to discover that this approach has actually been used for decades! Let’s go down that rabbit hole together!\u003c/p\u003e\n\u003ch2 id=\"regression-as-overlapping-circles\"\u003eRegression as overlapping circles\u003c/h2\u003e\n\u003cp\u003eThe earliest example I found is \u003ca href=\"#ref-CohenCohen:1975\"\u003eCohen and Cohen\u003c/a\u003e (\u003ca href=\"#ref-CohenCohen:1975\"\u003e1975\u003c/a\u003e), who proposed visualizing the shared variance between 2–3 variables as a “ballantine” graph (apparently named after \u003ca href=\"https://en.wikipedia.org/wiki/P._Ballantine_and_Sons_Brewing_Company\"\u003ean ale logo\u003c/a\u003e?), or what we call nowadays a Venn or Euler diagram. Others refined their approach, like \u003ca href=\"#ref-Hunt:1986\"\u003eHunt\u003c/a\u003e (\u003ca href=\"#ref-Hunt:1986\"\u003e1986\u003c/a\u003e) who provides all sorts of fancy geometric equations to make them accurate (and provides some neat vintage Pascal code in the appendix!), and \u003ca href=\"#ref-Ip:2001\"\u003eIp\u003c/a\u003e (\u003ca href=\"#ref-Ip:2001\"\u003e2001\u003c/a\u003e), who shows a bunch of different examples and highlights some of the limitations of using this approach.\u003c/p\u003e\n\u003cp\u003eFor this ongoing example, we’ll simulate some correlated data using \u003ca href=\"https://debruine.github.io/faux/\"\u003ethe \u003cstrong\u003efaux\u003c/strong\u003e package\u003c/a\u003e. We could use real data, but as you’ll see, these diagrams are pretty finicky and fragile and generally need very tame data to work. Here we’ll create data with three variables that are normally distributed with these parameters:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003eY\u003c/code\u003e: mean = 10, sd = 2\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eX1\u003c/code\u003e: mean = 9, sd = 1.7\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eX2\u003c/code\u003e: mean = 9, sd = 1.3\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eWe’ll make \u003ccode\u003eY\u003c/code\u003e and \u003ccode\u003eX1\u003c/code\u003e be correlated at r = 0.5, \u003ccode\u003eY\u003c/code\u003e and \u003ccode\u003eX2\u003c/code\u003e correlated at r = 0.3, and \u003ccode\u003eX1\u003c/code\u003e and \u003ccode\u003eX2\u003c/code\u003e correlated at r = 0.4:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eset.seed\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1234\u003c/span\u003e)\ndf \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm_multi\u003c/span\u003e(n \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e,\n                  mu \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e9\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e9\u003c/span\u003e),\n                  sd \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1.7\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1.3\u003c/span\u003e),\n                  r \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.3\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e),\n                  varnames \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Y\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X1\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X2\u0026#34;\u003c/span\u003e),\n                  empirical \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Look at the first few rows\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(df)\n\u003cspan style=\"color:#75715e\"\u003e##       Y    X1    X2\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1  8.22  6.73  8.38\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 10.17  9.36 10.12\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 12.03 10.32  9.86\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4  5.41  5.80  8.38\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5 10.10 10.08 10.09\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6 11.13  9.11  9.94\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Check if the correlations worked\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ecor\u003c/span\u003e(df)\n\u003cspan style=\"color:#75715e\"\u003e##        Y    X1    X2\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Y  1.000 0.453 0.373\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## X1 0.453 1.000 0.468\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## X2 0.373 0.468 1.000\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# Close enough!\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIn these regression diagrams, each variable is shown as a circle sized according to its variance, or:\u003c/p\u003e\n\u003cp\u003e$$\n\\operatorname{var} = \\sigma^2 = \\frac{\\sum (\\color{gray}{\\overbrace{\\color{black}{x_i}}^{\\substack{\\text{Single} \\ \\text{value}}}} - \\color{gray}{\\overbrace{\\color{black}{\\bar{x}}}^{\\substack{\\text{Mean of} \\ \\text{all values}}}\\color{black}{)^2}}}{\\color{gray}{\\underbrace{\\color{black}{n}}_{\\substack{\\text{Sample} \\ \\text{size}}}}-1}\n$$\u003c/p\u003e\n\u003cp\u003eAccording to \u003ca href=\"#ref-Ip:2001\"\u003eIp\u003c/a\u003e (\u003ca href=\"#ref-Ip:2001\"\u003e2001\u003c/a\u003e), you can also size the circles based on just the numerator of that equation, or the sum-of-squares, which is the same value proportionally number (it’s just not divided by \u003ccode\u003e\\(n-1\\)\u003c/code\u003e). It’s also easier to work with when plotting, so that’s what we’ll use throughout this example.\u003c/p\u003e\n\u003cp\u003e$$\n\\color{gray}{\\overbrace{\\color{black}{{\\scriptstyle\\sum} (x_i - \\bar{x})^2}}^{\\text{Sum of squares}}}\n$$\u003c/p\u003e\n\u003cp\u003eWe can even make a little function to calculate the sum of squares for us:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Sum of squares, or the numerator of the variance equation\u003c/span\u003e\nss \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(x) {\n  \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e((x \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emean\u003c/span\u003e(x))^2)\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eEnough math, though—let’s make some plots! We’ll use \u003ca href=\"https://cran.r-project.org/web/packages/eulerr/vignettes/introduction.html\"\u003ethe \u003cstrong\u003eeulerr\u003c/strong\u003e package\u003c/a\u003e for this, since (1) it calculates proportional overlaps between circles (that’s the key technical difference between Venn and Euler diagram—Venn diagrams are supposed to have equally sized overlapping areas), and (2) it uses grid graphics, so it fits nicely in the ggplot ecosystem.\u003c/p\u003e\n\u003ch3 id=\"relationship-between-two-variables\"\u003eRelationship between two variables\u003c/h3\u003e\n\u003cp\u003eFirst let’s just look at the relationship between \u003ccode\u003eY\u003c/code\u003e and \u003ccode\u003eX1\u003c/code\u003e. We’ll use the sum of squares to calculate the size for each circle:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ess_y \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ess\u003c/span\u003e(df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eY)\nss_x1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ess\u003c/span\u003e(df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eX1)\n\n\u003cspan style=\"color:#a6e22e\"\u003eplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eeuler\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Y\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ss_y,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X1\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ss_x1)),\n     quantities \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/08/21/r2-euler/index_files/figure-html/unrelated-vars-1.png\" width=\"75%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eJust looking at this plot, we can see that \u003ccode\u003eY\u003c/code\u003e has more variation than \u003ccode\u003eX1\u003c/code\u003e. Neat.\u003c/p\u003e\n\u003cp\u003eThese two variables are related to each other though and have some covariance. We can calculate the shared covariance using \u003ca href=\"https://en.wikipedia.org/wiki/Analysis_of_variance\"\u003eANOVA\u003c/a\u003e. Ordinarily you need to feed R’s \u003ccode\u003eanova()\u003c/code\u003e function an \u003ccode\u003elm()\u003c/code\u003e object to calculate different variance statistics (e.g. \u003ccode\u003eanova(lm(Y ~ X1, data = df))\u003c/code\u003e), but to save some typing, you can also use the \u003ccode\u003eaov()\u003c/code\u003e function to skip the intermediate \u003ccode\u003elm()\u003c/code\u003e step. The nice thing about using the sum of squares values for these diagrams rather than variance values is that \u003ccode\u003eaov()\u003c/code\u003e reports its results as sums of squares, so we can use those results directly.\u003c/p\u003e\n\u003cp\u003eLet’s see how much of the variation between \u003ccode\u003eY\u003c/code\u003e and \u003ccode\u003eX1\u003c/code\u003e is shared:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eaov\u003c/span\u003e(Y \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e X1, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df)\n\u003cspan style=\"color:#75715e\"\u003e## Call:\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##    aov(formula = Y ~ X1, data = df)\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Terms:\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                  X1 Residuals\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Sum of Squares   82       318\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Deg. of Freedom   1        98\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Residual standard error: 1.8\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Estimated effects may be unbalanced\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIf we look at the sum of squares row, we can see that 81.98 sum-of-squares units (whatever those mean) are shared between the two variables, with 317.87 not shared (or residual). To plot this overlap, we need to do a little bit of set theory math. We can’t just tell \u003ccode\u003eY\u003c/code\u003e to be 399 units big—we need to subtract the shared space from both \u003ccode\u003eY\u003c/code\u003e and \u003ccode\u003eX1\u003c/code\u003e. We’ll extract the sum of squares value from \u003ccode\u003eaov()\u003c/code\u003e (using \u003ccode\u003ebroom::tidy()\u003c/code\u003e to make this easier):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ess_both_y_x1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eaov\u003c/span\u003e(Y \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e X1, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X1\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003epull\u003c/span\u003e(sumsq)\nss_both_y_x1\n\u003cspan style=\"color:#75715e\"\u003e## [1] 82\u003c/span\u003e\n\n\u003cspan style=\"color:#a6e22e\"\u003eplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eeuler\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Y\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ss_y \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e ss_both_y_x1,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X1\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ss_x1 \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e ss_both_y_x1,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Y\u0026amp;X1\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ss_both_y_x1)),\n     quantities \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/08/21/r2-euler/index_files/figure-html/plot-basic-overlap-1.png\" width=\"75%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eNow we can visualize the covariance between these two variables! Let’s get rid of the raw numbers and add some letters for the different segments:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eeuler\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Y\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ss_y \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e ss_both_y_x1,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X1\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ss_x1 \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e ss_both_y_x1,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Y\u0026amp;X1\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ss_both_y_x1)),\n     quantities \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;A\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;B\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;C\u0026#34;\u003c/span\u003e))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/08/21/r2-euler/index_files/figure-html/plot-basic-overlap-labels-1.png\" width=\"75%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eArea C here represents the amount of variation in \u003ccode\u003eY\u003c/code\u003e explained by \u003ccode\u003eX1\u003c/code\u003e, while Area A represents the unexplained portion of \u003ccode\u003eY\u003c/code\u003e. In regression language, A is basically the error term:\u003c/p\u003e\n\u003cp\u003e$$\n\\hat{Y} = \\beta_0 + \\beta_1 X_1 + \\color{gray}{\\overbrace{\\epsilon}^{\\color{black}{\\text{A}}}}\n$$\u003c/p\u003e\n\u003cp\u003eThe great thing about visualizing this is that C also represents the \u003ccode\u003e\\(R^2\\)\u003c/code\u003e! In general, \u003ccode\u003e\\(R^2\\)\u003c/code\u003e is the ratio between explained and total variance:\u003c/p\u003e\n\u003cp\u003e$$\nR^2 = \\frac{\\text{Explained variance in }Y}{\\text{Total variance in }Y}\n$$\u003c/p\u003e\n\u003cp\u003eBased on this diagram, we can write this as:\u003c/p\u003e\n\u003cp\u003e$$\nR^2 = \\frac{C}{A + C}\n$$\u003c/p\u003e\n\u003cp\u003eUsing actual numbers, we get\u003c/p\u003e\n\u003cp\u003e$$\nR^2 = \\frac{81.98}{317.87 + 81.98} = 0.205\n$$\u003c/p\u003e\n\u003cp\u003eWe can do this more precisely with code:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003epart_a \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e ss_y \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e ss_both_y_x1\npart_c \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e ss_both_y_x1\n\npart_c \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e (part_a \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e part_c)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 0.205\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAccording to this, \u003ccode\u003eX1\u003c/code\u003e explains 20.5% of the variation in \u003ccode\u003eY\u003c/code\u003e. That’s apparent visually—the overlapping space covers about 20% of the total \u003ccode\u003eY\u003c/code\u003e circle.\u003c/p\u003e\n\u003cp\u003eLet’s run a regression model and check the \u003ccode\u003e\\(R^2\\)\u003c/code\u003e value to see if it’s the same:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(Y \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e X1, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eglance\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003epull\u003c/span\u003e(r.squared)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 0.205\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIncredible!! It’s the same! That’s so cool.\u003c/p\u003e\n\u003ch3 id=\"relationship-between-three-variables\"\u003eRelationship between three variables\u003c/h3\u003e\n\u003cp\u003eWhere this gets even more useful is when we look at the overlapping space between three different variables. It’s also a little more complicated, since we need to calculate a bunch of different shared variances and do some set theory calculations to find the exact size of these different slivers of the diagram. Here’s a general diagram of what we’ll be calculating (this is unrelated to the data we’ve been working with and doesn’t use any actual numbers—it’s just a reference so we can find which shared variances we need to calculate):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eeuler\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Y\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X1\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X2\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X1\u0026amp;Y\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X2\u0026amp;Y\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X1\u0026amp;X2\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Y\u0026amp;X1\u0026amp;X2\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e)),\n     quantities \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#66d9ef\"\u003eLETTERS\u003c/span\u003e[1\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e7\u003c/span\u003e]))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/08/21/r2-euler/index_files/figure-html/plot-generic-3-rings-1.png\" width=\"75%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eThis looks complicated, but the same principles apply. The entire circles for \u003ccode\u003eY\u003c/code\u003e, \u003ccode\u003eX1\u003c/code\u003e, and \u003ccode\u003eX2\u003c/code\u003e represent each variable’s total variance. Overlapping areas represent shared variance. For instance, the combination of D and G here (or \u003ccode\u003e\\(A \\cap B\\)\u003c/code\u003e) is the covariance that we calculated previously. The \u003ccode\u003e\\(R^2\\)\u003c/code\u003e is still here too—the total explained variance in \u003ccode\u003eY\u003c/code\u003e is the combination of D, E, and G, while A is the residual unexplained variance. That means we can calculate \u003ccode\u003e\\(R^2\\)\u003c/code\u003e like this:\u003c/p\u003e\n\u003cp\u003e$$\n\\frac{D + E + G}{A + D + E + G}\n$$\u003c/p\u003e\n\u003cp\u003eThis visualization also helps with the intuition of \u003ccode\u003e\\(R^2\\)\u003c/code\u003e. Generally when you add additional variables to a regression model, the \u003ccode\u003e\\(R^2\\)\u003c/code\u003e increases. That’s because you’re adding another circle to the diagram and absorbing more of the variation in the outcome. For instance, even though the numbers in this diagram aren’t to scale at all, you can see that (D + G) (the \u003ccode\u003e\\(R^2\\)\u003c/code\u003e that we calculated in the two-variable diagram) is smaller than (D + E + G). There’s more explained variance here.\u003c/p\u003e\n\u003cp\u003eTo calculate the actual values for each of these segments, we’ll use \u003ccode\u003eaov()\u003c/code\u003e again to find the shared variance. This will involve a lot of different calculations and some algebra to isolate each segment. This table will help us keep everything straight:\u003c/p\u003e\n\u003ctable\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align:left\"\u003eSegment\u003c/th\u003e\n\u003cth style=\"text-align:left\"\u003eExplanation\u003c/th\u003e\n\u003cth style=\"text-align:left\"\u003eCode or algebra\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left\"\u003eA + D + E + G\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003eTotal variation in \u003ccode\u003eY\u003c/code\u003e\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003e\u003ccode\u003ess(df$Y)\u003c/code\u003e or \u003ccode\u003eaov(Y ~ 1)\u003c/code\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left\"\u003eB + D + F + G\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003eTotal variation in \u003ccode\u003eX1\u003c/code\u003e\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003e\u003ccode\u003ess(df$X1)\u003c/code\u003e or \u003ccode\u003eaov(X1 ~ 1)\u003c/code\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left\"\u003eC + E + F + G\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003eTotal variation in \u003ccode\u003eX2\u003c/code\u003e\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003e\u003ccode\u003ess(df$X2)\u003c/code\u003e or \u003ccode\u003eaov(X2 ~ 1)\u003c/code\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left\"\u003eA\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003eUnexplained variation in \u003ccode\u003eY\u003c/code\u003e after accounting for \u003ccode\u003eX1\u003c/code\u003e and \u003ccode\u003eX2\u003c/code\u003e\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003eResiduals from \u003ccode\u003eaov(Y ~ X2 + X1)\u003c/code\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left\"\u003eB\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003eUnexplained variation in \u003ccode\u003eX1\u003c/code\u003e after accounting for \u003ccode\u003eY\u003c/code\u003e and \u003ccode\u003eX2\u003c/code\u003e\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003eResiduals from \u003ccode\u003eaov(X1 ~ Y + X2)\u003c/code\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left\"\u003eC\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003eUnexplained variation in \u003ccode\u003eX2\u003c/code\u003e after accounting for \u003ccode\u003eY\u003c/code\u003e and \u003ccode\u003eX1\u003c/code\u003e\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003eResiduals from \u003ccode\u003eaov(X2 ~ Y + X1)\u003c/code\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left\"\u003eD + G\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003eVariance shared by \u003ccode\u003eY\u003c/code\u003e and \u003ccode\u003eX1\u003c/code\u003e\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003e\u003ccode\u003eX1\u003c/code\u003e in \u003ccode\u003eaov(Y ~ X1)\u003c/code\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left\"\u003eE + G\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003eVariance shared by \u003ccode\u003eY\u003c/code\u003e and \u003ccode\u003eX2\u003c/code\u003e\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003e\u003ccode\u003eX2\u003c/code\u003e in \u003ccode\u003eaov(Y ~ X2)\u003c/code\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left\"\u003eD + G\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003eVariance shared by \u003ccode\u003eX1\u003c/code\u003e and \u003ccode\u003eX2\u003c/code\u003e\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003e\u003ccode\u003eX2\u003c/code\u003e in \u003ccode\u003eaov(X1 ~ X2)\u003c/code\u003e\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left\"\u003eD\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003eVariance \u003cem\u003eonly\u003c/em\u003e between \u003ccode\u003eY\u003c/code\u003e and \u003ccode\u003eX1\u003c/code\u003e, without influence from \u003ccode\u003eX2\u003c/code\u003e\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003e(A + D + E + G) − A − (E + G)\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left\"\u003eE\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003eVariance \u003cem\u003eonly\u003c/em\u003e between \u003ccode\u003eY\u003c/code\u003e and \u003ccode\u003eX2\u003c/code\u003e, without influence from \u003ccode\u003eX1\u003c/code\u003e\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003e(C + E + F + G) − C − (F + G)\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left\"\u003eF\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003eVariance \u003cem\u003eonly\u003c/em\u003e between \u003ccode\u003eX1\u003c/code\u003e and \u003ccode\u003eX2\u003c/code\u003e, without influence from \u003ccode\u003eY\u003c/code\u003e\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003e(B + D + F + G) − B − (D + G)\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left\"\u003eG\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003eVariance shared by \u003ccode\u003eY\u003c/code\u003e, \u003ccode\u003eX1\u003c/code\u003e, and \u003ccode\u003eX2\u003c/code\u003e\u003c/td\u003e\n\u003ctd style=\"text-align:left\"\u003e(D + G) − D\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003ePHEW. That’s \u003cem\u003ea lot\u003c/em\u003e. Here’s all the code for it:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ey_total \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ess\u003c/span\u003e(df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eY)    \u003cspan style=\"color:#75715e\"\u003e# A + D + E + G\u003c/span\u003e\nx1_total \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ess\u003c/span\u003e(df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eX1)  \u003cspan style=\"color:#75715e\"\u003e# B + D + F + G\u003c/span\u003e\nx2_total \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ess\u003c/span\u003e(df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eX2)  \u003cspan style=\"color:#75715e\"\u003e# C + E + F + G\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# A\u003c/span\u003e\ny_alone \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eaov\u003c/span\u003e(Y \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e X2 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e X1, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Residuals\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003epull\u003c/span\u003e(sumsq)\n\n\u003cspan style=\"color:#75715e\"\u003e# B\u003c/span\u003e\nx1_alone \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eaov\u003c/span\u003e(X1 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e Y \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e X2, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Residuals\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003epull\u003c/span\u003e(sumsq)\n\n\u003cspan style=\"color:#75715e\"\u003e# C\u003c/span\u003e\nx2_alone \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eaov\u003c/span\u003e(X2 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e Y \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e X1, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Residuals\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003epull\u003c/span\u003e(sumsq)\n\n\u003cspan style=\"color:#75715e\"\u003e# D + G\u003c/span\u003e\ny_plus_x1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eaov\u003c/span\u003e(Y \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e X1, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X1\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003epull\u003c/span\u003e(sumsq)\n\n\u003cspan style=\"color:#75715e\"\u003e# E + G\u003c/span\u003e\ny_plus_x2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eaov\u003c/span\u003e(Y \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e X2, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X2\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003epull\u003c/span\u003e(sumsq)\n\n\u003cspan style=\"color:#75715e\"\u003e# F + G\u003c/span\u003e\nx1_plus_x2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eaov\u003c/span\u003e(X1 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e X2, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X2\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003epull\u003c/span\u003e(sumsq)\n\n\u003cspan style=\"color:#75715e\"\u003e# D = (A + D + E + G) − A − (E + G)\u003c/span\u003e\ny_x1_alone \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e y_total \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e y_alone \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e y_plus_x2\n\n\u003cspan style=\"color:#75715e\"\u003e# E = (A + D + E + G) − A − (D + G)\u003c/span\u003e\ny_x2_alone \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e y_total \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e y_alone \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e y_plus_x1\n\n\u003cspan style=\"color:#75715e\"\u003e# G = (D + G) − D\u003c/span\u003e\ny_x1_x2_alone \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e y_plus_x1 \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e y_x1_alone\n\n\u003cspan style=\"color:#75715e\"\u003e# F = (F + G) - G\u003c/span\u003e\nx1_x2_alone \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e x1_plus_x2 \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e y_x1_x2_alone\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAgain, that’s super complex, but it’s really just a ton of set theory algebra.\u003c/p\u003e\n\u003cp\u003eNow that we have all these little pieces, let’s plot them!\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eall_pieces \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Y\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y_alone,\n                \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X1\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x1_alone,\n                \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X2\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x2_alone,\n                \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X1\u0026amp;Y\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y_x1_alone,\n                \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X2\u0026amp;Y\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y_x2_alone,\n                \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X1\u0026amp;X2\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x1_x2_alone,\n                \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Y\u0026amp;X1\u0026amp;X2\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y_x1_x2_alone)\nall_pieces\n\u003cspan style=\"color:#75715e\"\u003e##       Y      X1      X2    X1\u0026amp;Y    X2\u0026amp;Y   X1\u0026amp;X2 Y\u0026amp;X1\u0026amp;X2 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   304.6   201.6   123.6    39.7    13.3    21.5    42.3\u003c/span\u003e\n\n\u003cspan style=\"color:#a6e22e\"\u003eplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eeuler\u003c/span\u003e(all_pieces),\n     quantities \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eLETTERS\u003c/span\u003e[1\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e7\u003c/span\u003e])\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/08/21/r2-euler/index_files/figure-html/plot-complex-1.png\" width=\"75%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eThese circles are now all proportional to the actual values in the data. Both \u003ccode\u003eX1\u003c/code\u003e and \u003ccode\u003eX2\u003c/code\u003e explain some of the variation in \u003ccode\u003eY\u003c/code\u003e, but not a ton (and \u003ccode\u003eX1\u003c/code\u003e explains more than \u003ccode\u003eX2\u003c/code\u003e). The explained variance is represented by the area D + E + G, which means we can now calculate the actual \u003ccode\u003e\\(R^2\\)\u003c/code\u003e:\u003c/p\u003e\n\u003cp\u003e$$\nR^2 = \\frac{D + E + G}{A + D + E + G} = \\frac{39.69 + 13.27 + 42.29}{304.6 + 39.69 + 13.27 + 42.29} = 0.238\n$$\u003c/p\u003e\n\u003cp\u003eOr with code:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e(y_x1_alone \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e y_x2_alone \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e y_x1_x2_alone) \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\n  (y_alone \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e y_x1_alone \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e y_x2_alone \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e y_x1_x2_alone)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 0.238\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eLet’s confirm it with a regression model:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(Y \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e X1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e X2, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eglance\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003epull\u003c/span\u003e(r.squared)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 0.238\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAMAZING. It’s the same. It worked!\u003c/p\u003e\n\u003ch3 id=\"nicer-plot\"\u003eNicer plot\u003c/h3\u003e\n\u003cp\u003eWith everything nice and proportional, let’s make this plot a little fancier for teaching purposes. Since \u003cstrong\u003eeulerr\u003c/strong\u003e uses grid-based graphics, we can use it with \u003ca href=\"https://patchwork.data-imaginist.com/\"\u003e\u003cstrong\u003epatchwork\u003c/strong\u003e\u003c/a\u003e to add annotations (or combine it with other ggplot objects if we really wanted to):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(patchwork)  \u003cspan style=\"color:#75715e\"\u003e# For combining ggplot and grid elements\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(grid)       \u003cspan style=\"color:#75715e\"\u003e# For making custom grid grobs\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(latex2exp)  \u003cspan style=\"color:#75715e\"\u003e# For writing LaTeX-like text with grid plots\u003c/span\u003e\n\nnice_plot \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eeuler\u003c/span\u003e(all_pieces),\n                  quantities \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(labels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eLETTERS\u003c/span\u003e[1\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e7\u003c/span\u003e],\n                                    fontfamily \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Roboto Condensed Light\u0026#34;\u003c/span\u003e,\n                                    fontsize \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e16\u003c/span\u003e),\n                  fills \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#7FDBFF\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey30\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey80\u0026#34;\u003c/span\u003e,\n                                        \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF851B\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF851B\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey50\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF851B\u0026#34;\u003c/span\u003e),\n                               alpha \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.35\u003c/span\u003e)),\n                  labels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(fontfamily \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Roboto Condensed\u0026#34;\u003c/span\u003e,\n                                fontface \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bold\u0026#34;\u003c/span\u003e, fontsize \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e20\u003c/span\u003e))\n\nmath_part \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etextGrob\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eTeX\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;R^2 = \\\\frac{D + E + G}{A + D + E + G}\u0026#34;\u003c/span\u003e),\n                      gp \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egpar\u003c/span\u003e(fontfamily \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Roboto Condensed\u0026#34;\u003c/span\u003e,\n                                col \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey50\u0026#34;\u003c/span\u003e, fontsize \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e13\u003c/span\u003e))\n\n\u003cspan style=\"color:#75715e\"\u003e# Ordinarily patchwork works just fine with grid grob objects, like the results\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# from plot.euler(), but *not* when they\u0026#39;re the first element in patchwork chain\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# of plots. To make grob objects work nicely with patchwork, we need to wrap\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# them in wrap_elements()\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ewrap_elements\u003c/span\u003e(nice_plot) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003einset_element\u003c/span\u003e(math_part,\n                left \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e-0.04\u003c/span\u003e, bottom \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.72\u003c/span\u003e, right \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.3\u003c/span\u003e, top \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.85\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eplot_annotation\u003c/span\u003e(\n    title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;R² represented as an Euler diagram\u0026#34;\u003c/span\u003e,\n    subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Orange area (D + E + G) shows the total variance in\\noutcome Y that is jointly explained by X1 and X2\u0026#34;\u003c/span\u003e,\n    caption \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Circles sized according to each variable\u0026#39;s sum of squares; size of overlapping areas\\nis not 100% correct due to limitations in available geometric space\u0026#34;\u003c/span\u003e,\n    theme \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(plot.title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e20\u003c/span\u003e, family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Roboto Condensed\u0026#34;\u003c/span\u003e, face \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bold\u0026#34;\u003c/span\u003e),\n                  plot.subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e, family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Roboto Condensed\u0026#34;\u003c/span\u003e),\n                  plot.caption \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Roboto Condensed Light\u0026#34;\u003c/span\u003e, hjust \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e))\n  )\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/08/21/r2-euler/index_files/figure-html/nice-plot-1.png\" width=\"75%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003ch3 id=\"multicollinearity\"\u003eMulticollinearity\u003c/h3\u003e\n\u003cp\u003eAnother neat feature of this kind of diagram is that it helps visualize \u003ca href=\"https://en.wikipedia.org/wiki/Multicollinearity\"\u003emulticollinearity\u003c/a\u003e, or the issues that arise when you control for explanatory variables that explain the same kind of variation in the outcome. Multicollinearity leads to strange coefficient estimates and variance inflation because mathematically the regression model has no way of telling which of the highly correlated explanatory variables explain which parts of the outcome.\u003c/p\u003e\n\u003cp\u003eIn the diagram, areas D and E are uniquely accounted for by \u003ccode\u003eX1\u003c/code\u003e and \u003ccode\u003eX2\u003c/code\u003e respectively, but G is is overlapped, making it impossible to know if \u003ccode\u003eX1\u003c/code\u003e or \u003ccode\u003eX2\u003c/code\u003e explains that portion of the variation in \u003ccode\u003eY\u003c/code\u003e. Similarly, area F shows the variation shared by both \u003ccode\u003eX1\u003c/code\u003e and \u003ccode\u003eX2\u003c/code\u003e, and again it’s impossible to know which parts are unique. As a result, the area (F + G) represents the total multicollinearity in the model:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eeuler\u003c/span\u003e(all_pieces),\n     quantities \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eLETTERS\u003c/span\u003e[1\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e7\u003c/span\u003e],\n     fills \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003erep\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;white\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003erep\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4136\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e)))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/08/21/r2-euler/index_files/figure-html/plot-multicollinearity-1.png\" width=\"75%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003ch2 id=\"why-this-matters\"\u003eWhy this matters\u003c/h2\u003e\n\u003cp\u003eOne really neat thing about thinking about \u003ccode\u003e\\(R^2\\)\u003c/code\u003e this way is that it highlights a key difference in the purposes of regression: prediction and estimation.\u003c/p\u003e\n\u003cp\u003eWith prediction, the goal of the regression model is to predict the outcome as accurately as possible. This is what Netflix does when guessing what show you might want to watch next, or what the \u003ca href=\"https://earlywarningproject.ushmm.org/\"\u003eUS Holocaust Museum does to predict genocide and human rights abuses\u003c/a\u003e. You throw in as many control variables as you can in order to create a model that explains variation in Y as accurately as possible. As a result, these kinds of models will typically have a high \u003ccode\u003e\\(R^2\\)\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eeuler\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Next show\\non Netflix\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X1\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X2\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e6\u003c/span\u003e,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X3\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X4\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e6\u003c/span\u003e,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X5\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e6\u003c/span\u003e,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X1\u0026amp;Next show\\non Netflix\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X2\u0026amp;Next show\\non Netflix\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X3\u0026amp;Next show\\non Netflix\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X4\u0026amp;Next show\\non Netflix\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X5\u0026amp;Next show\\non Netflix\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X1\u0026amp;X2\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Next show\\non Netflix\u0026amp;X1\u0026amp;X2\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e)))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/08/21/r2-euler/index_files/figure-html/plot-diagram-prediction-1.png\" width=\"75%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eLook at that squishy little area of Y that’s not explained by any of the other variables. Neato.\u003c/p\u003e\n\u003cp\u003eIn the realm of causal inference in social science, or with estimation in general, the focus of the analysis is on \u003cem\u003ea single X variable\u003c/em\u003e , like whether or not people in the sample participated in a social program. You might include a bunch of control variables if you identification strategy tells you do: an interaction term for time and group if you’re using \u003ca href=\"https://evalf21.classes.andrewheiss.com/example/diff-in-diff/\"\u003edifference-in-differences\u003c/a\u003e, an indicator showing if people are above/below a threshold if you’re using \u003ca href=\"https://evalf21.classes.andrewheiss.com/example/rdd/\"\u003eregression discontinuity\u003c/a\u003e, an instrument if you’re using \u003ca href=\"https://evalf21.classes.andrewheiss.com/example/iv/\"\u003einstrumental variables\u003c/a\u003e, confounding control variables if you’re using \u003ca href=\"https://evalf21.classes.andrewheiss.com/example/matching-ipw/\"\u003einverse probability weighting and a DAG\u003c/a\u003e, or nothing(!) if you’re using a \u003ca href=\"https://evalf21.classes.andrewheiss.com/example/rcts/\"\u003erandomized controlled trial\u003c/a\u003e (like you can really just run \u003ccode\u003elm(Y ~ treatment)\u003c/code\u003e!). Each of these types of models will inevitably return an \u003ccode\u003e\\(R^2\\)\u003c/code\u003e value, since that what regression does, but we care less about that when estimating causal effects. All we care about is the accuracy of one little sliver of the diagram—that single policy lever that we might have control over to influence the larger outcome.\u003c/p\u003e\n\u003cp\u003eFor instance, let’s say you’re a new little nonprofit who created a cool new program to help reduce childhood poverty within your city. You want to know if that program does anything to poverty more generally. You have lots of donor money so you decide to run a carefully designed randomized trial. You run a regression model and get a tiny \u003ccode\u003e\\(R^2\\)\u003c/code\u003e value, like 0.015. You panic because that means your experiment only explains 1.5% of the variation in poverty, and that seems really bad and low!\u003c/p\u003e\n\u003cp\u003eBut that’s actually totally fine. The goal with the experiment is \u003cem\u003enot\u003c/em\u003e to explain all the factors that create poverty—there are far too many to include in a regression model. The goal here is to have an accurate estimate of how much your single program affects poverty. There’s \u003cem\u003eno way\u003c/em\u003e your little program is going to explain 80% of the variation in poverty. If you had a high \u003ccode\u003e\\(R^2\\)\u003c/code\u003e, I’d be incredibly worried! (Unless you really discovered a program that is a true silver bullet for poverty!)\u003c/p\u003e\n\u003cp\u003eLooking at an Euler diagram demonstrates this more easily. All we care about in this experiment is that little sliver. Is it accurate? Does the treatment move the needle on poverty in any way? If so, great!\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eeuler\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Poverty\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Program\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e,\n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Poverty\u0026amp;Program\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.25\u003c/span\u003e)),\n     fills \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;white\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey75\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF851B\u0026#34;\u003c/span\u003e))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/08/21/r2-euler/index_files/figure-html/plot-diagram-estimation-1.png\" width=\"75%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eSo don’t dismiss models immediately just because of a low \u003ccode\u003e\\(R^2\\)\u003c/code\u003e! The purpose of the models matters!\u003c/p\u003e\n\u003ch2 id=\"caveats\"\u003eCaveats\u003c/h2\u003e\n\u003cp\u003eThere are a few important caveats to keep in mind with these diagrams:\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e1: This is inefficient\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eCalculating each of these plot segments by hand is tedious and there will inevitably be typos and errors (there are probably errors in this very post!). Also, due to how ANOVA works, the order of the variables you specify matters \u003cem\u003ea lot\u003c/em\u003e: \u003ccode\u003eaov(Y ~ X1 + X2)\u003c/code\u003e and \u003ccode\u003eaov(Y ~ X2 + X1)\u003c/code\u003e give completely different sum of squares for the joint variation of \u003ccode\u003eY\u003c/code\u003e, \u003ccode\u003eX1\u003c/code\u003e, and \u003ccode\u003eX2\u003c/code\u003e. That in turn changes the sizes of the segments.\u003c/p\u003e\n\u003cp\u003eWhen writing this, I spent way too much time playing with covariance matrices, partial correlation matrices, and variance-covariance matrices to see if I could calculate these areas more mathematically using the guts of regression and ANOVA, but it was too tricky. Smarter people than me will need to figure it out.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e2: This doesn’t work in all cases\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eIt’s possible to have negative areas, depending on the data you have, and negative areas are unplottable (\u003ca href=\"#ref-Ip:2001\"\u003eIp\u003c/a\u003e (\u003ca href=\"#ref-Ip:2001\"\u003e2001\u003c/a\u003e) shows an example of this at the end of his article). In order to use this kind of diagram when teaching, you have to use carefully constructed data—you can’t just throw any model into a chart like this. Also, when working with actual numbers, you’re generally limited to just one or two explanatory variables. Any more and the math gets too complex.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003e3: This isn’t 100% accurate\u003c/strong\u003e\u003c/p\u003e\n\u003cp\u003eThe geometry behind creating these Euler diagrams is complex and doesn’t always work perfectly. Let’s plot the actual values of the sum of squares for each segment:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eeuler\u003c/span\u003e(all_pieces),\n     quantities \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/08/21/r2-euler/index_files/figure-html/plot-complex-values-1.png\" width=\"75%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eThat central piece where \u003ccode\u003eY\u003c/code\u003e, \u003ccode\u003eX1\u003c/code\u003e, and \u003ccode\u003eX2\u003c/code\u003e is 42, but it’s smaller any of the other intersections, which all have smaller sum-of-squares values. Yikes!\u003c/p\u003e\n\u003cp\u003eThe \u003cstrong\u003eeulerr\u003c/strong\u003e package provides a way of diagnosing how bad things are by either inspecting the results of \u003ccode\u003eeuler()\u003c/code\u003e directly, or looking at the residuals and errors with \u003ccode\u003eerror_plot()\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eeuler\u003c/span\u003e(all_pieces)\n\u003cspan style=\"color:#75715e\"\u003e##         original fitted residuals regionError\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Y          304.6  303.9     0.742       0.001\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## X1         201.6  200.3     1.326       0.001\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## X2         123.6  121.3     2.319       0.002\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Y\u0026amp;X1        39.7   47.6    -7.953       0.011\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Y\u0026amp;X2        13.3   26.5   -13.236       0.018\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## X1\u0026amp;X2       21.5   33.0   -11.541       0.016\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Y\u0026amp;X1\u0026amp;X2     42.3   10.7    31.558       0.042\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## diagError: 0.042 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## stress:    0.009\u003c/span\u003e\n\n\u003cspan style=\"color:#a6e22e\"\u003eerror_plot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eeuler\u003c/span\u003e(all_pieces),\n           quantities \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"https://www.shagunjhaver.com/blog/2021/08/21/r2-euler/index_files/figure-html/plot-errors-1.png\" width=\"75%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eThat central piece is underrepresented, while the other intersections are overrepresented. Alas.\u003c/p\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003cdiv id=\"refs\" class=\"references csl-bib-body hanging-indent\"\u003e\n\u003cdiv id=\"ref-CohenCohen:1975\" class=\"csl-entry\"\u003e\n\u003cp\u003eCohen, Jacob, and Patricia Cohen. 1975. \u003cem\u003eApplied Multiple Regression/Correlation Analysis for the Behavioral Sciences\u003c/em\u003e. New Jersey: Lawrence Erlbaum Associates.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv id=\"ref-Hunt:1986\" class=\"csl-entry\"\u003e\n\u003cp\u003eHunt, Earl. 1986. “The Design of Ballantines.” \u003cem\u003eBehavior Research Methods, Instruments, \u0026amp; Computers\u003c/em\u003e 28 (May): 277–84. \u003ca href=\"https://doi.org/10.3758/BF03204399\"\u003ehttps://doi.org/10.3758/BF03204399\u003c/a\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv id=\"ref-Ip:2001\" class=\"csl-entry\"\u003e\n\u003cp\u003eIp, Edward H. S. 2001. “Visualizing Multiple Regression.” \u003cem\u003eJournal of Statistics Education\u003c/em\u003e 9 (1). \u003ca href=\"https://doi.org/10.1080/10691898.2001.11910646\"\u003ehttps://doi.org/10.1080/10691898.2001.11910646\u003c/a\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n",
            "date_published": "2021-08-21T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2021/07/20/afc-richmond-ted-lasso-cross-stitch/",
            "url": "https://www.shagunjhaver.com/blog/2021/07/20/afc-richmond-ted-lasso-cross-stitch/",
            "title": "AFC Richmond / Ted Lasso cross stitch pattern",
            "summary": "Make your own Ted Lasso AFC Richmond crest cross stitch with a free pattern and an Illustrator template",
            "content_html": "\u003cdiv class=\"alert alert-info\"\u003e\u003ca href=\"#downloads\"\u003eJump to the downloads\u003c/a\u003e and get your own free pattern and template files!\u003c/div\u003e\n\u003cp\u003eApparently I now only produce \u003ca href=\"/blog/tags/cross-stitch/\"\u003ecross stitch content\u003c/a\u003e. Thanks, pandemic.\u003c/p\u003e\n\u003cp\u003eIn preparation for season 2 of the incredible \u003cem\u003eTed Lasso\u003c/em\u003e, I made a cross stitch version of the AFC Richmond crest, and I\u0026rsquo;m really happy with how it turned out!\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"afc-richmond-cross-stitch.jpg\" alt=\"A cross stitched AFC Richmond crest\" title=\"A cross stitched AFC Richmond crest\"\u003e\u003c/p\u003e\n\u003cp\u003eFor the world\u0026rsquo;s enjoyment, and to spread the cheer of Ted Lasso, I\u0026rsquo;ve provided the template—along with the raw Illustrator file—for free! (With a Creative Commons license.)\u003c/p\u003e\n\u003cp\u003eBelieve!\u003c/p\u003e\n\u003cp\u003e\u003cspan id=\"downloads\"\u003eDownload everything here:\u003c/span\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"afc-richmond-cross-stitch.pdf\"\u003eAFC Richmond crest cross stitch PDF\u003c/a\u003e (v1.0, 2021-07-20)\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"afc-richmond-cross-stitch.ai\"\u003eAFC Richmond crest cross stitch Illustrator file\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ca href=\"afc-richmond-cross-stitch.pdf\"\u003e\u003cimg src=\"afc-richmond-cross-stitch.png\" alt=\"AFC Richmond crest, from Ted Lasso\" title=\"AFC Richmond crest, from Ted Lasso\"\u003e\u003c/a\u003e\u003c/p\u003e\n",
            "date_published": "2021-07-20T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2021/07/10/hex-cross-stitch/",
            "url": "https://www.shagunjhaver.com/blog/2021/07/10/hex-cross-stitch/",
            "title": "Hex sticker/logo cross stitch pattern",
            "summary": "Make your own data science hex logo cross stitch with a free pattern and an Illustrator template",
            "content_html": "\u003cdiv class=\"alert alert-info\"\u003e\u003ca href=\"#downloads\"\u003eJump to the downloads\u003c/a\u003e and get your own free pattern and template files!\u003c/div\u003e\n\u003cp\u003eIn the data science world, hex stickers with logos of developers' favorite packages are all the rage. People collect them at conferences and events and display them on their laptops (or, like me, keep them in a pile on their desk because they\u0026rsquo;re too afraid to commit to affixing them anywhere permanently). There are even \u003ca href=\"http://hexb.in/sticker.html\"\u003eofficial standard dimensions\u003c/a\u003e and \u003ca href=\"https://github.com/terinjokes/StickersStandard\"\u003etemplates\u003c/a\u003e people can follow.\u003c/p\u003e\n\u003cp\u003eJust for fun, I make hex logos for each of my classes (\u003ca href=\"https://evalsp21.classes.andrewheiss.com/\"\u003eprogram evaluation/causal inference\u003c/a\u003e, \u003ca href=\"https://econs21.classes.andrewheiss.com/\"\u003emicroeconomics\u003c/a\u003e, and \u003ca href=\"https://datavizs21.classes.andrewheiss.com/\"\u003edata visualization\u003c/a\u003e)—see all \u003ca href=\"https://github.com/andrewheiss/hex-stickers\"\u003emy class and package hex logos here\u003c/a\u003e—and in non-pandemic times I print them and hand them out to students at the beginning of class. They look awesome.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"class-hexes.png\" alt=\"Course-specific hex logos\" title=\"Course-specific hex logos\"\u003e\u003c/p\u003e\n\u003cp\u003eContinuing my pandemic art kick (on this, the four hundred and eighty-fifth day of sheltering in place), and following my foray into cross stitch (like \u003ca href=\"https://www.andrewheiss.com/blog/2021/01/26/bayesian-cross-stitch-sampler/\"\u003ethis Bayesian Sampler\u003c/a\u003e), I decided to make cross stitch versions of my hex logos. So I stuck my program evaluation logo into Illustrator, pixel-art-ified it by hand, and made the thing.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"eval-cross-stitch.jpg\" alt=\"A cross stitched hex logo\" title=\"A cross stitched hex logo\"\u003e\u003c/p\u003e\n\u003cp\u003eThe design is a generic \u003ca href=\"https://en.wikipedia.org/wiki/Directed_acyclic_graph\"\u003eDAG\u003c/a\u003e showing an exposure, an outcome, an indirect effect, a confounder, and a collider; the color palette comes from the viridis inferno scale, generated with \u003ccode\u003eviridisLite::viridis(8, option = \u0026quot;inferno\u0026quot;, begin = 0.1, end = 0.9)\u003c/code\u003e in R.\u003c/p\u003e\n\u003cp\u003eTo help the world create hex logo cross stitch art, I\u0026rsquo;ve provided the Illustrator file for free! (with a Creative Commons license). Make your own designs—just delete the stuff on the Text and Pattern layers and add little rectangles filled with some color + a 0.5 point white stroke.\u003c/p\u003e\n\u003cp\u003e\u003cspan id=\"downloads\"\u003eDownload everything here!\u003c/span\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"hex-sticker-template.pdf\"\u003eHex logo cross stitch PDF\u003c/a\u003e (v1.0, 2021-02-15)\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"hex-sticker-template.ai\"\u003eHex logo cross stitch Illustrator file\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ca href=\"hex-sticker-template.pdf\"\u003e\u003cimg src=\"eval-template.png\" alt=\"A Bayesian sampler\" title=\"A Bayesian sampler\"\u003e\u003c/a\u003e\u003c/p\u003e\n",
            "date_published": "2021-07-10T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2021/01/26/bayesian-cross-stitch-sampler/",
            "url": "https://www.shagunjhaver.com/blog/2021/01/26/bayesian-cross-stitch-sampler/",
            "title": "Bayesian (cross stitch) sampler",
            "summary": "Make your own Bayesian cross stitch sampler with a free pattern of Bayes Theorem and the accompanying Illustrator template",
            "content_html": "\u003cdiv class=\"alert alert-info\"\u003e\u003ca href=\"#downloads\"\u003eJump to the downloads\u003c/a\u003e and get your own free pattern!\u003c/div\u003e\n\u003cp\u003eFor my latest pandemic art medium (on this, the three hundred and nineteenth day of sheltering in place), I decided to teach myself how to cross stitch. I did a ton of needlepoint as a kid and teen, but was always afraid of cross stitch because it was so much smaller and more delicate.\u003c/p\u003e\n\u003cp\u003eI somehow stumbled across \u003ca href=\"https://sgibson91.github.io/cross-stitch-carpentry/index.html\"\u003ethis lesson repository\u003c/a\u003e created by The Carpentries, an organization that normally teaches workshops on reproducible research and data scientific software like R and Python. This nifty \u003ca href=\"https://sgibson91.github.io/cross-stitch-carpentry/index.html\"\u003eCross Stitch Carpentry\u003c/a\u003e workshop is incredibly helpful and easy to follow, and after downloading \u003ca href=\"https://t.co/7d0BS3A0K9\"\u003ea pattern from Etsy\u003c/a\u003e, I successfully made my first cross stitched thing: \u003ca href=\"https://twitter.com/andrewheiss/status/1353172960119566336?s=21\"\u003ea miniature porg\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eI next wanted to make something related to my work with data and stats. In July, I made \u003ca href=\"https://twitter.com/andrewheiss/status/1287200192647827459?s=21\"\u003ea linocut print of the R logo\u003c/a\u003e, so I considered doing that with cross stitch too, but that seemed like a lot of thread. Also, I couldn’t find a good way to make a good pattern. There’s \u003ca href=\"https://github.com/glasnt/ih\"\u003ea neat Python program named \u003cstrong\u003eih\u003c/strong\u003e\u003c/a\u003e that automatically creates embroidery and cross stitch patterns from images, and there are plenty of (sketchy?) online resources for converting images to patterns (they probably rely on \u003cstrong\u003eih\u003c/strong\u003e behind the scenes?), but I like having more control over the output.\u003c/p\u003e\n\u003cp\u003eAfter lots of googling, I found that \u003ca href=\"https://blog.stitchpeople.com/creating-graph-templates/\"\u003eyou can use Adobe Illustrator to create cross stitch patterns\u003c/a\u003e (there’s an archived Facebook Live video \u003ca href=\"https://www.facebook.com/stitchpeople/videos/day-1-of-cross-stitch-a-portrait-with-lizzy/512456752992667/\"\u003eshowing the process here\u003c/a\u003e), which is perfect, since I use Illustrator all the time.\u003c/p\u003e\n\u003cp\u003eSo I drew the formula for \u003ca href=\"https://en.wikipedia.org/wiki/Bayes%27_theorem\"\u003eBayes’ theorem\u003c/a\u003e with little boxes, added some flourishes and borders, and made my first cross stitch pattern, which I then made into an actual cross stitch: a Bayesian \u003ca href=\"https://mc-stan.org/docs/2_26/reference-manual/hamiltonian-monte-carlo.html\"\u003esampler\u003c/a\u003e!\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"sampler-photo.jpg\" alt=\"A cross stitched Bayesian sampler\" title=\"A cross stitched Bayesian sampler\"\u003e\u003c/p\u003e\n\u003cp\u003eThe color palette is inspired from the jewel colors of the 2021 inauguration (via Cianna Bedford-Petersen’s \u003ca href=\"https://github.com/ciannabp/inauguration\"\u003eR package\u003c/a\u003e). The density plots in the corners and center are stylized prior and posterior distributions. The borders on the top and bottom are stylized trace plots showing intertwined \u003ca href=\"https://en.wikipedia.org/wiki/Markov_chain_Monte_Carlo\"\u003eMCMC chains\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eI’ve polished the pattern in Illustrator and released it for free! (with a Creative Commons license). I’ve also provided the original Illustrator file so that you can make your own designs—just delete the stuff on the Text and Pattern layers and add little rectangles filled with some color + a 0.5 point white stroke.\u003c/p\u003e\n\u003cp\u003e\u003cspan id=\"downloads\"\u003eDownload everything here!\u003c/span\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"bayesian-sampler.pdf\"\u003e“Bayesian Sampler” PDF\u003c/a\u003e (v1.0, 2021-01-25)\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"bayesian-sampler-paginated.pdf\"\u003e“Bayesian Sampler” paginated PDF\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"bayesian-sampler.ai\"\u003e“Bayesian Sampler” Illustrator file\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e\u003ca href=\"bayesian-sampler.pdf\"\u003e\u003cimg src=\"bayesian-sampler.png\" alt=\"A Bayesian sampler\" title=\"A Bayesian sampler\"\u003e\u003c/a\u003e\u003c/p\u003e\n",
            "date_published": "2021-01-26T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2021/01/15/msm-gee-multilevel/",
            "url": "https://www.shagunjhaver.com/blog/2021/01/15/msm-gee-multilevel/",
            "title": "Marginal structural models for panel data with GEE and multilevel models",
            "summary": "Use R to correctly close backdoor confounding in panel data with marginal structural models and inverse probability weights with both GEE and multilevel models",
            "content_html": "\u003cscript src=\"/blog/2021/01/15/msm-gee-multilevel/index_files/kePrint-0.0.1/kePrint.js\"\u003e\u003c/script\u003e\n\u003clink href=\"/blog/2021/01/15/msm-gee-multilevel/index_files/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" /\u003e\n\u003cscript src=\"/blog/2021/01/15/msm-gee-multilevel/index_files/kePrint-0.0.1/kePrint.js\"\u003e\u003c/script\u003e\n\u003clink href=\"/blog/2021/01/15/msm-gee-multilevel/index_files/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" /\u003e\n\u003cscript src=\"/blog/2021/01/15/msm-gee-multilevel/index_files/kePrint-0.0.1/kePrint.js\"\u003e\u003c/script\u003e\n\u003clink href=\"/blog/2021/01/15/msm-gee-multilevel/index_files/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" /\u003e\n\u003cp\u003eSince my last two blog posts on \u003ca href=\"https://www.andrewheiss.com/blog/2020/12/01/ipw-binary-continuous/\"\u003ebinary and continuous inverse probability weights (IPWs)\u003c/a\u003e and \u003ca href=\"https://www.andrewheiss.com/blog/2020/12/03/ipw-tscs-msm/\"\u003emarginal structural models (MSMs) for time-series cross-sectional (TSCS) panel data\u003c/a\u003e, I’ve spent a ton of time trying to figure out why I couldn’t recover the exact causal effect I had built in to those examples when using panel data. It was a mystery, and it took weeks to figure out what was happening.\u003c/p\u003e\n\u003cp\u003eAfter poring through all sorts of articles on MSMs and TSCS data like \u003ca href=\"#ref-ThoemmesOng:2016\"\u003eThoemmes and Ong\u003c/a\u003e (\u003ca href=\"#ref-ThoemmesOng:2016\"\u003e2016\u003c/a\u003e) and \u003ca href=\"#ref-BlackwellGlynn:2018\"\u003eBlackwell and Glynn\u003c/a\u003e (\u003ca href=\"#ref-BlackwellGlynn:2018\"\u003e2018\u003c/a\u003e), along with all sorts of articles on the differences between \u003ca href=\"https://en.wikipedia.org/wiki/Generalized_estimating_equation\"\u003egeneralized estimating equations (GEEs)\u003c/a\u003e, which the epidemiology world (and everyone who does MSMs) seems to love, and multilevel models (which I find a lot more intuitive, and which can be done Bayesianly with \u003cstrong\u003ebrms\u003c/strong\u003e), I \u003cem\u003efinally\u003c/em\u003e figured out what was wrong and how to calculate correct IPWs for panel data.\u003c/p\u003e\n\u003cp\u003eThe main issue lies in the synthetic data I had created for those earlier blog posts. \u003ca href=\"https://www.andrewheiss.com/blog/2020/12/03/ipw-tscs-msm/#simulated-time-series-cross-sectional-data\"\u003eThere, I used the \u003cstrong\u003efabricatr\u003c/strong\u003e package to create a country-year panel\u003c/a\u003e, which seemed correct and great. However, it didn’t exactly match the data-generating process in situations where the value in one time period (like \u003ccode\u003e\\(X_t\\)\u003c/code\u003e) depends on the value from the previous time period (or \u003ccode\u003e\\(X_{t-1}\\)\u003c/code\u003e), or autocorrelation. As such, I couldn’t quite get the correct causal effects out (since the data didn’t show interdepdency across time).\u003c/p\u003e\n\u003cp\u003eAfter lots of struggle, though, I finally figured out a way to explicitly build this autocorrelation in. And thanks to this delightfully accessible article by \u003ca href=\"#ref-ThoemmesOng:2016\"\u003eThoemmes and Ong\u003c/a\u003e (\u003ca href=\"#ref-ThoemmesOng:2016\"\u003e2016\u003c/a\u003e) (\u003ca href=\"https://anthonyongphd.files.wordpress.com/2016/02/emerging-adulthood-2016-thoemmes-40-59.pdf\"\u003eungated free version here\u003c/a\u003e), I found clear code for MSMs that I could expand to test on more complex panel data.\u003c/p\u003e\n\u003cp\u003eIn this post, I’ll do a few things: (1) recreate the two-time-period example from Thoemmes and Ong’s appendix (which is stuck in a PDF and really hard to copy/paste out), (2) redo their two-period example with a tidier approach, and (3) expand their two-period approach to multiple years and replace GEEs with multilevel models.\u003c/p\u003e\n\u003cp\u003eHere we go!\u003c/p\u003e\n\u003ch2 id=\"contents----omit-in-toc---\"\u003eContents \u003c!-- omit in toc --\u003e\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#synthetic-data-overview\"\u003eSynthetic data overview\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#original-two-period-thoemmes-and-ong-results\"\u003eOriginal two-period Thoemmes and Ong results\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tidier-two-period-results\"\u003eTidier two-period results\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#expansion-to-multiple-period-data\"\u003eExpansion to multiple-period data\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#tricky-interdependent-data-generating-process\"\u003eTricky interdependent data generating process\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#multiple-period-marginal-structural-models\"\u003eMultiple-period marginal structural models\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#questions-for-the-future\"\u003eQuestions for the future\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#references\"\u003eReferences\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(broom)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(ggdag)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(dagitty)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(ipw)  \u003cspan style=\"color:#75715e\"\u003e# For automatically calculating IPWs\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(geepack)  \u003cspan style=\"color:#75715e\"\u003e# For GEE models\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(lme4)  \u003cspan style=\"color:#75715e\"\u003e# For mixed/multilevel models\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(broom.mixed)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(kableExtra)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"synthetic-data-overview\"\u003eSynthetic data overview\u003c/h2\u003e\n\u003cp\u003eIn their paper, Thoemmes and Ong create simulated data based on this DAG, with a time-varying treatment, a non-time-varying confounder, and a time-varying outcome (depression):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# I generally prefer the easier-to-read formula syntax in dagify() (i.e. D1 ~ T1\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# + C, etc.), but it doesn\u0026#39;t work with subscripted numbers like T[1], so we have\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# to use this dagitty syntax instead\u003c/span\u003e\ndepression_dag \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edagitty\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;dag {\n\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;C\u0026#34; [pos=\u0026#34;2.5,2\u0026#34;]\n\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;T[1]\u0026#34; [pos=\u0026#34;1,1\u0026#34;]\n\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;D[1]\u0026#34; [pos=\u0026#34;2,1\u0026#34;]\n\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;T[2]\u0026#34; [pos=\u0026#34;3,1\u0026#34;]\n\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;D[2]\u0026#34; [pos=\u0026#34;4,1\u0026#34;]\n\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;C\u0026#34; -\u0026gt; \u0026#34;D[1]\u0026#34;\n\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;C\u0026#34; -\u0026gt; \u0026#34;D[2]\u0026#34;\n\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;C\u0026#34; -\u0026gt; \u0026#34;T[1]\u0026#34;\n\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;C\u0026#34; -\u0026gt; \u0026#34;T[2]\u0026#34;\n\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;D[1]\u0026#34; -\u0026gt; \u0026#34;T[2]\u0026#34;\n\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;T[1]\u0026#34; -\u0026gt; \u0026#34;D[1]\u0026#34;\n\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;T[2]\u0026#34; -\u0026gt; \u0026#34;D[2]\u0026#34;\n\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e}\u0026#39;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etidy_dagitty\u003c/span\u003e()\n\n\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(depression_dag, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e xend, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e yend)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_edges\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_point\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey80\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e12\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_text\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;black\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, parse \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_dag\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"/blog/2021/01/15/msm-gee-multilevel/index_files/figure-html/depression-dag-1.png\" width=\"75%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eEssentially earlier treatment ($T_1$) causes some level of depression ($D_1$), which causes later treatment ($T_2$), which causes later depression ($D_2$). This whole chain is influenced by some non-varying confounder ($C$).\u003c/p\u003e\n\u003ch2 id=\"original-two-period-thoemmes-and-ong-results\"\u003eOriginal two-period Thoemmes and Ong results\u003c/h2\u003e\n\u003cp\u003eHere’s the original code from the appendix of \u003ca href=\"#ref-ThoemmesOng:2016\"\u003eThoemmes and Ong\u003c/a\u003e (\u003ca href=\"#ref-ThoemmesOng:2016\"\u003e2016\u003c/a\u003e) for data with a time-varying continuous treatment and a confounder. It explicitly creates columns for \u003ccode\u003et1\u003c/code\u003e, \u003ccode\u003ed1\u003c/code\u003e, \u003ccode\u003et2\u003c/code\u003e, and \u003ccode\u003ed2\u003c/code\u003e, so it is easy to mathematically make it so that \u003ccode\u003et2\u003c/code\u003e is caused by \u003ccode\u003ed1\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eBecause it’s only two time periods, they calculate the inverse probability weights in two formulas and then multiply them together:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eWeights for the first time period:\u003c/p\u003e\n\u003cp\u003e$$\nw_1 = \\frac{\\phi(T_{i1})}{\\phi(T_{i1}\\ |\\ C)}\n$$\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eWeights for the second time period:\u003c/p\u003e\n\u003cp\u003e$$\nw_2 = \\frac{\\phi(T_{i2}\\ |\\ T_{i1})}{\\phi(T_{i2}\\ |\\ C, T_{i1}, D_{i1})}\n$$\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eFinal weights:\u003c/p\u003e\n\u003cp\u003e$$\nw = w_1 \\cdot w_2\n$$\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eHere’s their code:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e##################################################################### \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# iptw demo with time-varying continuous treatment and confounder\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#####################################################################\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# Felix Thoemmes, October, 2015 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#####################################################################\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e#set seed to replicate results\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eset.seed\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e12345\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e#define sample size\u003c/span\u003e\nn \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2000\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#define confounder c\u003c/span\u003e\nc \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n,\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e,\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e#define treatment at time 1 as function of confounder\u003c/span\u003e\nt1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003ec \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n,\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e.99\u003c/span\u003e))\n\u003cspan style=\"color:#75715e\"\u003e#define depression at time 1 as function of confounder and treat1\u003c/span\u003e\nd1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003ec \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.4\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003et1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n,\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e.822\u003c/span\u003e))\n\u003cspan style=\"color:#75715e\"\u003e#define treatment at time 2 as function of confounder and dep1\u003c/span\u003e\nt2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003ec \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.4\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003ed1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.4\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003et1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n,\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e.5196\u003c/span\u003e))\n\u003cspan style=\"color:#75715e\"\u003e#define outcome depression at time 2 as function of confounder, treat1, and dep1 \u003c/span\u003e\nd2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003ec \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.4\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003et2 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.4\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003ed1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n,\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e.4582\u003c/span\u003e))\n\u003cspan style=\"color:#75715e\"\u003e#add ID variable to do mixed effects models later\u003c/span\u003e\nid \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erep\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003elength\u003c/span\u003e(c))\n\ndf1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edata.frame\u003c/span\u003e(id, c, t1, d1, t2, d2)\n\n\u003cspan style=\"color:#75715e\"\u003e#compute the weights for timepoint 1\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#this is a continuous treatment\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#therefore we use densities of normal distributions\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#weights at time 1\u003c/span\u003e\nw1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(df1\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et1, \u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(t1 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)), \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(t1 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eresiduals)) \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(df1\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et1, \u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(t1 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e c)), \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(t1 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e c)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eresiduals))\n\n\u003cspan style=\"color:#75715e\"\u003e#weights at time 2\u003c/span\u003e\nw2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(df1\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et2, \u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(t2 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t1)), \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(t2 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t1)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eresiduals)) \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(df1\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et2, \u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(t2 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e c \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e d1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t1)), \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(t2 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e c \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e d1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t1)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eresiduals)) \n\n\u003cspan style=\"color:#75715e\"\u003e#total weights are a product of all time-varying weights\u003c/span\u003e\nw \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e w1\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003ew2\n\n\u003cspan style=\"color:#75715e\"\u003e#truncate weights at 5%\u003c/span\u003e\ntw1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eifelse\u003c/span\u003e(w \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003equantile\u003c/span\u003e(w, probs \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.05\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003equantile\u003c/span\u003e(w, probs \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.05\u003c/span\u003e), w)\ntw1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eifelse\u003c/span\u003e(w \u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003equantile\u003c/span\u003e(w, probs \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.95\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003equantile\u003c/span\u003e(w, probs \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.95\u003c/span\u003e), tw1)\n\n\u003cspan style=\"color:#75715e\"\u003e#truncate weights at 1%\u003c/span\u003e\ntw2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eifelse\u003c/span\u003e(w \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003equantile\u003c/span\u003e(w, probs \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.01\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003equantile\u003c/span\u003e(w, probs \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.01\u003c/span\u003e), w)\ntw2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eifelse\u003c/span\u003e(w \u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003equantile\u003c/span\u003e(w, probs \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.99\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003equantile\u003c/span\u003e(w, probs \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.99\u003c/span\u003e), tw2)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThey they run a bunch of different outcome models with \u003ccode\u003egeeglm()\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eonly_t1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(d2 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t1, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df1, id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erownames\u003c/span\u003e(df1))\nonly_t2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(d2 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t2, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df1, id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erownames\u003c/span\u003e(df1))\nboth_t \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(d2 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t2, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df1, id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erownames\u003c/span\u003e(df1))\nboth_t_c \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(d2 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t2 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e c \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e d1, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df1, id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erownames\u003c/span\u003e(df1))\n\nstab_ipw \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(d2 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t2, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df1, id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erownames\u003c/span\u003e(df1), weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e w)\nstab_ipw_1p \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(d2 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t2, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df1, id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erownames\u003c/span\u003e(df1), weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e tw2)\nstab_ipw_5p \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(d2 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t2, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df1, id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erownames\u003c/span\u003e(df1), weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e tw1)\n\nresults \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etribble\u003c/span\u003e(\n  \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e`Method`, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e`T\u0026lt;sub\u0026gt;1\u0026lt;/sub\u0026gt; effect`, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e`T\u0026lt;sub\u0026gt;2\u0026lt;/sub\u0026gt; effect`,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;True effect\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.160\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.400\u003c/span\u003e,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Naive, only T1\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(only_t1), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t1\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#66d9ef\"\u003eNA\u003c/span\u003e,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Naive, only T2\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#66d9ef\"\u003eNA\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(only_t2), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t2\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Naive, both\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(both_t), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t1\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(both_t), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t2\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Naive, both + controls\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(both_t_c), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t1\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(both_t_c), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t2\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;IPW\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(stab_ipw), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t1\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(stab_ipw), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t2\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;IPW, 1% truncated\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(stab_ipw_1p), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t1\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(stab_ipw_1p), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t2\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;IPW, 5% truncated\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(stab_ipw_5p), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t1\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(stab_ipw_5p), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t2\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate\n)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ctable style=\"width:70%; margin-left: auto; margin-right: auto;\" class=\" pure-table pure-table-horizontal\"\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align:left;\"\u003e\nMethod\n\u003c/th\u003e\n\u003cth style=\"text-align:right;\"\u003e\nT\u003csub\u003e1\u003c/sub\u003e effect\n\u003c/th\u003e\n\u003cth style=\"text-align:right;\"\u003e\nT\u003csub\u003e2\u003c/sub\u003e effect\n\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nTrue effect\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.160\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.400\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nNaive, only T1\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.423\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n—\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nNaive, only T2\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n—\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.649\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nNaive, both\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.048\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.623\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nNaive, both + controls\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.011\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.399\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nIPW\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.157\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.421\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nIPW, 1% truncated\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.154\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.434\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nIPW, 5% truncated\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.131\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.480\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003eAnd here’s all that compared to what they have in the paper:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"ThoemmesOng-Table2.png\" width=\"50%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eIt’s identical! I’m chalking any tiny differences up to the fact that \u003ccode\u003eset.seed()\u003c/code\u003e changed with R 4.0 and they used R 3.x in their paper. (Also the T2-only model is wrong, but that’s probably a typo—the “estimated scale parameter” from that model is 0.574 with an sd of 0.018, which lines up perfectly with the coefficient in the published table, so I think maybe the published paper has the wrong number in the table.)\u003c/p\u003e\n\u003cp\u003eAlso, there seems to be another typo in that table. The true effect of T1 in the table is 0.140, but in the text of the paper, it says the effect should be 0.160, which makes sense—that’s the product of 0.4 × 0.4, or each of the treatment coefficients ($0.4 \\times 0.4 = 0.16$).\u003c/p\u003e\n\u003cp\u003eRegardless of those super tiny insignificant typos, we did it! We have their exact results using marginal structural models and inverse probability weights.\u003c/p\u003e\n\u003ch2 id=\"tidier-two-period-results\"\u003eTidier two-period results\u003c/h2\u003e\n\u003cp\u003eThe code to generate that data isn’t very tidyverse-friendly and it creates a ton of intermediate vectors. Here’s a cleaner version with \u003cstrong\u003edplyr\u003c/strong\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eset.seed\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e12345\u003c/span\u003e)\nn \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2000\u003c/span\u003e\n\ndf_nice \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003en,\n                  c \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(t1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e c) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.99\u003c/span\u003e)),\n         d1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e c) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e t1) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.822\u003c/span\u003e)),\n         t2 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e c) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e d1) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e t1) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.5196\u003c/span\u003e)),\n         d2 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e c) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e t2) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e d1) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.4582\u003c/span\u003e)))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAlso, this original data is wide, with explicit columns for each time period. Let’s make it tidy and pretend the time periods are years (\u003ccode\u003ey\u003c/code\u003e) and add some lagged columns:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003edf_tidy \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e df_nice \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003epivot_longer\u003c/span\u003e(cols \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(t1, d1, t2, d2)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eseparate\u003c/span\u003e(name, into \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;variable\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;y\u0026#34;\u003c/span\u003e), sep \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003epivot_wider\u003c/span\u003e(names_from \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;variable\u0026#34;\u003c/span\u003e, values_from \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;value\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(id) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eacross\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(t, d), \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(lag \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e lag))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eungroup\u003c/span\u003e()\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(df_tidy)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 x 7\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##      id      c y           t       d  t_lag   d_lag\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;int\u0026gt;  \u0026lt;dbl\u0026gt; \u0026lt;chr\u0026gt;   \u0026lt;dbl\u0026gt;   \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;   \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1     1  0.586 1     -0.546  -1.11   NA     NA     \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2     1  0.586 2     -0.853  -1.73   -0.546 -1.11  \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3     2  0.709 1      1.14    0.361  NA     NA     \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4     2  0.709 2     -0.0673 -1.30    1.14   0.361 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5     3 -0.109 1     -0.584  -0.0822 NA     NA     \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6     3 -0.109 2     -0.932   0.535  -0.584 -0.0822\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThis is how panel data is typically structured, with rows repeated for each time period. This is good because we can figure out how to structure the weight models and outcome model in a way that uses this structure and compare it to the original \u003ccode\u003et1\u003c/code\u003e, \u003ccode\u003ed1\u003c/code\u003e, etc. models.\u003c/p\u003e\n\u003cp\u003eBecause there are only two time periods, the lagged columns here are missing a ton of data (since you can’t see what the value is for year 0), but it’ll still work.\u003c/p\u003e\n\u003cp\u003eWith the data like this, we can find the weights. We’ll do it both manually and with the \u003cstrong\u003eipw\u003c/strong\u003e package.\u003c/p\u003e\n\u003cp\u003eManually, we need to fit two models (a numerator and denominator) and then take the cumulative product of their probability distributions:\u003c/p\u003e\n\u003cp\u003e$$\nw = \\prod^t_{t = 1} \\frac{\\phi(T_{it} | T_{i, t-1}, C_i)}{\\phi(T_{it} | T_{i, t-1}, D_{i, t-1}, C_i)}\n$$\u003c/p\u003e\n\u003cp\u003eHere we go!\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Remove NAs since ipwpoint() will complain\u003c/span\u003e\ndf_tidy_sans_na \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e df_tidy \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e!\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eis.na\u003c/span\u003e(t_lag))\n\n\u003cspan style=\"color:#75715e\"\u003e# Manually\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# Numerator is lagged treatment + non-varying confounders\u003c/span\u003e\nmodel_num \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(t \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e c,\n                data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_tidy_sans_na)\n\n\u003cspan style=\"color:#75715e\"\u003e# Denominator is lagged treatment, lagged outcome, time-varying confounders +\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# non-varying confounders\u003c/span\u003e\nmodel_denom \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(t \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e d_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e c, \n                  data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_tidy_sans_na)\n\n\u003cspan style=\"color:#75715e\"\u003e# Probability distributions\u003c/span\u003e\nnum \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(df_tidy_sans_na\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et,\n             \u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(model_num),\n             \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eresiduals\u003c/span\u003e(model_num)))\n\nden \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(df_tidy_sans_na\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et,\n             \u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(model_denom),\n             \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eresiduals\u003c/span\u003e(model_denom)))\n\n\u003cspan style=\"color:#75715e\"\u003e# Make num/den fraction and find cumulative product within each id\u003c/span\u003e\ndf_weights_manual \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e df_tidy_sans_na \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(weights_no_time \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e num \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e den) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(id) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(ipw \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecumprod\u003c/span\u003e(weights_no_time)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eungroup\u003c/span\u003e()\n\n\u003cspan style=\"color:#75715e\"\u003e# Automatically find weights with ipw::ipwpoint()\u003c/span\u003e\ntidy_weights_auto \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eipwpoint\u003c/span\u003e(\n  exposure \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e t,\n  family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;gaussian\u0026#34;\u003c/span\u003e, \n  numerator \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e c, \n  denominator \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e d_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e c, \n  data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eas.data.frame\u003c/span\u003e(df_tidy_sans_na))\n\ndf_weights_auto \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e df_tidy_sans_na \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(ipw \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e tidy_weights_auto\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eipw.weights)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNow we can use these new weights in the outcome model:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emodel_lags_manual \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(d \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t_lag, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_weights_manual,\n                            id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e id, weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ipw)\n\nmodel_lags_auto \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(d \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t_lag, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_weights_auto, \n                          id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e id, weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ipw)\n\nresults \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etribble\u003c/span\u003e(\n  \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e`Method`, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e`T\u0026lt;sub\u0026gt;1\u0026lt;/sub\u0026gt; effect`, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e`T\u0026lt;sub\u0026gt;2\u0026lt;/sub\u0026gt; effect`,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;True effect\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.160\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.400\u003c/span\u003e,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;IPW, original\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(stab_ipw), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t1\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(stab_ipw), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t2\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;IPW, lagged, manual\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_lags_manual), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t_lag\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_lags_manual), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;IPW, lagged, automatic\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_lags_auto), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t_lag\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_lags_auto), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate\n) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eacross\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003esprintf\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;%.3f\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eround\u003c/span\u003e(., \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e)))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eadd_row\u003c/span\u003e(`T\u0026lt;sub\u0026gt;1\u0026lt;/sub\u0026gt; effect` \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u0026lt;b\u0026gt;lag(T) effect\u0026lt;/b\u0026gt;\u0026#34;\u003c/span\u003e, \n          `T\u0026lt;sub\u0026gt;2\u0026lt;/sub\u0026gt; effect` \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u0026lt;b\u0026gt;T effect\u0026lt;/b\u0026gt;\u0026#34;\u003c/span\u003e, \n          .after \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ctable style=\"width:70%; margin-left: auto; margin-right: auto;\" class=\" pure-table pure-table-horizontal\"\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align:left;\"\u003e\nMethod\n\u003c/th\u003e\n\u003cth style=\"text-align:left;\"\u003e\nT\u003csub\u003e1\u003c/sub\u003e effect\n\u003c/th\u003e\n\u003cth style=\"text-align:left;\"\u003e\nT\u003csub\u003e2\u003c/sub\u003e effect\n\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nTrue effect\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n0.160\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n0.400\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nIPW, original\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n0.157\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n0.421\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n—\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n\u003cb\u003elag(T) effect\u003c/b\u003e\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n\u003cb\u003eT effect\u003c/b\u003e\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nIPW, lagged, manual\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n0.150\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n0.441\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nIPW, lagged, automatic\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n0.150\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n0.441\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003eThose results aren’t identical (I don’t know why!), but they’re close-ish, so whatever. It worked! Instead of using explicit \u003ccode\u003et1\u003c/code\u003e, \u003ccode\u003ed1\u003c/code\u003e, etc. columns, we can do the same marginal structural model with just \u003ccode\u003et\u003c/code\u003e and \u003ccode\u003ed\u003c/code\u003e in a long data frame.\u003c/p\u003e\n\u003ch2 id=\"expansion-to-multiple-period-data\"\u003eExpansion to multiple-period data\u003c/h2\u003e\n\u003cp\u003eSince that’s all working, now we can do something a little/lot trickier—instead of manually specifying \u003ccode\u003e\\(T_1\\)\u003c/code\u003e and \u003ccode\u003e\\(T_2\\)\u003c/code\u003e, which isn’t really easily scalable to more time periods, we’ll construct the data more generally for any number of years\u003c/p\u003e\n\u003ch3 id=\"tricky-interdependent-data-generating-process\"\u003eTricky interdependent data generating process\u003c/h3\u003e\n\u003cp\u003eThe trick here is that we want to have any number of time periods, but also maintain the same DAG relationships. In the small data, these are the two general relationships:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e\\(\\text{treatment}_t = (0.1 \\cdot \\text{confounder}) + (0.4 \\cdot \\text{depression}_{t-1}) + (0.4 \\cdot \\text{treatment}_{t-1}) + \\text{noise}\\)\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e\\(\\text{depression}_t = (0.1 \\cdot \\text{confounder}) + (0.4 \\cdot \\text{treatment}_{t}) + (0.4 \\cdot \\text{depression}_{t-1}) + \\text{noise}\\)\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eOr in code:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003et = (0.1 * c) + (0.4 * lag(d)) + (0.4 * lag(t)) + rnorm(n, 0, sqrt(0.5196))\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ed = (0.1 * c) + (0.4 * t) + (0.4 * lag(d)) + rnorm(n, 0, sqrt(0.4582))\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eGenerating this data in a tidy \u003cstrong\u003edplyr\u003c/strong\u003e way is super tricky, since the \u003ccode\u003et\u003c/code\u003e and \u003ccode\u003ed\u003c/code\u003e columns are interdependent—the data has to be generated rowwise, but we also have to be able to look back a row to get the lagged values of \u003ccode\u003et\u003c/code\u003e and \u003ccode\u003ed\u003c/code\u003e. I’ve seen people like \u003ca href=\"#ref-BlackwellGlynn:2018\"\u003eBlackwell and Glynn\u003c/a\u003e (\u003ca href=\"#ref-BlackwellGlynn:2018\"\u003e2018\u003c/a\u003e) get around this by using a \u003ccode\u003efor\u003c/code\u003e loop to build the data, but I have an aversion to for loops in R \u003ca href=\"https://r4ds.had.co.nz/iteration.html#for-loops-vs.-functionals\"\u003esince \u003cstrong\u003epurrr\u003c/strong\u003e exists\u003c/a\u003e, so I spent way too much time trying to figure out a \u003cstrong\u003epurrr\u003c/strong\u003e-based way to do this. Others have tried this (like \u003ca href=\"https://community.rstudio.com/t/row-wise-iteration-in-a-dataframe-with-interdependent-variables/38778\"\u003ethis RStudio Community post\u003c/a\u003e), and I \u003ca href=\"https://twitter.com/andrewheiss/status/1347780639714664448\"\u003easked about it on Twitter\u003c/a\u003e, where I got a few cool solutions using \u003ccode\u003epurrr::accumulate()\u003c/code\u003e and \u003ccode\u003epurrr::reduce()\u003c/code\u003e, like \u003ca href=\"https://twitter.com/ianmoran011/status/1347849678696574977\"\u003ethis fancy \u003ccode\u003eaccumutate()\u003c/code\u003e function from Ian Moran\u003c/a\u003e and \u003ca href=\"https://gist.github.com/andrewheiss/89ae26a7a4682aff0ee9b7db1e92c326#gistcomment-3587810\"\u003ethese solutions from Miles McBain\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eThere are no loops involved in those solutions, but phew that accumulate/reduce syntax is wonky and I can’t fully wrap my head around it (plus it makes it hard to carry over non-accumulated variables). So I resorted to a loop. Oooof.\u003c/p\u003e\n\u003cp\u003eIt works, though! Let’s test it on just one ID. We’ll generate just one row with \u003ccode\u003et1\u003c/code\u003e, \u003ccode\u003et2\u003c/code\u003e, \u003ccode\u003ed1\u003c/code\u003e, and \u003ccode\u003ed2\u003c/code\u003e, and we’ll remove the noise from each of the columns:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eset.seed\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e12345\u003c/span\u003e)\nn \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Remove all noise so that we can compare this with the function version\u003c/span\u003e\ndf_example \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003en,\n                     c \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(t1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e c),\n         d1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e c) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e t1),\n         t2 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e c) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e d1) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e t1),\n         d2 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e c) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e t2) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e d1))\ndf_example\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 1 x 6\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##      id     c     t1     d1    t2    d2\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;int\u0026gt; \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1     1 0.586 0.0586 0.0820 0.115 0.137\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThis isn’t tidy data, so technically there are two years here. We’ll keep \u003ccode\u003et1\u003c/code\u003e and \u003ccode\u003ed1\u003c/code\u003e as the initial values for year 1, then generate values for 5 years. If we do this right, the \u003ccode\u003et\u003c/code\u003e and \u003ccode\u003ed\u003c/code\u003e values for year 2 should be identical to \u003ccode\u003et2\u003c/code\u003e and \u003ccode\u003ed2\u003c/code\u003e here.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Add a bunch of extra years with empty cells for t and d\u003c/span\u003e\ndf_multiple_years_empty \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e df_example \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(id, y, t \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e t1, d \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e d1, c) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eadd_row\u003c/span\u003e(y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# c doesn\u0026#39;t vary across time\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \n         c \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_example\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ec[1])\ndf_multiple_years_empty\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 5 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##      id     y       t       d     c\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;   \u0026lt;dbl\u0026gt;   \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1     1     1  0.0586  0.0820 0.586\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2     1     2 NA      NA      0.586\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3     1     3 NA      NA      0.586\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4     1     4 NA      NA      0.586\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5     1     5 NA      NA      0.586\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Now we need to build the interdependent values for t and d with \u0026lt;gasp\u0026gt; a loop\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# The loop is inside this function---it skips the initial row and then\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# iteratively adds new rows. We can\u0026#39;t use neat things like lag(t), so instead\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# we use df$t[i - 1]\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# We omit the extra noise for now\u003c/span\u003e\ndgp \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(df) {\n  \u003cspan style=\"color:#a6e22e\"\u003efor \u003c/span\u003e(i in \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003enrow\u003c/span\u003e(df)) {\n    df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et[i] \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ec[i]) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ed[i \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e]) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et[i \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e])\n    df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ed[i] \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ec[i]) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et[i]) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ed[i \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e])\n  }\n  \n  df\n}\n\n\u003cspan style=\"color:#75715e\"\u003e# Generate all 5 years\u003c/span\u003e\ndf_multiple_years_empty \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003edgp\u003c/span\u003e()\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 5 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##      id     y      t      d     c\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1     1     1 0.0586 0.0820 0.586\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2     1     2 0.115  0.137  0.586\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3     1     3 0.159  0.177  0.586\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4     1     4 0.193  0.207  0.586\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5     1     5 0.219  0.229  0.586\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIf this worked, the \u003ccode\u003et\u003c/code\u003e and \u003ccode\u003ed\u003c/code\u003e values for year 2 should be the same as \u003ccode\u003et2\u003c/code\u003e and \u003ccode\u003ed2\u003c/code\u003e here:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003edf_example\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 1 x 6\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##      id     c     t1     d1    t2    d2\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;int\u0026gt; \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1     1 0.586 0.0586 0.0820 0.115 0.137\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThey are!\u003c/p\u003e\n\u003cp\u003eSince we know it works, let’s generate a big dataset for playing with multi-year MSMs, this time with noise:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eset.seed\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1234\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Make data for the first year\u003c/span\u003e\ndf_first_year \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eexpand_grid\u003c/span\u003e(id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e2000\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(c \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003en\u003c/span\u003e(), \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e),\n         t \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e c) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003en\u003c/span\u003e(), \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.99\u003c/span\u003e)),\n         d \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e c) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e t) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003en\u003c/span\u003e(), \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.822\u003c/span\u003e)))\ndf_first_year\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 2,000 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##       id     y      c        t       d\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##    \u0026lt;int\u0026gt; \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt;   \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  1     1     1 -1.21  -1.09    -1.43  \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  2     2     1  0.277 -0.0714  -0.739 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  3     3     1  1.08  -0.00174 -0.0686\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  4     4     1 -2.35   0.952    1.88  \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  5     5     1  0.429 -1.60     0.0373\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  6     6     1  0.506 -0.990    0.535 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  7     7     1 -0.575 -1.79    -0.889 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  8     8     1 -0.547  0.456   -1.14  \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  9     9     1 -0.564 -0.500    0.386 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 10    10     1 -0.890 -1.92    -1.04  \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## # … with 1,990 more rows\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Add empty years 2-5\u003c/span\u003e\ndf_panel_empty \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e df_first_year \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003ebind_rows\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eexpand_grid\u003c/span\u003e(id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e2000\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003earrange\u003c/span\u003e(id, y)\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(df_panel_empty, \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 10 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##       id     y      c       t      d\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##    \u0026lt;int\u0026gt; \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;   \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  1     1     1 -1.21  -1.09   -1.43 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  2     1     2 NA     NA      NA    \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  3     1     3 NA     NA      NA    \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  4     1     4 NA     NA      NA    \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  5     1     5 NA     NA      NA    \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  6     2     1  0.277 -0.0714 -0.739\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  7     2     2 NA     NA      NA    \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  8     2     3 NA     NA      NA    \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  9     2     4 NA     NA      NA    \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 10     2     5 NA     NA      NA\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Add noise to the fancy dgp() function\u003c/span\u003e\ndgp \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(df) {\n  \u003cspan style=\"color:#a6e22e\"\u003efor \u003c/span\u003e(i in \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003enrow\u003c/span\u003e(df)) {\n    df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et[i] \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ec[i]) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ed[i \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e]) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et[i \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e]) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.5196\u003c/span\u003e))\n    df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ed[i] \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ec[i]) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et[i]) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ed[i \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e]) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.4582\u003c/span\u003e))\n  }\n  \n  df\n}\n\n\u003cspan style=\"color:#75715e\"\u003e# Run dgp() within each id\u003c/span\u003e\ndf_panel \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e df_panel_empty \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(id) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# This doesn\u0026#39;t vary with time, so repeat it across all the years\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(c \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e c[1]) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Nest the data into a single cell in each row\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003enest\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Run dgp() on the nested cell (in a column named \u0026#34;data\u0026#34;)\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(dgp \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(data, dgp)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003edata) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Unnest the nested dgp()-ed cells\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eunnest\u003c/span\u003e(dgp) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Add some lags\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eacross\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(t, d), \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(lag \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e lag))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eungroup\u003c/span\u003e()\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(df_panel, \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 10 x 7\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##       id     y      c       t      d   t_lag  d_lag\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##    \u0026lt;int\u0026gt; \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;   \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;   \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  1     1     1 -1.21  -1.09   -1.43  NA      NA    \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  2     1     2 -1.21  -1.11   -1.28  -1.09   -1.43 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  3     1     3 -1.21  -1.83   -1.35  -1.11   -1.28 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  4     1     4 -1.21  -1.62   -1.20  -1.83   -1.35 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  5     1     5 -1.21  -1.62   -0.981 -1.62   -1.20 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  6     2     1  0.277 -0.0714 -0.739 NA      NA    \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  7     2     2  0.277  1.09    0.116 -0.0714 -0.739\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  8     2     3  0.277  1.43    0.562  1.09    0.116\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  9     2     4  0.277  0.584  -0.606  1.43    0.562\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 10     2     5  0.277 -0.881   0.603  0.584  -0.606\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"multiple-period-marginal-structural-models\"\u003eMultiple-period marginal structural models\u003c/h3\u003e\n\u003cp\u003eCool cool cool. We have multi-period data where variables depend on their lagged values and other interdependent columns. Let’s build some MSMs!\u003c/p\u003e\n\u003cp\u003eWe’re going to build weights two different ways here. Because the data has a time-series cross-sectional structure (with multiple individuals across multiple years), the weight models need to account for that structure. Everywhere I’ve seen elsewhere uses generalized estimating equations (GEEs) for these models (and that’s what the \u003cstrong\u003eipw\u003c/strong\u003e package uses behind the scenes), but I’m a fan of multilevel models, so I’ll make weights with both to compare their results.\u003c/p\u003e\n\u003cp\u003eWe’ll use the same equation as before—the cumulative product of the ratio of two probability distributions:\u003c/p\u003e\n\u003cp\u003e$$\nw = \\prod^t_{t = 1} \\frac{\\phi(T_{it} | T_{i, t-1}, C_i)}{\\phi(T_{it} | T_{i, t-1}, D_{i, t-1}, C_i)}\n$$\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Again, ipw complains about missing values, so get rid of them (i.e. all year 1)\u003c/span\u003e\ndf_panel_sans_na \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e df_panel \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e!\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eis.na\u003c/span\u003e(t_lag)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eas.numeric\u003c/span\u003e(y))\n\n\u003cspan style=\"color:#75715e\"\u003e# Manually\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# Numerator is lagged treatment + non-varying confounders\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# ipw uses GEE models to account for panel structure, so use them here too\u003c/span\u003e\nmodel_num_gee \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(t \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e c, \n                        id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e id, waves \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, corstr \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ar1\u0026#34;\u003c/span\u003e,\n                        data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_panel_sans_na)\n\n\u003cspan style=\"color:#75715e\"\u003e# But we can also use mixed models with lmer\u003c/span\u003e\nmodel_num_multi \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elmer\u003c/span\u003e(t \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e c \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e id),\n                        data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_panel_sans_na)\n\n\u003cspan style=\"color:#75715e\"\u003e# Denominator is lagged treatment, lagged outcome, time-varying confounders +\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# non-varying confounders\u003c/span\u003e\nmodel_denom_gee \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(t \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e d_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e c, \n                          id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e id, waves \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, corstr \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ar1\u0026#34;\u003c/span\u003e,\n                          data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_panel_sans_na)\n\nmodel_denom_multi \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elmer\u003c/span\u003e(t \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e d_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e c \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e id),\n                          data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_panel_sans_na)\n\n\u003cspan style=\"color:#75715e\"\u003e# Probability distributions\u003c/span\u003e\nnum_gee \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(df_panel_sans_na\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et,\n             \u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(model_num_gee),\n             \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eresiduals\u003c/span\u003e(model_num_gee)))\n\nden_gee \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(df_panel_sans_na\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et,\n                 \u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(model_denom_gee),\n                 \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eresiduals\u003c/span\u003e(model_denom_gee)))\n\nnum_multi \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(df_panel_sans_na\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et,\n                   \u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(model_num_multi),\n                   \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eresiduals\u003c/span\u003e(model_num_multi)))\n\nden_multi \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(df_panel_sans_na\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et,\n                   \u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(model_denom_multi),\n                   \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eresiduals\u003c/span\u003e(model_denom_multi)))\n\ndf_panel_weights_manual \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e df_panel_sans_na \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(weights_no_time_gee \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e num_gee \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e den_gee,\n         weights_no_time_multi \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e num_multi \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e den_multi) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(id) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(ipw_gee \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecumprod\u003c/span\u003e(weights_no_time_gee),\n         ipw_multi \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecumprod\u003c/span\u003e(weights_no_time_multi)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eungroup\u003c/span\u003e()\n\n\u003cspan style=\"color:#75715e\"\u003e# Automatically with ipwtm()\u003c/span\u003e\npanel_weights_auto \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eipwtm\u003c/span\u003e(\n  exposure \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e t,\n  family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;gaussian\u0026#34;\u003c/span\u003e, \n  numerator \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e c, \n  denominator \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e d_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e c, \n  id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e id,\n  timevar \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y,\n  type \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;all\u0026#34;\u003c/span\u003e,\n  corstr \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ar1\u0026#34;\u003c/span\u003e,\n  data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eas.data.frame\u003c/span\u003e(df_panel_sans_na))\n\ndf_panel_weights_auto \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e df_panel_sans_na \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(ipw \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e panel_weights_auto\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eipw.weights)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNow we can build the outcome models, using both GEE and multilevel models.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003em_manual_gee \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(d \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t_lag, \n                       data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_panel_weights_manual,\n                       id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e id, waves \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, \n                       weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ipw_gee)\n\nm_auto_gee \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(d \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t_lag, \n                     data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_panel_weights_auto, \n                     id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e id, waves \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, \n                     weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ipw)\n\nm_lmer_manual_gee_wt \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elmer\u003c/span\u003e(d \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e id), \n                             data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_panel_weights_manual, \n                             weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ipw_gee)\n\nm_lmer_auto_gee_wt \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elmer\u003c/span\u003e(d \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e id), \n                           data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_panel_weights_auto, \n                           weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ipw)\n\nm_lmer_manual_multi_wt \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elmer\u003c/span\u003e(d \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e id), \n                               data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_panel_weights_manual, \n                               weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ipw_multi)\n\nresults \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etribble\u003c/span\u003e(\n  \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e`Method`, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e`Weights`, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003e`lag\u003c/span\u003e(T) effect`, ~`T effect`,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;True effect\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#66d9ef\"\u003eNA\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.160\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.400\u003c/span\u003e,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Panel with GEE\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Manual GEE weights\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(m_manual_gee), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t_lag\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(m_manual_gee), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Panel with GEE\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Automatic GEE weights\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(m_auto_gee), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t_lag\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(m_auto_gee), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Panel with multilevel model\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Manual GEE weights\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(m_lmer_manual_gee_wt), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t_lag\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(m_lmer_manual_gee_wt), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Panel with multilevel model\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Automatic GEE weights\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(m_lmer_auto_gee_wt), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t_lag\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(m_lmer_auto_gee_wt), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Panel with multilevel model\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Manual multilevel weights\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(m_lmer_manual_multi_wt), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t_lag\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(m_lmer_manual_multi_wt), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate\n)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ctable style=\"width:90%; margin-left: auto; margin-right: auto;\" class=\" pure-table pure-table-horizontal\"\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align:left;\"\u003e\nMethod\n\u003c/th\u003e\n\u003cth style=\"text-align:left;\"\u003e\nWeights\n\u003c/th\u003e\n\u003cth style=\"text-align:right;\"\u003e\nlag(T) effect\n\u003c/th\u003e\n\u003cth style=\"text-align:right;\"\u003e\nT effect\n\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nTrue effect\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n—\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.160\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.400\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nPanel with GEE\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nManual GEE weights\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.230\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.429\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nPanel with GEE\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nAutomatic GEE weights\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.230\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.429\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nPanel with multilevel model\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nManual GEE weights\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.195\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.408\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nPanel with multilevel model\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nAutomatic GEE weights\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.195\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.408\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nPanel with multilevel model\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nManual multilevel weights\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.196\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.414\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003ePhew.\u003c/p\u003e\n\u003cp\u003eAll of the models here are relatively close to the true effect for \u003ccode\u003e\\(T_t\\)\u003c/code\u003e! (Though they’re all sizably off for \u003ccode\u003e\\(T_{t-1}\\)\u003c/code\u003e, but I don’t know why).\u003c/p\u003e\n\u003cp\u003eImportantly, it seems that mixed models work just fine for both weights and outcome models, which means there’s probably no need to use GEE (and this can all be done Bayesianly with \u003ccode\u003ebrms()\u003c/code\u003e!).\u003c/p\u003e\n\u003cp\u003eIt works!\u003c/p\u003e\n\u003ch2 id=\"questions-for-the-future\"\u003eQuestions for the future\u003c/h2\u003e\n\u003cp\u003eI still have some lingering things to check (forthcoming in a future blog post):\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003ey\u003c/code\u003e isn’t any any of the models: weights numerator, weights denominator, or outcome. If I include it in any of the models, the there’s perfect fit. That may be because there are no time-varying confounders? I think year might need to be in there somewhere, but I’m not sure. \u003ca href=\"#ref-BlackwellGlynn:2018\"\u003eBlackwell and Glynn\u003c/a\u003e (\u003ca href=\"#ref-BlackwellGlynn:2018\"\u003e2018\u003c/a\u003e) include year in the numerator and denominator for weights in their Swank Steinmo replication, but not in their Burgoon replication.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThis example has no time-varying confounders. I need to see how this all works with those.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThis DAG for this example is pretty simple. I need to see what happens when there are \u003cem\u003ealso\u003c/em\u003e direct arrows from \u003ccode\u003e\\(T_{t-1} \\rightarrow T_{t}\\)\u003c/code\u003e and \u003ccode\u003e\\(D_{t-1} \\rightarrow D_{t}\\)\u003c/code\u003e.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003cdiv id=\"refs\" class=\"references csl-bib-body hanging-indent\"\u003e\n\u003cdiv id=\"ref-BlackwellGlynn:2018\" class=\"csl-entry\"\u003e\n\u003cp\u003eBlackwell, Matthew, and Adam N. Glynn. 2018. “How to Make Causal Inferences with Time-Series Cross-Sectional Data Under Selection on Observables.” \u003cem\u003eAmerican Political Science Review\u003c/em\u003e 112 (4): 1067–82. \u003ca href=\"https://doi.org/10.1017/s0003055418000357\"\u003ehttps://doi.org/10.1017/s0003055418000357\u003c/a\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv id=\"ref-ThoemmesOng:2016\" class=\"csl-entry\"\u003e\n\u003cp\u003eThoemmes, Felix, and Anthony D. Ong. 2016. “A Primer on Inverse Probability of Treatment Weighting and Marginal Structural Models.” \u003cem\u003eEmerging Adulthood\u003c/em\u003e 4 (1): 40–59. \u003ca href=\"https://doi.org/10.1177/2167696815621645\"\u003ehttps://doi.org/10.1177/2167696815621645\u003c/a\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n",
            "date_published": "2021-01-15T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2020/12/03/ipw-tscs-msm/",
            "url": "https://www.shagunjhaver.com/blog/2020/12/03/ipw-tscs-msm/",
            "title": "Generating inverse probability weights for marginal structural models with time-series cross-sectional panel data",
            "summary": "Use R to close backdoor confounding in panel data with marginal structural models and inverse probability weights for both binary and continuous treatments",
            "content_html": "\u003cp\u003eIn \u003ca href=\"/blog/2020/12/01/ipw-binary-continuous/\"\u003emy post on generating inverse probability weights for both binary and continuous treatments\u003c/a\u003e, I mentioned that I’d eventually need to figure out how to deal with more complex data structures and causal models where treatments, outcomes, and confounders vary over time. Instead of adjusting for DAG confounding with inverse probability weights, we need to use something called marginal structural models (MSMs) to make adjustments that account for treatment and outcome history and other time structures. This is complex stuff and social science hasn’t done much with it (but it’s been a common approach in epidemiology).\u003c/p\u003e\n\u003cp\u003eThis post is my first attempt at teaching myself how to do this stuff. As I note at the end in the \u003ca href=\"#important-caveats\"\u003ecaveats section\u003c/a\u003e, there might be (surely are!) mistakes. Please correct them!\u003c/p\u003e\n\u003ch2 id=\"contents----omit-in-toc---\"\u003eContents \u003c!-- omit in toc --\u003e\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#dags-and-time-series-cross-sectional-tscs-data\"\u003eDAGs and time-series cross-sectional (TSCS) data\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#marginal-structural-models\"\u003eMarginal structural models\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#simulated-time-series-cross-sectional-data\"\u003eSimulated time-series cross-sectional data\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#marginal-structural-model-with-a-binary-treatment\"\u003eMarginal structural model with a binary treatment\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#naive-estimate-without-weights\"\u003eNaive estimate without weights\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#manual-weights\"\u003eManual weights\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#weights-with-the-ipw-package\"\u003eWeights with the \u003cstrong\u003eipw\u003c/strong\u003e package\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#marginal-structural-model-with-a-continuous-treatment\"\u003eMarginal structural model with a continuous treatment\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#naive-estimate-without-weights-1\"\u003eNaive estimate without weights\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#manual-weights-1\"\u003eManual weights\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#weights-with-the-ipw-package-1\"\u003eWeights with the \u003cstrong\u003eipw\u003c/strong\u003e package\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#important-caveats\"\u003eImportant caveats!\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(lme4)  \u003cspan style=\"color:#75715e\"\u003e# For mixed models\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(fixest)  \u003cspan style=\"color:#75715e\"\u003e# For fixed effects models\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(broom)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(broom.mixed)  \u003cspan style=\"color:#75715e\"\u003e# For tidying mixed models\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(ggdag)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(dagitty)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(ipw)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"dags-and-time-series-cross-sectional-tscs-data\"\u003eDAGs and time-series cross-sectional (TSCS) data\u003c/h2\u003e\n\u003cp\u003eLet’s pretend that we’re interested in the causal effect of a policy in a country on a country’s happiness. We’ll work with two different policies: whether a country implements a 6-hour workday (like \u003ca href=\"https://www.forbes.com/sites/jackkelly/2020/01/08/finlands-prime-ministers-aspirational-goal-of-a-six-hour-four-day-workweek-will-this-ever-happen/?sh=79367a836384\"\u003eFinland has been considering\u003c/a\u003e), which is binary, and the number of mandated vacation days a country provides, which is continuous. Both the policy and national happiness are influenced and confounded by a few different variables: general country-specific trends, GDP per capita, level of democratization, and level of political corruption.\u003c/p\u003e\n\u003cp\u003eIn the absence of time, this causal model is fairly straightforward:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003esimple_dag \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edagify\u003c/span\u003e(happiness \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e policy \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e gdp_cap \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e democracy \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e corruption \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e country,\n                     policy \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e gdp_cap \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e democracy \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e corruption \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e country,\n                     coords \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(policy \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, happiness \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, gdp_cap \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, \n                                         democracy \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, corruption \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e, country \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e),\n                                   y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(policy \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, happiness \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, gdp_cap \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, \n                                         democracy \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3.3\u003c/span\u003e, corruption \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, country \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)),\n                     exposure \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;policy\u0026#34;\u003c/span\u003e,\n                     outcome \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;happiness\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#a6e22e\"\u003eggdag_status\u003c/span\u003e(simple_dag, text_col \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;black\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eguides\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_dag\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"/blog/2020/12/03/ipw-tscs-msm/index_files/figure-html/dag-simple-1.png\" width=\"75%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eIn a regular DAG setting, we can isolate the arrow between policy and happiness by statistically adjusting for all the nodes that open up backdoor relationships between them, or confound them. We can use \u003cem\u003edo\u003c/em\u003e-calculus logic for that, or we can use R:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eadjustmentSets\u003c/span\u003e(simple_dag)\n\u003cspan style=\"color:#75715e\"\u003e## { corruption, country, democracy, gdp_cap }\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAdjusting for the four confounders here is thus sufficient for closing all the backdoors and isolating the causal effect of the policy on national happiness. A standard approach to this kind of adjustment is inverse probability weighting, and I have \u003ca href=\"/blog/2020/12/01/ipw-binary-continuous/\"\u003ea whole post about how to do that with both binary and continuous treatments\u003c/a\u003e (as well as \u003ca href=\"/blog/2020/02/25/closing-backdoors-dags/\"\u003eanother post\u003c/a\u003e and \u003ca href=\"/research/chapters/heiss-causal-inference-2021/\"\u003ea textbook chapter\u003c/a\u003e with even more details and examples).\u003c/p\u003e\n\u003cp\u003eHowever, in reality, time also influences policies, happiness, and other confounders. The number of vacation days a country offers in 2019 depends a lot on the number of vacation days offered in 2018, and 2017, and 2016, and so on. Also, a country’s GDP, level of democracy, and level of corruption all depend on earlier values. Countries aren’t just getting random levels of democracy each year! Not all confounders vary with time—country remains the same every year, as do things like region and continent.\u003c/p\u003e\n\u003cp\u003eOn top of all that, happiness in a previous year could influence the policy in the current year. If a country has lower aggregate happiness in 2016, that could influences politicians’ choice to mandate a 6-hour workday or increase vacation days in 2017 or 2018.\u003c/p\u003e\n\u003cp\u003eWe need to incorporate time into our simple DAG. Because we’re adding a bunch more nodes, I’m going to collapse the time-varying confounders (GDP per capita, democracy, and corruption) and time-invariant confounders (just country here) into single separate nodes. To account for time, I add \u003ccode\u003e\\(t\\)\u003c/code\u003e subscripts: \u003ccode\u003e\\(t\\)\u003c/code\u003e represents the current year, \u003ccode\u003e\\(t - 1\\)\u003c/code\u003e (\u003ccode\u003et_m1\u003c/code\u003e in the graph) represents the previous year, \u003ccode\u003e\\(t - 2\\)\u003c/code\u003e represents two years earlier, and so on.\u003c/p\u003e\n\u003cp\u003eHere’s what this looks like:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003etime_dag \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edagify\u003c/span\u003e(happiness_t \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e policy_t \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e varying_confounders_t \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e happiness_tm1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e nonvarying_confounders,\n                   policy_t \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e varying_confounders_t \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e happiness_tm1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e policy_tm1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e nonvarying_confounders,\n                   varying_confounders_t \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e happiness_tm1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e varying_confounders_tm1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e nonvarying_confounders,\n                   happiness_tm1 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e policy_tm1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e varying_confounders_tm1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e nonvarying_confounders,\n                   policy_tm1 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e varying_confounders_tm1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e nonvarying_confounders,\n                   varying_confounders_tm1 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e nonvarying_confounders,\n                   coords \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(happiness_t \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e, policy_t \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, varying_confounders_t \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, \n                                       happiness_tm1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, policy_tm1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, varying_confounders_tm1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e,\n                                       nonvarying_confounders \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2.5\u003c/span\u003e),\n                                 y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(happiness_t \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, policy_t \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, varying_confounders_t \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e, \n                                       happiness_tm1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, policy_tm1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, varying_confounders_tm1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e,\n                                       nonvarying_confounders \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)),\n                   exposure \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;policy_t\u0026#34;\u003c/span\u003e,\n                   outcome \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;happiness_t\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#a6e22e\"\u003eggdag_status\u003c/span\u003e(time_dag, text_col \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;black\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eguides\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_dag\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"/blog/2020/12/03/ipw-tscs-msm/index_files/figure-html/dag-complex-1.png\" width=\"100%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003ePhew. That’s bananas. And that’s just for one time period. Technically there are also nodes from \u003ccode\u003e\\(t - 2\\)\u003c/code\u003e and \u003ccode\u003e\\(t - 3\\)\u003c/code\u003e and so on that influence \u003ccode\u003e\\(t - 1\\)\u003c/code\u003e. Figure 2 from \u003ca href=\"#ref-BlackwellGlynn:2018\"\u003eBlackwell and Glynn\u003c/a\u003e (\u003ca href=\"#ref-BlackwellGlynn:2018\"\u003e2018\u003c/a\u003e) shows a similar structure with previous time periods (though they don’t have an arrow from \u003ccode\u003e\\(Y_{t-1}\\)\u003c/code\u003e to \u003ccode\u003e\\(Y\\)\u003c/code\u003e):\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"blackwell-glynn-fig-2.png\" alt=\"Figure 2 from Blackwell and Glynn (2018)\"\u003e\u003c/p\u003e\n\u003cp\u003eAll we care about in this situation is the single arrow between \u003ccode\u003epolicy_t\u003c/code\u003e and \u003ccode\u003ehappiness_t\u003c/code\u003e. (There are ways of looking at other arrows, like the effect of \u003ccode\u003epolicy_tm1\u003c/code\u003e on \u003ccode\u003ehappiness_t\u003c/code\u003e, but we won’t try to measure those here. \u003ca href=\"#ref-BlackwellGlynn:2018\"\u003eBlackwell and Glynn\u003c/a\u003e (\u003ca href=\"#ref-BlackwellGlynn:2018\"\u003e2018\u003c/a\u003e) show how to do that.)\u003c/p\u003e\n\u003cp\u003eWe can use \u003cem\u003edo\u003c/em\u003e-calculus logic to see what nodes need to be adjusted for to isolate that arrow:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eadjustmentSets\u003c/span\u003e(time_dag)\n\u003cspan style=\"color:#75715e\"\u003e## { happiness_tm1, nonvarying_confounders, varying_confounders_t }\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAccording to this, we should adjust for time variant confounders in the current year, happiness in the previous year, and nonvarying confounders like country. \u003cem\u003eHowever\u003c/em\u003e, this won’t be completely accurate because the previous history matters. In general, situations where treatments, confounders, and outcomes vary over time, adjustment approaches like inverse probability weighting will be biased and incorrect.\u003c/p\u003e\n\u003ch2 id=\"marginal-structural-models\"\u003eMarginal structural models\u003c/h2\u003e\n\u003cp\u003eTo account for this time structure, we can instead use something called marginal structural models (MSMs) to make DAG adjustments. These have been used widely in epidemiology, and there are some really great and accessible overviews of the method here:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eChapter 12 in \u003ca href=\"https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/\"\u003eMiguel A. Hernán and James M. Robins, \u003cem\u003eCausal Inference: What If\u003c/em\u003e\u003c/a\u003e (\u003ca href=\"#ref-HernanRobins:2020\"\u003eHernán and Robins 2020\u003c/a\u003e)\u003c/li\u003e\n\u003cli\u003eFelix Thoemmes and Anthony D. Ong, “A Primer on Inverse Probability of Treatment Weighting and Marginal Structural Models” (\u003ca href=\"#ref-ThoemmesOng:2016\"\u003eThoemmes and Ong 2016\u003c/a\u003e)\u003c/li\u003e\n\u003cli\u003eStephen R. Cole and Miguel A. Hernán, “Constructing Inverse Probability Weights for Marginal Structural Models” (\u003ca href=\"#ref-ColeHernan:2008\"\u003eCole and Hernán 2008\u003c/a\u003e)\u003c/li\u003e\n\u003cli\u003eKosuke Imai and Marc Ratkovic, “Robust Estimation of Inverse Probability Weights for Marginal Structural Models” (\u003ca href=\"#ref-ImaiRatkovic:2015\"\u003eImai and Ratkovic 2015\u003c/a\u003e)\u003c/li\u003e\n\u003cli\u003eJames M. Robins, Miguel Ángel Hernán, and Babette Brumback, “Marginal Structural Models and Causal Inference in Epidemiology” (\u003ca href=\"#ref-RobinsHernanBrumback:2000\"\u003eRobins, Hernán, and Brumback 2000\u003c/a\u003e)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eIn my world of public policy and political science, though, MSMs are far rarer, even though \u003cem\u003e\u003cstrong\u003etons of the data we use\u003c/strong\u003e\u003c/em\u003e is time-series cross-sectional (TSCS) data, or panel data where each row represents a country and year (e.g. row 1 is Afghanistan in 2008, row 2 is Afghanistan in 2009, etc.) or state and year (e.g. Alabama 2015, Alabama 2016, etc.). The only paper I’ve really seen that uses MSMs in the political science world is \u003ca href=\"#ref-BlackwellGlynn:2018\"\u003eBlackwell and Glynn\u003c/a\u003e (\u003ca href=\"#ref-BlackwellGlynn:2018\"\u003e2018\u003c/a\u003e), which is an introduction to the topic and a call for using them more:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eMatthew Blackwell and Adam N. Glynn, “How to Make Causal Inferences with Time-Series Cross-Sectional Data under Selection on Observables,” (\u003ca href=\"#ref-BlackwellGlynn:2018\"\u003eBlackwell and Glynn 2018\u003c/a\u003e)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe basic intuition behind MSMs is similar to \u003ca href=\"blog/2020/12/01/ipw-binary-continuous/\"\u003esimpler inverse probability weighting\u003c/a\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eCalculate weights using confounders and the time structure\u003c/li\u003e\n\u003cli\u003eCalculate the average treatment effect using the weights and the time structure\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThe formula for calculating weights differs depending on if the treatment is binary or continuous, and they’re written slightly differently across those different resources listed above.\u003c/p\u003e\n\u003cp\u003eHere’s my version of how to calculate stabilized inverse probability weights with a binary treatment:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$\\text{Binary stabilized IPW}_{it} = \\prod^t_{t = 1} \\frac{P[X_{it} | \\bar{X}_{i, t-1}, V_i]}{P[X_{it} | \\bar{X}_{i, t-1}, Y_{i, t-1}, C_{it}, V_i]}$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eThere are a ton of variables in this equation. Let’s go through them one at a time:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e\\(i\\)\u003c/code\u003e stands for an individual (person, country, etc.)\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e\\(t\\)\u003c/code\u003e stands for a time period (year, month, day, etc.)\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e\\(X\\)\u003c/code\u003e stands for the observed treatment status; \u003ccode\u003e\\(X_{it}\\)\u003c/code\u003e stands for the observed treatment status of an individual at a given time. This is often written more specifically as \u003ccode\u003e\\(X_{it} = x_{it}\\)\u003c/code\u003e (see equation 1 in p. 46 in \u003ca href=\"#ref-ThoemmesOng:2016\"\u003eThoemmes and Ong\u003c/a\u003e (\u003ca href=\"#ref-ThoemmesOng:2016\"\u003e2016\u003c/a\u003e), and \u003ca href=\"https://rpubs.com/mbounthavong/IPTW_MSM_Tutorial\"\u003ethe equation at the beginning of this tutorial here\u003c/a\u003e, for instance), but for simplicity I’ll just write it as \u003ccode\u003e\\(X_{it}\\)\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e\\(\\bar{X}\\)\u003c/code\u003e stands for the individual’s history of treatment assignment (e.g. all \u003ccode\u003e\\(X\\)\u003c/code\u003e values in previous time periods)\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e\\(Y\\)\u003c/code\u003e stands for the outcome; \u003ccode\u003e\\(Y_{it}\\)\u003c/code\u003e stands for the outcome of an individual at a given time.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e\\(C\\)\u003c/code\u003e stands for time \u003cem\u003evarying\u003c/em\u003e confounders; because these change over time, \u003ccode\u003e\\(C\\)\u003c/code\u003e gets a \u003ccode\u003e\\(t\\)\u003c/code\u003e subscript: \u003ccode\u003e\\(C_{it}\\)\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e\\(V\\)\u003c/code\u003e stands for time \u003cem\u003einvarying\u003c/em\u003e confounders; that’s why there’s no \u003ccode\u003e\\(t\\)\u003c/code\u003e in \u003ccode\u003e\\(V_i\\)\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eFinally \u003ccode\u003e\\(P[\\cdot]\\)\u003c/code\u003e stands for the probability distribution\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eHere’s a more human explanation:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eThe numerator contains the probability of the observed treatment status ($X$) at each time given the previous history of treatment ($\\bar{X}$) and time \u003cem\u003einvariant\u003c/em\u003e confounders ($V_i$)\u003c/li\u003e\n\u003cli\u003eThe denominator contains the probability of the observed treatment status ($X$) at each time given the previous history of treatment ($\\bar{X}$), previous outcomes ($Y_{i, t-1}$), time *varying* confounders ($C_{it}$) and time *invariant* confounders ($V_i$). The previous outcomes part ($Y_{i, t-1}$) is optional; if you think that the outcome’s previous values influence current values, and the DAG shows an arrow from \u003ccode\u003e\\(Y_{t-1}\\)\u003c/code\u003e and \u003ccode\u003e\\(Y_t\\)\u003c/code\u003e, include it.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eImportantly, time varying confounders ($C_{it}$) are included in the denominator only, not the numerator. The lagged outcome ($Y_{i, t-1}$), if used, also only goes in the denominator.\u003c/p\u003e\n\u003cp\u003eTechnically the numerator can just be 1 instead of the whole \u003ccode\u003e\\(P[\\cdot]\\)\u003c/code\u003e thing, but that creates unstable weights. Using \u003ccode\u003e\\(P[\\cdot]\\)\u003c/code\u003e in the numerator creates stabilized weights.\u003c/p\u003e\n\u003cp\u003eThe equation for continuous weights looks really similar:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$\\text{Continuous stabilized IPW}_{it} = \\prod^t_{t = 1} \\frac{f_{X | \\bar{X}, V}[(X_{it} | \\bar{X}_{i, t-1}, V_i); \\mu_1, \\sigma^2_1]}{f_{X | \\bar{X}, Y, C, V}[(X_{it} | \\bar{X}_{i, t-1}, Y_{i, t-1}, C_{it}, V_i), \\mu_2, \\sigma^2_2]}$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eYikes. This is looks really complicated (and it is!), but again we can separate it into individual parts:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e\\(X\\)\u003c/code\u003e, \u003ccode\u003e\\(Y\\)\u003c/code\u003e, \u003ccode\u003e\\(V\\)\u003c/code\u003e, \u003ccode\u003e\\(C\\)\u003c/code\u003e, \u003ccode\u003e\\(i\\)\u003c/code\u003e, and \u003ccode\u003e\\(t\\)\u003c/code\u003e are all the same as the binary version of the formula\u003c/li\u003e\n\u003cli\u003eThe numerator is still the treatment, treatment history, and time invariant confounders\u003c/li\u003e\n\u003cli\u003eThe denominator is still the treatment, treatment history, previous outcome, time varying confounders, and time invariant confounders\u003c/li\u003e\n\u003cli\u003eThe \u003ccode\u003e\\(f_{\\cdot}(\\cdot)\\)\u003c/code\u003e functions are new and stand for a probability density function with a mean of \u003ccode\u003e\\(\\mu\\)\u003c/code\u003e and a variance of \u003ccode\u003e\\(\\sigma^2\\)\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThat’s a ton of information and it’s all really abstract. Let’s try this out with some simulated data\u003c/p\u003e\n\u003ch2 id=\"simulated-time-series-cross-sectional-data\"\u003eSimulated time-series cross-sectional data\u003c/h2\u003e\n\u003cp\u003eFor this example, we’ll use some data I generated with the \u003cstrong\u003efabricatr\u003c/strong\u003e package, which makes it really easy to build multilevel and nested structures like country- and year-level variables. The actual code to generate this is a little long, mostly because it’s heavily annotated and has a ton of intermediate variables. You can download the data here if you want to follow along with the rest of the code:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"happiness_data.csv\"\u003e\u003ci class=\"fas fa-file-csv\"\u003e\u003c/i\u003e \u003ccode\u003ehappiness_data.csv\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"happiness_simulation.R\"\u003e\u003ci class=\"fab fa-r-project\"\u003e\u003c/i\u003e \u003ccode\u003ehappiness_simulation.R\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eIt contains a bunch of different columns:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003ecountry\u003c/code\u003e: The country name (generated as a pronouncable 5-letter sequence (\u003ca href=\"https://arxiv.org/html/0901.4016\"\u003eproquint\u003c/a\u003e) with the \u003ca href=\"https://reside-ic.github.io/ids/\"\u003e\u003cstrong\u003eids\u003c/strong\u003e package\u003c/a\u003e)\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eyear\u003c/code\u003e: The year\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003evacation_days\u003c/code\u003e: The number of mandated vacation days. This is a treatment variable.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003epolicy\u003c/code\u003e: An indicator for whether a country has passed a policy that mandates a 6-hour workday. This is another treatment variable\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ehappiness_vacation\u003c/code\u003e: The level of happiness in a country, on a scale of 1–100 (more happiness = higher values). This is the outcome when using \u003ccode\u003evacation_days\u003c/code\u003e as the treatment.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ehappiness_policy\u003c/code\u003e: The level of happiness in a country. This is the outcome when using \u003ccode\u003epolicy\u003c/code\u003e as the treatment.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003elog_populuation\u003c/code\u003e: Logged population\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003elog_gdp\u003c/code\u003e: Logged GDP\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003egdp\u003c/code\u003e: GDP\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003epopulation\u003c/code\u003e: Population\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003egdp_cap\u003c/code\u003e: GDP per capita\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003elog_gdp_cap\u003c/code\u003e: Logged GDP per capita\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003edemocracy\u003c/code\u003e: The country’s level of democracy, on a scale of 1–100 (more democratic = higher values)\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ecorruption\u003c/code\u003e: The level of political corruption in a country, on a scale of 1–100 (more corrupt = higher values)\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003elag_*\u003c/code\u003e: Lagged versions of a bunch of different columns\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eAnd here’s what the actual data looks like:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ehappiness_data \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eread_csv\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;happiness_data.csv\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#a6e22e\"\u003eglimpse\u003c/span\u003e(happiness_data)\n\u003cspan style=\"color:#75715e\"\u003e## Rows: 1,520\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Columns: 18\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ country                \u0026lt;chr\u0026gt; \u0026#34;Mimim\u0026#34;, \u0026#34;Mimim\u0026#34;, \u0026#34;Mimim\u0026#34;, \u0026#34;Mimim\u0026#34;, \u0026#34;Mimim\u0026#34;, \u0026#34;Mimim\u0026#34;, \u0026#34;M…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ year                   \u0026lt;dbl\u0026gt; 2010, 2011, 2012, 2013, 2014, 2015, 2016, 2017, 2018, 20…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ vacation_days          \u0026lt;dbl\u0026gt; 12, 14, 16, 17, 18, 20, 21, 22, 24, 25, 9, 11, 13, 14, 1…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ policy                 \u0026lt;dbl\u0026gt; 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 1, 1, 1,…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ happiness_vacation     \u0026lt;dbl\u0026gt; 43.2, 45.1, 52.7, 52.7, 53.5, 61.4, 63.1, 66.1, 71.4, 73…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ happiness_policy       \u0026lt;dbl\u0026gt; 36.9, 40.6, 44.3, 46.3, 54.3, 58.4, 54.7, 59.1, 67.6, 59…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ log_population         \u0026lt;dbl\u0026gt; 17.4, 17.4, 17.5, 17.5, 17.6, 17.6, 17.7, 17.7, 17.8, 17…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ log_gdp                \u0026lt;dbl\u0026gt; 23.1, 23.2, 23.3, 23.4, 23.5, 23.6, 23.7, 23.8, 23.9, 24…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ gdp                    \u0026lt;dbl\u0026gt; 1.06e+10, 1.18e+10, 1.27e+10, 1.48e+10, 1.57e+10, 1.78e+…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ population             \u0026lt;dbl\u0026gt; 36049651, 37745007, 39520093, 41378659, 43324629, 453621…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ gdp_cap                \u0026lt;dbl\u0026gt; 293, 313, 321, 358, 361, 392, 434, 446, 483, 528, 5750, …\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ log_gdp_cap            \u0026lt;dbl\u0026gt; 5.68, 5.74, 5.77, 5.88, 5.89, 5.97, 6.07, 6.10, 6.18, 6.…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ democracy              \u0026lt;dbl\u0026gt; 56.9, 59.8, 77.5, 71.0, 76.2, 83.1, 87.3, 92.2, 100.0, 9…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ corruption             \u0026lt;dbl\u0026gt; 63.4, 62.9, 62.0, 60.7, 61.9, 60.4, 60.4, 57.9, 58.0, 58…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ lag_policy             \u0026lt;dbl\u0026gt; 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0, 1, 1, 1, 1, 1, 1, 1,…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ lag_happiness_policy   \u0026lt;dbl\u0026gt; 36.8, 36.9, 40.6, 44.3, 46.3, 54.3, 58.4, 54.7, 59.1, 67…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ lag_vacation_days      \u0026lt;dbl\u0026gt; 12, 12, 14, 16, 17, 18, 20, 21, 22, 24, 9, 9, 11, 13, 14…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ lag_happiness_vacation \u0026lt;dbl\u0026gt; 41.5, 43.2, 45.1, 52.7, 52.7, 53.5, 61.4, 63.1, 66.1, 71…\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe’ll use this data explore two different questions:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003cstrong\u003eBinary treatment: What is the effect of a 6-hour workday policy on national happiness?\u003c/strong\u003e\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eContinuous treatment: What is the effect of the number of mandated vacation days on national happiness?\u003c/strong\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"marginal-structural-model-with-a-binary-treatment\"\u003eMarginal structural model with a binary treatment\u003c/h2\u003e\n\u003cp\u003eBefore we do anything with the binary treatment, we need to filter the data a little. Because of the nature of the data, some of the fake countries never implement the policy and have all 0s in the \u003ccode\u003epolicy\u003c/code\u003e column. Weird things happen with the math of logistic regression if there are countries that have all 0s or all 1s for the outcome, since it’s technically impossible to predict their outcomes. That’s why \u003ca href=\"https://vuorre.netlify.app/post/2019/02/18/analyze-analog-scale-ratings-with-zero-one-inflated-beta-models/\"\u003ezero-one inflated beta (ZOIB) models or hurdle models\u003c/a\u003e are a thing—they’re two step models that first model if you do the policy at all, then model the probability of the policy if it does happen. Rather than deal with ZOIB stuff here, I made it so that all countries start with 0 for the policy (i.e. no country has the policy in the first year), and then here we filter out any countries that don’t ever implement the policy.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ehappiness_binary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e happiness_data \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(country) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(never_policy \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eall\u003c/span\u003e(policy \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eungroup\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e!\u003c/span\u003enever_policy)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"naive-estimate-without-weights\"\u003eNaive estimate without weights\u003c/h3\u003e\n\u003cp\u003eBefore playing with MSMs, let’s look at what the effect of the policy is on happiness without doing any inverse probability weighting for DAG adjustment. This is what most political science and international relations and public policy papers do. This is what I did in my dissertation and what I’ve done in a bunch of working papers. The wrongness of this approach is why I’m writing this post :)\u003c/p\u003e\n\u003cp\u003eThis is just a regular linear regression model. I could run it with \u003ccode\u003elm()\u003c/code\u003e, but then a ton of country and year coefficients would be included by default in the results, so I use \u003ccode\u003efeols()\u003c/code\u003e from the delightful \u003cstrong\u003efixest\u003c/strong\u003e package to include country and year as fixed effects. The results from \u003ccode\u003efeols()\u003c/code\u003e and \u003ccode\u003elm()\u003c/code\u003e are identical here; \u003ccode\u003efeols()\u003c/code\u003e is cleaner and faster.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emodel_naive \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efeols\u003c/span\u003e(happiness_policy \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e policy \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e log_gdp_cap \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e democracy \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n                       corruption \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e lag_happiness_policy \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e lag_policy \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e country \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e year,\n                data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e happiness_binary)\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_naive)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term                 estimate std.error statistic  p.value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;                   \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 policy                  6.76     0.397      17.0  1.90e-58\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 log_gdp_cap             3.80     1.85        2.05 4.07e- 2\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 democracy               0.146    0.0218      6.71 3.01e-11\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4 corruption             -0.158    0.0252     -6.26 5.31e-10\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5 lag_happiness_policy    0.172    0.0449      3.82 1.40e- 4\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6 lag_policy             -1.54     0.511      -3.01 2.66e- 3\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAccording to this, implementing a 6-hour workday is associated with a 6.8-point increase in national happiness. This is wrong though! We need to generate and use time-adjusted inverse probability weights to adjust for these confounders.\u003c/p\u003e\n\u003ch3 id=\"manual-weights\"\u003eManual weights\u003c/h3\u003e\n\u003cp\u003eWe’ll follow this formula to use confounders and previous treatments and outcomes to generate stabilized weights:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$\\text{Binary stabilized IPW}_{it} = \\prod^t_{t = 1} \\frac{P[X_{it} | \\bar{X}_{i, t-1}, V_i]}{P[X_{it} | \\bar{X}_{i, t-1}, Y_{i, t-1}, C_{it}, V_i]}$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eThe numerator predicts the treatment using the previous treatment and time invariant confounders. We’ll use logistic regression here, but I’m like 90% sure you can do fancier things like multilevel models or machine learning or Bayes stuff:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emodel_num \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eglm\u003c/span\u003e(policy \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e lag_policy \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e country, \n                 data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e happiness_binary, family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ebinomial\u003c/span\u003e(link \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;logit\u0026#34;\u003c/span\u003e))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe denominator predicts the treatment using time-varying confounders, previous outcome, previous treatment, and time invariant confounders. Again we’ll use logistic regression here, but you can probably do fancier stuff too:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# There\u0026#39;s a warning that fitted probabiltiies of 0 or 1 occurred, likely because\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# my data is too perfect. Oh well---we\u0026#39;ll live with it.\u003c/span\u003e\nmodel_denom \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eglm\u003c/span\u003e(policy \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e log_gdp_cap \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e democracy \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e corruption \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n                     lag_happiness_policy \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e lag_policy \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e country, \n                   data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e happiness_binary, family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ebinomial\u003c/span\u003e(link \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;logit\u0026#34;\u003c/span\u003e))\n\n\u003cspan style=\"color:#75715e\"\u003e# This also works if you use fixest::feglm() for country fixed effects\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# model_denom \u0026lt;- feglm(policy ~ log_gdp_cap + democracy + corruption +\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#                        lag_happiness_policy + lag_policy | country,\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#                      data = happiness_binary, family = binomial(link = \u0026#34;logit\u0026#34;))\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFinally we need to use the results from the numerator and denominator to construct the weights following the equation:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ehappiness_binary_weights \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e happiness_binary \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Propensity scores from the models\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(propensity_num \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e model_num\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003efitted.values,\n         propensity_denom \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e model_denom\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003efitted.values) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Probability of observed outcome\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(propensity_num_outcome \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eifelse\u003c/span\u003e(policy \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, propensity_num, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e propensity_num),\n         propensity_denom_outcome \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eifelse\u003c/span\u003e(policy \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, propensity_denom, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e propensity_denom)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Numerator / denominator\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(weights_no_time \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e propensity_num_outcome \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e propensity_denom_outcome) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Calculate the cumulative product of the weights within each country\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(country) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(ipw \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecumprod\u003c/span\u003e(weights_no_time)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eungroup\u003c/span\u003e()\n\nhappiness_binary_weights \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(country, year, policy, happiness_policy, ipw) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e()\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   country  year policy happiness_policy   ipw\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;   \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;            \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 Mimim    2010      0             36.9 0.800\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 Mimim    2011      0             40.6 0.640\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 Mimim    2012      0             44.3 0.516\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4 Mimim    2013      0             46.3 0.486\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5 Mimim    2014      1             54.3 0.116\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6 Mimim    2015      1             58.4 0.116\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFinally we’ll use those weights in a regression model to estimate the average treatment effect (ATE) of the policy on happiness. We need to use a model that accounts for the year and country panel structure for this. In every tutorial I’ve seen online, people use \u003ccode\u003egeeglm()\u003c/code\u003e from the \u003ca href=\"https://cran.r-project.org/package=geepack\"\u003e\u003cstrong\u003egeepack\u003c/strong\u003e package\u003c/a\u003e, which lets you specify country and year dimensions in generalized estimating equations. These feel an awful lot like mixed models with random country/year effects. There’s some useful discussion and useful links about the differences between GEE models and multilevel models \u003ca href=\"https://twitter.com/andrewheiss/status/1317634713935380480\"\u003ein this Twitter thread here\u003c/a\u003e. For the sake of this example, I’ll use multilevel models since I’m more familiar with them, and because you can build Bayesian ones with the \u003ca href=\"https://paul-buerkner.github.io/brms/\"\u003e\u003cstrong\u003ebrms\u003c/strong\u003e package\u003c/a\u003e; I have yet to find a Bayesian flavor of GEEs.\u003c/p\u003e\n\u003cp\u003eIn the outcome model, we include the previous treatment history and the invariant confounders (\u003ccode\u003ecountry\u003c/code\u003e, which I include as a random effect). To account for the time structure in the data, I also include a year random effect.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emodel_ate_binary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elmer\u003c/span\u003e(happiness_policy \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e policy \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e lag_policy \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n                           (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e country) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e year), \n                  data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e happiness_binary_weights, weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ipw)\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_ate_binary, effects \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;fixed\u0026#34;\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 3 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   effect term        estimate std.error statistic\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;  \u0026lt;chr\u0026gt;          \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 fixed  (Intercept)    51.9      1.26      41.2 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 fixed  policy          7.64     0.510     15.0 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 fixed  lag_policy     -1.30     0.448     -2.91\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eVoila! After adjusting for time-varying confounders and previous treatment history, the 6-hour workday policy \u003cem\u003ecauses\u003c/em\u003e an increase of 7.6 happiness points, on average. This is actually the effect that I built into the data. It worked!\u003c/p\u003e\n\u003cp\u003eHowever, I’m still not 100% confident that it did work. There are a lot of different moving parts here, and I’m not sure I have the right covariates in the right place (like in the outcome model, I’m fairly certain the model should be \u003ccode\u003ehappiness_policy ~ policy + lag_policy\u003c/code\u003e, but I’m not sure).\u003c/p\u003e\n\u003cp\u003eAlso the standard errors in this outcome model are wrong and have to be adjusted, either with fancy math or with bootstrapping (\u003ca href=\"#ref-BlackwellGlynn:2018\"\u003eBlackwell and Glynn\u003c/a\u003e (\u003ca href=\"#ref-BlackwellGlynn:2018\"\u003e2018\u003c/a\u003e) use boostrapping).\u003c/p\u003e\n\u003cp\u003eBut still, this is really neat.\u003c/p\u003e\n\u003ch3 id=\"weights-with-the-ipw-package\"\u003eWeights with the \u003cstrong\u003eipw\u003c/strong\u003e package\u003c/h3\u003e\n\u003cp\u003eInstead of manually doing all the math to generate the weights, we can use the \u003ccode\u003eipwtm()\u003c/code\u003e function from the \u003ca href=\"https://cran.r-project.org/package=ipw\"\u003e\u003cstrong\u003eipw\u003c/strong\u003e package\u003c/a\u003e to do it for us. We still specify a numerator and denominator, but the function takes care of the rest of the math. The numbers are the same.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# ipwtm() can\u0026#39;t handle tibbles! Force the data to be a data.frame\u003c/span\u003e\nweights_binary_ipw \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eipwtm\u003c/span\u003e(\n  exposure \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e policy,\n  family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;binomial\u0026#34;\u003c/span\u003e,\n  link \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;logit\u0026#34;\u003c/span\u003e,\n  \u003cspan style=\"color:#75715e\"\u003e# Time invariant stuff\u003c/span\u003e\n  numerator \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e lag_policy \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e country,\n  \u003cspan style=\"color:#75715e\"\u003e# All confounders\u003c/span\u003e\n  denominator \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e log_gdp_cap \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e democracy \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e corruption \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n    lag_happiness_policy \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e lag_policy \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e country,\n  id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e country,\n  timevar \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e year,\n  type \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;all\u0026#34;\u003c/span\u003e,\n  data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eas.data.frame\u003c/span\u003e(happiness_binary)\n)\n\n\u003cspan style=\"color:#75715e\"\u003e# They\u0026#39;re the same!\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(weights_binary_ipw\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eipw.weights)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 0.800 0.640 0.516 0.486 0.116 0.116\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(happiness_binary_weights\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eipw)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 0.800 0.640 0.516 0.486 0.116 0.116\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThis \u003ccode\u003eweights_binary_ipw\u003c/code\u003e object contains a bunch of other information too, but all we really care about here is what’s in the \u003ccode\u003eipw.weights\u003c/code\u003e slot. We can add those weights as a column in a dataset and run the outcome model, which will give us the same ATE as before (unsurprisingly, since they’re identical). Technically we don’t need to add a new column with the weights—the model will work if they’re a standalone vector—but I don’t like mixing data frames and standalone vectors and prefer to keep everything in one nice object.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ehappiness_binary_ipw \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e happiness_binary \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(ipw \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e weights_binary_ipw\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eipw.weights)\n\nmodel_ate_binary_ipw \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elmer\u003c/span\u003e(happiness_policy \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e policy \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e lag_policy \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n                               (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e country) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e year), \n                             data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e happiness_binary_ipw, weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ipw)\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_ate_binary_ipw, effects \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;fixed\u0026#34;\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 3 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   effect term        estimate std.error statistic\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;  \u0026lt;chr\u0026gt;          \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 fixed  (Intercept)    51.9      1.26      41.2 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 fixed  policy          7.64     0.510     15.0 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 fixed  lag_policy     -1.30     0.448     -2.91\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"marginal-structural-model-with-a-continuous-treatment\"\u003eMarginal structural model with a continuous treatment\u003c/h2\u003e\n\u003cp\u003eHere our main question is what the causal effect of mandated vacation time is on national happiness. This treatment is continuous—days of vacation. We don’t need to worry about having all 1s or all 0s and worry about zero-one inflated models or anything, since the treatment varies a lot across all countries and years.\u003c/p\u003e\n\u003ch3 id=\"naive-estimate-without-weights-1\"\u003eNaive estimate without weights\u003c/h3\u003e\n\u003cp\u003eAs before, we’ll look at the effect of vacation time is on happiness without any weights. Again, this is the approach in like a billion political science papers.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emodel_naive \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efeols\u003c/span\u003e(happiness_vacation \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e vacation_days \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e log_gdp_cap \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e democracy \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n                       corruption \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e lag_happiness_vacation \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e lag_vacation_days \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e country \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e year,\n                data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e happiness_data)\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_naive)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term                   estimate std.error statistic  p.value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;                     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 vacation_days            2.12      0.129      16.4  1.85e-55\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 log_gdp_cap              1.35      0.226       5.98 2.83e- 9\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 democracy                0.0516    0.0156      3.31 9.63e- 4\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4 corruption              -0.0624    0.0224     -2.78 5.48e- 3\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5 lag_happiness_vacation   0.559     0.148       3.76 1.74e- 4\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6 lag_vacation_days       -1.35      0.382      -3.54 4.13e- 4\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eHere we see that an additional day of vacation is associated with a 2.1-point increase in national happiness. Once again, this is wrong and biased, since there’s no weighting adjustment that deals with time-based confounding.\u003c/p\u003e\n\u003ch3 id=\"manual-weights-1\"\u003eManual weights\u003c/h3\u003e\n\u003cp\u003eWe’ll follow the formula for continuous stabilized weights:\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003e$$\\text{Continuous stabilized IPW}_{it} = \\prod^t_{t = 1} \\frac{f_{X | \\bar{X}, V}[(X_{it} | \\bar{X}_{i, t-1}, V_i); \\mu_1, \\sigma^2_1]}{f_{X | \\bar{X}, Y, C, V}[(X_{it} | \\bar{X}_{i, t-1}, Y_{i, t-1}, C_{it}, V_i), \\mu_2, \\sigma^2_2]}$$\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eThe numerator predicts the treatment using the previous treatment and time invariant confounders. We’ll use regular old linear regression here, but again, I’m like 90% sure you can do fancier things like multilevel models or machine learning or Bayes stuff:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emodel_num \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(vacation_days \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e lag_vacation_days \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e country, \n                data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e happiness_data)\n\n\u003cspan style=\"color:#75715e\"\u003e# This multilevel model works too\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# model_num \u0026lt;- lmer(vacation_days ~ lag_vacation_days + (1 | country), \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#                   data = happiness_data)\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Calculate the probability distribution\u003c/span\u003e\nnum \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(happiness_data\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003evacation_days,\n             \u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(model_num),\n             \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eresiduals\u003c/span\u003e(model_num)))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe denominator predicts the treatment using time-varying confounders, previous outcome, previous treatment, and time invariant confounders. Again we’ll use linear regression, but you can probably do fancier stuff too:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emodel_denom \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(vacation_days \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e log_gdp_cap \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e democracy \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e corruption \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n                    lag_happiness_vacation \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e lag_vacation_days \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e country, \n                  data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e happiness_data)\n\n\u003cspan style=\"color:#75715e\"\u003e# This multilevel model works too\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# model_denom \u0026lt;- lmer(vacation_days ~ log_gdp_cap + democracy + corruption + \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#                     lag_happiness_vacation + lag_vacation_days + (1 | country), \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#                   data = happiness_data)\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Calculate the probability distribution\u003c/span\u003e\nden \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(happiness_data\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003evacation_days,\n             \u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(model_denom),\n             \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eresiduals\u003c/span\u003e(model_denom)))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFinally we need to use the results from the numerator and denominator to build the inverse weights and calculate the cumulative product over time within each country:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Finally, we make actual IPW weights by building the fraction\u003c/span\u003e\nhappiness_data_weights \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e happiness_data \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(weights_no_time \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e num \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e den) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(country) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(ipw \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecumprod\u003c/span\u003e(weights_no_time)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eungroup\u003c/span\u003e()\n\nhappiness_data_weights \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(country, year, vacation_days, happiness_vacation, ipw) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e()\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   country  year vacation_days happiness_vacation   ipw\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;   \u0026lt;dbl\u0026gt;         \u0026lt;dbl\u0026gt;              \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 Mimim    2010            12               43.2 0.142\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 Mimim    2011            14               45.1 1.50 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 Mimim    2012            16               52.7 1.13 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4 Mimim    2013            17               52.7 0.941\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5 Mimim    2014            18               53.5 0.838\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6 Mimim    2015            20               61.4 0.457\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNow we can use the weights to find the ATE, just like we did with the binary version. Again, I’m using a multilevel model instead of a GEE model, which I \u003cem\u003ethink\u003c/em\u003e is theoretically fine and legal.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emodel_ate \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elmer\u003c/span\u003e(happiness_vacation \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e vacation_days \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e lag_vacation_days \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n                    (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e country) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e year), \n                  data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e happiness_data_weights, weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ipw)\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_ate, effects \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;fixed\u0026#34;\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 3 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   effect term              estimate std.error statistic\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;  \u0026lt;chr\u0026gt;                \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 fixed  (Intercept)          23.4     1.82        12.9\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 fixed  vacation_days         3.48    0.0908      38.4\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 fixed  lag_vacation_days    -1.19    0.0957     -12.4\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAfter correctly adjusting for all the time-varying confounding, the causal effect of an additional vacation day is 3.48 happiness points, which is bigger than the naive estimate of 2.1 that we found earlier.\u003c/p\u003e\n\u003cp\u003eHOWEVER, this isn’t what I built into the data?? In the simulated data, I made the vacation effect be 1.7. So either I did the simulation wrong and built the effect incorrectly and it’s not actually 1.7, or I’m misspecifying the model here. I’m pretty sure that the weights themselves are fine and correct—I copied the equation and code directly from \u003ca href=\"#ref-BlackwellGlynn:2018\"\u003eBlackwell and Glynn\u003c/a\u003e (\u003ca href=\"#ref-BlackwellGlynn:2018\"\u003e2018\u003c/a\u003e)’s replication data, and the weights and ATE are basically the same when using \u003ccode\u003eipwtm()\u003c/code\u003e. I don’t know what’s going on. :(\u003c/p\u003e\n\u003ch3 id=\"weights-with-the-ipw-package-1\"\u003eWeights with the \u003cstrong\u003eipw\u003c/strong\u003e package\u003c/h3\u003e\n\u003cp\u003eIt’s also possible to use the \u003ccode\u003eipwtm()\u003c/code\u003e function with continuous weights, but it runs \u003cem\u003eincredibly slowly\u003c/em\u003e since it uses \u003ccode\u003egeeglm()\u003c/code\u003e behind the scenes to build the weights.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# This takes forever! like multiple minutes\u003c/span\u003e\nweights_ipw_continuous \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eipwtm\u003c/span\u003e(\n  exposure \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e vacation_days,\n  family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;gaussian\u0026#34;\u003c/span\u003e,\n  corstr \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ar1\u0026#34;\u003c/span\u003e,\n  numerator \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e lag_vacation_days \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e country,  \u003cspan style=\"color:#75715e\"\u003e# Time invariant stuff\u003c/span\u003e\n  denominator \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e log_gdp_cap \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e democracy \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e corruption \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n    lag_happiness_vacation \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e lag_vacation_days \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e country,  \u003cspan style=\"color:#75715e\"\u003e# All confounders\u003c/span\u003e\n  id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e country,\n  timevar \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e year,\n  type \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;all\u0026#34;\u003c/span\u003e,\n  data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eas.data.frame\u003c/span\u003e(happiness_data)\n)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eBecause it uses GEE models for the numerator and denominator and accounts for autoregressive time structures in the data (that’s what the \u003ccode\u003ecostr = \u0026quot;ar1\u0026quot;\u003c/code\u003e argument is for), the weights are not exactly the same as the ones we found using manual math, but they’re super close:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Pretty close!\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(weights_ipw_continuous\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eipw.weights)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 0.142 1.505 1.126 0.941 0.838 0.457\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(happiness_data_weights\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eipw)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 0.142 1.505 1.126 0.941 0.838 0.457\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFinally we can use the weights to find the ATE. It’s basically identical to the effect we found with the manual math. (BUT STILL NOT 1.7 FOR WHATEVER REASON.)\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ehappiness_ipw \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e happiness_data \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(ipw \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e weights_ipw_continuous\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eipw.weights)\n\nmodel_ate_ipw \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elmer\u003c/span\u003e(happiness_vacation \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e vacation_days \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e lag_vacation_days \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n                        (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e country) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e year), \n                      data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e happiness_ipw, weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ipw)\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_ate_ipw, effects \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;fixed\u0026#34;\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 3 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   effect term              estimate std.error statistic\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;  \u0026lt;chr\u0026gt;                \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 fixed  (Intercept)          23.4     1.82        12.9\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 fixed  vacation_days         3.48    0.0908      38.4\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 fixed  lag_vacation_days    -1.19    0.0957     -12.4\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"important-caveats\"\u003eImportant caveats!\u003c/h2\u003e\n\u003cp\u003eThis is just a quick practical overview of how to actually build IPWs and use MSMs. I didn’t cover any of the math behind MSMs or the assumptions behind them, their limitations, diagnostics you should do, etc. Like, weights should generally have an average of 1 and not have values that are too extreme (and if values are too extreme, you can/should truncate them).\u003c/p\u003e\n\u003cp\u003eALSO I likely have something wrong here. If so, \u003cem\u003elet me know\u003c/em\u003e! Download the simulated data, play with it, fix the MSMs and weights, and tell me what’s wrong. Please!\u003c/p\u003e\n\u003cp\u003eConsult all these resources for better details about the mechanics of these models:\u003c/p\u003e\n\u003cdiv id=\"refs\" class=\"references csl-bib-body hanging-indent\"\u003e\n\u003cdiv id=\"ref-BlackwellGlynn:2018\" class=\"csl-entry\"\u003e\n\u003cp\u003eBlackwell, Matthew, and Adam N. Glynn. 2018. “How to Make Causal Inferences with Time-Series Cross-Sectional Data Under Selection on Observables.” \u003cem\u003eAmerican Political Science Review\u003c/em\u003e 112 (4): 1067–82. \u003ca href=\"https://doi.org/10.1017/s0003055418000357\"\u003ehttps://doi.org/10.1017/s0003055418000357\u003c/a\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv id=\"ref-ColeHernan:2008\" class=\"csl-entry\"\u003e\n\u003cp\u003eCole, Stephen R., and Miguel A. Hernán. 2008. “Constructing Inverse Probability Weights for Marginal Structural Models.” \u003cem\u003eAmerican Journal of Epidemiology\u003c/em\u003e 168 (6): 656–64. \u003ca href=\"https://doi.org/10.1093/aje/kwn164\"\u003ehttps://doi.org/10.1093/aje/kwn164\u003c/a\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv id=\"ref-HernanRobins:2020\" class=\"csl-entry\"\u003e\n\u003cp\u003eHernán, Miguel A., and James M. Robins. 2020. \u003cem\u003eCausal Inference: What If\u003c/em\u003e. Boca Raton, Florida: Chapman and Hall / CRC. \u003ca href=\"https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/\"\u003ehttps://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/\u003c/a\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv id=\"ref-ImaiRatkovic:2015\" class=\"csl-entry\"\u003e\n\u003cp\u003eImai, Kosuke, and Marc Ratkovic. 2015. “Robust Estimation of Inverse Probability Weights for Marginal Structural Models.” \u003cem\u003eJournal of the American Statistical Association\u003c/em\u003e 110 (511): 1013–23. \u003ca href=\"https://doi.org/10.1080/01621459.2014.956872\"\u003ehttps://doi.org/10.1080/01621459.2014.956872\u003c/a\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv id=\"ref-RobinsHernanBrumback:2000\" class=\"csl-entry\"\u003e\n\u003cp\u003eRobins, James M., Miguel Ángel Hernán, and Babette Brumback. 2000. “Marginal Structural Models and Causal Inference in Epidemiology.” \u003cem\u003eEpidemiology\u003c/em\u003e 11 (5): 550–60. \u003ca href=\"https://doi.org/10.1097/00001648-200009000-00011\"\u003ehttps://doi.org/10.1097/00001648-200009000-00011\u003c/a\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv id=\"ref-ThoemmesOng:2016\" class=\"csl-entry\"\u003e\n\u003cp\u003eThoemmes, Felix, and Anthony D. Ong. 2016. “A Primer on Inverse Probability of Treatment Weighting and Marginal Structural Models.” \u003cem\u003eEmerging Adulthood\u003c/em\u003e 4 (1): 40–59. \u003ca href=\"https://doi.org/10.1177/2167696815621645\"\u003ehttps://doi.org/10.1177/2167696815621645\u003c/a\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n",
            "date_published": "2020-12-03T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2020/12/01/ipw-binary-continuous/",
            "url": "https://www.shagunjhaver.com/blog/2020/12/01/ipw-binary-continuous/",
            "title": "Generating inverse probability weights for both binary and continuous treatments",
            "summary": "Use R to close backdoor confounding by generating and using inverse probability weights for both binary and continuous treatments",
            "content_html": "\u003cp\u003eMy \u003ca href=\"https://evalf20.classes.andrewheiss.com/\"\u003eprogram evaluation class\u003c/a\u003e is basically a fun wrapper around topics in causal inference and econometrics. I’m a big fan of Judea Pearl-style \u003ca href=\"https://bigthink.com/errors-we-live-by/judea-pearls-the-book-of-why-brings-news-of-a-new-science-of-causes\"\u003e“causal revolution”\u003c/a\u003e causal graphs (or \u003ca href=\"https://cran.r-project.org/web/packages/ggdag/vignettes/intro-to-dags.html\"\u003eDAGs\u003c/a\u003e), and they’ve made it easier for both me and my students to understand econometric approaches like diff-in-diff, regression discontinuity, and instrumental variables.\u003c/p\u003e\n\u003cp\u003eDAGs are also incredibly helpful for doing causal inference with observational data \u003cem\u003ewithout\u003c/em\u003e needing a specific quasi-experimental situation. As I show \u003ca href=\"/blog/2020/02/25/closing-backdoors-dags/\"\u003ein this blog post\u003c/a\u003e (and in \u003ca href=\"/research/chapters/heiss-causal-inference-2021/\"\u003ethis new textbook chapter!\u003c/a\u003e), you can use DAGs to identify confounders that distort the relationship (i.e. open up backdoors) between treatment and outcome. You can then use statistical methods to close those backdoors and adjust for the confounding. In both that blog post and the chapter, I show how to do this with matching and with inverse probability weighting (IPW).\u003c/p\u003e\n\u003cp\u003eHowever, those examples assume that the treatment is binary. This is fine—lots of social programs \u003cem\u003eare\u003c/em\u003e binary (used program/didn’t use program), and the math for creating inverse probability weights with binary treatment variables is fairly straightforward. However, treatment variables are also often \u003cem\u003enot\u003c/em\u003e binary, especially outside of program evaluation.\u003c/p\u003e\n\u003cp\u003eIn my own research, I’m working on a couple projects right now where the “treatment” is a count of anti-NGO legal restrictions in a country. I want to be able to use DAGs and inverse probability weighting to adjust for confounders, but I can’t use the IPW stuff I’ve been teaching because that variable isn’t binary! This research project gets even more complicated because it involves time-series cross-sectional (TSCS) data with both time-varying and time-invarying confounders, which opens up a whole other can of worms that I’ll figure out soon following \u003ca href=\"#ref-BlackwellGlynn:2018\"\u003eBlackwell and Glynn\u003c/a\u003e (\u003ca href=\"#ref-BlackwellGlynn:2018\"\u003e2018\u003c/a\u003e).\u003c/p\u003e\n\u003cp\u003eSo I had to teach myself how to do IPW with continuous variables. This post shows how to calculate IPWs for both binary and continuous treatments, both manually and with a couple different R packages (\u003ca href=\"https://cran.r-project.org/package=ipw\"\u003e\u003cstrong\u003eipw\u003c/strong\u003e\u003c/a\u003e and \u003ca href=\"https://github.com/ngreifer/WeightIt\"\u003e\u003cstrong\u003eWeightIt\u003c/strong\u003e\u003c/a\u003e).\u003c/p\u003e\n\u003ch2 id=\"contents----omit-in-toc---\"\u003eContents \u003c!-- omit in toc --\u003e\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#binary-treatments\"\u003eBinary treatments\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#example-data\"\u003eExample data\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ipw-manually-binary-treatment\"\u003eIPW manually, binary treatment\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ipw-with-the-ipw-package-binary-treatment\"\u003eIPW with the \u003cstrong\u003eipw\u003c/strong\u003e package, binary treatment\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ipw-with-the-weightit-package-binary-treatment\"\u003eIPW with the \u003cstrong\u003eWeightIt\u003c/strong\u003e package, binary treatment\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#continuous-treatments\"\u003eContinuous treatments\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#example-data-1\"\u003eExample data\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ipw-manually-continuous-treatment\"\u003eIPW manually, continuous treatment\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ipw-with-the-ipw-package-continuous-treatment\"\u003eIPW with the \u003cstrong\u003eipw\u003c/strong\u003e package, continuous treatment\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#ipw-with-the-weightit-package-continuous-treatment\"\u003eIPW with the \u003cstrong\u003eWeightIt\u003c/strong\u003e package, continuous treatment\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#references\"\u003eReferences\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(broom)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(scales)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(ggdag)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(dagitty)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(truncnorm)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(ipw)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(WeightIt)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"binary-treatments\"\u003eBinary treatments\u003c/h2\u003e\n\u003ch3 id=\"example-data\"\u003eExample data\u003c/h3\u003e\n\u003cp\u003eFor this example, we’ll generate a DAG for a hypothetical program where bed net use causes a reduction in malaria risk. That relationship is confounded by both income and health, and income influences health. Income and health both increase the probability of net usage.\u003c/p\u003e\n\u003cp\u003eThe treatment here is binary: either people use nets or they don’t.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emosquito_dag \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edagify\u003c/span\u003e(mal \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e net \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e inc \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e hlth,\n                       net \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e inc \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e hlth,\n                       hlth \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e inc,\n                       coords \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(mal \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e, net \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, inc \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, hlth \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e),\n                                     y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(mal \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, net \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, inc \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, hlth \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e)),\n                       exposure \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;net\u0026#34;\u003c/span\u003e,\n                       outcome \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;mal\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#a6e22e\"\u003eggdag_status\u003c/span\u003e(mosquito_dag) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eguides\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_dag\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"/blog/2020/12/01/ipw-binary-continuous/index_files/figure-html/dag-binary-1.png\" width=\"75%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eWe’ll measure these nodes like so:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eMalaria risk\u003c/strong\u003e: scale from 0–100, mostly around 40, but ranging from 10ish to 80ish. Best to use a Beta distribution.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eNet use\u003c/strong\u003e: binary 0/1, TRUE/FALSE variable, where 50% of people use nets. Best to use a binomial distribution. However, since we want to use other variables that increase the likelihood of using a net, we’ll generate a latent continuous variable, rescale it to 0–1, and then use it as probabilities in \u003ccode\u003erbinom()\u003c/code\u003e and assign people to treatment based on those probabilities.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eIncome\u003c/strong\u003e: weekly income, measured in dollars, mostly around 500 ± 300. Best to use a normal distribution.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eHealth\u003c/strong\u003e: scale from 0–100, mostly around 70, but ranging from 50ish to 100. Best to use a Beta distribution.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Make this randomness consistent\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eset.seed\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1234\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Simulate 1138 people (just for fun)\u003c/span\u003e\nn_people \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1138\u003c/span\u003e\n\nnet_data \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(\n  \u003cspan style=\"color:#75715e\"\u003e# Make an ID column (not necessary, but nice to have)\u003c/span\u003e\n  id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003en_people,\n  \u003cspan style=\"color:#75715e\"\u003e# Generate income variable: normal, 500 ± 300\u003c/span\u003e\n  income \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n_people, mean \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e500\u003c/span\u003e, sd \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e75\u003c/span\u003e)\n) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Generate health variable: beta, centered around 70ish\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(health_base \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erbeta\u003c/span\u003e(n_people, shape1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e7\u003c/span\u003e, shape2 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e,\n         \u003cspan style=\"color:#75715e\"\u003e# Health increases by 0.02 for every dollar in income\u003c/span\u003e\n         health_income_effect \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e income \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.02\u003c/span\u003e,\n         \u003cspan style=\"color:#75715e\"\u003e# Make the final health score and add some noise\u003c/span\u003e\n         health \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e health_base \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e health_income_effect \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n_people, mean \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, sd \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e),\n         \u003cspan style=\"color:#75715e\"\u003e# Rescale so it doesn\u0026#39;t go above 100\u003c/span\u003e\n         health \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erescale\u003c/span\u003e(health, to \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003emin\u003c/span\u003e(health), \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Generate net variable based on income, health, and random noise\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(net_score \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e income) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e health) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n_people, mean \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, sd \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e),\n         \u003cspan style=\"color:#75715e\"\u003e# Scale net score down to 0.05 to 0.95 to create a probability of using a net\u003c/span\u003e\n         net_probability \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erescale\u003c/span\u003e(net_score, to \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.05\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.95\u003c/span\u003e)),\n         \u003cspan style=\"color:#75715e\"\u003e# Randomly generate a 0/1 variable using that probability\u003c/span\u003e\n         net \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erbinom\u003c/span\u003e(n_people, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, net_probability)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Finally generate a malaria risk variable based on income, health, net use,\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# and random noise\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(malaria_risk_base \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erbeta\u003c/span\u003e(n_people, shape1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e, shape2 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e,\n         \u003cspan style=\"color:#75715e\"\u003e# Risk goes down by 10 when using a net. Because we rescale things,\u003c/span\u003e\n         \u003cspan style=\"color:#75715e\"\u003e# though, we have to make the effect a lot bigger here so it scales\u003c/span\u003e\n         \u003cspan style=\"color:#75715e\"\u003e# down to -10. Risk also decreases as health and income go up. I played\u003c/span\u003e\n         \u003cspan style=\"color:#75715e\"\u003e# with these numbers until they created reasonable coefficients.\u003c/span\u003e\n         malaria_effect \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e-30\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e net) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e-1.9\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e health) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e-0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e income),\n         \u003cspan style=\"color:#75715e\"\u003e# Make the final malaria risk score and add some noise\u003c/span\u003e\n         malaria_risk \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e malaria_risk_base \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e malaria_effect \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n_people, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, sd \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e),\n         \u003cspan style=\"color:#75715e\"\u003e# Rescale so it doesn\u0026#39;t go below 0,\u003c/span\u003e\n         malaria_risk \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erescale\u003c/span\u003e(malaria_risk, to \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e70\u003c/span\u003e))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(health_base, health_income_effect, net_score, net_probability, \n            malaria_risk_base, malaria_effect))\n\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(net_data)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##      id income health   net malaria_risk\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;int\u0026gt;  \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt; \u0026lt;int\u0026gt;        \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1     1   409.   63.1     0         45.1\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2     2   521.   83.5     1         23.4\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3     3   581.   73.0     0         36.5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4     4   324.   60.6     0         58.7\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5     5   532.   73.4     1         32.7\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6     6   538.   42.6     0         52.5\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"ipw-manually-binary-treatment\"\u003eIPW manually, binary treatment\u003c/h3\u003e\n\u003cp\u003eIf we just look at the effect of nets on malaria risk without any statistical adjustment, we see that nets cause a decrease of 13 points in malaria risk. This is wrong though because there’s confounding.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Wrong correlation-is-not-causation effect\u003c/span\u003e\nmodel_net_naive \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(malaria_risk \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e net, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e net_data)\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_net_naive)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 2 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term        estimate std.error statistic   p.value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;          \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 (Intercept)     41.9     0.413     102.  0.       \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 net            -13.6     0.572     -23.7 2.90e-101\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAccording to \u003cem\u003edo\u003c/em\u003e-calculus logic, we need to adjust for both income and health:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eadjustmentSets\u003c/span\u003e(mosquito_dag)\n\u003cspan style=\"color:#75715e\"\u003e## { hlth, inc }\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe’ll do that with inverse probability weighting. First we’ll use the health and income confounders to predict the treatment, or net use, and then we’ll generate propensity scores. We’ll then use those propensity scores to generate inverse probability weights following this formula:\u003c/p\u003e\n\u003cp\u003e$$\n\\frac{\\text{Treatment}}{\\text{Propensity}} - \\frac{1 - \\text{Treatment}}{1 - \\text{Propensity}}\n$$\u003c/p\u003e\n\u003cp\u003eThis formula will calculate weights for the average treatment effect (ATE). \u003ca href=\"https://livefreeordichotomize.com/2019/01/17/understanding-propensity-score-weighting/#how-do-we-incorporate-a-propensity-score-in-a-weight\"\u003eLucy D’Agostino McGowan has formulas for a bunch of different IPWs\u003c/a\u003e, including the average treatment on the treated (ATT), average treatment among the controls (ATC), and other effects.\u003c/p\u003e\n\u003cp\u003eHere’s how we do that with R:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Logit model to predict net use\u003c/span\u003e\nmodel_predict_net \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eglm\u003c/span\u003e(net \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e income \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e health,\n                         family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ebinomial\u003c/span\u003e(link \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;logit\u0026#34;\u003c/span\u003e),\n                         data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e net_data)\n\n\u003cspan style=\"color:#75715e\"\u003e# Generate propensity scores and IPWs\u003c/span\u003e\nnet_data_ipw \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eaugment_columns\u003c/span\u003e(model_predict_net, net_data,\n                                type.predict \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;response\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003erename\u003c/span\u003e(propensity \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e .fitted) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(ipw \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (net \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e propensity) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e ((\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e net) \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e propensity)))\n\nnet_data_ipw \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(id, income, health, net, malaria_risk, propensity, ipw) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e()\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 x 7\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##      id income health   net malaria_risk propensity   ipw\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;int\u0026gt;  \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt; \u0026lt;int\u0026gt;        \u0026lt;dbl\u0026gt;      \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1     1   409.   63.1     0         45.1      0.380  1.61\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2     2   521.   83.5     1         23.4      0.628  1.59\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3     3   581.   73.0     0         36.5      0.659  2.93\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4     4   324.   60.6     0         58.7      0.266  1.36\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5     5   532.   73.4     1         32.7      0.597  1.68\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6     6   538.   42.6     0         52.5      0.459  1.85\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFinally we’ll use those weights in a regression model to find the ATE. After adjusting for confounding and closing the backdoor paths opened by income and health, \u003cstrong\u003ethe effect of nets is -10.5\u003c/strong\u003e, which is more accurate than the naive estimate we found before. Yay!\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emodel_net_ipw \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(malaria_risk \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e net, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e net_data_ipw, weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ipw)\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_net_ipw)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 2 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term        estimate std.error statistic  p.value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;          \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 (Intercept)     40.4     0.409      98.8 0.      \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 net            -10.5     0.578     -18.3 1.83e-65\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"ipw-with-the-ipw-package-binary-treatment\"\u003eIPW with the \u003cstrong\u003eipw\u003c/strong\u003e package, binary treatment\u003c/h3\u003e\n\u003cp\u003eInstead of running a logistic regression model and generating propensity scores by hand, we can use the \u003cstrong\u003eipw\u003c/strong\u003e package to generate that \u003ccode\u003eipw\u003c/code\u003e column automatically. Specify the confounders in the \u003ccode\u003edenominator\u003c/code\u003e argument. There’s a \u003ccode\u003enumerator\u003c/code\u003e argument too that we can use for generating stabilized weights, but we’ll skip that for now.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# ipwpoint() can\u0026#39;t handle tibbles! Force net_data to be a data.frame\u003c/span\u003e\nweights_ipwpoint \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eipwpoint\u003c/span\u003e(\n  exposure \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e net,\n  family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;binomial\u0026#34;\u003c/span\u003e,  \u003cspan style=\"color:#75715e\"\u003e# The treatment is binary\u003c/span\u003e\n  link \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;logit\u0026#34;\u003c/span\u003e,\n  denominator \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e income \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e health,\n  data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eas.data.frame\u003c/span\u003e(net_data)\n)\n\n\u003cspan style=\"color:#75715e\"\u003e# They\u0026#39;re the same!\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(weights_ipwpoint\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eipw.weights)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 1.61 1.59 2.93 1.36 1.68 1.85\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(net_data_ipw\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eipw)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 1.61 1.59 2.93 1.36 1.68 1.85\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe resulting \u003ccode\u003eweights\u003c/code\u003e object here is a standalone object, and you can do other things with it like \u003ccode\u003esummary()\u003c/code\u003e. We can add the weights back into the main data and then fit the final model (\u003cem\u003etechnically\u003c/em\u003e we don’t need to—we could just say \u003ccode\u003eweights = weights_ipwpoint$ipw.weights\u003c/code\u003e and it would work just fine, but I don’t like working with standalone vectors and prefer to have them be columns, just so everything is all together in one place).\u003c/p\u003e\n\u003cp\u003eWe get the same ATE of -10.5.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003enet_data_ipwpoint \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e net_data \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(ipw \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e weights_ipwpoint\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eipw.weights)\n\nmodel_net_ipwpoint \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(malaria_risk \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e net, \n                         data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e net_data_ipwpoint, weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ipw)\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_net_ipwpoint)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 2 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term        estimate std.error statistic  p.value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;          \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 (Intercept)     40.4     0.409      98.8 0.      \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 net            -10.5     0.578     -18.3 1.83e-65\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"ipw-with-the-weightit-package-binary-treatment\"\u003eIPW with the \u003cstrong\u003eWeightIt\u003c/strong\u003e package, binary treatment\u003c/h3\u003e\n\u003cp\u003eWe can also use \u003ca href=\"https://ngreifer.github.io/WeightIt/articles/WeightIt.html\"\u003ethe \u003cstrong\u003eWeightIt\u003c/strong\u003e package\u003c/a\u003e to generate weights. It has slightly different syntax and can find all sorts of different estimands beyond the ATE (like \u003ca href=\"https://livefreeordichotomize.com/2019/01/17/understanding-propensity-score-weighting/#how-do-we-incorporate-a-propensity-score-in-a-weight\"\u003emost of the ones Lucy has listed\u003c/a\u003e). It can also handle a bunch of different methods beyond propensity scores. \u003cstrong\u003eWeightIt\u003c/strong\u003e can also handle tibbles, which is nice. It \u003cem\u003ealso\u003c/em\u003e provides a bunch of other summary information (if you use \u003ccode\u003esummary()\u003c/code\u003e), like effective sample sizes (ESS) in the treated/untreated groups and covariate balance.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eweights_weightit \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eweightit\u003c/span\u003e(net \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e income \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e health,  \u003cspan style=\"color:#75715e\"\u003e# Model net use with confounders\u003c/span\u003e\n                             data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e net_data, \n                             estimand \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ATE\u0026#34;\u003c/span\u003e,  \u003cspan style=\"color:#75715e\"\u003e# Find the ATE\u003c/span\u003e\n                             method \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ps\u0026#34;\u003c/span\u003e)  \u003cspan style=\"color:#75715e\"\u003e# Build weights with propensity scores\u003c/span\u003e\nweights_weightit\n\u003cspan style=\"color:#75715e\"\u003e## A weightit object\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  - method: \u0026#34;ps\u0026#34; (propensity score weighting)\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  - number of obs.: 1138\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  - sampling weights: none\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  - treatment: 2-category\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  - estimand: ATE\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  - covariates: income, health\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# See even more details here\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# summary(weights_weightit)\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Same as the other methods!\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(weights_weightit\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eweights)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 1.61 1.59 2.93 1.36 1.68 1.85\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAs with \u003cstrong\u003eipw\u003c/strong\u003e, we can add the weights to the dataset and run the model to find the same -10.5 ATE:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003enet_data_weightit \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e net_data \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(ipw \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e weights_weightit\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eweights)\n\nmodel_net_weightit \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(malaria_risk \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e net, \n                         data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e net_data_weightit, weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ipw)\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_net_weightit)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 2 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term        estimate std.error statistic  p.value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;          \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 (Intercept)     40.4     0.409      98.8 0.      \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 net            -10.5     0.578     -18.3 1.83e-65\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"continuous-treatments\"\u003eContinuous treatments\u003c/h2\u003e\n\u003ch3 id=\"example-data-1\"\u003eExample data\u003c/h3\u003e\n\u003cp\u003eInverse probability weights work with continuous treatment variables too, but the math is a \u003cdel\u003elittle\u003c/del\u003e lot trickier. For this example, we’ll generate a DAG for a hypothetical program where poorer families are given cash grants that they can spend on malaria prevention supplies, like mosquito nets, chemical treatments, and medication. It’s a voluntary program—people self select into it, and we’ll assume that people with lower health scores and lower income will sign up. The amount of the grant depends on income.\u003c/p\u003e\n\u003cp\u003eThe treatment here is continuous: people get different amounts of anti-malaria grant money. For the sake of simplicity here, everyone gets some grant money. I’m not even going to try multilevel zero-inflated models or anything (\u003ca href=\"https://vuorre.netlify.app/post/2019/02/18/analyze-analog-scale-ratings-with-zero-one-inflated-beta-models/\"\u003ethough those are cool!\u003c/a\u003e).\u003c/p\u003e\n\u003cp\u003eThe DAG looks the same as before (since we’re trying to keep things super simple here):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003egrant_dag \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edagify\u003c/span\u003e(mal \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e grant \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e inc \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e hlth,\n                    grant \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e inc \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e hlth,\n                    hlth \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e inc,\n                    coords \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(mal \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e, grant \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, inc \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, hlth \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e),\n                                  y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(mal \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, grant \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, inc \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, hlth \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e)),\n                    exposure \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grant\u0026#34;\u003c/span\u003e,\n                    outcome \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;mal\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#a6e22e\"\u003eggdag_status\u003c/span\u003e(grant_dag) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eguides\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_dag\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"/blog/2020/12/01/ipw-binary-continuous/index_files/figure-html/dag-continuous-1.png\" width=\"75%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eWe’ll measure these nodes like so:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eMalaria risk\u003c/strong\u003e: scale from 0–100, mostly around 40, but ranging from 10ish to 80ish. Best to use a Beta distribution.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eGrant\u003c/strong\u003e: amount between 5 and 40, centered around 20ish.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eIncome\u003c/strong\u003e: weekly income, measured in dollars, mostly around 500 ± 300. Best to use a normal distribution.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eHealth\u003c/strong\u003e: scale from 0–100, mostly around 70, but ranging from 50ish to 100. Best to use a Beta distribution.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Make this randomness consistent\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eset.seed\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1234\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Simulate 1504 people\u003c/span\u003e\nn_people \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1504\u003c/span\u003e\n\ngrant_data \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(\n  \u003cspan style=\"color:#75715e\"\u003e# Make an ID column (not necessary, but nice to have)\u003c/span\u003e\n  id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003en_people,\n  \u003cspan style=\"color:#75715e\"\u003e# Generate income variable: normal, 500 ± 300\u003c/span\u003e\n  income \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n_people, mean \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e500\u003c/span\u003e, sd \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e75\u003c/span\u003e)\n) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Generate health variable: beta, centered around 70ish\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(health_base \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erbeta\u003c/span\u003e(n_people, shape1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e7\u003c/span\u003e, shape2 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e,\n         \u003cspan style=\"color:#75715e\"\u003e# Health increases by 0.02 for every dollar in income\u003c/span\u003e\n         health_income_effect \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e income \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.02\u003c/span\u003e,\n         \u003cspan style=\"color:#75715e\"\u003e# Make the final health score and add some noise\u003c/span\u003e\n         health \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e health_base \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e health_income_effect \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n_people, mean \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, sd \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e),\n         \u003cspan style=\"color:#75715e\"\u003e# Rescale so it doesn\u0026#39;t go above 100\u003c/span\u003e\n         health \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erescale\u003c/span\u003e(health, to \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003emin\u003c/span\u003e(health), \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Generate grant variable\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(grant_base \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ertruncnorm\u003c/span\u003e(n_people, mean \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e18\u003c/span\u003e, sd \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, a \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, b \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e40\u003c/span\u003e),\n         \u003cspan style=\"color:#75715e\"\u003e# Grants are higher for people with lower incomes; higher for people with lower health\u003c/span\u003e\n         grant_effect \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (income \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e-0.25\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (health \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e-0.5\u003c/span\u003e),\n         \u003cspan style=\"color:#75715e\"\u003e# Make the final grant amount + noise + rescale it back down\u003c/span\u003e\n         grant \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e grant_base \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e grant_effect \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n_people, mean \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, sd \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e8\u003c/span\u003e),\n         grant \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eround\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003erescale\u003c/span\u003e(grant, to \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e40\u003c/span\u003e)), \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Finally generate a malaria risk variable based on income, health, grant amount,\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# and random noise\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(malaria_risk_base \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erbeta\u003c/span\u003e(n_people, shape1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e, shape2 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e,\n         \u003cspan style=\"color:#75715e\"\u003e# Risk goes down as grant money goes up. I played with these numbers\u003c/span\u003e\n         \u003cspan style=\"color:#75715e\"\u003e# until they created reasonable coefficients.\u003c/span\u003e\n         malaria_effect \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e-40\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e grant) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e-25\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e health) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e-0.05\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e income),\n         \u003cspan style=\"color:#75715e\"\u003e# Make the final malaria risk score and add some noise\u003c/span\u003e\n         malaria_risk \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e malaria_risk_base \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e malaria_effect \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n_people, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, sd \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e),\n         \u003cspan style=\"color:#75715e\"\u003e# Rescale so it doesn\u0026#39;t go below 0,\u003c/span\u003e\n         malaria_risk \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erescale\u003c/span\u003e(malaria_risk, to \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e70\u003c/span\u003e))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(health_base, health_income_effect, grant_base, grant_effect, \n            malaria_risk_base, malaria_effect))\n\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(grant_data)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##      id income health grant malaria_risk\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;int\u0026gt;  \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;        \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1     1   409.   70.2    27         26.3\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2     2   521.   75.3    18         33.3\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3     3   581.   62.6    20         42.3\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4     4   324.   83.9    28         11.8\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5     5   532.   74.3    20         31.8\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6     6   538.   75.9    15         36.2\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"ipw-manually-continuous-treatment\"\u003eIPW manually, continuous treatment\u003c/h3\u003e\n\u003cp\u003eIf we just look at the effect of grants on malaria risk without any adjustment, every extra grant dollar causes a drop of 0.4 malaria risk points. Once again, though, this is wrong because of confounding.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Wrong correlation-is-not-causation effect\u003c/span\u003e\nmodel_grant_naive \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(malaria_risk \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e grant, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e grant_data)\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_grant_naive)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 2 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term        estimate std.error statistic   p.value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;          \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 (Intercept)   44.2      1.35       32.8  2.56e-178\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 grant         -0.417    0.0615     -6.78 1.69e- 11\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAccording to \u003cem\u003edo\u003c/em\u003e-calculus logic, we again need to adjust for both income and health:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eadjustmentSets\u003c/span\u003e(grant_dag)\n\u003cspan style=\"color:#75715e\"\u003e## { hlth, inc }\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eHere’s where the math gets tricky. When we worked with a binary treatment, we calculated the propensity score for each observation and then used this formula to generate inverse probability weights:\u003c/p\u003e\n\u003cp\u003e$$\n\\frac{\\text{Treatment}}{\\text{Propensity}} - \\frac{1 - \\text{Treatment}}{1 - \\text{Propensity}}\n$$\u003c/p\u003e\n\u003cp\u003eWe can’t do that with continuous treatment variables, though, since we don’t really have propensity scores. Instead, we use this hairy-but-not-too-scary formula (from \u003ca href=\"#ref-NaimiMoodieAuger:2014\"\u003eNaimi et al.\u003c/a\u003e (\u003ca href=\"#ref-NaimiMoodieAuger:2014\"\u003e2014\u003c/a\u003e); \u003ca href=\"http://www.jayskaufman.com/uploads/3/0/8/9/30891283/naimi_constructing_ipw_for_continuous_exposures_epidemiology_2014.pdf\"\u003eungated version here\u003c/a\u003e; also \u003ca href=\"https://meghapsimatrix.com/post/continuous-r-rmarkdown/\"\u003esee this for another R example\u003c/a\u003e):\u003c/p\u003e\n\u003cp\u003e$$\n\\text{IPW} = \\frac{f_X (X; \\mu_1, \\sigma^2_1)}{f_{X | C} (X | C = c; \\mu_2, \\sigma^2_2)}\n$$\u003c/p\u003e\n\u003cp\u003ePhew. That’s a lot of math, but it’s not too bad if we take it apart:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e\\(X\\)\u003c/code\u003e stands for the continuous exposure or treatment variable\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e\\(C\\)\u003c/code\u003e stands for the confounders\u003c/li\u003e\n\u003cli\u003eThe \u003ccode\u003e\\(f_\\cdot (\\cdot)\\)\u003c/code\u003e function in both the numerator and denominator stands for a probability density function with a mean of \u003ccode\u003e\\(\\mu\\)\u003c/code\u003e and a variance of \u003ccode\u003e\\(\\sigma^2\\)\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eThe numerator \u003ccode\u003e\\(f_X (X; \\mu_1, \\sigma^2_1)\\)\u003c/code\u003e refers to the probability distribution of just the treatment variable (technically you could just use 1 as the numerator, but that can lead to unstable weights—using the probability distribution of the treatment helps stabilize the weights)\u003c/li\u003e\n\u003cli\u003eThe denominator \u003ccode\u003e\\(f_{X | C} (X | C = c; \\mu_2, \\sigma^2_2)\\)\u003c/code\u003e refers to the probability distribution of the treatment variable explained by the confounders\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e(Fun fact: I’m like 85% sure that the \u003ccode\u003e\\(\\frac{\\text{Treatment}}{\\text{Propensity}} - \\frac{1 - \\text{Treatment}}{1 - \\text{Propensity}}\\)\u003c/code\u003e formula is just an algebraically rearranged and simplified version of this fancier equation)\u003c/p\u003e\n\u003cp\u003eWe can calculate each element of this fraction and then generate the inverse probability weights. Here’s how to do that with R:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# The numerator is the probability distribution of just the treatment variable.\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# We\u0026#39;ll use a normal distribution for it (hence dnorm()). We need to feed\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# dnorm() the grant amount for each person, the predicted value from a simple\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# grant ~ 1 model, and the sd of the residuals from that model\u003c/span\u003e\nmodel_num \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(grant \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e grant_data)\nnum \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(grant_data\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003egrant,\n             \u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(model_num),\n             \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(model_num\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eresiduals))\n\n\u003cspan style=\"color:#75715e\"\u003e# The denominator is the probability distribution of the treatment variable\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# explained by the confounders. We\u0026#39;ll again use a normal distribution for it.\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# We\u0026#39;ll feed dnorm() the grant amount, the predicted value from a model that\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# includes the confounders, and the sd of the residuals from that model\u003c/span\u003e\nmodel_den \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(grant \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e health \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e income, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e grant_data)\nden \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(grant_data\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003egrant,\n             \u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(model_den),\n             \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(model_den\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eresiduals))\n\n\u003cspan style=\"color:#75715e\"\u003e# Finally, we make actual IPW weights by building the fraction\u003c/span\u003e\ngrant_data_ipw \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e grant_data \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(ipw \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e num \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e den)\n\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(grant_data_ipw)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 x 6\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##      id income health grant malaria_risk   ipw\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;int\u0026gt;  \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;        \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1     1   409.   70.2    27         26.3 0.288\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2     2   521.   75.3    18         33.3 0.492\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3     3   581.   62.6    20         42.3 0.687\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4     4   324.   83.9    28         11.8 0.177\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5     5   532.   74.3    20         31.8 0.499\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6     6   538.   75.9    15         36.2 0.748\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNow we can use the weights to find the ATE just like we did with the binary treatment:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emodel_grant_ipw \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(malaria_risk \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e grant, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e grant_data_ipw, weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ipw)\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_grant_ipw)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 2 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term        estimate std.error statistic   p.value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;          \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 (Intercept)    58.4     1.79        32.6 1.95e-176\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 grant          -1.11    0.0806     -13.7 1.45e- 40\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eEach dollar of grant money thus \u003cstrong\u003ecauses a drop of -1.1 malaria risk points\u003c/strong\u003e. Neato!\u003c/p\u003e\n\u003ch3 id=\"ipw-with-the-ipw-package-continuous-treatment\"\u003eIPW with the \u003cstrong\u003eipw\u003c/strong\u003e package, continuous treatment\u003c/h3\u003e\n\u003cp\u003eManually creating the numerator and denominator can get tedious though. We can use the \u003ccode\u003eipwpoint()\u003c/code\u003e function from \u003cstrong\u003eipw\u003c/strong\u003e to generate continuous weights in one step. Instead of specifying a binomial treatment like we did before, we’ll use a Gaussian (normal) family. We also specify both the numerator and denominator. It will generate identical weights.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eweights_continuous_ipwpoint \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eipwpoint\u003c/span\u003e(\n  exposure \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e grant,\n  family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;gaussian\u0026#34;\u003c/span\u003e,\n  numerator \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e,\n  denominator \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e health \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e income,\n  data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eas.data.frame\u003c/span\u003e(grant_data)\n)\n\n\u003cspan style=\"color:#75715e\"\u003e# Same values!\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(grant_data_ipw\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eipw)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 0.288 0.492 0.687 0.177 0.499 0.748\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(weights_continuous_ipwpoint\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eipw.weights)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 0.288 0.492 0.687 0.177 0.499 0.748\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe can then put those weights into the dataset and run a model with them. We get the same ATE of -1.1:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003egrant_data_ipwpoint \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e grant_data \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(ipw \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e weights_continuous_ipwpoint\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eipw.weights)\n\nmodel_grant_ipwpoint \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(malaria_risk \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e grant, \n                           data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e grant_data_ipwpoint, weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ipw)\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_grant_ipwpoint)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 2 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term        estimate std.error statistic   p.value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;          \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 (Intercept)    58.4     1.79        32.6 1.95e-176\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 grant          -1.11    0.0806     -13.7 1.45e- 40\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"ipw-with-the-weightit-package-continuous-treatment\"\u003eIPW with the \u003cstrong\u003eWeightIt\u003c/strong\u003e package, continuous treatment\u003c/h3\u003e\n\u003cp\u003eThe \u003cstrong\u003eWeightIt\u003c/strong\u003e package also handles continuous weights. The syntax is a lot simpler—there’s no need to worry about numerators and denominators.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eweights_weightit \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eweightit\u003c/span\u003e(grant \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e income \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e health,  \u003cspan style=\"color:#75715e\"\u003e# Model grant amount with confounders\u003c/span\u003e\n                             data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e grant_data, \n                             stabilize \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e)\nweights_weightit\n\u003cspan style=\"color:#75715e\"\u003e## A weightit object\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  - method: \u0026#34;ps\u0026#34; (propensity score weighting)\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  - number of obs.: 1504\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  - sampling weights: none\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  - treatment: continuous\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  - covariates: income, health\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# See even more details here\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# summary(weights_weightit)\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Not the same as the other methods :(\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(weights_weightit\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eweights)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 0.580 0.990 1.384 0.356 1.005 1.506\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eHowever(!), for mathy reasons I don’t understand, the weights it generates are not the same as what we get when doing it by hand or with \u003ccode\u003eipwpoint()\u003c/code\u003e. In fact, they’re almost exactly twice as large as the manual and \u003ccode\u003eipwpoint()\u003c/code\u003e weights:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Manual weights\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(grant_data_ipw\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eipw)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 0.288 0.492 0.687 0.177 0.499 0.748\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# weightit() weights / 2\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(weights_weightit\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eweights) \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## [1] 0.290 0.495 0.692 0.178 0.502 0.753\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eSurely there’s an argument to \u003ccode\u003eweightit()\u003c/code\u003e that I’m missing somewhere.\u003c/p\u003e\n\u003cp\u003eRegardless, for more mathy reasons I don’t understand, the ATE is identical even though the weights are roughly doubled:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003egrant_data_weightit \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e grant_data \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(ipw \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e weights_weightit\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eweights)\n\nmodel_grant_weightit \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(malaria_risk \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e grant, \n                           data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e grant_data_weightit, weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ipw)\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_grant_weightit)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 2 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term        estimate std.error statistic   p.value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;          \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 (Intercept)    58.4     1.79        32.6 1.95e-176\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 grant          -1.11    0.0806     -13.7 1.45e- 40\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003cdiv id=\"refs\" class=\"references csl-bib-body hanging-indent\"\u003e\n\u003cdiv id=\"ref-BlackwellGlynn:2018\" class=\"csl-entry\"\u003e\n\u003cp\u003eBlackwell, Matthew, and Adam N. Glynn. 2018. “How to Make Causal Inferences with Time-Series Cross-Sectional Data Under Selection on Observables.” \u003cem\u003eAmerican Political Science Review\u003c/em\u003e 112 (4): 1067–82. \u003ca href=\"https://doi.org/10.1017/s0003055418000357\"\u003ehttps://doi.org/10.1017/s0003055418000357\u003c/a\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv id=\"ref-NaimiMoodieAuger:2014\" class=\"csl-entry\"\u003e\n\u003cp\u003eNaimi, Ashley I., Erica E. M. Moodie, Nathalie Auger, and Jay S. Kaufman. 2014. “Constructing Inverse Probability Weights for Continuous Exposures; a Comparison of Methods.” \u003cem\u003eEpidemiology\u003c/em\u003e 25 (2): 292–99. \u003ca href=\"https://doi.org/10.1097/eDe.0000000000000053\"\u003ehttps://doi.org/10.1097/eDe.0000000000000053\u003c/a\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n",
            "date_published": "2020-12-01T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2020/03/12/emergency-online-teaching-resources/",
            "url": "https://www.shagunjhaver.com/blog/2020/03/12/emergency-online-teaching-resources/",
            "title": "Emergency online teaching resources",
            "summary": "List of resources to help teach online as universities rapidly shut down during the COVID-19 pandemic",
            "content_html": "\u003cp\u003e\u003cem\u003eThis is written for instructors in the Department of Public Management and Policy at the Andrew Young School of Policy Studies at Georgia State University, but it\u0026rsquo;s hopefully widely applicable too.\u003c/em\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eWith more than 100 universities moving their teaching online (including Emory just last night), it\u0026rsquo;s looking more and more inevitable that GSU will make a similar switch any time now.\u003c/p\u003e\n\u003cp\u003eBelow, I\u0026rsquo;ve described some resources to help the switch to online teaching go smoother. This is by no means comprehensive! Here are a bunch of other resources you can/should consult:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://cetl.gsu.edu/resources/resources-for-remote-teaching-and-learning/\"\u003eCETL\u0026rsquo;s strategies for teaching remotely\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://cetl.gsu.edu/resources/resources-for-remote-teaching-and-learning/faculty-quick-start-guide/\"\u003eCETL\u0026rsquo;s faculty quickstart guide\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://cetl.gsu.edu/resources/resources-for-remote-teaching-and-learning/faqs/\"\u003eCETL\u0026rsquo;s online teaching FAQs\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://oer.gsu.edu/icollegenow/front-matter/introduction/\"\u003eCETL\u0026rsquo;s iCollege resources\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eStanford\u0026rsquo;s \u003ca href=\"https://docs.google.com/document/d/1ccsudB2vwZ_GJYoKlFzGbtnmftGcXwCIwxzf-jkkoCU/edit#heading=h.nvtunalrrj5\"\u003e\u0026ldquo;Teaching effectively during times of disruption\u0026rdquo;\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://twitter.com/rebeccaglazier/status/1236338040710332416\"\u003eDr. Rebecca Glazier on effective online teaching\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://twitter.com/ProfJMale/status/1237155808464588800\"\u003eDr. Jessie Male on effective online teaching\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://twitter.com/rebeccakreitzer/status/1237837070682296321\"\u003eDr. Rebecca Kreitzer\u0026rsquo;s online teaching tips\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://docs.google.com/document/d/1dXeoYe7bUSVyE0ThVOgnGNdDMcsXFyEEm5XMN9ezT9E/edit\"\u003eDr. Shana Gadarian\u0026rsquo;s resources\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://simondhalliday.com/2020-03-10-online_teaching_covid19/\"\u003eDr. Simon Halliday\u0026rsquo;s resources for teaching online during COVID-19\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.engagingstudents.com/resources/\"\u003eEngaging Students' resources\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"contents----omit-in-toc---\"\u003eContents \u003c!-- omit in toc --\u003e\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#we-are-in-triage-mode\"\u003eWe are in triage mode\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#synchronous-teaching\"\u003eSynchronous teaching\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#webex\"\u003eWebex\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#equipment-you-need\"\u003eEquipment you need\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#getting-started\"\u003eGetting started\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#meeting-rooms-and-urls\"\u003eMeeting rooms and URLs\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#your-permanent-personal-meeting-url\"\u003eYour permanent personal meeting URL\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#meeting-specific-urls\"\u003eMeeting-specific URLs\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#webex-basics\"\u003eWebex basics\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#webex-in-icollege\"\u003eWebex in iCollege\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#other-ways-to-teach-synchronously\"\u003eOther ways to teach synchronously\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#distribution-of-course-materials\"\u003eDistribution of course materials\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#meeting-with-students-gras-and-colleagues\"\u003eMeeting with students, GRAs, and colleagues\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#asynchronous-teaching\"\u003eAsynchronous teaching\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"we-are-in-triage-mode\"\u003eWe are in triage mode\u003c/h2\u003e\n\u003cp\u003eIn this time of wild uncertainty and anxiety, remember to keep \u003ca href=\"https://twitter.com/davekarpf/status/1238132990556897285?s=21\"\u003ethese principles\u003c/a\u003e in mind first:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eLower your expectations for the class\u003c/li\u003e\n\u003cli\u003eDrop everything that\u0026rsquo;s not essential\u003c/li\u003e\n\u003cli\u003eKeep it simple\u003c/li\u003e\n\u003cli\u003eCommunicate clearly\u003c/li\u003e\n\u003cli\u003eBe flexible\u003c/li\u003e\n\u003cli\u003eBe generous\u003c/li\u003e\n\u003cli\u003eAsk how you can help\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eConsider taking a few minutes at the beginning of class to address student concerns about COVID-19, clear up misconceptions, and provide basic information about the disease. I\u0026rsquo;ve found that many students don\u0026rsquo;t have complete information about the pandemic, and talking through it and conveying basic information is reassuring.\u003c/p\u003e\n\u003cp\u003eLook at the first few slides of \u003ca href=\"https://evalsp20.classes.andrewheiss.com/class/09-class/\"\u003emy lecture here\u003c/a\u003e or \u003ca href=\"https://www.dropbox.com/s/qxskazf4k76duka/eckhouse%20-%20covid19%20slides%20-%202020-03-09.pdf\"\u003ethis lecture here\u003c/a\u003e for some examples.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.flattenthecurve.com/\"\u003eflattenthecurve.com\u003c/a\u003e is an excellent resource. Direct your students to it (and rely on it yourself). The \u003ca href=\"https://www.arcgis.com/apps/opsdashboard/index.html#/bda7594740fd40299423467b48e9ecf6\"\u003eJohns Hopkins COVID-19 map\u003c/a\u003e and the \u003ca href=\"https://www.nytimes.com/interactive/2020/world/coronavirus-maps.html\"\u003eNew York Times COVID-19 map\u003c/a\u003e are both reliable sources for tracking the spread of the disease\u003c/p\u003e\n\u003ch2 id=\"synchronous-teaching\"\u003eSynchronous teaching\u003c/h2\u003e\n\u003cp\u003ePerhaps the easiest option for moving your classes online with minimal extra work is to continue to hold your classes at their regularly scheduled time and have students participate remotely via synchronous video. I\u0026rsquo;ve been doing this for the past two weeks and it\u0026rsquo;s caused minimal disruption and extra work from my end.\u003c/p\u003e\n\u003ch3 id=\"webex\"\u003eWebex\u003c/h3\u003e\n\u003cp\u003eWebex is corporate video conferencing software that GSU has a subscription to. It is similar to Zoom (which you have have heard of or used elsewhere; Zoom was started by a former Webex employee after Webex was bought up by Cisco a few years ago), and provides all sorts of tools for having productive video conferences.\u003c/p\u003e\n\u003ch4 id=\"equipment-you-need\"\u003eEquipment you need\u003c/h4\u003e\n\u003cul\u003e\n\u003cli\u003eComputer\u003c/li\u003e\n\u003cli\u003eWebcam\n\u003cul\u003e\n\u003cli\u003eYou can use the one that\u0026rsquo;s built in to your laptop, or you can use an external one if you have one already (the one in your laptop is more than sufficient)\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eMicrophone\n\u003cul\u003e\n\u003cli\u003eYou can use the one that\u0026rsquo;s built in to your laptop, or you can use an external one. The one in your laptop is generally sufficient if you\u0026rsquo;re planning on sitting in front of your computer, but if you\u0026rsquo;re walking around a room, it might struggle to pick up your sound. It might be a good idea to get an external microphone. There are a billion options out there—I got \u003ca href=\"https://www.amazon.com/gp/product/B074C125TN/\"\u003ethis one which transmits wirelessly to my computer through USB\u003c/a\u003e, and includes both a lapel mic and a headset mic. If you\u0026rsquo;re only planning on recording at a desk, these articles (\u003ca href=\"https://thewirecutter.com/reviews/the-best-usb-microphone/\"\u003elink\u003c/a\u003e and \u003ca href=\"https://thewirecutter.com/lists/the-tools-to-ace-every-video-meeting/\"\u003elink\u003c/a\u003e) have great suggestions for good mics.\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"getting-started\"\u003eGetting started\u003c/h4\u003e\n\u003cp\u003eIf you haven\u0026rsquo;t downloaded Webex on your computer, go to \u003ca href=\"https://gsumeetings.webex.com/\"\u003ehttps://gsumeetings.webex.com/\u003c/a\u003e and log in with your GSU account. Once you\u0026rsquo;re logged in, you can click on the big green \u0026ldquo;Start a Meeting\u0026rdquo; button to start.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"personal-room-screen.png\" alt=\"Personal room screen\"\u003e\u003c/p\u003e\n\u003cp\u003eYou\u0026rsquo;ll be prompted to download the Cisco WebEx Meetings application if you haven\u0026rsquo;t already. Follow all the prompts to install it.\u003c/p\u003e\n\u003cp\u003eFrom now on, you can just open the Cisco Webex Meetings app directly on your computer instead of going to \u003ca href=\"https://gsumeetings.webex.com/\"\u003ehttps://gsumeetings.webex.com/\u003c/a\u003e.\u003c/p\u003e\n\u003ch4 id=\"meeting-rooms-and-urls\"\u003eMeeting rooms and URLs\u003c/h4\u003e\n\u003cp\u003eBecause Webex was invented for remote meetings, the whole application is based on that metaphor. When you teach and have students join via video, they\u0026rsquo;ll be joining a meeting. Participants join meetings by visiting specific URLs. You can use a permanent URL that will work every time, or you can generate meeting-specific URLs for specific classes\u003c/p\u003e\n\u003ch5 id=\"your-permanent-personal-meeting-url\"\u003eYour permanent personal meeting URL\u003c/h5\u003e\n\u003cp\u003eWebex gives you a permanent meeting URL—in the screenshot above, you can see that mine is \u003ca href=\"https://gsumeetings.webex.com/meet/aheiss\"\u003ehttps://gsumeetings.webex.com/meet/aheiss\u003c/a\u003e. If you send that link to your students, they\u0026rsquo;ll join you via video after visiting the URL. If you\u0026rsquo;re not there (e.g. they click on the link 30 minutes before class and you haven\u0026rsquo;t started streaming anything yet), they\u0026rsquo;ll see this:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"personal-room-waiting-screen.png\" alt=\"Personal room waiting screen\"\u003e\u003c/p\u003e\n\u003cp\u003eThey can wait on that screen until you start the meeting from your end.\u003c/p\u003e\n\u003cp\u003eThe nice thing about using your general permanent meeting URL is that it doesn\u0026rsquo;t change. You can send it to students who want to meet with you during office hours, or use it for committee meetings, or use it for each of your classes. The downside, though, is that it\u0026rsquo;s the same for everyone. If you\u0026rsquo;re meeting with a student during office hours, and a student from another class clicks on the link, they\u0026rsquo;ll automatically join your one-on-one meeting (which could be awkward!)\u003c/p\u003e\n\u003ch5 id=\"meeting-specific-urls\"\u003eMeeting-specific URLs\u003c/h5\u003e\n\u003cp\u003eTo avoid having unwanted guests join your class or office hours or committee meetings, you can generate meeting-specific URLs by scheduling future meetings.\u003c/p\u003e\n\u003cp\u003eFrom either the Webex Meetings application or from \u003ca href=\"https://gsumeetings.webex.com/\"\u003ehttps://gsumeetings.webex.com/\u003c/a\u003e, click on \u0026ldquo;Schedule\u0026rdquo; and enter the details for your class or meeting, including the start and end time. It makes you choose a password, but it doesn\u0026rsquo;t need to be highly secure or anything (I\u0026rsquo;ve used stuff like \u0026ldquo;asdf\u0026rdquo; or \u0026ldquo;1234\u0026rdquo; in the past).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"meeting-scheduling.png\" alt=\"Meeting scheduling\"\u003e\u003c/p\u003e\n\u003cp\u003eIf you include e-mail addresses in the \u0026ldquo;Attendees\u0026rdquo; section, Webex will send calendar invitations to your students with instructions on how to connect, including the meeting-specific URL and the meeting password. If you don\u0026rsquo;t include e-mail addresses there, it\u0026rsquo;s okay—you can communicate that information to them separately.\u003c/p\u003e\n\u003cp\u003eAfter you click on \u0026ldquo;Save\u0026rdquo;, you\u0026rsquo;ll get a confirmation e-mail from Webex, and you\u0026rsquo;ll see the meeting listed in the \u0026ldquo;Meetings\u0026rdquo; section of the Webex webpage:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"schedule-information.png\" alt=\"Schedule information\"\u003e\u003c/p\u003e\n\u003cp\u003eAt the bottom of page, you\u0026rsquo;ll see a \u0026ldquo;Meeting Information\u0026rdquo; section that includes the meeting-specific URL and the password for the meeting. Send those details to your students if you didn\u0026rsquo;t invite them through Webex\u0026rsquo;s system. You don\u0026rsquo;t really need to to worry about the meeting number or host key. The meeting number is only needed if students join the call/conference/meeting/class over the phone (there are instructions for doing that in the confirmation e-mail that Webex sends to you and t to them), and the host key is only needed if you need to host the meeting by phone.\u003c/p\u003e\n\u003ch4 id=\"webex-basics\"\u003eWebex basics\u003c/h4\u003e\n\u003cp\u003eOnce you start a video call, you\u0026rsquo;ll have a toolbar at the bottom with a bunch of different options:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"webex-toolbar.png\" alt=\"Webex toolbar\"\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eMute/unmute\u003c/strong\u003e: It\u0026rsquo;s often wise to mute yourself during breaks or while students are talking (or if you take a drink of water)\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eStart/stop video\u003c/strong\u003e: You can turn your video on/off here (the meeting will continue without video, so don\u0026rsquo;t worry about it accidentally ending)\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eShare screen\u003c/strong\u003e: By default, Webex will show whatever your camera is pointing at (i.e. you), but you can have it stream other things, like your computer screen. You can choose to share specific applications, like PowerPoint or Excel, or you can share your entire screen. If you\u0026rsquo;re plugged into a projector or screen (like when teaching), you can share \u0026ldquo;Screen 2\u0026rdquo; so students can see the projected PowerPoint (and not see your notes in presenter view)\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"webex-sharing.png\" alt=\"Webex sharing panel\"\u003e\u003c/p\u003e\n\u003cp\u003eIf you scroll down to the bottom of the share content window, you can also share a whiteboard, which lets you draw on screen with your mouse:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"ipad-whiteboard-sharing.png\" alt=\"iPad and whiteboard sharing\"\u003e\u003c/p\u003e\n\u003cp\u003eIf you plug an iPad or iPhone into your computer, you can also share that screen, which is an even easier way to have a whiteboard. Find some free/cheap drawing app for your iPad (if you have one) and stream that:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"ipad-sharing.png\" alt=\"iPad sharing\"\u003e\u003c/p\u003e\n\u003cp\u003eTo stop sharing your screen, move your mouse to the top of the screen and you\u0026rsquo;ll see a toolbar pop out. Click on \u0026ldquo;Stop Sharing\u0026rdquo; there.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eRecord meeting\u003c/strong\u003e: If you click on the \u0026ldquo;Record meeting\u0026rdquo; button, Webex will record the class session. When you finish the meeting, it will process all the video and send you an e-mail with a link that students can use to view later. \u003cem\u003eI\u0026rsquo;d recommend doing this every time you teach\u003c/em\u003e for students who might not be able to participate synchronously.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eView/mute participants\u003c/strong\u003e: If you click on this button, you\u0026rsquo;ll see a list of everyone on the call, along with indicators showing if they\u0026rsquo;ve turned off their video or muted themselves. \u003cstrong\u003eAll students should always keep themselves muted by default\u003c/strong\u003e, otherwise it gets really noisy and you\u0026rsquo;ll get lots of audio feedback. If students forget to mute themselves, you can mute them from here. When students want to ask a question or make a comment or respond to a question, they should unmute themselves. Remembering to unmute before speaking takes a little while to get used too, but it really makes the class go a lot smoother.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eChat\u003c/strong\u003e: You can chat with students too, which is often helpful if you want to have students virtually raise their hand or chime in or ask questions while you\u0026rsquo;re talking.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eEnd call\u003c/strong\u003e: This, um, ends the meeting.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch4 id=\"webex-in-icollege\"\u003eWebex in iCollege\u003c/h4\u003e\n\u003cp\u003eThere\u0026rsquo;s a way to \u003ca href=\"https://cetl.gsu.edu/services/digital-environments-teaching-tools/icollege-digital-learning-environment/webex-in-icollege/\"\u003eembed Webex meeting rooms inside iCollege courses\u003c/a\u003e, but I haven\u0026rsquo;t played with this yet, mostly because I use Webex for so many other things (office hours meetings, nonprofit board meetings, coauthor meetings), that I\u0026rsquo;m used to using it on its own. You might want to play with the iCollege integration for fun, though.\u003c/p\u003e\n\u003ch3 id=\"other-ways-to-teach-synchronously\"\u003eOther ways to teach synchronously\u003c/h3\u003e\n\u003cp\u003eYou don\u0026rsquo;t have to use Webex if you don\u0026rsquo;t want to! You can use Zoom, FaceTime, Skype, Google Hangouts, Facebook Messenger, WhatsApp, or any other live video calling service. If you don\u0026rsquo;t care about video and audio interaction with your students, you can stream your class live on YouTube or Twitch and have students participate through chat. If you want to be \u003cem\u003eextra\u003c/em\u003e fancy, you can use the free \u003ca href=\"https://obsproject.com/\"\u003eOBS\u003c/a\u003e application to switch between screens, video cameras, tables, etc. while streaming.\u003c/p\u003e\n\u003ch2 id=\"distribution-of-course-materials\"\u003eDistribution of course materials\u003c/h2\u003e\n\u003cp\u003eStudents need to be able to take quizzes or tests, turn in assignments, and access course materials remotely. iCollege is the best avenue for this, since it\u0026rsquo;s GSU\u0026rsquo;s main learning management software. If you need help, \u003ca href=\"https://cetl.gsu.edu/services/digital-environments-teaching-tools/icollege-digital-learning-environment/\"\u003eCETL has a lot of resources\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eIf you\u0026rsquo;re familiar with web hosting, you can be extra fancy and post slides and class materials to a public website too (\u003ca href=\"https://evalsp20.classes.andrewheiss.com/\"\u003elike this\u003c/a\u003e).\u003c/p\u003e\n\u003ch2 id=\"meeting-with-students-gras-and-colleagues\"\u003eMeeting with students, GRAs, and colleagues\u003c/h2\u003e\n\u003cp\u003eIf campus closes (or if you voluntarily start practicing social distancing and work from home), you need a way to continue to meet with your students, GRAs, coauthors, colleagues, committee members, and others. The easiest way to do this is probably through Webex (though you can use whatever video application you feel most comfortable with! I meet with different coauthors over the phone, through FaceTime, through Zoom, and through Google Hangouts). You can either use your permanent private meeting room, or schedule a specific meeting with a password and meeting-specific URL.\u003c/p\u003e\n\u003cp\u003eCoordinating student meeting times can be a hassle and you\u0026rsquo;ll want to avoid the inevitable e-mail tag that happens when trying to schedule stuff. I\u0026rsquo;ve found it easiest to use a free online service like \u003ca href=\"https://calendly.com/\"\u003eCalendly\u003c/a\u003e or \u003ca href=\"https://youcanbook.me/\"\u003eYouCanBook.me\u003c/a\u003e. These connect to your Google or Outlook calendars and let you set aside times that you are available. Students can then sign up for times to meet with you during those available slots. If you schedule other things during those times, those slots will become unavailable and people won\u0026rsquo;t be able to schedule meetings then.\u003c/p\u003e\n\u003cp\u003eYou can see what this looks like here: \u003ca href=\"https://calendly.com/andrewheiss/meeting/\"\u003ehttps://calendly.com/andrewheiss/meeting/\u003c/a\u003e. I\u0026rsquo;ve had enormous success with this under non-pandemic conditions—I don\u0026rsquo;t typically have set office hours during the week (like Mondays from 11-1 or something); instead, I have several chunks of time available for students and GRAs to schedule meetings, and they choose whatever slots are most convenient for them.\u003c/p\u003e\n\u003ch2 id=\"asynchronous-teaching\"\u003eAsynchronous teaching\u003c/h2\u003e\n\u003cp\u003eAt this point, given that we\u0026rsquo;re halfway through the semester, it\u0026rsquo;s unlikely that you\u0026rsquo;ll need to switch to asynchronous teaching. Developing a fully asynchronous class is hard and time-consuming and expensive—there\u0026rsquo;s a reason why we have an instructional designer on staff (Mya!) and why GSU offers immense support for developing online classes.\u003c/p\u003e\n\u003cp\u003eIf you want to switch to a completely asynchronous class, consult with Mya!\u003c/p\u003e\n\u003cp\u003eIf you want to have some asynchronous elements, like pre-recorded screencasts of how to do something in Excel, Stata, or R, or a miniature chunk of a lecture, or something similar, there are several useful resources:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://cetl.gsu.edu/services/digital-environments-teaching-tools/kaltura-media-hosting/\"\u003e\u003cstrong\u003eKaltura\u003c/strong\u003e\u003c/a\u003e: GSU has a subscription to this software. This is essentially like Webex and allows you to record yourself or your screen. It does not stream the recording live, however—it\u0026rsquo;s best for recording screencasts or recording yourself giving a lecture.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ePowerPoint\u003c/strong\u003e: You can record yourself using PowerPoint and upload the resulting video file to iCollege\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eQuickTime Player\u003c/strong\u003e: On macOS, you can use the QuickTime Player app to record audio, video, or your screen if you don\u0026rsquo;t want to use Kaltura\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eIf you want to edit or trim video that you create, you can use applications like these:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eiMovie\u003c/strong\u003e: macOS comes with the free iMovie, which lets you do basic video editing\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003ePhotos\u003c/strong\u003e: Windows 10 comes with the free Photos app, which \u003ca href=\"https://www.howtogeek.com/355524/how-to-use-windows-10s-hidden-video-editor/\"\u003ealso lets you do basic video editing\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://www.adobe.com/products/premiere.html\"\u003e\u003cstrong\u003eAdobe Premiere\u003c/strong\u003e\u003c/a\u003e or \u003ca href=\"https://www.adobe.com/products/premiere-rush.html\"\u003e\u003cstrong\u003eAdobe Premiere Rush\u003c/strong\u003e\u003c/a\u003e: If you want to be extra fancy, you can use Adobe Premiere (which you have access to through Adobe Creative Cloud, \u003ca href=\"https://technology.gsu.edu/technology-services/it-services/software-computer-purchase/software-download-and-purchase/adobe-creative-cloud/\"\u003ewhich you get for free from GSU\u003c/a\u003e)\u003c/li\u003e\n\u003c/ul\u003e\n",
            "date_published": "2020-03-12T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2020/02/25/closing-backdoors-dags/",
            "url": "https://www.shagunjhaver.com/blog/2020/02/25/closing-backdoors-dags/",
            "title": "Ways to close backdoors in DAGs",
            "summary": "Use regression, inverse probability weighting, and matching to close confounding backdoors and find causation in observational data",
            "content_html": "\u003cp\u003e\u003cspan class=\"small\"\u003e(\u003ca href=\"https://github.com/andrewheiss/closing-backdoors-dags\"\u003eSee this notebook on GitHub\u003c/a\u003e)\u003c/span\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eI’ve been teaching \u003ca href=\"https://evalsp20.classes.andrewheiss.com/\"\u003eprogram evaluation\u003c/a\u003e in the MPA/MPP program at GSU for the past semester and a half, and since I was given free rein over how to teach it, I decided to make it as modern and cutting edge as possible. To do this, I’ve infused the class with modern causal inference techniques (commonly known as the \u003ca href=\"https://bigthink.com/errors-we-live-by/judea-pearls-the-book-of-why-brings-news-of-a-new-science-of-causes\"\u003e“causal revolution”\u003c/a\u003e), focused on the language of \u003ca href=\"https://cran.r-project.org/web/packages/ggdag/vignettes/intro-to-dags.html\"\u003edirected acyclic graphs (DAGs)\u003c/a\u003e, \u003ca href=\"https://www.inference.vc/untitled/\"\u003edo-calculus\u003c/a\u003e, confounding, colliding, and the rest of Judea Pearl’s world of finding causation in observational data.\u003c/p\u003e\n\u003cp\u003eHowever, I was never taught this approach in any of my doctoral classes, and I’m entirely self-taught. I read \u003ca href=\"https://www.amazon.com/Book-Why-Science-Cause-Effect/dp/046509760X/\"\u003e\u003cem\u003eThe Book of Why\u003c/em\u003e\u003c/a\u003e in March 2019, and I’ve thrown myself into every possible journal article, blog post, and online course I’ve come across in order to understand how to isolate and identify causal effects. It’s been hard, but thanks to an incredibly welcoming community of economists, epidemiologists, and political scientists on Twitter, I’m getting it! (And so are my students!)\u003c/p\u003e\n\u003cp\u003eThe purpose of this post isn’t to introduce causal models and DAGs and confounders vs. colliders and all that. For that kind of introduction, consult any (or all!) of these resources:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eNick Huntington-Klein\u0026rsquo;s \u003ca href=\"http://www.nickchk.com/econ305.html\"\u003eECON 305: Economics, Causality, and Analytics course\u003c/a\u003e (especially lectures 13–18)\u003c/li\u003e\n\u003cli\u003eJulia M. Rohrer, “Thinking Clearly About Correlations and Causation: Graphical Causal Models for Observational Data,” Advances in Methods and Practices in \u003cem\u003ePsychological Science\u003c/em\u003e 1, no. 1 (March 2018): 27–42, doi: \u003ca href=\"https://doi.org/10.1177/2515245917745629\"\u003e10.1177/2515245917745629\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eMiguel A. Hernán and James M. Robbins, \u003cem\u003eCausal Inference: What If\u003c/em\u003e (CRC Press, 2020), \u003ca href=\"https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/\"\u003ehttps://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003ePaul Hünermund and Elias Bareinboim, “Causal Inference and Data-Fusion in Econometrics,” December 19, 2019, arXiv: 1912.09104 [econ.EM], \u003ca href=\"https://arxiv.org/abs/1912.09104\"\u003ehttps://arxiv.org/abs/1912.09104\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eFelix Elwert, “Graphical Causal Models,” chap. 13 in \u003cem\u003eHandbook of Causal Analysis for Social Research\u003c/em\u003e, ed. Stephen L. Morgan (New York: Springer, 2013), 245–273, doi: \u003ca href=\"https://doi.org/10.1007/978-94-007-6094-3_13\"\u003e10.1007/978-94-007-6094-3_13\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eJulian Schuessler and Peter Selb, “Graphical Causal Models for Survey Inference” (December 17, 2019), doi: \u003ca href=\"https://doi.org/10.31235/osf.io/hbg3m\"\u003e10.31235/osf.io/hbg3m\u003c/a\u003e, \u003ca href=\"https://osf.io/preprints/socarxiv/hbg3m/\"\u003ehttps://osf.io/preprints/socarxiv/hbg3m/\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eScott Cunningham, “Directed acyclical graphs” in \u003cem\u003eCausal Inference: The Mixtape\u003c/em\u003e (2018), \u003ca href=\"https://www.scunning.com/mixtape.html\"\u003ehttps://www.scunning.com/mixtape.html\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003ePaul Hünermund, “Causal Inference with Directed Acyclic Graphs,” \u003ca href=\"https://www.udemy.com/course/causal-data-science/?referralCode=4FB57D92601437BEB794\"\u003eUdemy\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eJason A. Roy, “A Crash Course in Causality: Inferring Causal Effects from Observational Data,” \u003ca href=\"https://www.coursera.org/learn/crash-course-in-causality/home/welcome\"\u003eCoursera\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eInstead, this post is a practical example of how exactly you can isolate causal effects by closing backdoor paths and adjusting for confounders in observational data. At its core, DAG-based causal inference involves isolating relationships—if some variable causes both your treatment and your outcome (thus confounding it), you can deal with that common cause in some statistical way and isolate the treatment–outcome effect. There’s no one right way to statistically deal with confounding, so here I show a few different ways to do it.\u003c/p\u003e\n\u003cp\u003eTo make this more concrete and practical, I use simulated data from a hypothetical program, but I use actual variable names rather than the $x$, $y$, and $z$ variables that are common in tutorials and articles about DAGs. Here, our outcome $y$ is a final grade, $x$ is a special math camp, and $z$ is all the possible confounders of the effect of the math camp on the grade.\u003c/p\u003e\n\u003cp\u003eLike \u003ca href=\"https://www.andrewheiss.com/blog/2019/01/29/diff-means-half-dozen-ways/\"\u003emy post showing a bunch of different ways to test differences in means\u003c/a\u003e, this is mostly a resource to my students and to future me. \u003ca href=\"https://github.com/andrewheiss/closing-backdoors-dags/issues\"\u003ePlease feel free to comment and make corrections or additions at GitHub!\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eHere’s a tl;dr table of contents since this is a little long:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#example-program\"\u003eExample program\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#simulated-data\"\u003eSimulated data\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#incorrect-correlation-is-not-causation-estimate\"\u003eIncorrect “correlation is not causation” estimate\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#adjustment-using-forbidden-unmeasured-variable\"\u003eAdjustment using forbidden unmeasured variable\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#adjustment-using-educated-guess-based-naive-matching\"\u003eAdjustment using educated-guess-based naive matching\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#brief-interlude-matching--slightly-simpler-dag\"\u003eBrief interlude: Matching + slightly simpler DAG\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#adjustment-using-inverse-probability-weighting-ipw\"\u003eAdjustment using inverse probability weighting (IPW)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#adjustment-using-matching-with-mahalanobis-distance\"\u003eAdjustment using matching (with Mahalanobis distance)\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#someday-when-im-smarter-do-calculus\"\u003eSomeday when I’m smarter: \u003cem\u003edo\u003c/em\u003e-calculus\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#comparison-of-all-methods\"\u003eComparison of all methods\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"example-program\"\u003eExample program\u003c/h2\u003e\n\u003cp\u003eWe’ll refer to a hypothetical math camp program throughout all these examples. Many policy schools offer a brief math camp in the weeks before students begin their graduate degrees, with the hope that it will help students be more prepared in math-heavy classes like statistics and microeconomics. For these examples, we’re interested in answering one question: what is the causal effect of attending math camp on final student outcomes?\u003c/p\u003e\n\u003cp\u003eWe can use \u003ca href=\"https://cran.r-project.org/web/packages/ggdag/vignettes/intro-to-ggdag.html\"\u003e\u003cstrong\u003eggdag\u003c/strong\u003e\u003c/a\u003e to draw a simplified causal model that explains what causes final student outcomes (it’s probably wrong, but whatever). I added all the fancy bells and whistles to the graph object here just for the sake of reference. In reality, you don’t need labels or coordinates or the individual \u003ccode\u003egeom_dag_*()\u003c/code\u003e layers and you can just do \u003ccode\u003eggdag(math_camp_dag)\u003c/code\u003e to get a basic graph, but for fun I’ve included everything you need for a publication-worthy graph.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)  \u003cspan style=\"color:#75715e\"\u003e# ggplot, dplyr, %\u0026gt;%, and friends\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(ggdag)  \u003cspan style=\"color:#75715e\"\u003e# Make DAGs with ggplot\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(dagitty)  \u003cspan style=\"color:#75715e\"\u003e# Do basic DAG math\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(broom)  \u003cspan style=\"color:#75715e\"\u003e# For converting model output to data frames\u003c/span\u003e\n\nnode_details \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etribble\u003c/span\u003e(\n  \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003ename, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003elabel, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003ex, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003ey,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;math_camp\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Math camp\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;final_grade\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Final grade\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;needs_camp\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Needs camp\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;gre_quant\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;GRE quantitative\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2.5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;gre_verbal\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;GRE verbal\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;background\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Background\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;undergraduate_gpa\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Undergraduate GPA\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e\n)\n\nnode_labels \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e node_details\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003elabel\n\u003cspan style=\"color:#a6e22e\"\u003enames\u003c/span\u003e(node_labels) \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e node_details\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ename\n\nmath_camp_dag \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edagify\u003c/span\u003e(final_grade \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e math_camp \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e gre_quant \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e gre_verbal \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n                          undergraduate_gpa \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e background,\n                        math_camp \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e needs_camp, \n                        needs_camp \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e background \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e undergraduate_gpa \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e gre_quant,\n                        gre_quant \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e background \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e undergraduate_gpa,\n                        gre_verbal \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e background \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e undergraduate_gpa,\n                        undergraduate_gpa \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e background,\n                        exposure \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;math_camp\u0026#34;\u003c/span\u003e,\n                        outcome \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;final_grade\u0026#34;\u003c/span\u003e,\n                        latent \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;background\u0026#34;\u003c/span\u003e,\n                        coords \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e node_details,\n                        labels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e node_labels)\n\n\u003cspan style=\"color:#75715e\"\u003e# Turn DAG into a tidy data frame for plotting\u003c/span\u003e\nmath_camp_dag_tidy \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e math_camp_dag \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etidy_dagitty\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003enode_status\u003c/span\u003e()   \u003cspan style=\"color:#75715e\"\u003e# Add column for exposure/outcome/latent\u003c/span\u003e\n\nstatus_colors \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(exposure \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#0074D9\u0026#34;\u003c/span\u003e, outcome \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4136\u0026#34;\u003c/span\u003e, latent \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey50\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Fancier graph\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(math_camp_dag_tidy, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e xend, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e yend)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_edges\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_point\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e status)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_label_repel\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e label, fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e status), seed \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1234\u003c/span\u003e,\n                       color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;white\u0026#34;\u003c/span\u003e, fontface \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bold\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_color_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e status_colors, na.value \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey20\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_fill_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e status_colors, na.value \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey20\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eguides\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e, fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etheme_dag\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"load-libraries-make-dag-1.png\" alt=\"DAG for math camp example\"\u003e\u003c/p\u003e\n\u003cp\u003eWe can tell a fairly complex story using this graph. Your final grade in the program is caused by a host of things, including your quantitative and verbal GRE scores (\u003ca href=\"https://www.sciencemag.org/careers/2017/06/gres-dont-predict-grad-school-success-what-does\"\u003ePROBABLY DEFINITELY NOT in real life\u003c/a\u003e, but go with it), your undergraduate GPA, and your unmeasured background factors (age, parental income, math anxiety, level of interest in the program, etc.). Your undergraduate GPA is determined by your background, and your GRE scores are determined by both your undergraduate GPA and your background. Because this math camp program is open to anyone, there is self-selection in who chooses to do it. We can pretend that this is decided by your undergraduate GPA, your quantitative GRE score, and your background. If the program was need-based and only offered to people with low GRE scores, we could draw an arrow from GRE quantitative to math camp, but we don’t. Finally, needing the math camp causes people to do it.\u003c/p\u003e\n\u003cp\u003eThere is a direct path between our treatment and outcome (math camp → final grade), but there is also some possible backdoor confounding. Both GRE quantitative and undergraduate GPA have arrows pointing to final grade and math camp (through “needs camp”), which means they’re a common cause, and background is both a confounder \u003cem\u003eand\u003c/em\u003e unmeasurable. But we don’t need to give up! If we adjust or control for “needs camp,” we can block the association between background, GRE quantitative, and undergraduate GPA. With this backdoor closed, we’ve isolated the math camp → final grade relationship and can find the causal effect.\u003c/p\u003e\n\u003cp\u003eHowever, we don’t really have a measure for needing math camp—we can’t read peoples’ minds and see if they need the program—so while it’d be great to just include a \u003ccode\u003eneeds_camp\u003c/code\u003e variable in a regression model, we’ll have to use other techniques to close the backdoor.\u003c/p\u003e\n\u003cp\u003eYou can find the backdoors automatically with Dagitty (draw the DAG there and notice red arrows between the unblocked confounders), or with functions in the \u003ca href=\"https://cran.r-project.org/package=dagitty\"\u003e\u003cstrong\u003edagitty\u003c/strong\u003e R package\u003c/a\u003e. If you run \u003ccode\u003epaths(math_camp_dag)\u003c/code\u003e, you can see that the only node pointing back into \u003ccode\u003emath_camp\u003c/code\u003e is \u003ccode\u003eneeds_camp\u003c/code\u003e, and if you run \u003ccode\u003eadjustmentSets(math_camp_dag)\u003c/code\u003e, you’ll see that \u003ccode\u003eneeds_camp\u003c/code\u003e is the only required adjustment set:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003epaths\u003c/span\u003e(math_camp_dag)\n\u003cspan style=\"color:#75715e\"\u003e## $paths\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  [1] \u0026#34;math_camp -\u0026gt; final_grade\u0026#34;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  [2] \u0026#34;math_camp \u0026lt;- needs_camp \u0026lt;- background -\u0026gt; final_grade\u0026#34;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  [3] \u0026#34;math_camp \u0026lt;- needs_camp \u0026lt;- background -\u0026gt; gre_quant -\u0026gt; final_grade\u0026#34;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  [4] \u0026#34;math_camp \u0026lt;- needs_camp \u0026lt;- background -\u0026gt; gre_quant \u0026lt;- undergraduate_gpa -\u0026gt; final_grade\u0026#34;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  [5] \u0026#34;math_camp \u0026lt;- needs_camp \u0026lt;- background -\u0026gt; gre_quant \u0026lt;- undergraduate_gpa -\u0026gt; gre_verbal -\u0026gt; final_grade\u0026#34;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  [6] \u0026#34;math_camp \u0026lt;- needs_camp \u0026lt;- background -\u0026gt; gre_verbal -\u0026gt; final_grade\u0026#34;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  ...\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $open\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  [1]  TRUE  TRUE  TRUE FALSE FALSE  TRUE FALSE FALSE  TRUE  TRUE  TRUE\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## [12]  TRUE  TRUE  TRUE FALSE  TRUE  TRUE  TRUE  TRUE FALSE  TRUE  TRUE\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## [23]  TRUE  TRUE FALSE FALSE  TRUE FALSE FALSE  TRUE  TRUE  TRUE\u003c/span\u003e\n\n\u003cspan style=\"color:#a6e22e\"\u003eadjustmentSets\u003c/span\u003e(math_camp_dag)\n\u003cspan style=\"color:#75715e\"\u003e##  { needs_camp }\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"simulated-data\"\u003eSimulated data\u003c/h2\u003e\n\u003cp\u003eAssuming this causal graph is correct (it’s probably not, but again, go with it), we can simulate data that reflects these causal relationships. There are a host of R packages for simulating data (like \u003ca href=\"https://github.com/trinker/wakefield\"\u003e\u003cstrong\u003ewakefield\u003c/strong\u003e\u003c/a\u003e, \u003ca href=\"https://www.rdatagen.net/page/simstudy/\"\u003e\u003cstrong\u003esimstudy\u003c/strong\u003e\u003c/a\u003e, and \u003ca href=\"https://declaredesign.org/r/fabricatr/\"\u003e\u003cstrong\u003efabricatr\u003c/strong\u003e\u003c/a\u003e), but here I do it a little more manually using \u003ccode\u003eMASS::mvrnorm()\u003c/code\u003e to use a \u003ca href=\"https://stats.stackexchange.com/a/164476/3025\"\u003emultivariate normal distribution to generate continuous variables that have a specific mean, standard deviation, and relationship with other variables\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eBecause data generation is beyond the scope of this post, the code below is heavily annotated. Importantly, the various \u003ccode\u003emutate()\u003c/code\u003e commands that create the \u003ccode\u003emath_camp\u003c/code\u003e data below create relationships between the confounders, treatment, and outcome. We also create a \u003ccode\u003eneeds_camp\u003c/code\u003e variable that is true if \u003cstrong\u003eboth\u003c/strong\u003e a student’s quantitative GRE score is less than the average \u003cem\u003eand\u003c/em\u003e if their undergraduate GPA is less than the average. We also build in some noncompliance: 80% of those who need math camp do it; 20% of those who don’t need it do it.\u003c/p\u003e\n\u003cp\u003eFor the sake of simplicity, the outcome here (\u003ccode\u003efinal_grade\u003c/code\u003e) isn’t GPA or anything—it’s an arbitrary number between 120 and 160 (though we could rescale it to something else).\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eMost importantly\u003c/strong\u003e, we force the math camp program to cause a \u003cstrong\u003e10 point increase\u003c/strong\u003e in students’ final grades. This is our baseline average treatment effect that we want to be able to find using different backdoor adjustment techniques.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Make these random draws the same every time\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eset.seed\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1234\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Create 2,000 rows\u003c/span\u003e\nnum \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2000\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Create confounder variables that are related to each other\u003c/span\u003e\nmu \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(undergrad_gpa \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, gre_verbal \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e160\u003c/span\u003e, gre_quant \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e145\u003c/span\u003e)\nstddev \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(undergrad_gpa \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e, gre_verbal \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, gre_quant \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Correlation matrix: undergrad GPA and verbal GRE have a correlation of 0.8;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# undergrad GPA and quantitative GRE have a correlation of 0.6, and verbal GRE\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# and quantitative GRE have a correlation of 0.4\u003c/span\u003e\ncor_matrix \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ematrix\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1.0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.8\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.6\u003c/span\u003e,\n                       \u003cspan style=\"color:#ae81ff\"\u003e0.8\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1.0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e,\n                       \u003cspan style=\"color:#ae81ff\"\u003e0.6\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1.0\u003c/span\u003e),\n                     ncol \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Convert correlation matrix to covariance matrix using fancy math\u003c/span\u003e\ncov_matrix \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e stddev \u003cspan style=\"color:#f92672\"\u003e%*%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e(stddev) \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e cor_matrix\n\n\u003cspan style=\"color:#75715e\"\u003e# Draw random numbers\u003c/span\u003e\nconfounders \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e MASS\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003emvrnorm\u003c/span\u003e(n \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e num, mu \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e mu, Sigma \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cov_matrix, empirical \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eas_tibble\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Truncate values so they\u0026#39;re within 130-170 range for GRE and less than 4.0 for GPA\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate_at\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003evars\u003c/span\u003e(gre_verbal, gre_quant),\n            \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ecase_when\u003c/span\u003e(\n              . \u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e170\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e170\u003c/span\u003e,\n              . \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e130\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e130\u003c/span\u003e,\n              \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e .\n            )) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(undergrad_gpa \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eifelse\u003c/span\u003e(undergrad_gpa \u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e, undergrad_gpa))\n\n\u003cspan style=\"color:#75715e\"\u003e# Make official dataset of simulated values\u003c/span\u003e\nmath_camp \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003enum) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ebind_cols\u003c/span\u003e(confounders) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e  \u003cspan style=\"color:#75715e\"\u003e# Bring in confounders\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# People need math camp if their GRE and GPA is lower than the average\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(needs_camp \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e gre_quant \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emean\u003c/span\u003e(gre_quant) \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e \n           undergrad_gpa \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emean\u003c/span\u003e(undergrad_gpa)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Build in some noncompliance: 80% of those who need math camp do it; 20% of\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# those who don\u0026#39;t need it do it.\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(math_camp \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecase_when\u003c/span\u003e(\n    needs_camp \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erbinom\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003en\u003c/span\u003e(), \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.8\u003c/span\u003e),\n    needs_camp \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erbinom\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003en\u003c/span\u003e(), \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.2\u003c/span\u003e)\n  )) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Create random error in grades\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(grade_noise \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(num, \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Create final grade based on all the arrows going into the node in the DAG.\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# There\u0026#39;s a 10 point causal effect\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(final_grade \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.3\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e gre_verbal) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e gre_quant) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n           (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e undergrad_gpa) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e math_camp) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e grade_noise) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(math_camp \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eas.logical\u003c/span\u003e(math_camp))  \u003cspan style=\"color:#75715e\"\u003e# Make true/false\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003ePhew. That’s a lot of code to make fake data, but it worked! We can look at the first few rows:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(math_camp)\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 x 8\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##      id undergrad_gpa gre_verbal gre_quant needs_camp math_camp grade_noise\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;int\u0026gt;         \u0026lt;dbl\u0026gt;      \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt; \u0026lt;lgl\u0026gt;      \u0026lt;lgl\u0026gt;           \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1     1          3.90       170       151. FALSE      FALSE            13.5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2     2          3.20       163.      143. FALSE      FALSE            13.2\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3     3          2.83       162.      140. TRUE       TRUE             10.4\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4     4          2.63       144.      154. FALSE      FALSE            17.0\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5     5          3.24       170       148. FALSE      FALSE            16.4\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6     6          2.95       167.      146. FALSE      FALSE            19.0\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## # … with 1 more variable: final_grade \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAbout 40% of the students participated in math camp:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emath_camp \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003ecount\u003c/span\u003e(math_camp) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(prop \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e n \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esum\u003c/span\u003e(n))\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 2 x 3\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   math_camp     n  prop\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;lgl\u0026gt;     \u0026lt;int\u0026gt; \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 FALSE      1182 0.591\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 TRUE        818 0.409\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"incorrect-correlation-is-not-causation-estimate\"\u003eIncorrect “correlation is not causation” estimate\u003c/h2\u003e\n\u003cp\u003eWe can take an initial stab at finding the causal effect of the program by comparing the average final grades for those who did math camp and those who didn’t. At first glance, it looks like math camp participants have a higher grade!\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emath_camp \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(math_camp) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003esummarize\u003c/span\u003e(avg \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emean\u003c/span\u003e(final_grade))\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 2 x 2\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   math_camp   avg\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;lgl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 FALSE      138.\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 TRUE       144.\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe distribution of scores is higher for those who did the program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(math_camp, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e final_grade, fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e math_camp)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_histogram\u003c/span\u003e(binwidth \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;white\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eguides\u003c/span\u003e(fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efacet_wrap\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003evars\u003c/span\u003e(math_camp), ncol \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_light\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"plot-distributions-wrong-1.png\" alt=\"Naive, wrong distributions\"\u003e\u003c/p\u003e\n\u003cp\u003eWe can run a simple linear regression model to estimate the exact effect:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emodel_wrong \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(final_grade \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e math_camp, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e math_camp)\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_wrong)\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 2 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term          estimate std.error statistic   p.value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;            \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 (Intercept)     138.       0.185     744.  0.       \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 math_campTRUE     6.54     0.290      22.6 8.48e-101\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eBased on this model, participating in the program is associated with 6.5 more points in your final grade. Neat.\u003c/p\u003e\n\u003cp\u003eThis is wrong, though, since there are confounders at play that cause both attendance at math camp and final grade. We need to adjust for those to get the actual causal effect.\u003c/p\u003e\n\u003ch2 id=\"adjustment-using-forbidden-unmeasured-variable\"\u003eAdjustment using forbidden unmeasured variable\u003c/h2\u003e\n\u003cp\u003eThe backdoor confounder we have to worry about is \u003ccode\u003eneeds_camp\u003c/code\u003e. We created this variable when we generated the data, so for fun, we can include it in the regression model as a control variable to adjust for it:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emodel_adj_needs_camp \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(final_grade \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e math_camp \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e needs_camp, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e math_camp)\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_adj_needs_camp)\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 3 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term           estimate std.error statistic   p.value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;             \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 (Intercept)      139.       0.174     798.  0.       \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 math_campTRUE     10.2      0.320      31.9 2.79e-181\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 needs_campTRUE    -6.69     0.329     -20.3 1.28e- 83\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe coefficient for \u003ccode\u003emath_campTRUE\u003c/code\u003e is now ≈10, which is what it should be! Adjusting for needing math camp isolated the causal effect.\u003c/p\u003e\n\u003cp\u003eBut we can’t do that in real life. We don’t know what needing math camp looks like in actual data, so we need to use other techniques.\u003c/p\u003e\n\u003ch2 id=\"adjustment-using-educated-guess-based-naive-matching\"\u003eAdjustment using educated-guess-based naive matching\u003c/h2\u003e\n\u003cp\u003eOne possible approach to guessing the need for math camp is to create groups of students based on what we think might be driving the need for camp. We know from the causal model that quantitative GRE scores and undergraduate GPAs partially cause needing the program. We can assume that people with lower test scores or lower GPAs need the camp and create our own guess about what the threshold might be.\u003c/p\u003e\n\u003cp\u003eLet’s look at the distribution of GRE scores and see if there’s any pattern about why people may have chosen to do the program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(math_camp, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e gre_quant, fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e math_camp)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_histogram\u003c/span\u003e(binwidth \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;white\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eguides\u003c/span\u003e(fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efacet_wrap\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003evars\u003c/span\u003e(math_camp), ncol \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_light\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"gre-math-camp-1.png\" alt=\"Quantitative GRE score across math camp participation\"\u003e\u003c/p\u003e\n\u003cp\u003eThere’s a pretty noticable break in the distribution of GRE scores for those who did the program: lots of people who scored under 145ish did the program, while not a lot of people who scored over 145 did. Without knowing anything about what completely causes math camp need, we can pretend that 145 is some sort of threshold of need and use that as our confounder:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emath_camp_guessed_need \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e math_camp \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(maybe_needs_camp \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e gre_quant \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e145\u003c/span\u003e)\n\nmodel_adj_needs_camp_guess \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(final_grade \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e math_camp \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e maybe_needs_camp, \n                                 data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e math_camp_guessed_need)\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_adj_needs_camp_guess)\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 3 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term                 estimate std.error statistic   p.value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;                   \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 (Intercept)            140.       0.197     708.  0.       \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 math_campTRUE            8.70     0.292      29.8 4.41e-162\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 maybe_needs_campTRUE    -5.33     0.287     -18.6 2.36e- 71\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAfter adjusting for our possible needing camp confounder, the causal effect is now 8.7, which is closer to 10! It’s still not entirely correct, but we’re getting closer.\u003c/p\u003e\n\u003ch2 id=\"brief-interlude-matching--slightly-simpler-dag\"\u003eBrief interlude: Matching + slightly simpler DAG\u003c/h2\u003e\n\u003cp\u003eWe just attempted to guess what the “needs camp” node might be based on the nodes flowing into it. If you notice, though, the “needs camp” node is an intermediate node on the path between GPA and GRE scores and actually participating in the math camp program. If we can guess what causes people to enroll in the program, that’s roughly the same as predicting their need for the camp.\u003c/p\u003e\n\u003cp\u003eAdditionally, predicting enrollment in the program directly (rather than the desire to enroll) lets us use better matching techniques. Our guess of needing camp was pretty naive—it’d be more accurate if we incorporated other variables (like GPA and background) into our manual grouping. But the intuition of trying to group manually was correct—we looked at the factors that caused needing math camp and guessed that some things make it more likely. We can make this process more formal by building an actual model that predicts the likelihood of treatment.\u003c/p\u003e\n\u003cp\u003eTo do this, we can remove the “needs camp” node, since it wasn’t doing much in the model and since we can use confounders like GPA and quantitative GRE to estimate the probability of enrollment in math camp directly. Here’s a slightly simpler version without “needs camp” and “background”:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003enode_details_simpler \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etribble\u003c/span\u003e(\n  \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003ename, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003elabel, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003ex, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003ey,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;math_camp\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Math camp\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;final_grade\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Final grade\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;gre_quant\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;GRE quantitative\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2.5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;gre_verbal\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;GRE verbal\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;undergraduate_gpa\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Undergraduate GPA\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e\n)\n\nnode_labels_simpler \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e node_details_simpler\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003elabel\n\u003cspan style=\"color:#a6e22e\"\u003enames\u003c/span\u003e(node_labels_simpler) \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e node_details_simpler\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ename\n\nmath_camp_dag_simpler \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edagify\u003c/span\u003e(final_grade \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e math_camp \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e gre_quant \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e gre_verbal \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n                                  undergraduate_gpa,\n                                math_camp \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e undergraduate_gpa \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e gre_quant,\n                                gre_quant \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e undergraduate_gpa,\n                                gre_verbal \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e undergraduate_gpa,\n                                exposure \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;math_camp\u0026#34;\u003c/span\u003e,\n                                outcome \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;final_grade\u0026#34;\u003c/span\u003e,\n                                coords \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e node_details,\n                                labels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e node_labels)\n\n\u003cspan style=\"color:#75715e\"\u003e# Turn DAG into a tidy data frame for plotting\u003c/span\u003e\nmath_camp_dag_simpler_tidy \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e math_camp_dag_simpler \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etidy_dagitty\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003enode_status\u003c/span\u003e()   \u003cspan style=\"color:#75715e\"\u003e# Add column for exposure/outcome\u003c/span\u003e\n\nstatus_colors \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(exposure \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#0074D9\u0026#34;\u003c/span\u003e, outcome \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4136\u0026#34;\u003c/span\u003e, latent \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey50\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Fancier graph\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(math_camp_dag_simpler_tidy, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e xend, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e yend)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_edges\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_point\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e status)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_label_repel\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e label, fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e status), seed \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1234\u003c/span\u003e,\n                       color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;white\u0026#34;\u003c/span\u003e, fontface \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bold\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_color_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e status_colors, na.value \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey20\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_fill_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e status_colors, na.value \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey20\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eguides\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e, fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etheme_dag\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"simpler-dag-1.png\" alt=\"Simpler math camp DAG\"\u003e\u003c/p\u003e\n\u003ch2 id=\"adjustment-using-inverse-probability-weighting-ipw\"\u003eAdjustment using inverse probability weighting (IPW)\u003c/h2\u003e\n\u003cp\u003eOne common method for matching the assignment to treatment based on confounders that is quite popular in epidemiology is to use inverse probability weighting (IPW). To estimate causal effects with IPW, we follow a two-step process. In the first step, we use the confounders to estimate propensity scores for each observation, or the probability of that observation going to math camp given other characteristics.\u003c/p\u003e\n\u003cp\u003eA common way to generate propensity scores is to use logistic regression. Here we build a model estimating participation in math camp based on undergraduate GPA and quantitative GRE scores. We then use \u003ccode\u003eaugment()\u003c/code\u003e to plug the GPA and GRE values for each observation into the model and generate a predicted probability:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eneeds_camp_model \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eglm\u003c/span\u003e(math_camp \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e undergrad_gpa \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e gre_quant, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e math_camp, \n                        family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ebinomial\u003c/span\u003e(link \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;logit\u0026#34;\u003c/span\u003e))\n\nmath_camp_propensities \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eaugment\u003c/span\u003e(needs_camp_model, math_camp, type.predict \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;response\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(p_camp \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e .fitted)  \u003cspan style=\"color:#75715e\"\u003e# Rename column\u003c/span\u003e\n\nmath_camp_propensities \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(id, undergrad_gpa, gre_quant, math_camp, p_camp) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e()\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##      id undergrad_gpa gre_quant math_camp p_camp\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;int\u0026gt;         \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt; \u0026lt;lgl\u0026gt;      \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1     1          3.90      151. FALSE     0.0969\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2     2          3.20      143. FALSE     0.371 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3     3          2.83      140. TRUE      0.554 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4     4          2.63      154. FALSE     0.291 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5     5          3.24      148. FALSE     0.258 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6     6          2.95      146. FALSE     0.371\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe have a new column \u003ccode\u003ep_camp\u003c/code\u003e that shows the probability of going to camp based on grades and test scores. Our first person has a high GPA and high GRE score, so they have a 9% chance of going to math camp, while person 3 has a low GPA and low test score, so they’re more likely to need it.\u003c/p\u003e\n\u003cp\u003eIn the second step, we incorporate these predicted probabilities into our causal effect estimation by converting them into weights, which creates a pseduo-population of observations (i.e. some student observations are more important than others for estimating the causal effect). What this means practically is that people with a low likelihood of attending math camp who \u003cem\u003edo\u003c/em\u003e attend it anyway should be treated as more important than those who follow expectations, since those with higher weights are more likely to influence the overall causal effect.\u003c/p\u003e\n\u003cp\u003eThere are a whole bunch of different weighting techniques, and \u003ca href=\"https://livefreeordichotomize.com/\"\u003eLucy D’Agostino McGowan\u003c/a\u003e covers them in depth \u003ca href=\"https://livefreeordichotomize.com/2019/01/17/understanding-propensity-score-weighting/\"\u003ein her excellent blog post here\u003c/a\u003e (see also \u003ca href=\"https://www.rdatagen.net/post/potential-outcomes-confounding/\"\u003ethis\u003c/a\u003e). For the sake of this example, we’ll calculate weights that are appropriate for estimating two different causal quantities. Here, $i$ represents an individual student, $e_i$ represents the propensity score for an individual needing/participating in math camp, or the treatment $Z_i$:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAverage treatment effect (ATE): overall average effect, or the difference in potential outcomes when the Z = 1 and Z = 0. Formula for weights: $\\frac{Z_i}{e_i} + \\frac{1 - Z_i}{1 - e_i}$\u003c/li\u003e\n\u003cli\u003eAverage treatment effect among the overlap population (ATO): effect of math camp across observations that overlap (i.e. those who are both likely and unlikely to need math camp). Formula for weights: $(1-e_i)Z_i + e_i(1-Z_i)$\u003c/li\u003e\n\u003c/ul\u003e\n\u003c!-- end list --\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emath_camp_propensities \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e math_camp_propensities \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(w_ate \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (math_camp \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e p_camp) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e ((\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e math_camp) \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e p_camp)),\n         w_ato \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e p_camp) \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e math_camp \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e p_camp \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e math_camp))\n\nmath_camp_propensities \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(id, p_camp, w_ate, w_ato) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e()\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 x 4\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##      id p_camp w_ate  w_ato\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;int\u0026gt;  \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1     1 0.0969  1.11 0.0969\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2     2 0.371   1.59 0.371 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3     3 0.554   1.80 0.446 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4     4 0.291   1.41 0.291 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5     5 0.258   1.35 0.258 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6     6 0.371   1.59 0.371\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFinally, we can incorporate these weights into a regression model. Note how we’re using \u003ccode\u003emath_camp\u003c/code\u003e as the only explanatory variable. Because we used undergraduate GPA and quantitative GRE scores to estimate the propensity scores for needing camp (and receiving the program), including the weights should be enough to close the “needs camp” back door:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emodel_ipw_ate \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(final_grade \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e math_camp, \n                    data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e math_camp_propensities, weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e w_ate)\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_ipw_ate)\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 2 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term          estimate std.error statistic   p.value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;            \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 (Intercept)      137.      0.222     614.  0.       \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 math_campTRUE     10.9     0.308      35.3 8.75e-213\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emodel_ipw_ato \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(final_grade \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e math_camp, \n                    data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e math_camp_propensities, weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e w_ato)\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_ipw_ato)\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 2 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term          estimate std.error statistic   p.value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;            \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 (Intercept)      136.      0.203     672.  0.       \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 math_campTRUE     10.0     0.286      35.0 1.02e-209\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eBoth of these causal estimates are pretty spot on, with the ATO providing an answer incredibly close to the true value of 10. Neat!\u003c/p\u003e\n\u003cp\u003eIf we had other backdoors to adjust for, we could include them in the propensity score model as well. We can do all our backdoor adjustment in the logit model, generate propensity scores, generate inverse probability weights, and then use the weights in a simple regression model to find the actual causal effect.\u003c/p\u003e\n\u003ch2 id=\"adjustment-using-matching-with-mahalanobis-distance\"\u003eAdjustment using matching (with Mahalanobis distance)\u003c/h2\u003e\n\u003cp\u003eWe can use other methods to find matches in the data to estimate the probability of attending math camp. There’s a whole world of other statistical methods for creating matches; inverse probability weights are just one method.\u003c/p\u003e\n\u003cp\u003eWhile matching based on propensity scores (i.e. building some model to generate predicted probabilities for the likelihood of treatment and matching observations that have similar propensities) is popular, it can cause problems when you use it for causal identification. Following \u003ca href=\"https://www.youtube.com/watch?v=rBv39pK1iEs\"\u003eGary King’s suggestions\u003c/a\u003e, we can match with other techniques. (Again, covering what all these do goes beyond the scope of this post, but there are some excellent resources out there, like \u003ca href=\"https://www.youtube.com/watch?v=rBv39pK1iEs\"\u003ethis highly accessible video by Gary King\u003c/a\u003e.)\u003c/p\u003e\n\u003cp\u003eOne popular technique in political science is to match based on \u003ca href=\"https://en.wikipedia.org/wiki/Mahalanobis_distance\"\u003eMahalanobis\u003c/a\u003e (or \u003ca href=\"https://en.wikipedia.org/wiki/Euclidean_distance\"\u003eEuclidean\u003c/a\u003e) distance. We can use \u003ccode\u003ematchit()\u003c/code\u003e from the \u003cstrong\u003eMatchIt\u003c/strong\u003e library to group students with similar needs. Instead of creating a new grouping variable like we did before for \u003ccode\u003eneeds_camp\u003c/code\u003e, because we know that undergrad GPA and quantitative GRE scores cause needing math camp, and that needing math camp is the only path into actually doing the program, we can model the probability of treatment by using undergrad GPA and quantitative GRE.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(MatchIt)  \u003cspan style=\"color:#75715e\"\u003e# For matching stuff\u003c/span\u003e\n\nmatched \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ematchit\u003c/span\u003e(math_camp \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e undergrad_gpa \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e gre_quant, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e math_camp,\n                   method \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;nearest\u0026#34;\u003c/span\u003e, distance \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;mahalanobis\u0026#34;\u003c/span\u003e, replace \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e)\nmatched\n\n\u003cspan style=\"color:#75715e\"\u003e## \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Call: \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## matchit(formula = math_camp ~ undergrad_gpa + gre_quant, data = math_camp, \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##     method = \u0026#34;nearest\u0026#34;, distance = \u0026#34;mahalanobis\u0026#34;, replace = TRUE)\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Sample sizes:\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##           Control Treated\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## All          1182     818\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Matched       366     818\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Unmatched     816       0\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Discarded       0       0\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eBy matching this way, we found 366 people who didn’t do math camp who look similar to those who did, which means we can arguably say that those who didn’t do it didn’t need to. If we want, we can see which observations were matched:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(matched\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ematch.matrix)\n\n\u003cspan style=\"color:#75715e\"\u003e##    1     \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3  \u0026#34;1864\u0026#34;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 7  \u0026#34;646\u0026#34; \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 9  \u0026#34;586\u0026#34; \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 12 \u0026#34;83\u0026#34;  \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 15 \u0026#34;244\u0026#34; \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 20 \u0026#34;1815\u0026#34;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAnd we can extract the details from the match:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emath_camp_matched \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ematch.data\u003c/span\u003e(matched)\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(math_camp_matched)\n\n\u003cspan style=\"color:#75715e\"\u003e##    id undergrad_gpa gre_verbal gre_quant needs_camp math_camp grade_noise\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3   3      2.828828   161.6843  140.4169       TRUE      TRUE    10.37564\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5   5      3.244684   170.0000  147.9607      FALSE     FALSE    16.40707\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 7   7      3.757950   170.0000  151.4425      FALSE      TRUE    24.01470\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 9   9      3.085583   162.4533  149.3013      FALSE      TRUE    21.00359\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 12 12      3.300517   167.0163  152.7640      FALSE      TRUE    15.10616\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 15 15      3.809366   170.0000  141.3918      FALSE      TRUE    12.68628\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##    final_grade distance   weights\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3     140.2209       NA 1.0000000\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5     142.6853       NA 0.4474328\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 7     162.2392       NA 1.0000000\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 9     155.6245       NA 1.0000000\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 12    152.9133       NA 1.0000000\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 15    145.9059       NA 1.0000000\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe have one new column in this data: \u003ccode\u003eweights\u003c/code\u003e. Observations are now weighted differently based on how distant they are from their matches—observations who attended math camp that are similar to those who didn’t have a higher weight. This weighting creates a pseudo-population of students (i.e. some student observations are more important than others for estimating the causal effect), just like we did with IPW.\u003c/p\u003e\n\u003cp\u003eWe can incorporate these weights into a regression model. Note how we’re using \u003ccode\u003emath_camp\u003c/code\u003e as the only explanatory variable. Because we used matching to guess the likelihood of needing camp (and receiving the program), including the weights should be enough to close the “needs camp” back door:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emodel_matched \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(final_grade \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e math_camp, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e math_camp_matched, weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e weights)\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_matched)\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 2 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term          estimate std.error statistic   p.value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;            \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 (Intercept)      134.      0.338     398.  0.       \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 math_campTRUE     10.0     0.407      24.7 7.68e-109\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAnd look at that! The coefficient for \u003ccode\u003emath_campTRUE\u003c/code\u003e is 10, which is what the true causal effect is.\u003c/p\u003e\n\u003cp\u003eMatching with Mahalanobis distance isn’t the only technique available—depending on the context of your actual data (and how complicated you want to get), you could use other algorithms like coarsened exact matching (CEM), optimal matching, or other techniques included in the \u003cstrong\u003eMatchIt\u003c/strong\u003e package.\u003c/p\u003e\n\u003cp\u003eOne potential downside to matching is that it throws away data. Notice how there are only 1,184 rows in the \u003ccode\u003emath_camp_matched\u003c/code\u003e dataset, while using inverse probability weights let us use the full 2,000 rows in the original data.\u003c/p\u003e\n\u003ch2 id=\"someday-when-im-smarter-do-calculus\"\u003eSomeday when I’m smarter: \u003cem\u003edo\u003c/em\u003e-calculus\u003c/h2\u003e\n\u003cp\u003eFinally, Judea Pearl’s most important contribution to the world of causal inference is a \u003ca href=\"https://plato.stanford.edu/entries/causal-models/do-calculus.html\"\u003ecomplete set of three axioms\u003c/a\u003e (or rules) that allow us to convert equations with a $do(\\cdot)$ operator into something estimatable with observational data.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003eVery\u003c/em\u003e briefly, the \u003cem\u003edo\u003c/em\u003e operator lets us define interventions (like programs and policies) in mathematical formulas. For instance, in our ongoing example, we’re interested in $Pr(\\text{Grade} | do(\\text{Math camp}))$, or the probability distribution of final grades given that someone \u003cem\u003edoes\u003c/em\u003e math camp. Math camp is an intervention, and in a randomized controlled trial, we’d be able to control who got to \u003cem\u003edo\u003c/em\u003e it, and thereby estimate the causal effect.\u003c/p\u003e\n\u003cp\u003eGiven observational data, though, we’re left only with the ability to calculate $Pr(\\text{Grade} | \\text{Math camp})$, or the probability distribution of final grades given math camp. Because there’s no $do(\\cdot)$ here, we can’t isolate the effect entirely if there are confounders like GRE and GPA. We tried that earlier in the “correlation isn’t causation” section and found an incorrect program effect.\u003c/p\u003e\n\u003cp\u003eThe three rules of Pearl’s \u003cem\u003edo\u003c/em\u003e-calculus allows us to chop up causal diagrams in systematic ways that can remove the $do(\\cdot)$. The reason closing backdoors by adjusting for confounders works is because the approach follows one of the \u003cem\u003edo\u003c/em\u003e-calculus rules that removes $do(\\cdot)$ from $Pr(\\text{Grade} | do(\\text{Math camp}))$. For instance (and apologies for using X, Y, and Z instead of actual variables!), in a DAG with one confounder (Z)…\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ebackdoor_dag \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edagify\u003c/span\u003e(Y \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e X \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e Z,\n                       X \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e Z,\n                       exposure \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;X\u0026#34;\u003c/span\u003e,\n                       outcome \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Y\u0026#34;\u003c/span\u003e,\n                       coords \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(X \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e),\n                                     y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(X \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, Z \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e)))\n\n\u003cspan style=\"color:#a6e22e\"\u003eggdag\u003c/span\u003e(backdoor_dag) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etheme_dag\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"do-calculus-tiny-dag-1.png\" alt=\"Tiny XYZ DAG\"\u003e\u003c/p\u003e\n\u003cp\u003e…the \u003cem\u003edo\u003c/em\u003e-calculus version of backdoor adjustment is:\u003c/p\u003e\n\u003cp\u003e$$\nP(Y | do(X)) = \\sum_Z P(Y | X, Z) \\times P(Z)\n$$\u003c/p\u003e\n\u003cp\u003eIn other words, we can remove the $do(\\cdot)$ if we multiply the probability distribution of Y given both X and Z by the probability distribution of Z, and then add all those values up for every value of Z. If X, Y, and Z were all binary, we’d be able to write the $do$-free version of the causal effect like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# P(y|do(x=1)) = P(y|x=1, z=1)*P(z=1) + P(y|x=1, z=0)*P(z=0)\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003emean\u003c/span\u003e(y[x \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e z \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e]) \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emean\u003c/span\u003e(z \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emean\u003c/span\u003e(y[x \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e z \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e]) \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emean\u003c/span\u003e(z \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThere are fancy algorithms that can determine the exact adjustment formula for a given DAG, and the \u003cstrong\u003ecausaleffect\u003c/strong\u003e package lets you use these algorithms in R. Here’s the \u003cem\u003edo\u003c/em\u003e-calculus version of our math camp example. Unfortunately we have to rewrite the DAG with a different syntax for it to work:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(causaleffect)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(igraph)\n\nmath_dag \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egraph.formula\u003c/span\u003e(grade \u003cspan style=\"color:#f92672\"\u003e+-\u003c/span\u003e undergradGPA, \n                          grade \u003cspan style=\"color:#f92672\"\u003e+-\u003c/span\u003e GREquant, \n                          grade \u003cspan style=\"color:#f92672\"\u003e+-\u003c/span\u003e GREverbal,\n                          grade \u003cspan style=\"color:#f92672\"\u003e+-\u003c/span\u003e mathcamp,\n                          mathcamp \u003cspan style=\"color:#f92672\"\u003e+-\u003c/span\u003e GREquant,\n                          mathcamp \u003cspan style=\"color:#f92672\"\u003e+-\u003c/span\u003e undergradGPA,\n                          GREquant \u003cspan style=\"color:#f92672\"\u003e+-\u003c/span\u003e undergradGPA,\n                          GREverbal \u003cspan style=\"color:#f92672\"\u003e+-\u003c/span\u003e undergradGPA,\n                      simplify \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e# plot(math_dag)  # Plot this\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# expr returns a LaTeX formula; simp simplifies the formula through repeated\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# application of the rules of do-calculus\u003c/span\u003e\ndo_calc_formula \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecausal.effect\u003c/span\u003e(y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grade\u0026#34;\u003c/span\u003e, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;mathcamp\u0026#34;\u003c/span\u003e,\n                                 G \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e math_dag, expr \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e, simp \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThis produces the following \u003cem\u003edo\u003c/em\u003e-calculus-based adjustment formula:\u003c/p\u003e\n\u003cdiv style=\"font-size: 60%;\"\u003e\n$$\n\\sum_{GREquant,undergradGPA}P(grade|undergradGPA,GREquant,mathcamp)P(GREquant|undergradGPA)P(undergradGPA)\n$$\n\u003c/div\u003e\n\u003cp\u003eNeat! We still need to adjust for GRE quantitative scores and undergrad GPA, and if we somehow multiply the three probability distributions (final grade given GPA, GRE, and mathcamp, GRE given GPA, and GPA), we’ll have a $do(\\cdot)$-free version of the causal effect.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eUnfortunately I have absolutely no idea how to do this with R.\u003c/strong\u003e Continuous variables blow up the math in \u003cem\u003edo\u003c/em\u003e-calculus equations and I don\u0026rsquo;t know how to deal with that.\u003c/p\u003e\n\u003ch2 id=\"comparison-of-all-methods\"\u003eComparison of all methods\u003c/h2\u003e\n\u003cp\u003ePhew. We just used naive matching, inverse probability weighting, and Mahalanobis matching to estimate the causal effect of a hypothetical math camp program on final grades using only observational data. How’d we do?!\u003c/p\u003e\n\u003cp\u003eHere are all the estimates we have, along with a blue dotted line for the truth. Adjusting for backdoor confounders allows us to get far more accurate and identified causal results than when we leave things unadjusted, and we get the most accurate results when we explicitly attempt to match treated and untreated observations (as with do with the IPW ATO and with Mahalanobis matching). That’s likely not always the case—lots of these methods depend on the relationships between the different nodes in the graph, and it’s possible that they don’t work when there are non-linear relationships.\u003c/p\u003e\n\u003cp\u003eBut in this case, at least, we can prove causation with observational data, which is really neat!\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(ggstance)\n\nall_models \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etribble\u003c/span\u003e(\n  \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003emethod, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003emodel,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Wrong correlation-not-causation\u0026#34;\u003c/span\u003e, model_wrong,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Forbidden needs camp\u0026#34;\u003c/span\u003e, model_adj_needs_camp,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Educated guess needs camp\u0026#34;\u003c/span\u003e, model_adj_needs_camp_guess,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Inverse probability weighting ATE\u0026#34;\u003c/span\u003e, model_ipw_ate,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Inverse probability weighting ATO\u0026#34;\u003c/span\u003e, model_ipw_ato,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Mahalanobis matching\u0026#34;\u003c/span\u003e, model_matched\n) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Extract coefficient for math_camp from each model\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(tidied \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(model, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(., conf.int \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e)),\n         effect \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(tidied, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(., term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;math_campTRUE\u0026#34;\u003c/span\u003e))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eunnest\u003c/span\u003e(effect) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003emodel, \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003etidied) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(method \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_inorder\u003c/span\u003e(method))\n\n\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(all_models, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e estimate, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_rev\u003c/span\u003e(method), color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e method)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_vline\u003c/span\u003e(xintercept \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, linetype \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;dashed\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#0074D9\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_pointrangeh\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(xmin \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e conf.low, xmax \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e conf.high), size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_color_viridis_d\u003c/span\u003e(option \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;plasma\u0026#34;\u003c/span\u003e, end \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.9\u003c/span\u003e, guide \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Causal effect\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, caption \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Dotted line shows true effect\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_light\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"compare-everything-1.png\" alt=\"Comparison of all causal effects\"\u003e\u003c/p\u003e\n",
            "date_published": "2020-02-25T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2020/01/10/makefile-subdirectory-zips/",
            "url": "https://www.shagunjhaver.com/blog/2020/01/10/makefile-subdirectory-zips/",
            "title": "Automatically zip up subdirectories with Make",
            "summary": "Use a Makefile to automatically zip up all subdirectories in a given folder *while also* accounting for dependencies",
            "content_html": "\u003cp\u003e\u003ca href=\"https://github.com/andrewheiss/makefile-subdirectory-zips\"\u003eSee this notebook on GitHub\u003c/a\u003e. You can (and should) download the project from there if you want to follow along and try this out.\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003ca href=\"#tldr-final-makefile\"\u003etl;dr: Skip to the completed example.\u003c/a\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eI use \u003ca href=\"https://bookdown.org/yihui/blogdown\"\u003e\u003cstrong\u003eblogdown\u003c/strong\u003e\u003c/a\u003e to generate the websites for \u003ca href=\"https://www.andrewheiss.com/teaching/\"\u003eall the courses I teach\u003c/a\u003e, and it’s delightful to not have to worry about databases and server configurations. I use a \u003ca href=\"https://www.gnu.org/software/make/\"\u003e\u003ccode\u003eMakefile\u003c/code\u003e\u003c/a\u003e to run the requisite commands with \u003ccode\u003emake deploy\u003c/code\u003e, which creates a magical incantation: R, \u003ca href=\"https://bookdown.org/yihui/blogdown\"\u003e\u003cstrong\u003eblogdown\u003c/strong\u003e\u003c/a\u003e, and \u003ca href=\"https://gohugo.io/\"\u003eHugo\u003c/a\u003e parse \u003ca href=\"https://rmarkdown.rstudio.com/\"\u003eR Markdown\u003c/a\u003e files and generate a complete HTML site, which then gets synced \u003ca href=\"https://evalsp20.classes.andrewheiss.com/\"\u003eto my server\u003c/a\u003e, all with minimal input from me.\u003c/p\u003e\n\u003cp\u003eThere are occasional points of friction, though. One that I’ve suffered through for the past few years is the creation and distribution of zipped files. I teach students R, and R projects rarely consist of a single file. To make it easier to distribute problem sets and projects to students, I zip these subfolders into single files like \u003ccode\u003eproblem_set_1.zip\u003c/code\u003e, so they just have to download one thing. Creating \u003ccode\u003e.zip\u003c/code\u003e files on macOS is trivial—right click on a folder, choose “Compress {foldername}”, and you’re done.\u003c/p\u003e\n\u003cp\u003eBut it’s tedious when you have lots of folders to zip, and even more tedious to remember to rezip folders where you’ve made changes. SO MANY TIMES I’ve fixed errors in R scripts or data but then have forgotten to rezip the project, and students end up downloading the uncorrected version of projects. Moreover, macOS includes hidden \u003ccode\u003e.DS_Store\u003c/code\u003e files when it zips up folders, and R and RStudio create their own invisible files and folders, like \u003ccode\u003e.Rhistory\u003c/code\u003e and \u003ccode\u003e.Rproj.user/\u003c/code\u003e. To avoid shipping these out to students, I typically go to the terminal, manually delete the unwanted invisible files, and \u003cem\u003ethen\u003c/em\u003e zip up the directory. But once again, I regularly forget to do this and end up including unwanted files.\u003c/p\u003e\n\u003cp\u003eI figured that since I’m already using a \u003ccode\u003eMakefile\u003c/code\u003e to generate and upload the course website, I’d try to use the magical power of Make to automatically zip up project folders as I build the site \u003cem\u003eand\u003c/em\u003e update them only if there are any changes. And it turns out that it’s possible, though the end result looks really cryptic (as do all \u003ccode\u003eMakefiles\u003c/code\u003e, really).\u003c/p\u003e\n\u003cp\u003eWhat follows here is a step-by-step didactic explanation of how I built a set of \u003ccode\u003eMakefile\u003c/code\u003e recipes to automatically zip up all the directories within a given directory, excluding invisible files (i.e. any file or directory that begins with a \u003ccode\u003e.\u003c/code\u003e), and only zipping up directories that have been modified since the last time Make was run. \u003ca href=\"#tldr-final-makefile\"\u003eYou can also skip to the end to see the finished \u003ccode\u003eMakefile\u003c/code\u003e.\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"folder-structure\"\u003eFolder structure\u003c/h2\u003e\n\u003cp\u003eThe example here assumes the project subdirectories live in a folder called \u003ccode\u003estatic/projects/\u003c/code\u003e, since that mimics \u003cstrong\u003eblogdown\u003c/strong\u003e/Hugo (any files in the \u003ccode\u003estatic/\u003c/code\u003e directory do not get processed by knitr when you build the site). Here’s the example folder structure with three problem set projects:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003estatic\n└── projects\n    ├── problem_set_1\n    │   ├── data\n    │   │   └── stuff.csv\n    │   ├── problem_set_1.Rproj\n    │   └── work.Rmd\n    ├── problem_set_2\n    │   ├── data\n    │   │   └── other_stuff.csv\n    │   ├── problem_set_2.Rproj\n    │   └── work.Rmd\n    └── problem_set_3\n        ├── code.R\n        ├── data\n        │   └── more_stuff.csv\n        ├── problem_set_3.Rproj\n        └── work.Rmd\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIn the end, what I want is something like this, with \u003ccode\u003e.zip\u003c/code\u003e files for each of the problem set folders (starred):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003estatic\n└── projects\n    ├── problem_set_1\n    │   ├── data\n    │   │   └── stuff.csv\n    │   ├── problem_set_1.Rproj\n    │   └── work.Rmd\n    ├── ⭐️ problem_set_1.zip\n    ├── problem_set_2\n    │   ├── data\n    │   │   └── other_stuff.csv\n    │   ├── problem_set_2.Rproj\n    │   └── work.Rmd\n    ├── ⭐️ problem_set_2.zip\n    ├── problem_set_3\n    │   ├── code.R\n    │   ├── data\n    │   │   └── more_stuff.csv\n    │   ├── problem_set_3.Rproj\n    │   └── work.Rmd\n    └── ⭐️ problem_set_3.zip\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"basic-approach\"\u003eBasic approach\u003c/h2\u003e\n\u003cp\u003eThe basic syntax for \u003ccode\u003eMakefile\u003c/code\u003e recipes is fairly simple:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-make\" data-lang=\"make\"\u003e\u003cspan style=\"color:#a6e22e\"\u003efile_to_create\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e dependencies\n    stuff to run to create file using dependencies\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIf I want to create a zipped file of one problem set project, I can add this to a file named \u003ccode\u003eMakefile\u003c/code\u003e (no extension), and then run \u003ccode\u003emake static/projects/problem_set_1.zip\u003c/code\u003e from the terminal:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-make\" data-lang=\"make\"\u003e\u003cspan style=\"color:#a6e22e\"\u003estatic/projects/problem_set_1.zip\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\n    zip -r static/projects/problem_set_1.zip static/projects/problem_set_1\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe \u003ccode\u003e-r\u003c/code\u003e flag means that all subdirectories in \u003ccode\u003estatic/projects/problem_set_1\u003c/code\u003e will be included. If I type \u003ccode\u003emake static/projects/problem_set_1.zip\u003c/code\u003e from the terminal, it should compress the folder and all its subfolders into a single \u003ccode\u003e.zip\u003c/code\u003e file.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u0026gt; make static/projects/problem_set_1.zip\n\nzip -r static/projects/problem_set_1.zip static/projects/problem_set_1\n  adding: static/projects/problem_set_1/ (stored 0%)\n  adding: static/projects/problem_set_1/work.Rmd (stored 0%)\n  adding: static/projects/problem_set_1/.DS_Store (deflated 97%)\n  adding: static/projects/problem_set_1/problem_set_1.Rproj (deflated 28%)\n  adding: static/projects/problem_set_1/data/ (stored 0%)\n  adding: static/projects/problem_set_1/data/stuff.csv (stored 0%)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"problems-with-the-basic-approach\"\u003eProblems with the basic approach\u003c/h2\u003e\n\u003cp\u003eHowever, there are a few issues:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eIf I run this again, \u003ccode\u003ezip\u003c/code\u003e will add files to the \u003ccode\u003e.zip\u003c/code\u003e. If any were deleted from the actual folder, they’ll stay inside the \u003ccode\u003e.zip\u003c/code\u003e file (i.e. the folder and the \u003ccode\u003e.zip\u003c/code\u003e file won’t be synchronized).\u003c/li\u003e\n\u003cli\u003eThis will include files and folders that begin with \u003ccode\u003e.\u003c/code\u003e (like \u003ccode\u003e.Rhistory\u003c/code\u003e and \u003ccode\u003e.Rproj.user/\u003c/code\u003e), and I don’t want those.\u003c/li\u003e\n\u003cli\u003eThe command will include all the parent folders in the zipped file. After I extract it, the actual files will be nested inside \u003ccode\u003estatic/projects/\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eThere are no dependencies, so this will happen every time I run \u003ccode\u003emake static/projects/problem_set_1.zip\u003c/code\u003e, even if nothing changed.\u003c/li\u003e\n\u003cli\u003eThis is for a single target only. In theory, I’d need to manually add separate entries for each folder in \u003ccode\u003estatic/projects\u003c/code\u003e, and that’s tedious.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"tweaking-the-zip-recipe\"\u003eTweaking the \u003ccode\u003ezip\u003c/code\u003e recipe\u003c/h2\u003e\n\u003cp\u003eWe can fix the first two issues with some adjustments to the \u003ccode\u003ezip\u003c/code\u003e command. Adding the \u003ccode\u003e-FS\u003c/code\u003e flag (\u003cem\u003ef\u003c/em\u003eile \u003cem\u003es\u003c/em\u003eync) will ensure that \u003ccode\u003ezip\u003c/code\u003e syncs the files between the source directory and the zipped files, and including the \u003ccode\u003e-x\u003c/code\u003e flag allows us to exclude patterns of files from the zipped file. Doing this will both sync files and exclude files/folders with a \u003ccode\u003e.\u003c/code\u003e prefix:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-make\" data-lang=\"make\"\u003e\u003cspan style=\"color:#a6e22e\"\u003estatic/projects/problem_set_1.zip\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\n    zip -FSr static/projects/problem_set_1.zip static/projects/problem_set_1 -x static/projects/problem_set_1/.\u003cspan style=\"color:#ae81ff\"\u003e\\*\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u0026gt; make static/projects/problem_set_1.zip\n\nzip -FSr static/projects/problem_set_1.zip static/projects/problem_set_1 -x static/projects/problem_set_1/.\\*\n  adding: static/projects/problem_set_1/ (stored 0%)\n  adding: static/projects/problem_set_1/work.Rmd (stored 0%)\n  adding: static/projects/problem_set_1/problem_set_1.Rproj (deflated 28%)\n  adding: static/projects/problem_set_1/data/ (stored 0%)\n  adding: static/projects/problem_set_1/data/stuff.csv (stored 0%)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe third issue with parent folders can’t be solved directly with \u003ccode\u003ezip\u003c/code\u003e. The problem occurs because we’re running \u003ccode\u003emake\u003c/code\u003e from the root of the project, so it’s including the whole nested file structure. To solve this, we can have \u003ccode\u003emake\u003c/code\u003e navigate to \u003ccode\u003estatic/projects\u003c/code\u003e before zipping anything, which then simplifies the filenames in the command:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-make\" data-lang=\"make\"\u003e\u003cspan style=\"color:#a6e22e\"\u003estatic/projects/problem_set_1.zip\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\n    cd static/projects \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e zip -FSr problem_set_1.zip problem_set_1 -x problem_set_1/.\u003cspan style=\"color:#ae81ff\"\u003e\\*\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u0026gt; make static/projects/problem_set_1.zip\n\ncd static/projects \u0026amp;\u0026amp; zip -FSr problem_set_1.zip problem_set_1 -x problem_set_1/.\\*\n  adding: problem_set_1/ (stored 0%)\n  adding: problem_set_1/work.Rmd (stored 0%)\n  adding: problem_set_1/problem_set_1.Rproj (deflated 28%)\n  adding: problem_set_1/data/ (stored 0%)\n  adding: problem_set_1/data/stuff.csv (stored 0%)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNo more nested parent folders!\u003c/p\u003e\n\u003ch2 id=\"adding-dependencies\"\u003eAdding dependencies\u003c/h2\u003e\n\u003cp\u003eRight now, there are no dependencies, which means that \u003ccode\u003emake\u003c/code\u003e will run \u003ccode\u003ezip\u003c/code\u003e regardless of whether it needs to. Even if nothing is changed in the \u003ccode\u003eproblem_set_1\u003c/code\u003e folder, a new \u003ccode\u003e.zip\u003c/code\u003e file will get created (and it’ll get reuploaded to the server because it’ll have a new creation date, which means there will be a lot of unnecessary uploading of potentially large files).\u003c/p\u003e\n\u003cp\u003eNormally, we’d have to define dependencies like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-make\" data-lang=\"make\"\u003e\u003cspan style=\"color:#a6e22e\"\u003estatic/projects/problem_set_1.zip\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e {DEPENDENT FILES}\n    cd static/projects \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e zip -FSr problem_set_1.zip problem_set_1 -x problem_set_1/.\u003cspan style=\"color:#ae81ff\"\u003e\\*\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThere’s no way to use a folder as a dependency, which means we need to list all the possible files in the project:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-make\" data-lang=\"make\"\u003e\u003cspan style=\"color:#a6e22e\"\u003estatic/projects/problem_set_1.zip\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e static/projects/problem_set_1/work.Rmd static/projects/problem_set_1/problem_set_1.Rproj static/projects/problem_set_1/data/stuff.csv\n    cd static/projects \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e zip -FSr problem_set_1.zip problem_set_1 -x problem_set_1/.\u003cspan style=\"color:#ae81ff\"\u003e\\*\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAnd that’s horrifically long and awful.\u003c/p\u003e\n\u003cp\u003eInstead of manually typing out all the dependencies, we can use a little \u003ccode\u003ebash\u003c/code\u003e trick to get a list of all the files in the folder and generate the list of dependencies using \u003ca href=\"https://www.gnu.org/software/make/manual/html_node/Shell-Function.html\"\u003e\u003ccode\u003e$(shell ...)\u003c/code\u003e\u003c/a\u003e. To see this in action more easily, it’s helpful to assign this shell command to a variable and create a new temporary target to show it\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-make\" data-lang=\"make\"\u003eFILES_IN_FOLDER \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003eshell find static/projects/problem_set_1 -type f\u003cspan style=\"color:#66d9ef\"\u003e)\u003c/span\u003e\n\n\u003cspan style=\"color:#a6e22e\"\u003edebug\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\n    @echo \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003eFILES_IN_FOLDER\u003cspan style=\"color:#66d9ef\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNow if you run \u003ccode\u003emake debug\u003c/code\u003e, you should see a list of all the files in the given folder (since that list was stored as \u003ccode\u003eFILES_IN_FOLDER\u003c/code\u003e; the \u003ccode\u003e@\u003c/code\u003e in front of \u003ccode\u003eecho\u003c/code\u003e suppresses the actual call to \u003ccode\u003eecho\u003c/code\u003e, so you should just see the output of the command).\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u0026gt; make debug\n\nstatic/projects/problem_set_1/work.Rmd static/projects/problem_set_1/.DS_Store static/projects/problem_set_1/problem_set_1.Rproj static/projects/problem_set_1/data/stuff.csv\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eYou might see that it found invisible files like \u003ccode\u003estatic/projects/problem_set_1/.DS_Store\u003c/code\u003e. We don’t want to include those as dependencies (especially files in \u003ccode\u003e.Rproj.user\u003c/code\u003e, since those get modified every time you do anything in RStudio), so we can modify the \u003ccode\u003efind\u003c/code\u003e command to exclude files that start with \u003ccode\u003e.\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-make\" data-lang=\"make\"\u003eFILES_IN_FOLDER \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003eshell find static/projects/problem_set_1 -type f ! -path \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;static/projects/problem_set_1/.*\u0026#34;\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003e)\u003c/span\u003e\n\n\u003cspan style=\"color:#a6e22e\"\u003edebug\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\n    @echo \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003eFILES_IN_FOLDER\u003cspan style=\"color:#66d9ef\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u0026gt; make debug\n\nstatic/projects/problem_set_1/work.Rmd static/projects/problem_set_1/problem_set_1.Rproj static/projects/problem_set_1/data/stuff.csv\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWith that \u003ccode\u003e$(shell ...)\u003c/code\u003e magic working, we can include it in the recipe as a dependency:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-make\" data-lang=\"make\"\u003e\u003cspan style=\"color:#a6e22e\"\u003estatic/projects/problem_set_1.zip\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003eshell find static/projects/problem_set_1 -type f ! -path \u0026#34;static/projects/problem_set_1/.*\u0026#34;\u003cspan style=\"color:#66d9ef\"\u003e)\u003c/span\u003e\n    cd static/projects \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e zip -FSr problem_set_1.zip problem_set_1 -x problem_set_1/.\u003cspan style=\"color:#ae81ff\"\u003e\\*\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eHOWEVER, this still won’t quite work. Put simply (and likely incorrectly, but it makes sense) \u003ccode\u003emake\u003c/code\u003e expands \u003ccode\u003e$()\u003c/code\u003e variables after it determines dependency rules, so it will treat \u003ccode\u003e$(shell ...)\u003c/code\u003e like an actual dependency instead of treating the \u003cem\u003eoutput\u003c/em\u003e of \u003ccode\u003e$(shell ...)\u003c/code\u003e as dependencies. To get around this, we can enable \u003ca href=\"http://www.gnu.org/software/make/manual/make.html#Secondary-Expansion\"\u003esecondary expansion\u003c/a\u003e (\u003ca href=\"https://stackoverflow.com/a/21950971/120898\"\u003esee also\u003c/a\u003e), which delays the creation of dependency rules until after \u003ccode\u003e$(shell ...)\u003c/code\u003e is run. To enable it, include \u003ccode\u003e.SECONDEXPANSION:\u003c/code\u003e somewhere and then use \u003ccode\u003e$$()\u003c/code\u003e instead of \u003ccode\u003e$()\u003c/code\u003e when expanding variables:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-make\" data-lang=\"make\"\u003e\u003cspan style=\"color:#a6e22e\"\u003e.SECONDEXPANSION\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\n\n\u003cspan style=\"color:#a6e22e\"\u003estatic/projects/problem_set_1.zip\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e $\u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003eshell find static/projects/problem_set_1 -type f ! -path \u0026#34;static/projects/problem_set_1/.*\u0026#34;\u003cspan style=\"color:#66d9ef\"\u003e)\u003c/span\u003e\n    cd static/projects \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e zip -FSr problem_set_1.zip problem_set_1 -x problem_set_1/.\u003cspan style=\"color:#ae81ff\"\u003e\\*\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u0026gt; make static/projects/problem_set_1.zip\n\ncd static/projects \u0026amp;\u0026amp; zip -FSr problem_set_1.zip problem_set_1 -x problem_set_1/.\\*\n  adding: problem_set_1/ (stored 0%)\n  adding: problem_set_1/work.Rmd (stored 0%)\n  adding: problem_set_1/problem_set_1.Rproj (deflated 28%)\n  adding: problem_set_1/data/ (stored 0%)\n  adding: problem_set_1/data/stuff.csv (stored 0%)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003ePhew. Now all the non-invisible files inside \u003ccode\u003eproblem_set_1/\u003c/code\u003e are dependencies. If I run it again without changing anything, nothing should get zipped:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u0026gt; make static/projects/problem_set_1.zip\n\nmake: `static/projects/problem_set_1.zip\u0026#39; is up to date.\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"automatic-variables\"\u003eAutomatic variables\u003c/h2\u003e\n\u003cp\u003eEverything’s working great so far! We’ve addressed \u003ca href=\"#problems-with-the-basic-approach\"\u003ethe first 4 of the 5 issues we found before\u003c/a\u003e. The only thing we have left is automating this so we don’t have to make another target recipe for \u003ccode\u003estatic/projects/problem_set_2.zip\u003c/code\u003e and \u003ccode\u003estatic/projects/problem_set_3.zip\u003c/code\u003e and so on. In the end, we want to be able to type \u003ccode\u003emake zip_projects\u003c/code\u003e and have \u003ccode\u003emake\u003c/code\u003e compress each of the subfolders automatically, based on changes in dependencies. To do this, we can use \u003ca href=\"http://www.gnu.org/software/make/manual/html_node/Automatic-Variables.html\"\u003eautomatic variables\u003c/a\u003e (\u003ca href=\"https://stackoverflow.com/a/3220288/120898\"\u003esee also\u003c/a\u003e) to generate targets on the fly. Here’s how we do this.\u003c/p\u003e\n\u003cp\u003eFirst, we can generate a list of all the subdirectories we want to compress, and then modify that list so that it becomes a list of all the targets we want to create (i.e. \u003ccode\u003eproblem_set_1.zip\u003c/code\u003e, \u003ccode\u003eproblem_set_2.zip\u003c/code\u003e, and so on). We’ll use some built-in \u003ccode\u003emake\u003c/code\u003e functions for manipulating text and searching for files to create some variables. Again, it’s easiest to see what these variables actually are if you create a temporary target like debug. Check the documentation for \u003ca href=\"https://www.gnu.org/software/make/manual/html_node/Text-Functions.html\"\u003e\u003ccode\u003e$(filter ...)\u003c/code\u003e\u003c/a\u003e, \u003ca href=\"https://www.gnu.org/software/make/manual/html_node/File-Name-Functions.html\"\u003e\u003ccode\u003e$(wildcard ...)\u003c/code\u003e\u003c/a\u003e, \u003ca href=\"https://www.gnu.org/software/make/manual/html_node/Text-Functions.html\"\u003e\u003ccode\u003e$(patsubst ...)\u003c/code\u003e\u003c/a\u003e, and \u003ca href=\"https://www.gnu.org/software/make/manual/html_node/File-Name-Functions.html\"\u003e\u003ccode\u003e$(addsuffix ...)\u003c/code\u003e\u003c/a\u003e for more details about what these functions do.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-make\" data-lang=\"make\"\u003eTO_ZIP_DIRS \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003efilter %/, \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003ewildcard static/projects/*/\u003cspan style=\"color:#66d9ef\"\u003e))\u003c/span\u003e  \u003cspan style=\"color:#75715e\"\u003e# Find all directories in static/projects\u003c/span\u003e\nTO_ZIP_NAMES \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003epatsubst %/,%,\u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003eTO_ZIP_DIRS\u003cspan style=\"color:#66d9ef\"\u003e))\u003c/span\u003e  \u003cspan style=\"color:#75715e\"\u003e# Remove trailing /\u003c/span\u003e\nZIP_TARGETS \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003eaddsuffix .zip,\u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003eTO_ZIP_NAMES\u003cspan style=\"color:#66d9ef\"\u003e))\u003c/span\u003e  \u003cspan style=\"color:#75715e\"\u003e# Add .zip\u003c/span\u003e\n\n\u003cspan style=\"color:#a6e22e\"\u003edebug\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\n    @echo \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003eTO_ZIP_DIRS\u003cspan style=\"color:#66d9ef\"\u003e)\u003c/span\u003e\n    @echo \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003eTO_ZIP_NAMES\u003cspan style=\"color:#66d9ef\"\u003e)\u003c/span\u003e\n    @echo \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003eZIP_TARGETS\u003cspan style=\"color:#66d9ef\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u0026gt; make debug\n\nstatic/projects/problem_set_1/ static/projects/problem_set_2/ static/projects/problem_set_3/\nstatic/projects/problem_set_1 static/projects/problem_set_2 static/projects/problem_set_3\nstatic/projects/problem_set_1.zip static/projects/problem_set_2.zip static/projects/problem_set_3.zip\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNeat. \u003ccode\u003e$(ZIP_TARGETS)\u003c/code\u003e now has a list of zipped files that we want to create. We can use that list as an actual target in a recipe. For now, we’ll just use \u003ccode\u003eecho\u003c/code\u003e so we can see what’s going on with the variable names. Note how I created a new target called \u003ccode\u003ezip_projects\u003c/code\u003e—this is what we’ll actually run in the terminal. It will look at the list in \u003ccode\u003e$(ZIP_TARGETS)\u003c/code\u003e and run the appropriate recipe for each one (which for now means it’ll just print the name of the file). Also notice the \u003ccode\u003e$@\u003c/code\u003e. This represents the name of the target that is passed to the recipe. Run \u003ccode\u003emake zip_projects\u003c/code\u003e and you should see a list of future filenames:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-make\" data-lang=\"make\"\u003e\u003cspan style=\"color:#a6e22e\"\u003e$(ZIP_TARGETS)\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\n    @echo $@\n\n\u003cspan style=\"color:#a6e22e\"\u003ezip_projects\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003eZIP_TARGETS\u003cspan style=\"color:#66d9ef\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u0026gt; make zip_projects\n\nstatic/projects/problem_set_1.zip\nstatic/projects/problem_set_2.zip\nstatic/projects/problem_set_3.zip\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNext we need to modify the big hairy \u003ccode\u003ecd static/projects \u0026amp;\u0026amp; zip -FSr problem_set_1.zip problem_set_1 -x problem_set_1/.\\*\u003c/code\u003e command to use the automatic names in \u003ccode\u003e$(ZIP_TARGETS)\u003c/code\u003e. We have access to the full target name (\u003ccode\u003estatic/projects/problem_set_1.zip\u003c/code\u003e) as the special \u003ccode\u003e$@\u003c/code\u003e variable. We can use other built-in functions to extract pieces of that string. Specifically, we need these things:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003estatic/projects\u003c/code\u003e, or the level below the base name of the future \u003ccode\u003e.zip\u003c/code\u003e file\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eproblem_set_1.zip\u003c/code\u003e, or the parent-directory-less name of the future \u003ccode\u003e.zip\u003c/code\u003e file\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eproblem_set_1\u003c/code\u003e, or the parent-directory-less and extension-less name of the future \u003ccode\u003e.zip\u003c/code\u003e file\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eWe can extract each of those with different \u003ca href=\"https://www.gnu.org/software/make/manual/html_node/File-Name-Functions.html\"\u003efile name functions\u003c/a\u003e:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e$(basename $@)\u003c/code\u003e will lead to \u003ccode\u003estatic/projects/problem_set_1\u003c/code\u003e. We can navigate to this folder with \u003ccode\u003ecd\u003c/code\u003e and then move back a level with \u003ccode\u003e..\u003c/code\u003e to get \u003ccode\u003estatic/projects\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e$(notdir $@)\u003c/code\u003e will lead to \u003ccode\u003eproblem_set_1.zip\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e$(notdir $(basename $@))\u003c/code\u003e will lead to \u003ccode\u003eproblem_set_1\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eYou can check all these by adding them to the recipe temporarily:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-make\" data-lang=\"make\"\u003e\u003cspan style=\"color:#a6e22e\"\u003e$(ZIP_TARGETS)\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\n    @echo $@\n    @echo \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003ebasename $@\u003cspan style=\"color:#66d9ef\"\u003e)\u003c/span\u003e\n    @echo \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003enotdir $@\u003cspan style=\"color:#66d9ef\"\u003e)\u003c/span\u003e\n    @echo \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003enotdir \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003ebasename $@\u003cspan style=\"color:#66d9ef\"\u003e))\u003c/span\u003e\n\n\u003cspan style=\"color:#a6e22e\"\u003ezip_projects\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003eZIP_TARGETS\u003cspan style=\"color:#66d9ef\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u0026gt; make zip_projects\n\nstatic/projects/problem_set_1.zip\nstatic/projects/problem_set_1\nproblem_set_1.zip\nproblem_set_1\nstatic/projects/problem_set_2.zip\nstatic/projects/problem_set_2\nproblem_set_2.zip\nproblem_set_2\nstatic/projects/problem_set_3.zip\nstatic/projects/problem_set_3\nproblem_set_3.zip\nproblem_set_3\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWith all those pieces of filenames, we can replace the hardcoded values of our hairy \u003ccode\u003ezip\u003c/code\u003e command with automatic versions:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-make\" data-lang=\"make\"\u003e\u003cspan style=\"color:#a6e22e\"\u003e$(ZIP_TARGETS)\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\n    cd \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003ebasename $@\u003cspan style=\"color:#66d9ef\"\u003e)\u003c/span\u003e/.. \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e zip -FSr \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003enotdir $@\u003cspan style=\"color:#66d9ef\"\u003e)\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003enotdir \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003ebasename $*\u003cspan style=\"color:#66d9ef\"\u003e))\u003c/span\u003e -x \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003enotdir \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003ebasename $*\u003cspan style=\"color:#66d9ef\"\u003e))\u003c/span\u003e/.\u003cspan style=\"color:#ae81ff\"\u003e\\*\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u0026gt; make zip_projects\n\ncd static/projects/problem_set_1/.. \u0026amp;\u0026amp; zip -FSr problem_set_1.zip problem_set_1 -x problem_set_1/.\\*\n  adding: problem_set_1/ (stored 0%)\n  adding: problem_set_1/work.Rmd (stored 0%)\n  adding: problem_set_1/problem_set_1.Rproj (deflated 28%)\n  adding: problem_set_1/data/ (stored 0%)\n  adding: problem_set_1/data/stuff.csv (stored 0%)\ncd static/projects/problem_set_2/.. \u0026amp;\u0026amp; zip -FSr problem_set_2.zip problem_set_2 -x problem_set_2/.\\*\n  adding: problem_set_2/ (stored 0%)\n  adding: problem_set_2/work.Rmd (stored 0%)\n  adding: problem_set_2/problem_set_2.Rproj (deflated 28%)\n  adding: problem_set_2/data/ (stored 0%)\n  adding: problem_set_2/data/other_stuff.csv (stored 0%)\ncd static/projects/problem_set_3/.. \u0026amp;\u0026amp; zip -FSr problem_set_3.zip problem_set_3 -x problem_set_3/.\\*\n  adding: problem_set_3/ (stored 0%)\n  adding: problem_set_3/work.Rmd (stored 0%)\n  adding: problem_set_3/code.R (stored 0%)\n  adding: problem_set_3/problem_set_3.Rproj (deflated 28%)\n  adding: problem_set_3/data/ (stored 0%)\n  adding: problem_set_3/data/more_stuff.csv (stored 0%)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eHoly moly! It zipped each individual folder! We’re almost done! The only thing we’re missing is dependencies—right now, if we run this again, it’ll rezip everything again, which we don’t want. We need to add our \u003ccode\u003e$$(shell ..)\u003c/code\u003e incantation as a dependency, but we need to make it specific to each target: i.e. it needs to generate a list of dependent files for each of the future zip files (only the contents of \u003ccode\u003eproblem_set_1\u003c/code\u003e when making \u003ccode\u003eproblem_set_1.zip\u003c/code\u003e, etc.). To make that work, we can use a \u003ccode\u003e%\u003c/code\u003e wildcard in the dependency definition:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-make\" data-lang=\"make\"\u003e\u003cspan style=\"color:#a6e22e\"\u003e$(ZIP_TARGETS)\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e %.zip : $\u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003eshell find % -type f ! -path \u0026#34;%/.*\u0026#34;\u003cspan style=\"color:#66d9ef\"\u003e)\u003c/span\u003e\n    cd \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003ebasename $@\u003cspan style=\"color:#66d9ef\"\u003e)\u003c/span\u003e/.. \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e zip -FSr \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003enotdir $@\u003cspan style=\"color:#66d9ef\"\u003e)\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003enotdir \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003ebasename $@\u003cspan style=\"color:#66d9ef\"\u003e))\u003c/span\u003e -x \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003enotdir \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003ebasename $@\u003cspan style=\"color:#66d9ef\"\u003e))\u003c/span\u003e/.\u003cspan style=\"color:#ae81ff\"\u003e\\*\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIf we manually delete any zipped files and run \u003ccode\u003emake zip_projects\u003c/code\u003e, it’ll generate them as expected. Where this is magical, though, is if I edit one of the files (like \u003ccode\u003eword.Rmd\u003c/code\u003e in \u003ccode\u003eproblem_set_1\u003c/code\u003e) and then rerun \u003ccode\u003emake zip_projects\u003c/code\u003e, it will \u003cem\u003eonly\u003c/em\u003e rezip that project:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e\u0026gt; make zip_projects\n\ncd static/projects/problem_set_1/.. \u0026amp;\u0026amp; zip -FSr problem_set_1.zip problem_set_1 -x problem_set_1/.\\*\nupdating: problem_set_1/work.Rmd (stored 0%)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAnd that’s it! We’re done!\u003c/p\u003e\n\u003cp\u003eThe final recipe is \u003cem\u003eextraordinarily\u003c/em\u003e cryptic, but because we built it up slowly, we should know what each of the pieces (\u003ccode\u003e$@\u003c/code\u003e, \u003ccode\u003e%\u003c/code\u003e, \u003ccode\u003e$(ZIP_TARGETS)\u003c/code\u003e, \u003ccode\u003e$(basename $@)\u003c/code\u003e, etc.) are.\u003c/p\u003e\n\u003ch3 id=\"tldr-final-makefile\"\u003etl;dr final \u003ccode\u003eMakefile\u003c/code\u003e\u003c/h3\u003e\n\u003cp\u003eHere’s the complete final \u003ccode\u003eMakefile\u003c/code\u003e without all the intermediate steps:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-make\" data-lang=\"make\"\u003eTO_ZIP_DIRS \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003efilter %/, \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003ewildcard static/projects/*/\u003cspan style=\"color:#66d9ef\"\u003e))\u003c/span\u003e  \u003cspan style=\"color:#75715e\"\u003e# Find all directories in static/projects\u003c/span\u003e\nTO_ZIP_NAMES \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003epatsubst %/,%,\u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003eTO_ZIP_DIRS\u003cspan style=\"color:#66d9ef\"\u003e))\u003c/span\u003e  \u003cspan style=\"color:#75715e\"\u003e# Remove trailing /\u003c/span\u003e\nZIP_TARGETS \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003eaddsuffix .zip,\u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003eTO_ZIP_NAMES\u003cspan style=\"color:#66d9ef\"\u003e))\u003c/span\u003e  \u003cspan style=\"color:#75715e\"\u003e# Add .zip\u003c/span\u003e\n\n\u003cspan style=\"color:#a6e22e\"\u003e.SECONDEXPANSION\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\n\n\u003cspan style=\"color:#a6e22e\"\u003e$(ZIP_TARGETS)\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e %.zip : $\u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003eshell find % -type f ! -path \u0026#34;%/.*\u0026#34;\u003cspan style=\"color:#66d9ef\"\u003e)\u003c/span\u003e\n    cd \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003ebasename $@\u003cspan style=\"color:#66d9ef\"\u003e)\u003c/span\u003e/.. \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u0026amp;\u003c/span\u003e zip -FSr \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003enotdir $@\u003cspan style=\"color:#66d9ef\"\u003e)\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003enotdir \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003ebasename $@\u003cspan style=\"color:#66d9ef\"\u003e))\u003c/span\u003e -x \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003enotdir \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003ebasename $@\u003cspan style=\"color:#66d9ef\"\u003e))\u003c/span\u003e/.\u003cspan style=\"color:#ae81ff\"\u003e\\*\u003c/span\u003e\n\n\u003cspan style=\"color:#a6e22e\"\u003ezip_projects\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003e$(\u003c/span\u003eZIP_TARGETS\u003cspan style=\"color:#66d9ef\"\u003e)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eYou can incorporate this into any other \u003ccode\u003eMakefile\u003c/code\u003e, \u003ca href=\"https://github.com/andrewheiss/evalsp20.classes.andrewheiss.com/blob/master/Makefile\"\u003elike this one that I use for building a course website\u003c/a\u003e. There, the \u003ccode\u003ezip_projects\u003c/code\u003e target is a dependency of the \u003ccode\u003ebuild\u003c/code\u003e target, so I just have to run \u003ccode\u003emake build\u003c/code\u003e to automatically zip everything up \u003cem\u003eand\u003c/em\u003e build the site with \u003cstrong\u003eblogdown\u003c/strong\u003e.\u003c/p\u003e\n\u003cp\u003ePerfection. Any subfolder in \u003ccode\u003estatic/projects/\u003c/code\u003e will automatically be zipped up with no input from me. No more accidentally forgetting to zip up things or include invisible files!\u003c/p\u003e\n",
            "date_published": "2020-01-10T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2020/01/01/flexdashboard-dynamic-data/",
            "url": "https://www.shagunjhaver.com/blog/2020/01/01/flexdashboard-dynamic-data/",
            "title": "Create a dynamic dashboard with R, flexdashboard, and Shiny",
            "summary": "Use R Markdown, flexdashboard, and Shiny to create a dashboard that automatically loads data from a Google Sheet",
            "content_html": "\u003cp\u003eNow that I\u0026rsquo;m on the tenure track, I\u0026rsquo;ve been looking for a way to keep track of my different research projects so I can get them all finished and published. \u003ca href=\"https://doi.org/10.1017/S1049096516000160\"\u003eMatt Lebo\u0026rsquo;s \u0026ldquo;Managing Your Research Pipeline\u0026rdquo;\u003c/a\u003e presents a neat way of quantifying and tracking the progress of your research, and I recently adopted it for my own stuff. I even made a fancy \u003ca href=\"https://rmarkdown.rstudio.com/\"\u003eR Markdown\u003c/a\u003e + \u003ca href=\"https://rmarkdown.rstudio.com/flexdashboard/\"\u003e\u003cstrong\u003eflexdashboard\u003c/strong\u003e\u003c/a\u003e \u003ca href=\"https://twitter.com/andrewheiss/status/1201892963451842562\"\u003edashboard to show the status of the pipeline\u003c/a\u003e interactively. I manage the data for the dashboard in a Google Sheet, knit the dashboard, and create an HTML file with the latest statistics.\u003c/p\u003e\n\u003cp\u003eThe combination of \u003ca href=\"https://rmarkdown.rstudio.com/\"\u003eR Markdown\u003c/a\u003e + \u003ca href=\"https://rmarkdown.rstudio.com/flexdashboard/\"\u003e\u003cstrong\u003eflexdashboard\u003c/strong\u003e\u003c/a\u003e + \u003ca href=\"https://plot.ly/ggplot2/\"\u003e\u003cstrong\u003eggplotly\u003c/strong\u003e\u003c/a\u003e makes it incredibly easy to create interactive dashboards, but you have to reknit and recompile the dashboard any time any data changes, which I\u0026rsquo;m not a fan of doing. Wouldn\u0026rsquo;t it be amazing if there was a way to get the latest data into a dashboard document without any reknitting?\u003c/p\u003e\n\u003cp\u003eFortunately there \u003cem\u003eis\u003c/em\u003e a way! \u003ca href=\"https://rmarkdown.rstudio.com/flexdashboard/shiny.html\"\u003e\u003cstrong\u003eflexdashboard\u003c/strong\u003e’s integration with Shiny\u003c/a\u003e makes it possible!\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s a minimal working example of feeding data from a Google Sheet into a Shiny-based flexdashboard. It has to be hosted on a Shiny server somewhere (like \u003ca href=\"https://www.shinyapps.io/\"\u003eshinyapps.io\u003c/a\u003e or on your own server), but you shouldn\u0026rsquo;t have to reknit ever again!\u003c/p\u003e\n\u003ch2 id=\"step-1-create-a-google-sheet\"\u003eStep 1: Create a Google Sheet\u003c/h2\u003e\n\u003cp\u003eGo to Google Drive, create a new spreadsheet, and put this data in it:\u003c/p\u003e\n\n\n\n\n\n\u003ctable class=\"pure-table pure-table-horizontal\"\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align:center\"\u003eCategory\u003c/th\u003e\n\u003cth style=\"text-align:center\"\u003eCount\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center\"\u003eA\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e4\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center\"\u003eB\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e3\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center\"\u003eC\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e8\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center\"\u003eD\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e2\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\n\u003cp\u003eYou can keep it private, but then you have to deal with OAuth tokens to get it to work with a Shiny server, so it\u0026rsquo;s easiest here to make it publicly accessible. If you want to work with private data, check the \u003ca href=\"https://googlesheets4.tidyverse.org/#auth\"\u003e\u003cstrong\u003egooglesheets4\u003c/strong\u003e documentation on authentication\u003c/a\u003e. Click on the \u0026ldquo;Share\u0026rdquo; button in the top right corner and make the document accessible via a link. You should also make the sheet public by going to File \u0026gt; Publish to the web and publish as a CSV. You can also just use \u003ca href=\"https://docs.google.com/spreadsheets/d/1RKNn84xVLUanhGyX8DPvDSd8zt4GX_eBmK2ZX2nf0BI/edit\"\u003ethis sheet here\u003c/a\u003e if you don\u0026rsquo;t want to create your own (but this is read only and you won\u0026rsquo;t be able to edit it and see your changes live).\u003c/p\u003e\n\u003ch2 id=\"step-2-build-a-static-dashboard\"\u003eStep 2: Build a static dashboard\u003c/h2\u003e\n\u003cp\u003eWe\u0026rsquo;ll make a barebones dashboard with a couple big numbers at the top showing a count of categories and the sum of the category counts, and an interactive bar chart at the bottom showing the counts in each category. Check the fantastic documentation for \u003ca href=\"https://rmarkdown.rstudio.com/flexdashboard/\"\u003e\u003cstrong\u003eflexdashboard\u003c/strong\u003e\u003c/a\u003e for more details and examples.\u003c/p\u003e\n\u003cp\u003eSave this as an R Markdown file and knit it—the resulting HTML file is a complete self-contained dashboard.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e---\ntitle: \u0026#34;Example dashboard with static data from Google\u0026#34;\noutput:\n  flexdashboard::flex_dashboard:\n    orientation: rows\n    theme: yeti\n---\n\n\n```{r setup, include=FALSE}\nlibrary(tidyverse)\nlibrary(googlesheets4)\nlibrary(flexdashboard)\nlibrary(plotly)\n\n# Make googlesheets4 not try to authenticate, since we\u0026#39;re using a public sheet\nsheets_deauth()\n```\n\n```{r get-data, message=FALSE, include=FALSE}\n# The 1RKNn84xVLUanhGyX8DPvDSd8zt4GX_eBmK2ZX2nf0BI comes from the shared link\n# URL from Google Sheets. You can also refer to sheets by name if you\u0026#39;re\n# authenticated into your account. See the googlesheets4 documentation for more\n# details\nremote_data \u0026lt;- read_sheet(\u0026#34;1RKNn84xVLUanhGyX8DPvDSd8zt4GX_eBmK2ZX2nf0BI\u0026#34;)\n```\n\n## Row\n\n### Categories {.value-box}\n\n```{r}\n# Find the number of unique categories\nn_categories \u0026lt;- remote_data %\u0026gt;% distinct(Category) %\u0026gt;% nrow()\n\n# Show the number in a special valueBox (note the {.value-box} CSS class\n# above—that applies the CSS class to the HTML output and makes it render\n# correctly)\nvalueBox(value = n_categories, icon = \u0026#34;fas fa-users\u0026#34;)\n```\n\n### Total {.value-box}\n\n```{r}\n# Get a total of all the counts\ntotal \u0026lt;- sum(remote_data$Count)\n\n# Show the number in a valueBox\nvalueBox(value = total, icon = \u0026#34;fas fa-cubes\u0026#34;)\n```\n\n## Row\n\n###\n\n```{r}\n# Make a basic column plot\nmy_plot \u0026lt;- ggplot(remote_data, aes(x = Category, y = Count)) +\n  geom_col(aes(text = Count)) +\n  theme_minimal()\n\n# Show the plot with plotly\nggplotly(my_plot, tooltip = \u0026#34;text\u0026#34;)\n```\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"step-3-make-static-dashboard-dynamic\"\u003eStep 3: Make static dashboard dynamic\u003c/h2\u003e\n\u003cp\u003eThe only problem with this dashboard is that it\u0026rsquo;s now the same every time you visit it. If you update the data in the Google Sheet, those changes won\u0026rsquo;t be reflected in the dashboard unless you reknit the document.\u003c/p\u003e\n\u003cp\u003eWe can make the dashboard dynamic with some basic shinyfication: we can put the data reading into a function that gets rerun when the page is reloaded, and we can put \u003ccode\u003evalueBox()\u003c/code\u003e and \u003ccode\u003eggplotly()\u003c/code\u003e inside functions that connect them to the more dynamic data. This only requires a few changes—here\u0026rsquo;s the same static dashboard with the Shiny bits added.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e---\ntitle: \u0026#34;Example dashboard with dynamic data from Google\u0026#34;\noutput:\n  flexdashboard::flex_dashboard:\n    orientation: rows\nruntime: shiny  # Make this use a Shiny backend\n---\n\n\n```{r setup, include=FALSE}\nlibrary(tidyverse)\nlibrary(googlesheets4)\nlibrary(flexdashboard)\nlibrary(plotly)\n\n# Make googlesheets4 not try to authenticate, since we\u0026#39;re using a public sheet\nsheets_deauth()\n```\n\n```{r get-data, message=FALSE, include=FALSE}\n# Create a function that reads the data from Google. I\u0026#39;ve seen other examples\n# that make this a reactive(), but I don\u0026#39;t really know what that is since I\n# rarely use Shiny :shrug:\n#\n# I\u0026#39;m also not completely sold that this is the right approach, since this feels\n# kind of roundabout (create a function, run the function), but it doesn\u0026#39;t work\n# if you just do remote_data \u0026lt;- read_sheet(). Also :shrug: for now.\n#\n# ALSO flexdashboard can use a special global chunk to speed up expensive data\n# loading (https://rmarkdown.rstudio.com/flexdashboard/shiny.html#loading_data),\n# which I assume also includes loading data remotely from Google, but if you\n# name this chunk global, the dynamic data loading stops working. Once again,\n# big :shrug:.\nload_remote_data \u0026lt;- function() {\n  read_sheet(\u0026#34;1RKNn84xVLUanhGyX8DPvDSd8zt4GX_eBmK2ZX2nf0BI\u0026#34;)\n}\n\nremote_data \u0026lt;- load_remote_data()\n```\n\n## Row\n\n### Categories {.value-box}\n\n```{r}\nn_categories \u0026lt;- remote_data %\u0026gt;% distinct(Category) %\u0026gt;% nrow()\n\n# Put valueBox() inside renderValueBox({})\nrenderValueBox({\n  valueBox(value = n_categories, icon = \u0026#34;fas fa-users\u0026#34;)\n})\n```\n\n\n### Total {.value-box}\n\n```{r}\ntotal \u0026lt;- sum(remote_data$Count)\n\n# Put valueBox() inside renderValueBox({})\nrenderValueBox({\n  valueBox(value = total, icon = \u0026#34;fas fa-cubes\u0026#34;)\n})\n```\n\n## Row\n\n###\n\n```{r}\nmy_plot \u0026lt;- ggplot(remote_data, aes(x = Category, y = Count)) +\n  geom_col(aes(text = Count)) +\n  theme_minimal()\n\n# Put ggplotly() inside renderPlotly({})\nrenderPlotly({\n  ggplotly(my_plot, tooltip = \u0026#34;text\u0026#34;)\n})\n```\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"step-4-check-the-dynamicness\"\u003eStep 4: Check the dynamicness\u003c/h2\u003e\n\u003cp\u003eEdit the Google Sheet, refresh the Shiny app, and you should see everything change in real time!\u003c/p\u003e\n\u003ch2 id=\"step-5-publish-somewhere\"\u003eStep 5: Publish somewhere\u003c/h2\u003e\n\u003cp\u003eThe easiest way to publish the Shiny-based dashboard is to click on the \u0026ldquo;Publish\u0026rdquo; menu in the top right corner of the RStudio preview window and then go through the menus to publish the document at shinyapps.io. \u003ca href=\"https://andrewheiss.shinyapps.io/dynamic-flexdashboard/\"\u003eHere\u0026rsquo;s mine.\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"shiny.png\" alt=\"flexdashboard-based Shiny app on shinyapps.io\"\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eAnd that\u0026rsquo;s it! An R Markdown-based flexdashboard that dynamically loads data from a Google Sheet. There are probably better ways to load the data (like somehow using the \u003ccode\u003eglobal\u003c/code\u003e chunk?), but this works well enough!\u003c/p\u003e\n",
            "date_published": "2020-01-01T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2019/10/09/convert-md-rtf-macos-services/",
            "url": "https://www.shagunjhaver.com/blog/2019/10/09/convert-md-rtf-macos-services/",
            "title": "Convert Markdown to rich text (with syntax highlighting!) in any macOS app",
            "summary": "Create a macOS Automator service to convert Markdown to rich text from any app in macOS",
            "content_html": "\u003cp\u003eGSU uses Microsoft\u0026rsquo;s Office365 for e-mail, which is fine. My previous institutions—Duke and BYU—both use it too, and it\u0026rsquo;s pretty standard. GSU also enforces 2-factor authentication (2FA) with Duo, which is also fine. Everybody should use some sort of 2FA for all their important accounts!\u003c/p\u003e\n\u003cp\u003eHowever, for whatever reason, GSU\u0026rsquo;s version of Duo\u0026rsquo;s 2FA doesn\u0026rsquo;t allow you to generate app-specific passwords for things like e-mail. Instead, any e-mail client I use has to have support for Microsoft\u0026rsquo;s special \u003ca href=\"https://docs.microsoft.com/en-us/office365/enterprise/office-365-client-support-modern-authentication\"\u003eModern Authentication\u003c/a\u003e system, which opens up a popup window to handle the 2FA and logging in and everything. The issue with this is that very few e-mail clients support Modern Authentication. In the macOS world, the only program that supports it is Apple Mail. That\u0026rsquo;s all.\u003c/p\u003e\n\u003cp\u003eThis means I\u0026rsquo;ve had to move away from my favorite e-mail client ever: \u003ca href=\"https://airmailapp.com/\"\u003eAirmail\u003c/a\u003e. Airmail is fast, looks nice, and has great search features. Most importantly for me, though, is that it let you write e-mails in Markdown and then converted the Markdown text to HTML when you clicked send. This is the coolest thing ever if you use Markdown everywhere normally, but it\u0026rsquo;s even better when teaching code-heavy classes. I could respond to student questions by typing stuff like:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003eOh, I see! You have an error in the 3rd line there. Try changing it to:\n\n```r\nggplot(mtcars, aes(x = wt, y = mpg)) +\n  geom_point() +\n  theme_bw()\n```\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e…and Airmail would convert that to nicely formatted HTML. So convenient!\u003c/p\u003e\n\u003cp\u003eApple Mail can\u0026rsquo;t do this.\u003c/p\u003e\n\u003cp\u003eHowever, through the magic of macOS services, Bash scripting, and AppleScript, I\u0026rsquo;ve found a way to convert Markdown text to richly formatted text, and it\u0026rsquo;s delightful!\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s how to do it.\u003c/p\u003e\n\u003ch2 id=\"macos-services\"\u003emacOS services\u003c/h2\u003e\n\u003cp\u003emacOS comes with Automator, a program that lets you create workflows for repeated tasks. One kind of workflow is called a Service (or Quick Action), which can take text (or a file), do stuff to it, and spit out new text. Here\u0026rsquo;s a super basic example that takes selected text, converts it to uppercase with the \u003ccode\u003etr\u003c/code\u003e bash command, copies it to the system-wide clipboard using the \u003ccode\u003epbcopy\u003c/code\u003e shell script, gets the contents of the clipboard, and then replaces the selected text:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"make-uppercase.png\" alt=\"Workflow to make text uppercase\"\u003e\u003c/p\u003e\n\u003cp\u003eIf you save this as a Quick Action, macOS will put it in a folder named \u003ccode\u003e~/Library/Services\u003c/code\u003e. Once it\u0026rsquo;s there, it\u0026rsquo;ll be accessible in any program that lets you type, like TextEdit or Mail. Type some text in TextEdit, select it, and go to the TextEdit → Services menu. You should see the \u0026ldquo;Make uppercase\u0026rdquo; service. If you click on it, your text will be converted to uppercase. Magic.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"services-menu.png\" alt=\"Services menu in TextEdit\"\u003e\u003c/p\u003e\n\u003cp\u003eYou can make these easier to run by assigning them keyboard shortcuts. Go to System Preferences → Keyboard → Shortcuts → Services, scroll down the list until you find the \u0026ldquo;Make uppercase\u0026rdquo; service, and add a shortcut for it. Now you can convert text to upper case in any application by selecting it and pressing the keyboard shortcut. Super magic.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"add-shortcut.png\" alt=\"Assigning a keyboard shortcut to a service\"\u003e\u003c/p\u003e\n\u003ch2 id=\"markdown-to-rtf-basic\"\u003eMarkdown to RTF, basic\u003c/h2\u003e\n\u003cp\u003eRather than converting text to uppercase, we can make a service that pipes Markdown text through \u003ca href=\"https://pandoc.org\"\u003epandoc\u003c/a\u003e, converts it to nicely styled RTF, and replaces the selected text with the nicely styled text.\u003c/p\u003e\n\u003cp\u003eMake a new Quick Action in Automator that looks like this (I named it \u003cstrong\u003emd2rtf\u003c/strong\u003e):\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"workflow-simple.png\" alt=\"Simple md2rtf workflow\"\u003e\u003c/p\u003e\n\u003cp\u003eThe shell script should look like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan style=\"color:#75715e\"\u003e# !/bin/bash\u003c/span\u003e\nexport LC_CTYPE\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003eUTF-8\n/usr/local/bin/pandoc -t rtf -s | pbcopy\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThis will run your text through pandoc, convert it to RTF, and copy the results to the clipboard. The \u0026ldquo;Get Contents of Clipboard\u0026rdquo; will then grab the formatted text from the clipboard and replace the selected text with it.\u003c/p\u003e\n\u003cp\u003eWatch it in action here:\u003c/p\u003e\n\u003ciframe src=\"https://player.vimeo.com/video/365343785\" width=\"640\" height=\"457\" frameborder=\"0\" allow=\"autoplay; fullscreen\" allowfullscreen\u003e\u003c/iframe\u003e\n\u003cp\u003eWith this service, I can type in Markdown in Mail, convert it all to rich text, and then send, which is really convenient!\u003c/p\u003e\n\u003ch2 id=\"markdown-to-rtf-with-syntax-highlighting\"\u003eMarkdown to RTF, with syntax highlighting\u003c/h2\u003e\n\u003cp\u003eHowever, it\u0026rsquo;s not quite perfect. RTF doesn\u0026rsquo;t support syntax highlighting, so if I convert any code, it\u0026rsquo;ll format it in monospaced Courier font (which is good!) that is just plain black (which is less good!). HTML output does support syntax highlighting, though, so it\u0026rsquo;d be nice if there was a way to take Markdown text and replace it with converted HTML.\u003c/p\u003e\n\u003cp\u003eJust changing the pandoc script to \u003ccode\u003e/usr/local/bin/pandoc -t html -s | pbcopy\u003c/code\u003e won\u0026rsquo;t work, though. It\u0026rsquo;ll convert the file to HTML, as expected, but it\u0026rsquo;ll replace your text with all the HTML tags instead of rendered HTML, which is less than ideal.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"wrong-html.png\" alt=\"Incorrect unrendered raw HTML\"\u003e\u003c/p\u003e\n\u003cp\u003eSo instead, we need to convert to HTML, somehow render that HTML to rich text, and then replace the text with that instead. Fortunately someone asked a \u003ca href=\"https://stackoverflow.com/a/11089226\"\u003esimilar question on StackOverflow in 2012\u003c/a\u003e, and there\u0026rsquo;s a solution we can adapt! We basically convert HTML to raw hex code, then convert the hex code to HTML with AppleScript, which renders the HTML correctly. It seems (and is) convoluted, but it works!\u003c/p\u003e\n\u003cp\u003eChange the shell script in the Automator workflow to this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan style=\"color:#75715e\"\u003e# !/bin/bash\u003c/span\u003e\nexport LC_CTYPE\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003eUTF-8\nhex\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e`\u003c/span\u003e/usr/local/bin/pandoc -t html -s --highlight-style pygments | hexdump -ve \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;1/1 \u0026#34;%.2x\u0026#34;\u0026#39;\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e`\u003c/span\u003e\nosascript -e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;set the clipboard to «data HTML\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e${\u003c/span\u003ehex\u003cspan style=\"color:#e6db74\"\u003e}\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e»\u0026#34;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"workflow-better.png\" alt=\"Better md2rtf workflow\"\u003e\u003c/p\u003e\n\u003cp\u003eThis will take the selected text, convert it to HTML, convert the raw HTML to hex codes, convert the hex code to \u003cem\u003erendered\u003c/em\u003e HTML, and replace the selected text with that.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s what it looks like:\u003c/p\u003e\n\u003ciframe src=\"https://player.vimeo.com/video/365343809\" width=\"640\" height=\"466\" frameborder=\"0\" allow=\"autoplay; fullscreen\" allowfullscreen\u003e\u003c/iframe\u003e\n\u003cp\u003eThis is almost perfect! The only minor issue is that the non-code text switched from Helvetica (TextEdit\u0026rsquo;s and Apple Mail\u0026rsquo;s default) to Times New Roman, which isn\u0026rsquo;t great. It\u0026rsquo;d be fantastic if the converted HTML used Helvetica instead of Times.\u003c/p\u003e\n\u003cp\u003eFortunately there\u0026rsquo;s a way to fix that. The text is getting converted to Times because the rendered HTML defaults to Times in the absence of any CSS styles telling it to be something else. If we can insert some custom CSS into the converted HTML file with pandoc, we should be able to get the correct font.\u003c/p\u003e\n\u003cp\u003eThere\u0026rsquo;s an argument for pandoc that lets you insert files into the head of the HTML, \u003ccode\u003e-H\u003c/code\u003e. (There\u0026rsquo;s also a \u003ccode\u003e--css\u003c/code\u003e argument, but \u003ca href=\"https://devilgate.org/blog/2012/07/02/tip-using-pandoc-to-create-truly-standalone-html-files/\"\u003eit doesn\u0026rsquo;t play well with standalone HTML files\u003c/a\u003e, so it\u0026rsquo;s easier to insert stuff directly into the converted HTML). Create an HTML file somewhere on your computer with this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-html\" data-lang=\"html\"\u003e\u0026lt;\u003cspan style=\"color:#f92672\"\u003estyle\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etype\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text/css\u0026#34;\u003c/span\u003e\u0026gt;\n\u003cspan style=\"color:#f92672\"\u003ebody\u003c/span\u003e {\n    \u003cspan style=\"color:#66d9ef\"\u003efont-family\u003c/span\u003e: Helvetica, \u003cspan style=\"color:#66d9ef\"\u003esans-serif\u003c/span\u003e;\n}\n\u0026lt;/\u003cspan style=\"color:#f92672\"\u003estyle\u003c/span\u003e\u0026gt;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e(This isn\u0026rsquo;t raw CSS—it\u0026rsquo;s CSS wrapped in HTML. We have to do that because pandoc will take that whole file and insert it as HTML in the converted document, so we have to treat it as HTML.)\u003c/p\u003e\n\u003cp\u003eChange your Automator workflow one last time so that it injects the custom CSS:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan style=\"color:#75715e\"\u003e# !/bin/bash\u003c/span\u003e\nexport LC_CTYPE\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003eUTF-8\nhex\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e`\u003c/span\u003e/usr/local/bin/pandoc -t html -s --highlight-style pygments -H ~/path/to/your/css/thing/md2rtf_styles.html | hexdump -ve \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;1/1 \u0026#34;%.2x\u0026#34;\u0026#39;\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e`\u003c/span\u003e\nosascript -e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;set the clipboard to «data HTML\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e${\u003c/span\u003ehex\u003cspan style=\"color:#e6db74\"\u003e}\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e»\u0026#34;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"workflow-best.png\" alt=\"Best md2rtf workflow\"\u003e\u003c/p\u003e\n\u003cp\u003eWith that addition, the workflow will now take your selected text, convert it to HTML that is styled with Helvetica, convert \u003cem\u003ethat\u003c/em\u003e to hex code, convert \u003cem\u003ethat\u003c/em\u003e to rendered HTML, and finally replace your text with impeccable style:\u003c/p\u003e\n\u003ciframe src=\"https://player.vimeo.com/video/365343828\" width=\"640\" height=\"471\" frameborder=\"0\" allow=\"autoplay; fullscreen\" allowfullscreen\u003e\u003c/iframe\u003e\n\u003cp\u003eI\u0026rsquo;ve added \u003cstrong\u003e⌘⌥^⇧P\u003c/strong\u003e as the shortcut for this (so I essentially mash down the whole bottom left corner of my keyboard and hit P), and it makes using Apple Mail with Markdown and code quite convenient!\u003c/p\u003e\n",
            "date_published": "2019-10-09T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2019/02/16/algebra-calculus-r-yacas/",
            "url": "https://www.shagunjhaver.com/blog/2019/02/16/algebra-calculus-r-yacas/",
            "title": "Chidi's budget and utility: doing algebra and calculus with R and yacas",
            "summary": "Use algebra and calculus with R and yacas to find Chidi's optimal level of pizza and frozen yogurt consumption given his budget and utility function.",
            "content_html": "\u003cp\u003e\u003cspan class=\"small\"\u003e(\u003ca href=\"https://github.com/andrewheiss/algebra-calculus-r-yacas\"\u003eSee this notebook on GitHub\u003c/a\u003e)\u003c/span\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eA year ago, \u003ca href=\"blog/2018/02/15/derivatives-r-fun/\"\u003eI wrote about how to use R to solve a typical microeconomics problem\u003c/a\u003e: finding the optimal price and quantity of some product given its demand and cost. Doing this involves setting the first derivatives of two functions equal to each other and using algebra to find where they cross. I showed how to use neat functions like \u003ccode\u003eDeriv::Deriv()\u003c/code\u003e and \u003ccode\u003esplinefun()\u003c/code\u003e and make fancy plots showing supply and demand and it’s pretty cool. I wrote it mostly because I was teaching an introductory microeconomics course and wanted an easy, generalizable, and manual math-less way to make these plots for my students’ exercises and problem sets, and it works great.\u003c/p\u003e\n\u003cp\u003eI’m teaching microeconomics again this year and decided to tackle a trickier problem that involves curvier curves, more variables, and more math. And the results are even cooler and open the door for more doing math and symbolic algebra directly with R.\u003c/p\u003e\n\u003cp\u003eAnother typical microeconomics problem is to find the optimal level of consumption of two goods, given their prices, your budget, and your preferences for those goods. It involves (1) constructing a budget line that shows the feasible level of consumption, (2) drawing indifference curves that show the combination of goods that give you the same amount of happiness, or utility, or utils, and (3) finding which indifference curve is tangent line and where that happens. The point where the budget matches the indifference curve is the optimal utility maximizing point. The more mathy approach is that we need to find where the slope of the budget line, or \u003cem\u003emarginal rate of transformation\u003c/em\u003e (MRT) is equal to the slope of the indifference curve, or \u003cem\u003emarginal rate of substitution\u003c/em\u003e (MRS).\u003c/p\u003e\n\u003cp\u003eFor this situation, imagine a mild-mannered professor named \u003ca href=\"https://thegoodplace.fandom.com/wiki/Chidi_Anagonye\"\u003eChidi Anagonye\u003c/a\u003e who is crippled with decision anxiety (he is also dead). He has to choose the best combination of pizza and frozen yogurt, but doesn’t know what to do! Here’s the information he has:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eHe has a budget of $45 and must spend it all.\u003c/li\u003e\n\u003cli\u003eSlices of Hawaiian pizza cost $3. We’ll abbreviate this as \\(x\\).\u003c/li\u003e\n\u003cli\u003eBowls of frozen yogurt cost $1.50. We’ll abbreviate this as \\(y\\).\u003c/li\u003e\n\u003cli\u003eThe happiness Chidi gets from eating pizza and frozen yogurt can be modeled with this utility function:\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e$$\nU(x, y) = x^2\\ 0.25y\n$$\u003c/p\u003e\n\u003cp\u003eArmed with only this information, we can find the optimal number of pizza slices and bowls of yogurt. So buckle up, \u003ca href=\"https://www.youtube.com/watch?v=2c-AawAKZ14\"\u003emy little chili babies\u003c/a\u003e. Let’s do this with R!\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#step-0-a-brief-note-about-math-in-r\"\u003eStep 0: A brief note about math in R\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#step-1-plot-a-budget-line\"\u003eStep 1: Plot a budget line\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#step-2-plot-utility-and-indifference-curves\"\u003eStep 2: Plot utility and indifference curves\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#step-3-find-where-the-indifference-curve-and-budget-line-are-tangent\"\u003eStep 3: Find where the indifference curve and budget line are tangent\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tldr-complete-example\"\u003etl;dr complete example\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"step-0-a-brief-note-about-math-in-r\"\u003eStep 0: A brief note about math in R\u003c/h2\u003e\n\u003cp\u003eR is phenomenal software for statistics and graphics and all sorts of other things, but it was not invented to do higher level algebra and calculus. Expensive programs like \u003ca href=\"https://en.wikipedia.org/wiki/MATLAB\"\u003eMATLAB\u003c/a\u003e and \u003ca href=\"https://en.wikipedia.org/wiki/Wolfram_Mathematica\"\u003eMathematica\u003c/a\u003e were invented for this kind of complicated numerical computing (and Wolfram Alpha is really neat! Try searching for \u003ca href=\"https://www.wolframalpha.com/input/?i=derive+3x%5E2\"\u003e“derive 3x^2”\u003c/a\u003e there and see what happens!). There are also a bunch of open source \u003ca href=\"https://en.wikipedia.org/wiki/Computer_algebra_system\"\u003ecomputer algebra systems\u003c/a\u003e (CAS) that let you do mathy things with formulas, like \u003ca href=\"https://en.wikipedia.org/wiki/SageMath\"\u003eSageMath\u003c/a\u003e, \u003ca href=\"https://en.wikipedia.org/wiki/SymPy\"\u003eSymPy\u003c/a\u003e, and \u003ca href=\"http://www.yacas.org/\"\u003eYacas\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eMany of these CAS libraries have interfaces with R, like \u003ca href=\"https://cran.r-project.org/web/packages/rSymPy/index.html\"\u003e\u003cstrong\u003erSymPy\u003c/strong\u003e\u003c/a\u003e and \u003ca href=\"https://cran.r-project.org/web/packages/Ryacas/index.html\"\u003e\u003cstrong\u003eRyacas\u003c/strong\u003e\u003c/a\u003e. However, they’re fairly undocumented and \u003cstrong\u003erSymPy\u003c/strong\u003e hasn’t been updated since 2010. Additionally, \u003cstrong\u003erSymPy\u003c/strong\u003e requires \u003cstrong\u003erJava\u003c/strong\u003e (for whatever reason), which is a gigantic headache to install. \u003cstrong\u003eRyacas\u003c/strong\u003e, on the other hand, doesn’t have a ton of dependencies, is actively maintained, and is \u003cem\u003eslightly\u003c/em\u003e better documented.\u003c/p\u003e\n\u003cp\u003eThere are like \u003ca href=\"https://cran.r-project.org/web/packages/Ryacas/vignettes/getting-started.html\"\u003ea billion examples of how to use \u003cstrong\u003eRyacas\u003c/strong\u003e here\u003c/a\u003e or \u003ca href=\"https://stackoverflow.com/questions/47474121/how-to-rearrange-the-complex-algebraic-equation-in-r\"\u003eon StackOverflow\u003c/a\u003e, but here are just a few tiny examples to show what it can do:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(Ryacas)\n\n\u003cspan style=\"color:#75715e\"\u003e# Define some variables to work with\u003c/span\u003e\nx \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eSym\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;x\u0026#34;\u003c/span\u003e)\ny \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eSym\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;y\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Write a formula as a string or R expression\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eyacas\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;x^2 + 5\u0026#34;\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e## expression(x^2 + 5)\u003c/span\u003e\n\n\u003cspan style=\"color:#a6e22e\"\u003eyacas\u003c/span\u003e(x^2 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e## expression(x^2 + 5)\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Find the derivative of a complicated formula\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eyacas\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ederiv\u003c/span\u003e(x^2 \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003ey)^3), x)\n\u003cspan style=\"color:#75715e\"\u003e## expression(2 * (x * (5 * y)^3))\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Find the derivative of an R function (!!!)\u003c/span\u003e\nneat_function \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(x, y) x^2 \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003ey)^3\n\u003cspan style=\"color:#a6e22e\"\u003eyacas\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ederiv\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eneat_function\u003c/span\u003e(x, y), x))  \u003cspan style=\"color:#75715e\"\u003e# d/dx\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## expression(2 * (x * (5 * y)^3))\u003c/span\u003e\n\n\u003cspan style=\"color:#a6e22e\"\u003eyacas\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ederiv\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eneat_function\u003c/span\u003e(x, y), y))  \u003cspan style=\"color:#75715e\"\u003e# d/dy\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## expression(x^2 * (15 * (5 * y)^2))\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Solve a complicated formula\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eSolve\u003c/span\u003e(x^2 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003ey) \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, y)\n\u003cspan style=\"color:#75715e\"\u003e## Yacas vector:\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## [1] y == -(x^2/5)\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Write these yacas things as LaTeX\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ecat\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eTeXForm\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eyacas\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eneat_function\u003c/span\u003e(x, y))))\n\u003cspan style=\"color:#75715e\"\u003e## x ^{2} \\left( 5 y\\right)  ^{3}\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWhat’s really neat about \u003cstrong\u003eRyacas\u003c/strong\u003e is that because it returns expressions, you can use them as pseudo functions within R using \u003ccode\u003eEval()\u003c/code\u003e. You can even build wrapper functions with \u003ccode\u003eEval()\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ederiv_neat_function \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(my_y, my_x) {\n  derived \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eyacas\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ederiv\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eneat_function\u003c/span\u003e(x, y), x))\n  \u003cspan style=\"color:#a6e22e\"\u003eEval\u003c/span\u003e(derived, \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e my_x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e my_y))\n}\n\n\u003cspan style=\"color:#a6e22e\"\u003ederiv_neat_function\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 500\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAgain, this is just scratching the surface of what \u003cstrong\u003eRyacas\u003c/strong\u003e can do. There are also more powerful CAS libraries, like Python’s \u003ca href=\"https://www.sympy.org/en/index.html\"\u003eSymPy\u003c/a\u003e, though it doesn’t currently have a nice interface with R (but you could theoretically use \u003ca href=\"https://rstudio.github.io/reticulate/\"\u003e\u003cstrong\u003ereticulate\u003c/strong\u003e\u003c/a\u003e to feed R objects directly to Python, do mathy things with them, and return them to R).\u003c/p\u003e\n\u003ch2 id=\"step-1-plot-a-budget-line\"\u003eStep 1: Plot a budget line\u003c/h2\u003e\n\u003cp\u003eWith that mathy stuff out of the way, we can finally start figuring out Chidi’s optimal level of consumption. First, we’ll load our libraries, create a custom ggplot theme, and set up some variables to work with \u003cstrong\u003eRyacas\u003c/strong\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(Ryacas)\n\n\u003cspan style=\"color:#75715e\"\u003e# Make a few minor adjustments to theme_classic()\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# I\u0026#39;m using Encode Sans Condensed: https://fonts.google.com/specimen/Encode+Sans+Condensed\u003c/span\u003e\ntheme_econ \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e() {\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_classic\u003c/span\u003e(base_family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Encode Sans Condensed\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n    \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(axis.title.x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(margin \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emargin\u003c/span\u003e(t \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)),\n          axis.title.y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(margin \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emargin\u003c/span\u003e(r \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)),\n          axis.title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Encode Sans Condensed Medium\u0026#34;\u003c/span\u003e))\n}\n\n\u003cspan style=\"color:#75715e\"\u003e# Make all labels automatically use Encode Sans\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eupdate_geom_defaults\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;label\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Encode Sans Condensed Bold\u0026#34;\u003c/span\u003e))\n\n\u003cspan style=\"color:#75715e\"\u003e# Yacas variables\u003c/span\u003e\nx \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eSym\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;x\u0026#34;\u003c/span\u003e)\ny \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eSym\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;y\u0026#34;\u003c/span\u003e)\nU \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eSym\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;U\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eTo build the budget line, we need to figure out how many pizzas and yogurts Chidi would buy if he spent all his money on each item. We can do this with some simple math:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003etotal_budget \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e45\u003c/span\u003e\nprice_x \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e\nprice_y \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e\n\nn_pizza \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e total_budget \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e price_x\nn_pizza\n\u003cspan style=\"color:#75715e\"\u003e## [1] 15\u003c/span\u003e\n\nn_yogurt \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e total_budget \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e price_y\nn_yogurt\n\u003cspan style=\"color:#75715e\"\u003e## [1] 30\u003c/span\u003e\n\nslope \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003en_yogurt \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e n_pizza\nslope\n\u003cspan style=\"color:#75715e\"\u003e## [1] -2\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThat’s 15 pizzas or 30 yogurts. We can use this information to build a formula. Since we can draw a line using the $y = mx + b$ form, we need to figure out the slope ($m$) and y-intercept ($b$). The y-intercept here is 30, or the number of yogurts he’d eat if x is 0, and the slope is the number of yogurts divided by the number of pizzas, or -2. That means the budget line is:\u003c/p\u003e\n\u003cp\u003e$$\ny = -2x + 30\n$$\u003c/p\u003e\n\u003cp\u003eWe’ll write this as an R function, and then we can use \u003ccode\u003estat_function()\u003c/code\u003e in \u003cstrong\u003eggplot2\u003c/strong\u003e to plot it:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ebudget \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(x) (slope \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e x) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e n_yogurt\n\n\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Draw the line\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003estat_function\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x),\n                fun \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e budget, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#638ccc\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Add a label\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eannotate\u003c/span\u003e(geom \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;label\u0026#34;\u003c/span\u003e, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2.5\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ebudget\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e2.5\u003c/span\u003e), \n           label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Budget\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#638ccc\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Slices of pizza\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Bowls of frozen yogurt\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Make the axes go all the way to zero\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_x_continuous\u003c/span\u003e(expand \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e), breaks \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eseq\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_y_continuous\u003c/span\u003e(expand \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e), breaks \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eseq\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e30\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_cartesian\u003c/span\u003e(xlim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e16\u003c/span\u003e), ylim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e32\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_econ\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cfigure\u003e\u003cimg src=\"plot-budget-1.png\"\n         alt=\"Budget line\"/\u003e\n\u003c/figure\u003e\n\n\u003cp\u003eAny point along that line will use up Chidi’s entire budget. He can’t afford any point above the line, and he’s not efficiently spending his money if he chooses any point below the line (like 5 pizzas and 10 yogurts, for instance).\u003c/p\u003e\n\u003ch2 id=\"step-2-plot-utility-and-indifference-curves\"\u003eStep 2: Plot utility and indifference curves\u003c/h2\u003e\n\u003cp\u003eLike we said at the beginning, Chidi gets utility (or happiness points) from his consumption of pizza and yogurt, based on this formula:\u003c/p\u003e\n\u003cp\u003e$$\nU(x, y) = x^2\\ 0.25y\n$$\u003c/p\u003e\n\u003cp\u003eWe can write this as an R function and use it to figure out how happy he’d be with any given amount of pizza and yogurt:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eutility_u \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(x, y) x^2 \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.25\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e y)\n\n\u003cspan style=\"color:#75715e\"\u003e# 5 pizzas, 5 yogurt\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eutility_u\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 31.25\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eHe gets 31.25 happiness points from 5 slices of pizza and 5 bowls of frozen yogurt. Neat.\u003c/p\u003e\n\u003cp\u003eIf we rearrange this utility formula to be in terms of $y$, we can plot the function to show the combinations of pizza and yogurt that would provide the same level of happiness. Ordinarily, you have to do this by hand with algebra, but the tediousness of that is \u003ca href=\"https://twitter.com/andrewheiss/status/1096537965784748032\"\u003ewhat led me down this mathy rabbit hole\u003c/a\u003e. We can use \u003cstrong\u003eRyacas\u003c/strong\u003e to rearrange this for us! With the \u003ccode\u003eSolve()\u003c/code\u003e function, we can set Chidi’s utility function to $U$ and solve for $y$ and yacas will rearrange everything for us:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eutility_solved \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eSolve\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eutility_u\u003c/span\u003e(x, y) \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e U, y)\nutility_solved\n\u003cspan style=\"color:#75715e\"\u003e## Yacas vector:\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## [1] y == U/(0.25 * x^2)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e$$\n\\left( y = \\frac{U}{0.25 x ^{2}} \\right)\n$$\u003c/p\u003e\n\u003cp\u003eAnd with \u003ccode\u003eEval()\u003c/code\u003e, we can use this as a function and figure out values of $y$ given different $x$s and $U$s. It’s even vectorized so you can feed it lots of numbers:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eEval\u003c/span\u003e(utility_solved, \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, U \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e))\n\u003cspan style=\"color:#75715e\"\u003e## [1] \u0026#34;( y == 1.6 )\u0026#34;\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# It\u0026#39;s already vectorized\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eEval\u003c/span\u003e(utility_solved, \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, U \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e))\n\u003cspan style=\"color:#75715e\"\u003e## [1] \u0026#34;( y == 40 )\u0026#34;               \u0026#34;( y == 10 )\u0026#34;              \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## [3] \u0026#34;( y == 4.44444444444444 )\u0026#34; \u0026#34;( y == 2.5 )\u0026#34;             \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## [5] \u0026#34;( y == 1.6 )\u0026#34;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe can make this more general by wrapping a function around it, which lets us pass any $x$ or $U$ we want. More importantly, we convert the text that \u003ccode\u003eEval()\u003c/code\u003e returns into a number with \u003ccode\u003estr_extract()\u003c/code\u003e, which uses a regular expression to pull out the number in the string (including decimals and negative signs).\u003c/p\u003e\n\u003cp\u003eNote how the arguments for the function aren’t just \u003ccode\u003ex\u003c/code\u003e and \u003ccode\u003eU\u003c/code\u003e, but \u003ccode\u003emy_x\u003c/code\u003e and \u003ccode\u003emy_u\u003c/code\u003e instead. That’s because of environment issues—using the same \u003ccode\u003ex\u003c/code\u003e and \u003ccode\u003eU\u003c/code\u003e variable names causes conflicts, since it’s not clear if the arguments or the global \u003ccode\u003ex\u003c/code\u003e and \u003ccode\u003eU\u003c/code\u003e we set earlier get passed to \u003ccode\u003eSolve()\u003c/code\u003e or \u003ccode\u003eEval()\u003c/code\u003e. To avoid this namespace clash, we rename the arguments.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eutility_y \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(my_x, my_U) {\n  solved \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eSolve\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eutility_u\u003c/span\u003e(x, y) \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e U, y)\n  solution \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eEval\u003c/span\u003e(solved, \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e my_x, U \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e my_U))\n  \u003cspan style=\"color:#75715e\"\u003e# Regex incantation to extract numbers\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eas.numeric\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003estr_extract\u003c/span\u003e(solution, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;-?[0-9]\\\\d*(\\\\.\\\\d+)?\u0026#34;\u003c/span\u003e))\n}\n\n\u003cspan style=\"color:#75715e\"\u003e# We could avoid regexes by digging into the deeply nested list that yacas()\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# returns, but doing that doesn\u0026#39;t handle negatives very well\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# See https://stackoverflow.com/q/8480778/120898\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# unlist(as.list(yacas(solution)$text[[1]][[3]]))\u003c/span\u003e\n\n\u003cspan style=\"color:#a6e22e\"\u003eutility_y\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 1.6\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Still vectorized\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eutility_y\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 40.000000 10.000000  4.444444  2.500000  1.600000\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNow that we’ve created this y-based function, we can plot it with \u003ccode\u003estat_function()\u003c/code\u003e. Here are a few different indifference curves for different levels of utility:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Budget line\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003estat_function\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x),\n                fun \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e budget, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#638ccc\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eannotate\u003c/span\u003e(geom \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;label\u0026#34;\u003c/span\u003e, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2.5\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ebudget\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e2.5\u003c/span\u003e), \n           label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Budget\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#638ccc\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# U = 10\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003estat_function\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x),\n                fun \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e utility_y, args \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(my_U \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e),\n                color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#ab62c0\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eannotate\u003c/span\u003e(geom \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;label\u0026#34;\u003c/span\u003e, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2.5\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eutility_y\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e2.5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e), \n           label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;U = 10\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#ab62c0\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# U = 100\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003estat_function\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x),\n                fun \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e utility_y, args \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(my_U \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e),\n                color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#ca5670\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eannotate\u003c/span\u003e(geom \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;label\u0026#34;\u003c/span\u003e, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e7\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eutility_y\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e7\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e), \n           label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;U = 100\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#ca5670\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# U = 500\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003estat_function\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x),\n                fun \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e utility_y, args \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(my_U \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e500\u003c/span\u003e),\n                color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#c57c3c\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eannotate\u003c/span\u003e(geom \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;label\u0026#34;\u003c/span\u003e, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e12.5\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eutility_y\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e12.5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e500\u003c/span\u003e), \n           label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;U = 500\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#c57c3c\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Slices of pizza\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Bowls of frozen yogurt\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_x_continuous\u003c/span\u003e(expand \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e), breaks \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eseq\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_y_continuous\u003c/span\u003e(expand \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e), breaks \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eseq\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e30\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_cartesian\u003c/span\u003e(xlim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e16\u003c/span\u003e), ylim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e32\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_econ\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cfigure\u003e\u003cimg src=\"plot-indifference-1.png\"\n         alt=\"Three indifference curves\"/\u003e\n\u003c/figure\u003e\n\n\u003cp\u003eEvery combination of pizza and yogurt on these indifference curves generates the same level of utility. Cool cool cool.\u003c/p\u003e\n\u003ch2 id=\"step-3-find-where-the-indifference-curve-and-budget-line-are-tangent\"\u003eStep 3: Find where the indifference curve and budget line are tangent\u003c/h2\u003e\n\u003cp\u003eHowever, we still don’t know what the best level of consumption is. To find that, we need to figure out the point where an indifference curve is tangent to the budget line. Based on the graph, it’s a combination of $x$ and $y$ that yields somewhere between 100 and 500 utils, but that’s a wide range. The mathy way to find this point is to set the slope of the budget line (the marginal rate of transformation) equal to the slope of the indifference curve (the marginal rate of substitution) and solve for $x$ and $y$. In economics, “marginal” means slope, or first derivative, so we need to differentiate our formulas.\u003c/p\u003e\n\u003cp\u003eIn addition to rearranging formulas, we can use \u003cstrong\u003eRyacas\u003c/strong\u003e to derive functions. \u003ca href=\"https://www.andrewheiss.com/blog/2018/02/15/derivatives-r-fun/\"\u003eLast year I showed how to use the \u003cstrong\u003eDeriv\u003c/strong\u003e package to calculate the derivative of a function in R\u003c/a\u003e. Those formulas only had one variable to worry about. This utility function has two, which means we need to take the partial derivative with respect to $x$ ($\\partial u / \\partial x$) and divide it by the partial derivative with respect to $y$ ($\\partial u / \\partial y$).\u003c/p\u003e\n\u003cp\u003eFrom my minimal tinkering, neither the base R derivative functions nor \u003ccode\u003eDeriv::Deriv()\u003c/code\u003e can handle partial derivatives well, but \u003ccode\u003eRyacas::deriv()\u003c/code\u003e does. Also, since it returns expressions, we can do math (like division!) with the partial derivatives. Here I find each of the partial derivatives and then use \u003ccode\u003eSimplify()\u003c/code\u003e to clean up their ratio:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Partial derivative with respect to x\u003c/span\u003e\nmu_x \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ederiv\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eutility_u\u003c/span\u003e(x, y), x)\nmu_x\n\u003cspan style=\"color:#75715e\"\u003e## expression(2 * (x * (0.25 * y)))\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e$$\n\\partial u / \\partial x = 2 x 0.25 y\n$$\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Partial derivative with respect to y\u003c/span\u003e\nmu_y \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ederiv\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eutility_u\u003c/span\u003e(x, y), y)\nmu_y\n\u003cspan style=\"color:#75715e\"\u003e## expression(0.25 * x^2)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e$$\n\\partial u / \\partial y = 0.25 x ^{2}\n$$\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Cleaned up version\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eSimplify\u003c/span\u003e(mu_x \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e mu_y)\n\u003cspan style=\"color:#75715e\"\u003e## expression(0.5 * y/(0.25 * x))\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e$$\n\\frac{\\partial u / \\partial x}{\\partial u / \\partial y} = \\frac{2 x 0.25 y}{0.25 x ^{2}} = \\frac{0.5 y}{0.25 x}\n$$\u003c/p\u003e\n\u003cp\u003eThis marginal rate of substitution is the slope of the indifference curve at any combination of $x$ and $y$, but it doesn’t incorporate any information about the prices. Before we can find where happiness meets the budget, we have to incorporate prices into the marginal utility, or marginal rate of substitution. Because of calculus proofs that are beyond my skill, the marginal rate of substitution can also be written as a ratio of prices, or $\\frac{\\text{Price}_x}{\\text{Price}_y}$. If we set marginal utility equal to this price ratio and rearrange the formula to be in terms of y, we’ll have the official price-attuned marginal rate of substitution (or slope of the indifference curve).\u003c/p\u003e\n\u003cp\u003eTo do this with R, we can use \u003ccode\u003eSolve()\u003c/code\u003e again, only this time we can set the equation equal to the price ratio:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# For unknown reasons, yacas works better with (3 / 1.5) instead of 2, so we\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# build the string with price_x and price_y instead of price_x/price_y\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eSolve\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003epaste\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eSimplify\u003c/span\u003e(mu_x \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e mu_y), \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;==\u0026#34;\u003c/span\u003e, price_x, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;/\u0026#34;\u003c/span\u003e, price_y), y)\n\u003cspan style=\"color:#75715e\"\u003e## Yacas vector:\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## [1] y == -(-0.75 * x/0.75)\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e$$\n\\left( y =  - \\frac{-0.75 x}{0.75} \\right)\n$$\u003c/p\u003e\n\u003cp\u003eAs before, we can turn this solved formula into a function so that we can find the slope of the indifference curve at any x.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emarginal_utility \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(my_x) {\n  mux_muy \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eSimplify\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ederiv\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eutility_u\u003c/span\u003e(x, y), x) \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ederiv\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eutility_u\u003c/span\u003e(x, y), y))\n  mux_muy_price \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eSolve\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003epaste\u003c/span\u003e(mux_muy, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;==\u0026#34;\u003c/span\u003e, price_x, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;/\u0026#34;\u003c/span\u003e, price_y), y)\n  solution \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eEval\u003c/span\u003e(mux_muy_price, \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e my_x))\n  \u003cspan style=\"color:#a6e22e\"\u003eas.numeric\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003estr_extract\u003c/span\u003e(solution, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;-?[0-9]\\\\d*(\\\\.\\\\d+)?\u0026#34;\u003c/span\u003e))\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIf we set this formula equal to the budget line and solve for x and y individually, we’ll find the optimal mix of pizza and yogurt. Instead of doing this by hand with algebra, we can use the built-in \u003ccode\u003euniroot()\u003c/code\u003e function to see where the two functions are the same. We have to feed \u003ccode\u003euniroot()\u003c/code\u003e a range to look in—here I chose 0–100. There’s probably a way to do this with \u003cstrong\u003eRyacas\u003c/strong\u003e, but I didn’t want to figure it out. And besides, I already made the \u003ccode\u003emarginal_utility()\u003c/code\u003e function be an official R function, so I figured I could use it like one here.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Find best x\u003c/span\u003e\noptimal_x \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003euniroot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(x) \u003cspan style=\"color:#a6e22e\"\u003ebudget\u003c/span\u003e(x) \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emarginal_utility\u003c/span\u003e(x), \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e))\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eroot\noptimal_x\n\u003cspan style=\"color:#75715e\"\u003e## [1] 10\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Plug best x into the budget function to find best y\u003c/span\u003e\noptimal_y \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ebudget\u003c/span\u003e(optimal_x)  \u003cspan style=\"color:#75715e\"\u003e# or marginal_utility(optimal_x)\u003c/span\u003e\noptimal_y\n\u003cspan style=\"color:#75715e\"\u003e## [1] 10\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Plug optimal x and y into utility function to find maximum utils given the budget\u003c/span\u003e\nmax_utility \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eutility_u\u003c/span\u003e(optimal_x, optimal_y)\nmax_utility\n\u003cspan style=\"color:#75715e\"\u003e## [1] 250\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThere! We have an answer. The optimal level of consumption is 10 slices of pizza and 10 bowls of frozen yogurt, which yields 250 utils of happiness.\u003c/p\u003e\n\u003cp\u003eWith these final numbers and derived functions, we can combine all this information into a final plot, which shows that the indifference curve for 250 utils is exactly tangent to the budget line at (10, 10). MAGIC.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Budget line\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003estat_function\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x),\n                fun \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e budget, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#638ccc\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eannotate\u003c/span\u003e(geom \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;label\u0026#34;\u003c/span\u003e, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2.5\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ebudget\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e2.5\u003c/span\u003e), \n           label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Budget\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#638ccc\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Best indifference curve\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003estat_function\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x),\n                fun \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e utility_y, args \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(my_U \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e max_utility),\n                color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#ca5670\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eannotate\u003c/span\u003e(geom \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;label\u0026#34;\u003c/span\u003e, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e7\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eutility_y\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e7\u003c/span\u003e, max_utility), \n           label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epaste0\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;U = \u0026#34;\u003c/span\u003e, max_utility), color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#ca5670\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Dotted lines to show x and y\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eannotate\u003c/span\u003e(geom \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;segment\u0026#34;\u003c/span\u003e, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e optimal_y, xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e optimal_x, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e optimal_y,\n           linetype \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;dashed\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey50\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eannotate\u003c/span\u003e(geom \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;segment\u0026#34;\u003c/span\u003e, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e optimal_x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e optimal_x, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e optimal_y,\n           linetype \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;dashed\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey50\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Dot at optimal point\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eannotate\u003c/span\u003e(geom \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;point\u0026#34;\u003c/span\u003e, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e optimal_x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e optimal_y, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Slices of pizza\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Bowls of frozen yogurt\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_x_continuous\u003c/span\u003e(expand \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e), breaks \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eseq\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_y_continuous\u003c/span\u003e(expand \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e), breaks \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eseq\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e30\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_cartesian\u003c/span\u003e(xlim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e16\u003c/span\u003e), ylim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e32\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_econ\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cfigure\u003e\u003cimg src=\"plot-everything-1.png\"\n         alt=\"Utility, budget, and optimal point\"/\u003e\n\u003c/figure\u003e\n\n\u003cp\u003eAnd there we go. \u003ca href=\"https://www.youtube.com/watch?v=2c-AawAKZ14\u0026amp;feature=youtu.be\u0026amp;t=128\"\u003eYou all get As. Or Fs. And there is no test. And you all failed it. And you all got As. Who cares. Goodbye.\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"tldr-complete-example\"\u003etl;dr complete example\u003c/h2\u003e\n\u003cp\u003eThat was a lot of annotated code. Here’s a complete example without all the explanation.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(Ryacas)\n\n\u003cspan style=\"color:#a6e22e\"\u003eupdate_geom_defaults\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;label\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Encode Sans Condensed Bold\u0026#34;\u003c/span\u003e))\n\n\u003cspan style=\"color:#75715e\"\u003e# Define some variables to work with\u003c/span\u003e\nx \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eSym\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;x\u0026#34;\u003c/span\u003e)\ny \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eSym\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;y\u0026#34;\u003c/span\u003e)\nU \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eSym\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;U\u0026#34;\u003c/span\u003e)\n\n\n\u003cspan style=\"color:#75715e\"\u003e# Prices and budget -------------------------------------------------------\u003c/span\u003e\ntotal_budget \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e45\u003c/span\u003e\nprice_x \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e\nprice_y \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Build budget line\u003c/span\u003e\nn_pizza \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e total_budget \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e price_x\nn_yogurt \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e total_budget \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e price_y\nslope \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003en_yogurt \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e n_pizza\n\nbudget \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(x) (slope \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e x) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e n_yogurt\n\n\n\u003cspan style=\"color:#75715e\"\u003e# Utility and indifference ------------------------------------------------\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# U = x^2 0.25y\u003c/span\u003e\nutility_u \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(x, y) x^2 \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.25\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e y)\n\n\u003cspan style=\"color:#75715e\"\u003e# Rewrite as y = something\u003c/span\u003e\nutility_y \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(my_x, my_U) {\n  solved \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eSolve\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eutility_u\u003c/span\u003e(x, y) \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e U, y)\n  solution \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eEval\u003c/span\u003e(solved, \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e my_x, U \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e my_U))\n  \u003cspan style=\"color:#a6e22e\"\u003eas.numeric\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003estr_extract\u003c/span\u003e(solution, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;-?[0-9]\\\\d*(\\\\.\\\\d+)?\u0026#34;\u003c/span\u003e))\n}\n\n\u003cspan style=\"color:#75715e\"\u003e# Marginal rate of substitution\u003c/span\u003e\nmarginal_utility \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(my_x) {\n  mux_muy \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eSimplify\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ederiv\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eutility_u\u003c/span\u003e(x, y), x) \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ederiv\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eutility_u\u003c/span\u003e(x, y), y))\n  mux_muy_price \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eSolve\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003epaste\u003c/span\u003e(mux_muy, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;==\u0026#34;\u003c/span\u003e, price_x, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;/\u0026#34;\u003c/span\u003e, price_y), y)\n  solution \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eEval\u003c/span\u003e(mux_muy_price, \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e my_x))\n  \u003cspan style=\"color:#a6e22e\"\u003eas.numeric\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003estr_extract\u003c/span\u003e(solution, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;-?[0-9]\\\\d*(\\\\.\\\\d+)?\u0026#34;\u003c/span\u003e))\n}\n\n\n\u003cspan style=\"color:#75715e\"\u003e# Optimal points ----------------------------------------------------------\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# Find best x\u003c/span\u003e\noptimal_x \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003euniroot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(x) \u003cspan style=\"color:#a6e22e\"\u003ebudget\u003c/span\u003e(x) \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emarginal_utility\u003c/span\u003e(x), \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e))\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eroot\n\n\u003cspan style=\"color:#75715e\"\u003e# Plug best x into the budget function to find best y\u003c/span\u003e\noptimal_y \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ebudget\u003c/span\u003e(optimal_x)\n\n\u003cspan style=\"color:#75715e\"\u003e# Plug optimal x and y into utility function to find maximum utils given the budget\u003c/span\u003e\nmax_utility \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eutility_u\u003c/span\u003e(optimal_x, optimal_y)\n\n\n\u003cspan style=\"color:#75715e\"\u003e# Plot everything ---------------------------------------------------------\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Budget line\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003estat_function\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x),\n                fun \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e budget, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#638ccc\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eannotate\u003c/span\u003e(geom \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;label\u0026#34;\u003c/span\u003e, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2.5\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ebudget\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e2.5\u003c/span\u003e), \n           label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Budget\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#638ccc\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Best indifference curve\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003estat_function\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x),\n                fun \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e utility_y, args \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(my_U \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e max_utility),\n                color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#ca5670\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eannotate\u003c/span\u003e(geom \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;label\u0026#34;\u003c/span\u003e, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e7\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eutility_y\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e7\u003c/span\u003e, max_utility), \n           label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epaste0\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;U = \u0026#34;\u003c/span\u003e, max_utility), color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#ca5670\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Dotted lines to show x and y\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eannotate\u003c/span\u003e(geom \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;segment\u0026#34;\u003c/span\u003e, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e optimal_y, xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e optimal_x, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e optimal_y,\n           linetype \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;dashed\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey50\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eannotate\u003c/span\u003e(geom \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;segment\u0026#34;\u003c/span\u003e, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e optimal_x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e optimal_x, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e optimal_y,\n           linetype \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;dashed\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey50\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Dot at optimal point\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eannotate\u003c/span\u003e(geom \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;point\u0026#34;\u003c/span\u003e, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e optimal_x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e optimal_y, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Slices of pizza\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Bowls of frozen yogurt\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_x_continuous\u003c/span\u003e(expand \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e), breaks \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eseq\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_y_continuous\u003c/span\u003e(expand \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e), breaks \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eseq\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e30\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_cartesian\u003c/span\u003e(xlim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e16\u003c/span\u003e), ylim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e32\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_classic\u003c/span\u003e(base_family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Encode Sans Condensed\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(axis.title.x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(margin \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emargin\u003c/span\u003e(t \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)),\n        axis.title.y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(margin \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emargin\u003c/span\u003e(r \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)),\n        axis.title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Encode Sans Condensed Medium\u0026#34;\u003c/span\u003e))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cfigure\u003e\u003cimg src=\"complete-example-1.png\"\n         alt=\"Complete example\"/\u003e\n\u003c/figure\u003e\n\n",
            "date_published": "2019-02-16T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2019/01/29/diff-means-half-dozen-ways/",
            "url": "https://www.shagunjhaver.com/blog/2019/01/29/diff-means-half-dozen-ways/",
            "title": "Half a dozen frequentist and Bayesian ways to measure the difference in means in two groups",
            "summary": "Learn how to run standard t-tests, simulations, and Bayesian difference in means tests with R and Stan",
            "content_html": "\u003cp\u003e\u003cspan class=\"small\"\u003e(\u003ca href=\"https://github.com/andrewheiss/diff-means-half-dozen-ways\"\u003eSee this notebook on GitHub\u003c/a\u003e)\u003c/span\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eTaking a sample from two groups from a population and seeing if there’s a significant or substantial difference between them is a standard task in statistics. Measuring performance on a test before and after some sort of intervention, measuring average GDP in two different continents, measuring average height in two groups of flowers, etc.—we like to know if any group differences we see are attributable to chance / measurement error, or if they’re real.\u003c/p\u003e\n\u003cp\u003eClassical frequentist statistics typically measures the difference between groups with a \u003ca href=\"https://en.wikipedia.org/wiki/Student%27s_t-test\"\u003et-test\u003c/a\u003e, but t-tests are 100+ years old and statistical methods have advanced a lot since 1908. Nowadays, we can use simulation and/or Bayesian methods to get richer information about the differences between two groups without worrying so much about the assumptions and preconditions for classical t-tests.\u003c/p\u003e\n\u003cp\u003eMostly as a resource to future me, here are a bunch of different ways to measure the difference in means in two groups. I’ve done them all in real life projects, but I’m tired of constantly searching my computer for the code to do them:)\u003c/p\u003e\n\u003cp\u003eThese ways can all be adapted to different situations (i.e. difference in proportions, one-sample difference in means, etc.). The process for simulation and Bayesian approaches will be roughly the same, while for frequentist approaches, you’ll need to walk through a \u003ca href=\"https://www.google.com/search?q=statistical+test+workflow\u0026amp;tbm=isch\"\u003estatistical test workflow\u003c/a\u003e to find the appropriate test.\u003c/p\u003e\n\u003cp\u003eAlso, this is long and really kind of meant as a general reference. Here’s a tl;dr table of contents:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#data\"\u003eData\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#classical-frequentist-t-tests\"\u003eClassical frequentist t-tests\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#t-test-assuming-equal-variances\"\u003et-test, assuming equal variances\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#t-test-assuming-unequal-variance\"\u003et-test, assuming unequal variance\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#simulation-based-tests\"\u003eSimulation-based tests\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#bayesian-regression\"\u003eBayesian regression\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#regression-assuming-equal-variances\"\u003eRegression, assuming equal variances\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#a-quick-digression-into-priors\"\u003eA quick digression into priors\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#regression-assuming-unequal-variances\"\u003eRegression, assuming unequal variances\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#regression-best\"\u003eRegression, BEST\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#bayesian-analysis-directly-with-stan\"\u003eBayesian analysis, directly with Stan\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#regression-best-with-priors-on-variables-instead-of-difference\"\u003eRegression, BEST, with priors on variables instead of difference\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#comparing-all-methods\"\u003eComparing all methods\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"data\"\u003eData\u003c/h2\u003e\n\u003cp\u003eFirst we need some data to play with. We’ll use the \u003ca href=\"https://cran.r-project.org/package=ggplot2movies\"\u003e\u003cstrong\u003eggplot2movies\u003c/strong\u003e package\u003c/a\u003e, which contains information about almost 60,000 movies from IMDB from 1893 to 2005. For this example, we want to see if there is a significant/substantial/real difference in the average IMDB rating for action movies and comedies. Are people more likely to rate comedies higher than action movies?\u003c/p\u003e\n\u003cp\u003eInstead of working with all 20,407 action movies and comedies, we take a random sample of 200 each. (This is just so we can have some variation in the group averages—if we work with all 20,000, the confidence intervals for each group average basically disappear since there are so many observations.)\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Load libraries\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)  \u003cspan style=\"color:#75715e\"\u003e# ggplot, dplyr, and friends\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(ggridges)   \u003cspan style=\"color:#75715e\"\u003e# Ridge plots\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(ggstance)   \u003cspan style=\"color:#75715e\"\u003e# Horizontal pointranges and bars\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(patchwork)  \u003cspan style=\"color:#75715e\"\u003e# Lay out multiple ggplot plots; install from https://github.com/thomasp85/patchwork\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(scales)     \u003cspan style=\"color:#75715e\"\u003e# Nicer formatting for numbers\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(broom)      \u003cspan style=\"color:#75715e\"\u003e# Convert model results to tidy data frames\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(infer)      \u003cspan style=\"color:#75715e\"\u003e# Statistical inference with simulation\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(rstan)      \u003cspan style=\"color:#75715e\"\u003e# R interface to Stan\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(brms)       \u003cspan style=\"color:#75715e\"\u003e# Run Stan-based models with standard R syntax\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(ggplot2movies)  \u003cspan style=\"color:#75715e\"\u003e# Lots of movies from IMDB\u003c/span\u003e\n\n\n\u003cspan style=\"color:#75715e\"\u003e# Clean up data\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eset.seed\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1234\u003c/span\u003e)  \u003cspan style=\"color:#75715e\"\u003e# Set seed so we get the same sampled rows every time\u003c/span\u003e\nmovies_clean \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e movies \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Make a binary column for genre\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(title, year, rating, Action, Comedy) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e!\u003c/span\u003e(Action \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e Comedy \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(genre \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecase_when\u003c/span\u003e(Action \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Action\u0026#34;\u003c/span\u003e,\n                           Comedy \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Comedy\u0026#34;\u003c/span\u003e,\n                           \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Neither\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(genre \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Neither\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Make a numeric version of genre, where action = 1, comedy = 2\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(genre_numeric \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eas.numeric\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003efactor\u003c/span\u003e(genre))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Make genre a factor\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(genre \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efactor\u003c/span\u003e(genre)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eAction, \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eComedy) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Randomly select 200 movies in each genre\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(genre) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003esample_n\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e200\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eungroup\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eTo get a sense of the data, we’ll do some quick exploratory data analysis with a bunch of different graph types.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Make a custom theme\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# I\u0026#39;m using Asap Condensed; download from \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# https://fonts.google.com/specimen/Asap+Condensed\u003c/span\u003e\ntheme_fancy \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e() {\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_minimal\u003c/span\u003e(base_family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Asap Condensed\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n    \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(panel.grid.minor \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e())\n}\n\neda_boxplot \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(movies_clean, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e genre, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e rating, fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e genre)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_boxplot\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_fill_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#0288b7\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#a90010\u0026#34;\u003c/span\u003e), guide \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003escale_y_continuous\u003c/span\u003e(breaks \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eseq\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Rating\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_fancy\u003c/span\u003e()\n\neda_histogram \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(movies_clean, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e rating, fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e genre)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_histogram\u003c/span\u003e(binwidth \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;white\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_fill_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#0288b7\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#a90010\u0026#34;\u003c/span\u003e), guide \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003escale_x_continuous\u003c/span\u003e(breaks \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eseq\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Count\u0026#34;\u003c/span\u003e, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Rating\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efacet_wrap\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e genre, nrow \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_fancy\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(panel.grid.major.x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e())\n\neda_ridges \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(movies_clean, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e rating, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_rev\u003c/span\u003e(genre), fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e genre)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003estat_density_ridges\u003c/span\u003e(quantile_lines \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e, quantiles \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, scale \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;white\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003escale_fill_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#0288b7\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#a90010\u0026#34;\u003c/span\u003e), guide \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003escale_x_continuous\u003c/span\u003e(breaks \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eseq\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Rating\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e,\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;White line shows median rating\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_fancy\u003c/span\u003e()\n\n(eda_boxplot \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e eda_histogram) \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e \n    eda_ridges \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eplot_annotation\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Do comedies get higher ratings than action movies?\u0026#34;\u003c/span\u003e,\n                  subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Sample of 400 movies from IMDB\u0026#34;\u003c/span\u003e,\n                  theme \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(text \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Asap Condensed\u0026#34;\u003c/span\u003e),\n                                plot.title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(face \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bold\u0026#34;\u003c/span\u003e,\n                                                          size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erel\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e))))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"eda-plots-1.png\" alt=\"Exploratory data analysis\"\u003e\u003c/p\u003e\n\u003cp\u003eInitially, it looks like there might be a difference in average rating. Comedies tend to have higher ratings. We can calculate the difference with some \u003cstrong\u003edplyr\u003c/strong\u003e \u003ccode\u003egroup_by() %\u0026gt;% summarize()\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003egroup_diffs \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e movies_clean \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(genre) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003esummarize\u003c/span\u003e(avg_rating \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emean\u003c/span\u003e(rating, na.rm \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(diff_means \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e avg_rating \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elead\u003c/span\u003e(avg_rating))\ngroup_diffs\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 2 x 3\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   genre  avg_rating diff_means\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;fct\u0026gt;       \u0026lt;dbl\u0026gt;      \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 Action       5.28     -0.682\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 Comedy       5.97     NA\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eYep. There’s a -0.6825 point difference in ratings. Action movies score 0.7 points lower than comedies, on average.\u003c/p\u003e\n\u003cp\u003eBut how certain are we that that difference is real and not just due to sampling error? It’s time for inference!\u003c/p\u003e\n\u003ch2 id=\"classical-frequentist-t-tests\"\u003eClassical frequentist t-tests\u003c/h2\u003e\n\u003ch3 id=\"t-test-assuming-equal-variances\"\u003et-test, assuming equal variances\u003c/h3\u003e\n\u003cp\u003eWe can use a standard frequentist t-test to check if the group means are different. We can assume that the variances in the two groups are the same and run \u003ccode\u003et.test()\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Assume equal variances\u003c/span\u003e\nt_test_eq \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003et.test\u003c/span\u003e(rating \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e genre, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e movies_clean, var.equal \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e)\nt_test_eq\n\n\u003cspan style=\"color:#75715e\"\u003e## \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  Two Sample t-test\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## data:  rating by genre\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## t = -4.4753, df = 398, p-value = 0.000009977\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## alternative hypothesis: true difference in means is not equal to 0\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 95 percent confidence interval:\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  -0.9823168 -0.3826832\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## sample estimates:\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## mean in group Action mean in group Comedy \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##               5.2845               5.9670\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe default output is helpful—the p-value is really tiny, which means there’s a tiny chance that we’d see a difference that big in group means in a world where there’s no difference. However, in this format, it’s hard to extract any of these values for later use, like in plotting. We can use the \u003ccode\u003etidy()\u003c/code\u003e function from the \u003cstrong\u003ebroom\u003c/strong\u003e library to convert these t-test results to a nice data frame.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003et_test_eq_tidy \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(t_test_eq) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Calculate difference in means, since t.test() doesn\u0026#39;t actually do that\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(estimate \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e estimate1 \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e estimate2) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Rearrange columns\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003estarts_with\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;estimate\u0026#34;\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003eeverything\u003c/span\u003e())\n\nt_test_eq_tidy\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 1 x 10\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   estimate1 estimate2 estimate statistic p.value parameter conf.low\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##       \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;   \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1      5.28      5.97   -0.682     -4.48 9.98e-6       398   -0.982\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## # … with 3 more variables: conf.high \u0026lt;dbl\u0026gt;, method \u0026lt;chr\u0026gt;,\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## #   alternative \u0026lt;chr\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eBy default, though, R does not assume that the variance in the two groups’ populations is equal, which is probably a reasonable thing to do. There may be structural differences in how comedies and action movies are produced, which in turn leads to structural differences in how they’re rated.\u003c/p\u003e\n\u003cp\u003eThere are several systematic ways to check if the two groups have equal variance. For all these tests, the null hypothesis is that the two groups have similar (homogeneous) variances. If the p-value is less than 0.05, we can assume that they have unequal or heterogeneous variances. (\u003ca href=\"https://statistic-on-air.blogspot.com/2009/07/analysis-of-variance-anova-for-multiple.html\"\u003eHere’s a helpful overview\u003c/a\u003e of this process.)\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://en.wikipedia.org/wiki/Bartlett%27s_test\"\u003e\u003cstrong\u003eBartlett test\u003c/strong\u003e\u003c/a\u003e: Check homogeneity of variances based on the mean\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003ebartlett.test\u003c/span\u003e(rating \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e genre, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e movies_clean)\n\n\u003cspan style=\"color:#75715e\"\u003e## \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  Bartlett test of homogeneity of variances\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## data:  rating by genre\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Bartlett\u0026#39;s K-squared = 0.10006, df = 1, p-value = 0.7518\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://en.wikipedia.org/wiki/Levene%27s_test\"\u003e\u003cstrong\u003eLevene test\u003c/strong\u003e\u003c/a\u003e: Check homogeneity of variances based on the median, so it’s more robust to outliers\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Install the car package first\u003c/span\u003e\ncar\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eleveneTest\u003c/span\u003e(rating \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e genre, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e movies_clean)\n\n\u003cspan style=\"color:#75715e\"\u003e## Levene\u0026#39;s Test for Homogeneity of Variance (center = median)\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##        Df F value Pr(\u0026gt;F)\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## group   1  0.4917 0.4836\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##       398\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://biostats.w.uib.no/test-for-homogeneity-of-variances-levenes-test/\"\u003e\u003cstrong\u003eFligner-Killeen test\u003c/strong\u003e\u003c/a\u003e: Check homogeneity of variances based on the median, so it’s more robust to outliers\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003efligner.test\u003c/span\u003e(rating \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e genre, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e movies_clean)\n\n\u003cspan style=\"color:#75715e\"\u003e## \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  Fligner-Killeen test of homogeneity of variances\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## data:  rating by genre\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Fligner-Killeen:med chi-squared = 0.78337, df = 1, p-value = 0.3761\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ca href=\"https://en.wikipedia.org/wiki/Kruskal%E2%80%93Wallis_one-way_analysis_of_variance\"\u003e\u003cstrong\u003eKruskal-Wallis test\u003c/strong\u003e\u003c/a\u003e: Check homogeneity of distributions nonparametrically\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003ekruskal.test\u003c/span\u003e(rating \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e genre, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e movies_clean)\n\n\u003cspan style=\"color:#75715e\"\u003e## \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  Kruskal-Wallis rank sum test\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## data:  rating by genre\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Kruskal-Wallis chi-squared = 19.787, df = 1, p-value = 0.000008655\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003ePhew. In all these tests except the Kruskall-Wallis test, we don’t have enough evidence to conclude that the variances are different, so we’re probably safe leaving \u003ccode\u003evar.equal = TRUE\u003c/code\u003e on.\u003c/p\u003e\n\u003ch3 id=\"t-test-assuming-unequal-variance\"\u003et-test, assuming unequal variance\u003c/h3\u003e\n\u003cp\u003eWe can run a t-test assuming that the two groups have unequal variances by setting \u003ccode\u003evar.equal = FALSE\u003c/code\u003e, or just leaving it off. I generally just do this instead of going through all the tests for equal variance.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Assume unequal variances\u003c/span\u003e\nt_test_uneq \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003et.test\u003c/span\u003e(rating \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e genre, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e movies_clean)\nt_test_uneq_tidy \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(t_test_uneq) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(estimate \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e estimate1 \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e estimate2) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003estarts_with\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;estimate\u0026#34;\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003eeverything\u003c/span\u003e())\nt_test_uneq_tidy\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 1 x 10\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   estimate estimate1 estimate2 statistic p.value parameter conf.low\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##      \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;   \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1   -0.682      5.28      5.97     -4.48 9.98e-6      398.   -0.982\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## # … with 3 more variables: conf.high \u0026lt;dbl\u0026gt;, method \u0026lt;chr\u0026gt;,\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## #   alternative \u0026lt;chr\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"simulation-based-tests\"\u003eSimulation-based tests\u003c/h2\u003e\n\u003cp\u003eInstead of dealing with all the assumptions of the data and finding the exact statistical test written by some dude in the 1940s, we can use the power of bootstrapping, permutation, and simulation to construct a null distribution and calculate confidence intervals. According to Allen Downey, \u003ca href=\"http://allendowney.blogspot.com/2016/06/there-is-still-only-one-test.html\"\u003ethere is actually only one statistical test\u003c/a\u003e and that at their core, all statistical tests follow the same universal pattern:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eStep 1: Calculate a sample statistic, or $\\delta$.\u003c/strong\u003e This is the main measure you care about: the difference in means, the average, the median, the proportion, the difference in proportions, the chi-squared value, etc.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eStep 2: Use simulation to invent a world where $\\delta$ is null.\u003c/strong\u003e Simulate what the world would look like if there was no difference between two groups, or if there was no difference in proportions, or where the average value is a specific number.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eStep 3: Look at $\\delta$ in the null world.\u003c/strong\u003e Put the sample statistic in the null world and see if it fits well.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eStep 4: Calculate the probability that $\\delta$ could exist in null world.\u003c/strong\u003e This is the p-value, or the probability that you’d see a $\\delta$ at least that high in a world where there’s no difference.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eStep 5: Decide if $\\delta$ is statistically significant.\u003c/strong\u003e Choose some evidentiary standard or threshold (like 0.05) for deciding if there’s sufficient proof for rejecting the null world.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eI have \u003ca href=\"https://www.andrewheiss.com/blog/2018/12/05/test-any-hypothesis/\"\u003ea fully commented example of how to do this with the \u003cstrong\u003einfer\u003c/strong\u003e package here\u003c/a\u003e. Once you get the hang of it, the \u003ca href=\"https://github.com/tidymodels/infer\"\u003e\u003cstrong\u003einfer\u003c/strong\u003e workflow\u003c/a\u003e is fairly intuitive and flexible and far more delightful than worrying about classical tests.\u003c/p\u003e\n\u003cp\u003eFirst we calculate the difference in means in the actual data:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Calculate the difference in means\u003c/span\u003e\ndiff_means \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e movies_clean \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003especify\u003c/span\u003e(rating \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e genre) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Order here means we subtract comedy from action (Action - Comedy)\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecalculate\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;diff in means\u0026#34;\u003c/span\u003e, order \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Action\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Comedy\u0026#34;\u003c/span\u003e))\ndiff_means\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 1 x 1\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##     stat\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##    \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 -0.682\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThen we can generate a bootstrapped distribution of the difference in means based on our sample and calculate the confidence interval:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eboot_means \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e movies_clean \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003especify\u003c/span\u003e(rating \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e genre) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egenerate\u003c/span\u003e(reps \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1000\u003c/span\u003e, type \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bootstrap\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003ecalculate\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;diff in means\u0026#34;\u003c/span\u003e, order \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Action\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Comedy\u0026#34;\u003c/span\u003e))\n\nboostrapped_confint \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e boot_means \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eget_confidence_interval\u003c/span\u003e()\n\nboot_means \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003evisualize\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eshade_confidence_interval\u003c/span\u003e(boostrapped_confint,\n                            color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#8bc5ed\u0026#34;\u003c/span\u003e, fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#85d9d2\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_vline\u003c/span\u003e(xintercept \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e diff_means\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003estat, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#77002c\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Bootstrapped distribution of differences in means\u0026#34;\u003c/span\u003e,\n       x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Action − Comedy\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Count\u0026#34;\u003c/span\u003e,\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Red line shows observed difference; shaded area shows 95% confidence interval\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_fancy\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"sim-boot-1.png\" alt=\"Bootstrapped confidence interval\"\u003e\u003c/p\u003e\n\u003cp\u003eNeat. We have a simulation-based confidence interval, and it doesn’t contain zero, so we can have some confidence that there’s a real difference between the two groups.\u003c/p\u003e\n\u003cp\u003eWe can go through the testing process more thoroughly by following Downey’s process. We’ve already done step one (calculate $\\delta$); next we generate a world where there’s no difference by shuffling all the action/comedy labels through permutation\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Step 2: Invent a world where δ is null\u003c/span\u003e\ngenre_diffs_null \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e movies_clean \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003especify\u003c/span\u003e(rating \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e genre) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003ehypothesize\u003c/span\u003e(null \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;independence\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egenerate\u003c/span\u003e(reps \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e5000\u003c/span\u003e, type \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;permute\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003ecalculate\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;diff in means\u0026#34;\u003c/span\u003e, order \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Action\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Comedy\u0026#34;\u003c/span\u003e))\n\n\u003cspan style=\"color:#75715e\"\u003e# Step 3: Put actual observed δ in the null world and see if it fits\u003c/span\u003e\ngenre_diffs_null \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003evisualize\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egeom_vline\u003c/span\u003e(xintercept \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e diff_means\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003estat, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#77002c\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_y_continuous\u003c/span\u003e(labels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e comma) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Simulated difference in average ratings (Action − Comedy)\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Count\u0026#34;\u003c/span\u003e,\n       title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Simulation-based null distribution of differences in means\u0026#34;\u003c/span\u003e,\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Red line shows observed difference\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_fancy\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"sim-generate-null-world-1.png\" alt=\"Simulated p-value\"\u003e\u003c/p\u003e\n\u003cp\u003eThat red line is pretty far to the left and seems like it wouldn’t fit very well in a world where there’s no actual difference between the groups. We can calculate the probability of seeing that red line in a null world (step 4) with \u003ccode\u003eget_p_value()\u003c/code\u003e (and we can use the cool new \u003ccode\u003epvalue()\u003c/code\u003e function in the \u003cstrong\u003escales\u003c/strong\u003e library to format it as \u0026lt; 0.001):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Step 4: Calculate probability that observed δ could exist in null world\u003c/span\u003e\ngenre_diffs_null \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eget_p_value\u003c/span\u003e(obs_stat \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e diff_means, direction \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;both\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(p_value_clean \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epvalue\u003c/span\u003e(p_value))\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 1 x 2\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   p_value p_value_clean\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##     \u0026lt;dbl\u0026gt; \u0026lt;chr\u0026gt;        \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1       0 \u0026lt;0.001\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eBecause the p-value is so small, it passes pretty much all evidentiary thresholds (p \u0026lt; 0.05, p \u0026lt; 0.01, etc), so we can safely say that there’s a difference between the two groups. Action movies are rated lower, on average, than comedies.\u003c/p\u003e\n\u003ch2 id=\"bayesian-regression\"\u003eBayesian regression\u003c/h2\u003e\n\u003cp\u003eNext we can leave the world of frequentist statistics and null hypothesis testing and do some Bayesian analysis. Frequentist null hypothesis significance testing (NHST) determines the \u003cem\u003eprobability of the data given a null hypothesis\u003c/em\u003e (i.e. $P(\\text{data} | H)$, yielding results that are often unwieldy, phrased as the probability of rejecting the null if it is true (hence all that talk of “null worlds” earlier). In contrast, Bayesian analysis determines the \u003cem\u003eprobability of a hypothesis given the data\u003c/em\u003e (i.e.$P(H | \\text{data})$), resulting in probabilities that are directly interpretable.\u003c/p\u003e\n\u003cp\u003eBayesian analysis is way more computationally intensive and requires more upfront work (e.g prior specification). Because of this, R itself doesn’t have robust support for the actual Monte Carlo sampling and other computational heavy lifting involved in Bayesian stuff. Instead, it can connect to external sampling programs that are optimized for this kind of repetitive simulation work. \u003ca href=\"https://en.wikipedia.org/wiki/Bayesian_inference_using_Gibbs_sampling\"\u003eBUGS\u003c/a\u003e and \u003ca href=\"http://mcmc-jags.sourceforge.net/\"\u003eJAGS\u003c/a\u003e were popular sampling software tools, but nowadays all the cool kids are using \u003ca href=\"https://mc-stan.org/\"\u003eStan\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eWriting Stan code by hand is tricky since it requires that you essentially learn another programming language. Fortunately, you technically can do Bayesian analysis without writing a single line of Stan code. There are two different packages that precompile Stan code for you:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://mc-stan.org/users/interfaces/rstanarm\"\u003e\u003cstrong\u003erstanarm\u003c/strong\u003e\u003c/a\u003e: This is written by the Stan team itself and provides functions like \u003ccode\u003estan_lm()\u003c/code\u003e and \u003ccode\u003estan_glm()\u003c/code\u003e that are drop-in replacements for R’s standard \u003ccode\u003elm()\u003c/code\u003e and \u003ccode\u003eglm()\u003c/code\u003e. The code is highly optimized and precompiled and runs really fast, but there’s no good way to inspect the underlying Stan code. Also, it’s more limited in the types of regression it supports.\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://github.com/paul-buerkner/brms\"\u003e\u003cstrong\u003ebrms\u003c/strong\u003e\u003c/a\u003e: This provides a more universal front end for Stan and supports a wider variety of models. It doesn’t have drop-in \u003ccode\u003elm()\u003c/code\u003e replacements, but the \u003ccode\u003ebrm()\u003c/code\u003e function is fairly intuitive after poring through the documentation and examples. It’s slower than \u003cstrong\u003erstanarm\u003c/strong\u003e because it has to compile the Stan scripts it generates with C++, but you can inspect the Stan code behind each of the models with \u003ccode\u003estancode()\u003c/code\u003e and better see what’s going on behind the scenes.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThere aren’t really any cool front end packages for running non-regression analyses with Stan from R (there is \u003ca href=\"http://www.sumsar.net/blog/2014/02/bayesian-first-aid-one-sample-t-test/\"\u003eRasmus Bååth’s Bayesian First Aid package\u003c/a\u003e, but it uses JAGS and hasn’t been updated in a while and I want to use Stan like the cool kids), but you can actually calculate differences in means with regression, which means we can approximate frequentist t-tests without writing any Stan code.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://vuorre.netlify.com/post/2017/01/02/how-to-compare-two-groups-with-robust-bayesian-estimation-using-r-stan-and-brms/\"\u003eThis blog post by Matti Vuorre\u003c/a\u003e is a masterpiece and clearly explains the rationale behind how and why you can use regression for t-tests. This code here is adapted from his stuff.\u003c/p\u003e\n\u003cp\u003eFirst, we’ll set a bunch of Monte Carlo parameters:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eCHAINS \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e\nITER \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2000\u003c/span\u003e\nWARMUP \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1000\u003c/span\u003e\nBAYES_SEED \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1234\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eoptions\u003c/span\u003e(mc.cores \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e parallel\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003edetectCores\u003c/span\u003e())  \u003cspan style=\"color:#75715e\"\u003e# Use all cores\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"regression-assuming-equal-variances\"\u003eRegression, assuming equal variances\u003c/h3\u003e\n\u003cp\u003eThen we can run the model. We set a couple priors for the intercept (normal, with a mean of 0 and standard deviation of 5) and the beta/slope (normal, with a mean of 0 and a standard deviation of 1). In this model, \u003ccode\u003erating ~ genre\u003c/code\u003e, we assume equal variances between the groups.\u003c/p\u003e\n\u003cp\u003eWe use \u003ccode\u003etidyMCMC\u003c/code\u003e from \u003cstrong\u003ebroom\u003c/strong\u003e to calculate the medians of the posterior distributions and create confidence intervals.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ebrms_eq \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ebrm\u003c/span\u003e(\n  \u003cspan style=\"color:#75715e\"\u003e# bf() is an alias for brmsformula() and lets you specify model formulas\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ebf\u003c/span\u003e(rating \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e genre), \n  \u003cspan style=\"color:#75715e\"\u003e# Reverse the levels of genre so that comedy is the base case\u003c/span\u003e\n  data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(movies_clean, genre \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_rev\u003c/span\u003e(genre)),\n  prior \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eset_prior\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;normal(0, 5)\u0026#34;\u003c/span\u003e, class \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Intercept\u0026#34;\u003c/span\u003e),\n            \u003cspan style=\"color:#a6e22e\"\u003eset_prior\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;normal(0, 1)\u0026#34;\u003c/span\u003e, class \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;b\u0026#34;\u003c/span\u003e)),\n  chains \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e CHAINS, iter \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ITER, warmup \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e WARMUP, seed \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e BAYES_SEED,\n  file \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;cache/brms_eq\u0026#34;\u003c/span\u003e\n)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ebrms_eq_tidy \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etidyMCMC\u003c/span\u003e(brms_eq, conf.int \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e, conf.level \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.95\u003c/span\u003e, \n           estimate.method \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;median\u0026#34;\u003c/span\u003e, conf.method \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;HPDinterval\u0026#34;\u003c/span\u003e)\nbrms_eq_tidy\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 3 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term          estimate std.error conf.low conf.high\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;            \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 b_Intercept      5.96     0.108     5.74      6.16 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 b_genreAction   -0.666    0.152    -0.968    -0.374\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 sigma            1.53     0.0529    1.43      1.64\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eHere the intercept represents the mean comedy score, while the coefficient for action represents the difference from that mean, or the effect that we care about. These findings match what we got with the frequentist work from earlier, only now we can change the interpretation: We’re 95% confident that the true population-level difference in rating is between -0.968 and -0.374, with a median of -0.666.\u003c/p\u003e\n\u003ch3 id=\"a-quick-digression-into-priors\"\u003eA quick digression into priors\u003c/h3\u003e\n\u003cp\u003eIf you don’t explicitly set any priors, \u003cstrong\u003ebrms\u003c/strong\u003e chooses sensible defaults for you. You can see what priors you can potentially set with \u003ccode\u003eget_prior()\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eget_prior\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ebf\u003c/span\u003e(rating \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e genre), data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e movies_clean)\n\n\u003cspan style=\"color:#75715e\"\u003e##                 prior     class        coef group resp dpar nlpar bound\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1                             b                                        \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2                             b genreComedy                            \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 student_t(3, 6, 10) Intercept                                        \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4 student_t(3, 0, 10)     sigma\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eYou can use this table to select which prior you want to set. For instance, to specify the prior distribution for the intercept, you can use \u003ccode\u003eset_prior(\u0026quot;normal(0, 5)\u0026quot;, class = \u0026quot;Intercept\u0026quot;)\u003c/code\u003e, which matches the table. More complicated formulas will have values in the \u003ccode\u003edpar\u003c/code\u003e and \u003ccode\u003enlpar\u003c/code\u003e columns, and you can use those to drill down to specific priors for those terms (e.g. \u003ccode\u003eset_prior(\u0026quot;cauchy(0, 1)\u0026quot;, class = \u0026quot;b\u0026quot;, dpar = \u0026quot;sigma\u0026quot;)\u003c/code\u003e).\u003c/p\u003e\n\u003cp\u003eAlso, you can plot the different distributions to get a sense of their shapes with either base R or with ggplot:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Normal distribution: normal(0, 5)\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ecurve\u003c/span\u003e(expr \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(x, mean \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, sd \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e), from \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e-20\u003c/span\u003e, to \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e20\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cfigure class=\"img-50\"\u003e\u003cimg src=\"dist-base-norm-1.png\"\n         alt=\"Normal distribution\"/\u003e\n\u003c/figure\u003e\n\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Cauchy distribution: cauchy(0, 1)\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ecurve\u003c/span\u003e(expr \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edcauchy\u003c/span\u003e(x, location \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, scale \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e), from \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e-5\u003c/span\u003e, to \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cfigure class=\"img-50\"\u003e\u003cimg src=\"dist-base-cauchy-1.png\"\n         alt=\"Cauchy distribution\"/\u003e\n\u003c/figure\u003e\n\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Or do this with ggplot\u003c/span\u003e\nnorm_ggplot \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e-20\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e20\u003c/span\u003e)), \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003estat_function\u003c/span\u003e(fun \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e dnorm, n \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e500\u003c/span\u003e, args \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(mean \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, sd \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;normal(0, 5)\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_fancy\u003c/span\u003e()\n\ncauchy_ggplot \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e-5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e)), \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003estat_function\u003c/span\u003e(fun \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e dcauchy, n \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e500\u003c/span\u003e, args \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(location \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, scale \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;cauchy(0, 1)\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_fancy\u003c/span\u003e()\n\nnorm_ggplot \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e cauchy_ggplot\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cfigure class=\"img-75\"\u003e\u003cimg src=\"dists-ggplot-1.png\"\n         alt=\"Normal and Cauchy distributions with ggplot\"/\u003e\n\u003c/figure\u003e\n\n\u003ch3 id=\"regression-assuming-unequal-variances\"\u003eRegression, assuming unequal variances\u003c/h3\u003e\n\u003cp\u003eWe can also use regression to estimate the difference in means under the assumption that group variances are different. Here, following \u003ca href=\"https://vuorre.netlify.com/post/2017/01/02/how-to-compare-two-groups-with-robust-bayesian-estimation-using-r-stan-and-brms/#equal-variances-model\"\u003eMatti Vuorre\u003c/a\u003e, we need to model the variance (or sigma) in each group, and we need to specify a prior for that term (I chose \u003ccode\u003ecauchy(0, 1\u003c/code\u003e). We do this by specifying two formulas in \u003ccode\u003ebrm()\u003c/code\u003e.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ebrms_uneq \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ebrm\u003c/span\u003e(\n  \u003cspan style=\"color:#a6e22e\"\u003ebf\u003c/span\u003e(rating \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e genre, sigma \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e genre), \n  data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(movies_clean, genre \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_rev\u003c/span\u003e(genre)),\n  prior \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eset_prior\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;normal(0, 5)\u0026#34;\u003c/span\u003e, class \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Intercept\u0026#34;\u003c/span\u003e),\n            \u003cspan style=\"color:#a6e22e\"\u003eset_prior\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;normal(0, 1)\u0026#34;\u003c/span\u003e, class \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;b\u0026#34;\u003c/span\u003e),\n            \u003cspan style=\"color:#a6e22e\"\u003eset_prior\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;cauchy(0, 1)\u0026#34;\u003c/span\u003e, class \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;b\u0026#34;\u003c/span\u003e, dpar \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sigma\u0026#34;\u003c/span\u003e)),\n  chains \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e CHAINS, iter \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ITER, warmup \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e WARMUP, seed \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e BAYES_SEED,\n  file \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;cache/brms_uneq\u0026#34;\u003c/span\u003e\n)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ebrms_uneq_tidy \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etidyMCMC\u003c/span\u003e(brms_uneq, conf.int \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e, conf.level \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.95\u003c/span\u003e, \n           estimate.method \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;median\u0026#34;\u003c/span\u003e, conf.method \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;HPDinterval\u0026#34;\u003c/span\u003e)\nbrms_uneq_tidy\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 4 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term                estimate std.error conf.low conf.high\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;                  \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 b_Intercept           5.96      0.111     5.73      6.17 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 b_sigma_Intercept     0.433     0.0494    0.335     0.528\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 b_genreAction        -0.665     0.156    -0.979    -0.371\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4 b_sigma_genreAction  -0.0199    0.0702   -0.161     0.113\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFor mathy reasons (again, \u003ca href=\"https://vuorre.netlify.com/post/2017/01/02/how-to-compare-two-groups-with-robust-bayesian-estimation-using-r-stan-and-brms/#unequal-variances-model\"\u003esee Matti Vourre’s post\u003c/a\u003e), the sigma terms are on a log scale, so we need to exponentiate them back to the scale of the data.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ebrms_uneq_tidy \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate_at\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003evars\u003c/span\u003e(estimate, std.error, conf.low, conf.high),\n            \u003cspan style=\"color:#a6e22e\"\u003efuns\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eifelse\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003estr_detect\u003c/span\u003e(term, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sigma\u0026#34;\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003eexp\u003c/span\u003e(.), .)))\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 4 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term                estimate std.error conf.low conf.high\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;                  \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 b_Intercept            5.96      0.111    5.73      6.17 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 b_sigma_Intercept      1.54      1.05     1.40      1.70 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 b_genreAction         -0.665     0.156   -0.979    -0.371\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4 b_sigma_genreAction    0.980     1.07     0.851     1.12\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eHere, the interpretation for the intercept and action coefficients are the same as before: the intercept the average comedy rating; the action coefficient is the change from the average comedy rating, or the effect we care about. The sigmas work similarly: the intercept sigma is the standard deviation for comedies; the intercept sigma + action sigma is the standard deviation for action movies.\u003c/p\u003e\n\u003ch3 id=\"regression-best\"\u003eRegression, BEST\u003c/h3\u003e\n\u003cp\u003eA more robust way of estimating group differences Bayesianly is to use John Kruschke’s \u003ca href=\"https://psycnet.apa.org/doi/10.1037/a0029146\"\u003eBayesian Estimation Supersedes the t Test (BEST)\u003c/a\u003e method. I’m 100% not going into the nitty gritty details of this (\u003ca href=\"https://vuorre.netlify.com/post/2017/01/02/how-to-compare-two-groups-with-robust-bayesian-estimation-using-r-stan-and-brms/#robust-bayesian-estimation\"\u003eMatti Vuorre has, though\u003c/a\u003e). In the most simplest terms, the only difference between BEST and the unequal variance regression above is that we model the data with a t distribution, which means we have a new parameter, $\\nu$ (nu), that changes the normality of the distribution (i.e. the degrees of freedom parameter in a t distribution). Kruschke uses an exponential prior with a rate of 1/29 in his paper, so we do too. It looks like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e)), \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003estat_function\u003c/span\u003e(fun \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e dexp, n \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e500\u003c/span\u003e, args \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(rate \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e29\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;exponential(1/29)\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_fancy\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cfigure class=\"img-75\"\u003e\u003cimg src=\"dist-exp-1.png\"\n         alt=\"Exponential distribution\"/\u003e\n\u003c/figure\u003e\n\n\u003cp\u003eAdd \u003ccode\u003efamily = student\u003c/code\u003e and set the prior for \u003ccode\u003enu\u003c/code\u003e and we’re ready to go:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ebrms_uneq_robust \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ebrm\u003c/span\u003e(\n  \u003cspan style=\"color:#a6e22e\"\u003ebf\u003c/span\u003e(rating \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e genre, sigma \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e genre), \n  family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e student,\n  data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(movies_clean, genre \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_rev\u003c/span\u003e(genre)),\n  prior \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eset_prior\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;normal(0, 5)\u0026#34;\u003c/span\u003e, class \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Intercept\u0026#34;\u003c/span\u003e),\n            \u003cspan style=\"color:#a6e22e\"\u003eset_prior\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;normal(0, 1)\u0026#34;\u003c/span\u003e, class \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;b\u0026#34;\u003c/span\u003e),\n            \u003cspan style=\"color:#a6e22e\"\u003eset_prior\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;cauchy(0, 1)\u0026#34;\u003c/span\u003e, class \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;b\u0026#34;\u003c/span\u003e, dpar \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sigma\u0026#34;\u003c/span\u003e),\n            \u003cspan style=\"color:#a6e22e\"\u003eset_prior\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;exponential(1.0/29)\u0026#34;\u003c/span\u003e, class \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;nu\u0026#34;\u003c/span\u003e)),\n  chains \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e CHAINS, iter \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ITER, warmup \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e WARMUP, seed \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e BAYES_SEED,\n  file \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;cache/brms_uneq_robust\u0026#34;\u003c/span\u003e\n)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ebrms_uneq_robust_tidy \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etidyMCMC\u003c/span\u003e(brms_uneq_robust, conf.int \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e, conf.level \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.95\u003c/span\u003e, \n           estimate.method \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;median\u0026#34;\u003c/span\u003e, conf.method \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;HPDinterval\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Rescale sigmas\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate_at\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003evars\u003c/span\u003e(estimate, std.error, conf.low, conf.high),\n            \u003cspan style=\"color:#a6e22e\"\u003efuns\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eifelse\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003estr_detect\u003c/span\u003e(term, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sigma\u0026#34;\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003eexp\u003c/span\u003e(.), .)))\nbrms_uneq_robust_tidy\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 5 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term                estimate std.error conf.low conf.high\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;                  \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 b_Intercept            5.98      0.104    5.77      6.17 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 b_sigma_Intercept      1.47      1.06     1.31      1.66 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 b_genreAction         -0.680     0.148   -0.966    -0.394\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4 b_sigma_genreAction    0.999     1.08     0.860     1.16 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5 nu                    31.9      27.5      5.62     95.1\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNeato. Just like the other models, the coefficient for action shows us the difference in means (and it’s super similar to everything else). We can exponentiate the sigma coefficients and see the group standard deviations, and we have a coefficient for $\\nu$, or the degrees of freedom for the underlying distribution.\u003c/p\u003e\n\u003ch2 id=\"bayesian-analysis-directly-with-stan\"\u003eBayesian analysis, directly with Stan\u003c/h2\u003e\n\u003cp\u003e\u003cstrong\u003eUpdate\u003c/strong\u003e: \u003ca href=\"https://mikedecr.github.io/\"\u003eMike DeCrescenzo\u003c/a\u003e made a \u003ca href=\"https://twitter.com/mikedecr/status/1090416939917340672\"\u003efascinating point on Twitter\u003c/a\u003e that relying on regression for t-test-like analysis with Bayesianism actually has important theoretical implications. When specifying a model as \u003ccode\u003ey ~ a + bx\u003c/code\u003e as we did above with \u003ccode\u003erating ~ genre\u003c/code\u003e, the coefficient for genre (\u003ccode\u003eb\u003c/code\u003e) is actually the difference in means and doesn\u0026rsquo;t directly reflect the rating itself. In theory, if we\u0026rsquo;re thinking about two groups with two different variances, we should model the distribution of each group, not the distribution of the differences in groups. Analyzing the distributions of the two groups separately and \u003cem\u003ethen\u003c/em\u003e calculating the difference should yield more transparent results. And that\u0026rsquo;s why we can/should do the analysis in Stan by hand like this.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eAnother update\u003c/strong\u003e: \u003ca href=\"https://twitter.com/tjmahr/status/1090417050600816641?s=21\"\u003eAccording to TJ Mahr\u003c/a\u003e, you can get around this beta-for-the-difference issue by running a model like \u003ccode\u003erating ~ 0 + genre\u003c/code\u003e, which suppresses the intercept and estimates coefficients for both groups directly. You have to calculate the difference in coefficients/group means by hand after, but at least you\u0026rsquo;ll be estimating the right things.\u003c/p\u003e\n\u003cp\u003eInstead of using regression models and combining coefficients to figure out group means and differences, we can be brave and write actual Stan code that can return any value we want. We don’t have to be constrained by regression formulas, but we do have to figure out how to code in Stan, which is intimidating.\u003c/p\u003e\n\u003cp\u003eThere are lots of resources out there for Stan (and Bayesianism in general), including \u003ca href=\"https://xcelab.net/rm/statistical-rethinking/\"\u003eRichard McElreath’s \u003cem\u003eStatistical Rethinking\u003c/em\u003e\u003c/a\u003e, which has all its code in raw Stan \u003cem\u003eand\u003c/em\u003e brms syntax. John Kruschke’s \u003cem\u003eDoing Bayesian Data Analysis\u003c/em\u003e book includes code in both JAGS and Stan (click on \u003ca href=\"https://sites.google.com/site/doingbayesiandataanalysis/software-installation\"\u003ethe link in step 5 here\u003c/a\u003e; the code for BEST analysis is in the file named \u003ccode\u003eStan-Ymet-Xnom2grp-MrobustHet.R\u003c/code\u003e).\u003c/p\u003e\n\u003cp\u003eBut the resource that made the structure of Stan files (mostly) click for me was a recorded class (specifically \u003ca href=\"https://www.youtube.com/watch?v=-mfeHHLcb1g\"\u003ethe session from 2017-01-30\u003c/a\u003e) by \u003ca href=\"https://github.com/mike-lawrence\"\u003eMike Lawrence\u003c/a\u003e (a Canadian researcher) that \u003ca href=\"https://discourse.mc-stan.org/t/what-would-be-a-good-resource-to-understand-the-method-of-two-sample-bayesian-hypothesis-testing/1492/6\"\u003eI stumbled on\u003c/a\u003e while searching the internet for ways to run BEST with Stan. Though the video is super long (you can skip around and/or watch at 2x speed; the two-sample example starts at minute 52), Mike clearly lays out the process for writing a Stan file and it’s the coolest thing ever. EVEN BETTER is the fact that he provides \u003ca href=\"https://www.dropbox.com/sh/js0us2461w98bn7/AADcxczFADrCfnSA2qo8Gb2wa?dl=0\"\u003eall the code from his class on Dropbox\u003c/a\u003e (see the \u003ca href=\"https://www.dropbox.com/sh/js0us2461w98bn7/AACjhob9JjkfncwkEjyI2-Pxa/2017-01-30?dl=0\u0026amp;subfolder_nav_tracking=1\"\u003ecode from 2017-01-30\u003c/a\u003e for t-test related stuff)\u003c/p\u003e\n\u003cp\u003eThrough a combination of Mike Lawrence’s video, \u003ca href=\"https://github.com/m-clark/Miscellaneous-R-Code/blob/master/ModelFitting/Bayesian/rstant_testBEST.R\"\u003eMichael Clark’s BEST implementation here\u003c/a\u003e, John Kruschke’s Stan code, and lots of debugging, \u003ca href=\"imdb_best.stan\"\u003eI created this Stan code\u003c/a\u003e. Explaining the whole logic behind it goes way beyond the scope of this blog post, but I heavily commented it so it should be easy-ish to follow if you understand Stan files (which I still don’t completely ¯\\_(ツ)_/¯).\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/andrewheiss/diff-means-half-dozen-ways/blob/master/imdb_best.stan\"\u003eDownload \u003ccode\u003efancy-best.stan\u003c/code\u003e\u003c/a\u003e and put it in the same folder as whatever script you’re typing in (or change the path to match wherever you put it). Note how the \u003ccode\u003edata\u003c/code\u003e argument in \u003ccode\u003esampling()\u003c/code\u003e doesn’t just take a data frame like in \u003ccode\u003ebrm()\u003c/code\u003e. We have to pass Stan specific pieces of data, all of which are specified in the \u003ccode\u003edata{}\u003c/code\u003e block in the Stan script.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003estan_best \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003esampling\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003estan_model\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;imdb_best.stan\u0026#34;\u003c/span\u003e), \n           \u003cspan style=\"color:#75715e\"\u003e# Make a list of data to send to Stan\u003c/span\u003e\n           data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(N \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003enrow\u003c/span\u003e(movies_clean), \n                       n_groups \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elength\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eunique\u003c/span\u003e(movies_clean\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003egenre)), \n                       group_id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e movies_clean\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003egenre_numeric, \n                       y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e movies_clean\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003erating),\n           chains \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e CHAINS, iter \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ITER, warmup \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e WARMUP, seed \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e BAYES_SEED)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003estan_best_tidy \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etidyMCMC\u003c/span\u003e(stan_best, conf.int \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e, conf.level \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.95\u003c/span\u003e, \n           estimate.method \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;median\u0026#34;\u003c/span\u003e, conf.method \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;HPDinterval\u0026#34;\u003c/span\u003e)\nstan_best_tidy\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 8 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term     estimate std.error conf.low conf.high\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;       \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 mu[1]       5.29     0.108     5.09      5.50 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 mu[2]       5.99     0.104     5.79      6.19 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 sigma[1]    1.47     0.0838    1.30      1.63 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4 sigma[2]    1.47     0.0885    1.30      1.65 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5 nu         29.0     20.1       6.35     76.2  \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6 mu_diff    -0.693    0.147    -0.992    -0.422\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 7 cohen_d    -0.573    0.123    -0.825    -0.349\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 8 cles        0.343    0.0318    0.280     0.402\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eOne advantage of running the analysis with raw Stan instead of forcing it into regression form is that we can have Stan calculate all sorts of stuff for us. The averages for both groups get returned (\u003ccode\u003emu[1]\u003c/code\u003e and \u003ccode\u003emu[2]\u003c/code\u003e), along with \u003ccode\u003emu_diff\u003c/code\u003e, so there\u0026rsquo;s no need to combine slope and intercept terms. Also note how the \u003ccode\u003esigma\u003c/code\u003e coefficients are already in the right scale. I also (following Kruschke and others) made it so that the Stan code returned information about effect sizes, including \u003ca href=\"https://en.wikipedia.org/wiki/Effect_size#Cohen's_d\"\u003eCohen\u0026rsquo;s d\u003c/a\u003e, which is the standardized difference in means, and the \u003ca href=\"https://janhove.github.io/reporting/2016/11/16/common-language-effect-sizes\"\u003ecommon language effect size (CLES)\u003c/a\u003e, which is the probability that a rating sampled at random from one group will be greater than a rating sampled from the other group.\u003c/p\u003e\n\u003cp\u003eHere, the difference in means is the same as all the other methods, but the effect size isn’t terribly huge. According to Cohen’s d, we have a medium effect size, and there’s a 34% chance that we could randomly select an action rating from the comedy distribution.\u003c/p\u003e\n\u003ch2 id=\"regression-best-with-priors-on-variables-instead-of-difference\"\u003eRegression, BEST, with priors on variables instead of difference\u003c/h2\u003e\n\u003cp\u003e\u003cem\u003e(I added this section later)\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eIn the Twitter discussion that followed this post, \u003ca href=\"https://mikedecr.github.io/\"\u003eMike DeCrescenzo\u003c/a\u003e made a \u003ca href=\"https://twitter.com/mikedecr/status/1090416939917340672\"\u003efascinating point\u003c/a\u003e that relying on regression for t-test-like analysis with Bayesianism actually has important theoretical implications.\u003c/p\u003e\n\u003cp\u003eWhen specifying a model as \u003ccode\u003ey ~ a + bx\u003c/code\u003e as we did above with \u003ccode\u003erating ~ genre\u003c/code\u003e, the coefficient for genre (\u003ccode\u003eb\u003c/code\u003e) is actually the difference in means and doesn’t directly reflect the rating itself. In theory, if\nwe’re thinking about two groups with two different variances, we should model the distribution of each group, not the distribution of the differences in groups. Analyzing the distributions of the two groups separately and \u003cem\u003ethen\u003c/em\u003e calculating the difference should yield more transparent results. Plus it’s easier to think about setting priors on two variables that were measured in real life (e.g. ratings for comedies and action movies), rather than setting priors on whatever the difference between those looks like.\u003c/p\u003e\n\u003cp\u003eThe raw Stan code above does this correctly by feeding two groups into the model rather than the difference in means. \u003ca href=\"https://twitter.com/tjmahr/status/1090417050600816641?s=21\"\u003eTJ Mahr\u003c/a\u003e and \u003ca href=\"https://github.com/ASKurz/Doing-Bayesian-Data-Analysis-in-brms-and-the-tidyverse\"\u003eSolomon Kurz’s translation of Kruschke’s code into \u003cstrong\u003ebrms\u003c/strong\u003e\u003c/a\u003e (\u003ca href=\"https://github.com/ASKurz/Doing-Bayesian-Data-Analysis-in-brms-and-the-tidyverse/blob/master/16.Rmd\"\u003esee near the bottom of chapter 16\u003c/a\u003e) both show that we can do this with \u003cstrong\u003ebrms\u003c/strong\u003e by changing the formula slightly. If we suppress the intercept by running a model like \u003ccode\u003eratiing ~ 0 + genre\u003c/code\u003e, \u003cstrong\u003ebrms\u003c/strong\u003e returns coefficients for each of the groups (no more base case!), and these coefficients represent group means.\u003c/p\u003e\n\u003cp\u003eHere’s an intercept-free version of the \u003cstrong\u003ebrms\u003c/strong\u003e-based BEST regression from earlier. Note how we’re modeling both the rating and the group sigmas without intercepts (\u003ccode\u003erating ~ 0 + genre, sigma ~ 0 + genre\u003c/code\u003e), and that we no longer specify a prior for the intercept (if we do, \u003ccode\u003ebrm()\u003c/code\u003e yells at us). Also note that instead of modeling the beta coefficient as a normal distribution centered around zero (since that represented the difference in means), we specify the distribution of action and comedy ratings themselves. Because we’re dealing with actual ratings, we can make them fairly well informed and constrained. For instance, no movie is rated below 1 or above 10, and I’m guessing from past experience looking at ratings on Amazon and IMDB and elsewhere that people tend to inflate their ratings. I’d guess that the distribution of ratings looks something like this: normally distributed with a mean of 6, standard deviation of 2, and truncated at 1 and 10.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Cool extra thing I discovered: the msm library has rtnorm, dtnorm, and family\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# which let you plot and draw from a truncated normal distribution\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# msm::rtnorm(1000, mean = 6, sd = 2, lower = 1, upper = 10)\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)), \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003estat_function\u003c/span\u003e(fun \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e dnorm, n \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e500\u003c/span\u003e, args \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(mean \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e6\u003c/span\u003e, sd \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;normal(6, 2); truncated at 1 and 10\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_fancy\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cfigure class=\"img-75\"\u003e\u003cimg src=\"dist-ratings-1.png\"\n         alt=\"Normal distribution, truncated\"/\u003e\n\u003c/figure\u003e\n\n\u003cp\u003eNow we can run the model like normal:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ebrms_uneq_robust_groups \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ebrm\u003c/span\u003e(\n  \u003cspan style=\"color:#a6e22e\"\u003ebf\u003c/span\u003e(rating \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e genre, sigma \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e genre), \n  family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e student,\n  data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(movies_clean, genre \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_rev\u003c/span\u003e(genre)),\n  prior \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\n    \u003cspan style=\"color:#75715e\"\u003e# Set group mean prior\u003c/span\u003e\n    \u003cspan style=\"color:#a6e22e\"\u003eset_prior\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;normal(6, 2)\u0026#34;\u003c/span\u003e, class \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;b\u0026#34;\u003c/span\u003e, lb \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, ub \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e),\n    \u003cspan style=\"color:#75715e\"\u003e# Ser group variance priors. We keep the less informative cauchy(0, 1).\u003c/span\u003e\n    \u003cspan style=\"color:#a6e22e\"\u003eset_prior\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;cauchy(0, 1)\u0026#34;\u003c/span\u003e, class \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;b\u0026#34;\u003c/span\u003e, dpar \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sigma\u0026#34;\u003c/span\u003e),\n    \u003cspan style=\"color:#a6e22e\"\u003eset_prior\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;exponential(1.0/29)\u0026#34;\u003c/span\u003e, class \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;nu\u0026#34;\u003c/span\u003e)),\n  chains \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e CHAINS, iter \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ITER, warmup \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e WARMUP, seed \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e BAYES_SEED,\n  file \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;cache/brms_uneq_robust_groups\u0026#34;\u003c/span\u003e\n)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe still need to exponentiate the sigma coefficients when we’re done.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ebrms_uneq_robust_groups_tidy \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etidyMCMC\u003c/span\u003e(brms_uneq_robust_groups, conf.int \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e, conf.level \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.95\u003c/span\u003e, \n           estimate.method \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;median\u0026#34;\u003c/span\u003e, conf.method \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;HPDinterval\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Rescale sigmas\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate_at\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003evars\u003c/span\u003e(estimate, std.error, conf.low, conf.high),\n            \u003cspan style=\"color:#a6e22e\"\u003efuns\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eifelse\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003estr_detect\u003c/span\u003e(term, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sigma\u0026#34;\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003eexp\u003c/span\u003e(.), .)))\nbrms_uneq_robust_groups_tidy\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 5 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term                estimate std.error conf.low conf.high\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;                  \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 b_genreComedy           5.99     0.109     5.77      6.19\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 b_genreAction           5.30     0.107     5.09      5.50\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 b_sigma_genreComedy     1.47     1.06      1.30      1.65\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4 b_sigma_genreAction     1.47     1.06      1.31      1.62\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5 nu                     29.9     28.1       6.00     92.7\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eBecause we calculated the group means themselves, we need to do an extra few steps to get the difference in means. It’s fairly easy: we extract the posterior samples for each of the groups, subtract them from each other, and then calculate the credible interval.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ebrms_uneq_robust_groups_post \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eposterior_samples\u003c/span\u003e(brms_uneq_robust_groups) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# We can exponentiate here!\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate_at\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003evars\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003econtains\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sigma\u0026#34;\u003c/span\u003e)), \u003cspan style=\"color:#a6e22e\"\u003efuns\u003c/span\u003e(exp)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# For whatever reason, we need to log nu?\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(nu \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elog10\u003c/span\u003e(nu)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(diff_means \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e b_genreAction \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e b_genreComedy,\n         diff_sigma \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e b_sigma_genreAction \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e b_sigma_genreComedy) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Calculate effect sizes, just for fun\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(cohen_d \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e diff_means \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e((b_sigma_genreAction \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e b_sigma_genreComedy)\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e),\n         cles \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(diff_means \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e((b_sigma_genreAction \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e b_sigma_genreComedy)), \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e))\n\nbrms_uneq_robust_groups_tidy_fixed \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etidyMCMC\u003c/span\u003e(brms_uneq_robust_groups_post, conf.int \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e, conf.level \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.95\u003c/span\u003e, \n           estimate.method \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;median\u0026#34;\u003c/span\u003e, conf.method \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;HPDinterval\u0026#34;\u003c/span\u003e)\nbrms_uneq_robust_groups_tidy_fixed\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 9 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term                estimate std.error conf.low conf.high\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;                  \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 b_genreComedy        5.99       0.109     5.77      6.19 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 b_genreAction        5.30       0.107     5.09      5.50 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 b_sigma_genreComedy  1.47       0.0882    1.30      1.64 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4 b_sigma_genreAction  1.47       0.0826    1.31      1.62 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5 nu                   1.48       0.287     0.963     2.04 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6 diff_means          -0.690      0.151    -1.01     -0.415\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 7 diff_sigma           0.00100    0.111    -0.212     0.217\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 8 cohen_d             -0.571      0.126    -0.818    -0.327\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 9 cles                 0.368      0.0132    0.341     0.391\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAnd voila! Difference in means based on priors on individual group means rather than differences in groups!\u003c/p\u003e\n\u003ch2 id=\"comparing-all-methods\"\u003eComparing all methods\u003c/h2\u003e\n\u003cp\u003eHoly cow, that’s a lot of code. We can compare the output from all these different methods in a single plot. In this case, since both groups are pretty normally distributed already and there were no outliers, there isn’t much variation at all in the results—all the different methods show essentially the same thing. We can legally interpret the Bayesian results using credible intervals and probabilities; with the classical t-tests, we still have to talk about null hypotheses. But in the end, the results are nearly identical (but that’s definitely not always the case).\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Make a bunch of data frames that have three columns: \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# estimate, conf.low, and conf.high\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Extract t-test results\u003c/span\u003e\nt_test_eq_small \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e t_test_eq_tidy \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(estimate, conf.low, conf.high)\n\nt_test_uneq_small \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e t_test_uneq_tidy \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(estimate, conf.low, conf.high)\n\n\u003cspan style=\"color:#75715e\"\u003e# Extract simulation results\u003c/span\u003e\ninfer_simulation \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(estimate \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e diff_means\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003estat,\n                           conf.low \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e boostrapped_confint\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003e`2.5%`,\n                           conf.high \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e boostrapped_confint\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003e`97.5%`)\n\n\u003cspan style=\"color:#75715e\"\u003e# Extract brms regression results\u003c/span\u003e\nbrms_eq_small \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e brms_eq_tidy \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;b_genreAction\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(estimate, conf.low, conf.high)\n\nbrms_uneq_small \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e brms_uneq_tidy \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;b_genreAction\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(estimate, conf.low, conf.high)\n\nbrms_uneq_robust_small \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e brms_uneq_robust_tidy \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;b_genreAction\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(estimate, conf.low, conf.high)\n\nbrms_uneq_robust_groups_small \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e brms_uneq_robust_groups_tidy_fixed \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;diff_means\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(estimate, conf.low, conf.high)\n\n\u003cspan style=\"color:#75715e\"\u003e# Extract Stan results\u003c/span\u003e\nstan_best_small \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e stan_best_tidy \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;mu_diff\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(estimate, conf.low, conf.high)\n\n\u003cspan style=\"color:#75715e\"\u003e# Put all these mini dataframes into a list column, then unnest\u003c/span\u003e\nmeta_diffs \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etribble\u003c/span\u003e(\n  \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003epackage, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003emethod, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003eresults,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t-test\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;equal variances\u0026#34;\u003c/span\u003e, t_test_eq_small,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t-test\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;unequal variances\u0026#34;\u003c/span\u003e, t_test_uneq_small,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;infer\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;simulation\u0026#34;\u003c/span\u003e, infer_simulation,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;brms\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;equal variances\u0026#34;\u003c/span\u003e, brms_eq_small,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;brms\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;unequal variances\u0026#34;\u003c/span\u003e, brms_uneq_small,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;brms\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;BEST\u0026#34;\u003c/span\u003e, brms_uneq_robust_small,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;brms\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;BEST; group means\u0026#34;\u003c/span\u003e, brms_uneq_robust_groups_small,\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Stan\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;BEST\u0026#34;\u003c/span\u003e, stan_best_small\n) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eunnest\u003c/span\u003e(results) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(method \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epaste0\u003c/span\u003e(package, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;: \u0026#34;\u003c/span\u003e, method)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(method \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_inorder\u003c/span\u003e(method))\n\n\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(meta_diffs, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e estimate, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_rev\u003c/span\u003e(method), color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e package)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_pointrangeh\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(xmin \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e conf.low, xmax \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e conf.high), size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_vline\u003c/span\u003e(xintercept \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_color_viridis_d\u003c/span\u003e(option \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;plasma\u0026#34;\u003c/span\u003e, end \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.9\u003c/span\u003e, guide \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Mean rating for action movies − mean rating for comedies\u0026#34;\u003c/span\u003e,\n       y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, caption \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Sample of 400 movies from IMDB\u0026#34;\u003c/span\u003e,\n       title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Comedies get higher ratings than action movies\u0026#34;\u003c/span\u003e,\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Effect is roughly the same regardless of method used\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eexpand_limits\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_fancy\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(plot.title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(face \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bold\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erel\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e)))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"compare-everything-1.png\" alt=\"Comparison of all methods\"\u003e\u003c/p\u003e\n",
            "date_published": "2019-01-29T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2018/12/28/tidytext-pos-arabic/",
            "url": "https://www.shagunjhaver.com/blog/2018/12/28/tidytext-pos-arabic/",
            "title": "Tidy text, parts of speech, and unique words in the Qur'an",
            "summary": "Use R and parts-of-speech tagging to explore the Qur'an in Arabic",
            "content_html": "\u003cp\u003e\u003cspan class=\"small\"\u003e(\u003ca href=\"https://github.com/andrewheiss/tidytext-pos-arabic\"\u003eSee this notebook on GitHub\u003c/a\u003e)\u003c/span\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eAs I showed in \u003ca href=\"https://www.andrewheiss.com/blog/2018/12/26/tidytext-pos-john/\"\u003ea previous blog post\u003c/a\u003e, the \u003ca href=\"https://statsmaths.github.io/cleanNLP/\"\u003e\u003cstrong\u003ecleanNLP\u003c/strong\u003e package\u003c/a\u003e is a phenomenal frontend for natural language processing in R. Rather than learn the exact syntax for NLP packages like \u003ca href=\"https://spacy.io/\"\u003espaCy\u003c/a\u003e or \u003ca href=\"https://nlp.stanford.edu/\"\u003eCoreNLP\u003c/a\u003e, you can use a consistent set of functions and let \u003cstrong\u003ecleanNLP\u003c/strong\u003e handle the API translation behind the scenes for you.\u003c/p\u003e\n\u003cp\u003ePreviously, I used spaCy to tag the parts of speech in the Four Gospels to find the most distinctive nouns and verbs in the Gospel of John. Here, I’ll show a quick example of how to use CoreNLP to tag parts of speech in Arabic. CoreNLP is far far far slower than spaCy, but it can handle languages like Arabic and Chinese, which is pretty magical.\u003c/p\u003e\n\u003cp\u003eHere we go!\u003c/p\u003e\n\u003ch2 id=\"load-packages-and-data\"\u003eLoad packages and data\u003c/h2\u003e\n\u003cp\u003eYou’ll need to install the \u003ca href=\"https://github.com/andrewheiss/quRan\"\u003enew \u003cstrong\u003equRan\u003c/strong\u003e package\u003c/a\u003e, which contains two Arabic versions of the Qur’an (with and without vowels) and two English translations (Yusuf Ali and Saheeh International). Install it with \u003ccode\u003eremotes::install_github(\u0026quot;andrewheiss/quRan\u0026quot;)\u003c/code\u003e or \u003ccode\u003edevtools::install_github(\u0026quot;andrewheiss/quRan\u0026quot;)\u003c/code\u003e. It’ll be on CRAN once they open up for submissions again in January.\u003c/p\u003e\n\u003cp\u003eYou’ll also need to install \u003cstrong\u003erJava\u003c/strong\u003e. \u003ca href=\"https://twitter.com/andrewheiss/status/1078476157119418370?s=21\"\u003eBest of luck with this.\u003c/a\u003e It is the worst package in the world to install, especially on macOS. The only way I got it to work was to \u003ca href=\"https://www.snaq.net/software/rjava-macos.php\"\u003efollow the instructions here\u003c/a\u003e (even though at the top of that page it says that recent versions of R/Java no longer require this fix—that is false). Here’s basically what you have to do:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eDownload and install the \u003ca href=\"http://www.oracle.com/technetwork/java/javase/downloads/index.html\"\u003emost recent Java SE 8 JDK from Oracle\u003c/a\u003e (I did Java SE 8u191)\u003c/li\u003e\n\u003cli\u003eReinstall R\u003c/li\u003e\n\u003cli\u003eDownload and run the \u003ca href=\"https://gist.github.com/gwinstanley/884d6af25844bdaeb0c81f95bb285768\"\u003e\u003ccode\u003efix-rJava.sh\u003c/code\u003e script\u003c/a\u003e listed at \u003ca href=\"https://www.snaq.net/software/rjava-macos.php\"\u003esnaq.net\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003eInstall rJava with \u003ccode\u003einstall.packages(\u0026quot;rJava\u0026quot;)\u003c/code\u003e or \u003ccode\u003einstall.packages(\u0026quot;rJava\u0026quot;, type = \u0026quot;source\u0026quot;, repos = \u0026quot;http://cran.us.r-project.org\u0026quot;)\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eHopefully it worked?\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eFinally, you\u0026rsquo;ll need to install \u003ccode\u003ecleanNLP\u003c/code\u003e and use it to download the CoreNLP parser and all its accompanying languages. Here’s how you do that:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(cleanNLP)\n\n\u003cspan style=\"color:#75715e\"\u003e# This should download everything\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ecnlp_download_corenlp\u003c/span\u003e()\n\n\u003cspan style=\"color:#75715e\"\u003e# Check if Arabic is there\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003edir\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003esystem.file\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;extdata\u0026#34;\u003c/span\u003e, package \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;cleanNLP\u0026#34;\u003c/span\u003e))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003ePhew. If you’ve done all that, we can get started officially. We’ll load these packages:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(cleanNLP)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(quRan)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidytext)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(arabicStemR)  \u003cspan style=\"color:#75715e\"\u003e# Has a list of Arabic stopwords\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"part-of-speech-tagging\"\u003ePart-of-speech tagging\u003c/h2\u003e\n\u003cp\u003eTo start, we’ll initialize the CoreNLP Arabic tagging engine (this takes a few seconds to run):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003ecnlp_init_corenlp\u003c/span\u003e(language \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ar\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThen, for the sake of speed, we’ll extract just the first surah of the Qur’an (\u003ca href=\"https://en.wikipedia.org/wiki/Al-Fatiha\"\u003ethe Fatihah\u003c/a\u003e) and tag it with \u003ccode\u003ecnlp_annotate()\u003c/code\u003e. We’ll use the version of the Qur’an without vowels because it seems to work better with CoreNLP. \u003ccode\u003ecnlp_annotate()\u003c/code\u003e does the heavy lifting of annotation and returns an object with the \u003ccode\u003eannotate\u003c/code\u003e class, which isn’t readily usable.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003efatiha \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e quran_ar_min \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(surah_id \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)\n\nfatiha_annotated \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecnlp_annotate\u003c/span\u003e(fatiha,\n                                  text_name \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e, doc_name \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ayah_title\u0026#34;\u003c/span\u003e)\n\nfatiha_terms \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e fatiha_annotated\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003etoken\n\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(fatiha_terms)\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 x 8\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   id      sid   tid word   lemma upos  pos     cid\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt; \u0026lt;int\u0026gt; \u0026lt;int\u0026gt; \u0026lt;chr\u0026gt;  \u0026lt;chr\u0026gt; \u0026lt;chr\u0026gt; \u0026lt;chr\u0026gt; \u0026lt;int\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 1:1       1     1 بسم    \u0026#34;\u0026#34;    NOUN  NNP       1\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 1:1       1     2 الله   \u0026#34;\u0026#34;    NOUN  NNP       5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 1:1       1     3 الرحمن \u0026#34;\u0026#34;    \u0026#34;\u0026#34;    DTNNP    10\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4 1:1       1     4 الرحيم \u0026#34;\u0026#34;    \u0026#34;\u0026#34;    DTNNP    17\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5 1:2       1     1 الحمد  \u0026#34;\u0026#34;    \u0026#34;\u0026#34;    DTNNP     0\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6 1:2       1     2 لله    \u0026#34;\u0026#34;    NOUN  NN        6\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe output we get here isn’t as fancy as what spaCy returns for English text. We don’t get lemmatized words (base unpluralized, unconjugated words), and the \u003ccode\u003eupos\u003c/code\u003e column isn’t very rich—it just pulls out verbs and nouns. The \u003ccode\u003epos\u003c/code\u003e column, though, seems to have more information in it. This column uses \u003ca href=\"https://www.ling.upenn.edu/courses/Fall_2003/ling001/penn_treebank_pos.html\"\u003ecodes from the Penn Treebank Project\u003c/a\u003e. For instance, “Allah” (الله) in the second row is marked as \u003ccode\u003eNNP\u003c/code\u003e, which is a singular proper noun, while “al-rahman” (the merciful; الرحمن) in the third row is marked as \u003ccode\u003eDTNNP\u003c/code\u003e, which is a determiner (\u003ccode\u003eDT\u003c/code\u003e; ال / “the”) + a singular proper noun (\u003ccode\u003eNNP\u003c/code\u003e; رحمن / “merciful”).\u003c/p\u003e\n\u003cp\u003eNow that we know the tagging works, we can tag the entire Qur’an. \u003cem\u003e\u003cstrong\u003eWarning:\u003c/strong\u003e\u003c/em\u003e CoreNLP is \u003cem\u003eincredibly\u003c/em\u003e slow with this much text. It took 2,194 seconds to run this on my newish MacBook Pro (36 minutes!). To speed this up, you can download and load the pre-tagged text:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"quran_annotated.rds\"\u003e\u003ccode\u003equran_annotated.rds\u003c/code\u003e\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# THIS TAKES SO LONG\u003c/span\u003e\nquran_annotated \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecnlp_annotate\u003c/span\u003e(quran_ar_min,\n                                 text_name \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e, doc_name \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ayah_title\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# SAVE THIS SO YOU NEVER HAVE TO RUN IT AGAIN\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003esaveRDS\u003c/span\u003e(quran_annotated, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;quran_annotated.rds\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003equran_annotated \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ereadRDS\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;data/quran_annotated.rds\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Convert to data frame\u003c/span\u003e\nquran_terms \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e quran_annotated\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003etoken\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"most-common-nouns-and-verbs\"\u003eMost common nouns and verbs\u003c/h2\u003e\n\u003cp\u003eNow that we have all the parts of speech for the Qur’an, we can do some quick exploratory data analysis.\u003c/p\u003e\n\u003cp\u003eFor instance, what are the most common nouns in the book? We need to do a little fancy filtering for this to work because the \u003ccode\u003epos\u003c/code\u003e column marks all sorts of nouns: singular proper nouns (\u003ccode\u003eNNP\u003c/code\u003e), plural proper nouns (\u003ccode\u003eNNPS\u003c/code\u003e), regular nouns with a “the” (\u003ccode\u003eDTNN\u003c/code\u003e), etc. We need to find all the words with \u003ccode\u003epos\u003c/code\u003e that contains \u003ccode\u003eNN\u003c/code\u003e. The \u003ccode\u003estr_detect()\u003c/code\u003e function from \u003cstrong\u003estringr\u003c/strong\u003e makes this easy.\u003c/p\u003e\n\u003cp\u003eAdditionally, we need to remove common words like في and لهم. The \u003cstrong\u003earabicStemR\u003c/strong\u003e package has a list of Arabic stopwords, but it’s buried in a \u003ccode\u003eremoveStopWords()\u003c/code\u003e function. We can extract that list into its own mini data frame, though.\u003c/p\u003e\n\u003cp\u003eThe \u003ca href=\"https://github.com/davnn/stopwords\"\u003e\u003cstrong\u003estopwords\u003c/strong\u003e package\u003c/a\u003e also has a bunch of common Arabic words, accessible through \u003ccode\u003estopwords::stopwords(language = \u0026quot;ar\u0026quot;, source = \u0026quot;misc\u0026quot;))\u003c/code\u003e, but it’s not as long of a list as \u003ccode\u003earabicStemR::removeStopWords()\u003c/code\u003e, and it includes important Qur’anic words like يوم (day). So we’ll just use the \u003cstrong\u003earabicStemR\u003c/strong\u003e words here.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# In order to get the full list of Arabic stopwords, we have to feed\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# removeStopWorsd some sort of Arabic text, and then access the\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# `arabicStopwordList` from the resulting object. It\u0026#39;s a roundabout approach,\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# but it works\u003c/span\u003e\narabic_stopwords \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edata_frame\u003c/span\u003e(word \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eremoveStopWords\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;سلام\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003earabicStopwordList)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e(NOTE: It is currently not possible to correctly plot Arabic text (or any right-to-left text) in R on macOS, and \u003ca href=\"https://stackoverflow.com/questions/22423760/right-to-left-languages-support-in-r-using-mac\"\u003eit’s been an issue for a long time\u003c/a\u003e. I made all these graphs with \u003ca href=\"https://hub.docker.com/r/rocker/tidyverse/\"\u003ethe tidyverse Docker image\u003c/a\u003e. You can also use \u003ccode\u003eplotly::ggplotly()\u003c/code\u003e)\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003etop_nouns \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e quran_terms \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003estr_detect\u003c/span\u003e(pos, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;NN\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003ecount\u003c/span\u003e(word, sort \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Get rid of tiny diacritic-like words\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003enchar\u003c/span\u003e(word) \u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Get rid of stopwords\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eanti_join\u003c/span\u003e(arabic_stopwords, by \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;word\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etop_n\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, n) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(word \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_inorder\u003c/span\u003e(word))\n\nplot_top_nouns \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(top_nouns, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_rev\u003c/span\u003e(word), y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e n, fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e n \u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e500\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_col\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003escale_fill_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#8F562B\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#276B42\u0026#34;\u003c/span\u003e), guide \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_y_continuous\u003c/span\u003e(labels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e scales\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003ecomma) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Frequency\u0026#34;\u003c/span\u003e, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_flip\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_minimal\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(panel.grid.major.y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e())\nplot_top_nouns\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"most-common-nouns-1.png\" width=\"95%\" style=\"display: block; margin: auto;\" alt=\"Most common nouns in the Qur'an\" /\u003e\u003c/p\u003e\n\u003cp\u003eThe most common noun \u003cem\u003eby far\u003c/em\u003e is Allah, which makes sense, given that this is the Qur’an. The other common words are “earth,” “by Allah,” “day,” “your Lord,” “thing,” “heavens,” “people,” “book,” and “the Merciful.”\u003c/p\u003e\n\u003cp\u003eWhat about the most common verbs? Here we select words that have \u003ccode\u003eVB\u003c/code\u003e in their \u003ccode\u003epos\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003etop_verbs \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e quran_terms \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003estr_detect\u003c/span\u003e(pos, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;VB\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003ecount\u003c/span\u003e(word, sort \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Get rid of tiny diacritic-like words\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003enchar\u003c/span\u003e(word) \u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Get rid of stopwords\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eanti_join\u003c/span\u003e(arabic_stopwords, by \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;word\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etop_n\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, n) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(word \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_inorder\u003c/span\u003e(word))\n\nword_themes \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edata_frame\u003c/span\u003e(theme \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Saying\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Other\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Saying\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Believing\u0026#34;\u003c/span\u003e, \n                                    \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Saying\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Other\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Other\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Believing\u0026#34;\u003c/span\u003e, \n                                    \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Other\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Other\u0026#34;\u003c/span\u003e))\ntop_verbs_themes \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e top_verbs \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003ebind_cols\u003c/span\u003e(word_themes) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(theme \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efactor\u003c/span\u003e(theme, levels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Saying\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Believing\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Other\u0026#34;\u003c/span\u003e)))\n\nplot_top_verbs \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(top_verbs_themes, \n                         \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_rev\u003c/span\u003e(word), y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e n, fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e theme)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_col\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003escale_fill_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#2BCAE0\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#9D2D2A\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#F5D085\u0026#34;\u003c/span\u003e),\n                    name \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Frequency\u0026#34;\u003c/span\u003e, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_flip\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_minimal\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(panel.grid.major.y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e(),\n        legend.position \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bottom\u0026#34;\u003c/span\u003e,\n        legend.key.size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eunit\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.65\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;lines\u0026#34;\u003c/span\u003e))\nplot_top_verbs\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"most-common-verbs-1.png\" width=\"95%\" style=\"display: block; margin: auto;\" alt=\"Most common verbs in the Qur'an\" /\u003e\u003c/p\u003e\n\u003cp\u003eHere, the most common verbs fall into two general themes: “saying” and “believing”. The most common “saying” words are literally “he said” and “said”, while the most common “believing” words are “y’all believe” (imperative) and “they disbelieve.” The other words are either forms of “to be” or preposition-like things that the tagger thought were verbs.\u003c/p\u003e\n\u003ch2 id=\"most-distinctive-meccan-and-medinan-nouns\"\u003eMost distinctive Meccan and Medinan nouns\u003c/h2\u003e\n\u003cp\u003eThe Qur’an is a collection of revelations received by Mohammed in two different locations during two different time periods: \u003ca href=\"https://en.wikipedia.org/wiki/Meccan_surah\"\u003eMecca\u003c/a\u003e and \u003ca href=\"https://en.wikipedia.org/wiki/Medinan_surah\"\u003eMedina\u003c/a\u003e. Scholars have categorized the different surahs by their likely provenance, and the \u003cstrong\u003equRan\u003c/strong\u003e package helpfully includes a column marking if each surah is Meccan or Medinan.\u003c/p\u003e\n\u003cp\u003eTypically, Meccan surahs are shorter than Medinan surahs and were revealed earlier during the development of Islam. As a check, lets see what the average surah length is across these two types of surahs:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eperiod_length \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e quran_ar_min \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(revelation_type, surah_id) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003esummarize\u003c/span\u003e(n_ayaat \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003en\u003c/span\u003e()) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(revelation_type) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003esummarize\u003c/span\u003e(avg_ayaat \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emean\u003c/span\u003e(n_ayaat))\nperiod_length\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 2 x 2\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   revelation_type avg_ayaat\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;               \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 Meccan               53.6\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 Medinan              58.0\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eMeccan surahs are an average of 4.5 ayahs shorter than Medinan surahs. Cool.\u003c/p\u003e\n\u003cp\u003eWhat are the most distinctive nouns and verbs in these two types of surahs? As in \u003ca href=\"https://www.andrewheiss.com/blog/2018/12/26/tidytext-pos-john/\"\u003emy previous post about John and the synoptic gospels\u003c/a\u003e, we can use the \u003ca href=\"https://www.andrewheiss.com/blog/2018/12/26/tidytext-pos-john/#most-unique-words\"\u003etf-idf score as a measure of word uniqueness\u003c/a\u003e. The higher this value, the more unique a word is in a document in a corpus.\u003c/p\u003e\n\u003cp\u003eWe lost lots of the helpful columns from \u003ccode\u003equran_ar_min\u003c/code\u003e when tagging the parts of speech, though. All we’re left with from the original data is the \u003ccode\u003eayah_title\u003c/code\u003e column, which gives the surah and ayah of each word (e.g. 2:242). To bring the revelation type and other columns back in, we’ll make a smaller dataset and then join that to our tagged data:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003etype_lookup \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e quran_ar_min \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(ayah_title, surah_id, surah_title_ar, surah_title_en, ayah, revelation_type)\n\nquran_terms \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e quran_terms \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eleft_join\u003c/span\u003e(type_lookup, by \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;id\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ayah_title\u0026#34;\u003c/span\u003e))\n\n\u003cspan style=\"color:#a6e22e\"\u003eglimpse\u003c/span\u003e(quran_terms)\n\n\u003cspan style=\"color:#75715e\"\u003e## Observations: 82,823\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Variables: 13\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ id              \u0026lt;chr\u0026gt; \u0026#34;1:1\u0026#34;, \u0026#34;1:1\u0026#34;, \u0026#34;1:1\u0026#34;, \u0026#34;1:1\u0026#34;, \u0026#34;1:2\u0026#34;, \u0026#34;1:2\u0026#34;, \u0026#34;1:2...\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ sid             \u0026lt;int\u0026gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1...\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ tid             \u0026lt;int\u0026gt; 1, 2, 3, 4, 1, 2, 3, 4, 1, 2, 1, 2, 3, 1, 2, 3...\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ word            \u0026lt;chr\u0026gt; \u0026#34;بسم\u0026#34;, \u0026#34;الله\u0026#34;, \u0026#34;الرحمن\u0026#34;, \u0026#34;الرحيم\u0026#34;, \u0026#34;الحمد\u0026#34;, \u0026#34;ل...\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ lemma           \u0026lt;chr\u0026gt; \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;...\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ upos            \u0026lt;chr\u0026gt; \u0026#34;NOUN\u0026#34;, \u0026#34;NOUN\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;\u0026#34;, \u0026#34;NOUN\u0026#34;, \u0026#34;NOUN\u0026#34;, \u0026#34;\u0026#34;...\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ pos             \u0026lt;chr\u0026gt; \u0026#34;NNP\u0026#34;, \u0026#34;NNP\u0026#34;, \u0026#34;DTNNP\u0026#34;, \u0026#34;DTNNP\u0026#34;, \u0026#34;DTNNP\u0026#34;, \u0026#34;NN\u0026#34;,...\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ cid             \u0026lt;int\u0026gt; 1, 5, 10, 17, 0, 6, 10, 13, 0, 7, 0, 5, 9, 0, ...\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ surah_id        \u0026lt;int\u0026gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1...\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ surah_title_ar  \u0026lt;fct\u0026gt; الفاتحة, الفاتحة, الفاتحة, الفاتحة, الفاتحة, ا...\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ surah_title_en  \u0026lt;fct\u0026gt; Al-Faatiha, Al-Faatiha, Al-Faatiha, Al-Faatiha...\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ ayah            \u0026lt;int\u0026gt; 1, 1, 1, 1, 2, 2, 2, 2, 3, 3, 4, 4, 4, 5, 5, 5...\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ revelation_type \u0026lt;chr\u0026gt; \u0026#34;Meccan\u0026#34;, \u0026#34;Meccan\u0026#34;, \u0026#34;Meccan\u0026#34;, \u0026#34;Meccan\u0026#34;, \u0026#34;Mecca...\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNow we can use the \u003ccode\u003ebind_tf_idf()\u003c/code\u003e function from \u003cstrong\u003etidytext\u003c/strong\u003e to calculate the tf-idf for each word in each type of revelation:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003etype_tf_idf \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e quran_terms \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003ecount\u003c/span\u003e(revelation_type, word, pos, sort \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003ebind_tf_idf\u003c/span\u003e(word, revelation_type, n) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003earrange\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003edesc\u003c/span\u003e(tf_idf))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNow we can find the uniquest nouns across the two types of surahs:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003euniquest_nouns \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e type_tf_idf \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Only look at nouns\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003estr_detect\u003c/span\u003e(pos, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;NN\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(revelation_type) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etop_n\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, tf_idf) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eungroup\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(word \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_inorder\u003c/span\u003e(word))\n\nplot_unique_nouns \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(uniquest_nouns, \n                            \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_rev\u003c/span\u003e(word), y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e tf_idf, fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e revelation_type)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_col\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_fill_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#A02513\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#274E49\u0026#34;\u003c/span\u003e), guide \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;tf-idf\u0026#34;\u003c/span\u003e,\n       title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Most unique nouns in the Meccan and Medinan surahs\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_flip\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_minimal\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(plot.title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(face \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bold\u0026#34;\u003c/span\u003e),\n        strip.text \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(face \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bold\u0026#34;\u003c/span\u003e),\n        panel.grid.major.y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e()) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efacet_wrap\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e revelation_type, scales \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;free_y\u0026#34;\u003c/span\u003e)\nplot_unique_nouns\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"plot-unique-nouns-1.png\" width=\"95%\" style=\"display: block; margin: auto;\" alt=\"Most unique nouns in the Qur'an\" /\u003e\u003c/p\u003e\n\u003cp\u003eThis is so cool. The most unique and distinctive Meccan nouns are “Joseph,” “criminals,” “filling,” “wo,” “others,” \u003ca href=\"https://en.wikipedia.org/wiki/Thamud\"\u003e“Thamoud,”\u003c/a\u003e “right,” “humans,” “liars,” and “hearing.” Most of these make sense: For instance, surah 12, “Yusuf”, is Meccan and is all about the story of Joseph in Egypt.\u003c/p\u003e\n\u003cp\u003eThe most distinctive Medinan nouns, on the other hand, are “liars,” “his prophet,” “borders/limits,” “wisdom,” “Arabs,” “the Messiah,” “houses,” “killing/fighting,” “the Jews,” “the Hajj,” “hypocrites,” and “promised.”\u003c/p\u003e\n\u003cp\u003eWe can also find the uniquest verbs—just use \u003ccode\u003efilter(str_detect(pos, \u0026quot;VB\u0026quot;))\u003c/code\u003e to select the verbs and do the same thing. I’ll leave that as an exercise to the reader.\u003c/p\u003e\n\u003cp\u003eThus, we can do a lot of cool text analysis with Arabic using R!\u003c/p\u003e\n",
            "date_published": "2018-12-28T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2018/12/26/tidytext-pos-john/",
            "url": "https://www.shagunjhaver.com/blog/2018/12/26/tidytext-pos-john/",
            "title": "Tidy text, parts of speech, and unique words in the Bible",
            "summary": "Use R and parts-of-speech tagging to explore the distinctive features of John",
            "content_html": "\u003cp\u003e\u003cspan class=\"small\"\u003e(\u003ca href=\"https://github.com/andrewheiss/tidytext-pos-john\"\u003eSee this notebook on GitHub\u003c/a\u003e)\u003c/span\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eAs part of my goal to read some sort of religiously themed book every day (\u003ca href=\"https://www.goodreads.com/review/list/2733632-andrew-heiss?shelf=religious\"\u003ewhat I’ve read so far\u003c/a\u003e), I’ve been reading \u003ca href=\"https://www.amazon.com/Becoming-Beloved-Disciple-Coming-Through/dp/1462136109/\"\u003eEric Huntsman’s new \u003cem\u003eBecoming the Beloved Disciple\u003c/em\u003e\u003c/a\u003e, a close reading of the Gospel of John from an LDS perspective.\u003c/p\u003e\n\u003cp\u003eNear the beginning, Huntsman discusses several word frequencies that make John unique compared to the \u003ca href=\"https://en.wikipedia.org/wiki/Synoptic_Gospels\"\u003esynoptic gospels\u003c/a\u003e of Matthew, Mark, and Luke (which all \u003ca href=\"https://en.wikipedia.org/wiki/Q_source\"\u003edraw on the same Q source\u003c/a\u003e). For instance, Huntsman states that John focuses more on themes of discipleship (since the word “disciple” appears 87 times in John), and on “knowing,” “believing,” and “doing,” which appear more often in John than the other gospels.\u003c/p\u003e\n\u003cp\u003eIn the course of \u003ca href=\"https://datavizf18.classes.andrewheiss.com/class/11-class/\"\u003eteaching data visualization\u003c/a\u003e, I’ve dabbled in text-based analysis with R, and as a PhD student I wrote a couple of \u003ca href=\"https://www.andrewheiss.com/research/heiss-rogerson-sources/\"\u003enow-dormant papers\u003c/a\u003e that used cool digital humanities methods to analyze large corpora of text, so my curiosity was piqued. How unique \u003cem\u003eis\u003c/em\u003e the word “disciple” in John compared to the synoptic gospels? What are the most unique verbs in John? What words are the most predictive that we’re in John?\u003c/p\u003e\n\u003cp\u003eLet’s explore with R!\u003c/p\u003e\n\u003cp\u003eAs I started writing this post, I also accidentally created an R package. The complete LDS scriptures are \u003ca href=\"http://scriptures.nephi.org/\"\u003eavailable online for free as an open source database\u003c/a\u003e, and I’ve downloaded that CSV file so many times for other little mini projects I’ve done, so I decided to finally just stick it all in a new package so I wouldn’t need to keep downloading the data by hand. \u003ca href=\"https://github.com/andrewheiss/scriptuRs\"\u003eSo, behold: \u003cstrong\u003escriptuRs\u003c/strong\u003e\u003c/a\u003e. Install it with \u003ccode\u003eremotes::install_github(\u0026quot;andrewheiss/scriptuRs\u0026quot;)\u003c/code\u003e or \u003ccode\u003edevtools::install_github(\u0026quot;andrewheiss/scriptuRs\u0026quot;)\u003c/code\u003e. It’ll be on CRAN once they open up for submissions again in January.\u003c/p\u003e\n\u003ch2 id=\"load-packages-and-data\"\u003eLoad packages and data\u003c/h2\u003e\n\u003cp\u003eFirst, we\u0026rsquo;ll load the necessary packages and data:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)  \u003cspan style=\"color:#75715e\"\u003e# For dplyr, ggplot2, and friends\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(scriptuRs)  \u003cspan style=\"color:#75715e\"\u003e# For full text of bible\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidytext)   \u003cspan style=\"color:#75715e\"\u003e# For analyzing text\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(cleanNLP)   \u003cspan style=\"color:#75715e\"\u003e# For fancier natural language processing\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Load data\u003c/span\u003e\ngospels \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ekjv_bible\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(book_title \u003cspan style=\"color:#f92672\"\u003e%in%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Matthew\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Mark\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Luke\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;John\u0026#34;\u003c/span\u003e))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"part-of-speech-tagging\"\u003ePart-of-speech tagging\u003c/h2\u003e\n\u003cp\u003eBecause I want to know what the most unique/common verbs are in John, we need to identify the grammatical purpose of each word. There are incredible algorithms for tagging parts of speech, such as \u003ca href=\"https://nlp.stanford.edu/\"\u003eStanford NLP\u003c/a\u003e or \u003ca href=\"https://spacy.io/\"\u003espaCy\u003c/a\u003e, and the \u003ca href=\"https://statsmaths.github.io/cleanNLP/\"\u003e\u003cstrong\u003ecleanNLP\u003c/strong\u003e package\u003c/a\u003e provides an easy frontend for working with any of them.\u003c/p\u003e\n\u003cp\u003eInstalling \u003cstrong\u003ecleanNLP\u003c/strong\u003e is trivial—it’s just a normal R package—but connecting it with external NLP algorithms is a little trickier. To install spaCy, which is a really fast tagging library, follow these steps:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eMake sure Python is installed.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eOpen Terminal and run this command to install spaCy:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003epip install -U spacy\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eRun this command to download spaCy’s English algorithms:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-fallback\" data-lang=\"fallback\"\u003epython -m spacy download en\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eThen, in RStudio, we can point R to the version of Python that has spaCy installed and tell \u003cstrong\u003ecleanNLP\u003c/strong\u003e to use spaCy as the NLP backend:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Set up NLP backend\u003c/span\u003e\nreticulate\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003euse_python\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;/usr/local/bin/python3\u0026#34;\u003c/span\u003e)  \u003cspan style=\"color:#75715e\"\u003e# I use homebrew python3\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ecnlp_init_spacy\u003c/span\u003e()  \u003cspan style=\"color:#75715e\"\u003e# Use spaCy\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# cnlp_init_udpipe()  # Or use this R-only one without external dependencies\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWith all that set up, we can now use \u003ccode\u003ecnlp_annotate()\u003c/code\u003e to do the actual tagging:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Determine the parts of speech of the \u0026#34;text\u0026#34; column and use \u0026#34;verse_title\u0026#34; as the id\u003c/span\u003e\ngospels_annotated \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecnlp_annotate\u003c/span\u003e(gospels,\n                                   text_name \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e, doc_name \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;verse_title\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe resulting object is a large \u003ccode\u003eannotation\u003c/code\u003e, which is a custom class for \u003cstrong\u003ecleanNLP\u003c/strong\u003e that‘s not very usable with tidy analysis. Fortunately there\u0026rsquo;s a data frame in the object in the \u003ccode\u003e$token\u003c/code\u003e slot:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003egospel_terms \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e gospels_annotated\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003etoken\n\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(gospel_terms)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 x 10\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   doc_id       sid   tid token     token_with_ws lemma     upos  xpos  tid_source relation\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;      \u0026lt;int\u0026gt; \u0026lt;int\u0026gt; \u0026lt;chr\u0026gt;     \u0026lt;chr\u0026gt;         \u0026lt;chr\u0026gt;     \u0026lt;chr\u0026gt; \u0026lt;chr\u0026gt;      \u0026lt;int\u0026gt; \u0026lt;chr\u0026gt;   \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 Matthew 1…     1     1 THE       \u0026#34;THE \u0026#34;        the       DET   DT             2 det     \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 Matthew 1…     1     2 book      \u0026#34;book \u0026#34;       book      NOUN  NN             0 root    \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 Matthew 1…     1     3 of        \u0026#34;of \u0026#34;         of        ADP   IN             2 prep    \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4 Matthew 1…     1     4 the       \u0026#34;the \u0026#34;        the       DET   DT             5 det     \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5 Matthew 1…     1     5 generati… \u0026#34;generation \u0026#34; generati… NOUN  NN             3 pobj    \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6 Matthew 1…     1     6 of        \u0026#34;of \u0026#34;         of        ADP   IN             5 prep\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eI think this is amazing. There are columns for each word, its lemma (an uncapitalized, unconjugated base form of the word), and the part of speech. The \u003ccode\u003eupos\u003c/code\u003e column shows the universal part of speech code (like \u003ccode\u003eNOUN\u003c/code\u003e, \u003ccode\u003ePROPN\u003c/code\u003e (for proper nouns), \u003ccode\u003eVERB\u003c/code\u003e, etc.), and the \u003ccode\u003epos\u003c/code\u003e column shows a more detailed part of speech code, based on the \u003ca href=\"https://www.ling.upenn.edu/courses/Fall_2003/ling001/penn_treebank_pos.html\"\u003ePenn Treebank codes\u003c/a\u003e (you can get tenses, plurals, types of adverbs, etc.).\u003c/p\u003e\n\u003ch1 id=\"most-unique-words\"\u003eMost unique words\u003c/h1\u003e\n\u003cp\u003eWith the parts of speech tagged, we can now figure out what are the most unique words in John. To do this, we’ll calculate the term-frequency inverse-document-frequency (tf-idf) score for each word. This number is ultimately fairly meaningless in isolation, but it generally measures how unique a word is in a corpus of documents—it is the product of the term frequency and the inverse document frequency:\u003c/p\u003e\n\u003cp\u003e$$\n\u003ccode\u003e\\begin{aligned} tf(\\text{term}) \u0026amp;= \\frac{n_{\\text{term}}}{n_{\\text{terms in document}}} \\\\ idf(\\text{term}) \u0026amp;= \\ln{\\left(\\frac{n_{\\text{documents}}}{n_{\\text{documents containing term}}}\\right)} \\\\ tf\\text{-}idf(\\text{term}) \u0026amp;= tf(\\text{term}) \\times idf(\\text{term}) \\end{aligned}\u003c/code\u003e\n$$\u003c/p\u003e\n\u003cp\u003eTo calculate this, first we need to specify what document each of these words is in. We can kind of get at that now, since the \u003ccode\u003eid\u003c/code\u003e column of \u003ccode\u003egospel_terms\u003c/code\u003e contains the book, chapter name, and verse number for each word (i.e. Matthew 1:1), but it\u0026rsquo;d be nice to have a column called \u003ccode\u003ebook_title\u003c/code\u003e. We had that column in the original \u003ccode\u003egospels\u003c/code\u003e data, but we lost it after we ran the parts of speech tagging. We\u0026rsquo;ll create a smaller dataset with the chapter, book, and verse information, and then join that to our tagged data:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003egospels_lookup \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e gospels \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(verse_title, book_title, chapter_number, verse_number)\n\ngospel_terms \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e gospel_terms \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eleft_join\u003c/span\u003e(gospels_lookup, by \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;doc_id\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;verse_title\u0026#34;\u003c/span\u003e))\n\n\u003cspan style=\"color:#a6e22e\"\u003eglimpse\u003c/span\u003e(gospel_terms)\n\u003cspan style=\"color:#75715e\"\u003e## Rows: 98,555\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Columns: 13\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ doc_id         \u0026lt;chr\u0026gt; \u0026#34;Matthew 1:1\u0026#34;, \u0026#34;Matthew 1:1\u0026#34;, \u0026#34;Matthew 1:1\u0026#34;, \u0026#34;Matthew 1:1\u0026#34;, \u0026#34;Mat…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ sid            \u0026lt;int\u0026gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ tid            \u0026lt;int\u0026gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 1…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ token          \u0026lt;chr\u0026gt; \u0026#34;THE\u0026#34;, \u0026#34;book\u0026#34;, \u0026#34;of\u0026#34;, \u0026#34;the\u0026#34;, \u0026#34;generation\u0026#34;, \u0026#34;of\u0026#34;, \u0026#34;Jesus\u0026#34;, \u0026#34;Christ…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ token_with_ws  \u0026lt;chr\u0026gt; \u0026#34;THE \u0026#34;, \u0026#34;book \u0026#34;, \u0026#34;of \u0026#34;, \u0026#34;the \u0026#34;, \u0026#34;generation \u0026#34;, \u0026#34;of \u0026#34;, \u0026#34;Jesus \u0026#34;, …\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ lemma          \u0026lt;chr\u0026gt; \u0026#34;the\u0026#34;, \u0026#34;book\u0026#34;, \u0026#34;of\u0026#34;, \u0026#34;the\u0026#34;, \u0026#34;generation\u0026#34;, \u0026#34;of\u0026#34;, \u0026#34;Jesus\u0026#34;, \u0026#34;Christ…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ upos           \u0026lt;chr\u0026gt; \u0026#34;DET\u0026#34;, \u0026#34;NOUN\u0026#34;, \u0026#34;ADP\u0026#34;, \u0026#34;DET\u0026#34;, \u0026#34;NOUN\u0026#34;, \u0026#34;ADP\u0026#34;, \u0026#34;PROPN\u0026#34;, \u0026#34;PROPN\u0026#34;, \u0026#34;P…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ xpos           \u0026lt;chr\u0026gt; \u0026#34;DT\u0026#34;, \u0026#34;NN\u0026#34;, \u0026#34;IN\u0026#34;, \u0026#34;DT\u0026#34;, \u0026#34;NN\u0026#34;, \u0026#34;IN\u0026#34;, \u0026#34;NNP\u0026#34;, \u0026#34;NNP\u0026#34;, \u0026#34;,\u0026#34;, \u0026#34;DT\u0026#34;, \u0026#34;NN…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ tid_source     \u0026lt;int\u0026gt; 2, 0, 2, 5, 3, 5, 8, 6, 8, 11, 8, 11, 12, 13, 16, 13, 16, 17, 2,…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ relation       \u0026lt;chr\u0026gt; \u0026#34;det\u0026#34;, \u0026#34;root\u0026#34;, \u0026#34;prep\u0026#34;, \u0026#34;det\u0026#34;, \u0026#34;pobj\u0026#34;, \u0026#34;prep\u0026#34;, \u0026#34;compound\u0026#34;, \u0026#34;pobj\u0026#34;…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ book_title     \u0026lt;chr\u0026gt; \u0026#34;Matthew\u0026#34;, \u0026#34;Matthew\u0026#34;, \u0026#34;Matthew\u0026#34;, \u0026#34;Matthew\u0026#34;, \u0026#34;Matthew\u0026#34;, \u0026#34;Matthew\u0026#34;…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ chapter_number \u0026lt;dbl\u0026gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ verse_number   \u0026lt;dbl\u0026gt; 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2…\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNow, we can use the \u003ccode\u003ebind_tf_idf()\u003c/code\u003e function from \u003cstrong\u003etidytext\u003c/strong\u003e to calculate the tf-idf for each lemma in each book:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Add the tf-idf for these words\u003c/span\u003e\ngospel_tf_idf \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e gospel_terms \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(upos \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eifelse\u003c/span\u003e(lemma \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;abideth\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;VERB\u0026#34;\u003c/span\u003e, upos)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(lemma_upos \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epaste0\u003c/span\u003e(lemma, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;_\u0026#34;\u003c/span\u003e, upos)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003ecount\u003c/span\u003e(book_title, lemma_upos, sort \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003ebind_tf_idf\u003c/span\u003e(lemma_upos, book_title, n) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eseparate\u003c/span\u003e(lemma_upos, into \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;lemma\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;upos\u0026#34;\u003c/span\u003e), sep \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;_\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003earrange\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003edesc\u003c/span\u003e(tf_idf))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eSo, what are the most unique (i.e. the highest tf-idf) nouns in John?\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003euniquest_nouns_in_john \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e gospel_tf_idf \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(upos \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;NOUN\u0026#34;\u003c/span\u003e, book_title \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;John\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(rank \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003en\u003c/span\u003e())\n\nuniquest_nouns_in_john \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etop_n\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, tf_idf) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(lemma \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_inorder\u003c/span\u003e(lemma)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_rev\u003c/span\u003e(lemma), y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e tf_idf)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egeom_col\u003c/span\u003e(fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#b24b70\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;tf-idf\u0026#34;\u003c/span\u003e,\n       title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Most unique nouns in John\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_flip\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_y_continuous\u003c/span\u003e(expand \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_minimal\u003c/span\u003e(base_family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;IBM Plex Sans\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(plot.title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(face \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bold\u0026#34;\u003c/span\u003e),\n        panel.grid.major.y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e())\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"/blog/2018/12/26/tidytext-pos-john/index_files/figure-html/unique-nouns-1.png\" width=\"95%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eThe most common nouns are words like \u0026ldquo;record,\u0026rdquo; \u0026ldquo;clay,\u0026rdquo; and \u0026ldquo;pool\u0026rdquo;. \u0026ldquo;Disciple\u0026rdquo; isn\u0026rsquo;t in the top 10. Nor does it even have a positive number! It appears 79 times, but it\u0026rsquo;s the 244th most unique noun in John (out of 463 words!), which means it\u0026rsquo;s not that uncommon compared to the other gospels:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003euniquest_nouns_in_john \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(lemma \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;disciple\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003etf, \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eidf)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 1 x 6\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   book_title lemma    upos      n tf_idf  rank\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;      \u0026lt;chr\u0026gt;    \u0026lt;chr\u0026gt; \u0026lt;int\u0026gt;  \u0026lt;dbl\u0026gt; \u0026lt;int\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 John       disciple NOUN     79      0   244\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIn fact, the other gospels all use it fairly frequently too. John does indeed use it the most, but just a tiny bit more than Matthew:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003egospel_tf_idf \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(lemma \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;disciple\u0026#34;\u003c/span\u003e, upos \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;NOUN\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003etf, \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eidf)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 4 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   book_title lemma    upos      n tf_idf\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;      \u0026lt;chr\u0026gt;    \u0026lt;chr\u0026gt; \u0026lt;int\u0026gt;  \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 John       disciple NOUN     79      0\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 Matthew    disciple NOUN     74      0\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 Mark       disciple NOUN     46      0\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4 Luke       disciple NOUN     39      0\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWhat about the verbs? What are the most distinctive verbs in John?\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003euniquest_verbs_in_john \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e gospel_tf_idf \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(upos \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;VERB\u0026#34;\u003c/span\u003e, book_title \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;John\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(rank \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003en\u003c/span\u003e())\n\nuniquest_verbs_in_john \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003etop_n\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, tf_idf) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(lemma \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_inorder\u003c/span\u003e(lemma)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_rev\u003c/span\u003e(lemma), y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e tf_idf)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egeom_col\u003c/span\u003e(fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#8f4bbf\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;tf-idf\u0026#34;\u003c/span\u003e,\n       title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Most unique verbs in John\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_flip\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_y_continuous\u003c/span\u003e(expand \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_minimal\u003c/span\u003e(base_family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;IBM Plex Sans\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(plot.title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(face \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bold\u0026#34;\u003c/span\u003e),\n        panel.grid.major.y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e())\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"/blog/2018/12/26/tidytext-pos-john/index_files/figure-html/unique-verbs-1.png\" width=\"95%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eHere Huntsman is on to something. He argues that the frequency of the word \u0026ldquo;abide\u0026rdquo; represents John\u0026rsquo;s emphasis on bridging the gap between what we should \u003cem\u003edo\u003c/em\u003e and what we should \u003cem\u003ebe\u003c/em\u003e. That is, \u0026ldquo;to abide\u0026rdquo; means staying with someone, or maintaining an ongoing relationship, but also persisting and remaining in a way of life. If John emphasizes discipleship, it makes sense that he\u0026rsquo;d emphasize the need to abide—or continue—in discipleship. And indeed, it is one of the most unique verbs in John. Neat.\u003c/p\u003e\n\u003ch2 id=\"most-predictive-words\"\u003eMost predictive words\u003c/h2\u003e\n\u003cp\u003eBeyond just counting words and calculating tf-idf scores, we can use fancier statistical and machine learning techniques to discover which words are the most predictive of being from John. If we stumbled on a random New Testament verse, what words would tip us off that the verse might be from John? If \u0026ldquo;disciple\u0026rdquo; isn\u0026rsquo;t that unique of a word for John, what words are?\u003c/p\u003e\n\u003cp\u003eTo do this, we\u0026rsquo;ll adapt a \u003ca href=\"https://juliasilge.com/blog/tidy-text-classification/\"\u003ecool new blog post by Julia Silge\u003c/a\u003e and use a logistic regression model with \u003ca href=\"https://en.wikipedia.org/wiki/Lasso_(statistics)\"\u003eLASSO regularization\u003c/a\u003e to categorize John vs. the synoptic gospels. LASSOing gives us a measure of variable importance and lets us see which words are most important for predicting if text comes from John or not.\u003c/p\u003e\n\u003cp\u003eBefore running the model with \u003ca href=\"https://web.stanford.edu/~hastie/glmnet/glmnet_alpha.html\"\u003e\u003cstrong\u003eglmnet\u003c/strong\u003e\u0026rsquo;s\u003c/a\u003e \u003ccode\u003ecv.glmnet()\u003c/code\u003e, we have to restructure our tidy data into a sparse matrix. Following Julia\u0026rsquo;s approach, we\u0026rsquo;ll also split our data into a training set and a test set:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(rsample)\n\n\u003cspan style=\"color:#75715e\"\u003e# Make this random split reproducible\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eset.seed\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1234\u003c/span\u003e)\n\nverses_split \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e gospels \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e verse_title) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003einitial_split\u003c/span\u003e(prop \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e)\n\ntrain_data \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etraining\u003c/span\u003e(verses_split)\ntest_data \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etesting\u003c/span\u003e(verses_split)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNow we can make a spare matrix based on the training set:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003esparse_words \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e gospel_terms \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecount\u003c/span\u003e(doc_id, lemma) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003einner_join\u003c/span\u003e(train_data, by \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;doc_id\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;id\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecast_sparse\u003c/span\u003e(doc_id, lemma, n)\n\n\u003cspan style=\"color:#a6e22e\"\u003edim\u003c/span\u003e(sparse_words)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 2835 2590\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe have 2,835 rows and 2,590 columns to work with. Phew.\u003c/p\u003e\n\u003cp\u003eWe need an outcome variable here, too, or a binary variable indicating if the verse is in John or one of the synoptic gospels.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003everses_books \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(verse_title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erownames\u003c/span\u003e(sparse_words)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eleft_join\u003c/span\u003e(gospels \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(verse_title, book_title), by \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;verse_title\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(book_type \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eifelse\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003estr_detect\u003c/span\u003e(book_title, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;John\u0026#34;\u003c/span\u003e), \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;John\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Synoptic gospels\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(is_john \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e book_type \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;John\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe can finally run the model now with the \u003ccode\u003esparse_words\u003c/code\u003e matrix and the binary \u003ccode\u003everses_books$is_john\u003c/code\u003e variable:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(glmnet)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(doMC)\n\u003cspan style=\"color:#a6e22e\"\u003eregisterDoMC\u003c/span\u003e(cores \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e parallel\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003edetectCores\u003c/span\u003e())\n\nmodel \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecv.glmnet\u003c/span\u003e(sparse_words, verses_books\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eis_john,\n                   family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;binomial\u0026#34;\u003c/span\u003e,\n                   parallel \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e, keep \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e\n)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe can then extract the coefficients that have the highest lambda within 1 standard error of the minimum (\u003ca href=\"https://stats.stackexchange.com/a/77549/3025\"\u003e\u003ccode\u003eglmnet\u003c/code\u003e goes through a sequence of possible lambda values for each iteration of the model\u003c/a\u003e—we want the one with the best, or where it\u0026rsquo;s big, but still close to the minimum).\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(glmnet)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(broom)\n\ncoefs \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e model\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eglmnet.fit \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(lambda \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e model\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003elambda.1se) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(term \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;(Intercept)\u0026#34;\u003c/span\u003e)\n\ntop_coefs \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e coefs \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(estimate \u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etop_n\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eabs\u003c/span\u003e(estimate)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eungroup\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003earrange\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003edesc\u003c/span\u003e(estimate)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(term \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_inorder\u003c/span\u003e(term)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(prob_type \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eifelse\u003c/span\u003e(estimate \u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Increases likelihood of being from John\u0026#34;\u003c/span\u003e, \n                            \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Increases likelihood of being from Synoptic Gospels\u0026#34;\u003c/span\u003e),\n         prob_type \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_inorder\u003c/span\u003e(prob_type))\n\ntop_coefs \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_rev\u003c/span\u003e(term), y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e estimate, fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e prob_type)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_col\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_fill_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#6d80b0\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#6c9d53\u0026#34;\u003c/span\u003e), name \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Coefficient\u0026#34;\u003c/span\u003e,\n       title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Words that change the likelihood of being in John\u0026#34;\u003c/span\u003e,\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;A verse with “changer” in it is probably from John\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_minimal\u003c/span\u003e(base_family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;IBM Plex Sans\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(plot.title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(face \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bold\u0026#34;\u003c/span\u003e),\n        legend.position \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;top\u0026#34;\u003c/span\u003e,\n        legend.justification \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;left\u0026#34;\u003c/span\u003e,\n        legend.box.margin \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emargin\u003c/span\u003e(l \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e-0.75\u003c/span\u003e, t \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e-0.25\u003c/span\u003e, unit \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;lines\u0026#34;\u003c/span\u003e),\n        legend.key.size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eunit\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.65\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;lines\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_flip\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"/blog/2018/12/26/tidytext-pos-john/index_files/figure-html/lasso-coefs-1.png\" width=\"95%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eFor whatever reason, \u0026ldquo;changer\u0026rdquo; is a very John-like word (even though \u003ca href=\"https://en.wikipedia.org/wiki/Cleansing_of_the_Temple\"\u003ethe incident of the money changers at the temple appears in all four gospels\u003c/a\u003e), and nouns like \u0026ldquo;manna\u0026rdquo; and \u0026ldquo;leg\u0026rdquo; are also very John-like. Meanwhile, words like \u0026ldquo;parable\u0026rdquo; and \u0026ldquo;Herodians\u0026rdquo; seem to be more Synoptic-like.\u003c/p\u003e\n\u003cp\u003eWhere do words like \u0026ldquo;abide\u0026rdquo; or \u0026ldquo;disciple\u0026rdquo; fit in this model?\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ecoefs \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(term \u003cspan style=\"color:#f92672\"\u003e%in%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;disciple\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;abideth\u0026#34;\u003c/span\u003e))\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 2 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   term      step estimate  lambda dev.ratio\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;    \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt;   \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 disciple    29    0.582 0.00646     0.617\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 abideth     29    2.78  0.00646     0.617\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe coefficient for \u0026ldquo;disciple\u0026rdquo; is positive, but not really that high—just ≈0.6—so it doesn\u0026rsquo;t boost the likelihood that we\u0026rsquo;re in John. \u0026ldquo;Abideth,\u0026rdquo; though, has a fairly strong effect, just as we found with the tf-idf.\u003c/p\u003e\n\u003cp\u003eNeat!\u003c/p\u003e\n",
            "date_published": "2018-12-26T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2018/12/17/academic-job-market-visualized/",
            "url": "https://www.shagunjhaver.com/blog/2018/12/17/academic-job-market-visualized/",
            "title": "The academic job search finally comes to an end",
            "summary": "Explore 2.5 years of applying for academic jobs with fancy data visualization",
            "content_html": "\u003cp\u003eI am \u003cem\u003eso beyond thrilled\u003c/em\u003e to announce that I\u0026rsquo;ll be joining the \u003ca href=\"https://aysps.gsu.edu/\"\u003eAndrew Young School of Policy Studies\u003c/a\u003e at \u003ca href=\"https://www.gsu.edu/\"\u003eGeorgia State University\u003c/a\u003e in Fall 2019 as an assistant professor in the \u003ca href=\"https://aysps.gsu.edu/public-management-policy/\"\u003eDepartment of Public Management and Policy\u003c/a\u003e. I\u0026rsquo;ll be teaching classes in statistics/data science, economics, and nonprofit management in beautiful downtown Atlanta, and we\u0026rsquo;ll be moving back to the South. I am so so excited about this! The Andrew Young School does amazing work in public policy, administration, and nonprofit management, and I\u0026rsquo;ll be working with phenomenal colleagues and students. I still can\u0026rsquo;t believe this is real.\u003c/p\u003e\n\u003cp\u003ePart of the reason I\u0026rsquo;m in shock is that for the past 2.5 years, I\u0026rsquo;ve been ripped apart and destroyed by the academic job market. This job market is a horrendous beast of a thing. It is soul-crushing and dream-shattering and a constant stream of rejection. While facing rejection \u003ca href=\"https://www.nytimes.com/2018/12/14/opinion/sunday/writers-rejections-resolutions.html\"\u003eis good and builds grit etc., etc.\u003c/a\u003e, in reality it\u0026rsquo;s awful.\u003c/p\u003e\n\u003cp\u003eIn an effort to stay On Brand™, here are a bunch of fancy graphs and numbers showing what it\u0026rsquo;s been like to apply for nearly 200 jobs since August 2016. Unlike many of my other blog posts, I haven\u0026rsquo;t included any of the code to generate these. \u003ca href=\"https://github.com/andrewheiss/academic-job-market/blob/master/README.Rmd\"\u003eThat code\u003c/a\u003e is all available in a \u003ca href=\"https://github.com/andrewheiss/academic-job-market\"\u003eGitHub repository\u003c/a\u003e (see \u003ccode\u003eREADME.Rmd\u003c/code\u003e), along with the \u003ca href=\"https://github.com/andrewheiss/academic-job-market/blob/master/data/jobs_clean.csv\"\u003eraw data\u003c/a\u003e that I\u0026rsquo;ve collected over the past few years (for the morbidly curious).\u003c/p\u003e\n\u003ch2 id=\"application-count-and-outcomes\"\u003eApplication count and outcomes\u003c/h2\u003e\n\u003cp\u003eBetween August 31, 2016 and November 18, 2018, I applied for 186 tenure-track and non-tenure-track academic jobs at R1 schools, liberal arts colleges, and teaching-focused public universities. I was offered one two-year visiting assistant professorship at the \u003ca href=\"https://marriottschool.byu.edu/mpa/\"\u003eRomney Institute of Public Service and Ethics\u003c/a\u003e at BYU (where I completed my MPA before getting my PhD), and one tenure-track assistant professorship at the Andrew Young School at Georgia State University.\u003c/p\u003e\n\u003cp\u003eThat\u0026rsquo;s it. That\u0026rsquo;s a 98.9% rejection rate. Here\u0026rsquo;s what the weight of rejection looks like:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/blog/2018/12/17/academic-job-market-visualized/index_files/figure-html/plot-waffle-total-1.png\" width=\"2100\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eNot every one of these was an outright rejection. The typical academic search goes through a few stages:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eScreen hundreds of initial applications\u003c/li\u003e\n\u003cli\u003eSkype or call 10-15 possible candidates\u003c/li\u003e\n\u003cli\u003eFly out ≈3 candidates\u003c/li\u003e\n\u003cli\u003eExtend offer to 1 candidate\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eI made it through different stages of this process with many of the schools I applied to. In total, I had 27 Skype interviews and 9 flyouts over three years. This waffle plot divides up each of the applications by their final outcome (i.e. Skype, flyout, offer), discipline, and year. smh polisci.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/blog/2018/12/17/academic-job-market-visualized/index_files/figure-html/iron-waffles-1.png\" width=\"2100\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eI received my PhD in public policy, with an emphasis in political science and international relations. Many faculty at Duke emphasized that having a dual emphasis like this would be great for the academic job market—because I\u0026rsquo;m trained in both fields, I could theoretically fit comfortably in a traditional political science department or in a public policy or administration department/school. I applied to positions in both disciplines, but I was \u003cem\u003efar\u003c/em\u003e less successful in getting any traction in the political science world (even though I attend and present research at ISA and APSA pretty regularly and \u003ca href=\"https://www.andrewheiss.com/research/heiss-kelley-2017/\"\u003eI have published in the Journal of Politics\u003c/a\u003e ¯\\_(ツ)_/¯).\u003c/p\u003e\n\u003cp\u003eMy first year on the market, I was split 50/50 between public administration/policy jobs and political science jobs. During my second year, because I had very little response from political science I focused almost entirely on public admin/policy. During this most recent cycle, out of desperation I went back to applying to political science jobs in international relations and comparative politics. In the chart below, my proportion of public admin/policy jobs is actually the lowest this year, but that\u0026rsquo;s because (1) political science deadlines are way earlier, and (2) I essentially quit applying for jobs. This stopping was both because \u003ca href=\"https://www.heissatopia.com/2018/11/thursday-night-and-grandmas-passing.html\"\u003emy mom died suddenly\u003c/a\u003e, which completely threw me off the rhythm of the market (i.e. I stopped applying completely until one school graciously e-mailed me to remind me to apply), and because I got an amazing job offer. I was on track for another 50/50 year, though.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/blog/2018/12/17/academic-job-market-visualized/index_files/figure-html/discipline-props-1.png\" width=\"2100\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003ch2 id=\"application-timing\"\u003eApplication timing\u003c/h2\u003e\n\u003cp\u003eApplying for jobs is also a grueling process. Here\u0026rsquo;s what a typical job needs for a complete application:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eCV\u003c/li\u003e\n\u003cli\u003eCover letter tailored for the job, department, and university\u003c/li\u003e\n\u003cli\u003eTeaching statement and/or research statement and/or diversity statement (and for a few religious schools I applied to, a belief statement)\u003c/li\u003e\n\u003cli\u003eTeaching evaluations and/or sample syllabuses\u003c/li\u003e\n\u003cli\u003eTranscripts from graduate school\u003c/li\u003e\n\u003cli\u003eWriting sample(s)\u003c/li\u003e\n\u003cli\u003e3–5 letters of recommendation\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eFortunately, once I wrote a version of each of these things, applying to individual schools didn\u0026rsquo;t take too terribly long. I spent August–September 2016 crafting my teaching/research/diversity statements and general cover letter, polishing my writing samples, and collecting letters of recommendation, and I edited and improved them over the whole 2.5-year process.\u003c/p\u003e\n\u003cp\u003eWriting cover letters generally took ≈45 minutes per school to scour each department\u0026rsquo;s website for relevant programs, centers, faculty, and classes. On some of the days where I sent out 5+ applications, I occasionally forgot to change the recipient address in the cover letter, or writing “I am applying for job X at university Y” while leaving “University Z” from the previous application. This was always horrifying, but I got Skype interviews out of a couple of those, so I think search committees tend to be forgiving about those kinds of mistakes.\u003c/p\u003e\n\u003cp\u003eThis plot shows my pace of applying for jobs. Each dot is a job; each column is a week. The fall semester has been the most intense for sending out applications. In 2016–17, my record was 16 jobs in one week; in 2017–18 it was only 6 (since I severely cut back on political science jobs); and in 2018–19, I applied for 30 jobs in one week. With a rough average of 1 hour per application, \u003ca href=\"https://twitter.com/andrewheiss/status/1046608912617680896\"\u003ethat week was particularly intense\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/blog/2018/12/17/academic-job-market-visualized/index_files/figure-html/dotplot-faux-facet-1.png\" width=\"1800\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eSo many dots.\u003c/p\u003e\n\u003ch2 id=\"geography\"\u003eGeography\u003c/h2\u003e\n\u003cp\u003eFinally, another unique aspect of the academic job market is the fact that you rarely have control over where you end up. If you want to live in a specific state or city, you have to make sure a university there has an open position in your exact field (and then you have to compete against 300+ other applicants, so lolz to that). Friends, family, and neighbors would always suggest that I send my CV to nearby schools because \u0026ldquo;surely they\u0026rsquo;ll find a place for you—you\u0026rsquo;re smart!\u0026rdquo;. But that\u0026rsquo;s not how academia works.\u003c/p\u003e\n\u003cp\u003eI applied to positions in 12 different countries, with most in the United States.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/blog/2018/12/17/academic-job-market-visualized/index_files/figure-html/countries-bar-1.png\" width=\"2100\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s a world map showing the locations of all these jobs across the three years. It\u0026rsquo;s really hard to see any patterns beyond the fact that I only applied for jobs in the Gulf in 2016–17, I guess?\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/blog/2018/12/17/academic-job-market-visualized/index_files/figure-html/countries-map-cycle-1.png\" width=\"2100\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eSince the bulk of my applications went to schools in the US and Canada, here\u0026rsquo;s a more zoomed-in map. Because there are occasionally clusters of schools—particularly along the east coast—I put a 15-mile radius around each school, and if any of those buffer zones overlapped, I increased the point size to show how many schools are in that shared area. \u003ca href=\"https://github.com/andrewheiss/academic-job-market/blob/master/README.Rmd#L441\"\u003eThe code for this is actually pretty magical and ingenius\u003c/a\u003e—it\u0026rsquo;s worth it to \u003ca href=\"https://github.com/andrewheiss/academic-job-market/blob/master/README.Rmd#L441\"\u003echeck out the R code\u003c/a\u003e for this post just for those calculations :).\u003c/p\u003e\n\u003cp\u003eI applied to schools in 36 states + DC. I didn\u0026rsquo;t apply to any schools in Alaska, Delaware, Iowa, Louisiana, Mississippi, Montana, North Dakota, Nebraska, New Hampshire, Nevada, Rhode Island, South Dakota, Vermont, West Virginia, or Wyoming.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"/blog/2018/12/17/academic-job-market-visualized/index_files/figure-html/map-blobs-1.png\" width=\"2400\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eHere\u0026rsquo;s to being done with the job search! Off to Georgia State next year!\u003c/p\u003e\n",
            "date_published": "2018-12-17T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2018/12/05/test-any-hypothesis/",
            "url": "https://www.shagunjhaver.com/blog/2018/12/05/test-any-hypothesis/",
            "title": "How to test any hypothesis with the infer package",
            "summary": "Use the infer package in R to test any statistical hypothesis through simulation.",
            "content_html": "\u003cp\u003eThis semester, I used the new \u003ca href=\"https://moderndive.com/\"\u003eModernDive textbook\u003c/a\u003e to teach \u003ca href=\"https://statsf18.classes.andrewheiss.com/\"\u003eintroductory statistics for executive MPA students at BYU\u003c/a\u003e, and it\u0026rsquo;s been absolutely delightful. The book\u0026rsquo;s approach to teaching statistics follows a growing trend (led by \u003ca href=\"http://www2.stat.duke.edu/~mc301/\"\u003eMine Çetinkaya-Rundel\u003c/a\u003e, \u003ca href=\"https://alison.rbind.io/\"\u003eAlison Hill\u003c/a\u003e, and others) of emphasizing data and simulations instead of classical probability theory and complex statistical tests.\u003c/p\u003e\n\u003cp\u003eWhere this approach \u003cem\u003ereally\u003c/em\u003e shines is with hypothesis testing. This is the core of inferential statistics, but it\u0026rsquo;s really hard for students to wrap their head around how to reject null hypotheses and interpret p-values. \u003ca href=\"https://fivethirtyeight.com/features/not-even-scientists-can-easily-explain-p-values/\"\u003eEven seasoned scientists struggle with explaining what p-values mean\u003c/a\u003e. This stuff is hard.\u003c/p\u003e\n\u003cp\u003eModernDive borrows from Allen Downey\u0026rsquo;s philosophy that \u003ca href=\"http://allendowney.blogspot.com/2016/06/there-is-still-only-one-test.html\"\u003ethere is only one statistical test\u003c/a\u003e and that at their core, all statistical tests (be they t-tests, chi-squared tests, signed Wilcoxon rank tests, etc.) follow the same universal pattern:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003cstrong\u003eStep 1: Calculate a sample statistic, or \u003ccode\u003e\\(\\delta\\)\u003c/code\u003e.\u003c/strong\u003e This is the main measure you care about: the difference in means, the average, the median, the proportion, the difference in proportions, the chi-squared value, etc.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eStep 2: Use simulation to invent a world where \u003ccode\u003e\\(\\delta\\)\u003c/code\u003e is null.\u003c/strong\u003e Simulate what the world would look like if there was no difference between two groups, or if there was no difference in proportions, or where the average value is a specific number.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eStep 3: Look at \u003ccode\u003e\\(\\delta\\)\u003c/code\u003e in the null world.\u003c/strong\u003e Put the sample statistic in the null world and see if it fits well.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eStep 4: Calculate the probability that \u003ccode\u003e\\(\\delta\\)\u003c/code\u003e could exist in null world.\u003c/strong\u003e This is the p-value, or the probability that you\u0026rsquo;d see a \u003ccode\u003e\\(\\delta\\)\u003c/code\u003e at least that high in a world where there\u0026rsquo;s no difference.\u003c/li\u003e\n\u003cli\u003e\u003cstrong\u003eStep 5: Decide if \u003ccode\u003e\\(\\delta\\)\u003c/code\u003e is statistically significant.\u003c/strong\u003e Choose some evidentiary standard or threshold for deciding if there\u0026rsquo;s sufficient proof for rejecting the null world. Standard thresholds (from least to most rigorous) are 0.1, 0.05, and 0.01.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThat\u0026rsquo;s all. Five steps. No need to follow \u003ca href=\"https://www.google.com/search?q=statistical+test+flow+chart\"\u003ecomplicated flowcharts to select the best and most appropriate statistical test\u003c/a\u003e. No need to run a bunch of tests to see if you need to pool variances or leave them separate. Calculate a number, simulate a null world, and decide if that number is significantly different from what is typically seen in the null world. Voila!\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://github.com/tidymodels/infer\"\u003eThe \u003ccode\u003einfer\u003c/code\u003e package in R\u003c/a\u003e makes this process explicit, easy, and intuitive.\u003c/p\u003e\n\u003cp\u003eIn December 2018 (just two days ago!), the World Bank announced a new \u003ca href=\"https://www.cgdev.org/blog/three-lessons-world-banks-new-worldwide-bureaucracy-indicators-database\"\u003eWorldwide Bureaucracy Indicators Database\u003c/a\u003e, with dozens of measures of public sector effectiveness. The data includes variables that measure the proportion of women employed in both the private and the public sectors. Is there a difference between these two sectors? Do more women work in the public sector than the private sector? Instead of consulting a flow chart to find the right test that meets our assumptions and data limitations, we just simulate our way to a p-value and test to see if the difference in median proportions in each sector is significantly different from zero.\u003c/p\u003e\n\u003cp\u003eWe first \u003ca href=\"https://datacatalog.worldbank.org/dataset/worldwide-bureaucracy-indicators\"\u003edownload a CSV of the WWBI data from the World Bank\u003c/a\u003e. In its raw form, it\u0026rsquo;s kind of a mess, with a row for each indicator in each country (so Afghanistan has a row for women private sector employment, one for women public sector employment, and so on), and columns for each year. This heavily commented code will load and clean and rearrange the WWBI data into something we can analyze and plot.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Load libraries\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(ggridges)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(scales)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(infer)\n\n\u003cspan style=\"color:#a6e22e\"\u003eset.seed\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1234\u003c/span\u003e)  \u003cspan style=\"color:#75715e\"\u003e# Make all random draws reproducible\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# https://datacatalog.worldbank.org/dataset/worldwide-bureaucracy-indicators\u003c/span\u003e\nwwbi \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eread_csv\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;WWBIData.csv\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Create a list of indicators we want to work with\u003c/span\u003e\nindicators \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;BI.PWK.PRVS.FE.ZS\u0026#34;\u003c/span\u003e,  \u003cspan style=\"color:#75715e\"\u003e# females as share of private paid employees\u003c/span\u003e\n  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;BI.PWK.PUBS.FE.ZS\u0026#34;\u003c/span\u003e   \u003cspan style=\"color:#75715e\"\u003e# females as share of public paid employees\u003c/span\u003e\n)\n\n\u003cspan style=\"color:#75715e\"\u003e# Make a small, cleaner subset of the WWBI data\u003c/span\u003e\nwwbi_small \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e wwbi \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Only select the columns we care about\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(country \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e `Country Name`, country_code \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e `Country Code`, \n         indicator \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e `Indicator Code`, \u003cspan style=\"color:#a6e22e\"\u003estarts_with\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;20\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Keep only the indicators we care about\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(indicator \u003cspan style=\"color:#f92672\"\u003e%in%\u003c/span\u003e indicators) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Gather all the year-based columns into two long columns\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egather\u003c/span\u003e(year, value, \u003cspan style=\"color:#a6e22e\"\u003estarts_with\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;20\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Spread the data back out so that there are columns for each indicator\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003espread\u003c/span\u003e(indicator, value) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Make these indicator names human readable\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003erename\u003c/span\u003e(share_female_private \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e `BI.PWK.PRVS.FE.ZS`,\n         share_female_public \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e `BI.PWK.PUBS.FE.ZS`) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Amid all the gathering and spreading, every column has become a character.\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# This converts the year and all the share_* variables back to numbers\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate_at\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003evars\u003c/span\u003e(year, \u003cspan style=\"color:#a6e22e\"\u003estarts_with\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;share\u0026#34;\u003c/span\u003e)), as.numeric)\n\nwwbi_2012 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e wwbi_small \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(year \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2012\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Get rid of rows that are missing data in the share_* columns\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003edrop_na\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003estarts_with\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;share\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Make this tidy and long, with a column for private or public\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egather\u003c/span\u003e(sector, proportion, \u003cspan style=\"color:#a6e22e\"\u003estarts_with\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;share\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Make these values even nicer\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(sector \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erecode\u003c/span\u003e(sector,\n                         share_female_private \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Women in private sector\u0026#34;\u003c/span\u003e,\n                         share_female_public \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Women in public sector\u0026#34;\u003c/span\u003e))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFirst, we\u0026rsquo;ll use a ridge plot (or overlapping density plots) to see if there\u0026rsquo;s a difference in the distribution of employment across these two sectors. We include \u003ccode\u003equantile_lines = TRUE\u003c/code\u003e and \u003ccode\u003equantiles = 2\u003c/code\u003e to draw the median of each distribution.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(wwbi_2012, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e proportion, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e sector, fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e sector)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003estat_density_ridges\u003c/span\u003e(quantile_lines \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e, quantiles \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, scale \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;white\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003escale_fill_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#98823c\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#9a5ea1\u0026#34;\u003c/span\u003e), guide \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003escale_x_continuous\u003c/span\u003e(labels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epercent_format\u003c/span\u003e(accuracy \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Percent of women employed in the sector\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_minimal\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(panel.grid.minor \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e())\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"figure\" style=\"text-align: center\"\u003e\n\u003cimg src=\"/blog/2018/12/05/test-any-hypothesis/index_files/figure-html/diff-ridges-1.png\" alt=\"Distribution of female employment in public and private sectors\" width=\"75%\" /\u003e\n\u003cp class=\"caption\"\u003eFigure 1: Distribution of female employment in public and private sectors\u003c/p\u003e\n\u003c/div\u003e\n\u003cp\u003eIt looks like there\u0026rsquo;s a difference here—the median percent of women in the public sector looks like it\u0026rsquo;s between 40–50%, while the median percent of women in the private sector is 50ish%.\u003c/p\u003e\n\u003cp\u003eWe can use the \u003ccode\u003einfer\u003c/code\u003e package to determine the exact difference in the medians of these distributions. We use a formula in \u003ccode\u003especify()\u003c/code\u003e to indicate which variables we want to be our response (or y) and which we want to be our explanatory (or x) variables, and then we \u003ccode\u003ecalculate()\u003c/code\u003e the difference in median values. The \u003ccode\u003eorder\u003c/code\u003e argument tells \u003ccode\u003einfer\u003c/code\u003e to subtract the public values from the private values.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ediff_prop \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e wwbi_2012 \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003especify\u003c/span\u003e(proportion \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e sector) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003ecalculate\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;diff in medians\u0026#34;\u003c/span\u003e, \n            order \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Women in private sector\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Women in public sector\u0026#34;\u003c/span\u003e))\ndiff_prop\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 1 x 1\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##     stat\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##    \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 -0.152\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe difference in the median proportions here is 15.2%. More women appear to be employed in the public sector. But because of sampling issues, is there a possibility that this 15% difference could potentially be zero? Could it be positive instead of negative?\u003c/p\u003e\n\u003cp\u003eTo test this, we simulate a world where the actual difference in medians between these two sectors is zero. We then plot that null distribution, place the observed 15.2% difference in it, and see how well it fits. Here we follow the same \u003ccode\u003especify() %\u0026gt;% calculate()\u003c/code\u003e pattern, but introduce two new steps. We first \u003ccode\u003ehypothesize()\u003c/code\u003e that the two sectors are independent of each other and that there\u0026rsquo;s no difference between the two. We then \u003ccode\u003egenerate()\u003c/code\u003e a null distribution based on permutation (essentially shuffling the private/public labels within the existing data 5,000 times), and then calculate the difference in medians for the two groups.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003epub_private_null \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e wwbi_2012 \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003especify\u003c/span\u003e(proportion \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e sector) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003ehypothesize\u003c/span\u003e(null \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;independence\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egenerate\u003c/span\u003e(reps \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e5000\u003c/span\u003e, type \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;permute\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003ecalculate\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;diff in medians\u0026#34;\u003c/span\u003e, \n            order \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Women in private sector\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Women in public sector\u0026#34;\u003c/span\u003e))\n\n\u003cspan style=\"color:#75715e\"\u003e# Conveniently, the visualize() function that comes with infer returns a ggplot\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# object, so we can continue to add ggplot layers to enhance and clean the plot\u003c/span\u003e\npub_private_null \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003evisualize\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egeom_vline\u003c/span\u003e(xintercept \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e diff_prop\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003estat, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4136\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Difference in median proportion\\n(Women in private sector − women in public sector)\u0026#34;\u003c/span\u003e,\n       y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Count\u0026#34;\u003c/span\u003e,\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Red line shows observed difference in median proportions\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_x_continuous\u003c/span\u003e(labels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epercent_format\u003c/span\u003e(accuracy \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_minimal\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(panel.grid.minor \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e())\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"figure\" style=\"text-align: center\"\u003e\n\u003cimg src=\"/blog/2018/12/05/test-any-hypothesis/index_files/figure-html/diff-in-null-world-1.png\" alt=\"Observed difference in a hypothetical null world\" width=\"75%\" /\u003e\n\u003cp class=\"caption\"\u003eFigure 2: Observed difference in a hypothetical null world\u003c/p\u003e\n\u003c/div\u003e\n\u003cp\u003eThis red line is pretty far in the left tail of the distribution and seems atypical. We can calculate the probability of seeing a difference as big as 15.2% with the \u003ccode\u003eget_pvalue()\u003c/code\u003e function. Because we care about differences in means or medians (and because the difference could be positive if we flipped the order of subtracting the two groups—public−private instead of private−public), we specify \u003ccode\u003edirection = \u0026quot;both\u0026quot;\u003c/code\u003e to get a two-tailed p-value.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003epub_private_null \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eget_pvalue\u003c/span\u003e(obs_stat \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e diff_prop, direction \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;both\u0026#34;\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e## Warning: Please be cautious in reporting a p-value of 0. This result is an approximation\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## based on the number of `reps` chosen in the `generate()` step. See `?get_p_value()` for\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## more information.\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 1 x 1\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   p_value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##     \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1       0\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe p-value is basically 0 (it\u0026rsquo;s not actually 0—it\u0026rsquo;s something like 0.0000001—but because it is based on simulations, it\u0026rsquo;ll report 0 and R will show a warning), which means that there\u0026rsquo;s a 0% chance of seeing a difference at least as large as 15.2% in a world where there\u0026rsquo;s no difference. That\u0026rsquo;s pretty strong evidence, and I\u0026rsquo;d feel confident declaring that there\u0026rsquo;s a statistically significant difference between sectoral employment patterns for women, with more women working in public sector jobs than in the private sector.\u003c/p\u003e\n\u003cp\u003eAnd that\u0026rsquo;s it! No flow charts. No complex assumption checking. Using the \u003ccode\u003einfer\u003c/code\u003e package in R, we brute forced-ly simulated our way to a p-value that is actually interpretable, and now we know that women tend to work in the public sector more than in the private sector. Magic!\u003c/p\u003e\n",
            "date_published": "2018-12-05T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2018/07/30/disposable-supercomputer-future/",
            "url": "https://www.shagunjhaver.com/blog/2018/07/30/disposable-supercomputer-future/",
            "title": "Create a cheap, disposable supercomputer with R, DigitalOcean, and future",
            "summary": "Use the future R package to run computationally intensive R commands on a cluster of remote computers",
            "content_html": "\u003cp\u003e\u003cem\u003etl;dr\u003c/em\u003e: \u003ca href=\"#full-example\"\u003eSkip to complete example\u003c/a\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eIn one of my \u003ca href=\"https://github.com/andrewheiss/donors-ngo-restrictions\"\u003ecurrent research projects\u003c/a\u003e, I use Bayesian modeling (with \u003ca href=\"http://mc-stan.org/\"\u003eStan\u003c/a\u003e and \u003ca href=\"http://mc-stan.org/rstanarm/articles/rstanarm.html\"\u003erstanarm\u003c/a\u003e) and multiple imputation (with \u003ca href=\"https://gking.harvard.edu/Amelia\"\u003eAmelia\u003c/a\u003e) to measure how international aid agencies change their funding allocations to countries that impose legal restrictions on NGOs. It\u0026rsquo;s a fascinating topic and I\u0026rsquo;m using exciting cutting edge research methods to do it.\u003c/p\u003e\n\u003cp\u003eHowever, these cutting edge research methods are \u003cem\u003ereally\u003c/em\u003e computationally intensive. On my laptop, using all four CPU cores, it takes ≈45 minutes to run one set of models (see \u003ca href=\"https://github.com/andrewheiss/donors-ngo-restrictions/blob/cb93d175e29b88502640e70b48f5a899dbdba1c4/Data/run_bayes_remote.R#L95\"\u003e\u003ccode\u003eh1.barriers.total \u0026lt;- mods.h1.next_year.raw.bayes.nested\u003c/code\u003e here\u003c/a\u003e, for instance), so with all the different model specifications and robustness checks, it takes \u003cem\u003ehours\u003c/em\u003e to run the complete analysis for this project. It\u0026rsquo;s awful and I hate rerunning it.\u003c/p\u003e\n\u003cp\u003eIn the past, I created several \u003ca href=\"https://www.digitalocean.com/\"\u003eDigitalOcean\u003c/a\u003e droplets (what they call virtual private servers), installed \u003ca href=\"https://www.rstudio.com/products/rstudio/download-server/\"\u003eRStudio Server\u003c/a\u003e on each, uploaded my data to each instance, and ran separate models on each. This reduced computation time, since I could have like 5 computers all running different parts of the analysis, but it required a ton of manual work and oversight. Computers are really good at automating stuff,  and tools like \u003ca href=\"https://slurm.schedmd.com/\"\u003eSlurm\u003c/a\u003e and \u003ca href=\"http://hadoop.apache.org/\"\u003eHadoop\u003c/a\u003e and \u003ca href=\"https://kubernetes.io/\"\u003eKubernetes\u003c/a\u003e all allow you to orchestrate computing across clusters of machines. However, because these tools are powerful, they\u0026rsquo;re also really complicated and require a lot of additional configuration, and the tradeoff between teaching myself Kubernetes vs. just doing it all manually wasn\u0026rsquo;t that favorable.\u003c/p\u003e\n\u003cp\u003eSurely, \u003ca href=\"https://twitter.com/andrewheiss/status/1022937013022945280?s=21\"\u003eI mused on Twitter last week\u003c/a\u003e, there\u0026rsquo;s a better easier way to manage all this computing.\u003c/p\u003e\n\u003cp\u003eThere is! And it\u0026rsquo;s surprisingly easy with the \u003ca href=\"https://github.com/HenrikBengtsson/future\"\u003e\u003cstrong\u003efuture\u003c/strong\u003e\u003c/a\u003e package in R!\u003c/p\u003e\n\u003cp\u003eYou can create your own disposable supercomputer with remote clusters of computers in just a few intuitive steps.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eCreate remote computers that have the correct R environment and packages set up already\u003c/li\u003e\n\u003cli\u003eUse \u003ccode\u003efuture::plan()\u003c/code\u003e to point R to those computers\u003c/li\u003e\n\u003cli\u003eRun R commands on those computers with \u003ccode\u003efuture::future_lapply()\u003c/code\u003e or \u003ccode\u003efurrr::future_map()\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eThrow away the remote computers when you\u0026rsquo;re done\u003c/li\u003e\n\u003cli\u003eThat\u0026rsquo;s all!\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003e\u003ca href=\"#full-example\"\u003eA fully worked out, tl;dr example is at the end of this post.\u003c/a\u003e\u003c/p\u003e\n\u003ch2 id=\"0-super-quick-introduction-to-future\"\u003e0. Super quick introduction to future\u003c/h2\u003e\n\u003cp\u003eThe key to all of this working correctly is the \u003ca href=\"https://github.com/HenrikBengtsson/future\"\u003e\u003cstrong\u003efuture\u003c/strong\u003e\u003c/a\u003e package in R. \u003cstrong\u003efuture\u003c/strong\u003e allows you to evaluate R commands and expressions in separate processes.\u003c/p\u003e\n\u003cp\u003eFor instance, ordinarily, when you run this command, \u003ccode\u003ex\u003c/code\u003e gets assigned a value immediately:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ex \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e {\n  \u003cspan style=\"color:#a6e22e\"\u003ecat\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Something really computationally intensive\\n\u0026#34;\u003c/span\u003e)\n  \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e\n}\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; Something really computationally intensive\u003c/span\u003e\n\nx\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; [1] 10\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe stuff in \u003ccode\u003ecat()\u003c/code\u003e gets printed immediately and the value of 10 is assigned to \u003ccode\u003ex\u003c/code\u003e immediately as well. This is all well and good, but if the command is computationally intensive, you have to wait until it\u0026rsquo;s done before doing anything else in R.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003efuture\u003c/strong\u003e includes a special assignment command \u003ccode\u003e%\u0026lt;-%\u003c/code\u003e that delays evaluation until \u003ccode\u003ex\u003c/code\u003e is called.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(future)\n\nx \u003cspan style=\"color:#f92672\"\u003e%\u0026lt;-%\u003c/span\u003e {\n    \u003cspan style=\"color:#a6e22e\"\u003ecat\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Something really computationally intensive\\n\u0026#34;\u003c/span\u003e)\n    \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e\n}\n\nx\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; Something really computationally intensive\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; [1] 10\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNotice how \u003ccode\u003ecat()\u003c/code\u003e isn\u0026rsquo;t run until \u003ccode\u003ex\u003c/code\u003e is run. That\u0026rsquo;s because the whole expression isn\u0026rsquo;t actually run yet—it isn\u0026rsquo;t evaluated until \u003ccode\u003ex\u003c/code\u003e is called.\u003c/p\u003e\n\u003cp\u003eThe magic of \u003cstrong\u003efuture\u003c/strong\u003e is that this deferred evaluation \u003cem\u003ecan automatically happen anywhere else\u003c/em\u003e. You specify where evaluation happens with \u003ccode\u003efuture::plan()\u003c/code\u003e. For instance, if you want \u003ccode\u003ex\u003c/code\u003e to be handled on multiple CPUs on your local computer, you\u0026rsquo;d do this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(future)\n\u003cspan style=\"color:#a6e22e\"\u003eplan\u003c/span\u003e(multiprocess)\n\nx \u003cspan style=\"color:#f92672\"\u003e%\u0026lt;-%\u003c/span\u003e {\n  \u003cspan style=\"color:#a6e22e\"\u003ecat\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Something really computationally intensive\\n\u0026#34;\u003c/span\u003e)\n  \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e\n}\n\nx\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; Something really computationally intensive\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; [1] 10\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eR now uses multiple cores to create \u003ccode\u003ex\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eOr, if you want \u003ccode\u003ex\u003c/code\u003e to be processed on a cluster of three remote computers, you\u0026rsquo;d do this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(future)\n\nips \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;192.168.1.1\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;192.168.1.2\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;192.168.1.3\u0026#34;\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003eplan\u003c/span\u003e(remote, workers \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ips)\n\nx \u003cspan style=\"color:#f92672\"\u003e%\u0026lt;-%\u003c/span\u003e {\n    \u003cspan style=\"color:#a6e22e\"\u003ecat\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Something really computationally intensive\\n\u0026#34;\u003c/span\u003e)\n    \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e\n}\n\nx\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; Something really computationally intensive\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; [1] 10\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003ccode\u003ex\u003c/code\u003e is now created across three computers automatically.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003efuture\u003c/strong\u003e has functions like \u003ca href=\"https://github.com/HenrikBengtsson/future.apply\"\u003e\u003ccode\u003efuture.apply::future_lapply()\u003c/code\u003e\u003c/a\u003e that allow you to apply functions to lists, just like \u003ccode\u003elapply()\u003c/code\u003e and friends in base R, and the \u003ca href=\"https://github.com/DavisVaughan/furrr\"\u003e\u003cstrong\u003efurrr\u003c/strong\u003e package\u003c/a\u003e has futurized functions like \u003ccode\u003efuture_map()\u003c/code\u003e that are equivalent to \u003ccode\u003emap()\u003c/code\u003e and friends in \u003cstrong\u003epurrr\u003c/strong\u003e. The \u003ccode\u003efuture_*\u003c/code\u003e versions of these functions will automatically take advantage of whatever you\u0026rsquo;ve specified in \u003ccode\u003eplan()\u003c/code\u003e. If you use \u003ccode\u003eplan(multiprocess)\u003c/code\u003e, \u003ccode\u003efuture_map()\u003c/code\u003e will automatically send chunks of computations to each of the CPU cores; if you use \u003ccode\u003eplan(remote)\u003c/code\u003e, \u003ccode\u003efuture_map()\u003c/code\u003e will automatically send chunks of computations to each of the remote computers.\u003c/p\u003e\n\u003cp\u003eThis is seriously magic and incredible. The backend you specify with \u003ccode\u003eplan()\u003c/code\u003e \u003cem\u003edoesn\u0026rsquo;t matter\u003c/em\u003e and you can change it later to anything you want \u003cem\u003ewithout having to change your code\u003c/em\u003e.\u003c/p\u003e\n\u003ch2 id=\"1-create-remote-computers-that-have-the-correct-r-environment-and-packages-set-up-already\"\u003e1. Create remote computers that have the correct R environment and packages set up already\u003c/h2\u003e\n\u003ch3 id=\"11-create-a-remote-computer-or-two-or-three\"\u003e1.1. Create a remote computer (or two or three)\u003c/h3\u003e\n\u003cp\u003eFirst, you need a remote computer. I prefer to use DigitalOcean, mostly because I already use it for my personal web hosting and other personal projects, and because I find it way more intuitive and easy to use than \u003ca href=\"https://aws.amazon.com/ec2/\"\u003eAmazon\u0026rsquo;s EC2\u003c/a\u003e (which, like Kubernetes, et al. is incredibly powerful, but incredibly complicated). But you can also do all of this with AWS, \u003ca href=\"https://www.linode.com/\"\u003eLinode\u003c/a\u003e, \u003ca href=\"https://cloud.google.com/\"\u003eGoogle Cloud Platform\u003c/a\u003e, or any other VPS service (\u003ca href=\"https://gist.github.com/DavisVaughan/ef544e6ef2228920e7e7100c48def93e\"\u003ehere\u0026rsquo;s how to do it with AWS\u003c/a\u003e and with \u003ca href=\"https://cloudyr.github.io/googleComputeEngineR/articles/massive-parallel.html\"\u003eGoogle Cloud\u003c/a\u003e). The magic of \u003cstrong\u003efuture\u003c/strong\u003e is that it doesn\u0026rsquo;t matter what backend you use—the package takes care of everything for you.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s what to do with DigitalOcean:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eCreate a DigitalOcean account (\u003ca href=\"https://m.do.co/c/cec0de11762e\"\u003eget $10 for free with this link\u003c/a\u003e)\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eCreate an SSH key pair between your DigitalOcean account and your computer. \u003ca href=\"https://www.digitalocean.com/docs/droplets/how-to/add-ssh-keys/\"\u003eFollow the instructions here\u003c/a\u003e to create SSH keys and then upload the public keys to your account. Setting up SSH keys like this lets you securely access your remote computer without a password, which is nice when running remote computations from R.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eIn your DigitalOcean account, create a new Droplet. For simplicity\u0026rsquo;s sake, you can use the \u0026ldquo;One-click apps\u0026rdquo; tab to create a computer that has \u003ca href=\"https://www.docker.com/\"\u003eDocker\u003c/a\u003e pre-installed.\u003c/p\u003e\n\u003cfigure\u003e\u003cimg src=\"do-docker-image.png\"\n         alt=\"Create a DigitalOcean image with Docker pre-installed\"/\u003e\n\u003c/figure\u003e\n\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eChoose how big you want the droplet to be. For now, we\u0026rsquo;ll just make a small $5/month VPS, but you can get as fancy as you want in real life.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eCheck the box near the bottom to add your SSH key to the VPS automatically.\u003c/p\u003e\n\u003cfigure class=\"img-50\"\u003e\u003cimg src=\"do-ssh.png\"\n         alt=\"Enable SSH key in new droplet\"/\u003e\n\u003c/figure\u003e\n\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eAll done! Take note of the IP address. You can connect to the machine now with a terminal with \u003ccode\u003essh root@IPADDRESS\u003c/code\u003e if you want, but you don\u0026rsquo;t need to.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eYou can automate all this with the \u003ca href=\"https://github.com/sckott/analogsea\"\u003e\u003cstrong\u003eanalogsea\u003c/strong\u003e package\u003c/a\u003e in R. Create an API key in your DigitalOcean account:\u003c/p\u003e\n\u003cfigure class=\"img-50\"\u003e\u003cimg src=\"do-pat.png\"\n         alt=\"Create new API key in DigitalOcean\"/\u003e\n\u003c/figure\u003e\n\n\u003cp\u003eThen edit \u003ccode\u003e~/.Rprofile\u003c/code\u003e (or create a new file there, if needed) and add this line:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eSys.setenv\u003c/span\u003e(DO_PAT \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;KEY_GOES_HERE\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNow, you can use R to create DigitalOcean droplets, like so:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(analogsea)\n\n\u003cspan style=\"color:#75715e\"\u003e# droplet_create() makes a generic Linux VPS\u003c/span\u003e\nremote_computer \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edroplet_create\u003c/span\u003e(region \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sfo2\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;1gb\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Or...\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# docklet_create() makes a Linux VPS with Docker pre-installed\u003c/span\u003e\nremote_computer \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edocklet_create\u003c/span\u003e(region \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sfo2\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;1gb\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"12-make-sure-the-remote-computer-has-the-correct-r-environment-and-packages\"\u003e1.2. Make sure the remote computer has the correct R environment and packages\u003c/h3\u003e\n\u003cp\u003eThe computers you specify in \u003ccode\u003eplan(remote, workers = \u0026quot;blah\u0026quot;)\u003c/code\u003e need to (1) have R installed, and (2) have all the packages installed that are needed for the computation. You can manually install R and all the needed packages, but that can take a long time and it\u0026rsquo;s tedious. If you need a cluster of 6 computers, you don\u0026rsquo;t want to take an hour to install R on each of them (and wait for all the packages to compile).\u003c/p\u003e\n\u003cp\u003eThe easiest way to get a ready-to-go R environment is to use \u003ca href=\"https://www.docker.com/\"\u003eDocker\u003c/a\u003e. I won\u0026rsquo;t cover the details of Docker here (since \u003ca href=\"https://www.andrewheiss.com/blog/2017/04/27/super-basic-practical-guide-to-docker-and-rstudio/\"\u003eI\u0026rsquo;ve done that already\u003c/a\u003e)—essentially, Docker lets you install pre-configured virtual computers instantly. For example, \u003ca href=\"https://hub.docker.com/r/rocker/r-base/\"\u003e\u003ccode\u003erocker/rbase\u003c/code\u003e\u003c/a\u003e is a Linux machine with R preinstalled, and \u003ca href=\"https://hub.docker.com/r/rocker/tidyverse/\"\u003e\u003ccode\u003erocker/tidyverse\u003c/code\u003e\u003c/a\u003e is a Linux machine with R + RStudio server + tidyverse pre-installed. You can also create project-specific environments like \u003ca href=\"https://hub.docker.com/r/andrewheiss/docker-donors-ngo-restrictions/\"\u003ethis one for my donors-NGOs project\u003c/a\u003e, and you can use R packages like \u003ca href=\"https://github.com/o2r-project/containerit\"\u003e\u003cstrong\u003econtainerit\u003c/strong\u003e\u003c/a\u003e to automatically create a \u003ccode\u003eDockerfile\u003c/code\u003e out of your current R environment. It\u0026rsquo;s probably best to make your own custom Docker image for your own projects if you use any packages beyond what\u0026rsquo;s in the default \u003ccode\u003erbase\u003c/code\u003e or \u003ccode\u003etidyverse\u003c/code\u003e images.\u003c/p\u003e\n\u003cp\u003eTo get a Docker image onto your remote computer, log into the computer with \u003ccode\u003essh root@IPADDRESS\u003c/code\u003e in your terminal and run \u003ccode\u003edocker pull rocker/tidyverse\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eIf you\u0026rsquo;re using \u003cstrong\u003eanalogsea\u003c/strong\u003e, run this from R:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003edroplet\u003c/span\u003e(remote_computer\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eid) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edocklet_pull\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;rocker/tidyverse\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eYou can do this to create as many remote computers as you want.\u003c/p\u003e\n\u003cp\u003eThe first time you run \u003ccode\u003edocklet_pull()\u003c/code\u003e on a droplet, Docker will download hundreds of megabytes of container files. This is fine for one computer, but if you\u0026rsquo;re creating a cluster of multiple computers, you might not want to redownload everything every time on each computer (to avoid extra bandwidth charges, for example). Instead of pulling a fresh Docker image on each computer, you can take a snapshot of the first remote droplet and then make new droplets based on the snapshot:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Create new droplet with rocker/tidyverse\u003c/span\u003e\nremote_computer \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edocklet_create\u003c/span\u003e(region \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sfo2\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;1gb\u0026#34;\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003edroplet\u003c/span\u003e(remote_computer\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eid) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edocklet_pull\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;rocker/tidyverse\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Create snapshot\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003edroplet\u003c/span\u003e(remote_computer\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eid) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003edroplet_power_off\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003edroplet_snapshot\u003c/span\u003e(name \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;tidyverse_ready\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003edroplet_power_on\u003c/span\u003e()\n\n\u003cspan style=\"color:#75715e\"\u003e# Create a new droplet based on this snapshot. This new computer will already\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# have rocker/tidyverse on it\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# You can see a list of available snapshots and get the name/id with\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# images(private = TRUE)\u003c/span\u003e\nremote_computer2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edroplet_create\u003c/span\u003e(image \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;12345678\u0026#34;\u003c/span\u003e, \n                                   region \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sfo2\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;1gb\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# This won\u0026#39;t take long because it already has rocker/tidyverse\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# You should get this message:\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#   Status: Image is up to date for rocker/tidyverse:latest\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003edroplet\u003c/span\u003e(remote_computer\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eid) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edocklet_pull\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;rocker/tidyverse\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eJust make sure you delete the snapshots when you\u0026rsquo;re done—they cost $0.05 per GB per month.\u003c/p\u003e\n\u003ch2 id=\"2-use-futureplan-to-point-r-to-those-computers\"\u003e2. Use \u003ccode\u003efuture::plan()\u003c/code\u003e to point R to those computers\u003c/h2\u003e\n\u003cp\u003eWe can now point R to this remote computer (or remote computers) and have \u003cstrong\u003efuture\u003c/strong\u003e automatically use the Docker-installed R.\u003c/p\u003e\n\u003cp\u003eIf we didn\u0026rsquo;t use Docker and instead installed R on the remote machine itself, all we\u0026rsquo;d need to do is run this in R:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eplan\u003c/span\u003e(remote, workers \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;IP ADDRESS HERE\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eHowever, because R lives inside a Docker image, we need to do a tiny bit of extra configuration on the local computer—we have to tell the remote computer how to turn on and access the R Docker image. We do this by defining a cluster. Here\u0026rsquo;s a heavily commented example of how to do that:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Public IP for droplet(s); this can also be a vector of IP addresses\u003c/span\u003e\nip \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e IP_ADDRESS_HERE\n\n\u003cspan style=\"color:#75715e\"\u003e# Path to private SSH key that matches key uploaded to DigitalOcean\u003c/span\u003e\nssh_private_key_file \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;/Users/andrew/.ssh/id_rsa\u0026#34;\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Connect and create a cluster\u003c/span\u003e\ncl \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emakeClusterPSOCK\u003c/span\u003e(\n  ip,\n  \n  \u003cspan style=\"color:#75715e\"\u003e# User name; DigitalOcean droplets use root by default\u003c/span\u003e\n  user \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;root\u0026#34;\u003c/span\u003e,\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Use private SSH key registered with DigitalOcean\u003c/span\u003e\n  rshopts \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\n    \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;-o\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;StrictHostKeyChecking=no\u0026#34;\u003c/span\u003e,\n    \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;-o\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;IdentitiesOnly=yes\u0026#34;\u003c/span\u003e,\n    \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;-i\u0026#34;\u003c/span\u003e, ssh_private_key_file\n  ),\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Command to run on each remote machine\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# The script loads the tidyverse Docker image\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# --net=host allows it to communicate back to this computer\u003c/span\u003e\n  rscript \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sudo\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;docker\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;run\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;--net=host\u0026#34;\u003c/span\u003e, \n              \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;rocker/tidyverse\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Rscript\u0026#34;\u003c/span\u003e),\n  \n  \u003cspan style=\"color:#75715e\"\u003e# These are additional commands that are run on the remote machine. \u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# At minimum, the remote machine needs the future library to work—installing furrr also installs future.\u003c/span\u003e\n  rscript_args \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\n    \u003cspan style=\"color:#75715e\"\u003e# Create directory for package installation\u003c/span\u003e\n    \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;-e\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eshQuote\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;local({p \u0026lt;- Sys.getenv(\u0026#39;R_LIBS_USER\u0026#39;); dir.create(p, recursive = TRUE, showWarnings = FALSE); .libPaths(p)})\u0026#34;\u003c/span\u003e),\n    \u003cspan style=\"color:#75715e\"\u003e# Install furrr and future\u003c/span\u003e\n    \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;-e\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eshQuote\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;if (!requireNamespace(\u0026#39;furrr\u0026#39;, quietly = TRUE)) install.packages(\u0026#39;furrr\u0026#39;)\u0026#34;\u003c/span\u003e)\n  ),\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Actually run this stuff. Set to TRUE if you don\u0026#39;t want it to run remotely.\u003c/span\u003e\n  dryrun \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e\n)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWith this cluster defined, we can now use it in \u003ccode\u003efuture::plan()\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eplan\u003c/span\u003e(cluster, workers \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cl)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAnd that\u0026rsquo;s it! \u003cstrong\u003efuture\u003c/strong\u003e is now ready to run commands on the remote computer.\u003c/p\u003e\n\u003ch2 id=\"3-run-r-commands-on-those-computers-with-futurefuture_lapply-or-furrrfuture_map\"\u003e3. Run R commands on those computers with \u003ccode\u003efuture::future_lapply()\u003c/code\u003e or \u003ccode\u003efurrr::future_map()\u003c/code\u003e\u003c/h2\u003e\n\u003cp\u003eNow we can run \u003cstrong\u003efuture\u003c/strong\u003e-based commands on the remote computer with \u003ccode\u003e%\u0026lt;-%\u003c/code\u003e. First, let\u0026rsquo;s check the remote computer\u0026rsquo;s name:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Verify that commands run remotely by looking at the name of the remote\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# Create future expression; this doesn\u0026#39;t run remotely yet\u003c/span\u003e\nremote_name \u003cspan style=\"color:#f92672\"\u003e%\u0026lt;-%\u003c/span\u003e {\n  \u003cspan style=\"color:#a6e22e\"\u003eSys.info\u003c/span\u003e()[[\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;nodename\u0026#34;\u003c/span\u003e]]\n} \n\n\u003cspan style=\"color:#75715e\"\u003e# Run remote expression and see that it\u0026#39;s running inside Docker, not locally\u003c/span\u003e\nremote_name\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; [1] \u0026#34;docker-s-1vcpu-2gb-sfo2-01\u0026#34;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eHow many CPUs does it have?\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# See how many CPU cores the remote machine has\u003c/span\u003e\nn_cpus \u003cspan style=\"color:#f92672\"\u003e%\u0026lt;-%\u003c/span\u003e {parallel\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003edetectCores\u003c/span\u003e()} \nn_cpus\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; [1] 1\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# Just one, since this is a small machine\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe can now outsource any command we want to the remote computer. We don\u0026rsquo;t even have to transfer data manually to the remote—\u003cstrong\u003efuture\u003c/strong\u003e takes care of all of that automatically:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Do stuff with data locally\u003c/span\u003e\ntop_5_worlds \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e starwars \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e!\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eis.na\u003c/span\u003e(homeworld)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003ecount\u003c/span\u003e(homeworld, sort \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eslice\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(homeworld \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_inorder\u003c/span\u003e(homeworld, ordered \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e))\n\n\u003cspan style=\"color:#75715e\"\u003e# Create plot remotely, just for fun\u003c/span\u003e\nhomeworld_plot \u003cspan style=\"color:#f92672\"\u003e%\u0026lt;-%\u003c/span\u003e { \n  \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(top_5_worlds, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e homeworld, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e n)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n    \u003cspan style=\"color:#a6e22e\"\u003egeom_bar\u003c/span\u003e(stat \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;identity\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \n    \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Homeworld\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Count\u0026#34;\u003c/span\u003e, \n         title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Most Star Wars characters are from Naboo and Tatooine\u0026#34;\u003c/span\u003e,\n         subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;It really is a Skywalker/Amidala epic\u0026#34;\u003c/span\u003e)\n}\n\n\u003cspan style=\"color:#75715e\"\u003e# Run the command remotely and show plot locally\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# Note how we didn\u0026#39;t have to load any data on the remote machine. future takes\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# care of all of that for us!\u003c/span\u003e\nhomeworld_plot\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"star-wars-homeworlds.png\" width=\"75%\" style=\"display: block; margin: auto;\" alt=\"Top homeworlds in Star Wars\" /\u003e\u003c/p\u003e\n\u003cp\u003eIn addition to \u003ccode\u003e%\u0026lt;-%\u003c/code\u003e, we can use functions like \u003ccode\u003efurrr::future_map()\u003c/code\u003e to run functions across a vector of values. Because we\u0026rsquo;re only running one remote computer, all these calculations happen on that remote image. If we used more, \u003cstrong\u003efuture\u003c/strong\u003e would automatically dispatch different chunks of this code across different computers and then reassemble them locally. Anything you can do with \u003cstrong\u003efurrr\u003c/strong\u003e or \u003cstrong\u003efuture\u003c/strong\u003e can now be done remotely.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Multiply the numbers 1-5 by 10000 random numbers\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# All these calculations happen remotely!\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003efuture_map\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e10000\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e .x)\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; [[1]]\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;     [1] -6.249602e-01  1.949156e+00  2.205669e+00  4.525842e-01\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; ...\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eYou can even nest \u003cstrong\u003efuture\u003c/strong\u003e plans by \u003ca href=\"https://cran.r-project.org/web/packages/future/vignettes/future-3-topologies.html\"\u003especifying them in a list\u003c/a\u003e, and the package will take care of the different nested layers automatically. You can also place \u003ccode\u003eplan(list(...))\u003c/code\u003e in a file named \u003ccode\u003e.future.R\u003c/code\u003e, which \u003cstrong\u003efuture\u003c/strong\u003e will source automatically when it is loaded. This allows you to use different plans on different computers without ever changing your code.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eplan\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e( \n  \u003cspan style=\"color:#a6e22e\"\u003etweak\u003c/span\u003e(cluster, workers \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cl),  \u003cspan style=\"color:#75715e\"\u003e# Use a cluster of computers locally \u003c/span\u003e\n  multiprocess  \u003cspan style=\"color:#75715e\"\u003e# Use all the CPUs on remote machines \u003c/span\u003e\n)) \n\ncomplicated_remote_stuff \u003cspan style=\"color:#f92672\"\u003e%\u0026lt;-%\u003c/span\u003e {  \n  \u003cspan style=\"color:#75715e\"\u003e# Do complicated stuff on all the remote CPUs with future or furrr functions\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efuture_map\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e10000\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e .x)\n} \n\ncomplicated_remote_stuff\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; [[1]]\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;     [1] -4.746093e-02  1.874897e+00  1.679342e+00 -5.775777e-01\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; ...\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"4-throw-away-the-remote-computers-when-youre-done\"\u003e4. Throw away the remote computers when you\u0026rsquo;re done\u003c/h2\u003e\n\u003cp\u003eBecause we\u0026rsquo;ve used Docker-based R installations, spinning up new droplets is trivial—you don\u0026rsquo;t have to manually install R and all the packages you need by hand. All these remote images are completely disposable.\u003c/p\u003e\n\u003cp\u003eOnce you\u0026rsquo;re done running stuff remotely, you can delete the droplets and save money. Either delete them through the DigitalOcean dashboard, or use \u003cstrong\u003eanalogsea\u003c/strong\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003edroplet_destroy\u003c/span\u003e(remote_computer\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eid)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"5-thats-all\"\u003e5. That\u0026rsquo;s all!\u003c/h2\u003e\n\u003cp\u003ePhew. That\u0026rsquo;s all! This is a lot easier than figuring out how to orchestrate Docker images with Kubernetes or figuring out how to create Hadoop clusters. \u003cstrong\u003efuture\u003c/strong\u003e takes care of all the hard work behind the scenes and this all Just Works™.\u003c/p\u003e\n\u003ch2 id=\"full-example\"\u003eFull example\u003c/h2\u003e\n\u003cp\u003eHere\u0026rsquo;s a real-life example of using Stan to estimate a bunch of models on a cluster of two 4-CPU, 8 GB RAM machines. It uses the \u003ca href=\"https://hub.docker.com/r/andrewheiss/docker-donors-ngo-restrictions/\"\u003e\u003ccode\u003eandrewheiss/docker-donors-ngo-restrictions\u003c/code\u003e\u003c/a\u003e Docker image because it already has Stan and family pre-installed. Each machine costs $0.06 per hour to run, so it\u0026rsquo;s essentially a cheap, fast, remote, and disposable supercomputer.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Load libraries ----------------------------------------------------------\u003c/span\u003e\n\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(analogsea)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(broom)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(rstanarm)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(gapminder)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tictoc)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(ggstance)\n\n\u003cspan style=\"color:#75715e\"\u003e# Path to private SSH key that matches key on DigitalOcean\u003c/span\u003e\nssh_private_key_file \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;/Users/andrew/.ssh/id_rsa\u0026#34;\u003c/span\u003e\n\n\n\u003cspan style=\"color:#75715e\"\u003e# Set up remote machines --------------------------------------------------\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Create two new droplets with Docker pre-installed\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# Here I\u0026#39;m using \u0026#34;s-4vcpu-8gb\u0026#34;, which has 4 CPUs and 8 GB of RAM.\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# Run analogsea::sizes() to see all the available sizes\u003c/span\u003e\ndroplet1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edocklet_create\u003c/span\u003e(region \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sfo2\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;s-4vcpu-8gb\u0026#34;\u003c/span\u003e)\ndroplet2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edocklet_create\u003c/span\u003e(region \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sfo2\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;s-4vcpu-8gb\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Pull the docker image with the environment for this project\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# Here I\u0026#39;m using andrewheiss/docker-donors-ngo-restrictions because it already\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# has rstan and friends installed; none of the rocker R images do that\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# NB: Wait for a minute before running this so that Docker is ready to\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# run on the remote machines\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003edroplet\u003c/span\u003e(droplet1\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eid) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003edocklet_pull\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;andrewheiss/docker-donors-ngo-restrictions\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#a6e22e\"\u003edroplet\u003c/span\u003e(droplet2\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eid) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003edocklet_pull\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;andrewheiss/docker-donors-ngo-restrictions\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Get IP addresses\u003c/span\u003e\nip1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edroplet\u003c/span\u003e(droplet1\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eid)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003enetworks\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ev4[[1]]\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eip_address\nip2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edroplet\u003c/span\u003e(droplet2\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eid)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003enetworks\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ev4[[1]]\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eip_address\n\nips \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(ip1, ip2)\n\n\n\u003cspan style=\"color:#75715e\"\u003e# Make remote cluster -----------------------------------------------------\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Command to run on each remote machine\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# The script loads the docker-donors-ngo-restrictions Docker image\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# --net=host allows it to communicate back to this computer\u003c/span\u003e\nrscript \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;sudo\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;docker\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;run\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;--net=host\u0026#34;\u003c/span\u003e, \n             \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;andrewheiss/docker-donors-ngo-restrictions\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Rscript\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Connect and create a cluster\u003c/span\u003e\ncl \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emakeClusterPSOCK\u003c/span\u003e(\n  ips,\n  \n  \u003cspan style=\"color:#75715e\"\u003e# User name; DO droplets use root by default\u003c/span\u003e\n  user \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;root\u0026#34;\u003c/span\u003e,\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Use private SSH key registered with DO\u003c/span\u003e\n  rshopts \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\n    \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;-o\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;StrictHostKeyChecking=no\u0026#34;\u003c/span\u003e,\n    \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;-o\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;IdentitiesOnly=yes\u0026#34;\u003c/span\u003e,\n    \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;-i\u0026#34;\u003c/span\u003e, ssh_private_key_file\n  ),\n  \n  rscript \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e rscript,\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Things to run each time the remote instance starts\u003c/span\u003e\n  rscript_args \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\n    \u003cspan style=\"color:#75715e\"\u003e# Set up .libPaths() for the root user and install future/purrr/furrr packages\u003c/span\u003e\n    \u003cspan style=\"color:#75715e\"\u003e# Technically future and furrr are already installed on \u003c/span\u003e\n    \u003cspan style=\"color:#75715e\"\u003e# andrewheiss/docker-donors-ngo-restrictions, so these won\u0026#39;t do anything\u003c/span\u003e\n    \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;-e\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eshQuote\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;local({p \u0026lt;- Sys.getenv(\u0026#39;R_LIBS_USER\u0026#39;); dir.create(p, recursive = TRUE, showWarnings = FALSE); .libPaths(p)})\u0026#34;\u003c/span\u003e),\n    \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;-e\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eshQuote\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;if (!requireNamespace(\u0026#39;furrr\u0026#39;, quietly = TRUE)) install.packages(\u0026#39;furrr\u0026#39;)\u0026#34;\u003c/span\u003e),\n    \u003cspan style=\"color:#75715e\"\u003e# Make sure the remote computer uses all CPU cores with Stan\u003c/span\u003e\n    \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;-e\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eshQuote\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;options(mc.cores = parallel::detectCores())\u0026#34;\u003c/span\u003e)\n  ),\n  \n  dryrun \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e\n)\n\n\u003cspan style=\"color:#75715e\"\u003e# Use the cluster of computers as the backend for future and furrr functions\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eplan\u003c/span\u003e(cluster, workers \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cl)\n\n\u003cspan style=\"color:#75715e\"\u003e# We\u0026#39;ll use gapminder data to estimate the relationship between health and \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# wealth in each continent using a Bayesian model\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Process and manipulate data locally\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# Nest continent-based data frames into one larger data frame\u003c/span\u003e\ngapminder_to_model \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e gapminder \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(continent) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003enest\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#75715e\"\u003e# Not enough observations here, so ignore it\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(continent \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Oceania\u0026#34;\u003c/span\u003e)\ngapminder_to_model\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; # A tibble: 4 x 2\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;   continent data              \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;   \u0026lt;fct\u0026gt;     \u0026lt;list\u0026gt;            \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; 1 Asia      \u0026lt;tibble [396 × 5]\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; 2 Europe    \u0026lt;tibble [360 × 5]\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; 3 Africa    \u0026lt;tibble [624 × 5]\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; 4 Americas  \u0026lt;tibble [300 × 5]\u0026gt; \u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Fit a Bayesian model with naive normal priors on the coefficients and\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# intercept on each of the continents. In real life, you\u0026#39;d want to use less\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# naive priors and rescale your data, but this is just an example.\u003c/span\u003e\nmodel_to_run \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(df) {\n  model_stan \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003estan_glm\u003c/span\u003e(lifeExp \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e gdpPercap \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e country, \n                         data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df, family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egaussian\u003c/span\u003e(),\n                         prior \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003enormal\u003c/span\u003e(), prior_intercept \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003enormal\u003c/span\u003e(),\n                         chains \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e, iter \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2000\u003c/span\u003e, warmup \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1000\u003c/span\u003e, seed \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1234\u003c/span\u003e)\n  \u003cspan style=\"color:#a6e22e\"\u003ereturn\u003c/span\u003e(model_stan)\n}\n\n\u003cspan style=\"color:#75715e\"\u003e# Use future_map to outsource each of the continent-based models to a different\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# remote computer, where it will be run with all 4 remote cores\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003etic\u003c/span\u003e()\ngapminder_models \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e gapminder_to_model \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(model \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e data \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efuture_map\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emodel_to_run\u003c/span\u003e(.x)))\n\u003cspan style=\"color:#a6e22e\"\u003etoc\u003c/span\u003e()\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; 27.786 sec elapsed\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# That\u0026#39;s so fast!\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# It worked!\u003c/span\u003e\ngapminder_models\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; # A tibble: 4 x 3\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;   continent data               model        \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;   \u0026lt;fct\u0026gt;     \u0026lt;list\u0026gt;             \u0026lt;list\u0026gt;       \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; 1 Asia      \u0026lt;tibble [396 × 5]\u0026gt; \u0026lt;S3: stanreg\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; 2 Europe    \u0026lt;tibble [360 × 5]\u0026gt; \u0026lt;S3: stanreg\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; 3 Africa    \u0026lt;tibble [624 × 5]\u0026gt; \u0026lt;S3: stanreg\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; 4 Americas  \u0026lt;tibble [300 × 5]\u0026gt; \u0026lt;S3: stanreg\u0026gt;\u003c/span\u003e\n\n\n\u003cspan style=\"color:#75715e\"\u003e# Do stuff with the models ------------------------------------------------\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Extract the gdpPercap coefficient from the rstanarm models\u003c/span\u003e\ngapminder_models_to_plot \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e gapminder_models \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(tidied \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e model \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(.x, intervals \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e, prob \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.9\u003c/span\u003e))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eunnest\u003c/span\u003e(tidied) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;gdpPercap\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Plot the coefficients\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(gapminder_models_to_plot, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e estimate, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e continent)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_vline\u003c/span\u003e(xintercept \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_pointrangeh\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(xmin \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e lower, xmax \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e upper, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e continent), size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Coefficient estimate (log GDP per capita)\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e,\n       caption \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Bars show 90% credible intervals\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_color_viridis_d\u003c/span\u003e(begin \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, end \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.9\u003c/span\u003e, name \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_grey\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(legend.position \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bottom\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"model-coefs.png\" width=\"75%\" style=\"display: block; margin: auto;\" alt=\"Model coefficients by continent\" /\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Delete droplets ---------------------------------------------------------\u003c/span\u003e\n\n\u003cspan style=\"color:#a6e22e\"\u003edroplet_delete\u003c/span\u003e(droplet1\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eid)\n\u003cspan style=\"color:#a6e22e\"\u003edroplet_delete\u003c/span\u003e(droplet2\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eid)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e",
            "date_published": "2018-07-30T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2018/03/08/amelia-broom-huxtable/",
            "url": "https://www.shagunjhaver.com/blog/2018/03/08/amelia-broom-huxtable/",
            "title": "Show multiply imputed results in a side-by-side regression table with broom and huxtable",
            "summary": "Extend broom's tidy() and glance() to work with lists of multiply imputed regression models",
            "content_html": "\u003cp\u003e\u003cspan class=\"small\"\u003e(\u003ca href=\"https://github.com/andrewheiss/amelia-broom-huxtable\"\u003eSee this notebook on GitHub\u003c/a\u003e)\u003c/span\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003etl;dr\u003c/em\u003e: Use the functions in \u003ca href=\"broomify-amelia.R\"\u003e\u003ccode\u003ebroomify-amelia.R\u003c/code\u003e\u003c/a\u003e to use \u003ccode\u003ebroom::tidy()\u003c/code\u003e, \u003ccode\u003ebroom::glance()\u003c/code\u003e, and \u003ccode\u003ehuxtable::huxreg()\u003c/code\u003e on lists of multiply imputed models.\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eThe whole reason I went into the rabbit hole of the mechanics of merging imputed regression results \u003ca href=\"https://www.andrewheiss.com/blog/2018/03/07/amelia-tidy-melding/\"\u003ein the previous post\u003c/a\u003e was so I could easily report these results in papers and writeups. In political science and economics (and probably other social science disciplines), it\u0026rsquo;s fairly standard to report many regression models in a side-by-side table, with a column for each model and rows for each coefficient. R packages like \u003ca href=\"https://cran.r-project.org/package=stargazer\"\u003e\u003ccode\u003estargazer\u003c/code\u003e\u003c/a\u003e and \u003ca href=\"https://cran.r-project.org/package=huxtable\"\u003e\u003ccode\u003ehuxtable\u003c/code\u003e\u003c/a\u003e make this fairly straightforward.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(Amelia)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(stargazer)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(huxtable)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(broom)\n\n\u003cspan style=\"color:#75715e\"\u003e# Use the africa dataset from Ameila\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003edata\u003c/span\u003e(africa)\n\n\u003cspan style=\"color:#75715e\"\u003e# Build some example models\u003c/span\u003e\nmodel_original1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(gdp_pc \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e trade \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e civlib, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e africa)\nmodel_original2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(gdp_pc \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e trade \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e civlib \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e infl, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e africa)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eStargazer takes a list of models:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003estargazer\u003c/span\u003e(model_original1, model_original2, type \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e## \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## ====================================================================\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                                   Dependent variable:               \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                     ------------------------------------------------\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                                          gdp_pc                     \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                               (1)                      (2)          \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## --------------------------------------------------------------------\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## trade                      18.000***                18.500***       \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                             (1.270)                  (1.200)        \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                                                                     \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## civlib                    -665.000***              -589.000***      \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                            (185.000)                (176.000)       \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                                                                     \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## infl                                                -6.340***       \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                                                      (1.620)        \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                                                                     \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Constant                    136.000                 166.000*        \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                            (100.000)                (94.900)        \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                                                                     \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## --------------------------------------------------------------------\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Observations                  115                      115          \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## R2                           0.653                    0.695         \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Adjusted R2                  0.647                    0.687         \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Residual Std. Error    352.000 (df = 112)      332.000 (df = 111)   \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## F Statistic         106.000*** (df = 2; 112) 84.500*** (df = 3; 111)\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## ====================================================================\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Note:                                    *p\u0026lt;0.1; **p\u0026lt;0.05; ***p\u0026lt;0.01\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAs does huxtable\u0026rsquo;s \u003ccode\u003ehuxreg()\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003ehuxreg\u003c/span\u003e(model_original1, model_original2) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eprint_screen\u003c/span\u003e()\n\u003cspan style=\"color:#75715e\"\u003e##                    ────────────────────────────────────────────────────\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                                                  (1)              (2)  \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                                     ───────────────────────────────────\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                      (Intercept)         136.063          166.435      \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                                         (100.409)         (94.871)     \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                      trade                18.027 ***       18.494 ***  \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                                           (1.272)          (1.204)     \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                      civlib             -665.428 ***     -588.722 **   \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                                         (185.436)        (175.717)     \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                      infl                                  -6.336 ***  \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                                                            (1.620)     \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                                     ───────────────────────────────────\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                      N                   115              115          \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                      R2                    0.653            0.695      \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                      logLik             -836.136         -828.709      \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                      AIC                1680.272         1667.418      \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                    ────────────────────────────────────────────────────\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                      *** p \u0026lt; 0.001; ** p \u0026lt; 0.01; * p \u0026lt; 0.05.           \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Column names: names, model1, model2\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003ca href=\"https://cran.r-project.org/web/packages/stargazer/vignettes/stargazer.pdf\"\u003eStargazer has support for a ton of different model types\u003c/a\u003e (see \u003ccode\u003e?stargazer\u003c/code\u003e for details), but they\u0026rsquo;re all hardcoded into stargazer\u0026rsquo;s internal code and adding more is tricky. \u003ca href=\"https://hughjonesd.github.io/huxtable/\"\u003eHuxtable\u003c/a\u003e, on the other hand, doesn\u0026rsquo;t rely on hardcoded model processing, but instead will display any model that works with \u003ccode\u003ebroom::tidy()\u003c/code\u003e and \u003ccode\u003ebroom::glance()\u003c/code\u003e. The \u003ca href=\"https://cran.r-project.org/package=broom\"\u003e\u003ccode\u003ebroom\u003c/code\u003e package\u003c/a\u003e supports way more models than stargazer (including models created with \u003ca href=\"https://cran.r-project.org/package=rstan\"\u003e\u003ccode\u003erstan\u003c/code\u003e\u003c/a\u003e and \u003ca href=\"https://cran.r-project.org/package=rstanarm\"\u003e\u003ccode\u003erstanarm\u003c/code\u003e\u003c/a\u003e!), and because of this, huxtable is far more extensible—if you can create a \u003ccode\u003etidy()\u003c/code\u003e and a \u003ccode\u003eglance()\u003c/code\u003e function for a type of model, huxtable can use it.\u003c/p\u003e\n\u003cp\u003eAlso, stargazer was written before \u003ca href=\"https://rmarkdown.rstudio.com/\"\u003eR Markdown\u003c/a\u003e was really a thing, so it has excellent support for HTML and LaTeX output, but that\u0026rsquo;s it. Including stargazer tables in an R Markdown document is a hassle, especially if you want to be able to convert it to Word (\u003ca href=\"https://github.com/andrewheiss/edb-social-pressure/blob/master/bin/stargazer2docx.py\"\u003eI\u0026rsquo;ve written a Python script for doing this\u003c/a\u003e—that\u0026rsquo;s how much extra work it takes). Huxtable, though, was written after the R Markdown and tidyverse revolutions, so it supports piping \u003cem\u003eand\u003c/em\u003e can output to HTML, LaTeX, \u003cem\u003eand\u003c/em\u003e Markdown (with \u003ccode\u003ehuxtable::print_md()\u003c/code\u003e).\u003c/p\u003e\n\u003cp\u003eThis history is important because it means that models based on multiple imputation \u003cstrong\u003ewill not work with stargazer.\u003c/strong\u003e Melding all the coefficients across imputations creates nice data frames of model results, but it doesn\u0026rsquo;t create a model that stargazer can work with. This is unfortunate, especially given \u003ca href=\"https://github.com/search?l=\u0026amp;q=stargazer+user%3Aandrewheiss\u0026amp;ref=advsearch\u0026amp;type=Code\u0026amp;utf8=%E2%9C%93\"\u003ehow much I use stargazer\u003c/a\u003e. However, if we could make a \u003ccode\u003etidy()\u003c/code\u003e and a \u003ccode\u003eglance()\u003c/code\u003e function that could work with a list of multiply imputed models, huxtable would solve all our problems.\u003c/p\u003e\n\u003cp\u003eSo here\u0026rsquo;s how to solve all your problems :)\u003c/p\u003e\n\u003cp\u003eFirst, we\u0026rsquo;ll impute the missing data in the Africa data set, nest the imputed data in a larger data frame, and run a model on each imputed dataset:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eset.seed\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1234\u003c/span\u003e)\nimp_amelia \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eamelia\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e africa, m \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, cs \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;country\u0026#34;\u003c/span\u003e, ts \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;year\u0026#34;\u003c/span\u003e, \n                     logs \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;gdp_pc\u0026#34;\u003c/span\u003e, p2s \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)\n\nmodels_imputed_df \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ebind_rows\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eunclass\u003c/span\u003e(imp_amelia\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eimputations), .id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;m\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(m) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003enest\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(model \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e data \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(gdp_pc \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e trade \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e civlib, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e .)))\n\nmodels_imputed_df\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 5 x 3\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## # Groups:   m [5]\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   m     data               model \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt; \u0026lt;list\u0026gt;             \u0026lt;list\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 imp1  \u0026lt;tibble [120 × 7]\u0026gt; \u0026lt;lm\u0026gt;  \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 imp2  \u0026lt;tibble [120 × 7]\u0026gt; \u0026lt;lm\u0026gt;  \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 imp3  \u0026lt;tibble [120 × 7]\u0026gt; \u0026lt;lm\u0026gt;  \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4 imp4  \u0026lt;tibble [120 × 7]\u0026gt; \u0026lt;lm\u0026gt;  \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5 imp5  \u0026lt;tibble [120 × 7]\u0026gt; \u0026lt;lm\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eBefore we do anything with the models in \u003ccode\u003emodels_imputed_df$model\u003c/code\u003e, first we can define a few functions to extend broom. R\u0026rsquo;s S3 object system means that a function named \u003ccode\u003ewhatever.blah()\u003c/code\u003e will automatically work when called on objects with the class \u003ccode\u003eblah\u003c/code\u003e. This is how broom generally works—there are functions named \u003ccode\u003etidy.anova()\u003c/code\u003e, \u003ccode\u003etidy.glm()\u003c/code\u003e, \u003ccode\u003etidy.lm()\u003c/code\u003e, etc. that will do the correct tidying when run on \u003ccode\u003eanova\u003c/code\u003e, \u003ccode\u003eglm\u003c/code\u003e, and \u003ccode\u003elm\u003c/code\u003e objects. Huxtable also takes advantage of this S3 object system—it will call the appropriate tidy and glance functions based on the class of the models passed to it.\u003c/p\u003e\n\u003cp\u003eTo make a list of models work with broom, we need to invent a new class of model. In this example I\u0026rsquo;ve named it \u003ccode\u003emelded\u003c/code\u003e, but it could be anything. Here are three functions designed to work on \u003ccode\u003emelded\u003c/code\u003e objects (the code for these is largely based on \u003ca href=\"https://www.andrewheiss.com/blog/2018/03/07/amelia-tidy-melding/\"\u003ethe previous post about melding coefficients\u003c/a\u003e). These functions are also found in \u003ca href=\"broomify-amelia.R\"\u003e\u003ccode\u003ebroomify-amelia.R\u003c/code\u003e\u003c/a\u003e, which you can add to your project (maybe someday this could be an actual package, but I don\u0026rsquo;t see a reason for it yet).\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003etidy.melded \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(x, conf.int \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e, conf.level \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.95\u003c/span\u003e) {\n  \u003cspan style=\"color:#75715e\"\u003e# Get the df from one of the models\u003c/span\u003e\n  model_degrees_freedom \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eglance\u003c/span\u003e(x[[1]])\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003edf.residual\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Create matrices of the estimates and standard errors\u003c/span\u003e\n  params \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(models \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eunclass\u003c/span\u003e(x)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n    \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(m \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003en\u003c/span\u003e(),\n           tidied \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e models \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(tidy)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n    \u003cspan style=\"color:#a6e22e\"\u003eunnest\u003c/span\u003e(tidied) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n    \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(m, term, estimate, std.error) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n    \u003cspan style=\"color:#a6e22e\"\u003egather\u003c/span\u003e(key, value, estimate, std.error) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n    \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(term \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_inorder\u003c/span\u003e(term)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e  \u003cspan style=\"color:#75715e\"\u003e# Order the terms so that spread() keeps them in order\u003c/span\u003e\n    \u003cspan style=\"color:#a6e22e\"\u003espread\u003c/span\u003e(term, value)\n  \n  just_coefs \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e params \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(key \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;estimate\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003em, \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003ekey)\n  just_ses \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e params \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(key \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;std.error\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003em, \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003ekey)\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Meld the coefficients with Rubin\u0026#39;s rules\u003c/span\u003e\n  coefs_melded \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emi.meld\u003c/span\u003e(just_coefs, just_ses)\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Create tidy output\u003c/span\u003e\n  output \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eas.data.frame\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ecbind\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e(coefs_melded\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eq.mi),\n                                \u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e(coefs_melded\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ese.mi))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n    magrittr\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eset_colnames\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;estimate\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;std.error\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n    \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(term \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erownames\u003c/span\u003e(.)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n    \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(term, \u003cspan style=\"color:#a6e22e\"\u003eeverything\u003c/span\u003e()) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n    \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(statistic \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e estimate \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e std.error,\n           p.value \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ept\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eabs\u003c/span\u003e(statistic), model_degrees_freedom, lower.tail \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e))\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Add confidence intervals if needed\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eif \u003c/span\u003e(conf.int \u003cspan style=\"color:#f92672\"\u003e\u0026amp;\u003c/span\u003e conf.level) {\n    \u003cspan style=\"color:#75715e\"\u003e# Convert conf.level to tail values (0.025 when it\u0026#39;s 0.95)\u003c/span\u003e\n    a \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e conf.level) \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e\n    \n    output \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e output \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n      \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(conf.low \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e estimate \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e std.error \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eqt\u003c/span\u003e(a, model_degrees_freedom),\n             conf.high \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e estimate \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e std.error \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eqt\u003c/span\u003e((\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e a), model_degrees_freedom))\n  }\n  \n  \u003cspan style=\"color:#75715e\"\u003e# tidy objects only have a data.frame class, not tbl_df or anything else\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eclass\u003c/span\u003e(output) \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;data.frame\u0026#34;\u003c/span\u003e\n  output\n}\n\nglance.melded \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(x) {\n  \u003cspan style=\"color:#75715e\"\u003e# Because the properly melded parameters and the simple average of the\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# parameters of these models are roughly the same (see\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# https://www.andrewheiss.com/blog/2018/03/07/amelia-tidy-melding/), for the\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# sake of simplicty we just take the average here\u003c/span\u003e\n  output \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(models \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eunclass\u003c/span\u003e(x)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n    \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(glance \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e models \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(glance)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n    \u003cspan style=\"color:#a6e22e\"\u003eunnest\u003c/span\u003e(glance) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n    \u003cspan style=\"color:#a6e22e\"\u003esummarize_at\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003evars\u003c/span\u003e(r.squared, adj.r.squared, sigma, statistic, p.value, df, \n                      logLik, AIC, BIC, deviance, df.residual),\n                 \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(mean)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n    \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(m \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eas.integer\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003elength\u003c/span\u003e(x)))\n  \n  \u003cspan style=\"color:#75715e\"\u003e# glance objects only have a data.frame class, not tbl_df or anything else\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eclass\u003c/span\u003e(output) \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;data.frame\u0026#34;\u003c/span\u003e\n  output\n}\n\nnobs.melded \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(x, \u003cspan style=\"color:#66d9ef\"\u003e...\u003c/span\u003e) {\n  \u003cspan style=\"color:#75715e\"\u003e# Take the number of observations from the first model\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003enobs\u003c/span\u003e(x[[1]])\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWith these three functions, we can now use \u003ccode\u003eglance()\u003c/code\u003e and \u003ccode\u003etidy()\u003c/code\u003e on a list of models with the class \u003ccode\u003emelded\u003c/code\u003e, like so:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Extract the models into a vector and make it a \u0026#34;melded\u0026#34; class\u003c/span\u003e\nmodels_imputed \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e models_imputed_df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003emodel\n\u003cspan style=\"color:#75715e\"\u003e# Without this, R won\u0026#39;t use our custom tidy.melded() or glance.melded() functions\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eclass\u003c/span\u003e(models_imputed) \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;melded\u0026#34;\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eglance\u003c/span\u003e(models_imputed)\n\u003cspan style=\"color:#75715e\"\u003e##   r.squared adj.r.squared sigma statistic  p.value df logLik  AIC  BIC deviance\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1     0.657         0.651   348       112 9.68e-28  2   -871 1750 1761 14154815\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   df.residual m\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1         117 5\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(models_imputed)\n\u003cspan style=\"color:#75715e\"\u003e##          term estimate std.error statistic  p.value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 (Intercept)    120.6     96.67      1.25 2.15e-01\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2       trade     18.1      1.24     14.63 3.45e-28\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3      civlib   -637.8    181.13     -3.52 6.13e-04\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eEven better, though, is that we can use these imputed models in a huxtable regression table. And, because I included a column named \u003ccode\u003em\u003c/code\u003e in \u003ccode\u003eglance.melded()\u003c/code\u003e, we can also include it in the regression output!\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003ehuxreg\u003c/span\u003e(model_original1, model_original2, models_imputed,\n       statistics \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(N \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;nobs\u0026#34;\u003c/span\u003e, R2 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;r.squared\u0026#34;\u003c/span\u003e, `Adj R2` \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;adj.r.squared\u0026#34;\u003c/span\u003e, \n                      \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;logLik\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;AIC\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;m\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eprint_screen\u003c/span\u003e()\n\u003cspan style=\"color:#75715e\"\u003e##                ────────────────────────────────────────────────────────────\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                                         (1)            (2)            (3)  \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                              ──────────────────────────────────────────────\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                  (Intercept)    136.063        166.435        120.591      \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                                (100.409)       (94.871)       (96.669)     \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                  trade           18.027 ***     18.494 ***     18.089 ***  \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                                  (1.272)        (1.204)        (1.237)     \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                  civlib        -665.428 ***   -588.722 **    -637.832 ***  \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                                (185.436)      (175.717)      (181.130)     \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                  infl                           -6.336 ***                 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                                                 (1.620)                    \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                              ──────────────────────────────────────────────\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                  N              115            115            120          \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                  R2               0.653          0.695          0.657      \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                  Adj R2           0.647          0.687          0.651      \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                  logLik        -836.136       -828.709       -870.954      \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                  AIC           1680.272       1667.418       1749.908      \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                  m                                              5.000      \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                ────────────────────────────────────────────────────────────\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                  *** p \u0026lt; 0.001; ** p \u0026lt; 0.01; * p \u0026lt; 0.05.                   \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Column names: names, model1, model2, model3\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e",
            "date_published": "2018-03-08T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2018/03/07/amelia-tidy-melding/",
            "url": "https://www.shagunjhaver.com/blog/2018/03/07/amelia-tidy-melding/",
            "title": "Meld regression output from multiple imputations with tidyverse",
            "summary": "Use tidyverse functions to correctly meld and pool multiply imputed model output.",
            "content_html": "\u003cp\u003e\u003cspan class=\"small\"\u003e(\u003ca href=\"https://github.com/andrewheiss/amelia-tidy-melding\"\u003eSee this notebook on GitHub\u003c/a\u003e)\u003c/span\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eMissing data can significantly influence the results of normal regression models, since the default in R and most other statistical packages is to throw away any rows with missing variables. To avoid unnecessarily throwing out data, it\u0026rsquo;s helpful to impute missing values. One of the best ways to do this is to build a separate regression model to make predictions that fill in the gaps in data. This isn\u0026rsquo;t always accurate, so it\u0026rsquo;s best to make many iterations of predictions (in imputation parlance, \u003ccode\u003e\\(m\\)\u003c/code\u003e is the number of imputations done to a dataset). After making \u003ccode\u003e\\(m\\)\u003c/code\u003e datasets, you can use this data by (1) running statistical tests on each imputation individually and then (2) pooling those results into a single number. The \u003ca href=\"https://cran.r-project.org/web/packages/Amelia/vignettes/amelia.pdf\"\u003eexcellent Amelia vignette\u003c/a\u003e details the theory and mechanics of how to use multiple imputation, and it\u0026rsquo;s a fantastic resource.\u003c/p\u003e\n\u003cp\u003eThere are several packages for dealing with missing data in R, including \u003ca href=\"https://cran.r-project.org/package=mi\"\u003e\u003ccode\u003emi\u003c/code\u003e\u003c/a\u003e, \u003ca href=\"https://cran.r-project.org/package=mice\"\u003e\u003ccode\u003emice\u003c/code\u003e\u003c/a\u003e, and \u003ca href=\"https://cran.r-project.org/package=Amelia\"\u003e\u003ccode\u003eAmelia\u003c/code\u003e\u003c/a\u003e, and Thomas Leeper has \u003ca href=\"http://thomasleeper.com/Rcourse/Tutorials/mi.html\"\u003ea short overview of how to use all three\u003c/a\u003e. I\u0026rsquo;m partial to \u003ca href=\"https://gking.harvard.edu/amelia\"\u003eAmelia\u003c/a\u003e, since it\u0026rsquo;s designed to work well with time series-cross sectional data and can deal with complicated features like country-year observations.\u003c/p\u003e\n\u003cp\u003eBecause Amelia is written by Gary King, et al., it works with \u003ca href=\"https://zeligproject.org/\"\u003eZelig\u003c/a\u003e, a separate framework that\u0026rsquo;s designed to simplify modeling in R. With Zelig + Amelia, you can combine all of the \u003ccode\u003e\\(m\\)\u003c/code\u003e imputations automatically with whatever Zelig uses for printing model results. I\u0026rsquo;m not a huge fan of Zelig, though, and I prefer using \u003ccode\u003elm()\u003c/code\u003e, \u003ccode\u003eglm()\u003c/code\u003e, \u003ccode\u003estan_glm()\u003c/code\u003e, and gang on my own, thank you very much.\u003c/p\u003e\n\u003cp\u003eHowever, doing it on my own means there\u0026rsquo;s a little more work involved with combining coefficients and parameters across imputations. Fortunately, the \u003ca href=\"https://www.tidyverse.org/\"\u003etidyverse\u003c/a\u003e—specifically its ability to store models within data frames—makes it really easy to deal with models based on imputed data. Here\u0026rsquo;s how to do it using tidy functions. The code for this whole process can be greatly simplified in real life. You technically don\u0026rsquo;t need all these intermediate steps, though they\u0026rsquo;re helpful for seeing what\u0026rsquo;s going on behind the scenes.\u003c/p\u003e\n\u003cp\u003eWe\u0026rsquo;ll start by working with some basic example imputed data frame from Amelia\u0026rsquo;s built-in data. We create 5 imputed datasets defining countries and years as cross sections and time series, and we log GDP per capita in the predictive model:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(Amelia)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(broom)\n\n\u003cspan style=\"color:#a6e22e\"\u003eset.seed\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1234\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003edata\u003c/span\u003e(africa)\nimp_amelia \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eamelia\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e africa, m \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, cs \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;country\u0026#34;\u003c/span\u003e, ts \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;year\u0026#34;\u003c/span\u003e, \n                     logs \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;gdp_pc\u0026#34;\u003c/span\u003e, p2s \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe resulting object contains a list of data frames, and each imputed dataset is stored in a list slot named \u0026ldquo;imputations\u0026rdquo; or \u003ccode\u003eimp_amelia$imputations\u003c/code\u003e. We can combine these all into one big data frame with \u003ccode\u003ebind_rows()\u003c/code\u003e, group by the imputation number ($m$), and nest them into imputation-specific rows:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# unclass() is necessary because bind_rows() will complain when dealing with\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# lists with the \u0026#34;amelia\u0026#34; class, which is what amelia() returns\u003c/span\u003e\nall_imputations \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ebind_rows\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eunclass\u003c/span\u003e(imp_amelia\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eimputations), .id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;m\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(m) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003enest\u003c/span\u003e()\n\nall_imputations\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 5 x 2\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## # Groups:   m [5]\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   m     data              \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt; \u0026lt;list\u0026gt;            \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 imp1  \u0026lt;tibble [120 × 7]\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 imp2  \u0026lt;tibble [120 × 7]\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 imp3  \u0026lt;tibble [120 × 7]\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4 imp4  \u0026lt;tibble [120 × 7]\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5 imp5  \u0026lt;tibble [120 × 7]\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWith this nested data, we can use \u003ccode\u003epurrr::map()\u003c/code\u003e to run models and return tidy summaries of those models directly in the data frame:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emodels_imputations \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e all_imputations \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(model \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e data \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(gdp_pc \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e trade \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e civlib, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e .)),\n         tidied \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e model \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(., conf.int \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e)),\n         glance \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e model \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eglance\u003c/span\u003e(.)))\n\nmodels_imputations\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 5 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## # Groups:   m [5]\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   m     data               model  tidied           glance           \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt; \u0026lt;list\u0026gt;             \u0026lt;list\u0026gt; \u0026lt;list\u0026gt;           \u0026lt;list\u0026gt;           \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 imp1  \u0026lt;tibble [120 × 7]\u0026gt; \u0026lt;lm\u0026gt;   \u0026lt;tibble [3 × 7]\u0026gt; \u0026lt;tibble [1 × 12]\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 imp2  \u0026lt;tibble [120 × 7]\u0026gt; \u0026lt;lm\u0026gt;   \u0026lt;tibble [3 × 7]\u0026gt; \u0026lt;tibble [1 × 12]\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 imp3  \u0026lt;tibble [120 × 7]\u0026gt; \u0026lt;lm\u0026gt;   \u0026lt;tibble [3 × 7]\u0026gt; \u0026lt;tibble [1 × 12]\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4 imp4  \u0026lt;tibble [120 × 7]\u0026gt; \u0026lt;lm\u0026gt;   \u0026lt;tibble [3 × 7]\u0026gt; \u0026lt;tibble [1 × 12]\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5 imp5  \u0026lt;tibble [120 × 7]\u0026gt; \u0026lt;lm\u0026gt;   \u0026lt;tibble [3 × 7]\u0026gt; \u0026lt;tibble [1 × 12]\u0026gt;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eHaving the models structured like this makes it easy to access coefficients for models from individual imputations, like so:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emodels_imputations \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(m \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;imp1\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eunnest\u003c/span\u003e(tidied)\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 3 x 11\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## # Groups:   m [1]\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   m     data   model term  estimate std.error statistic  p.value conf.low conf.high glance\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt; \u0026lt;list\u0026gt; \u0026lt;lis\u0026gt; \u0026lt;chr\u0026gt;    \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt;     \u0026lt;dbl\u0026gt; \u0026lt;list\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 imp1  \u0026lt;tibb… \u0026lt;lm\u0026gt;  (Int…    114.      97.7       1.17 2.44e- 1    -79.0     308.  \u0026lt;tibb…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 imp1  \u0026lt;tibb… \u0026lt;lm\u0026gt;  trade     18.1      1.25     14.4  9.65e-28     15.6      20.6 \u0026lt;tibb…\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 imp1  \u0026lt;tibb… \u0026lt;lm\u0026gt;  civl…   -631.     182.       -3.46 7.47e- 4   -993.     -270.  \u0026lt;tibb…\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eMore importantly, we can access the coefficients for all the models, which is essential for combining and averaging the coefficients across all five imputations.\u003c/p\u003e\n\u003cp\u003ePooling or melding coefficients from many models is a little trickier than just averaging them all together (as delightfully easy as that would be). \u003ca href=\"https://doi.org/10.1002/9780470316696\"\u003eDonald Rubin (1987)\u003c/a\u003e outlines an algorithm/set of rules for combining the results from multiply imputed datasets that reflects the averages and accounts for differences in standard errors. Rubin\u0026rsquo;s rules are essentially a fancier, more robust way of averaging coefficients and other quantities of interest across imputations.\u003c/p\u003e\n\u003cp\u003eAmelia has a built-in function for using Rubin\u0026rsquo;s rules named \u003ccode\u003emi.meld()\u003c/code\u003e that accepts two m-by-k matrices (one for coefficients and one for standard errors) like so:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e      coef1  coef2  coefn\nimp1  x      x      x\nimp2  x      x      x\nimpn  x      x      x\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe can use some dplyr/tidyr magic to wrangle the regression results into this form:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Create a wide data frame of just the coefficients and standard errors\u003c/span\u003e\nparams \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e models_imputations \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eunnest\u003c/span\u003e(tidied) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(m, term, estimate, std.error) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egather\u003c/span\u003e(key, value, estimate, std.error) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003espread\u003c/span\u003e(term, value) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eungroup\u003c/span\u003e()\nparams\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 10 x 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##    m     key       `(Intercept)` civlib trade\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##    \u0026lt;chr\u0026gt; \u0026lt;chr\u0026gt;             \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  1 imp1  estimate          114.   -631. 18.1 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  2 imp1  std.error          97.7   182.  1.25\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  3 imp2  estimate          123.   -626. 18.0 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  4 imp2  std.error          96.8   181.  1.24\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  5 imp3  estimate          114.   -633. 18.2 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  6 imp3  std.error          96.5   181.  1.24\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  7 imp4  estimate          119.   -651. 18.2 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  8 imp4  std.error          95.4   180.  1.22\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##  9 imp5  estimate          132.   -648. 18.0 \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 10 imp5  std.error          95.2   180.  1.22\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Extract just the coefficients\u003c/span\u003e\njust_coefs \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e params \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(key \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;estimate\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003em, \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003ekey)\njust_coefs\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 5 x 3\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   `(Intercept)` civlib trade\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##           \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1          114.  -631.  18.1\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2          123.  -626.  18.0\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3          114.  -633.  18.2\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4          119.  -651.  18.2\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5          132.  -648.  18.0\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Extract just the standard errors\u003c/span\u003e\njust_ses \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e params \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(key \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;std.error\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003em, \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003ekey)\njust_ses\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 5 x 3\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   `(Intercept)` civlib trade\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##           \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1          97.7   182.  1.25\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2          96.8   181.  1.24\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3          96.5   181.  1.24\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4          95.4   180.  1.22\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5          95.2   180.  1.22\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe can then use these matrices in \u003ccode\u003emi.meld()\u003c/code\u003e, which returns a list with two slots—\u003ccode\u003eq.mi\u003c/code\u003e and \u003ccode\u003ese.mi\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ecoefs_melded \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emi.meld\u003c/span\u003e(just_coefs, just_ses)\ncoefs_melded\n\u003cspan style=\"color:#75715e\"\u003e## $q.mi\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##      (Intercept) civlib trade\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## [1,]         121   -638  18.1\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $se.mi\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##      (Intercept) civlib trade\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## [1,]        96.7    181  1.24\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eArmed with these, we can create our regression summary table with some more dplyr wizardry. To calculate the p-value and confidence intervals, we need to extract the degrees of freedom from one of the imputed models\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emodel_degree_freedom \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e models_imputations \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eunnest\u003c/span\u003e(glance) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(m \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;imp1\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003epull\u003c/span\u003e(df.residual)\n\nmelded_summary \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eas.data.frame\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ecbind\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e(coefs_melded\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eq.mi),\n                                      \u003cspan style=\"color:#a6e22e\"\u003et\u003c/span\u003e(coefs_melded\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ese.mi))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  magrittr\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eset_colnames\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;estimate\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;std.error\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(term \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erownames\u003c/span\u003e(.)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(term, \u003cspan style=\"color:#a6e22e\"\u003eeverything\u003c/span\u003e()) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(statistic \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e estimate \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e std.error,\n         conf.low \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e estimate \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e std.error \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eqt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.025\u003c/span\u003e, model_degree_freedom),\n         conf.high \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e estimate \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e std.error \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eqt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.975\u003c/span\u003e, model_degree_freedom),\n         p.value \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ept\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eabs\u003c/span\u003e(statistic), model_degree_freedom, lower.tail \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e))\n\nmelded_summary\n\u003cspan style=\"color:#75715e\"\u003e##          term estimate std.error statistic conf.low conf.high  p.value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 (Intercept)    120.6     96.67      1.25    -70.9     312.0 2.15e-01\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2      civlib   -637.8    181.13     -3.52   -996.6    -279.1 6.13e-04\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3       trade     18.1      1.24     14.63     15.6      20.5 3.45e-28\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eHooray! Correctly melded coefficients and standard errors!\u003c/p\u003e\n\u003cp\u003eBut what do we do about the other model details, like \u003ccode\u003e\\(R^2\\)\u003c/code\u003e and the F-statistic? How do we report those?\u003c/p\u003e\n\u003cp\u003eAccording to \u003ca href=\"https://lists.gking.harvard.edu/pipermail/amelia/2016-July/001249.html\"\u003ea post on the Amelia mailing list\u003c/a\u003e, there are two ways. First, we can use a fancy method for combining \u003ccode\u003e\\(R^2\\)\u003c/code\u003e and adjusted \u003ccode\u003e\\(R^2\\)\u003c/code\u003e described by \u003ca href=\"https://doi.org/10.1080/02664760802553000\"\u003eOfer Harel (2009)\u003c/a\u003e. Second, we can just take the average of the \u003ccode\u003e\\(R^2\\)\u003c/code\u003es from all the imputed models. The results should be roughly the same.\u003c/p\u003e\n\u003cp\u003eHarel\u0026rsquo;s method involves two steps:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eIn each complete data set, calculate the \u003ccode\u003e\\(R^2\\)\u003c/code\u003e, take its square root ($R$), transform \u003ccode\u003e\\(R\\)\u003c/code\u003e with a Fisher z-transformation ($Q = \\frac{1}{2} \\log_{e}(\\frac{1 + R}{1 - R})$), and calculate the variance of \u003ccode\u003e\\(R^2\\)\u003c/code\u003e (which is \u003ccode\u003e\\(\\frac{1}{\\text{degrees of freedom}}\\)\u003c/code\u003e)\u003c/li\u003e\n\u003cli\u003eMeld the resulting \u003ccode\u003e\\(Q\\)\u003c/code\u003e and variance using Rubin\u0026rsquo;s rules (\u003ccode\u003emi.meld()\u003c/code\u003e; this creates \u003ccode\u003e\\(Q_a\\)\u003c/code\u003e), undo the z-transformation ($R_a = (\\frac{-1 + \\exp(2Q_a)}{1 + \\exp(2Q_a)})^2$), and square it ($R_a^2$)\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eThat looks complicated, but it\u0026rsquo;s fairly easy with some dplyr magic. Here\u0026rsquo;s how to do it for adjusted \u003ccode\u003e\\(R^2\\)\u003c/code\u003e (the same process works for regular \u003ccode\u003e\\(R^2\\)\u003c/code\u003e too):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Step 1: in each complete data set, calculate R2, take its square root,\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# transform it with Fisher z-transformation, and calculate the variance of R2\\\u003c/span\u003e\nr2s \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e models_imputations \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eunnest\u003c/span\u003e(glance) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(m, adj.r.squared, df.residual) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(R \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(adj.r.squared),  \u003cspan style=\"color:#75715e\"\u003e# Regular R\u003c/span\u003e\n         Q \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elog\u003c/span\u003e((R \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e R)),  \u003cspan style=\"color:#75715e\"\u003e# Fisher z-transformation\u003c/span\u003e\n         se \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e df.residual)  \u003cspan style=\"color:#75715e\"\u003e# R2 variance\u003c/span\u003e\nr2s\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 5 x 6\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## # Groups:   m [5]\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   m     adj.r.squared df.residual     R     Q      se\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;         \u0026lt;dbl\u0026gt;       \u0026lt;int\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;   \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1 imp1          0.643         117 0.802  1.10 0.00855\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 imp2          0.648         117 0.805  1.11 0.00855\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3 imp3          0.652         117 0.807  1.12 0.00855\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4 imp4          0.660         117 0.812  1.13 0.00855\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5 imp5          0.654         117 0.808  1.12 0.00855\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Step 2: combine the results using Rubin\u0026#39;s rules (mi.meld()), inverse transform\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# the value, and square it\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Meld the R2 values with mi.meld()\u003c/span\u003e\nQ_melded \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emi.meld\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eas.matrix\u003c/span\u003e(r2s\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eQ), \u003cspan style=\"color:#a6e22e\"\u003eas.matrix\u003c/span\u003e(r2s\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ese))\n\n\u003cspan style=\"color:#75715e\"\u003e# Inverse transform Q to R and square it\u003c/span\u003e\nr2_melded \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e ((\u003cspan style=\"color:#a6e22e\"\u003eexp\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e Q_melded\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eq.mi) \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eexp\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e Q_melded\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eq.mi)))^2\nr2_melded\n\u003cspan style=\"color:#75715e\"\u003e##       [,1]\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## [1,] 0.651\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe correctly pooled/melded \u003ccode\u003e\\(R^2\\)\u003c/code\u003e is thus 0.651. Neat.\u003c/p\u003e\n\u003cp\u003eHow does this compare to just the average of all the \u003ccode\u003e\\(R^2\\)\u003c/code\u003es from all the imputations?\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003er2s_avg \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e models_imputations \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eungroup\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eunnest\u003c/span\u003e(glance) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003esummarize\u003c/span\u003e(adj.r.squared_avg \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emean\u003c/span\u003e(adj.r.squared)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003epull\u003c/span\u003e(adj.r.squared_avg)\nr2s_avg\n\u003cspan style=\"color:#75715e\"\u003e## [1] 0.651\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe incorrectly averaged \u003ccode\u003e\\(R^2\\)\u003c/code\u003e is 0.651, which is basically identical to the correctly melded 0.651. This is probably because the models from the five imputed models are already fairly similar—there might be more variance in \u003ccode\u003e\\(R^2\\)\u003c/code\u003e in data that\u0026rsquo;s less neat. But for this situation, the two approaches are essentially the same. Other model diagnostics like the F-statistic can probably be pooled just with averages as well. I haven\u0026rsquo;t found any specific algorithms for melding them with fancy math.\u003c/p\u003e\n\u003cp\u003eSo, in summary, combine the coefficients and standard errors from multiply imputed models with \u003ccode\u003emi.meld()\u003c/code\u003e and combine other model parameters like \u003ccode\u003e\\(R^2\\)\u003c/code\u003e either with Harel\u0026rsquo;s fancy method or by simply averaging them.\u003c/p\u003e\n",
            "date_published": "2018-03-07T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2018/02/15/derivatives-r-fun/",
            "url": "https://www.shagunjhaver.com/blog/2018/02/15/derivatives-r-fun/",
            "title": "Fun with empirical and function-based derivatives in R",
            "summary": "Use R to do things with derivatives, both with actual functions and with existing empirical data.",
            "content_html": "\u003cscript src=\"/blog/2018/02/15/derivatives-r-fun/index_files/kePrint-0.0.1/kePrint.js\"\u003e\u003c/script\u003e\n\u003clink href=\"/blog/2018/02/15/derivatives-r-fun/index_files/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" /\u003e\n\u003cp\u003e\u003cspan class=\"small\"\u003e(\u003ca href=\"https://github.com/andrewheiss/derivatives-r-fun\"\u003eSee this notebook on GitHub\u003c/a\u003e)\u003c/span\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cem\u003etl;dr\u003c/em\u003e: Use functions like \u003ccode\u003eDeriv::Deriv()\u003c/code\u003e, \u003ccode\u003esplinefun()\u003c/code\u003e, \u003ccode\u003eapproxfun()\u003c/code\u003e, and \u003ccode\u003euniroot()\u003c/code\u003e to do things with derivatives in R, both with actual functions and with existing empirical data\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eA typical microeconomics problem involves finding the optimal price and quantity of a product, given its demand and cost across different quantities. You can optimize this price and quantity and maximize profit by finding the point where the marginal cost and the marginal revenue (or the first derivatives of the cost and revenue functions) are equal to each other.\u003c/p\u003e\n\u003cp\u003eFor instance, the demand for some product can be defined as \u003ccode\u003e\\(Q = 10 - 2P\\)\u003c/code\u003e (where \u003ccode\u003e\\(Q =\\)\u003c/code\u003e quantity and \u003ccode\u003e\\(P =\\)\u003c/code\u003e price). The revenue you get from selling that product is defined as \u003ccode\u003e\\(R = PQ\\)\u003c/code\u003e (just multiplying price × quantity), so through some algebraic trickery and rearranging of Ps and Qs, you can create a revenue function for this demand curve: \u003ccode\u003e\\(R = 5Q - 0.5Q^2\\)\u003c/code\u003e. The cost function for this product can be defined as \u003ccode\u003e\\(C = 0.25Q + 0.5Q^2\\)\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eTo figure out the optimal profit, we set the marginal cost and marginal revenue equations equal to each other and solve for Q. Here, \u003ccode\u003e\\(\\frac{dC}{dQ} = MC = 0.25 + 0.5Q\\)\u003c/code\u003e and \u003ccode\u003e\\(\\frac{dR}{dQ} = MR = 5 - Q\\)\u003c/code\u003e, so with algebra we can find the optimal point:\u003c/p\u003e\n\u003cp\u003e$$\n\u003ccode\u003e\\begin{aligned} MC \u0026amp;= MR \\\\ 0.25 + 0.5Q \u0026amp;= 5 - Q \\\\ 1.5Q \u0026amp;= 4.75 \\\\ Q \u0026amp;= 3.1\\overline{66} \\end{aligned}\u003c/code\u003e\n$$\u003c/p\u003e\n\u003cp\u003ePhew. Calculus.\u003c/p\u003e\n\u003cp\u003eDoing this in R is fairly straightforward and far more flexible and far less algebra-intensive. First, define the functions:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(Deriv)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(pander)\n\ndemand \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(q) \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e q)\nrevenue \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(q) (\u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e q) \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e q\n\ncost \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(q) (\u003cspan style=\"color:#ae81ff\"\u003e0.25\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e q) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e q)^2\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003ePlotting these functions is easy with \u003ccode\u003egeom_function()\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_function\u003c/span\u003e(fun \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cost, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Total cost\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_function\u003c/span\u003e(fun \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e revenue, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Total revenue\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Quantity\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Price\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_y_continuous\u003c/span\u003e(labels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e scales\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003edollar) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_color_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Total cost\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;red\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Total revenue\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;blue\u0026#34;\u003c/span\u003e),\n                     name \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Function\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_light\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(legend.position \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bottom\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"/blog/2018/02/15/derivatives-r-fun/index_files/figure-html/plot-functions-1.png\" width=\"75%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eThen, using \u003ccode\u003eDeriv::Deriv()\u003c/code\u003e, create derivative functions for the marginal cost and marginal revenue equations:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emr \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eDeriv\u003c/span\u003e(revenue, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;q\u0026#34;\u003c/span\u003e)\nmc \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eDeriv\u003c/span\u003e(cost, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;q\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe can also plot these:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_function\u003c/span\u003e(fun \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e mc, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Marginal cost\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_function\u003c/span\u003e(fun \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e mr, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Marginal revenue\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Quantity\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Price\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_y_continuous\u003c/span\u003e(labels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e scales\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003edollar) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_color_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Marginal cost\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;red\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Marginal revenue\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;blue\u0026#34;\u003c/span\u003e),\n                     name \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Function\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_cartesian\u003c/span\u003e(ylim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e6\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_light\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(legend.position \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bottom\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"/blog/2018/02/15/derivatives-r-fun/index_files/figure-html/plot-marginal-functions-1.png\" width=\"75%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eFinally, use the \u003ccode\u003euniroot()\u003c/code\u003e function to look for the point where \u003ccode\u003emc\u003c/code\u003e and \u003ccode\u003emr\u003c/code\u003e intersect within a given range (here I\u0026rsquo;m looking between 1 and 10 since the demand curve goes negative after \u003ccode\u003e\\(Q =\\)\u003c/code\u003e 10):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eoptimal_q \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003euniroot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(x) \u003cspan style=\"color:#a6e22e\"\u003emc\u003c/span\u003e(x) \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emr\u003c/span\u003e(x), \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e))\noptimal_q\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eroot\n\u003cspan style=\"color:#75715e\"\u003e## [1] 3.166667\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIt\u0026rsquo;s the same answer!\u003c/p\u003e\n\u003cp\u003eWe can then plug \u003ccode\u003eoptimal_q$root\u003c/code\u003e back into the marginal revenue and demand functions to find the optimal price (in a competitive market, the price should be equal to the marginal revenue, but this happens to be a monopoly, so the actual price is higher, but that\u0026rsquo;s totally unrelated to the topic here):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003emr\u003c/span\u003e(optimal_q\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eroot)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 1.833333\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003edemand\u003c/span\u003e(optimal_q\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eroot)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 3.416667\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# oh noes monopolies\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cstrong\u003eHowever! Wait! Stop!\u003c/strong\u003e This is all well and fine if you have precise formulas for demand and cost. But real life is far messier than this. What if you don\u0026rsquo;t know the underlying equations?\u003c/p\u003e\n\u003cp\u003eOften in economics, you have a set of quantities and prices based on empirical data. Market research and surveys can estimate the demand for a product, and tracking how fixed and variable costs change over time can estimate the costs for a product, but this data is all empirically based and not based in actual formulas.\u003c/p\u003e\n\u003cp\u003eFor instance, suppose you have this table of prices, quantities, and costs (which is actually really based on the demand and cost functions from earlier):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ecosts_revenues \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(Quantity \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eseq\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e),\n                         Price \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edemand\u003c/span\u003e(Quantity),\n                         `Total Revenue` \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erevenue\u003c/span\u003e(Quantity),\n                         `Total Cost` \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecost\u003c/span\u003e(Quantity),\n                         Profit \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e `Total Revenue` \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e `Total Cost`)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ctable class=\" pure-table pure-table-horizontal\" style=\"margin-left: auto; margin-right: auto;\"\u003e\n \u003cthead\u003e\n  \u003ctr\u003e\n   \u003cth style=\"text-align:right;\"\u003e Quantity \u003c/th\u003e\n   \u003cth style=\"text-align:left;\"\u003e Price \u003c/th\u003e\n   \u003cth style=\"text-align:left;\"\u003e Total Revenue \u003c/th\u003e\n   \u003cth style=\"text-align:left;\"\u003e Total Cost \u003c/th\u003e\n   \u003cth style=\"text-align:left;\"\u003e Profit \u003c/th\u003e\n  \u003c/tr\u003e\n \u003c/thead\u003e\n\u003ctbody\u003e\n  \u003ctr\u003e\n   \u003ctd style=\"text-align:right;\"\u003e 0 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $5.00 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $0.00 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $0.00 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $0.00 \u003c/td\u003e\n  \u003c/tr\u003e\n  \u003ctr\u003e\n   \u003ctd style=\"text-align:right;\"\u003e 1 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $4.50 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $4.50 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $0.50 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $4.00 \u003c/td\u003e\n  \u003c/tr\u003e\n  \u003ctr\u003e\n   \u003ctd style=\"text-align:right;\"\u003e 2 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $4.00 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $8.00 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $1.50 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $6.50 \u003c/td\u003e\n  \u003c/tr\u003e\n  \u003ctr\u003e\n   \u003ctd style=\"text-align:right;\"\u003e 3 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $3.50 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $10.50 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $3.00 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $7.50 \u003c/td\u003e\n  \u003c/tr\u003e\n  \u003ctr\u003e\n   \u003ctd style=\"text-align:right;\"\u003e 4 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $3.00 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $12.00 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $5.00 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $7.00 \u003c/td\u003e\n  \u003c/tr\u003e\n  \u003ctr\u003e\n   \u003ctd style=\"text-align:right;\"\u003e 5 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $2.50 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $12.50 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $7.50 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $5.00 \u003c/td\u003e\n  \u003c/tr\u003e\n  \u003ctr\u003e\n   \u003ctd style=\"text-align:right;\"\u003e 6 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $2.00 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $12.00 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $10.50 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $1.50 \u003c/td\u003e\n  \u003c/tr\u003e\n  \u003ctr\u003e\n   \u003ctd style=\"text-align:right;\"\u003e 7 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $1.50 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $10.50 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $14.00 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e -$3.50 \u003c/td\u003e\n  \u003c/tr\u003e\n  \u003ctr\u003e\n   \u003ctd style=\"text-align:right;\"\u003e 8 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $1.00 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $8.00 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $18.00 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e -$10.00 \u003c/td\u003e\n  \u003c/tr\u003e\n  \u003ctr\u003e\n   \u003ctd style=\"text-align:right;\"\u003e 9 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $0.50 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $4.50 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $22.50 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e -$18.00 \u003c/td\u003e\n  \u003c/tr\u003e\n  \u003ctr\u003e\n   \u003ctd style=\"text-align:right;\"\u003e 10 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $0.00 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $0.00 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e $27.50 \u003c/td\u003e\n   \u003ctd style=\"text-align:left;\"\u003e -$27.50 \u003c/td\u003e\n  \u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003eWe can still use R to find the optimal quantity, \u003cem\u003e\u003cstrong\u003eeven without actual formulas\u003c/strong\u003e\u003c/em\u003e. R has two base functions for approximating functions based on existing data. \u003ccode\u003eapproxfun()\u003c/code\u003e will try to fit data linearly, and \u003ccode\u003esplinefun()\u003c/code\u003e will try to fit data with cubic splines (i.e. it can handle curvy lines better than \u003ccode\u003eapproxfun()\u003c/code\u003e).\u003c/p\u003e\n\u003cp\u003eFirst, we can plot the revenue and cost columns to see their shape:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ecosts_revenues_plot \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e costs_revenues \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(Quantity, \u003cspan style=\"color:#a6e22e\"\u003estarts_with\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Total\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003egather\u003c/span\u003e(Variable, Price, \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003eQuantity)\n\n\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(costs_revenues_plot, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Quantity, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Price, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e Variable)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_line\u003c/span\u003e(size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_y_continuous\u003c/span\u003e(labels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e scales\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003edollar) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_color_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;red\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;blue\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_light\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(legend.position \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bottom\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"/blog/2018/02/15/derivatives-r-fun/index_files/figure-html/empirical-cost-revenue-1.png\" width=\"75%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eBecause both variables are curvilinear, it\u0026rsquo;s probably best to approximate their functions using splines with \u003ccode\u003esplinefun()\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ecost_empirical \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esplinefun\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e costs_revenues\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eQuantity, \n                            y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e costs_revenues\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003e`Total Cost`)\n\nrevenue_empirical \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esplinefun\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e costs_revenues\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eQuantity, \n                               y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e costs_revenues\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003e`Total Revenue`)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIf we compare the empirically-based functions with their real-life counterparts, we can see that the approximation worked great:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003ecost\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e##  [1]  0.5  1.5  3.0  5.0  7.5 10.5 14.0 18.0 22.5 27.5\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ecost_empirical\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e##  [1]  0.5  1.5  3.0  5.0  7.5 10.5 14.0 18.0 22.5 27.5\u003c/span\u003e\n\n\u003cspan style=\"color:#a6e22e\"\u003erevenue\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e##  [1]  4.5  8.0 10.5 12.0 12.5 12.0 10.5  8.0  4.5  0.0\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003erevenue_empirical\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e##  [1]  4.5  8.0 10.5 12.0 12.5 12.0 10.5  8.0  4.5  0.0\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eDetermining the marginal cost and revenue functions from these approximations is surprisingly easy because \u003ccode\u003esplinefun()\u003c/code\u003e objects have a built-in mechanism for returning derivatives with a \u003ccode\u003ederiv\u003c/code\u003e argument:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003emc\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e##  [1] 0.75 1.25 1.75 2.25 2.75 3.25 3.75 4.25 4.75 5.25\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ecost_empirical\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, deriv \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e##  [1] 0.75 1.25 1.75 2.25 2.75 3.25 3.75 4.25 4.75 5.25\u003c/span\u003e\n\n\u003cspan style=\"color:#a6e22e\"\u003emr\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e##  [1]  4  3  2  1  0 -1 -2 -3 -4 -5\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003erevenue_empirical\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, deriv \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e##  [1]  4  3  2  1  0 -1 -2 -3 -4 -5\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eMagic!\u003c/p\u003e\n\u003cp\u003eWe can plot these empirically-approximated marginal functions and see that they intersect, as expected:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_function\u003c/span\u003e(fun \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cost_empirical, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, args \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(deriv \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e),\n                \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Marginal cost\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_function\u003c/span\u003e(fun \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e revenue_empirical, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, args \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(deriv \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e),\n                \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Marginal revenue\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Quantity\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Price\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_y_continuous\u003c/span\u003e(labels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e scales\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003edollar) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_color_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Marginal cost\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;red\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Marginal revenue\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;blue\u0026#34;\u003c/span\u003e),\n                     name \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Empirical function\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_cartesian\u003c/span\u003e(ylim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e6\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_light\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(legend.position \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bottom\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"/blog/2018/02/15/derivatives-r-fun/index_files/figure-html/plot-empirical-marginal-functions-1.png\" width=\"75%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eFinally, we can use \u003ccode\u003euniroot()\u003c/code\u003e to find where these two functions intersect:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eoptimal_q_empirical \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003euniroot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(x) \u003cspan style=\"color:#a6e22e\"\u003ecost_empirical\u003c/span\u003e(x, deriv \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \n                                 \u003cspan style=\"color:#a6e22e\"\u003erevenue_empirical\u003c/span\u003e(x, deriv \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e))\noptimal_q_empirical\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eroot\n\u003cspan style=\"color:#75715e\"\u003e## [1] 3.166667\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIt\u0026rsquo;s the same!\u003c/p\u003e\n\u003cp\u003eAnd just like before, we can find the optimal price, given this quantity. But first we have to create an empirical function for the demand. The demand variable is linear here, so we can use \u003ccode\u003eapproxfun()\u003c/code\u003e, but \u003ccode\u003esplinefun()\u003c/code\u003e works just fine too (and it has built-in derivative capabilities, while \u003ccode\u003eapproxfun()\u003c/code\u003e doesn\u0026rsquo;t).\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003erevenue_empirical\u003c/span\u003e(optimal_q_empirical\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eroot, deriv \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 1.833333\u003c/span\u003e\n\ndemand_empricial_spline \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esplinefun\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e costs_revenues\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eQuantity,\n                                     y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e costs_revenues\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ePrice)\n\ndemand_empricial_approx \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eapproxfun\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e costs_revenues\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eQuantity,\n                                     y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e costs_revenues\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ePrice)\n\n\u003cspan style=\"color:#a6e22e\"\u003edemand_empricial_spline\u003c/span\u003e(optimal_q_empirical\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eroot)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 3.416667\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003edemand_empricial_approx\u003c/span\u003e(optimal_q_empirical\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eroot)\n\u003cspan style=\"color:#75715e\"\u003e## [1] 3.416667\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# oh noes monopolies again\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe can plot all of these things together:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_function\u003c/span\u003e(fun \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e demand_empricial_spline, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e,\n                \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Demand\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_function\u003c/span\u003e(fun \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cost_empirical, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, args \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(deriv \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e),\n                \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Marginal cost\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_function\u003c/span\u003e(fun \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e revenue_empirical, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, args \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(deriv \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e),\n                \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Marginal revenue\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_vline\u003c/span\u003e(xintercept \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e optimal_q_empirical\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eroot, \n             color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey50\u0026#34;\u003c/span\u003e, linetype \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;dashed\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_hline\u003c/span\u003e(yintercept \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erevenue_empirical\u003c/span\u003e(optimal_q_empirical\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eroot, deriv \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e), \n             color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey50\u0026#34;\u003c/span\u003e, linetype \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;dashed\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Quantity\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Price\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_y_continuous\u003c/span\u003e(labels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e scales\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003edollar) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_color_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Marginal cost\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;red\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Marginal revenue\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;blue\u0026#34;\u003c/span\u003e,\n                                \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Demand\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;darkgreen\u0026#34;\u003c/span\u003e),\n                     name \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Function\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_cartesian\u003c/span\u003e(ylim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e6\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_light\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(legend.position \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bottom\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"/blog/2018/02/15/derivatives-r-fun/index_files/figure-html/plot-all-empirical-1.png\" width=\"75%\" style=\"display: block; margin: auto;\" /\u003e\u003c/p\u003e\n\u003cp\u003eIn this case, the empirical solution and the function-based solution are identical, but that\u0026rsquo;s only because I created the empirical data from the functions. In real life, though, this same process should work on any empirical price, quantity, and cost data.\u003c/p\u003e\n",
            "date_published": "2018-02-15T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2017/09/27/working-with-r-cairo-graphics-custom-fonts-and-ggplot/",
            "url": "https://www.shagunjhaver.com/blog/2017/09/27/working-with-r-cairo-graphics-custom-fonts-and-ggplot/",
            "title": "Working with R, Cairo graphics, custom fonts, and ggplot",
            "summary": "The Cairo graphics library makes it easy to embed custom fonts in PDFs and create high resolution PNGs.",
            "content_html": "\u003cp\u003eSkip to instructions for \u003ca href=\"#mac\"\u003emacOS\u003c/a\u003e or \u003ca href=\"#windows\"\u003eWindows\u003c/a\u003e\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eR and ggplot can create fantastic graphs, but the default Arial/Helvetica font is too boring and standard. You can change the font used in a plot fairly easily three different ways:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eAll of the built-in ggplot themes have a \u003ccode\u003ebase_family\u003c/code\u003e argument for setting the overall font family for the plot\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eelement_text()\u003c/code\u003e has a \u003ccode\u003efamily\u003c/code\u003e argument for changing fonts on individual plot elements\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003egeom_text()\u003c/code\u003e and \u003ccode\u003eannotate(geom = \u0026quot;text\u0026quot;, ...)\u003c/code\u003e have a \u003ccode\u003efamily\u003c/code\u003e argument for changing fonts on text layers\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eFor example:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Load libraries\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)\n\n\u003cspan style=\"color:#75715e\"\u003e# Create plot\u003c/span\u003e\np \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(mpg, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cyl, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e hwy)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_point\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_smooth\u003c/span\u003e(method \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;lm\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eannotate\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e35\u003c/span\u003e, label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;There aren\u0026#39;t a lot of\\n5 cylinder cars\u0026#34;\u003c/span\u003e,\n           family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Source Sans Pro Semibold\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#DC5B44\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Highway miles per gallon and cylinders\u0026#34;\u003c/span\u003e,\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;This is an interesting relationship, I guess\u0026#34;\u003c/span\u003e,\n       caption \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Source: ggplot\u0026#39;s built-in data\u0026#34;\u003c/span\u003e,\n       x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Cylinders\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Highway miles per gallon\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_light\u003c/span\u003e(base_family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Source Sans Pro\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(plot.caption \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Source Sans Pro ExtraLight\u0026#34;\u003c/span\u003e))\np\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cfigure class=\"img-75\"\u003e\u003cimg src=\"example-plot-1.png\"\n         alt=\"Example nice plot\"/\u003e\n\u003c/figure\u003e\n\n\u003cp\u003eHowever, there are a couple difficulties when using custom fonts like this:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eR on Windows does not automatically see custom fonts and will throw an error if you try to use them.\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003eggsave()\u003c/code\u003e on its own cannot correctly save PDF versions of plots with custom fonts—it cannot embed the fonts.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eFixing both of these issues is relatively easy. On Windows, you can either load fonts into R on the fly with \u003ccode\u003ewindowsFonts(name_of_font_inside_r = windowsFont(\u0026quot;Name of actual font\u0026quot;))\u003c/code\u003e, or you can use \u003ccode\u003eextrafonts::load_fonts()\u003c/code\u003e from the \u003ccode\u003eextrafonts\u003c/code\u003e library to permanently load fonts into R\u0026rsquo;s internal database. A full example of this \u003ca href=\"#windows\"\u003eis included below\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eEmbedding fonts in PDFs is also fairly easy. Instead of using R\u0026rsquo;s default PDF-writing engine, you can use the \u003ca href=\"https://www.cairographics.org/\"\u003eCairo graphics library\u003c/a\u003e (which, nowadays, is conveniently packaged with R). Cairo has full Unicode support and can handle embedding custom fonts just fine. To make \u003ccode\u003eggsave()\u003c/code\u003e use the Cairo engine when writing a PDF, specify the device:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggsave\u003c/span\u003e(\u003cspan style=\"color:#66d9ef\"\u003e...\u003c/span\u003e, filename \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;whatever.pdf\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#66d9ef\"\u003e...\u003c/span\u003e, device \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cairo_pdf)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eYou can also use Cairo\u0026rsquo;s PNG engine when writing PNG files. R\u0026rsquo;s default PNG-writing engine can sometimes have issues with correctly setting the resolution. In theory, if you specify a width and a height and a DPI, \u003ccode\u003eggsave()\u003c/code\u003e will generate a file with those dimensions. However, if you place the PNG into Word, PowerPoint, InDesign, or any other programs, the graphic will be too large, for reasons unknown. If you save the graphic with the Cairo library, though, these programs will respect the size and DPI and place the image correctly.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggsave\u003c/span\u003e(\u003cspan style=\"color:#66d9ef\"\u003e...\u003c/span\u003e, filename \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;whatever.png\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#66d9ef\"\u003e...\u003c/span\u003e, dpi \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e300\u003c/span\u003e, type \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;cairo\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eUsing the Cairo PNG library makes a significant difference when you use the image in other programs. Notice how the Cairo-based PNG is actually 4 inches wide in Word, while R\u0026rsquo;s default PNG takes up the full width of the page and uses a lower resolution:\u003c/p\u003e\n\u003cfigure class=\"img-75\"\u003e\u003cimg src=\"cairo_notcairo_word.png\"\n         alt=\"Cairo vs. not Cairo in Word\"/\u003e\n\u003c/figure\u003e\n\n\u003cp\u003eFinally, if you use R Markdown and knitr, you can specify the Cairo device for each output type in the document metadata:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-yaml\" data-lang=\"yaml\"\u003e---\n\u003cspan style=\"color:#f92672\"\u003etitle\u003c/span\u003e: \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Whatever\u0026#34;\u003c/span\u003e\n\u003cspan style=\"color:#f92672\"\u003eoutput\u003c/span\u003e:\n  \u003cspan style=\"color:#f92672\"\u003epdf_document\u003c/span\u003e:\n    \u003cspan style=\"color:#f92672\"\u003edev\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003ecairo_pdf\u003c/span\u003e\n  \u003cspan style=\"color:#f92672\"\u003ehtml_document\u003c/span\u003e:\n    \u003cspan style=\"color:#f92672\"\u003edev\u003c/span\u003e: \u003cspan style=\"color:#ae81ff\"\u003epng\u003c/span\u003e\n---\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003chr\u003e\n\u003cp\u003e \u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s how you can use \u003ccode\u003eggplot::ggsave()\u003c/code\u003e and Cairo to create PDF with embedded custom fonts and PNGs with correct resolutions:\u003c/p\u003e\n\u003ch2 id=\"mac\"\u003eFull instructions for macOS\u003c/h2\u003e\n\u003cp\u003eThe Cairo graphics library should be installed behind the scenes when you install R—you should not need to install any R-specific Cairo libraries or anything for this to work. However, you \u003cem\u003edo\u003c/em\u003e need to install an X11 window system first, like \u003ca href=\"https://www.xquartz.org/\"\u003eXQuartz\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eYou can verify that you have Cairo support by running the \u003ccode\u003ecapabilities()\u003c/code\u003e function; \u003ccode\u003eTRUE\u003c/code\u003e should show up under \u003ccode\u003ecairo\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003ecapabilities\u003c/span\u003e()\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;        jpeg         png        tiff       tcltk         X11        aqua\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;        TRUE        TRUE        TRUE        TRUE        TRUE        TRUE\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;    http/ftp     sockets      libxml        fifo      cledit       iconv\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;        TRUE        TRUE        TRUE        TRUE       FALSE        TRUE\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;         NLS     profmem       cairo         ICU long.double     libcurl\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;        TRUE        TRUE        TRUE        TRUE        TRUE        TRUE\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eR on macOS should automatically see the fonts you have installed on your computer.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s a full example of loading and using a custom font on macOS:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Load libraries\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)\n\n\u003cspan style=\"color:#75715e\"\u003e# Create sample data\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eset.seed\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1234\u003c/span\u003e)  \u003cspan style=\"color:#75715e\"\u003e# This makes R run the same random draw\u003c/span\u003e\ndf \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edata_frame\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e),\n                 y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e))\n\n\u003cspan style=\"color:#75715e\"\u003e# Create plot\u003c/span\u003e\np \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(df, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_point\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;This is a title\u0026#34;\u003c/span\u003e,\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;This is a subtitle\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eannotate\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;This is some text\u0026#34;\u003c/span\u003e,\n           family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Papyrus\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;darkred\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e8\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_light\u003c/span\u003e(base_family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Comic Sans MS\u0026#34;\u003c/span\u003e)\np\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cfigure class=\"img-75\"\u003e\u003cimg src=\"full-example-mac-1.png\"\n         alt=\"Example plot on macOS\"/\u003e\n\u003c/figure\u003e\n\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Save the plot as a PDF with ggsave and Cairo\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# R will want to autocomplete cairo_pdf to cairo_pdf() (note the parentheses)\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# This will not work with the parentheses; ensure there aren\u0026#39;t any\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eggsave\u003c/span\u003e(p, filename \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;example.pdf\u0026#34;\u003c/span\u003e, device \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cairo_pdf,\n       width \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e, height \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, units \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;in\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# You can also save the plot as a high resolution PNG using Cairo\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# Note the difference here; instead of using device = cairo_pdf, you use\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# type = \u0026#34;cairo\u0026#34;. It\u0026#39;s confusing and weird and that\u0026#39;s just life.\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eggsave\u003c/span\u003e(p, filename \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;example.png\u0026#34;\u003c/span\u003e, dpi \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e300\u003c/span\u003e, type \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;cairo\u0026#34;\u003c/span\u003e,\n       width \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e, height \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, units \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;in\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"windows\"\u003eFull instructions for Windows\u003c/h2\u003e\n\u003cp\u003eThe Cairo graphics library should be installed behind the scenes when you install R—you should not need to install any special Cairo libraries or anything for this to work.\u003c/p\u003e\n\u003cp\u003eYou can verify that you have Cairo support by running the \u003ccode\u003ecapabilities()\u003c/code\u003e function; \u003ccode\u003eTRUE\u003c/code\u003e should show up under \u003ccode\u003ecairo\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003ecapabilities\u003c/span\u003e()\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;        jpeg         png        tiff       tcltk         X11        aqua\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;        TRUE        TRUE        TRUE        TRUE       FALSE       FALSE\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;    http/ftp     sockets      libxml        fifo      cledit       iconv\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;        TRUE        TRUE        TRUE        TRUE       FALSE        TRUE\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;         NLS     profmem       cairo         ICU long.double     libcurl\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;        TRUE        TRUE        TRUE        TRUE        TRUE        TRUE\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eR on Windows cannot see the fonts you have installed on your computer. You can see a list of fonts R does have access to with the \u003ccode\u003ewindowsFonts()\u003c/code\u003e function:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003ewindowsFonts\u003c/span\u003e()\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; $serif\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; [1] \u0026#34;TT Times New Roman\u0026#34;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; $sans\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; [1] \u0026#34;TT Arial\u0026#34;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; $mono\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; [1] \u0026#34;TT Courier New\u0026#34;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eYou can add all your system fonts to that database by installing the \u003ccode\u003eextrafont\u003c/code\u003e library and running \u003ccode\u003efont_import()\u003c/code\u003e. This will take a while, though, and it will only pick up fonts that are currently installed. If you install a font later, R will not see it—you\u0026rsquo;ll need to run \u003ccode\u003eextrafont::font_import()\u003c/code\u003e again.\u003c/p\u003e\n\u003cp\u003eAlternatively, you can load fonts into R on the fly, without loading the full database, using \u003ccode\u003ewindowsFonts(name_of_font_inside_r = windowsFont(\u0026quot;Name of actual font\u0026quot;))\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003ewindowsFonts\u003c/span\u003e(`Comic Sans MS` \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ewindowsFont\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Comic Sans MS\u0026#34;\u003c/span\u003e))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eOnce you do this, the font will be loaded:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003ewindowsFonts\u003c/span\u003e()\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; $serif\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; [1] \u0026#34;TT Times New Roman\u0026#34;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; $sans\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; [1] \u0026#34;TT Arial\u0026#34;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; $mono\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; [1] \u0026#34;TT Courier New\u0026#34;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; $`Comic Sans MS`\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; [1] \u0026#34;Comic Sans MS\u0026#34;\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThis only takes effect for your current R session, so if you are knitting a document or if you ever plan on closing RStudio, you\u0026rsquo;ll need to incorporate this font assignment code into your script. If you don\u0026rsquo;t want to do that, run \u003ccode\u003eextrafont::load_fonts()\u003c/code\u003e to load all the fonts—once you do this, you won\u0026rsquo;t need to repeatedly run \u003ccode\u003ewindowsFonts()\u003c/code\u003e to load fonts each time you run a script.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s a full example of loading and using a custom font on Windows:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Load specific fonts into R\u0026#39;s internal database\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003ewindowsFonts\u003c/span\u003e(`Comic Sans MS` \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ewindowsFont\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Comic Sans MS\u0026#34;\u003c/span\u003e))\n\u003cspan style=\"color:#a6e22e\"\u003ewindowsFonts\u003c/span\u003e(Papyrus \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ewindowsFont\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Papyrus\u0026#34;\u003c/span\u003e))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Load libraries\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)\n\n\u003cspan style=\"color:#75715e\"\u003e# Create sample data\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eset.seed\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1234\u003c/span\u003e)  \u003cspan style=\"color:#75715e\"\u003e# This makes R run the same random draw\u003c/span\u003e\ndf \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edata_frame\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e),\n                 y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e))\n\n\u003cspan style=\"color:#75715e\"\u003e# Create plot\u003c/span\u003e\np \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(df, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_point\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eannotate\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;text\u0026#34;\u003c/span\u003e, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;This is some text\u0026#34;\u003c/span\u003e,\n           family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Papyrus\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;darkred\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e8\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;This is a title\u0026#34;\u003c/span\u003e,\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;This is a subtitle\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_light\u003c/span\u003e(base_family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Comic Sans MS\u0026#34;\u003c/span\u003e)\np\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cfigure class=\"img-75\"\u003e\u003cimg src=\"full-example-windows2-1.png\"\n         alt=\"Example plot in Windows\"/\u003e\n\u003c/figure\u003e\n\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Save the plot as a PDF with ggsave and Cairo\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# R will want to autocomplete cairo_pdf to cairo_pdf() (note the parentheses)\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# This will not work with the parentheses; ensure there aren\u0026#39;t any\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eggsave\u003c/span\u003e(p, filename \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;example.pdf\u0026#34;\u003c/span\u003e, device \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cairo_pdf,\n       width \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e, height \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, units \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;in\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# You can also save the plot as a high resolution PNG using Cairo\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# Note the difference here; instead of using device = cairo_pdf, you use\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# type = \u0026#34;cairo\u0026#34;. It\u0026#39;s confusing and weird and that\u0026#39;s just life.\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eggsave\u003c/span\u003e(p, filename \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;example.png\u0026#34;\u003c/span\u003e, dpi \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e300\u003c/span\u003e, type \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;cairo\u0026#34;\u003c/span\u003e,\n       width \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e, height \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, units \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;in\u0026#34;\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003eggsave\u003c/span\u003e(p, filename \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;example_no_cairo.png\u0026#34;\u003c/span\u003e, dpi \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e300\u003c/span\u003e,\n       width \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e, height \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, units \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;in\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e",
            "date_published": "2017-09-27T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2017/09/15/create-supply-and-demand-economics-curves-with-ggplot2/",
            "url": "https://www.shagunjhaver.com/blog/2017/09/15/create-supply-and-demand-economics-curves-with-ggplot2/",
            "title": "Create supply and demand economics curves with ggplot2",
            "summary": "Use ggplot to create economics-style, non-data-based conceptual graphs.",
            "content_html": "\u003cdiv class=\"alert alert-primary\"\u003eThis is now an R package named \u003ca href=\"https://github.com/andrewheiss/reconPlots\"\u003e\u003ccode\u003ereconPlots\u003c/code\u003e\u003c/a\u003e.\u003c/div\u003e\n\u003cp\u003e\u003cspan class=\"small\"\u003e(\u003ca href=\"#tldr\"\u003eSkip to the tl;dr complete example\u003c/a\u003e; \u003ca href=\"https://github.com/andrewheiss/supply-demand-ggplot\"\u003esee this mini project on GitHub\u003c/a\u003e)\u003c/span\u003e\u003c/p\u003e\n\u003cp\u003eSo far, teaching at BYU has been delightful. I\u0026rsquo;ve been using static course-specific websites for the two classes I\u0026rsquo;m teaching this semester—\u003ca href=\"https://datavizf17.classes.andrewheiss.com/\"\u003edata visualization\u003c/a\u003e and \u003ca href=\"https://storiesf17.classes.andrewheiss.com/\"\u003etelling stories with data\u003c/a\u003e—and it\u0026rsquo;s been fantastic. Everything is self-contained and automated and magic and I\u0026rsquo;m a huge fan of \u003ca href=\"https://bookdown.org/yihui/blogdown/\"\u003eblogdown\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eI\u0026rsquo;m teaching basic microeconomics for public managers next semester. Economics is full of graphs, with supply curves, demand curves, intersections, lines, and shaded areas galore. However, these graphics are rarely connected to real data—they\u0026rsquo;re conceptual—which makes them a little harder to plot with statistical graphics packages.\u003c/p\u003e\n\u003cp\u003eIn the econ classes I took at BYU and Duke, I either drew problem set graphs by hand on paper or by hand in Illustrator, which was tedious and not very automatable. Since I\u0026rsquo;m hoping to create another course-specific website with blogdown, I headed out to find an R-based solution for creating conceptual, non-data-based graphs.\u003c/p\u003e\n\u003cp\u003eAfter an \u003ca href=\"https://twitter.com/bechhof/status/908484621800583168\"\u003einitial call out on Twitter\u003c/a\u003e and searches on Google, I found that the cool kids in econ either use OmniGraffle or Illustrator (which requires manual labor) or \u003ca href=\"https://en.wikibooks.org/wiki/LaTeX/PGF/TikZ\"\u003etikz\u003c/a\u003e to create their graphs. R Markdown and knitr \u003ca href=\"https://github.com/yihui/knitr-examples/blob/master/058-engine-tikz.Rmd\"\u003esupport raw tikz chunks\u003c/a\u003e, but only in LaTeX/PDF output (which makes sense, since tikz is essentially TeX). There\u0026rsquo;s \u003ca href=\"https://stackoverflow.com/a/41337307/120898\"\u003ea hacky workaround to get tikz graphics in HTML output\u003c/a\u003e, but \u003ca href=\"https://twitter.com/andrewheiss/status/908506601849470976\"\u003eit looks horrible\u003c/a\u003e. Beyond these issues, I didn\u0026rsquo;t want to learn yet another scripting language, so it was back to looking for R-only solutions.\u003c/p\u003e\n\u003cp\u003eTo my delight, I came across \u003ca href=\"http://is-r.tumblr.com/post/37631901708/economics-style-graphs-with-bezier-from-hmisc\"\u003ethis post from is.R() from 2012\u003c/a\u003e where \u003ca href=\"https://twitter.com/dsparks\"\u003eDavid Sparks\u003c/a\u003e essentially did exactly what I want to do—use ggplot to create conceptual non-data-based graphs. I borrowed extensively from David\u0026rsquo;s original code and updated his system for my own graphs.\u003c/p\u003e\n\u003cp\u003eThere are a couple key functions that make this work. First is \u003ccode\u003ebezier()\u003c/code\u003e from the \u003ca href=\"https://cran.r-project.org/package=Hmisc\"\u003eHmisc package\u003c/a\u003e, which generates a \u003ca href=\"https://en.wikipedia.org/wiki/B%C3%A9zier_curve\"\u003eBézier curve\u003c/a\u003e from a set of coordinates. Importantly, though, we don\u0026rsquo;t need to actually load the Hmisc package, since we only need \u003ccode\u003eHmisc::bezier()\u003c/code\u003e. Loading the whole package muddies up the environment—in particular \u003ccode\u003eHmisc::summarize()\u003c/code\u003e conflicts with \u003ccode\u003edplyr::summarize()\u003c/code\u003e and can cause problems later.\u003c/p\u003e\n\u003cp\u003eFirst, we can create a supply curve:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(dplyr)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(ggplot2)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003esupply \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e Hmisc\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ebezier\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e8\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e9\u003c/span\u003e),\n                        y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e9\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eas_data_frame\u003c/span\u003e()\n\n\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(supply, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#0073D9\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_classic\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_equal\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cfigure class=\"img-75\"\u003e\u003cimg src=\"generate-supply-1.png\"\n         alt=\"Generate supply curve\"/\u003e\n\u003c/figure\u003e\n\n\u003cp\u003eWe can adjust the curviness of the curve by moving the x and y coordinates around. For instance:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003esupply1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e Hmisc\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ebezier\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e9\u003c/span\u003e),\n                         y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e9\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eas_data_frame\u003c/span\u003e()\n\nsupply2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e Hmisc\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ebezier\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e9\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e9\u003c/span\u003e),\n                         y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e9\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eas_data_frame\u003c/span\u003e()\n\nall_supply_curves \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ebind_rows\u003c/span\u003e(supply, supply1, supply2, .id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;id\u0026#34;\u003c/span\u003e)\n\n\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(all_supply_curves, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, colour \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e id)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_color_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#0073D9\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#001F40\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#80DBFF\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_classic\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_equal\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cfigure class=\"img-75\"\u003e\u003cimg src=\"generate-supplies-1.png\"\n         alt=\"Lots of supply curves\"/\u003e\n\u003c/figure\u003e\n\n\u003cp\u003eWe can make a downward-sloping demand curve the same way. Since we\u0026rsquo;re using two \u003ccode\u003egeom_path()\u003c/code\u003e layers here, we remove the \u003ccode\u003edata\u003c/code\u003e parameter to the main \u003ccode\u003eggplot()\u003c/code\u003e function, but keep the aesthetic mapping.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003edemand \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e Hmisc\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ebezier\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e9\u003c/span\u003e),\n                        \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e9\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eas_data_frame\u003c/span\u003e()\n\n\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(mapping \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e supply, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#0073D9\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e demand, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4036\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_classic\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_equal\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cfigure class=\"img-75\"\u003e\u003cimg src=\"generate-demand-1.png\"\n         alt=\"Generate demand curve\"/\u003e\n\u003c/figure\u003e\n\n\u003cp\u003eThe second key function for plotting these supply and demand graphs is a combination of \u003ccode\u003eapproxfun()\u003c/code\u003e and \u003ccode\u003euniroot()\u003c/code\u003e, which we use to find the intersection of the two curves. In his original post, Sparks created an \u003ccode\u003eapproxIntersection()\u003c/code\u003e function to figure out intersections with brute force (i.e. create curves with hundreds of points and then look along the points to find where the coordinates are closest). In his post, he notes:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eThis probably doesn’t work well in a lot of cases, and I would be interested in hearing of anyone’s less hacky solutions.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eSo I wanted to try to find a less hacky solution. In \u003ca href=\"https://stat.ethz.ch/pipermail/r-help/2011-July/282967.html\"\u003ethis old e-mail to r-help\u003c/a\u003e about finding the intersection of two lines, it was suggested that:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eWith linear interpolation, \u003ccode\u003euniroot()\u003c/code\u003e on the difference between the two \u003ccode\u003eapproxfun()\u003c/code\u003es should get you there [the intersection of two curves] rather quickly.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eI\u0026rsquo;ve used R for years and I\u0026rsquo;d never heard of either of those functions. But I figured I\u0026rsquo;d give it a try.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eapproxfun()\u003c/code\u003e takes a matrix of data and approximates a function to fit that data. For example, we can generate a function for the supply curve and then plug in any x value to calculate the corresponding y. Here are the y values for 2, 6, and 8 (they should match the graphs above):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# I honestly have no idea why rule = 2, but things break when rule = 1, so ¯\\_(ツ)_/¯\u003c/span\u003e\nfun_supply \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eapproxfun\u003c/span\u003e(supply\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ex, supply\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ey, rule \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e)\n\n\u003cspan style=\"color:#a6e22e\"\u003efun_supply\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e6\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e8\u003c/span\u003e))\n\n\u003cspan style=\"color:#75715e\"\u003e## [1] 1.590161 4.521605 6.805785\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eMagic.\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003euniroot()\u003c/code\u003e function can take a function and search across an interval for the root of that function (or, in this case, where two functions intersect). As said in the r-help post, we want to the root of the difference of the supply and demand curves. \u003ccode\u003euniroot\u003c/code\u003e only accepts a single function, so we create an anonymous function where we calculate the difference between the two (\u003ccode\u003efunction(x) fun_supply(x) - fun_demand(x)\u003c/code\u003e). We also want to search along the whole range of x, which currently goes from 1 to 9:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003efun_demand \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eapproxfun\u003c/span\u003e(demand\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ex, demand\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ey, rule \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e)\n\nintersection_funs \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e  \u003cspan style=\"color:#a6e22e\"\u003euniroot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(x) \u003cspan style=\"color:#a6e22e\"\u003efun_supply\u003c/span\u003e(x) \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efun_demand\u003c/span\u003e(x), \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e9\u003c/span\u003e))\nintersection_funs\n\n\u003cspan style=\"color:#75715e\"\u003e## $root\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## [1] 4.654098\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $f.root\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## [1] 0.000002875289\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $iter\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## [1] 5\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $init.it\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## [1] NA\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $estim.prec\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## [1] 0.00006103516\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThis gives a lot of output, but we only really care about the \u003ccode\u003e$root\u003c/code\u003e value, which is 4.654. And sure enough, it calculated the correct intersection!\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(mapping \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e supply, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#0073D9\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e demand, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4036\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_vline\u003c/span\u003e(xintercept \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e intersection_funs\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eroot, linetype \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;dotted\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_classic\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_equal\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cfigure class=\"img-75\"\u003e\u003cimg src=\"supply-demand-intersection-x-1.png\"\n         alt=\"Supply demand intersection for just x\"/\u003e\n\u003c/figure\u003e\n\n\u003cp\u003eTo get the horizontal intersection, we just have to find where the vertical intersection (4.654) shows up in the demand function. We calculate this by plugging the intersection into \u003ccode\u003efun_demand()\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ey_root \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efun_demand\u003c/span\u003e(intersection_funs\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eroot)\n\n\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(mapping \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e supply, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#0073D9\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e demand, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4036\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_vline\u003c/span\u003e(xintercept \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e intersection_funs\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eroot, linetype \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;dotted\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_hline\u003c/span\u003e(yintercept \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y_root, linetype \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;dotted\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_classic\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_equal\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cfigure class=\"img-75\"\u003e\u003cimg src=\"supply-demand-intersection-xy-1.png\"\n         alt=\"Supply demand intersection for both x and y\"/\u003e\n\u003c/figure\u003e\n\n\u003cp\u003eFinding the intersections involves a lot of code, so we can put it all in a single function to make life easier later. This function only works on one intersection—it\u0026rsquo;ll find the first intersection in the full range of the first curve. Finding multiple intersections \u003ca href=\"https://stackoverflow.com/a/15298121/120898\"\u003erequires more complicated logic\u003c/a\u003e, but since I\u0026rsquo;m not planning on plotting anything more complicated, I\u0026rsquo;m fine with this.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# curve1 and curve2 should be data.frames with an x and y column\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# For instance, as_data_frame(Hmisc::bezier(c(1, 8, 9), c(1, 5, 9)))\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u003c/span\u003e\ncurve_intersect \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(curve1, curve2) {\n  \u003cspan style=\"color:#75715e\"\u003e# Approximate the functional form of both curves\u003c/span\u003e\n  curve1_f \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eapproxfun\u003c/span\u003e(curve1\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ex, curve1\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ey, rule \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e)\n  curve2_f \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eapproxfun\u003c/span\u003e(curve2\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ex, curve2\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ey, rule \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e)\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Calculate the intersection of curve 1 and curve 2 along the x-axis\u003c/span\u003e\n  point_x \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003euniroot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(x) \u003cspan style=\"color:#a6e22e\"\u003ecurve1_f\u003c/span\u003e(x) \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecurve2_f\u003c/span\u003e(x),\n                     \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003emin\u003c/span\u003e(curve1\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ex), \u003cspan style=\"color:#a6e22e\"\u003emax\u003c/span\u003e(curve1\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ex)))\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eroot\n  \n  \u003cspan style=\"color:#75715e\"\u003e# Find where point_x is in curve 2\u003c/span\u003e\n  point_y \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecurve2_f\u003c/span\u003e(point_x)\n  \n  \u003cspan style=\"color:#75715e\"\u003e# All done!\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ereturn\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e point_x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e point_y))\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe function returns a list with x and y values:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eintersection_xy \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecurve_intersect\u003c/span\u003e(supply, demand)\nintersection_xy\n\n\u003cspan style=\"color:#75715e\"\u003e## $x\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## [1] 4.654098\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $y\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## [1] 3.395557\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe can use this simpler list in the plot. Here, we stop using \u003ccode\u003egeom_vline()\u003c/code\u003e and \u003ccode\u003egeom_hline()\u003c/code\u003e and plot segments instead, stopping at the intersection of the curves (with a point at the intersection, just for fun):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eintersection_xy_df \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e intersection_xy \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eas_data_frame\u003c/span\u003e()\n\n\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(mapping \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e supply, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#0073D9\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e demand, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4036\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_segment\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e intersection_xy_df,\n               \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y), lty \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;dotted\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_segment\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e intersection_xy_df,\n               \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y), lty \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;dotted\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_point\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e intersection_xy_df, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Quantity\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Price\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_classic\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_equal\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cfigure class=\"img-75\"\u003e\u003cimg src=\"supply-demand-intersection-simple-1.png\"\n         alt=\"Simple supply demand intersection\"/\u003e\n\u003c/figure\u003e\n\n\u003cp\u003eNow that we can quickly calculate the intersection of two curves, we can make more complicated plots, like adding a second demand curve and showing the change in price that results from the shift:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003edemand2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e Hmisc\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ebezier\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e11\u003c/span\u003e),\n                         \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e11\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eas_data_frame\u003c/span\u003e()\n\n\u003cspan style=\"color:#75715e\"\u003e# Make a data frame of the intersections of the supply curve and both demand curves\u003c/span\u003e\nintersections \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ebind_rows\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ecurve_intersect\u003c/span\u003e(supply, demand),\n                           \u003cspan style=\"color:#a6e22e\"\u003ecurve_intersect\u003c/span\u003e(supply, demand2))\n\n\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(mapping \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e supply, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#0073D9\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e demand, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4036\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, linetype \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;dashed\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e demand2, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4036\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_segment\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e intersections,\n               \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y), lty \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;dotted\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_segment\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e intersections,\n               \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y), lty \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;dotted\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_point\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e intersections, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Quantity\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Price\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_classic\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_equal\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cfigure class=\"img-75\"\u003e\u003cimg src=\"add-second-demand-curve-1.png\"\n         alt=\"Add second demand curve\"/\u003e\n\u003c/figure\u003e\n\n\u003cp\u003eSuper magic!\u003c/p\u003e\n\u003cp\u003eWe can put a few final touches on it:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eAdd an arrow with \u003ccode\u003eannotate(\u0026quot;segment\u0026quot;, ...)\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eForce the line segments to the axes with \u003ccode\u003escale_*_continuous(expand = c(0, 0), ...)\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eAdd breaks and labels on the axes for the segments with \u003ccode\u003escale_*_continuous(..., breaks = XXX, labels = XXX)\u003c/code\u003e\n\u003cul\u003e\n\u003cli\u003eWe use \u003ca href=\"https://stat.ethz.ch/R-manual/R-devel/library/grDevices/html/plotmath.html\"\u003eplotmath\u003c/a\u003e to get superscripted text in the labels using \u003ccode\u003eexpression(Q[1], Q[2])\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eAdd text annotations directly to the plot with \u003ccode\u003egeom_text()\u003c/code\u003e. We can use plotmath here too, but only if \u003ccode\u003eparse = TRUE\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eUse a nicer font and make the title slightly bigger\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Create a data frame for the in-plot labels\u003c/span\u003e\nplot_labels \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edata_frame\u003c/span\u003e(label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;S\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;D[1]\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;D[2]\u0026#34;\u003c/span\u003e),\n                          x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e8\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e),\n                          y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e8\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e8\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e8\u003c/span\u003e))\n\n\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(mapping \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e supply, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#0073D9\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e demand, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4036\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, linetype \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;dashed\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e demand2, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4036\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_segment\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e intersections,\n               \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y), lty \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;dotted\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_segment\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e intersections,\n               \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y), lty \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;dotted\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_text\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e plot_labels,\n            \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e label), parse \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e,\n            family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Source Sans Pro\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eannotate\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;segment\u0026#34;\u003c/span\u003e, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3.5\u003c/span\u003e, xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4.5\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e6\u003c/span\u003e, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e7\u003c/span\u003e,\n           arrow \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003earrow\u003c/span\u003e(length \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eunit\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;lines\u0026#34;\u003c/span\u003e)), colour \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey50\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_point\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e intersections, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_x_continuous\u003c/span\u003e(expand \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e), breaks \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e intersections\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ex,\n                     labels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eexpression\u003c/span\u003e(Q[1], Q[2])) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_y_continuous\u003c/span\u003e(expand \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e), breaks \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e intersections\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ey,\n                     labels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eexpression\u003c/span\u003e(P[1], P[2])) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Quantity\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Price\u0026#34;\u003c/span\u003e,\n       title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Rightward shift in demand\u0026#34;\u003c/span\u003e,\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;As demand increases, so does price\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_equal\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_classic\u003c/span\u003e(base_family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Source Sans Pro\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(plot.title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Source Sans Pro Semibold\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erel\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1.3\u003c/span\u003e)))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cfigure class=\"img-75\"\u003e\u003cimg src=\"all-together-now-1.png\"\n         alt=\"All together now!\"/\u003e\n\u003c/figure\u003e\n\n\u003cp\u003ePerfect!\u003c/p\u003e\n\u003cp\u003eThe only thing I have left to figure out is shading areas under the lines and curves to show consumer and producer surplus, but I\u0026rsquo;ll get to that later (in theory, it should be a matter of using \u003ccode\u003egeom_ribbon()\u003c/code\u003e, \u003ca href=\"https://stackoverflow.com/a/24419687/120898\"\u003elike this\u003c/a\u003e.)\u003c/p\u003e\n\u003ch2 id=\"tldr\"\u003etl;dr\u003c/h2\u003e\n\u003cp\u003eAll that explanation above makes the process sound more complicated than it actually is. Here\u0026rsquo;s a complete example:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003esupply \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e Hmisc\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ebezier\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e8\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e9\u003c/span\u003e),\n                        \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e9\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003edata.frame\u003c/span\u003e()\n\ndemand1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e Hmisc\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ebezier\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e9\u003c/span\u003e),\n                         \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e9\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003edata.frame\u003c/span\u003e()\n\ndemand2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e Hmisc\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ebezier\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e11\u003c/span\u003e),\n                         \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e11\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003edata.frame\u003c/span\u003e()\n\n\u003cspan style=\"color:#75715e\"\u003e# Calculate the intersections of the two curves\u003c/span\u003e\nintersections \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ebind_rows\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ecurve_intersect\u003c/span\u003e(supply, demand1),\n                           \u003cspan style=\"color:#a6e22e\"\u003ecurve_intersect\u003c/span\u003e(supply, demand2))\n\nplot_labels \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edata_frame\u003c/span\u003e(label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;S\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;D[1]\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;D[2]\u0026#34;\u003c/span\u003e),\n                          x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e8\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e),\n                          y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e8\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e8\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e8\u003c/span\u003e))\n\n\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(mapping \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e supply, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#0073D9\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e demand, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4036\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, linetype \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;dashed\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e demand2, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#FF4036\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_segment\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e intersections,\n               \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y), lty \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;dotted\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_segment\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e intersections,\n               \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y), lty \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;dotted\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_text\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e plot_labels,\n            \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e label), parse \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e,\n            family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Source Sans Pro\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eannotate\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;segment\u0026#34;\u003c/span\u003e, x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3.5\u003c/span\u003e, xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e4.5\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e6\u003c/span\u003e, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e7\u003c/span\u003e,\n           arrow \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003earrow\u003c/span\u003e(length \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eunit\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;lines\u0026#34;\u003c/span\u003e)), colour \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey50\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_point\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e intersections, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_x_continuous\u003c/span\u003e(expand \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e), breaks \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e intersections\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ex,\n                     labels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eexpression\u003c/span\u003e(Q[1], Q[2])) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_y_continuous\u003c/span\u003e(expand \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e), breaks \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e intersections\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ey,\n                     labels \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eexpression\u003c/span\u003e(P[1], P[2])) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Quantity\u0026#34;\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Price\u0026#34;\u003c/span\u003e,\n       title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Rightward shift in demand\u0026#34;\u003c/span\u003e,\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;As demand increases, so does price\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_equal\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_classic\u003c/span\u003e(base_family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Source Sans Pro\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(plot.title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Source Sans Pro Semibold\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erel\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1.3\u003c/span\u003e)))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cfigure class=\"img-75\"\u003e\u003cimg src=\"complete-example-1.png\"\n         alt=\"Complete example\"/\u003e\n\u003c/figure\u003e\n\n",
            "date_published": "2017-09-15T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2017/08/26/quickly-play-with-polity-iv-and-oecd-data-and-see-the-danger-of-us-democracy/",
            "url": "https://www.shagunjhaver.com/blog/2017/08/26/quickly-play-with-polity-iv-and-oecd-data-and-see-the-danger-of-us-democracy/",
            "title": "Quickly play with Polity IV and OECD data (and see the danger of US democracy)",
            "summary": "Use ggplot to reproducibly see how much trouble the Polity Project thinks the US is in.",
            "content_html": "\u003cp\u003eThe \u003ca href=\"http://www.systemicpeace.org/polityproject.html\"\u003ePolity IV Project\u003c/a\u003e released new data yesterday, with democratization scores for 169 countries up to 2016. I wanted to check if the ongoing erosion of US democratic institutions since the 2016 elections registered in the US\u0026rsquo;s Polity score, and, lo and behold, it did! We dropped from our solid, historically consistent 10 to an 8.\u003c/p\u003e\n\u003cp\u003eBut is that bad? How does that compare to other advanced democracies, like countries in the OECD?\u003c/p\u003e\n\u003cp\u003eWhat follows below shows how relatively easy it is to quickly and reproducibly grab the new data, graph it, and compare scores across countries. (This notebook is also in \u003ca href=\"https://github.com/andrewheiss/polity-oecd\"\u003ea GitHub repository\u003c/a\u003e.)\u003c/p\u003e\n\u003cp\u003eBefore we start, we\u0026rsquo;ll load all the libraries we\u0026rsquo;ll need:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)     \u003cspan style=\"color:#75715e\"\u003e# dplyr, ggplot, etc.\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(readxl)        \u003cspan style=\"color:#75715e\"\u003e# Read Excel files\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(forcats)       \u003cspan style=\"color:#75715e\"\u003e# Deal with factors\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(countrycode)   \u003cspan style=\"color:#75715e\"\u003e# Deal with country codes and names\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(rvest)         \u003cspan style=\"color:#75715e\"\u003e# Scrape websites\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(httr)          \u003cspan style=\"color:#75715e\"\u003e# Download stuff\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(ggrepel)       \u003cspan style=\"color:#75715e\"\u003e# Place non-overlapping labels on plots\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFirst, we have to download the new Polity data. We could navigate to the \u003ca href=\"http://www.systemicpeace.org/inscrdata.html\"\u003ePolity IV data page\u003c/a\u003e and download the data manually, but that\u0026rsquo;s not scriptable. Instead, we can use \u003ccode\u003eGET()\u003c/code\u003e from the \u003ccode\u003ehttr\u003c/code\u003e package (or \u003ccode\u003ehttr::GET()\u003c/code\u003e for short) to download the file directly rather than hunting it down with a browser. After saving the Excel file to a temporary file, we use \u003ccode\u003ereadxl::read_excel()\u003c/code\u003e to load and parse the data. The chain of functions following \u003ccode\u003eread_excel()\u003c/code\u003e (chained together with \u003ccode\u003edplyr\u003c/code\u003e’s \u003ccode\u003e%\u0026gt;%\u003c/code\u003e pipes) selects and renames the \u003ca href=\"http://www.correlatesofwar.org/data-sets/cow-country-codes\"\u003eCorrelates of War country code\u003c/a\u003e, year, and polity score; ensures that those columns are integers (rather than text or decimal-based numbers); and finally filters the data to 2001 and beyond.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003epolity.url \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;http://www.systemicpeace.org/inscr/p4v2016.xls\u0026#34;\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Download Polity data to temporary file\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eGET\u003c/span\u003e(polity.url, \u003cspan style=\"color:#a6e22e\"\u003ewrite_disk\u003c/span\u003e(polity.temp \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etempfile\u003c/span\u003e(fileext \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;.xls\u0026#34;\u003c/span\u003e)))\n\n\u003cspan style=\"color:#75715e\"\u003e## Response [http://www.systemicpeace.org/inscr/p4v2016.xls]\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Date: 2017-08-27 01:23\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Status: 200\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Content-Type: application/vnd.ms-excel\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Size: 4.29 MB\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## \u0026lt;ON DISK\u0026gt;  /var/folders/0h/6jl6g9317lv3k5w9h72m18kw0000gn/T//Rtmp0TEhay/file125c8561fd799.xls\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Read and clean Polity data\u003c/span\u003e\npolity \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eread_excel\u003c/span\u003e(polity.temp) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(cowcode \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ccode, year, polity \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e polity2) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate_at\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003evars\u003c/span\u003e(year, cowcode, polity),\n            \u003cspan style=\"color:#a6e22e\"\u003efuns\u003c/span\u003e(as.integer)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(year \u003cspan style=\"color:#f92672\"\u003e\u0026gt;=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2000\u003c/span\u003e)\n\npolity \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eglimpse\u003c/span\u003e()\n\n\u003cspan style=\"color:#75715e\"\u003e## Observations: 2,814\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Variables: 3\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ cowcode \u0026lt;int\u0026gt; 700, 700, 700, 700, 700, 700, 700, 700, 700, 700, 700, 700, 700, 700, 700, 700, 700, 339, 339, 339,...\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ year    \u0026lt;int\u0026gt; 2000, 2001, 2002, 2003, 2004, 2005, 2006, 2007, 2008, 2009, 2010, 2011, 2012, 2013, 2014, 2015, 201...\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ polity  \u0026lt;int\u0026gt; -7, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, NA, -1, -1, -1, 5, 5, 7, 7, 7, 9, 9, 9, 9, 9, 9...\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe Polity project does not include information about OECD membership, so we have to download that on our own. It\u0026rsquo;s relatively easy to google \u0026ldquo;OECD member countries\u0026rdquo; and copy/paste the results from any of the resulting webpages into a CSV file, but that\u0026rsquo;s not reproducible or scriptable.\u003c/p\u003e\n\u003cp\u003eInstead, we can use the \u003ccode\u003ervest\u003c/code\u003e package to scrape data directly from the \u003ca href=\"https://www.oecd.org/about/membersandpartners/list-oecd-member-countries.htm\"\u003eOECD\u0026rsquo;s most recent list of members\u003c/a\u003e. There are several ways to target HTML elements on a page, including both CSS selectors and XPath queries, each with advantages and disadvantages. Using CSS is fairly simple if you\u0026rsquo;re familiar with the structure of the HTML—if you want to select a table inside an \u003ccode\u003e\u0026lt;article\u0026gt;\u003c/code\u003e element in the main \u003ccode\u003e\u0026lt;section id=\u0026quot;content\u0026quot;\u0026gt;\u003c/code\u003e section, you can specify \u003ccode\u003e#content \u0026gt; article \u0026gt; table\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eThe syntax for XPath is easier to use, but is really hard to write by hand. Fortunately, you don\u0026rsquo;t have to do it manually. In Chrome, go to the \u003ca href=\"https://www.oecd.org/about/membersandpartners/list-oecd-member-countries.htm\"\u003eOECD\u0026rsquo;s list\u003c/a\u003e, right click on the webpage, and select \u0026ldquo;Inspect\u0026rdquo; to open Chrome\u0026rsquo;s built in web inspector. Activate the inspection tool and find the table with the list of countries:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"select-element.png\" alt=\"Select HTML table\"\u003e\u003c/p\u003e\n\u003cp\u003eRight click on \u003ccode\u003e\u0026lt;table align=\u0026quot;center\u0026quot; border=\u0026quot;0\u0026quot; style=\u0026quot;width: 75%;\u0026quot;\u0026gt;\u003c/code\u003e in the inspector and choose \u0026ldquo;Copy\u0026rdquo; \u0026gt; \u0026ldquo;Copy XPath\u0026rdquo; to copy an XPath query for that table to the clipboard:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"copy-xpath.png\" alt=\"Copy XPath\"\u003e\u003c/p\u003e\n\u003cp\u003eWe can then use that query (which should be something like \u003ccode\u003e//*[@id=\u0026quot;webEditContent\u0026quot;]/table[2]\u003c/code\u003e) in a \u003ccode\u003edplyr\u003c/code\u003e chain that will load the webpage, select the HTML \u003ccode\u003e\u0026lt;table\u0026gt;\u003c/code\u003e element, and parse it into something R can read.\u003c/p\u003e\n\u003cp\u003eThe \u003ccode\u003edplyr\u003c/code\u003e chain has a few interesting quirks. \u003ccode\u003eread_html()\u003c/code\u003e will download the given URL as HTML, and \u003ccode\u003ehtml_nodes()\u003c/code\u003e will select the HTML element specified by the XPath query. \u003ccode\u003ehtml_table()\u003c/code\u003e will parse that element into an R object (here we specify \u003ccode\u003efill = TRUE\u003c/code\u003e since not all the rows in the table have the same number of columns; filling the table adds additional empty columns to rows that lack them). \u003ccode\u003ebind_rows()\u003c/code\u003e and \u003ccode\u003eas_data_frame()\u003c/code\u003e convert the parsed HTML table into a data frame.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Pro tip: the HTML structure of the OECD page can change over time, and the\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# XPath query will inevitably break. To avoid this, use a snapshot of the\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# webpage from the Internet Archive instead of the current OECD page, since the\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# archived version won\u0026#39;t change.\u003c/span\u003e\n\noecd.url \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;https://web.archive.org/web/20170821160714/https://www.oecd.org/about/membersandpartners/list-oecd-member-countries.htm\u0026#34;\u003c/span\u003e\n\noecd.countries.raw \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eread_html\u003c/span\u003e(oecd.url) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Use single quotes instead of double quotes since XPath uses \u0026#34; in the query\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ehtml_nodes\u003c/span\u003e(xpath \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;//*[@id=\u0026#34;webEditContent\u0026#34;]/table[2]\u0026#39;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ehtml_table\u003c/span\u003e(fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ebind_rows\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eas_data_frame\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eBecause this table has extra empty columns, R doesn\u0026rsquo;t recognize header rows automatically and names each column \u003ccode\u003eX1\u003c/code\u003e, \u003ccode\u003eX2\u003c/code\u003e, and so on.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eoecd.countries.raw \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e()\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 x 4\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##      X1        X2                X3    X4\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;chr\u0026gt;     \u0026lt;chr\u0026gt;             \u0026lt;chr\u0026gt; \u0026lt;lgl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1         Country              Date    NA\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2       AUSTRALIA       7 June 1971    NA\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3         AUSTRIA 29 September 1961    NA\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4         BELGIUM 13 September 1961    NA\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5          CANADA     10 April 1961    NA\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6           CHILE        7 May 2010    NA\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe can select and rename the country and date columns and ignore the empty first and last columns using \u003ccode\u003eselect()\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eoecd.countries.raw1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e oecd.countries.raw \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(Country \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e X2, Date \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e X3)\n\noecd.countries.raw1 \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e()\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 x 2\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##     Country              Date\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##       \u0026lt;chr\u0026gt;             \u0026lt;chr\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1   Country              Date\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2 AUSTRALIA       7 June 1971\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3   AUSTRIA 29 September 1961\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4   BELGIUM 13 September 1961\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5    CANADA     10 April 1961\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6     CHILE        7 May 2010\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eBecause R didn\u0026rsquo;t recognize the header, it included the header as an actual row of data. Additionally, the webpage put a note about membership in the final row:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eoecd.countries.raw1 \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etail\u003c/span\u003e()\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 x 2\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                              Country                               Date\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##                                \u0026lt;chr\u0026gt;                              \u0026lt;chr\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1                             SWEDEN                  28 September 1961\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2                        SWITZERLAND                  28 September 1961\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3                             TURKEY                      2 August 1961\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4                     UNITED KINGDOM                         2 May 1961\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5                      UNITED STATES                      12 April 1961\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6 More on membership and enlargement More on membership and enlargement\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe can use \u003ccode\u003eslice()\u003c/code\u003e to select all rows in between the first and last, starting from row 2 to row \u003ccode\u003en() - 1\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eoecd.countries.raw2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e oecd.countries.raw1 \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eslice\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003en\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e))\n\noecd.countries.raw2 \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e()\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 x 2\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##          Country              Date\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##            \u0026lt;chr\u0026gt;             \u0026lt;chr\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1      AUSTRALIA       7 June 1971\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2        AUSTRIA 29 September 1961\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3        BELGIUM 13 September 1961\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4         CANADA     10 April 1961\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5          CHILE        7 May 2010\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6 CZECH REPUBLIC  21 December 1995\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eoecd.countries.raw2 \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etail\u003c/span\u003e()\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 x 2\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##          Country              Date\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##            \u0026lt;chr\u0026gt;             \u0026lt;chr\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1          SPAIN     3 August 1961\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2         SWEDEN 28 September 1961\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3    SWITZERLAND 28 September 1961\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4         TURKEY     2 August 1961\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5 UNITED KINGDOM        2 May 1961\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6  UNITED STATES     12 April 1961\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFinally, we can use the \u003ccode\u003ecountrycode\u003c/code\u003e package to convert the country names into Correlates of War (COW) codes:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eoecd.countries \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e oecd.countries.raw2 \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(cowcode \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecountrycode\u003c/span\u003e(Country, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;country.name\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;cown\u0026#34;\u003c/span\u003e))\n\noecd.countries \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eglimpse\u003c/span\u003e()\n\n\u003cspan style=\"color:#75715e\"\u003e## Observations: 35\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## Variables: 3\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ Country \u0026lt;chr\u0026gt; \u0026#34;AUSTRALIA\u0026#34;, \u0026#34;AUSTRIA\u0026#34;, \u0026#34;BELGIUM\u0026#34;, \u0026#34;CANADA\u0026#34;, \u0026#34;CHILE\u0026#34;, \u0026#34;CZECH REPUBLIC\u0026#34;, \u0026#34;DENMARK\u0026#34;, \u0026#34;ESTONIA\u0026#34;, \u0026#34;FINL...\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ Date    \u0026lt;chr\u0026gt; \u0026#34;7 June 1971\u0026#34;, \u0026#34;29 September 1961\u0026#34;, \u0026#34;13 September 1961\u0026#34;, \u0026#34;10 April 1961\u0026#34;, \u0026#34;7 May 2010\u0026#34;, \u0026#34;21 Decembe...\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## $ cowcode \u0026lt;int\u0026gt; 900, 305, 211, 20, 155, 316, 390, 366, 375, 220, 255, 350, 310, 395, 205, 666, 325, 740, 732, 367, ...\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eBefore we start plotting, we have to manipulate and filter the data a little bit more. First, we\u0026rsquo;ll create a data frame of just US Polity scores, selecting only countries with a COW code of 2 (which is the US)\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eus.polity \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e polity \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(cowcode \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e)\n\nus.polity \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e()\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 x 3\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   cowcode  year polity\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##     \u0026lt;int\u0026gt; \u0026lt;int\u0026gt;  \u0026lt;int\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1       2  2000     10\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2       2  2001     10\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3       2  2002     10\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4       2  2003     10\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5       2  2004     10\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6       2  2005     10\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWe then want to calculate the average Polity score for all OECD countries over time, excluding the US. We select all rows with a COW code in \u003ccode\u003eoecd.countries$cowcode\u003c/code\u003e using \u003ccode\u003e%in%\u003c/code\u003e in the filter query and then exclude the US with \u003ccode\u003ecowcode != 2\u003c/code\u003e. We then calculate the yearly mean with \u003ccode\u003egroup_by()\u003c/code\u003e and \u003ccode\u003esummarise()\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eoecd.polity \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e polity \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(cowcode \u003cspan style=\"color:#f92672\"\u003e%in%\u003c/span\u003e oecd.countries\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ecowcode,\n         cowcode \u003cspan style=\"color:#f92672\"\u003e!=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(year) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003esummarise\u003c/span\u003e(polity \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emean\u003c/span\u003e(polity, na.rm\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e))\n\noecd.polity \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e()\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 x 2\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##    year   polity\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;int\u0026gt;    \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1  2000 9.454545\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2  2001 9.454545\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3  2002 9.484848\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 4  2003 9.484848\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 5  2004 9.484848\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 6  2005 9.484848\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIn the final plot, we want to include shaded regions showing Polity\u0026rsquo;s general classifications of regime type, where autocracies range from −10 to −6, anocracies range from −5 to 5, and democracies range from 6 to 10. We can use \u003ccode\u003edplyr::tribble()\u003c/code\u003e to quickly create a small data frame with these ranges. The \u003ccode\u003emutate()\u003c/code\u003e command at the end uses \u003ccode\u003eforcats::fct_inorder\u003c/code\u003e to change the \u003ccode\u003edemocracy\u003c/code\u003e column into an ordered factor so the ranges are plotted in the correct order. Finally, to prevent gaps, I add/subtract 0.5 from the start and end values (i.e. since democracies end at 6 and anocracies start at 5, there would be an empty gap in the plot between 5 and 6).\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003epolity.breaks \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etribble\u003c/span\u003e(\n  \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003estart, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003eend, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003edemocracy,\n  \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5.5\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Democracy\u0026#34;\u003c/span\u003e,\n  \u003cspan style=\"color:#ae81ff\"\u003e5.5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e-5.5\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Anocracy\u0026#34;\u003c/span\u003e,\n  \u003cspan style=\"color:#ae81ff\"\u003e-5.5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e-10\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Autocracy\u0026#34;\u003c/span\u003e\n) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(democracy \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efct_inorder\u003c/span\u003e(democracy, ordered \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e))\n\npolity.breaks\n\n\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 3 x 3\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   start   end democracy\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;     \u0026lt;ord\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 1  10.0   5.5 Democracy\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 2   5.5  -5.5  Anocracy\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e## 3  -5.5 -10.0 Autocracy\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNow that we have all the cleaned up data frames, we can finally put it all together in one final plot. Check the heavily commented code below for an explanation of each layer\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# We start with an empty ggplot object since we\u0026#39;re using so many separate data frames\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# First we include the shaded ranges for democracies, anocracies, and\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# autocracies. Since we want the regions to go from edge to edge\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# horizontally, we set xmin and xmax to ±Inf. ymin and ymax use the ranges we\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# created in the polity.breaks data frame. We use democracy as the fill\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# variable. The alpha value makes the layer 80% transparent.\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_rect\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e polity.breaks, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(xmin \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eInf\u003c/span\u003e, xmax \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eInf\u003c/span\u003e,\n                                      ymin \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e end, ymax \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e start,\n                                      fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e democracy),\n            alpha \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.2\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# We then add the line for the US polity score\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_line\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e us.polity, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e year, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e polity), size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#00A1B0\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# And then the line for the average OECD polity score\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_line\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e oecd.polity, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e year, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e polity), size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#EB6642\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# We add a label for the US line above the line at y = 11, using the same color\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_text\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2000\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e11\u003c/span\u003e, label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;United States\u0026#34;\u003c/span\u003e),\n            hjust \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Open Sans Condensed Bold\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#00A1B0\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# We add a similar label for the OECD line at y = 8.5, again with the same color\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_text\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2000\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e8.5\u003c/span\u003e, label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;OECD average\u0026#34;\u003c/span\u003e),\n            hjust \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Open Sans Condensed Bold\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#EB6642\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# All of the data happens in the democracy region, but we want to show the\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# full range of Polity values, so we force the y axis to go from -10 to 11\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_cartesian\u003c/span\u003e(ylim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e11\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e-10\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Remove the \u0026#34;democracy\u0026#34; title from the legend\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eguides\u003c/span\u003e(fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eguide_legend\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Add titles and labels and captions\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Polity IV score\u0026#34;\u003c/span\u003e,\n       title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Democracy in the USA\u0026#34;\u003c/span\u003e, subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;I wonder what happened in 2016…\u0026#34;\u003c/span\u003e,\n       caption \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Source: Polity IV Project\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Use a light theme with Open Sans Light as the default font\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_light\u003c/span\u003e(base_family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Open Sans Light\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Move the legend to the bottom and make the title font bigger, bolder, and condenseder\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(legend.position \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bottom\u0026#34;\u003c/span\u003e,\n        plot.title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Open Sans Condensed Bold\u0026#34;\u003c/span\u003e,\n                                  size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erel\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1.6\u003c/span\u003e)))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"unnamed-chunk-6-1.png\" alt=\"Polity in the US and OECD\"\u003e\u003c/p\u003e\n\u003cp\u003eOnce we have this basic plot, we can extend it with more data. For instance, we can compare the US\u0026rsquo;s Polity score not only to the OECD average, but to specific countries:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003elots.of.countries \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;United States\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Hungary\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Turkey\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Poland\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Mexico\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecountrycode\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;country.name\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;cown\u0026#34;\u003c/span\u003e)\n\nlots.of.countries.polity \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e polity \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(cowcode \u003cspan style=\"color:#f92672\"\u003e%in%\u003c/span\u003e lots.of.countries) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(country \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecountrycode\u003c/span\u003e(cowcode, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;cown\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;country.name\u0026#34;\u003c/span\u003e))\n  \n\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_rect\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e polity.breaks, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(xmin \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eInf\u003c/span\u003e, xmax \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eInf\u003c/span\u003e,\n                                      ymin \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e end, ymax \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e start,\n                                      fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e democracy),\n            alpha \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.2\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# First we add the line for the average OECD polity score. This time we make it dashed\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_line\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e oecd.polity, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e year, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e polity),\n            size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#EB6642\u0026#34;\u003c/span\u003e, linetype \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;dashed\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# We then add the lines for all the other countries\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_line\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e lots.of.countries.polity,\n            \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e year, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e polity, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e country), size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# To create the labels we only select the 2005 values. If we didn\u0026#39;t, labels\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# would appear on every year, and we\u0026#39;d essentially have a plot of repeated\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# labels\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_label_repel\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(lots.of.countries.polity, year \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2005\u003c/span\u003e),\n                   \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e year, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e polity, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e country, label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e country),\n                   family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Open Sans Condensed Bold\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# We add a label for the OECD line at y = 8.5, again with the same color\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_label\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2000\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e8.5\u003c/span\u003e, label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;OECD average\u0026#34;\u003c/span\u003e),\n            hjust \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Open Sans Condensed Bold\u0026#34;\u003c/span\u003e, color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#EB6642\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_cartesian\u003c/span\u003e(ylim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e11\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e-10\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#75715e\"\u003e# Turn off the legend for the color aesthetic\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eguides\u003c/span\u003e(fill \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eguide_legend\u003c/span\u003e(title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e),\n         color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Polity IV score\u0026#34;\u003c/span\u003e,\n       title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Democracy around the world\u0026#34;\u003c/span\u003e,\n       subtitle \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Everyone\u0026#39;s doing okay except the US (and Turkey)\u0026#34;\u003c/span\u003e,\n       caption \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Source: Polity IV Project\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_light\u003c/span\u003e(base_family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Open Sans Light\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(legend.position \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;bottom\u0026#34;\u003c/span\u003e,\n        plot.title \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_text\u003c/span\u003e(family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Open Sans Condensed Bold\u0026#34;\u003c/span\u003e,\n                                  size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erel\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1.6\u003c/span\u003e)))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"unnamed-chunk-7-1.png\" alt=\"Polity in the US, OECD, and others\"\u003e\u003c/p\u003e\n\u003cp\u003eAnd thus we can quickly and reproducibly see that democracy in the USA post-2016 is pretty precariously positioned. (But we\u0026rsquo;re not Turkey. Yet.)\u003c/p\u003e\n",
            "date_published": "2017-08-26T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2017/08/10/exploring-minards-1812-plot-with-ggplot2/",
            "url": "https://www.shagunjhaver.com/blog/2017/08/10/exploring-minards-1812-plot-with-ggplot2/",
            "title": "Exploring Minard's 1812 plot with ggplot2",
            "summary": "Use ggplot to do fun and fancy things with Minard's famous plot of Napoleon's 1812 retreat from Russia.",
            "content_html": "\u003cp\u003eFor whatever reason, I decided to start reading Tolstoy\u0026rsquo;s \u003cem\u003eWar and Peace\u003c/em\u003e (via Audible) the week I had to turn in my dissertation. I still have a dozen or so hours to go, but the book has been incredible. I had no idea what it was about going into it, and was delighted to find that the \u0026ldquo;war\u0026rdquo; parts of the book deal with the Napolonic wars—both his 1804–1805 campaign in the \u003ca href=\"https://en.wikipedia.org/wiki/War_of_the_Third_Coalition\"\u003eWar of the Third Coalition\u003c/a\u003e (like the \u003ca href=\"https://en.wikipedia.org/wiki/Battle_of_Austerlitz\"\u003eBattle of Austerlitz\u003c/a\u003e), and his \u003ca href=\"https://en.wikipedia.org/wiki/French_invasion_of_Russia\"\u003e1812 campaign to invade Russia\u003c/a\u003e, from whence we get \u003ca href=\"https://en.wikipedia.org/wiki/1812_Overture\"\u003eTchaikovsky\u0026rsquo;s \u003cem\u003e1812 Overture\u003c/em\u003e\u003c/a\u003e. I knew \u003cem\u003enothing\u003c/em\u003e about these wars and Tolstoy\u0026rsquo;s descriptions are incredible and gripping.\u003c/p\u003e\n\u003cp\u003eIt\u0026rsquo;s been especially exciting because I\u0026rsquo;m preparing a course on data visualization this fall and had been looking forward to using \u003ca href=\"https://en.wikipedia.org/wiki/Charles_Joseph_Minard#Work\"\u003eCharles Minard\u0026rsquo;s famous plot\u003c/a\u003e about Napoleon\u0026rsquo;s 1812 winter retreat from Moscow, where the Grande Armée dropped from 422,000 to 10,000 troops.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"Minard.png\" alt=\"Original Minard plot\"\u003e\u003c/p\u003e\n\u003cp\u003eEdward Tufte has said that Minard\u0026rsquo;s plot \u0026ldquo;may well be the best statistical graphic ever drawn\u0026rdquo; because it manages to pack a ton of information into one dense figure. The plot contains six variables, each mapped to a different aesthetic:\u003c/p\u003e\n\n\n\n\n\n\u003ctable class=\"pure-table pure-table-horizontal\"\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth\u003eInformation\u003c/th\u003e\n\u003cth\u003eAesthetic\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd\u003eSize of Napoleon\u0026rsquo;s Grande Armée\u003c/td\u003e\n\u003ctd\u003eWidth of path\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eLongitude of the army\u0026rsquo;s position\u003c/td\u003e\n\u003ctd\u003ex-axis\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eLatitude of the army\u0026rsquo;s position\u003c/td\u003e\n\u003ctd\u003ey-axis\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eDirection of the army\u0026rsquo;s movement\u003c/td\u003e\n\u003ctd\u003eColor of path\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eDate of points along retreat path\u003c/td\u003e\n\u003ctd\u003eText below plot\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd\u003eTemperature during the army\u0026rsquo;s retreat\u003c/td\u003e\n\u003ctd\u003eLine below plot\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\n\u003cp\u003eDesigners and statisticians have recreated this plot dozens of times—there are \u003ca href=\"http://www.datavis.ca/gallery/re-minard.php\"\u003egalleries of attempts\u003c/a\u003e all around the internet. It\u0026rsquo;s even included in Hadley Wickham\u0026rsquo;s \u003ca href=\"http://vita.had.co.nz/papers/layered-grammar.pdf\"\u003eoriginal article introducting \u003ccode\u003eggplot2\u003c/code\u003e\u003c/a\u003e. Creating the plot in R is fairly trivial and \u003ca href=\"http://www.datavis.ca/gallery/minard/ggplot2/minard.r\"\u003erequires minimal code\u003c/a\u003e, thanks to ggplot\u0026rsquo;s clear grammar for data graphics.\u003c/p\u003e\n\u003cp\u003eIn the seven years since Hadley\u0026rsquo;s original article, ggplot and R have matured significantly (thanks, in large part, due to the \u003ca href=\"http://www.tidyverse.org/\"\u003etidyverse\u003c/a\u003e). With these improvements, we can add fancier elements to the basic ggplot Minard plot and play around with some fun R features.\u003c/p\u003e\n\u003ch2 id=\"getting-started\"\u003eGetting started\u003c/h2\u003e\n\u003cp\u003eFirst, we load the necessary libraries and data (data available at \u003ca href=\"http://www.datavis.ca/gallery/re-minard.php\"\u003eMichael Friendly\u0026rsquo;s Minard gallery\u003c/a\u003e or in the \u003ca href=\"https://github.com/andrewheiss/fancy-minard/tree/master/input/minard\"\u003eGitHub repository for this notebook\u003c/a\u003e.)\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(lubridate)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(ggmap)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(ggrepel)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(gridExtra)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(pander)\n\ncities \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eread.table\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;input/minard/cities.txt\u0026#34;\u003c/span\u003e,\n                     header \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e, stringsAsFactors \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e)\n\ntroops \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eread.table\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;input/minard/troops.txt\u0026#34;\u003c/span\u003e,\n                     header \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e, stringsAsFactors \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e)\n\ntemps \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eread.table\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;input/minard/temps.txt\u0026#34;\u003c/span\u003e,\n                    header \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e, stringsAsFactors \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(date \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edmy\u003c/span\u003e(date))  \u003cspan style=\"color:#75715e\"\u003e# Convert string to actual date\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"geography\"\u003eGeography\u003c/h2\u003e\n\u003cp\u003eThe troops data includes five variables about troop movement: location, number of survivors, direction (advancing or retreating) and group (since Napoleon had generals commanding different elements of the army).\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003etroops \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epandoc.table\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\n\n\n\n\n\u003ctable class=\"pure-table pure-table-horizontal\"\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align:center\"\u003elong\u003c/th\u003e\n\u003cth style=\"text-align:center\"\u003elat\u003c/th\u003e\n\u003cth style=\"text-align:center\"\u003esurvivors\u003c/th\u003e\n\u003cth style=\"text-align:center\"\u003edirection\u003c/th\u003e\n\u003cth style=\"text-align:center\"\u003egroup\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center\"\u003e24\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e54.9\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e340000\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003eA\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e1\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center\"\u003e24.5\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e55\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e340000\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003eA\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e1\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center\"\u003e25.5\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e54.5\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e340000\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003eA\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e1\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center\"\u003e26\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e54.7\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e320000\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003eA\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e1\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center\"\u003e27\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e54.8\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e300000\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003eA\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e1\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:center\"\u003e28\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e54.9\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e280000\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003eA\u003c/td\u003e\n\u003ctd style=\"text-align:center\"\u003e1\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\n\n\u003cp\u003eEach of these variables maps well into ggplot\u0026rsquo;s aesthetic-based paradigm. If we include just geographic and group information (so there are separate lines for the different divisions), we get a basic skeleton of the original plot:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(troops, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e long, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e lat, group \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e group)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"troops-1-1.png\" alt=\"Troops, line\"\u003e\u003c/p\u003e\n\u003cp\u003eWe can map data to other aesthetics, like color and size:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(troops, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e long, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e lat, group \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e group,\n                   color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e direction, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e survivors)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"troops-2-1.png\" alt=\"Troops, line with color and thickness\"\u003e\u003c/p\u003e\n\u003cp\u003eThe individual segments of the path don\u0026rsquo;t fit together very well and leave big gaps. We can fix that by adding a rounded line ending to each segment.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(troops, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e long, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e lat, group \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e group,\n                   color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e direction, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e survivors)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(lineend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;round\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"troops-3-1.png\" alt=\"Troops, line with color and thickness and rounded ends\"\u003e\u003c/p\u003e\n\u003cp\u003eThe size of the path hides the drama of the plot. Napoleon started the 1812 campaign with 422,000 troops and returned with only 10,000. ggplot automatically makes discrete categories for the \u003ccode\u003esurvivors\u003c/code\u003e variable, resulting in three not-very-granular categories. We can adjust the scale to allow for more categories, thus showing more variation in size and highlighting the devasation of the army:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(troops, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e long, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e lat, group \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e group,\n                   color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e direction, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e survivors)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(lineend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;round\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_size\u003c/span\u003e(range \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e))\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"troops-4-1.png\" alt=\"Troops, big lines\"\u003e\u003c/p\u003e\n\u003cp\u003eFinally, we can remove the labels, legends, and change the colors to match \u003cspan style=\"color:#DFC17E;\"\u003ethe shade of brown\u003c/span\u003e from Minard\u0026rsquo;s original plot (which I figured out with Photoshop\u0026rsquo;s eyedropper tool).\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(troops, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e long, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e lat, group \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e group,\n                   color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e direction, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e survivors)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(lineend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;round\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_size\u003c/span\u003e(range \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_colour_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#DFC17E\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#252523\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eguides\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"troops-5-1.png\" alt=\"Troops, correct colors\"\u003e\u003c/p\u003e\n\u003cp\u003eOne of the amazing things about this plot is that it is actually a map—the x and y axes show the longitude and latitude of the troops. This means we can overlay geographic details, like cities. The cities in the original data can easily be added with \u003ccode\u003egeom_point()\u003c/code\u003e and \u003ccode\u003egeom_text()\u003c/code\u003e. We use \u003ccode\u003evjust\u003c/code\u003e in \u003ccode\u003egeom_text()\u003c/code\u003e to move the labels down away from their points.\u003c/p\u003e\n\u003cp\u003e(Now that we\u0026rsquo;re adding graphical layers from different sources, it\u0026rsquo;s good to move the aesthetics defined in \u003ccode\u003eaes()\u003c/code\u003e to the layers where they\u0026rsquo;re actually used.)\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e troops, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e long, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e lat, group \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e group,\n                               color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e direction, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e survivors),\n            lineend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;round\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_point\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cities, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e long, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e lat)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_text\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cities, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e long, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e lat, label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e city), vjust \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_size\u003c/span\u003e(range \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_colour_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#DFC17E\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#252523\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eguides\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"troops-map-1-1.png\" alt=\"Troops, with city names\"\u003e\u003c/p\u003e\n\u003cp\u003eAlternatively, we can use \u003ccode\u003egeom_text_repel\u003c/code\u003e from the \u003ca href=\"https://github.com/slowkow/ggrepel\"\u003e\u003ccode\u003eggrepel\u003c/code\u003e package\u003c/a\u003e to automatically move the labels away from points and to ensure none of the labels overlap. We can also adjust the labels so they\u0026rsquo;re easier to read (using \u003ca href=\"https://fonts.google.com/specimen/Open+Sans\"\u003eOpen Sans\u003c/a\u003e).\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e troops, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e long, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e lat, group \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e group,\n                               color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e direction, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e survivors),\n            lineend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;round\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_point\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cities, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e long, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e lat),\n             color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#DC5B44\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_text_repel\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cities, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e long, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e lat, label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e city),\n                  color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#DC5B44\u0026#34;\u003c/span\u003e, family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Open Sans Condensed Bold\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_size\u003c/span\u003e(range \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_colour_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#DFC17E\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#252523\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eguides\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"troops-map-2-1.png\" alt=\"Troops, with nicer city names\"\u003e\u003c/p\u003e\n\u003cp\u003eAlso, because this is a map, we can overlay it on other maps. It\u0026rsquo;s fairly easy to get map data from Google or from the \u003ca href=\"https://www.openstreetmap.org/\"\u003eOpenStreetMap project\u003c/a\u003e (through the \u003ca href=\"http://maps.stamen.com/\"\u003eStamen project\u003c/a\u003e) with the \u003ca href=\"https://github.com/dkahle/ggmap\"\u003e\u003ccode\u003eggmap\u003c/code\u003e package\u003c/a\u003e. There are some weird quirks you have to deal with, though:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eYou can supply \u003ccode\u003eggmap\u003c/code\u003e with a four-number bounding box to get a specific region of a map. OpenStreetMap makes this really easy to do. Vavigate to the area you want to map at openstreetmap.org and click on \u0026ldquo;Export\u0026rdquo; in the top toolbar. The left sidebar should show the latitudes and longitudes for the current view. If you click on \u0026ldquo;Manually select a different area,\u0026rdquo; you can create your own bounding box.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"bounding-box.png\" alt=\"OpenStreetMap screenshot\"\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eOpenStreetMap is the only data source ggmap uses that can use exact bounding boxes. When you use Google as a source, Google will find the center of the bounding box and estimate the region you want, and it\u0026rsquo;s often wrong and will get too much of the map (or too little). OpenStreetMap is thus better for getting exact areas.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eBUUUUUT \u003ca href=\"https://github.com/dkahle/ggmap/issues/117\"\u003eOpenStreetMap no longer allows ggmap to access its API\u003c/a\u003e, which stinks. Fortunatley, the \u003ca href=\"http://maps.stamen.com/\"\u003eStamen project\u003c/a\u003e \u003cem\u003edoes\u003c/em\u003e work with \u003ccode\u003eggmap\u003c/code\u003e, and it\u0026rsquo;s based on OpenStreetMap data, so all is well(ish).\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eWith those caveats, we can get map tiles from Stamen with \u003ccode\u003eget_stamenmap()\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emarch.1812.europe \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(left \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e-13.10\u003c/span\u003e, bottom \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e35.75\u003c/span\u003e, right \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e41.04\u003c/span\u003e, top \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e61.86\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# \u0026#34;zoom\u0026#34; ranges from 3 (continent) to 21 (building)\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# \u0026#34;where\u0026#34; is a path to a folder where the downloaded tiles are cached\u003c/span\u003e\nmarch.1812.europe.map \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eget_stamenmap\u003c/span\u003e(bbox \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e march.1812.europe, zoom \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e,\n                                       maptype \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;terrain\u0026#34;\u003c/span\u003e, where \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;cache\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eOnce we have the tiles, the \u003ccode\u003eggmap()\u003c/code\u003e function plots them nicely:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggmap\u003c/span\u003e(march.1812.europe.map)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"show-europe-only-1.png\" alt=\"Map of Europe\"\u003e\u003c/p\u003e\n\u003cp\u003eWe can even use Stamen\u0026rsquo;s fancier map types, like watercolor:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emarch.1812.europe.map.wc \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eget_stamenmap\u003c/span\u003e(bbox \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e march.1812.europe, zoom \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e,\n                                          maptype \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;watercolor\u0026#34;\u003c/span\u003e, where \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;cache\u0026#34;\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003eggmap\u003c/span\u003e(march.1812.europe.map.wc)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"get-tiles-wc-1.png\" alt=\"Watercolor map of Europe\"\u003e\u003c/p\u003e\n\u003cp\u003eNow we can overlay the Minard plot to see where the march took place in relation to the rest of Europe:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggmap\u003c/span\u003e(march.1812.europe.map.wc) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e troops, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e long, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e lat, group \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e group,\n                               color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e direction, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e survivors),\n            lineend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;round\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_size\u003c/span\u003e(range \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_colour_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#DFC17E\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#252523\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eguides\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_nothing\u003c/span\u003e()  \u003cspan style=\"color:#75715e\"\u003e# This is a special theme that comes with ggmap\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"europe-minard-1.png\" alt=\"Watercolor map with troops\"\u003e\u003c/p\u003e\n\u003cp\u003eWe can also zoom in on just northeastern Europe and add the cities back in. We\u0026rsquo;ll save this plot to an object (\u003ccode\u003emarch.1812.plot\u003c/code\u003e) so we can use it later.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emarch.1812.ne.europe \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(left \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e23.5\u003c/span\u003e, bottom \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e53.4\u003c/span\u003e, right \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e38.1\u003c/span\u003e, top \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e56.3\u003c/span\u003e)\n\nmarch.1812.ne.europe.map \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eget_stamenmap\u003c/span\u003e(bbox \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e march.1812.ne.europe, zoom \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e8\u003c/span\u003e,\n                                          maptype \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;terrain-background\u0026#34;\u003c/span\u003e, where \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;cache\u0026#34;\u003c/span\u003e)\n\nmarch.1812.plot \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggmap\u003c/span\u003e(march.1812.ne.europe.map) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e troops, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e long, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e lat, group \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e group,\n                               color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e direction, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e survivors),\n            lineend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;round\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_point\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cities, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e long, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e lat),\n             color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#DC5B44\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_text_repel\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cities, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e long, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e lat, label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e city),\n                  color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#DC5B44\u0026#34;\u003c/span\u003e, family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Open Sans Condensed Bold\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_size\u003c/span\u003e(range \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_colour_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#DFC17E\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#252523\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eguides\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_nothing\u003c/span\u003e()\n\nmarch.1812.plot\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"russia-minard-1.png\" alt=\"Troops with map background\"\u003e\u003c/p\u003e\n\u003cp\u003eMagic!\u003c/p\u003e\n\u003ch2 id=\"temperatures-and-time\"\u003eTemperatures and time\u003c/h2\u003e\n\u003cp\u003eSo far we have four of the variables from Minard\u0026rsquo;s original plot—we\u0026rsquo;re still missing the temperatures during the retreat and the days of the retreat. Minard put this infomration in a separate plot under the map, which is fairly easy to do with \u003ca href=\"https://cran.r-project.org/web/packages/gridExtra/index.html\"\u003e\u003ccode\u003egridExtra\u003c/code\u003e\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eFirst we have to create the panel, which is a basic line graph with longitude along the x-axis and temperature along the y-axis, with text added at each point.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e temps, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e long, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e temp)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_line\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_text\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e temp), vjust \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1.5\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"temps-1-1.png\" alt=\"Temperatures\"\u003e\u003c/p\u003e\n\u003cp\u003eWe can create a new variable for nicer labels, combining temperature with the date. We\u0026rsquo;ll also clean up the theme, move the axis label to the right, and only include major horizontal gridlines. When we overlay the two plots, we have to make sure the x-axes align, so we need to use the same x-axis limits used in \u003ccode\u003emarch.1812.plot\u003c/code\u003e. Those limits are buried inside the plot object, the parts of which can be accessed with \u003ccode\u003eggplot_build()\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggplot_build\u003c/span\u003e(march.1812.plot)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003elayout\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003epanel_ranges[[1]]\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ex.range\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e## [1] 23.5 38.1\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003etemps.nice \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e temps \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(nice.label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003epaste0\u003c/span\u003e(temp, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;°, \u0026#34;\u003c/span\u003e, month, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;. \u0026#34;\u003c/span\u003e, day))\n\ntemps.1812.plot \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e temps.nice, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e long, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e temp)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_line\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_label\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e nice.label),\n            family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Open Sans Condensed Bold\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2.5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;° Celsius\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_x_continuous\u003c/span\u003e(limits \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot_build\u003c/span\u003e(march.1812.plot)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003elayout\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003epanel_ranges[[1]]\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ex.range) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_y_continuous\u003c/span\u003e(position \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;right\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_cartesian\u003c/span\u003e(ylim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e-35\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e  \u003cspan style=\"color:#75715e\"\u003e# Add some space above/below\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_bw\u003c/span\u003e(base_family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Open Sans Condensed Light\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(panel.grid.major.x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e(),\n        panel.grid.minor.x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e(),\n        panel.grid.minor.y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e(),\n        axis.text.x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e(), axis.ticks \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e(),\n        panel.border \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e())\n\ntemps.1812.plot\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"temps-2-1.png\" alt=\"Temperatures, cleaner\"\u003e\u003c/p\u003e\n\u003ch2 id=\"combining-the-plots\"\u003eCombining the plots\u003c/h2\u003e\n\u003cp\u003eFinally, we use functions in \u003ccode\u003egridExtra\u003c/code\u003e to combine the two plots. The easiest way to combine plot objects with \u003ccode\u003egridExtra\u003c/code\u003e is to use \u003ccode\u003egrid.arrange()\u003c/code\u003e, but doing so doesn\u0026rsquo;t align the axes of the plot. For instance, look at these two example plots—they\u0026rsquo;re no longer comparable vertically because the left side of the bottom plot extends to the edge of the plot, expanding under the long axis label in the top plot:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eexample.data \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edata_frame\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e))\n\nplot1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(example.data, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_line\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;This is a really\\nreally really really\\nreally tall label\u0026#34;\u003c/span\u003e)\n\nplot2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(example.data, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_line\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e)\n\n\u003cspan style=\"color:#a6e22e\"\u003egrid.arrange\u003c/span\u003e(plot1, plot2)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"align-example-1.png\" alt=\"Combined plots\"\u003e\u003c/p\u003e\n\u003cp\u003eInstead of using \u003ccode\u003egrid.arrange\u003c/code\u003e, we can use \u003ccode\u003egridExtra\u003c/code\u003e’s special version of \u003ccode\u003erbind()\u003c/code\u003e (or \u003ccode\u003ecbind()\u003c/code\u003e) for \u003ccode\u003eggplotGrob\u003c/code\u003e objects:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eplot.both \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erbind\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eggplotGrob\u003c/span\u003e(plot1),\n                   \u003cspan style=\"color:#a6e22e\"\u003eggplotGrob\u003c/span\u003e(plot2))\n\ngrid\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003egrid.newpage\u003c/span\u003e()\ngrid\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003egrid.draw\u003c/span\u003e(plot.both)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"align-example-good-1.png\" alt=\"Combined with gtable\"\u003e\u003c/p\u003e\n\u003cp\u003eNow that we can align plots correctly, we can combine the map and the temperature:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eboth.1812.plot \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erbind\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eggplotGrob\u003c/span\u003e(march.1812.plot),\n                        \u003cspan style=\"color:#a6e22e\"\u003eggplotGrob\u003c/span\u003e(temps.1812.plot))\n\ngrid\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003egrid.newpage\u003c/span\u003e()\ngrid\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003egrid.draw\u003c/span\u003e(both.1812.plot)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"align-minard-1.png\" alt=\"All combined\"\u003e\u003c/p\u003e\n\u003cp\u003eThey\u0026rsquo;re aligned, but there\u0026rsquo;s an obvious problem—the map is way too small and the temperatures are too tall. With \u003ccode\u003egrid.arrange\u003c/code\u003e it\u0026rsquo;s possible to pass a vector of relative panel heights, which would let us shrink the bottom panel. While using \u003ccode\u003egtable::rbind()\u003c/code\u003e does let us align the two plots, it doesn\u0026rsquo;t provide an easy way to mess with panel heights. Following \u003ca href=\"https://stackoverflow.com/questions/24331107/the-perils-of-aligning-plots-in-ggplot/24333504#24333504\"\u003ethis StackOverflow answer\u003c/a\u003e, though, we can mess with the ggplot object and adjust the panels manually.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Identify which layout elements are panels\u003c/span\u003e\npanels \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e both.1812.plot\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003elayout\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et\u003cspan style=\"color:#a6e22e\"\u003e[grep\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;panel\u0026#34;\u003c/span\u003e, both.1812.plot\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003elayout\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ename)]\n\n\u003cspan style=\"color:#75715e\"\u003e# Normally we can pass a vector of null units that represent relative heights.\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# For instance, `unit(c(3, 1), \u0026#34;null\u0026#34;)` would make the top panel 3 times as\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# tall as the bottom.\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# But, the map here uses coord_equal() to show the correct dimensions of the\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# map, and this messes with the panel height for whatever reason. So instead,\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# we extract the original map panel height, which is really small, and then\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# make the bottom panel smaller in the same scale.\u003c/span\u003e\nmap.panel.height \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e both.1812.plot\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eheights[panels][1]\n\n\u003cspan style=\"color:#75715e\"\u003e# See, super small\u003c/span\u003e\nmap.panel.height\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e## [1] 0.345197879241894null\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Apply new panel heights to object\u003c/span\u003e\nboth.1812.plot\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eheights[panels] \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eunit\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(map.panel.height, \u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e), \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;null\u0026#34;\u003c/span\u003e)\n\ngrid\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003egrid.newpage\u003c/span\u003e()\ngrid\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003egrid.draw\u003c/span\u003e(both.1812.plot)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"adjust-panels-1.png\" alt=\"Combined with correct heights\"\u003e\u003c/p\u003e\n\u003cp\u003eWe can follow the same process to create a backgroundless version of the map:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# No map this time\u003c/span\u003e\nmarch.1812.plot.simple \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_path\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e troops, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e long, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e lat, group \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e group,\n                               color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e direction, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e survivors),\n            lineend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;round\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_point\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cities, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e long, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e lat),\n             color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#DC5B44\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_text_repel\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e cities, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e long, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e lat, label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e city),\n                  color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#DC5B44\u0026#34;\u003c/span\u003e, family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Open Sans Condensed Bold\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_size\u003c/span\u003e(range \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_colour_manual\u003c/span\u003e(values \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#DFC17E\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;#252523\u0026#34;\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003eguides\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eFALSE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_nothing\u003c/span\u003e()\n\n\u003cspan style=\"color:#75715e\"\u003e# Change the x-axis limits to match the simple map\u003c/span\u003e\ntemps.1812.plot \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e temps.nice, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e long, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e temp)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_line\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003egeom_label\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(label \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e nice.label),\n            family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Open Sans Condensed Bold\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2.5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003elabs\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;° Celsius\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_x_continuous\u003c/span\u003e(limits \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot_build\u003c/span\u003e(march.1812.plot.simple)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003elayout\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003epanel_ranges[[1]]\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ex.range) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003escale_y_continuous\u003c/span\u003e(position \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;right\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003ecoord_cartesian\u003c/span\u003e(ylim \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e-35\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e  \u003cspan style=\"color:#75715e\"\u003e# Add some space above/below\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme_bw\u003c/span\u003e(base_family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Open Sans Condensed Light\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003etheme\u003c/span\u003e(panel.grid.major.x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e(),\n        panel.grid.minor.x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e(),\n        panel.grid.minor.y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e(),\n        axis.text.x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e(), axis.ticks \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e(),\n        panel.border \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eelement_blank\u003c/span\u003e())\n\n\u003cspan style=\"color:#75715e\"\u003e# Combine the two plots\u003c/span\u003e\nboth.1812.plot.simple \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erbind\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eggplotGrob\u003c/span\u003e(march.1812.plot.simple),\n                               \u003cspan style=\"color:#a6e22e\"\u003eggplotGrob\u003c/span\u003e(temps.1812.plot))\n\n\u003cspan style=\"color:#75715e\"\u003e# Adjust panels\u003c/span\u003e\npanels \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e both.1812.plot.simple\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003elayout\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et\u003cspan style=\"color:#a6e22e\"\u003e[grep\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;panel\u0026#34;\u003c/span\u003e, both.1812.plot.simple\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003elayout\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ename)]\n\n\u003cspan style=\"color:#75715e\"\u003e# Because this plot doesn\u0026#39;t use coord_equal, since it\u0026#39;s not a map, we can use\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# whatever relative numbers we want, like a 3:1 ratio\u003c/span\u003e\nboth.1812.plot.simple\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eheights[panels] \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eunit\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e), \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;null\u0026#34;\u003c/span\u003e)\n\ngrid\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003egrid.newpage\u003c/span\u003e()\ngrid\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003egrid.draw\u003c/span\u003e(both.1812.plot.simple)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"combined-simple-1.png\" alt=\"Recreation of Minard\u0026rsquo;s plot\"\u003e\u003c/p\u003e\n\u003ch2 id=\"conclusion\"\u003eConclusion\u003c/h2\u003e\n\u003cp\u003eRecreating Minard\u0026rsquo;s famous 1812 plot is relatively easy to do with ggplot. Adding fancy bells and whistles like maps and aligned panels is a little trickier, but the end result is worth the extra effort.\u003c/p\u003e\n",
            "date_published": "2017-08-10T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2017/04/27/super-basic-practical-guide-to-docker-and-rstudio/",
            "url": "https://www.shagunjhaver.com/blog/2017/04/27/super-basic-practical-guide-to-docker-and-rstudio/",
            "title": "Super basic practical guide to Docker and RStudio",
            "summary": "Use RStudio inside Docker containers for portable and reproducible development environments.",
            "content_html": "\u003cp\u003eAll the cool data science kids seem to be using \u003ca href=\"https://www.docker.com/\"\u003eDocker\u003c/a\u003e these days, and being able to instantly spin up a pre-built computer with a complete development or production environment is magic. The R community has also jumped on the Docker whale, and \u003ca href=\"https://ropensci.org/\"\u003erOpenSci\u003c/a\u003e maintains \u003ca href=\"https://hub.docker.com/u/rocker/\"\u003edozens of pre-built Docker images\u003c/a\u003e. \u003ca href=\"https://ropensci.org/blog/blog/2014/10/23/introducing-rocker\"\u003eThese images are well documented\u003c/a\u003e and there are \u003ca href=\"https://github.com/rocker-org/rocker/wiki/Using-the-RStudio-image\"\u003ehelpful guides explaining how to get started\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eRead all that first. This post doesn\u0026rsquo;t explain how Docker works. Instead, it\u0026rsquo;s a quick super basic beginner\u0026rsquo;s guide about how I use these Docker images in real-world R development and research.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eContents:\u003c/strong\u003e\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#why-even-do-this\"\u003eWhy even do this\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#run-locally-with-a-gui\"\u003eRun locally with a GUI\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#run-on-a-remote-server\"\u003eRun on a remote server\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#getting-stuff-in-and-out-of-the-container\"\u003eGetting stuff in and out of the container\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#running-on-a-remote-server-without-rstudio\"\u003eRunning on a remote server without RStudio\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#making-a-custom-dockerfile\"\u003eMaking a custom Dockerfile\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003chr\u003e\n\u003ch2 id=\"why-even-do-this\"\u003eWhy even do this\u003c/h2\u003e\n\u003cp\u003eI\u0026rsquo;ve found two general reasons for running R in a Docker container:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eReproducibility and consistent development environments\u003c/strong\u003e: Python virtual environments are awesome—anyone can install all the packages/libraries your script needs in a local Python installation. R doesn\u0026rsquo;t have virtual environments. R has \u003ca href=\"https://rstudio.github.io/packrat/\"\u003e\u003ccode\u003epackrat\u003c/code\u003e\u003c/a\u003e, which is incorporated into RStudio, but it\u0026rsquo;s a hassle and I hate using it and can never get it working right.\u003c/p\u003e\n\u003cp\u003eInstead of using packrat, you can develop an R project within a Docker container. (This idea comes from a \u003ca href=\"https://twitter.com/noamross/status/842196567050330112\"\u003eTwitter conversation\u003c/a\u003e with \u003ca href=\"https://twitter.com/noamross\"\u003e@noamross\u003c/a\u003e.) Create a custom Dockerfile for your project where you install any additional packages your project needs (\u003ca href=\"#making-a-custom-dockerfile\"\u003emore on that below\u003c/a\u003e), and then develop your project in the browser-based RStudio from the container. (Or, be lazy like me and keep developing in your local R installation without containers and periodically check to make sure it all works in a pristine development environment in a container).\u003c/p\u003e\n\u003cp\u003eAll someone needs to do to run your project is pull the Docker image for your project, which will already have all the packages and dependencies and extra files installed.\u003c/p\u003e\n\u003cp\u003eIn an ideal world, you can create a Dockerfile for a specific project, develop everything in RStudio in the browser, and the distribute both the \u003ca href=\"https://github.com/andrewheiss/docker-donors-ngo-restrictions\"\u003eDockerfile\u003c/a\u003e and the \u003ca href=\"https://github.com/andrewheiss/donors-ngo-restrictions\"\u003eproject repository\u003c/a\u003e so others can reproduce everything.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eOffloading computationally intensive stuff\u003c/strong\u003e: I often build Bayesian models with \u003ca href=\"http://mc-stan.org/\"\u003eStan\u003c/a\u003e and \u003ca href=\"http://mc-stan.org/interfaces/rstanarm\"\u003e\u003ccode\u003erstanarm\u003c/code\u003e\u003c/a\u003e. Complicated Bayesian models take forever to run, though, because of long Monte Carlo Markov chains (it takes hours to run dozens of Bayesian random effects effects models with \u003ccode\u003erstanarm::stan_glmer()\u003c/code\u003e, for instance). Rather than tie up my computer and make it so I can\u0026rsquo;t put it to sleep, I create a virtual server on \u003ca href=\"https://www.digitalocean.com/\"\u003eDigitalOcean\u003c/a\u003e and run these intensive scripts in a Docker container there.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"run-locally-with-a-gui\"\u003eRun locally with a GUI\u003c/h2\u003e\n\u003cp\u003eThe easiest possible way to play with Docker is to use \u003ca href=\"https://kitematic.com/\"\u003eKitematic\u003c/a\u003e, Docker\u0026rsquo;s own cross-platform GUI. Kitematic automatically installs Docker and all its dependencies and it runs a virtual Linux machine in the background, which \u003cem\u003ethen\u003c/em\u003e runs Docker inside. With Kitematic you can search for public images and builds on \u003ca href=\"https://hub.docker.com\"\u003eDocker Hub\u003c/a\u003e and manage all your running containers without having to deal with the command line.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eDownload and install \u003ca href=\"https://kitematic.com/\"\u003eKitematic\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eSearch for a Docker image, like \u003ca href=\"https://hub.docker.com/r/rocker/tidyverse/\"\u003e\u003ccode\u003erocker/tidyverse\u003c/code\u003e\u003c/a\u003e and create it\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"kitematic-search.png\" alt=\"Search for a container in Kitematic\" title=\"Search for a container in Kitematic\"\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eAccess a containerized RStudio installation at the URL shown in Kitematic (in this case \u003ccode\u003e192.168.99.100:32769\u003c/code\u003e (default username and password are both \u003ccode\u003erstudio\u003c/code\u003e)\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"kitematic-rstudio.png\" alt=\"RStudio running in a Docker container in Kitematic\" title=\"RStudio running in a Docker container in Kitematic\"\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eStop the container when you\u0026rsquo;re all done\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"run-on-a-remote-server\"\u003eRun on a remote server\u003c/h2\u003e\n\u003cp\u003eRunning a container remotely lets you offload computationally intensive tasks. There\u0026rsquo;s no fancy GUI for starting remote containers, but it\u0026rsquo;s easy enough.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eCreate a \u003ca href=\"https://www.digitalocean.com/\"\u003eDigitalOcean droplet\u003c/a\u003e. Use one of the pre-built Docker one-click apps and choose some size for your server (number of CPUs and amount of RAM).\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"do-create.png\" alt=\"Create DigitalOcean droplet with Docker pre-installed\" title=\"Create DigitalOcean droplet with Docker pre-installed\"\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eOnce the server is live, log into it via \u003ccode\u003essh\u003c/code\u003e from your local machine: \u003ccode\u003essh root@ip_address_here\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eGet the latest version of the Docker image of your choice by typing \u003ccode\u003edocker pull rocker/tidyverse\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eRun that image \u003ccode\u003edocker run -d -p 8787:8787 rocker/tidyverse\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eAccess the remote RStudio installation at \u003ccode\u003eip_address_here:8787\u003c/code\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eStop the container or destroy the DigitalOcean droplet when you\u0026rsquo;re done.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eBonus things:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eIf you select \u0026ldquo;User data\u0026rdquo; in the additional options section when creating the droplet, you can paste a \u003ca href=\"https://www.digitalocean.com/community/tutorials/how-to-use-cloud-config-for-your-initial-server-setup\"\u003e\u003ccode\u003ecloud-config\u003c/code\u003e\u003c/a\u003e file that contains a list of directives to run when the droplet is initialized.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"do-cloud-config.png\" alt=\"User data option in DigitalOcean\" title=\"User data option in DigitalOcean\"\u003e\u003c/p\u003e\n\u003cp\u003eYou can use this to automatically pull and run the Docker image when you create the droplet so there\u0026rsquo;s no need to even SSH into the new machine. Just wait a couple minutes for Docker to do its thing and you\u0026rsquo;ll have an RStudio installation waiting at \u003ccode\u003eip_address_here:8787\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s a basic \u003ccode\u003ecloud-config\u003c/code\u003e file I use to automatically start the server and set a password:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e#cloud-config\nruncmd:\n  - docker run -d -p 8787:8787 -e PASSWORD=supersekrit rocker/tidyverse\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eIf you \u003ca href=\"https://www.digitalocean.com/community/tutorials/how-to-use-ssh-keys-with-digitalocean-droplets\"\u003eupload your public SSH key to DigitalOcean\u003c/a\u003e you can automatically add it to the droplet when creating it, making it so you can log in via SSH without a password.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"do-ssh.png\" alt=\"Enable SSH key in DigitalOcean\" title=\"Enable SSH key in DigitalOcean\"\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"getting-stuff-in-and-out-of-the-container\"\u003eGetting stuff in and out of the container\u003c/h2\u003e\n\u003cp\u003eWhen you pull an image from Docker Hub, they\u0026rsquo;re typically empty and pristine. You have to add your own files and data. Also, Docker containers are ephemeral. Once you stop running a container, any data stored in it disappears—when you start the container again, it\u0026rsquo;ll be back in its pristine state.\u003c/p\u003e\n\u003cp\u003eThere are multiple ways to get files in and out of a container though:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eLocally mounted volume\u003c/strong\u003e: It\u0026rsquo;s possible to run a Docker container that mounts a local folder into the container\u0026rsquo;s file system, making local files accessible to the container. Setting this up in Kitematic is trivial—change the container\u0026rsquo;s \u0026ldquo;Volumes\u0026rdquo; setting to map the built-in \u003ccode\u003ekitematic\u003c/code\u003e folder to some local directory on your computer, and anything you save in the \u003ccode\u003ekitematic\u003c/code\u003e folder within the container will actually be saved on your computer. Setting this up from terminal (like on a remote computer) is trickier (Google \u0026ldquo;docker mount local directory\u0026rdquo;). However, since I create and delete remote servers willy nilly, I don\u0026rsquo;t ever really get around to mounting directories remotely.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"kitematic-mount.png\" alt=\"Volume mounting settings in Kitematic\" title=\"Volume mounting settings in Kitematic\"\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003eUpload and download with RStudio\u003c/strong\u003e: You can use the \u0026ldquo;Upload\u0026rdquo; button in the \u0026ldquo;Files\u0026rdquo; panel in RStudio to get individual files or whole directories into the container. Use \u0026ldquo;More \u0026gt; Export\u0026rdquo; to download files.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"rstudio-upload-download.png\" alt=\"Upload and download with RStudio\" title=\"Upload and download with RStudio\"\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cstrong\u003egit\u003c/strong\u003e: You can clone and pull a git repository using RStudio.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"rstudio-git.png\" alt=\"Git push/pull in RStudio\" title=\"Git push/pull in RStudio\"\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"running-on-a-remote-server-without-rstudio\"\u003eRunning on a remote server without RStudio\u003c/h2\u003e\n\u003cp\u003eWhen running computationally intensive stuff, RStudio in the browser can sometimes cause problems. I often can\u0026rsquo;t get back into the session if it\u0026rsquo;s stuck running a script for hours, meaning I just have to trust that it\u0026rsquo;s working, which is awful.\u003c/p\u003e\n\u003cp\u003eInstead, I run long scripts in the background without using RStudio and monitor them using a log file.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eLog in to the remote server with \u003ccode\u003essh\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eFind the name or the ID of the Docker container that\u0026rsquo;s running RStudio by running \u003ccode\u003edocker ps\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eConnect to that container by running \u003ccode\u003edocker exec -it hash_of_container bash\u003c/code\u003e (like \u003ccode\u003efcab1f00f1d1\u003c/code\u003e) or \u003ccode\u003edocker exec -it name_of_container bash\u003c/code\u003e. You\u0026rsquo;re now inside the container.\u003c/li\u003e\n\u003cli\u003eNavigate to the script you want to run: \u003ccode\u003ecd home/rstudio/name_of_your_file.R\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eRun the script. There are a billion different ways to do this, like with \u003ccode\u003escreen\u003c/code\u003e or \u003ccode\u003etmux\u003c/code\u003e or \u003ccode\u003edtach\u003c/code\u003e. I find it easiest to use \u003ccode\u003enohup\u003c/code\u003e and redirect the output of the script to a log file. I run \u003ccode\u003enohup Rscript name_of_your_file.R \u0026gt; process_of_script.log 2\u0026gt;\u0026amp;1 \u0026amp;\u003c/code\u003e to send all output to \u003ccode\u003eprocess_of_script.log\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eMonitor the script periodically. You can do this in RStudio by logging in and opening the log file (and because the script is running in the background, there won\u0026rsquo;t be any problems restoring an RStudio session), or by typing \u003ccode\u003etail process_of_script.log\u003c/code\u003e from the terminal inside the container.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch2 id=\"making-a-custom-dockerfile\"\u003eMaking a custom Dockerfile\u003c/h2\u003e\n\u003cp\u003eThe \u003ca href=\"https://hub.docker.com/r/rocker/tidyverse/\"\u003ebase \u003ccode\u003erocker/tidyverse\u003c/code\u003e container\u003c/a\u003e has most of the packages I typically need for projects, but I also regularly use packages that it doesn\u0026rsquo;t have by default, like \u003ca href=\"https://rapporter.github.io/pander/\"\u003e\u003ccode\u003epander\u003c/code\u003e\u003c/a\u003e, \u003ca href=\"https://cran.r-project.org/web/packages/ggstance/index.html\"\u003e\u003ccode\u003eggstance\u003c/code\u003e\u003c/a\u003e, and \u003ca href=\"https://cran.r-project.org/web/packages/countrycode/index.html\"\u003e\u003ccode\u003ecountrycode\u003c/code\u003e\u003c/a\u003e.  Because containers come in a pristine state, you have to install all additional packages by hand in a new container, which is tedious and not reproducible.\u003c/p\u003e\n\u003cp\u003eTo fix this, you can create your own Dockerfile that is based on another Dockerfile. This is actually what all the rocker images do—they\u0026rsquo;re based on a  basic \u003ca href=\"https://hub.docker.com/r/rocker/rstudio/~/dockerfile/\"\u003e\u003ccode\u003erocker/r-base\u003c/code\u003e\u003c/a\u003e image and then add additional installation commands and directives (for instance, \u003ccode\u003erocker/tidyverse\u003c/code\u003e is based on \u003ccode\u003erocker/rstudio\u003c/code\u003e which is based on \u003ccode\u003erocker/r-base\u003c/code\u003e). If you make your own Dockerfile based on your favorite rocker image, you can host it as an automated build on Docker Hub and then pull it just like any other image.\u003c/p\u003e\n\u003cp\u003eMaking Dockerfiles is tricky and full of tons of options that are well covered elsewhere. Here are some examples I\u0026rsquo;ve made:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"https://hub.docker.com/r/andrewheiss/docker-example-r-environment/~/dockerfile/\"\u003e\u003cstrong\u003eSuper basic easy example\u003c/strong\u003e\u003c/a\u003e: This is \u003ccode\u003erocker/tidyverse\u003c/code\u003e with the CRAN versions of \u003ccode\u003epander\u003c/code\u003e, \u003ccode\u003estargazer\u003c/code\u003e, \u003ccode\u003ecountrycode\u003c/code\u003e, and \u003ccode\u003eWDI\u003c/code\u003e and the development version of \u003ccode\u003eggrepel\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://hub.docker.com/r/andrewheiss/tidyverse-rstanarm/~/dockerfile/\"\u003e\u003cstrong\u003e\u003ccode\u003etidyverse_rstanarm\u003c/code\u003e\u003c/strong\u003e\u003c/a\u003e: This installs Stan and \u003ccode\u003erstanarm\u003c/code\u003e in the \u003ccode\u003erocker/tidyverse\u003c/code\u003e image. Installing Stan from source is tricky and it took me hours to get the right incantation of commands, but it works!\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"https://hub.docker.com/r/andrewheiss/docker-donors-ngo-restrictions/~/dockerfile/\"\u003e\u003cstrong\u003e\u003ccode\u003edocker-donors-ngo-restrictions\u003c/code\u003e\u003c/strong\u003e\u003c/a\u003e: This is \u003ccode\u003etidyverse_rstanarm\u003c/code\u003e with all the packages needed for a \u003ca href=\"https://github.com/andrewheiss/donors-ngo-restrictions\"\u003especific project\u003c/a\u003e. It does fancy stuff like installing custom fonts and some Python packages.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eYou can host these custom Dockerfiles on GitHub and connect them to Docker Hub as automated builds. Every time you push to the GitHub repository, Docker Hub will automatically rebuild the image so when people run \u003ccode\u003edocker pull repository/name\u003c/code\u003e, they\u0026rsquo;ll get the latest version. Magic.\u003c/p\u003e\n",
            "date_published": "2017-04-27T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2016/12/08/save-base-graphics-as-pseudo-objects-in-r/",
            "url": "https://www.shagunjhaver.com/blog/2016/12/08/save-base-graphics-as-pseudo-objects-in-r/",
            "title": "Save base graphics as pseudo-objects in R",
            "summary": "Use pryr to save a series of R commands as a kind of macro you can call repeatedly.",
            "content_html": "\u003cp\u003e\u003cstrong\u003etl;dr:\u003c/strong\u003e Use \u003ccode\u003epryr::%\u0026lt;a-%\u003c/code\u003e to save a series of R commands as a kind of macro you can call repeatedly.\u003c/p\u003e\n\u003chr\u003e\n\u003ch2 id=\"saving-grid-based-plots-to-objects\"\u003eSaving grid-based plots to objects\u003c/h2\u003e\n\u003cp\u003eOne nice thing about ggplot (and grid graphics in general) is that you can save plots as objects and use them later in other functions like \u003ccode\u003egridExtra::grid.arrange()\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(gridExtra)\n\ndf \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edata_frame\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e, y\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e),\n                 z\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003esample\u003c/span\u003e(\u003cspan style=\"color:#66d9ef\"\u003eLETTERS\u003c/span\u003e[1\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e], \u003cspan style=\"color:#ae81ff\"\u003e100\u003c/span\u003e, replace\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e))\n\n\u003cspan style=\"color:#75715e\"\u003e# Scatterplot\u003c/span\u003e\np1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(df, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003ex, y\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003ey, color\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003ez)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeom_point\u003c/span\u003e()\n\n\u003cspan style=\"color:#75715e\"\u003e# Distribution\u003c/span\u003e\np2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(df, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003ey, fill\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003ez)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeom_density\u003c/span\u003e(alpha\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e)\n\n\u003cspan style=\"color:#75715e\"\u003e# Combine plots\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# arrangeGrob() is basically grid.arrange(), but allows you to save as an object\u003c/span\u003e\np.both \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003earrangeGrob\u003c/span\u003e(p1, p2)\ngrid\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003egrid.draw\u003c/span\u003e(p.both)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"ggplot-example-1.png\" alt=\"ggplot-example-1\"\u003e\u003c!-- --\u003e\u003c/p\u003e\n\u003cp\u003eThis is particularly useful when saving plots with \u003ccode\u003eggsave\u003c/code\u003e; you can simultaneously make PDF and PNG versions of your plots for use in LaTeX (PDF) or Word, PowerPoint, or HTML (PNG).\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003eggsave\u003c/span\u003e(p.both, filename\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;blah.pdf\u0026#34;\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003eggsave\u003c/span\u003e(p.both, filename\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;blah.png\u0026#34;\u003c/span\u003e)\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"saving-base-graphics-based-plots-to-objects\"\u003eSaving base graphics-based plots to objects\u003c/h2\u003e\n\u003cp\u003eHowever, saving base R graphics to objects for later reuse is a little trickier, since plots are built line-by-line into specific devices. One approach is to make plots on a null device, record the plot, and then display it later:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Save plot to an object using a null PDF device\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# http://stackoverflow.com/a/14742001/120898\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003epdf\u003c/span\u003e(\u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003edev.control\u003c/span\u003e(displaylist\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;enable\u0026#34;\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003eplot\u003c/span\u003e(df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ex, df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ey)\n\u003cspan style=\"color:#a6e22e\"\u003etext\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e40\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Random\u0026#34;\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003etext\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e60\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Text\u0026#34;\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003elines\u003c/span\u003e(stats\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003elowess\u003c/span\u003e(df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ex, df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ey))\np1.base \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erecordPlot\u003c/span\u003e()\n\u003cspan style=\"color:#a6e22e\"\u003einvisible\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003edev.off\u003c/span\u003e())\n\n\u003cspan style=\"color:#75715e\"\u003e# Display the saved plot\u003c/span\u003e\ngrid\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003egrid.newpage\u003c/span\u003e()\np1.base\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"recordplot-1.png\" alt=\"recordplot-1\"\u003e\u003c!-- --\u003e\u003c/p\u003e\n\u003cp\u003eOne advantage of this is that you can then reuse the plot object to simultaneously save a PDF and a PNG without recreating the plot:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003epdf\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;blah_base.pdf\u0026#34;\u003c/span\u003e)\np1.base\n\u003cspan style=\"color:#a6e22e\"\u003edev.off\u003c/span\u003e()\n\n\u003cspan style=\"color:#a6e22e\"\u003epng\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;blah_base.png\u0026#34;\u003c/span\u003e)\np1.base\n\u003cspan style=\"color:#a6e22e\"\u003edev.off\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThis is particularly helpful if you want to use nicer fonts or higher resolutions with Cairo:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003ecairo_pdf\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;blah_base.pdf\u0026#34;\u003c/span\u003e,\n          width\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e8\u003c/span\u003e, height\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e3.5\u003c/span\u003e, family\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Comic Sans\u0026#34;\u003c/span\u003e)\np1.base\n\u003cspan style=\"color:#a6e22e\"\u003edev.off\u003c/span\u003e()\n\n\u003cspan style=\"color:#a6e22e\"\u003epng\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;blah_base.png\u0026#34;\u003c/span\u003e, \n    width\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e8\u003c/span\u003e, height\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e3.5\u003c/span\u003e, family\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Comic Sans\u0026#34;\u003c/span\u003e, \n    bg\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;white\u0026#34;\u003c/span\u003e, units\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;in\u0026#34;\u003c/span\u003e, res\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e300\u003c/span\u003e, type\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;cairo\u0026#34;\u003c/span\u003e)\np1.base\n\u003cspan style=\"color:#a6e22e\"\u003edev.off\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThere are situations, though, where recorded base graphics plot are clunky and don\u0026rsquo;t work well, since the plots have device information embedded in them. Rearranging saved plots with \u003ccode\u003epar(mfrow()\u003c/code\u003e, \u003ccode\u003elayout()\u003c/code\u003e or \u003ca href=\"http://seananderson.ca/courses/11-multipanel/multipanel.pdf\"\u003eother multipanel techniques\u003c/a\u003e can be tricky. Saved plots that make heavy modifications to \u003ccode\u003epar()\u003c/code\u003e (like Sankey diagrams created from the \u003ca href=\"https://cran.r-project.org/web/packages/riverplot/index.html\"\u003eriverplot package\u003c/a\u003e) can also be unwieldy when laying out with multiple base graphics plots. It seems that the best way to use multipanel techniques with base R is to use the actual plot commands rather than inserting recorded plots. Which means that if you want to simultaneously output a PNG and a PDF, you have to repeat the code twice, which is awful.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"show-split-1.png\" alt=\"show-split-1\"\u003e\u003c!-- --\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003epdf\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;blah.pdf\u0026#34;\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003esplit.screen\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e))\n\n\u003cspan style=\"color:#a6e22e\"\u003escreen\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003eplot\u003c/span\u003e(df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ex, df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ey)\n\u003cspan style=\"color:#a6e22e\"\u003etext\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e40\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Random\u0026#34;\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003etext\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e60\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Text\u0026#34;\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003elines\u003c/span\u003e(stats\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003elowess\u003c/span\u003e(df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ex, df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ey))\n\n\u003cspan style=\"color:#a6e22e\"\u003escreen\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003eplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003edensity\u003c/span\u003e(df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ey))\n\n\u003cspan style=\"color:#a6e22e\"\u003eclose.screen\u003c/span\u003e(all\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e) \n\u003cspan style=\"color:#a6e22e\"\u003edev.off\u003c/span\u003e()\n\n\u003cspan style=\"color:#75715e\"\u003e# Once more, with feeling\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003epng\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;blah.png\u0026#34;\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003esplit.screen\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e))\n\n\u003cspan style=\"color:#a6e22e\"\u003escreen\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003eplot\u003c/span\u003e(df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ex, df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ey)\n\u003cspan style=\"color:#a6e22e\"\u003etext\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e40\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Random\u0026#34;\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003etext\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e60\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Text\u0026#34;\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003elines\u003c/span\u003e(stats\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003elowess\u003c/span\u003e(df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ex, df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ey))\n\n\u003cspan style=\"color:#a6e22e\"\u003escreen\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e)\n\u003cspan style=\"color:#a6e22e\"\u003eplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003edensity\u003c/span\u003e(df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ey))\n\n\u003cspan style=\"color:#a6e22e\"\u003eclose.screen\u003c/span\u003e(all\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e) \n\u003cspan style=\"color:#a6e22e\"\u003edev.off\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"a-solution-active-bindings-in-pryr\"\u003eA solution: active bindings in \u003ccode\u003epryr\u003c/code\u003e\u003c/h2\u003e\n\u003cp\u003eInstead of recording a plot and saving all its device-specific settings, you can use the \u003ccode\u003e%\u0026lt;a-%\u003c/code\u003e function in \u003ca href=\"https://github.com/hadley/pryr\"\u003eHadley Wickham\u0026rsquo;s \u003ccode\u003epryr\u003c/code\u003e\u003c/a\u003e package to essentially \u003ca href=\"https://stackoverflow.com/questions/29583849/r-saving-a-plot-in-an-object\"\u003esave a chunk of R code as an object that can then be re-run later\u003c/a\u003e, almost like a macro.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(pryr)\n\np1.pryr \u003cspan style=\"color:#f92672\"\u003e%\u0026lt;a-%\u003c/span\u003e {\n  \u003cspan style=\"color:#a6e22e\"\u003eplot\u003c/span\u003e(df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ex, df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ey)\n  \u003cspan style=\"color:#a6e22e\"\u003etext\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e40\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Random\u0026#34;\u003c/span\u003e)\n  \u003cspan style=\"color:#a6e22e\"\u003etext\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e60\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Text\u0026#34;\u003c/span\u003e)\n  \u003cspan style=\"color:#a6e22e\"\u003elines\u003c/span\u003e(stats\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003elowess\u003c/span\u003e(df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ex, df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ey))\n}\n\np2.pryr \u003cspan style=\"color:#f92672\"\u003e%\u0026lt;a-%\u003c/span\u003e {\n  \u003cspan style=\"color:#a6e22e\"\u003eplot\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003edensity\u003c/span\u003e(df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ey))\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eEvery time \u003ccode\u003ep1.pryr\u003c/code\u003e is called from now on, R will run everything assinged to it in \u003ccode\u003e{}\u003c/code\u003e. The plot itself is not saved as an object—rather, the code that generates the plot is saved as an object.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ep1.pryr\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"pryr-show-1.png\" alt=\"pryr-show-1\"\u003e\u003c!-- --\u003e\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ep2.pryr\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"pryr-show-2.png\" alt=\"pryr-show-2\"\u003e\u003c!-- --\u003e\u003c/p\u003e\n\u003cp\u003eIncluding these plots in a multipanel layout is trivial:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003esplit.screen\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e))\n\n\u003cspan style=\"color:#a6e22e\"\u003escreen\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)\np1.pryr\n\n\u003cspan style=\"color:#a6e22e\"\u003escreen\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e)\np2.pryr\n\n\u003cspan style=\"color:#a6e22e\"\u003eclose.screen\u003c/span\u003e(all\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e) \n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"pryr-multipanel-1.png\" alt=\"pryr-multipanel-1\"\u003e\u003c!-- --\u003e\u003c/p\u003e\n\u003cp\u003eSaving these plots as PDFs and PNGs is the same as saving recorded plots:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003epdf\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;blah_base_pryr.pdf\u0026#34;\u003c/span\u003e)\np1.pryr\n\u003cspan style=\"color:#a6e22e\"\u003edev.off\u003c/span\u003e()\n\n\u003cspan style=\"color:#a6e22e\"\u003epng\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;blah_base_pryr.png\u0026#34;\u003c/span\u003e)\np1.pryr\n\u003cspan style=\"color:#a6e22e\"\u003edev.off\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eBut even better is saving multipanel plots as PDFs and PNGs. Save the whole multipanel plot code as an actively bound object and then wrap it in \u003ccode\u003epdf()\u003c/code\u003e or \u003ccode\u003epng()\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003ep.both.pryr \u003cspan style=\"color:#f92672\"\u003e%\u0026lt;a-%\u003c/span\u003e {\n  \u003cspan style=\"color:#a6e22e\"\u003esplit.screen\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e))\n\n  \u003cspan style=\"color:#a6e22e\"\u003escreen\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)\n  p1.pryr\n  \n  \u003cspan style=\"color:#a6e22e\"\u003escreen\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e)\n  p2.pryr\n  \n  \u003cspan style=\"color:#a6e22e\"\u003eclose.screen\u003c/span\u003e(all\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e)\n}\n\n\u003cspan style=\"color:#a6e22e\"\u003epdf\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;blah_base_both_pryr.pdf\u0026#34;\u003c/span\u003e)\np.both.pryr\n\u003cspan style=\"color:#a6e22e\"\u003edev.off\u003c/span\u003e()\n\n\u003cspan style=\"color:#a6e22e\"\u003epng\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;blah_base_both_pryr.png\u0026#34;\u003c/span\u003e)\np.both.pryr\n\u003cspan style=\"color:#a6e22e\"\u003edev.off\u003c/span\u003e()\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAgain, actively bound objects are \u003cem\u003enot\u003c/em\u003e the objects themselves, but an expression that gets run every time the object is accessed. It is far easier to deal with saved base graphics as code instead of as recorded plots, since there is no inherent device information to contend with.\u003c/p\u003e\n\u003cp\u003eIn the end, it\u0026rsquo;s easiest to save grid-based graphics to objects, since they\u0026rsquo;re designed to do that. But you can fake it with base graphics using \u003ccode\u003epryr\u003c/code\u003e.\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003eOne quick real-world use case. As mentioned, Sankey diagrams from \u003ca href=\"https://cran.r-project.org/web/packages/riverplot/index.html\"\u003eriverplot package\u003c/a\u003e override all graphical parameters and can\u0026rsquo;t be easily plotted in multipanel layouts if you record them with \u003ccode\u003erecordPlot()\u003c/code\u003e. With \u003ccode\u003epryr\u003c/code\u003e, though, it\u0026rsquo;s easy.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(riverplot)\n\nx \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eriverplot.example\u003c/span\u003e()\n\nriverplot.saved \u003cspan style=\"color:#f92672\"\u003e%\u0026lt;a-%\u003c/span\u003e {\n  \u003cspan style=\"color:#a6e22e\"\u003eplot\u003c/span\u003e(x)\n  \u003cspan style=\"color:#a6e22e\"\u003etext\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Some text\\n\u0026#34;\u003c/span\u003e, adj\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.5\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e-0.5\u003c/span\u003e), font\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e)\n  \u003cspan style=\"color:#a6e22e\"\u003epoints\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003erep\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e), pch\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e19\u003c/span\u003e)\n}\n\np.both.river \u003cspan style=\"color:#f92672\"\u003e%\u0026lt;a-%\u003c/span\u003e {\n  \u003cspan style=\"color:#a6e22e\"\u003esplit.screen\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e))\n\n  \u003cspan style=\"color:#a6e22e\"\u003escreen\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)\n  riverplot.saved\n  \n  \u003cspan style=\"color:#a6e22e\"\u003escreen\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e)\n  \u003cspan style=\"color:#a6e22e\"\u003eplot\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)\n  \n  \u003cspan style=\"color:#a6e22e\"\u003eclose.screen\u003c/span\u003e(all\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e)\n}\n\np.both.river\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003e\u003cimg src=\"riverplot-example-1.png\" alt=\"riverplot-example-1\"\u003e\u003c!-- --\u003e\u003c/p\u003e\n",
            "date_published": "2016-12-08T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2016/04/25/convert-logistic-regression-standard-errors-to-odds-ratios-with-r/",
            "url": "https://www.shagunjhaver.com/blog/2016/04/25/convert-logistic-regression-standard-errors-to-odds-ratios-with-r/",
            "title": "Convert logistic regression standard errors to odds ratios with R",
            "summary": "Correctly transform logistic regression standard errors to odds ratios using R",
            "content_html": "\u003cp\u003eConverting logistic regression coefficients and standard errors into odds ratios is trivial in Stata: just add \u003ccode\u003e, or\u003c/code\u003e to the end of a \u003ccode\u003elogit\u003c/code\u003e command:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e. use \u0026#34;http://www.ats.ucla.edu/stat/data/hsbdemo\u0026#34;, clear\n\n. logit honors i.female math read, or\n\nLogistic regression                             Number of obs     =        200\n                                                LR chi2(3)        =      80.87\n                                                Prob \u0026gt; chi2       =     0.0000\nLog likelihood = -75.209827                     Pseudo R2         =     0.3496\n\n------------------------------------------------------------------------------\n      honors | Odds Ratio   Std. Err.      z    P\u0026gt;|z|     [95% Conf. Interval]\n-------------+----------------------------------------------------------------\n      female |\n     female  |   3.173393   1.377573     2.66   0.008      1.35524    7.430728\n        math |   1.140779   .0370323     4.06   0.000     1.070458     1.21572\n        read |   1.078145    .029733     2.73   0.006     1.021417    1.138025\n       _cons |   1.99e-06   3.68e-06    -7.09   0.000     5.29e-08    .0000749\n------------------------------------------------------------------------------\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eDoing the same thing in R is a little trickier. Calculating odds ratios for \u003cem\u003ecoefficients\u003c/em\u003e is trivial, and \u003ccode\u003eexp(coef(model))\u003c/code\u003e gives the same results as Stata:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"color:#75715e\"\u003e# Load libraries\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(dplyr)  \u003cspan style=\"color:#75715e\"\u003e# Data frame manipulation\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(readr)  \u003cspan style=\"color:#75715e\"\u003e# Read CSVs nicely\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(broom)  \u003cspan style=\"color:#75715e\"\u003e# Convert models to data frames\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Use treatment contrasts instead of polynomial contrasts for ordered factors\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eoptions\u003c/span\u003e(contrasts\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003erep\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;contr.treatment\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e))\n\n\u003cspan style=\"color:#75715e\"\u003e# Load and clean data\u003c/span\u003e\ndf \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eread_csv\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;http://www.ats.ucla.edu/stat/data/hsbdemo.csv\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(honors \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efactor\u003c/span\u003e(honors, levels\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;not enrolled\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;enrolled\u0026#34;\u003c/span\u003e)),\n         female \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efactor\u003c/span\u003e(female, levels\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;male\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;female\u0026#34;\u003c/span\u003e), ordered\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e))\n\n\u003cspan style=\"color:#75715e\"\u003e# Run model\u003c/span\u003e\nmodel \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eglm\u003c/span\u003e(honors \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e female \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e math \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e read, data\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003edf, family\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003ebinomial\u003c/span\u003e(link\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;logit\u0026#34;\u003c/span\u003e))\n\u003cspan style=\"color:#a6e22e\"\u003esummary\u003c/span\u003e(model)\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; Call:\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; glm(formula = honors ~ female + math + read, family = binomial(link = \u0026#34;logit\u0026#34;), \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;     data = df)\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; Deviance Residuals:\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;     Min       1Q   Median       3Q      Max  \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; -2.0055  -0.6061  -0.2730   0.4844   2.3953  \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; Coefficients:\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;               Estimate Std. Error z value Pr(\u0026gt;|z|)    \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; (Intercept)  -13.12749    1.85080  -7.093 1.31e-12 ***\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; femalefemale   1.15480    0.43409   2.660  0.00781 ** \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; math           0.13171    0.03246   4.058 4.96e-05 ***\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; read           0.07524    0.02758   2.728  0.00636 ** \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; ---\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; Signif. codes:  0 \u0026#39;***\u0026#39; 0.001 \u0026#39;**\u0026#39; 0.01 \u0026#39;*\u0026#39; 0.05 \u0026#39;.\u0026#39; 0.1 \u0026#39; \u0026#39; 1\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; (Dispersion parameter for binomial family taken to be 1)\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;     Null deviance: 231.29  on 199  degrees of freedom\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; Residual deviance: 150.42  on 196  degrees of freedom\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; AIC: 158.42\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; Number of Fisher Scoring iterations: 5\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Exponentiate coefficients\u003c/span\u003e\n\u003cspan style=\"color:#a6e22e\"\u003eexp\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ecoef\u003c/span\u003e(model))\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;  (Intercept) femalefemale         math         read \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; 1.989771e-06 3.173393e+00 1.140779e+00 1.078145e+00\u003c/span\u003e\n\n\u003cspan style=\"color:#75715e\"\u003e# Exponentiate standard errors\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# WRONG\u003c/span\u003e\nses \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ediag\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003evcov\u003c/span\u003e(model)))\n\u003cspan style=\"color:#a6e22e\"\u003eexp\u003c/span\u003e(ses)\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;  (Intercept) femalefemale         math         read \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;     6.364894     1.543557     1.032994     1.027961\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eCalculating the odds-ratio adjusted \u003cem\u003estandard errors\u003c/em\u003e is less trivial—\u003ccode\u003eexp(ses)\u003c/code\u003e does not work. This is because of the underlying math behind logistic regression (and all other models that use odds ratios, hazard ratios, etc.). Instead of exponentiating, the standard errors have to be calculated with calculus (Taylor series) or simulation (bootstrapping). Stata uses the \u003ca href=\"https://www.stata.com/support/faqs/statistics/delta-rule/\"\u003eTaylor series-based delta method\u003c/a\u003e, which is \u003ca href=\"http://www.ats.ucla.edu/stat/r/faq/deltamethod.htm\"\u003efairly easy to implement in R\u003c/a\u003e (see Example 2).\u003c/p\u003e\n\u003cp\u003eEssentially, you can calculate the odds ratio-adjusted standard error with $\\sqrt{\\text{gradient} \\times \\text{coefficient variance} \\times \\text{gradient}}$, and since the first derivative/gradient of $e^x$ is just $e^x$, in this case the adjusted standard error is simply $\\sqrt{e^{\\text{coefficient}} \\times \\text{coefficient variance} \\times e^{\\text{coefficient}}}$ or $\\sqrt{(e^{\\text{coefficient}})^2 \\times \\text{coefficient variance}}$\u003c/p\u003e\n\u003cp\u003eDoing this in R is easy, especially with \u003ca href=\"https://github.com/dgrtwo/broom\"\u003e\u003ccode\u003ebroom::tidy()\u003c/code\u003e\u003c/a\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003emodel.df \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model)  \u003cspan style=\"color:#75715e\"\u003e# Convert model to dataframe for easy manipulation\u003c/span\u003e\nmodel.df\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;           term     estimate  std.error statistic      p.value\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; 1  (Intercept) -13.12749111 1.85079765 -7.092883 1.313465e-12\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; 2 femalefemale   1.15480121 0.43408932  2.660285 7.807461e-03\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; 3         math   0.13171175 0.03246105  4.057532 4.959406e-05\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; 4         read   0.07524236 0.02757725  2.728422 6.363817e-03\u003c/span\u003e\n\nmodel.df \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(or \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eexp\u003c/span\u003e(estimate),  \u003cspan style=\"color:#75715e\"\u003e# Odds ratio/gradient\u003c/span\u003e\n         var.diag \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ediag\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003evcov\u003c/span\u003e(model)),  \u003cspan style=\"color:#75715e\"\u003e# Variance of each coefficient\u003c/span\u003e\n         or.se \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(or^2 \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e var.diag))  \u003cspan style=\"color:#75715e\"\u003e# Odds-ratio adjusted \u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;           term     estimate  std.error statistic      p.value           or\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; 1  (Intercept) -13.12749111 1.85079765 -7.092883 1.313465e-12 1.989771e-06\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; 2 femalefemale   1.15480121 0.43408932  2.660285 7.807461e-03 3.173393e+00\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; 3         math   0.13171175 0.03246105  4.057532 4.959406e-05 1.140779e+00\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; 4         read   0.07524236 0.02757725  2.728422 6.363817e-03 1.078145e+00\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt;       var.diag        or.se\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; 1 3.4254519469 3.682663e-06\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; 2 0.1884335381 1.377536e+00\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; 3 0.0010537198 3.703090e-02\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; 4 0.0007605045 2.973228e-02\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThis can all be wrapped up into a simple function:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003eget.or.se \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(model) {\n  broom\u003cspan style=\"color:#f92672\"\u003e::\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n    \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(or \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eexp\u003c/span\u003e(estimate),\n           var.diag \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ediag\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003evcov\u003c/span\u003e(model)),\n           or.se \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(or^2 \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e var.diag)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n    \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(or.se) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e unlist \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e unname\n}\n\n\u003cspan style=\"color:#a6e22e\"\u003eget.or.se\u003c/span\u003e(model)\n\u003cspan style=\"color:#75715e\"\u003e#\u0026gt; [1] 3.682663e-06 1.377536e+00 3.703090e-02 2.973228e-02\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eSame results in both programs!\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"same.gif\" alt=\"Same!\" title=\"Same!\"\u003e\u003c/p\u003e\n",
            "date_published": "2016-04-25T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2016/04/03/drone-sightings-in-the-us-visualized/",
            "url": "https://www.shagunjhaver.com/blog/2016/04/03/drone-sightings-in-the-us-visualized/",
            "title": "Drone sightings in the US, visualized",
            "summary": "See where the FAA has reported hobbyist drone sightings from 2014–2016",
            "content_html": "\u003cp\u003eFor my first entry into \u003ca href=\"https://rud.is/b/2016/03/30/introducing-a-weekly-r-python-js-etc-vis-challenge/\"\u003e@hrbrmstr\u0026rsquo;s new weekly data visualization challenge\u003c/a\u003e, I made two plots related to the \u003ca href=\"https://www.faa.gov/uas/resources/public_records/uas_sightings_report/\"\u003edataset of unmanned aircraft (UAS) sightings\u003c/a\u003e. The \u003ca href=\"https://github.com/andrewheiss/2016-13/tree/master/andrewheiss\"\u003eR code for these plots is on GitHub\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eFirst, I was interested in the type of drones being spotted. When I think of drones, I typically think of the ones the CIA and Air Force have flying over Yemen, Somalia, Afghanistan, and Pakistan shooting at suspected ISIS and Al-Qaeda members. To see if that\u0026rsquo;s the case with these UAS sightings, I mapped out all US-based Air Force bases and all drone sightings, assuming that any military drone sightings would happen near bases.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"drones_af_map.png\" alt=\"UAS sightings and Air Force bases\"\u003e\u003c/p\u003e\n\u003cp\u003eWhile some sightings do occur near bases (like in Eastern Washington, Eastern Colorado, and Nebraska, for example), most don\u0026rsquo;t. In fact, in Texas, there are almost no UAS sightings near Air Force bases. Thus, even though there are \u003ca href=\"http://www.engadget.com/2016/03/09/pentagon-deployed-drones-in-us/\"\u003edocumented cases of military drones being used in the US\u003c/a\u003e, these sightings are most definitely not military drones (unless they\u0026rsquo;re all drones coming from unmapped CIA bases). They\u0026rsquo;re quadrocopters and other hobbyist drones.\u003c/p\u003e\n\u003cp\u003eI noticed that in some cases (like Salt Lake City, Las Vegas, and Phoenix), almost all sightings were clustered around Air Force bases. However, this is not because the military is spying on everyone in the west, but because that\u0026rsquo;s where everyone lives—very few hobbyist drone operators live in the Utah, Nevada, or Arizona deserts. Drone sightings (both the number of sightings and their location) might just be a function of state population.\u003c/p\u003e\n\u003cp\u003eFor my second plot, I looked at the relationship between drone sightings and state population to see if there are states that see more drones than normal. The results were surprising.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"drones_states.png\" alt=\"Drone sightings per capita\"\u003e\u003c/p\u003e\n\u003cp\u003eWhile more populous states like New York, California, Florida, and Texas predictably see more drones (since there are likely more hobbyists), Washington, DC by far sees the most drone activity per capita. Maybe everyone there really is just trying to spy on Congress and the \u003ca href=\"http://www.cnn.com/2015/05/14/politics/white-house-drone-arrest/\"\u003ePresident\u003c/a\u003e, even though \u003ca href=\"http://www.usatoday.com/story/news/2015/10/09/drone-crash-white-house-ellipse-us-park-police-federal-aviation-administration/73641812/\"\u003edrones are ostensibly banned in DC\u003c/a\u003e.\u003c/p\u003e\n",
            "date_published": "2016-04-03T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2016/02/11/fauxcasts/",
            "url": "https://www.shagunjhaver.com/blog/2016/02/11/fauxcasts/",
            "title": "Fauxcasts: Use a podcast app to listen to audiobooks",
            "summary": "Create a temporary podcast feed of a CD-based audiobook and use a modern podcast app to listen to the book faster and better.",
            "content_html": "\u003cp\u003eOur public library has a huge collection of books on CD, including a bunch of \u003ca href=\"https://en.wikipedia.org/wiki/Arkangel_Shakespeare\"\u003ewell dramatized versions of Shakespeare plays\u003c/a\u003e that I\u0026rsquo;ve always meant to read. However, out of all the music-listening devices I own, only two have optical drives: the ancient Mac Mini we use for our media center and our minivan. It\u0026rsquo;s trivial to rip the audiobooks to MP3 on the Mac Mini, but I\u0026rsquo;ve never been completely happy with the options for listening to them.\u003c/p\u003e\n\u003cp\u003eI listen to to pretty much all spoken word media on my iPhone or iPad through either \u003ca href=\"https://overcast.fm/\"\u003eOvercast\u003c/a\u003e (for podcasts) or the \u003ca href=\"https://www.audible.com/sw\"\u003eAudible app\u003c/a\u003e (for audiobooks). Both of these apps allow for faster playback (up to 2.5 or 3x), and Overcast uses the fantastic Smart Speed feature to cut out the silence in between sentences.\u003csup id=\"fnref:1\"\u003e\u003ca href=\"#fn:1\" class=\"footnote-ref\" role=\"doc-noteref\"\u003e1\u003c/a\u003e\u003c/sup\u003e Apple\u0026rsquo;s native Music app has none of these extra features, which means I have to listen to CD-based audiobooks at 1x speed like a caveman.\u003c/p\u003e\n\u003cp\u003eIn a perfect world I\u0026rsquo;d be able fly through these CD-based audiobooks in Overcast.\u003c/p\u003e\n\u003cp\u003eBehold that perfect world: \u003ca href=\"https://github.com/andrewheiss/fauxcasts\"\u003eFauxcasts\u003c/a\u003e. I wrote up a little script that generates a podcast RSS feed from a folder of MP3 files. After running the script, I just have to upload the folder and feed to a server, subscribe to my fake podcast, and listen away.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"fauxcast.png\" alt=\"Macbeth as a podcast\"\u003e\u003c/p\u003e\n\u003cp\u003eGet \u003ca href=\"https://github.com/andrewheiss/fauxcasts\"\u003eFauxcasts from GitHub\u003c/a\u003e and make your own temporary podcasts.\u003c/p\u003e\n\u003csection class=\"footnotes\" role=\"doc-endnotes\"\u003e\n\u003chr\u003e\n\u003col\u003e\n\u003cli id=\"fn:1\" role=\"doc-endnote\"\u003e\n\u003cp\u003eSince Overcast came out in July 2014, Smart Speed has saved me an extra 42 hours beyond speed adjustments, which is kind of ridiculously awesome.\u0026#160;\u003ca href=\"#fnref:1\" class=\"footnote-backref\" role=\"doc-backlink\"\u003e\u0026#x21a9;\u0026#xfe0e;\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/section\u003e\n",
            "date_published": "2016-02-11T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2016/02/10/libreoffice-base-sqlite-odbc-osx/",
            "url": "https://www.shagunjhaver.com/blog/2016/02/10/libreoffice-base-sqlite-odbc-osx/",
            "title": "Use LibreOffice Base as a GUI for an SQLite database in OS X",
            "summary": "Connect LibreOffice to an SQLite database to take advantage of SQLite’s ubiquitousness and LibreOffice’s form-based GUI.",
            "content_html": "\u003ch2 id=\"the-problem\"\u003eThe problem\u003c/h2\u003e\n\u003cp\u003eAs I conduct interviews for my dissertation research, I\u0026rsquo;ve been trying to figure out an open source database for storing interview notes and keeping track of the people and organizations I\u0026rsquo;m talking to. My ideal requirements are simple:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eThe format should be open source.\u003c/li\u003e\n\u003cli\u003eThe format should be portable and not require an underlying server (sorry MongoDB and MySQL)—this way I can save the file in an encrypted file container for IRB data protection purposes.\u003c/li\u003e\n\u003cli\u003eThe format should be easy to access with multiple languages (especially R and Python), ideally without external dependencies like Java.\u003c/li\u003e\n\u003cli\u003eThe format should be compatible with some sort of Microsoft Access-esque form GUI to allow for easy data insertion.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eHowever, finding the right combination of programs and formats has been slightly more difficult. \u003ca href=\"https://sqlite.org/\"\u003eSQLite\u003c/a\u003e is the best format, given that it\u0026rsquo;s the \u003ca href=\"https://sqlite.org/mostdeployed.html\"\u003emost widely deployed and used database engine\u003c/a\u003e \u003cem\u003eand\u003c/em\u003e is open source \u003cem\u003eand\u003c/em\u003e has native support in both \u003ca href=\"https://cran.r-project.org/web/packages/dplyr/\"\u003eR\u003c/a\u003e\u003csup id=\"fnref:1\"\u003e\u003ca href=\"#fn:1\" class=\"footnote-ref\" role=\"doc-noteref\"\u003e1\u003c/a\u003e\u003c/sup\u003e and \u003ca href=\"https://docs.python.org/3/library/sqlite3.html\"\u003ePython\u003c/a\u003e. The only thing it lacks is a nice form-based GUI front end.\u003c/p\u003e\n\u003cp\u003eThere are \u003ca href=\"http://sqlitebrowser.org/\"\u003eplenty\u003c/a\u003e of \u003ca href=\"https://www.sqlitepro.com/\"\u003eSQLite\u003c/a\u003e \u003ca href=\"https://addons.mozilla.org/en-US/firefox/addon/sqlite-manager-webext/\"\u003eviewers\u003c/a\u003e, but I haven\u0026rsquo;t found any that let you create Access-like forms. I could use Python to program my own GUI (or even get fancy and learn Swift and make a native Cocoa app), but that seems like an excessive amount of work.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"https://www.libreoffice.org/discover/base/\"\u003eLibreOffice Base\u003c/a\u003e has excellent support for database-backed forms, but under the hood, LibreOffice uses the Java-based \u003ca href=\"http://hsqldb.org/\"\u003eHSQLDB\u003c/a\u003e, which does not have native R and Python support and requires older Java runtime environments.\u003c/p\u003e\n\u003ch2 id=\"the-solution\"\u003eThe solution\u003c/h2\u003e\n\u003cp\u003eFortunately there\u0026rsquo;s a way to use an SQLite database as the backend for LibreOffice Base using an ODBC driver, giving the best of both worlds: an open, universal, Java-free database behind a customizable form-based GUI.\u003c/p\u003e\n\u003cp\u003eThere are \u003ca href=\"https://wiki.openoffice.org/wiki/Documentation/How_Tos/Using_SQLite_With_OpenOffice.org\"\u003eofficial instructions for doing this on Linux and Windows\u003c/a\u003e, but there\u0026rsquo;s nothing about doing it in OS X. So here\u0026rsquo;s that missing tutorial.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eSQLite is already installed on OS X. Create a new SQLite database using \u003ccode\u003esqlite3\u003c/code\u003e in Terminal (or even easier, use a \u003ca href=\"http://sqlitebrowser.org/\"\u003eGUI\u003c/a\u003e \u003ca href=\"https://www.sqlitepro.com/\"\u003eprogram\u003c/a\u003e). Add some tables to it, or don\u0026rsquo;t—it doesn\u0026rsquo;t matter. You just some sort of database file.\u003c/li\u003e\n\u003cli\u003eDownload the \u003ca href=\"http://www.ch-werner.de/sqliteodbc/\"\u003eSQLite ODBC driver\u003c/a\u003e for OS X. The page includes a link to a precompiled version (\u003cem\u003ecurrently it says \u0026ldquo;Steve Palm kindly provided a build of version 0.9993 for MacOSX 10.{6,7,8,9,10,11} on Intel as installer package (sqliteodbc-0.9993.dmg)\u0026quot;\u003c/em\u003e). Install the driver by opening \u003ccode\u003esqliteodbc-0.9993.pkg\u003c/code\u003e.\u003c/li\u003e\n\u003cli\u003eDownload an ODBC manager app. Prior to OS X 10.5, Apple included one of these, but for whatever reason they stopped with Snow Leopard. There are two that work equally well: \u003ca href=\"http://www.odbcmanager.net/index.php\"\u003eODBC Manager\u003c/a\u003e and \u003ca href=\"http://www.iodbc.org/dataspace/iodbc/wiki/iODBC/Downloads\"\u003eiODBC Administrator\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003eOpen the ODBC manager/administrator app. Add a new driver using these settings:\n\u003cimg src=\"driver_setup.png\" alt=\"Driver setup dialog\" title=\"Driver setup dialog\"\u003e\u003c/li\u003e\n\u003cli\u003eAdd a new User DSN (Data Source Name). Create a new key named \u0026ldquo;database\u0026rdquo; and use the full absolute path to the SQLite database file as the value:\n\u003cimg src=\"dsn_setup.png\" alt=\"DSN setup dialog\" title=\"DSN setup dialog\"\u003e\u003c/li\u003e\n\u003cli\u003eQuit the ODBC manager. The SQLite file is now accessible in any program that uses ODBC.\u003c/li\u003e\n\u003cli\u003eOpen LibreOffice and create a new Base database. In the wizard, select \u0026ldquo;Connect to an existing database\u0026rdquo; and choose \u0026ldquo;ODBC\u0026rdquo;:\n\u003cimg src=\"base_wizard.png\" alt=\"LibreOffice Base wizard\" title=\"LibreOffice Base wizard\"\u003e\u003c/li\u003e\n\u003cli\u003eClick next to select which ODBC database to load. If you click on \u0026ldquo;Browse…\u0026rdquo;, you should see the name of the SQLite database you set up as a DSN earlier.\u003c/li\u003e\n\u003cli\u003eClick on \u0026ldquo;Finish.\u0026rdquo; LibreOffice will prompt you to save an \u003ccode\u003e.odf\u003c/code\u003e database. This is fine—it\u0026rsquo;s not actually saving the database, just the accompanying form data.\u003csup id=\"fnref:2\"\u003e\u003ca href=\"#fn:2\" class=\"footnote-ref\" role=\"doc-noteref\"\u003e2\u003c/a\u003e\u003c/sup\u003e\u003c/li\u003e\n\u003cli\u003eCreate new tables and forms using LibreOffice:\n\u003cimg src=\"ugly_form.png\" alt=\"Super ugly example form\" title=\"Super ugly example form\"\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eAny time you save, all edits will occur on the SQLite file. Create a table, insert some records, and open the SQLite file in a GUI program to see all the changes. Magic!\u003c/p\u003e\n\u003cp\u003eEven though there are 10 steps, it\u0026rsquo;s not too difficult. tl;dr version: (1) install an SQLite ODBC driver, (2) install an ODBC manager, (3) use the manager to configure the SQLite ODBC driver and connect to an existing SQLite database, and (4) connect to the SQLite database through ODBC with LibreOffice Base.\u003c/p\u003e\n\u003cp\u003ePerfect!\u003c/p\u003e\n\u003csection class=\"footnotes\" role=\"doc-endnotes\"\u003e\n\u003chr\u003e\n\u003col\u003e\n\u003cli id=\"fn:1\" role=\"doc-endnote\"\u003e\n\u003cp\u003eTechnically RSQLite is a separate package, but it\u0026rsquo;s a dependency of \u003ca href=\"https://cran.r-project.org/web/packages/dplyr/index.html\"\u003edplyr\u003c/a\u003e, which is as important as base R in my book.\u0026#160;\u003ca href=\"#fnref:1\" class=\"footnote-backref\" role=\"doc-backlink\"\u003e\u0026#x21a9;\u0026#xfe0e;\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli id=\"fn:2\" role=\"doc-endnote\"\u003e\n\u003cp\u003eI think… I haven\u0026rsquo;t actually checked or tested this.\u0026#160;\u003ca href=\"#fnref:2\" class=\"footnote-backref\" role=\"doc-backlink\"\u003e\u0026#x21a9;\u0026#xfe0e;\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/section\u003e\n",
            "date_published": "2016-02-10T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2013/05/28/toggle-bluetooth-menu-applescript/",
            "url": "https://www.shagunjhaver.com/blog/2013/05/28/toggle-bluetooth-menu-applescript/",
            "title": "Toggle the Bluetooth menu item with AppleScript",
            "summary": "The OS X Bluetooth menu item re-enables itself every time a device battery gets low. This simple application turns it back off.",
            "content_html": "\u003cp\u003eI like to keep my menubar as uncluttered as possible, so I keep as many items hidden as possible—especially system programs like Time Machine, the displays menu, or the volume menu.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"menubar.png\" alt=\"Clean menu bar\"\u003e\u003c/p\u003e\n\u003cp\u003eI also keep the Bluetooth menu turned off. However, when the battery runs low on either my keyboard or mouse, the Bluetooth menu item comes back, and it doesn\u0026rsquo;t turn back off after the batteries get replaced. The only way to turn it off is to go to the Bluetooth panel in System Preferences and disable the menu item manually. It\u0026rsquo;s a tiny chore, but a chore nonetheless. One that can be automated!\u003csup id=\"fnref:1\"\u003e\u003ca href=\"#fn:1\" class=\"footnote-ref\" role=\"doc-noteref\"\u003e1\u003c/a\u003e\u003c/sup\u003e\u003csup id=\"fnref:2\"\u003e\u003ca href=\"#fn:2\" class=\"footnote-ref\" role=\"doc-noteref\"\u003e2\u003c/a\u003e\u003c/sup\u003e\u003c/p\u003e\n\u003cp\u003eSave \u003ca href=\"https://gist.github.com/andrewheiss/5667322\"\u003ethis\u003c/a\u003e to an AppleScript application (or an Automator application) and run to (kludgingly) toggle the Bluetooth menu item.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-applescript\" data-lang=\"applescript\"\u003e\u003cspan style=\"color:#66d9ef\"\u003etell\u003c/span\u003e application \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;System Preferences\u0026#34;\u003c/span\u003e\n  activate\n  \u003cspan style=\"color:#66d9ef\"\u003eset\u003c/span\u003e the current pane \u003cspan style=\"color:#66d9ef\"\u003eto\u003c/span\u003e pane \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Bluetooth\u0026#34;\u003c/span\u003e\n  delay \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\n\u003cspan style=\"color:#66d9ef\"\u003eend\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003etell\u003c/span\u003e\n\n\u003cspan style=\"color:#66d9ef\"\u003etell\u003c/span\u003e application \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;System Events\u0026#34;\u003c/span\u003e\n  \u003cspan style=\"color:#66d9ef\"\u003etell\u003c/span\u003e process \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;System Preferences\u0026#34;\u003c/span\u003e\n    \u003cspan style=\"color:#66d9ef\"\u003eset\u003c/span\u003e toggleBluetooth \u003cspan style=\"color:#66d9ef\"\u003eto\u003c/span\u003e the checkbox \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Show Bluetooth in menu bar\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eof\u003c/span\u003e the \u003cspan style=\"color:#a6e22e\"\u003ewindow\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Bluetooth\u0026#34;\u003c/span\u003e\n    click toggleBluetooth\n  \u003cspan style=\"color:#66d9ef\"\u003eend\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003etell\u003c/span\u003e\n\u003cspan style=\"color:#66d9ef\"\u003eend\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003etell\u003c/span\u003e\n\n\u003cspan style=\"color:#66d9ef\"\u003etell\u003c/span\u003e application \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;System Preferences\u0026#34;\u003c/span\u003e\n  quit\n\u003cspan style=\"color:#66d9ef\"\u003eend\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003etell\u003c/span\u003e\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003csection class=\"footnotes\" role=\"doc-endnotes\"\u003e\n\u003chr\u003e\n\u003col\u003e\n\u003cli id=\"fn:1\" role=\"doc-endnote\"\u003e\n\u003cp\u003eSee \u003ca href=\"geeks-vs-nongeeks-repetitive-tasks.png\"\u003ethis fantastic graph\u003c/a\u003e originally posted by \u003ca href=\"https://plus.google.com/+BrunoOliveira/posts/MGxauXypb1Y\"\u003eBruno Oliviera\u003c/a\u003e.\u0026#160;\u003ca href=\"#fnref:1\" class=\"footnote-backref\" role=\"doc-backlink\"\u003e\u0026#x21a9;\u0026#xfe0e;\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli id=\"fn:2\" role=\"doc-endnote\"\u003e\n\u003cp\u003eAnd by spending 15 minutes figuring out the hidden Applescript API for System Preferences to automate a task that takes up 30 seconds every month, \u003ca href=\"http://xkcd.com/1205/\"\u003eI totally saved time in the long run\u003c/a\u003e.\u0026#160;\u003ca href=\"#fnref:2\" class=\"footnote-backref\" role=\"doc-backlink\"\u003e\u0026#x21a9;\u0026#xfe0e;\u003c/a\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003c/section\u003e\n",
            "date_published": "2013-05-28T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2013/03/15/side-by-side-page-numbers-indesign/",
            "url": "https://www.shagunjhaver.com/blog/2013/03/15/side-by-side-page-numbers-indesign/",
            "title": "True side-by-side page numbers in InDesign",
            "summary": "Automatically create side-by-side page numbers for parallel texts or spread numbers in InDesign.",
            "content_html": "\u003cp\u003eThe books I make for the Middle East Texts Initiative contain side-by-side English-Arabic translations of old Arabic, Hebrew, and Latin texts. InDesign can generally handle the side-by-side parallel stories and text frames, but it cannot properly number the pages. After all the front matter and introductory text, the English translation starts on a verso page (left) with page 1, followed by a page of Arabic on the recto (right), also on page 1. The next verso is page 2.\u003c/p\u003e\n\u003cp\u003eInDesign doesn\u0026rsquo;t include a way to insert automatic spread numbers instead of page numbers, which means there\u0026rsquo;s no easy way to have automatic parallel, same-numbered pages. For years users have come up with kludgy solutions, like:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eMaking a list of page numbers in Excel and placing that list in a threaded text box on every master page (kind of like \u003ca href=\"http://indesignsecrets.com/making-numbered-tickets.php\"\u003ethis\u003c/a\u003e)\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://indesignsecrets.com/create-spread-numbers.php\"\u003ePlacing a document of empty lines\u003c/a\u003e to take advantage of InDesign\u0026rsquo;s automatic paragraph numbering\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://indesignsecrets.com/create-spread-numbers.php#comment-497592\"\u003eMaking a special text variable\u003c/a\u003e for each page (\u003ca href=\"http://benmilander.com/content/number-spreads-free-script\"\u003eautomated version\u003c/a\u003e)\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eThese methods all work, but with one big caveat—they don\u0026rsquo;t deal with any of the \u003cem\u003eactual\u003c/em\u003e page numbers. If you try to build an automatic table of contents after using any of these methods, you\u0026rsquo;ll get page numbers, not the spread numbers. Similarly, the exported PDF will show page numbers instead of spread numbers.\u003c/p\u003e\n\u003cp\u003eThe only real way to get true side-by-side numbering is to create new sections for each page. Right click on one of your pages, start a section at page 1. Right click on the next page, start a section at page 1 with some prefix (so there aren\u0026rsquo;t duplicate pages). Right click on the next page, start a section at page 2. And so on for the all the side-by-side pages.\u003c/p\u003e\n\u003cp\u003eCrazy tedious. But totally automatable with a script. \u003ca href=\"https://github.com/andrewheiss/Side-by-side-page-numbers-in-InDesign\"\u003eFind said script at GitHub\u003c/a\u003e.\u003c/p\u003e\n",
            "date_published": "2013-03-15T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2012/07/02/gutenberg-ipsum/",
            "url": "https://www.shagunjhaver.com/blog/2012/07/02/gutenberg-ipsum/",
            "title": "Gutenberg ipsum",
            "summary": "Stop using boring, boilerplate Lorem ipsum filler text and build your own random, semi-coherent text from Project Gutenberg books.",
            "content_html": "\u003cp\u003eI\u0026rsquo;ve decided to try to be more like \u003ca href=\"http://bencrowder.net/\"\u003eBen Crowder\u003c/a\u003e, \u003ca href=\"http://www.todrobbins.com/\"\u003eTod Robbins\u003c/a\u003e, and \u003ca href=\"http://brettterpstra.com/\"\u003eBrett Terpstra\u003c/a\u003e and release my code tinkerings into the public more often.\u003c/p\u003e\n\u003cp\u003eSince upgrading to \u003ca href=\"http://smilesoftware.com/TextExpander/\"\u003eTextExpander 4\u003c/a\u003e a couple weeks ago, I\u0026rsquo;ve decided to delve into it a lot more. I recently converted from \u003ca href=\"http://www.ergonis.com/products/typinator/\"\u003eTypinator\u003c/a\u003e, where I only really used a few expansions for \u003ca href=\"http://www.andrewheiss.com/blog/2009/04/26/typing-transliterated-arabic-quickly/\"\u003etyping transliterated Arabic\u003c/a\u003e. After belatedly stumbling upon a couple posts by \u003ca href=\"http://brettterpstra.com/dammit-again-with-the-lipsum/\"\u003eBrett\u003c/a\u003e and \u003ca href=\"http://www.leancrew.com/all-this/2011/02/dissociated-darwin/\"\u003eDr. Drang\u003c/a\u003e, I found that TextExpander can be used for some pretty fun stuff. Like random Lorem Ipsum-like text based on \u003cem\u003en\u003c/em\u003e-gram algorithms!\u003c/p\u003e\n\u003cp\u003eI really liked Dr. Drang\u0026rsquo;s concept of using text from Project Gutenberg to build completely random—yet mostly sensible—dummy text, since the standard \u0026ldquo;Lorem ipsum\u0026rdquo; looks really repetitive and boring. Isn\u0026rsquo;t this \u003cem\u003eBrothers Karamazov\u003c/em\u003e-esque paragraph a lot better?\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eMitya uttered his wild speech. He turned quickly on his way. “Do you suppose gentlemen, that doesn’t care for an escort, for?” I am gone? You won’t be frightened and cry out: ‘I want to join the choir and shout nastiness into both ears,’ while he ran to his bedroom, lay down and I walked along both of us. Dear ones, why do you wait.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eOr this Homeric sounding stuff?\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eAnd of bounding steeds: Seven captives next a little space Then rush d amid the bright band: great Ithacus, before, First of mortals! for the gods Then swift pursued her urged, and crown\u0026rsquo;d Then sunk unpitied to the dire alarms; Both breathing slaughter, follow\u0026rsquo;d and Patroclus loved remains defend. Beneath.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eI made a couple minor modifications to Dr. Drang\u0026rsquo;s original Perl script, clunkily removing paired characters like quotes and parentheses and allowing new corpus files to be specified with the command line, which makes it easier to repeat the code for multiple TextExpander snippets.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s how to get it working:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eCopy the script below and save it somewhere on your computer (mine is in \u003ccode\u003e~/bin/gutenberg_ipsum/\u003c/code\u003e).\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-perl\" data-lang=\"perl\"\u003e\u003cspan style=\"color:#75715e\"\u003e#!/usr/bin/perl -w\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# Modified from Dr. Drang\u0026#39;s original script at http://www.leancrew.com/all-this/2011/02/dissociated-darwin/\u003c/span\u003e\n\n\u003cspan style=\"color:#66d9ef\"\u003euse\u003c/span\u003e Games::Dissociate;\n\n\u003cspan style=\"color:#75715e\"\u003e# Choose the corpus file\u003c/span\u003e\n\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e ($#ARGV \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) {\n  $corpus \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;totc.txt\u0026#34;\u003c/span\u003e;\n} \u003cspan style=\"color:#66d9ef\"\u003eelse\u003c/span\u003e {\n  $corpus \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e $ARGV[\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e];\n}\n\n\u003cspan style=\"color:#75715e\"\u003e# Slurp in the given corpus as a single string.\u003c/span\u003e\nopen(\u003cspan style=\"color:#66d9ef\"\u003emy\u003c/span\u003e $fh, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;$ENV{HOME}/bin/gutenberg_ipsum/words/\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e.\u003c/span\u003e $corpus) \u003cspan style=\"color:#f92672\"\u003eor\u003c/span\u003e die \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Can\u0026#39;t open\u0026#34;\u003c/span\u003e;\n{local $/; $corpus \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026lt;$fh\u0026gt;\u003c/span\u003e;}\n\n\u003cspan style=\"color:#75715e\"\u003e# Dissociate the corpus, using word pairs, and return 15-50 pairs.\u003c/span\u003e\n$length \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e int(\u003cspan style=\"color:#ae81ff\"\u003e15\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e rand(\u003cspan style=\"color:#ae81ff\"\u003e35\u003c/span\u003e));\n$dis \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e dissociate($corpus, \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e, $length);\n\n\u003cspan style=\"color:#75715e\"\u003e# Remove quotes and other paired characters, since there might be some that are unmatched\u003c/span\u003e\n\u003cspan style=\"color:#75715e\"\u003e# But this is an incredibly clunky fix. If I had more time/better Perl chops, I\u0026#39;d probably build some algorithm to find unmatched quotes or parentheses and insert them randomly in the text. But that\u0026#39;s hard :)\u003c/span\u003e\n$dis \u003cspan style=\"color:#f92672\"\u003e=~\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003es/[\\\u0026#34;\\[\\]\\_\\(\\)]//gm\u003c/span\u003e;\n\n\u003cspan style=\"color:#75715e\"\u003e# Capitalize the first word and end it with a period.\u003c/span\u003e\n$dis \u003cspan style=\"color:#f92672\"\u003e=~\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003es/^(.)/\\u$1/\u003c/span\u003e;\n$dis \u003cspan style=\"color:#f92672\"\u003e=~\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003es/[.);:?\u0026#39;\u0026#34;, -]+$/./\u003c/span\u003e;\n\n\u003cspan style=\"color:#66d9ef\"\u003eprint\u003c/span\u003e $dis;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cul\u003e\n\u003cli\u003eGo to \u003ca href=\"http://www.gutenberg.org/\"\u003eProject Gutenberg\u003c/a\u003e and download the full text for some book (or create some other corpus), stripping out the legal text, table of contents, and anything else you don\u0026rsquo;t want the script to use to generate random text. Save that file in some folder on your computer (mine is in \u003ccode\u003e~/bin/gutenberg_ipsum/words/\u003c/code\u003e).\u003c/li\u003e\n\u003cli\u003eModify line 7 of the script to default to your newly downloaded and saved corpus (mine is \u003ccode\u003etotc.txt\u003c/code\u003e, for \u003cem\u003eA Tale of Two Cities\u003c/em\u003e).\u003c/li\u003e\n\u003cli\u003eModify line 14 to point to wherever you saved your script file and corpus file(s).\u003c/li\u003e\n\u003cli\u003eMake the script executable (\u003ccode\u003echmod +x gutenberg_ipsum.pl\u003c/code\u003e at the terminal).\u003c/li\u003e\n\u003cli\u003eInstall Games::Dissociate. You can either follow \u003ca href=\"http://www.leancrew.com/all-this/2011/02/dissociated-darwin/\"\u003eDr. Drang\u0026rsquo;s instructions\u003c/a\u003e or use Perl\u0026rsquo;s CPAN shell:\n\u003cul\u003e\n\u003cli\u003eType \u003ccode\u003esudo perl -MCPAN -e shell\u003c/code\u003e at a terminal and hit enter for each of the configuration options if they haven\u0026rsquo;t been preset previously\u003c/li\u003e\n\u003cli\u003eType \u003ccode\u003einstall Games::Dissociate\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003eOnce everything has installed, type \u003ccode\u003eq\u003c/code\u003e to exit the Perl shell\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003eTest your script by running it from the terminal: \u003ccode\u003egutenberg_ipsum.pl\u003c/code\u003e. You should get some fun random filler text.\u003c/li\u003e\n\u003cli\u003eUse other corpus texts by passing their filenames as arguments: \u003ccode\u003egutenberg_ipsum.pl alice.txt\u003c/code\u003e for \u003cem\u003eAlice in Wonderland\u003c/em\u003e, for example. Just make sure a corpus with that name lives in your corpus directory.\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eOnce the script is installed and running, It\u0026rsquo;s trivial to make it work with TextExpander. Make a new Shell Script snippet with this code:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e\u003cspan style=\"color:#75715e\"\u003e#!/usr/bin/env bash\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e~/bin/gutenberg_ipsum/gutenberg_ipsum.pl princessofmars.txt\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eMake as many snippets as you want—one for each of your corpus files. All you need to change in each script is the argument for the file. Replace \u003ccode\u003eprincessofmars.txt\u003c/code\u003e with the name of whatever corpus you want that snippet to use.\u003c/p\u003e\n\u003cp\u003eIn the end you can create a good collection of different automatic random filler text from any corpus you want.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"te-snippets-small.png\" alt=\"Gutenberg ipsum snippets\"\u003e\u003c/p\u003e\n\u003cp\u003eIf TextExpander 4 allowed its new Fill Ins to work as variables in a shell script, this whole collection could be a lot simpler—it could just be one dropdown menu of all the corpus files in the \u003ccode\u003ewords\u003c/code\u003e folder. But since that\u0026rsquo;s not possible, this will have to do.\u003c/p\u003e\n\u003cp\u003eAll the credit to this collection of snippets goes to \u003ca href=\"http://www.leancrew.com/\"\u003eDr. Drang\u003c/a\u003e and \u003ca href=\"http://brettterpstra.com/\"\u003eBrett Terpstra\u003c/a\u003e. You should read their stuff—really.\u003c/p\u003e\n",
            "date_published": "2012-07-02T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2012/04/17/install-r-rstudio-r-commander-windows-osx/",
            "url": "https://www.shagunjhaver.com/blog/2012/04/17/install-r-rstudio-r-commander-windows-osx/",
            "title": "Install R, RStudio, and R Commander in Windows and OS X",
            "summary": "R, RStudio, and R Commander are all powerful open source statistical tools, but they can be a little tricky to install. These instructions make it easy to get everything working right.",
            "content_html": "\u003cp\u003e\u003ca href=\"http://www.r-project.org/\"\u003eR\u003c/a\u003e is an incredibly powerful open source program for statistics and graphics. It can run on pretty much any computer and has a very active and friendly support community online. Graphics created by R are extremely extensible and are used in high level publications like the New York Times (as explained by \u003ca href=\"http://book.flowingdata.com/\"\u003ethis former NYT infographic designer\u003c/a\u003e).\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://rstudio.org/\"\u003eRStudio\u003c/a\u003e is an integrated development environment (IDE) for R. It\u0026rsquo;s basically a nice front-end for R, giving you a console, a scripting window, a graphics window, and an R workspace, among other options.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://socserv.mcmaster.ca/jfox/Misc/Rcmdr/\"\u003eR Commander\u003c/a\u003e is a basic graphical user interface (GUI) for R. It provides a series of menus that allow you to run lots of statistic tests and create graphics without typing a line of code. More advanced features of R aren\u0026rsquo;t accessible through R Commander, but you can use it for the majority of your statistics. \u003cem\u003e(Lots of people (like me) use R Commander as a crutch for a few months before they get the hang of the R language. As intimidating as it might be to constantly type stuff at the console, it really is a lot faster.)\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eHowever, as is the case with lots of free and open source software, it can be a little tricky to install all of these different programs and get them to work nicely together. The simple instructions below explain how to get everything working right.\u003c/p\u003e\n\u003ch3 id=\"install-r-rstudio-and-r-commander-in-windows\"\u003eInstall R, RStudio, and R Commander in Windows\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eDownload R from \u003ca href=\"http://cran.us.r-project.org/\"\u003ehttp://cran.us.r-project.org/\u003c/a\u003e (click on \u0026ldquo;Download R for Windows\u0026rdquo; \u0026gt; \u0026ldquo;base\u0026rdquo; \u0026gt; \u0026ldquo;Download R 2.x.x for Windows\u0026rdquo;)\u003c/li\u003e\n\u003cli\u003eInstall R. Leave all default settings in the installation options.\u003c/li\u003e\n\u003cli\u003eDownload RStudio from \u003ca href=\"http://rstudio.org/download/desktop\"\u003ehttp://rstudio.org/download/desktop\u003c/a\u003e and install it. Leave all default settings in the installation options.\u003c/li\u003e\n\u003cli\u003eOpen RStudio.\u003c/li\u003e\n\u003cli\u003eGo to the \u0026ldquo;Packages\u0026rdquo; tab and click on \u0026ldquo;Install Packages\u0026rdquo;. The first time you\u0026rsquo;ll do this you\u0026rsquo;ll be prompted to choose a CRAN mirror. R will download all necessary files from the server you select here. Choose the location closest to you (probably \u0026ldquo;USA CA 1\u0026rdquo; or \u0026ldquo;USA CA 2\u0026rdquo;, which are housed at UC Berkeley and UCLA, respectively).\u003cbr\u003e\n\u003cimg src=\"install_packages_win.png\" alt=\"Install packages in Windows\"\u003e\u003c/li\u003e\n\u003cli\u003eStart typing \u0026ldquo;Rcmdr\u0026rdquo; until you see it appear in a list. Select the first option (or finish typing Rcmdr), ensure that \u0026ldquo;Install dependencies\u0026rdquo; is checked, and click \u0026ldquo;Install\u0026rdquo;.\u003cbr\u003e\n\u003cimg src=\"install_packages_win_1.png\" alt=\"Install Rcmdr in Windows\"\u003e\u003c/li\u003e\n\u003cli\u003eWait while all the parts of the R Commander package are installed.\u003c/li\u003e\n\u003cli\u003eIf you get permission errors while installing packages, close R Studio and reopen it with administrator privileges.\u003cbr\u003e\n\u003cimg src=\"run_as_administrator.png\" alt=\"Run as administrator in Windows\"\u003e\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"install-r-rstudio-and-r-commander-in-mac-os-x\"\u003eInstall R, RStudio, and R Commander in Mac OS X\u003c/h3\u003e\n\u003col\u003e\n\u003cli\u003eDownload R from \u003ca href=\"http://cran.us.r-project.org/\"\u003ehttp://cran.us.r-project.org/\u003c/a\u003e (click on \u0026ldquo;Download R for Mac OS X\u0026rdquo; \u0026gt; \u0026ldquo;R-2.x.x.pkg (latest version)\u0026quot;)\u003c/li\u003e\n\u003cli\u003eInstall R.\u003c/li\u003e\n\u003cli\u003eDownload RStudio from \u003ca href=\"http://rstudio.org/download/desktop\"\u003ehttp://rstudio.org/download/desktop\u003c/a\u003e.\u003c/li\u003e\n\u003cli\u003eInstall RStudio by dragging the application icon to your Applications folder.\u003c/li\u003e\n\u003cli\u003eDownload Tcl/Tk from \u003ca href=\"http://cran.r-project.org/bin/macosx/tools/\"\u003ehttp://cran.r-project.org/bin/macosx/tools/\u003c/a\u003e (click on \u003ccode\u003etcltk-8.x.x-x11.dmg\u003c/code\u003e; OS X needs this to run R Commander.)\u003c/li\u003e\n\u003cli\u003eInstall Tcl/Tk.\u003c/li\u003e\n\u003cli\u003eGo to your Applications folder and find a folder named Utilities. Verify that you have a program named \u0026ldquo;X11\u0026rdquo; there. If not, go to \u003ca href=\"http://xquartz.macosforge.org/\"\u003ehttp://xquartz.macosforge.org/\u003c/a\u003e and download and install the latest version of XQuartz.\u003cbr\u003e\n\u003cimg src=\"x11_utilities.png\" alt=\"X11 in Applications/Utilities\"\u003e\u003c/li\u003e\n\u003cli\u003eOpen RStudio.\u003c/li\u003e\n\u003cli\u003eGo to the \u0026ldquo;Packages\u0026rdquo; tab and click on \u0026ldquo;Install Packages\u0026rdquo;. The first time you\u0026rsquo;ll do this you\u0026rsquo;ll be prompted to choose a CRAN mirror. R will download all necessary files from the server you select here. Choose the location closest to you (probably \u0026ldquo;USA CA 1\u0026rdquo; or \u0026ldquo;USA CA 2\u0026rdquo;, which are housed at UC Berkeley and UCLA, respectively).\u003cbr\u003e\n\u003cimg src=\"install_packages_mac.png\" alt=\"Install packages in OS X\"\u003e\u003c/li\u003e\n\u003cli\u003eStart typing \u0026ldquo;Rcmdr\u0026rdquo; until you see it appear in a list. Select the first option (or finish typing Rcmdr), ensure that \u0026ldquo;Install dependencies\u0026rdquo; is checked, and click \u0026ldquo;Install\u0026rdquo;.\u003cbr\u003e\n\u003cimg src=\"install_packages_mac_1.png\" alt=\"Install Rcmdr in OS X\"\u003e\u003c/li\u003e\n\u003cli\u003eWait while all the parts of the R Commander package are installed.\u003c/li\u003e\n\u003c/ol\u003e\n\u003ch3 id=\"open-r-commander-in-windows-and-os-x\"\u003eOpen R Commander in Windows and OS X\u003c/h3\u003e\n\u003cp\u003eOnce you\u0026rsquo;ve installed R Commander, you won\u0026rsquo;t have to go through all those steps again! Running R Commander from this point on is simple—follow the instructions below.\u003c/p\u003e\n\u003cp\u003eIf you decide to stop using R Commander and just stick with R, all you ever need to do is open RStudio—even simpler!\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003eOpen R Studio\u003c/li\u003e\n\u003cli\u003eIn the console, type \u003ccode\u003ewindows()\u003c/code\u003e if using Windows, \u003ccode\u003equartz()\u003c/code\u003e if using Mac OS X. (This tells R Commander to output all graphs to a new window). If you don\u0026rsquo;t do this, R Commander graphs will be output to the graphics window in RStudio.\u003c/li\u003e\n\u003cli\u003eGo to the \u0026ldquo;Packages\u0026rdquo; tab, scroll down to \u0026ldquo;Rcmdr,\u0026rdquo; and check the box to load the plugin. (Alternatively, type \u003ccode\u003elibrary(Rcmdr)\u003c/code\u003e at the console.)\u003c/li\u003e\n\u003c/ol\u003e\n",
            "date_published": "2012-04-17T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2011/06/25/world-ready-composer-not-perfect/",
            "url": "https://www.shagunjhaver.com/blog/2011/06/25/world-ready-composer-not-perfect/",
            "title": "World-Ready Composer not Perfect",
            "summary": "Even though InDesign’s new World-Ready Composer is awesome, it is still buggy and struggles with a few Arabic fonts.",
            "content_html": "\u003cp\u003eAlthough Adobe has included the world-ready composer in InDesign CS4 and 5, \u003ca href=\"http://www.andrewheiss.com/blog/2011/06/24/using-arabic-in-indesign-cs5-without-indesign-me/\"\u003elike I said in my previous post\u003c/a\u003e, it\u0026rsquo;s not documented or supported at all. It\u0026rsquo;s still buggy and unfinished, unfortunately.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s a little example of how buggy it really is. I typeset the same sentence in Arabic in different fonts I have installed on my computer. As you can see, most of the fonts work flawlessly (yay!), with two exceptions. Traditional Arabic can\u0026rsquo;t display short vowels—they break up the connecting letters—and Geeza Pro is a sad, sad little font.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"Arabic%20Samples.pdf\"\u003eDownload PDF of sample\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"Arabic-Samples.png\" alt=\"Arabic typographic samples\" title=\"Arabic typographic samples\"\u003e\u003c/p\u003e\n\u003cp\u003eI don\u0026rsquo;t know if this is a problem with the fonts themselves or with the composer. \u003cdel\u003eTraditional Arabic was specially designed for Office 2007 to be a high quality Arabic font, and it comes with thousands of extra glyphs for every position possible, so it would seem like it \u003cem\u003eshould\u003c/em\u003e be able to display correctly.\u003c/del\u003e Just kidding. Arabic Typesetting is the special Office 2007 font and it works just fine (it has a nice Naskh-y feel to it). Traditional Arabic has been included with Windows since Windows 2000 and apparently isn\u0026rsquo;t very well made (?). Or maybe the composer is just buggy (?).\u003c/p\u003e\n\u003cp\u003eGeeza Pro, on the other hand, definitely has a problem with the font itself. One dead forum (formerly at \u003ca href=\"http://forum.redlers.com/viewtopic.php?f=1\u0026amp;t=2180\"\u003ehttp://forum.redlers.com/viewtopic.php?f=1\u0026amp;t=2180\u003c/a\u003e) says that the version of Geeza Pro in Snow Leopard is faulty and doesn\u0026rsquo;t connect. Hopefully Lion fixes that…\u003c/p\u003e\n",
            "date_published": "2011-06-25T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2011/06/24/using-arabic-in-indesign-cs5-without-indesign-me/",
            "url": "https://www.shagunjhaver.com/blog/2011/06/24/using-arabic-in-indesign-cs5-without-indesign-me/",
            "title": "Using Arabic in InDesign CS5 without InDesign ME",
            "summary": "Use InDesign CS5‘s hidden World Ready Composer to typeset text in Arabic and other complex scripts.",
            "content_html": "\u003cp\u003eNearly four years ago, \u003ca href=\"/blog/2007/09/17/using-arabic-in-indesign-without-indesign-me/\"\u003eI posted a workaround for InDesign CS3\u0026rsquo;s lack of support for RTL support.\u003c/a\u003e The only way to get proper Arabic or Hebrew text back then was to type backwards—something trivial (and scriptable) for Hebrew, but far more complicated for Arabic, with all its different letter forms that change depending on their position in the word. Rather than \u003cem\u003etype\u003c/em\u003e backwards, you had to \u003cem\u003emanually\u003c/em\u003e insert glyphs from the glyphs panel backwards. While this was extraordinarily tedious, it worked for times when you only needed to deal with a few words—maybe a short sentence.\u003c/p\u003e\n\u003cp\u003eFor my job I\u0026rsquo;ve been using InDesign CS3 ME with Tasmeem and have fallen in love with the super advanced typographic tools that it provides. But, I\u0026rsquo;m not planning on keeping that job forever (I\u0026rsquo;m graduating in less than a year!), and I don\u0026rsquo;t want to go back to hunting for glyphs. I\u0026rsquo;ve been spoiled :)\u003c/p\u003e\n\u003cp\u003eI heard rumors that CS4 and CS5 had a mysterious RTL editing mode that was only accessible through scripting, but I was in Egypt for both launches and wasn\u0026rsquo;t able to get the educational upgrade. I finally upgraded to CS5 a couple days ago and immediately got to work figuring out this rumored Arabic mode.\u003c/p\u003e\n\u003cp\u003eStarting with CS4, Adobe began including a new \u0026ldquo;world ready\u0026rdquo; paragraph composer, which provides many of the same typographic controls offered by Winsoft\u0026rsquo;s Middle Eastern editions. However, CS4 shipped before Adobe could polish off any of the controls. The internet world hoped that there\u0026rsquo;d be some new world ready panel for CS5, but to no avail. The world ready composer was included (and improved?) with CS5, but is still mostly inaccessible.\u003c/p\u003e\n\u003cp\u003eUnless you do a cool trick :)\u003c/p\u003e\n\u003cp\u003eYou can programmatically create paragraph styles that use the world ready composer, allowing you to typeset Arabic, Hebrew, Thai, Devangari-like languages, and a ton of other more complex scripts. Here\u0026rsquo;s how you can enable native Arabic typography inside CS5 (courtesy of \u003ca href=\"http://www.thomasphinney.com/2009/01/adobe-world-ready-composer/\"\u003eThomas Phinney\u003c/a\u003e):\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\u003ca href=\"http://www.thomasphinney.com/wp-content/uploads/2009/01/r2l_scripts_for_id_cs4.zip\"\u003eDownload these scripts\u003c/a\u003e by Thomas Phinney and Peter Kahrel and \u003ca href=\"http://www.danrodney.com/scripts/directions-installingscripts.html\"\u003einstall them\u003c/a\u003e in your script folder.\u003c/li\u003e\n\u003cli\u003eRun the \u0026ldquo;r2l Paragraph Style Arabic\u0026rdquo; script from the Scripts panel. A new paragraph style named \u0026ldquo;RTL Arabic\u0026rdquo; should appear in your Paragraph Styles panel.\u003c/li\u003e\n\u003cli\u003eCheck the style settings and verify that the \u0026ldquo;Adobe World-Ready Paragraph Composer\u0026rdquo; is being used for the style.\u003cbr\u003e\n\u003cimg src=\"world-ready.png\" alt=\"World-Ready Composer\" title=\"World-Ready Composer\"\u003e\u003c/li\u003e\n\u003cli\u003eStart using Arabic text!\u003c/li\u003e\n\u003cli\u003e\u003cem\u003eBonus:\u003c/em\u003e To use the composer in other documents you can either run the script again or just copy the style. The composer is activated by the style. Theoretically you could save the Arabic style to a new template and never have to run the script again.\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eThis is definitely \u003cem\u003enot\u003c/em\u003e a full replacement for Winsoft\u0026rsquo;s CS5 InDesign ME, since it doesn\u0026rsquo;t give you any graphical control over kashidas, digits, diacritic positions, or any of the other more detailed options available in the world ready composer. You can edit the script, change the options around, and create a new style, but you\u0026rsquo;d need to know the API for the world ready composer. Phinney\u0026rsquo;s script, for example, sets the default digits for the style as Arabic digits with \u003ccode\u003eps.digitsType = DigitsTypeOptions.arabicDigits;\u003c/code\u003e. If you knew the option for Farsi-style numbers, you could edit the script. Unfortunately the whole composer is completely undocumented and unsupported. \u003ca href=\"http://indesigning.net/right-to-left-arabic-hebrew-hindi-in-indesign-cs4-none-me\"\u003eThis site\u003c/a\u003e includes many of the hidden options—you\u0026rsquo;d just need to guess about how to use them in the script. Maybe Adobe will finally make all these options accessible in CS6?\u003c/p\u003e\n\u003cp\u003eThere are a couple options for more graphical control over the hidden settings, but they cost money. \u003ca href=\"https://sites.google.com/site/adoberighttoleft/Home\"\u003eidRTL\u003c/a\u003e created a plugin that provides a useful panel to edit all the hidden Middle Eastern settings. It\u0026rsquo;s $50 and says it\u0026rsquo;s made for CS4, although I\u0026rsquo;m assuming it\u0026rsquo;ll work with CS5 too. \u003ca href=\"http://in-tools.com/products/plugins/world-tools/\"\u003eWord Tools\u003c/a\u003e creates a similar panel, costs $100, and supports CS5.\u003c/p\u003e\n\u003cp\u003eSo, even though activating the world ready composer can be a little tricky, it\u0026rsquo;s a fantastic little trick that lets you use real RTL text without tedious backward typing.\u003c/p\u003e\n",
            "date_published": "2011-06-24T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2011/06/19/fake-cloud-app-dropbox/",
            "url": "https://www.shagunjhaver.com/blog/2011/06/19/fake-cloud-app-dropbox/",
            "title": "Fake CloudApp with Dropbox and Quicksilver",
            "summary": "Move files to your Dropbox public folder and generate a shareable URL instantly, \u003cem\u003eà la\u003c/em\u003e CloudApp, with a combination of a few services and Quicksilver triggers.",
            "content_html": "\u003cp\u003eRecently a friend showed me \u003ca href=\"http://getcloudapp.com/\"\u003eCloudApp\u003c/a\u003e, a fantastic little app that sits in your menu bar and lets you share files almost instantly. With a quick keystroke you upload a file to their servers and get a public URL to share with anyone. Neato.\u003c/p\u003e\n\u003cp\u003eHowever, with a basic (free) CloudApp account you are limited in the size and number of uploads you can make each month. I\u0026rsquo;m also really picky about what goes in my menu bar, and I didn\u0026rsquo;t really like having an extra app running just for when I need to upload something.\u003c/p\u003e\n\u003cp\u003eMy current workflow for uploading and sending files is to drag a file into my Dropbox public folder, navigate to it, right click it, and copy its public Dropbox URL. I like this because Dropbox is already running on my computer (no need for extra menu bar apps) and because I feel like I have more control over the fate of my file than with CloudApp (regardless of \u003ca href=\"http://daringfireball.net/linked/2011/05/17/dropbox-encryption\"\u003eDropbox\u0026rsquo;s recent legal issues\u003c/a\u003e). Plus there aren\u0026rsquo;t any arbitrary upload or storage space restrictions.\u003c/p\u003e\n\u003cp\u003eThe one downside to this workflow is that it\u0026rsquo;s long and convoluted and lacks the magic instantaneousness of CloudApp. So I decided to make my own magical  CloudApp-esque instant upload + public URL system with programs I\u0026rsquo;m already running: Dropbox and Quicksilver.\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s how to do it:\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eDownload the \u003ca href=\"http://dropboxwiki.com/Dropbox_Service\"\u003e\u0026ldquo;Post to Dropbox\u0026rdquo;\u003c/a\u003e OS X service.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eUnzip and open the Copy to Dropbox service in Automator.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003e\u003cem\u003eOptional:\u003c/em\u003e If you don\u0026rsquo;t want to clutter your public folder with random files, you can change the \u0026ldquo;Copy Finder Items\u0026rdquo; action in Automator to point to a subfolder in your public folder. Mine is set to \u0026ldquo;~/Dropbox/Public/Uploaded,\u0026rdquo; so I can periodically go and clear out any out of date uploads, like one-off screenshots and the like.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eIn the Run Shell Script section, replace \u003ccode\u003e\u0026lt;DROPBOX-ID\u0026gt;\u003c/code\u003e with your Dropbox user ID (the one from your public URLs, not your e-mail address).\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eIf you want to use the Move to Dropbox service as well (I use both), open it and type your user ID there as well.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eMove both services to ~/Library/Services. You can now access them from the system wide services menu. Right click on any file, go to \u0026ldquo;Services\u0026rdquo; and easily move or copy any file to your public Dropbox folder \u003cem\u003eand\u003c/em\u003e get the URL for that file placed automatically in your clipboard.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eWhile these services eliminate most of the clicking and dragging I was doing before, they still require three clicks (select the file, right click to navigate to the services menu, click on the service). Luckily Quicksilver simplifies the process even more. You could probably use other Quicksilver-esque programs like Alfred and the like to get the universal service keyboard shortcuts.\u003c/p\u003e\n\u003col\u003e\n\u003cli\u003e\n\u003cp\u003eEnable the \u0026ldquo;Services Menu Module\u0026rdquo; in Quicksliver\u0026rsquo;s plug-ins sheet in its preferences (⌘ + ,).\u003cbr\u003e\n\u003cimg src=\"qs-plugins_500.png\" alt=\"Quicksilver plugin menu\" title=\"Quicksilver plugin menu\"\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eGo to Preferences and make sure \u0026ldquo;Enable advanced features\u0026rdquo; is checked.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eGo to Catalog \u0026gt; Quicksilver and check \u0026ldquo;Proxy Objects\u0026rdquo;\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eCreate a new trigger to pipe the current selection through each of the services. I use ⌃⌥⌘U for Copy to Dropbox and ⌃⌥⇧⌘U (essentially mashing down the whole corner of my keyboard :) ) for Move to Dropbox.\n\u003cimg src=\"trigger_500.png\" alt=\"Setting a trigger in Quicksilver\" title=\"Setting a trigger in Quicksilver\"\u003e\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eSelect a file, press your new keyboard shortcut, and voila—the file is instantly copied to Dropbox and you have a URL ready to paste somewhere. Pure magic :)\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ol\u003e\n\u003cp\u003eOne of the only differences between this and CloudApp is that there\u0026rsquo;s no response after you use the service. There\u0026rsquo;s nothing to let you know that it actually happened. However, you can easily add a sound or Growl notification to the Automator service if you want some sort of response.\u003c/p\u003e\n\u003cp\u003eSo there it is. Magic CloudApp functionality using Dropbox and Quicksilver!\u003c/p\u003e\n",
            "date_published": "2011-06-19T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2011/02/03/in-tahrir-square/",
            "url": "https://www.shagunjhaver.com/blog/2011/02/03/in-tahrir-square/",
            "title": "In Tahrir Square",
            "summary": "A poem in honor of the #Jan25 Tahrir protestors",
            "content_html": "\u003cp\u003eMy awesome wife \u003ca href=\"http://www.heissatopia.com/2011/02/in-tahrir-square.html\"\u003ejust wrote up a fantastic poem\u003c/a\u003e dedicated to the #Jan25 Tahrir protestors. This past week has been riveting and emotional for us, even though we live far from Egypt now. Cairo was our home for two years—we drank from the Nile \u003cspan class=\"rtl\"\u003e(شربنا من النيل)\u003c/span\u003e and feel part of it. This horrific carnage is absolutely sickening.\u003c/p\u003e\n\u003cp\u003eTa7ya Masr!\u003c/p\u003e\n\u003chr\u003e\n\u003ch3 id=\"in-tahrir-square\"\u003eIn Tahrir Square\u003c/h3\u003e\n\u003cp\u003eIn Tahrir Square the people fight\u003cbr\u003e\nFor freedom, truth, and human rights\u003cbr\u003e\nWe all should have; While here I sit\u003cbr\u003e\nAnd watch the robins peck and flit\u003cbr\u003e\nNot knowing what went on last night.\u003c/p\u003e\n\u003cp\u003eHow many dead? We\u0026rsquo;ll never know.\u003cbr\u003e\nThe guns, the knives, the bombs aglow\u003cbr\u003e\nSeek and will seek to thwart hearts knit\u003cbr\u003e\nIn Tahrir square.\u003c/p\u003e\n\u003cp\u003eTake up their quarrel with the foe:\u003cbr\u003e\nTo you from failing hands they fling\u003cbr\u003e\nThe torch; be yours to hold it high.\u003cbr\u003e\nIf ye break faith with those who die\u003cbr\u003e\nThey shall not sleep, when silence rings\u003cbr\u003e\nIn Tahrir Square.\u003c/p\u003e\n\u003cp\u003eNancy Heiss\u003cbr\u003e\nFebruary 3, 2011\u003c/p\u003e\n\u003cp\u003e\u003cem\u003e(With thanks to \u003ca href=\"http://en.wikipedia.org/wiki/In_Flanders_Fields\"\u003eJohn McCrae\u003c/a\u003e)\u003c/em\u003e\u003c/p\u003e\n",
            "date_published": "2011-02-03T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2011/01/27/mona-prince-on-egyptian-revolution/",
            "url": "https://www.shagunjhaver.com/blog/2011/01/27/mona-prince-on-egyptian-revolution/",
            "title": "Mona Prince on #jan25 Egyptian Protests ",
            "summary": "Mona Prince's personal account of the #jan25 Egyptian protests",
            "content_html": "\u003cp\u003eEgyptian novelist and professor Mona Prince just sent me this personal report on her experience with the \u003ca href=\"http://en.wikipedia.org/wiki/2011_Egyptian_protests\"\u003e#jan25 protests\u003c/a\u003e. I\u0026rsquo;m reposting it here in its entirety.\u003c/p\u003e\n\u003chr\u003e\n\u003cp\u003e\u003cstrong\u003ea personal testimony on police brutality during protests: jan 26 2011 down town cairo\u0026mdash;mona prince\u003c/strong\u003e\u003cbr\u003e\nround 6.30 pm down town cairo, i joined the demonstration on qasr el nil street along with some friends and other people whom i don\u0026rsquo;t know. the protesters were marching  peacefully and politely and decently from one street to another evading the security forces who were some how at a loss at how to stop us, especially when we took to shawarbi street, we were at the back, and the police officers behind and front talking in their walki talki, we could hear them saying they don\u0026rsquo;t know how to besiege us. we kept on moving and more people were joining us from the streets and shops, young men and women. we were chanting the requests of egyptian people \u0026quot; leave \u0026quot; and \u0026quot; egyptian people want the regime out \u0026ldquo;. we didn\u0026rsquo;t attack any body, or destroy any shops or cars\u0026hellip; we were moving in the middle of streets without blocking the traffic, just slowing it down until we reached sherif street and we were heading towards 26 july street, then the security forces appeared from behind and front. we started running, and  security police in civilian clothes started grabbing randomly many young men and women. i saw them grab and beat a young innocent man, pushed him to the ground and kept kicking. i protested against the beating up, and kept screaming at them to stop acting like animals, 4 or 5 huge giant men grabbed me from my hair and said \u0026quot; well join him you bitch \u0026quot; and slapped me on the face , beat me up, kicked me, and cornered me next to the young man and kept hitting me on my head, arm, shoulder, back , stepping on my head with their shoes until i bled from my mouth and could not speak any more on the ground. they kept their shoes on my head, kicked me every few seconds,calling me the dirtiest names ever the they dragged me all along the street to 26 july and threw me in one of those microbuses without number plates. they have also dragged the other young man who completely fainted and others too and threw us all in the microbus. and while pushing me inside they were trying to pull off my clothes and sexually harassed me,one grabbed my breasts , another held me my waste, and another grabbed my bottom. i tried to call friends discreetly, but they saw me, so they pull me out of the car and said \u0026quot; get off \u0026quot; but 3 of them were blocking the door, and they grabbed the mobile from me, then threw me to the asphalt road.\ndespite the pain, i will go on protesting\nmona prince\negyptian writer and university professor\ncairo january 27 2011\u003c/p\u003e\n\u003cdiv class=\"rtl\"\u003e\n**شهادة عن وحشية بلطجية الامن في المظاهرات- وسط القاهرة ٢٦ يناير ٢٠١١ مني برنس\n**\nفي حوالي السادسة و نصف مساء يوم الاربعاء ٢٦ يناير ٢٠١١، انضممت انا و أصدقاء و آخرين لا اعرفهم الى مسيرة سلمية احتجاجية في منطقة وسط المدينة، في شارع قصر النيل. و كان المتظاهرون يسيرون بكل ادب من شارع الي اخر في محاولة للهرب و تجنب قوات الامن المركزي الذين بدوا في حيرة و ارتباك حول كيفية محاصرتنا و تفريقنا، خاصة بعدما توجهنا الى شارع الشواربي. كنت انا و المجموعة التي معي في الخلف، و من امامنا و خلفنا ضباط الامن يتكلمون في اجهزتهم اللاسلكية و سمعناهم يقولون ما مفاده انهم لا يعرفون كيف يحاصروننا. استمررنا في السير بشجاعة و دون خوف، و اضم الينا الكثير من الشباب و البنات من الشوارع الجانبية و المحلات، و كنا نردد \" ارحل \" و \" الشعب يريد اسقاط النظام \" لم نعتدي على منشآت او سيارات و لم نهاجم احدا. كنا نسير و سط الشوارع دون أن نمنع مرور السيارات و ان كنا أبطأنا سيرها باتجاه شارع ٢٦ يوليو. ثم ظهرت قوات الامن المركزي من الامام و الخلف ر بدأت تجري نحونا بقوة، فجرينا متفرقين محاولين الاحتماء بالمحلات. و فجأة بدأ بلطجية الامن و وزارة الداخلية الذين يرتدون ملابس مدنية في القبض العشوائي علي الشباب و البنات و ضربهم بقوة. رأيتهم يقبضون على شاب كان يسير أمامي و لم يفعل اي شيء سوى الهتاف مثلنا، دفعوه بزخذيتهم و القوا به الي الأرض و انهالوا عليه ضربا و ركلا و لكما حتى اغمي عليه. اعترضت على ما يفعلون و صرخت فيهم الا يتصرفوا مثل الحيوانات و انهم ليسوا رجال و ليسوا بني آدمين، فاندفع نحوي ٤ او ٥ رجال ضخام الحجم و جروني من شعري، ضربوني علي و جهي، أخذوا يضربونني بعنف و يركلونني ثم القوا بي الى الآرض بجانب الشاب الذي فقد وعيه و هم يقولون \" طب يللا حصليه يا بنت القحبة \".  فرد اخر \" مرة قحبة \" و استمروا في ضربي و ركلي بضعة دقائق و يدوسون علي رأسي و جسدي بأحذيتهم حتى سال الدم من فمي و هم يسبونني بأقذر السباب و الصفات، الى ان سكت و لم استطع الكلام. ثم جرجروني و هم ما يزالرن يركلونني و يسبونني الى شارع ٢٦ يوليو ثم القوا في واحد من تلك الميكروباصات التي لا تحمل لوحة ارقام. و فعلوا نفس الشيء مع شباب اخرين و القوا بهم الى داخل نفس السيارة، من بينهم الشاب الذي كنت ادافع عنه و فقد وعيه. و في اثناء محاولتهم حشري داخل السيارة، كانوا يتحرشون بي جنسيا، و يحاولون تعريتي واحد مسكني من صدري، و الحر من وسطي و شخص اخر مسكني من اسفل ظهري ثم دفعوني الى الداخل.  كان هناك نحو ٥ او ٦ و ربما اكثر شباب داخل السيارة. حاولت الاتصال بأصدقاء بشكل هامس و بعيد عن اعين الامن لكنهم رأوومي. سحبوني من داخل الميكروباص و امروني بالنزول و هم يسبونني و في نفس الوقت يسدون باب السيارة  \" بتكلمي مين يا بنت ....\" و خطفوا مني التلفون المحمول بالقوة ثم شدوني خارج السيارة و القوا بي الي الاسفلت.\n\u003cp\u003eرغم الألم سوف استمر في الاحتجاج\nمنى برنس\nكاتبة مصرية و استاذة بالجامعة\nالقاهرة ٢٧ يناير ٢٠١١\u003c/p\u003e\n\u003c/div\u003e\n",
            "date_published": "2011-01-27T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2010/09/24/ios4-multitasking-battery-life/",
            "url": "https://www.shagunjhaver.com/blog/2010/09/24/ios4-multitasking-battery-life/",
            "title": "iOS 4, Multitasking, and Battery Life",
            "summary": "The multitasking capabilities of iOS 4 seem to be draining my battery. Help me figure out how to stop it!",
            "content_html": "\u003cp\u003eI recently got a brand new 4G iPod Touch for my initial foray into the amazing world of iOS. I\u0026rsquo;ve been sitting on the sidelines far too long and I\u0026rsquo;m \u003ca href=\"http://twitter.com/#!/andrewheiss/status/25170167865\"\u003eso excited\u003c/a\u003e to finally have an almost-iPhone.\u003c/p\u003e\n\u003cp\u003eHowever, I ran into my first hitch this morning and my Google skills have proven useless to solve it. I\u0026rsquo;ve been using the iPod as an alarm clock for the past few days since its UI is superior to the ancient digital clock in our bedroom :). When I went to bed last night the battery was probably at 80% capacity. \u003ca href=\"http://www.apple.com/ipodtouch/specs.html\"\u003eApple touts\u003c/a\u003e that the new iPod has 40 hours of battery life when playing music—quite impressive. I had put the iPod in airplane mode, turning off the WiFi so that I wouldn\u0026rsquo;t get any mail or Facebook notifications. With no internet, no music, and no apps (supposedly) running, the iPod\u0026rsquo;s battery theoretically should have lasted for months—or even years :)\u003c/p\u003e\n\u003cp\u003eHowever, I didn\u0026rsquo;t wake up to the iPod\u0026rsquo;s alarm this morning. I woke up to Rachel pulling on my arm and saying \u0026ldquo;Wake up, Dad! I want cereal!\u0026rdquo; 1.5 hours later than when I was planning to wake up.\u003c/p\u003e\n\u003cp\u003eThe iPod\u0026rsquo;s battery had died in less than 7 hours.\u003c/p\u003e\n\u003cp\u003eI\u0026rsquo;m assuming this is linked to the new multitasking system in iOS 4, where apps that aren\u0026rsquo;t running are put into memory so you can open them where you left off. Sure enough, I had like 25 apps in the multitasking tray, which I quickly cleared out after plugging in the depleted iPod.\u003c/p\u003e\n\u003cp\u003eSo, iOS users out there: what experience have you had with multitasking and battery life? Is there an easy way to \u0026ldquo;officially\u0026rdquo; quit an application rather than send it to the tray? What should I do avoid something like this again?\u003c/p\u003e\n",
            "date_published": "2010-09-24T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2010/02/28/queen-rania-at-auc/",
            "url": "https://www.shagunjhaver.com/blog/2010/02/28/queen-rania-at-auc/",
            "title": "Queen Rania at AUC",
            "summary": "On February 28, 2010 at the American University in Cairo, Jordan's Queen Rania gave a speech on the importance of civic engagement in the Arab world. While her idea that regular citizens need to be more involved in government, the hardhanded policies of Arab governments make it almost impossible for that to happen.",
            "content_html": "\u003cp\u003eThis morning AUC\u0026rsquo;s \u003ca href=\"https://business.aucegypt.edu/research/centers/gerhart\" title=\"Gerhart Center\"\u003eJohn D. Gerhart Center for Civic Engagement\u003c/a\u003e hosted a lecture by \u003ca href=\"http://www.queenrania.jo/\"\u003eQueen Rania al-Abdullah\u003c/a\u003e of Jordan. Queen Rania is famous for being intensely involved in the public sphere and, according to the venerable \u003ca href=\"http://en.wikipedia.org/wiki/Queen_Rania_of_Jordan\"\u003eWikipedia\u003c/a\u003e, is considered one of the \u003ca href=\"http://www.forbes.com/lists/2009/11/power-women-09_Queen-Rania_VZPS.html\"\u003eworld\u0026rsquo;s most powerful women\u003c/a\u003e. She\u0026rsquo;s involved with a ton of foundations and NGOs that cover a wide range of goals, from advocating for improvement in girls' education and employment, promoting dialogue between the US and the Arab world, and calling for what became the buzzword of today\u0026rsquo;s lecture: civic engagement. She uses technology to promote her agenda of social improvement and is active on \u003ca href=\"http://www.youtube.com/user/QueenRania\"\u003eYouTube\u003c/a\u003e, \u003ca href=\"http://twitter.com/QueenRania\"\u003eTwitter\u003c/a\u003e, and \u003ca href=\"http://www.facebook.com/QueenRania\"\u003eFacebook\u003c/a\u003e. Basically a beautiful, famous, powerful world leader.\u003c/p\u003e\n\u003cp\u003eQueen Rania focused primarily on the need for native grassroots movements in the Arab world, stating that civic engagement is an essential element of societal reform—changes so desperately needed in this region, where poverty and corruption are rampant. She stated that it is the responsibility of all citizens to take an interest in developing and improving their own country. Calling on Arabs to \u0026ldquo;look up\u0026rdquo; and think of others, she cited the example of one of AUC\u0026rsquo;s homegrown NGOs, \u003ca href=\"http://www.ayb-sd.org/#history\"\u003eAlashanek Ya Balady\u003c/a\u003e, which is heavily involved in promoting sustainable development in Egypt\u0026rsquo;s poorest neighborhoods. The efforts of AYB and dozens of other organizations constitute a laudable homegrown effort to reform Egyptian society, and they have had lots of success so far.\u003c/p\u003e\n\u003cp\u003eThe queen then went on to decry the current state of civic laziness in the Arab world, saying that many Arabs confuse the responsibilities of \u0026ldquo;citizenship\u0026rdquo; with \u0026ldquo;sitizenship,\u0026rdquo; opting to sit still, sit back, and complain rather than take their own initiative to change society. This is not because Arabs are disconnected, emotionless people—far from it. \u0026ldquo;We\u0026rsquo;re all passionate about food, family, football, and \u003ca href=\"http://en.wikipedia.org/wiki/Palestinian_territories\"\u003eFilistin\u003c/a\u003e,\u0026rdquo; she said, but those passions need to be refocused on bringing about change instead of complacently complaining about the backwardness of Arab governments and societies.\u003c/p\u003e\n\u003cp\u003eShe developed this theme by responding to a series of preselected questions that followed her main motivational speech, declaring that universities and academia are responsible for remaining engaged with society and not remain isolated in academia. Too often the educated class remains cynically aloof from the rest of the world and fails to contribute real change or instill the culture of civic engagement in their pupils. She also noted the role of Islam in developing this culture of engagement, saying that Islam inherently advocates civic reform and grassroots movements. She called on the audience to \u0026ldquo;recapture those compassionate values of Islam\u0026rdquo; that have been hijacked by Western media and use the power of faith to help improve society.\u003c/p\u003e\n\u003cp\u003eEssentially, she concluded, if we want to see any reform and improvement in the region, the onus is on citizens. Change in the Middle East cannot come from governments, since they are inherently inefficient. Real change can only come about with a change in attitude and an increase in engagement. Regular citizens are the driving factor for this change.\u003c/p\u003e\n\u003cp\u003eIn the end it was a pretty motivating and inspiring speech, and I agree with most of what she said. Real, lasting change in the Middle East will need to come from some type of bottom-up popular movement, especially when the reforms so desperately needed reduce the power of the ruling class. However, repressive governments throughout the Arab world (including Rania’s Jordan) severely limit what progressive movements can do, and Middle Eastern dictatorships last for decades.\u003c/p\u003e\n\u003cp\u003eFor example, Egypt’s current president, \u003ca href=\"http://en.wikipedia.org/wiki/Hosni_Mubarak\"\u003eHosni Mubarak\u003c/a\u003e, has been in power for almost 30 years. He ran the country uncontestedly until 2005, when, after pressure from George W. Bush, Mubarak amended the constitution to allow candidates from parties other than the ruling National Democratic Party (NDP) to run in presidential elections. The first “free and fair” elections were held that year. Despite a somewhat large grassroots political opposition movement, \u003ca href=\"http://news.bbc.co.uk/2/hi/middle_east/4709011.stm\"\u003eKifaya\u003c/a\u003e, Mubarak won handily and his opponent, \u003ca href=\"http://en.wikipedia.org/wiki/Ayman_Nour\"\u003eAyman Nour\u003c/a\u003e, was arrested and sentenced to prison for five years. Today Kifaya, a native grassroots movement, is detoothed and powerless. Good thing civic engagement worked…\u003c/p\u003e\n\u003cp\u003eThe next Egyptian presidential elections are slated for 2011, but since Mubarak is getting on in years (he’s 81!), he’s probably not going to run. Instead, it seems that his son, Gamal Mubarak, will inherit his father’s place. Sure, he’ll go through the farce of the election process, but the NDP politicos and thugs will pretty much guarantee his victory.\u003c/p\u003e\n\u003cp\u003eUnderstandably, there is a growing anti-Gamal movement in Egypt, and it’s even homegrown and grassrooty. It got a huge boost last week when \u003ca href=\"http://en.wikipedia.org/wiki/Mohamed_ElBaradei\"\u003eMohamed ElBaradei\u003c/a\u003e, former head of the IAEA and winner of a Nobel Prize, returned to Cairo after a decades-long pseudo-exile. He has announced that he would consider running for president in 2011 if circumstances allowed for it. He already has a large base of support and even an official-ish \u003ca href=\"http://www.elbaradei2011.com/\"\u003ecampaign website\u003c/a\u003e. \u003ca href=\"http://www.npr.org/templates/story/story.php?storyId=124087093\u0026amp;ft=1\u0026amp;f=1009\"\u003eAmerican media\u003c/a\u003e is picking up on him, too. He has a lot of international clout and could present a real threat to the Mubarak dynasty. He might have the potential of becoming the Egyptian Obama—“Yes we can!”\u003c/p\u003e\n\u003cp\u003eBut (and this is a pretty big but…), he can’t even legally run—he’s not constitutionally permitted to run for president. For him to become president, Mubarak would first have to amend the constitution to open the field for more opposition parities. Then ElBaradei would actually have to win in elections run by the NDP. Yeah. Good luck there.\u003c/p\u003e\n\u003cp\u003eWhile the possibility of an ElBaradei run \u003ca href=\"http://baheyya.blogspot.com/2010/02/wildcard_25.html\"\u003ehas Mubarak somewhat scared\u003c/a\u003e, the cards are really stacked against him. This growing popular movement faces the impossible task of forcing a constitutional amendment. It’s a native movement, just like Queen Rania wants, but it is severely limited. Egyptians remain \u003ca href=\"http://egyptianchronicles.blogspot.com/2010/02/elbaradei-let-keep-him-hope.html\"\u003ehopeful\u003c/a\u003e, but sadly, Gamal will most likely take over in 2011.\u003c/p\u003e\n\u003cp\u003eWhile Jordan, as a monarchy, doesn’t face these issues of presidential elections, it has its own slew of problems with citizenship. Although Rania herself is a Palestinian, the Jordanian government \u003ca href=\"http://www.hrw.org/en/news/2010/02/01/jordan-stop-withdrawing-nationality-palestinian-origin-citizens\"\u003eregularly withdraws Jordanian nationality and rights from Palestinian refugees\u003c/a\u003e. How can native, grassroots Jordanian organizations reform when the government makes them stateless?\u003c/p\u003e\n\u003cp\u003eIn her speech Rania exhorted AUCians: “Don’t wait for governments to change and reform. \u003cem\u003eYou\u003c/em\u003e must be the change you want to see.” Um. She’s \u003cem\u003ein\u003c/em\u003e the Jordanian government. She’s the queen! She surely has some influence on the Jordanian political scene. Can’t she help the \u003cem\u003egovernment\u003c/em\u003e change so that these popular groups can actually do something? Arab governments tolerate, even embrace, NGOs like AYB or the queen’s water projects in Jordan—they love this type of civic engagement. But heaven forbid these civically engaged movements threaten their despotic power, though.\u003c/p\u003e\n\u003cp\u003eCan real governmental and societal change happen in the Middle East solely through “civic engagement.” No way. Arab governments must make changes if any popular movements want to make substantial change.\u003c/p\u003e\n\u003cp\u003eSo, while Queen Rania’s speech \u003cem\u003ewas\u003c/em\u003e inspiring and motivational on the surface, it was full of \u003cem\u003ekalaam fadi\u003c/em\u003e—empty words.\u003c/p\u003e\n",
            "date_published": "2010-02-28T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2009/09/23/flashbakectl-released/",
            "url": "https://www.shagunjhaver.com/blog/2009/09/23/flashbakectl-released/",
            "title": "flashbakectl released",
            "summary": "flashbakectl is a handy little script that starts and stops Flashbake by loading and unloading plist files.",
            "content_html": "\u003cp\u003eAdding to my apparent \u003ca href=\"http://www.andrewheiss.com/blog/2009/08/18/itunes-plugin-for-flashbake/\" title=\"iTunes plugin for Flashbake  –   AndrewHeiss.com\"\u003eseries of Flashbake addons\u003c/a\u003e, I\u0026rsquo;ve just released \u003ca href=\"http://github.com/andrewheiss/flashbakectl\" title=\"andrewheiss's flashbakectl at master - GitHub\"\u003e\u003ccode\u003eflashbakectl\u003c/code\u003e\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eNormally to run \u003ca href=\"https://github.com/cmdln/flashbake\" title=\"Home - flashbake - GitHub\"\u003eFlashbake\u003c/a\u003e consistently you need to set up a cron job. While OS X is built on Unix and has cron, Apple recommends using \u003ccode\u003elaunchd\u003c/code\u003e and property list (plist) files to run system agents and daemons. \u003ccode\u003eflashbakectl\u003c/code\u003e is a handy little script that loads and unloads a plist for you.\u003c/p\u003e\n\u003cp\u003eBefore working on your project, run \u003ccode\u003eflashbakectl -l\u003c/code\u003e to load the plist and start the daemon, which will commit your unsaved changes every 15 minutes (or whatever you set it to). When you\u0026rsquo;re done for the day, run \u003ccode\u003eflashbakectl -u\u003c/code\u003e to stop the daemon, saving your computer from unnecessarily running Flashbake \u003cem\u003ead infinitum\u003c/em\u003e.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003eflashbakectl\u003c/code\u003e only works on Mac OS X. \u003ca href=\"http://github.com/andrewheiss/flashbakectl\" title=\"andrewheiss's flashbakectl at master - GitHub\"\u003eYou can get it at GitHub\u003c/a\u003e. Enjoy!\u003c/p\u003e\n",
            "date_published": "2009-09-23T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2009/08/18/itunes-plugin-for-flashbake/",
            "url": "https://www.shagunjhaver.com/blog/2009/08/18/itunes-plugin-for-flashbake/",
            "title": "iTunes plugin for Flashbake",
            "summary": "Flashbake-iTunes is a plugin for Flashbake that allows you to include information for the current track in the periodic git commit message.",
            "content_html": "\u003cp\u003e\u003ca href=\"https://github.com/cmdln/flashbake\" title=\"Home - flashbake - GitHub\"\u003eFlashbake\u003c/a\u003e is a fantastic script \u003ca href=\"http://lifehacker.com/5232049/flashbake-automates-version-control-for-nerdy-writers\" title=\"Flashbake Automates Version Control for (Nerdy) Writers - Downloads - Lifehacker\"\u003efor nerdy writers\u003c/a\u003e (like me) that periodically commits changes to a Git repository and can optionally append various metadata to the commit message, allowing you to \u003ca href=\"http://www.boingboing.net/2009/02/13/flashbake-free-versi.html\" title=\"Flashbake: Free version-control for writers using git - Boing Boing\"\u003eannotate the entire creative process\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eFlashbake includes several plugins for adding recent tweets, weather, the current time zone, and other random information. There\u0026rsquo;s even a plugin for the Banshee music player for Linux. There\u0026rsquo;s nothing for iTunes, however, which is unfortunate since I\u0026rsquo;m always listening to something when I write or code.\u003c/p\u003e\n\u003cp\u003eSo I hacked together a little plugin for Flashbake that uses AppleScript to get the current track information from iTunes and add it to the commit message. It\u0026rsquo;s admittedly a \u0026ldquo;frankenscript\u0026rdquo; and only works on Mac OS X (since it relies on AppleScript), but it works great.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://github.com/andrewheiss/Flashbake-iTunes/\" title=\"andrewheiss's Flashbake-iTunes at master - GitHub\"\u003eYou can get it at GitHub\u003c/a\u003e. Enjoy!\u003c/p\u003e\n",
            "date_published": "2009-08-18T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2009/08/01/using-google-voice-and-gizmo-project-together-internationally/",
            "url": "https://www.shagunjhaver.com/blog/2009/08/01/using-google-voice-and-gizmo-project-together-internationally/",
            "title": "Using Google Voice and Gizmo Project Together",
            "summary": "Description of how to make Google Voice and the Gizmo Project work together with an ATA so that you get a free phone number and almost free phone calls.",
            "content_html": "\u003cdiv class=\"alert alert-info\"\u003eSee update below \u003ca href=\"#update\"\u003e(skip to update)\u003c/a\u003e\u003c/div\u003e\n\u003cp\u003e\u003ca href=\"http://www.google.com/voice\" title=\"Google Voice\"\u003eGoogle Voice\u003c/a\u003e, the Google-ized incarnation of GrandCentral, is a fantastic service that aims to become your virtual phone switchboard. It gives you a free phone number that can receive regular phone calls and route them to any other actual phones you have connected to your account. Powerful stuff.\u003c/p\u003e\n\u003cp\u003eUnfortunately, though, its forwarding abilities are limited to US phones. Using some VoIP magic, though, you can create a semblance of international forwarding and get free (or nearly free) phone calls to the US while abroad. If you\u0026rsquo;re not in a foreign country, you can harness the same VoIP magic to get a nearly free phone service.\u003c/p\u003e\n\u003ch3 id=\"the-gizmo-project---background\"\u003eThe Gizmo Project\u0026mdash;background\u003c/h3\u003e\n\u003cp\u003eGizmo (formerly \u003ca href=\"http://gizmo5.com/pc/\"\u003ehttp://gizmo5.com/pc/\u003c/a\u003e) is normally a \u003ca href=\"http://en.wikipedia.org/wiki/Voip\" title=\"Voice over Internet Protocol - Wikipedia, the free encyclopedia\"\u003eVoIP\u003c/a\u003e provider that lets you make free (or super cheap\u0026mdash;something like $0.019 a minute) phone calls. When you sign up for an account you get a special phone number in the 747 area code as your VoIP/Gizmo username. While any phone on the Gizmo network can call your 747 number for free, regular phones can\u0026rsquo;t connect to it.\u003c/p\u003e\n\u003cp\u003eGizmo offers a Call In service that lets you buy a phone number in most US area codes (or one of dozens of countries), which then lets you receive phone calls from standard phones. Call In numbers start at $35 a year (or $12 a year for three months), but prices can be higher depending on demand.\u003c/p\u003e\n\u003cp\u003eGizmo touts itself primarily as software\u0026mdash;it provides a \u0026ldquo;soft phone\u0026rdquo; program that you run on your computer. As long as the program is open you can make and receive phone calls (much like an IM program or Skype) using a microphone and your computer\u0026rsquo;s speakers or headphones.\u003c/p\u003e\n\u003ch3 id=\"gizmo-without-a-computer\"\u003eGizmo without a computer\u003c/h3\u003e\n\u003cp\u003eIt\u0026rsquo;s impractical to keep your computer on all the time and it can be awkward to use your computer as a phone. You can get around this limitation by buying an \u003ca href=\"http://en.wikipedia.org/wiki/Analog_telephony_adapter\" title=\"Analog telephony adapter - Wikipedia, the free encyclopedia\"\u003eATA adapter\u003c/a\u003e\u0026mdash;a little box that plugs into your network with the sole purpose of running phone services. It\u0026rsquo;s essentially a hardware version of the Gizmo soft phone.\u003c/p\u003e\n\u003cp\u003eFancy corporate VoIP phones (\u003ca href=\"http://en.wikipedia.org/wiki/File:Cisco_7960_IP_Phone.JPG\" title=\"File:Cisco 7960 IP Phone.JPG - Wikipedia, the free encyclopedia\"\u003elike the ubiquitous Cisco ones\u003c/a\u003e) have ATAs built in (kind of. The real ATA is somewhere on the network letting these computer-phones connect to it). You don\u0026rsquo;t need a fancy VoIP phone, though. Standard consumer ATAs let you plug regular phones directly into the adapter.\u003c/p\u003e\n\u003cp\u003eAfter configuring the ATA with your Gizmo information you can make and receive calls using your Call In number. Rather than pay $40+ a month for regular phone service, you can have a fully featured phone that only costs $35 a year plus \u0026lt;$0.02 a minute.\u003c/p\u003e\n\u003ch3 id=\"before-google-voice\"\u003eBefore Google Voice\u003c/h3\u003e\n\u003cp\u003eFor the past three years we\u0026rsquo;ve been using Gizmo as our full-time phone. We bought a \u003ca href=\"https://www.voipsupply.com/linksys-pap2t-na\"\u003eLinksys/Sipura ATA\u003c/a\u003e (our model, the SPA1000 is no longer manufactured), got a $10 phone from Target, and bought a Utah county 801 Call In number. The phone worked perfectly. I could plug the ATA in to any internet connection and get cheap/free phone service.\u003c/p\u003e\n\u003cp\u003eOur system even works (mostly) in Egypt. I have two phones on my desk: the $10 Target phone plugged into the ATA (which is plugged into the router) and a 20 EGP neon pink phone (plugged into our Egyptian phone line). Family, friends, and unsuspecting telemarketers can reach us at our Utah number and pay only what it costs them to call an 801 number.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"current_phone_set_up.jpg\" alt=\"Current phone set up\"\u003e\u003cbr\u003e\n\u003cem\u003eOur current phone set up\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eThe only problem with the system our system in Egypt is a bizarre limitation with Egyptian (or at least Link.net\u0026rsquo;s) internet infrastructure. We don\u0026rsquo;t have any bandwidth issues when someone calls us, but when we call out, the connection drops within the first ten seconds of the call 90% of the time. To get around this, we used some SkypeOut credits\u0026mdash;we\u0026rsquo;d call someone in the States with Skype (using my computer), tell them to call us on our Utah number, hang up, and wait for their call.\u003c/p\u003e\n\u003cp\u003eThis worked when we called actual people, but doesn\u0026rsquo;t work when calling banks, insurance companies, airline companies, or anything else with a phone tree\u0026mdash;phone trees can\u0026rsquo;t call you back. SkypeOut works for those, but it\u0026rsquo;s more expensive than Gizmo.\u003c/p\u003e\n\u003cp\u003eGoogle Voice changes all this.\u003c/p\u003e\n\u003ch3 id=\"enter-gizmo-voice\"\u003eEnter Gizmo Voice\u003c/h3\u003e\n\u003cp\u003eGoogle and Gizmo have joined up to let you hook Google Voice directly into your Gizmo account. Rather than buy a Gizmo Call In number, I can use my free Google Voice number with my Gizmo Account. After following Gizmo\u0026rsquo;s instructions on connecting the two accounts, now when people call my Google Voice number, the call is routed to the normally inaccessible 747 Gizmo number, which is already associated with my ATA box.\u003c/p\u003e\n\u003cp\u003eThis means I can stop paying $35 a year for my Call In number. The only thing I pay for is the phone use itself. Gizmo just changed their phone rates for users using Google Voice\u0026mdash;apparently all calls under three minutes are free, while longer phone calls follow their normal low rates.\u003c/p\u003e\n\u003cp\u003eAdditionally, now that I can have my Gizmo phone connected to my Google Voice account, my bizarre issue with calling out on Egyptian internet can be solved. In order to call people and have your Google Voice phone number appear on their caller IDs, you need to use Google Voice as an intermediary. You type in the number you want to call on their website and they\u0026rsquo;ll call one of your linked phones. When you pick up, your phone will start dialing the outbound number. Since Google calls my Gizmo phone now to make outbound calls, Link.net considers it an inbound call and it doesn\u0026rsquo;t get cut off.\u003c/p\u003e\n\u003cp\u003eSo now, Gizmo combined with Google Voice gives me free short calls and cheap long calls to the US and a free US number that can replace my Gizmo Call In number. Everything works both in the States and internationally. It\u0026rsquo;s a nearly perfect system.\u003c/p\u003e\n\u003ch3 id=\"del-datetime2009-08-03t1854390000still-untesteddel-now-tested\"\u003e\u003cdel datetime=\"2009-08-03T18:54:39+00:00\"\u003eStill untested\u003c/del\u003e Now tested\u0026hellip;\u003c/h3\u003e\n\u003cp\u003eIn theory, since I have my Gizmo and GV accounts linked, my Google Voice number should show up on the recipient\u0026rsquo;s caller ID when I call out with my US phone, circumventing the need to use the Google Voice web site as the middleman. \u003cdel datetime=\"2009-08-03T18:47:13+00:00\"\u003eI can\u0026rsquo;t test it, though, since my internet connection won\u0026rsquo;t let me make any outbound calls with my ATA. I\u0026rsquo;ll keep trying over the next week, since I can make like 10–15 second calls 10% of the time.\u003c/del\u003e\u003c/p\u003e\n\u003cp\u003eIt works! My Google Voice number shows up, just like it should\u0026hellip;\u003c/p\u003e\n\u003ch4 id=\"update\"\u003eUpdate\u003c/h4\u003e\n\u003cp\u003e\u003ca href=\"http://lifehacker.com/5400534/google-acquires-gizmo5-voip-service-voip-coming-to-google-voice\"\u003eGoogle has acquired Gizmo5\u003c/a\u003e, which hopefully means that the link between Gizmo and GV will be more permanent and more official. Awesome.\u003c/p\u003e",
            "date_published": "2009-08-01T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2009/07/30/alexandria-train-crash/",
            "url": "https://www.shagunjhaver.com/blog/2009/07/30/alexandria-train-crash/",
            "title": "Alexandria Train Crash",
            "summary": "Pictures and details of a minor train wreck in Alexandria, Egypt on July 30, 2009.",
            "content_html": "\u003cdiv class=\"alert alert-info\"\u003eSee update below \u003ca href=\"#update\"\u003e(skip to update)\u003c/a\u003e\u003c/div\u003e\n\u003cp\u003eAfter almost a year of being in Egypt, we finally decided to go up to Alexandria today. We took the 9:00 AM train from Cairo and the ride went smooth until we were just outside the final Mahatat Misr station, where we were delayed for over an hour until pulling up to a platform.\u003c/p\u003e\n\u003cp\u003eImmediately after we got off the train we saw the reason for the delay. A train had rammed into the station, apparently at full speed, derailing the first three cars—the engine, the generator, and the first actual cabin. Part of the station itself was damaged, as was, ironically enough, a parked fire truck.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"general_train_wreck_chaos.jpg\"\u003e\u003cimg src=\"general_train_wreck_chaos.jpg\" alt=\"General train wreck chaos\" width=\"600px\" /\u003e\u003c/a\u003e\u003cbr\u003e\n\u003cem\u003eClick to enlarge\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eThe train crashed at around 8 AM and was empty. By 12:30 (when we got there), Egyptian Railway repair crews were lifting the damaged cabin off the tracks.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"detail_of_fire_truck_train_station_damage.jpg\"\u003e\u003cimg src=\"detail_of_fire_truck_train_station_damage.jpg\" alt=\"Detail of fire truck/train station damage\" width=\"600px\" /\u003e\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"silhouette_of_repairs.jpg\"\u003e\u003cimg src=\"silhouette_of_repairs.jpg\" alt=\"Silhouette of repairs\" width=\"600px\" /\u003e\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eBy 6:00 PM, when we arrived back at the station to return to Cairo, the repairmen were working on lifting the engine and had apparently already extricated the generator car.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"detail_of_damaged_engine.jpg\"\u003e\u003cimg src=\"detail_of_damaged_engine.jpg\" alt=\"Detail of damaged engine\" width=\"600px\" /\u003e\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eSince two platforms were out of commission, trains were shuffled around all day, causing major delays. Our train ride back to Cairo took over four hours instead of the usual two.\u003c/p\u003e\n\u003cp\u003eAs far as I know, nobody was killed as the train was empty. I don\u0026rsquo;t know about injuries, since I arrived on the scene several hours after the actual accident.\u003c/p\u003e\n\u003cp\u003eNeedless to say, it was exciting—in a macabre sort of way. I\u0026rsquo;ve read so much about Egyptian train crashes—I got to see the aftermath of one. :)\u003c/p\u003e\n\u003cp\u003e\u003cdel datetime=\"2009-08-01T06:21:25+00:00\"\u003eI'll post the full set of pictures tomorrow on Flickr.\u003c/del\u003e\u003c/p\u003e\n\u003ch4 id=\"update\"\u003eUpdate\u003c/h4\u003e\n\u003cp\u003eI posted our photos of the accident at \u003ca href=\"http://www.flickr.com/photos/andrewheiss/sets/72157621785548829/\"\u003eFlickr\u003c/a\u003e. They are licensed under a \u003ca href=\"http://creativecommons.org/licenses/by/3.0/\"\u003eCreative Commons Attribution license\u003c/a\u003e, so you can use them however you want.\u003c/p\u003e\n\u003cp\u003eNancy has also blogged about the accident at our \u003ca href=\"http://www.heissatopia.com/2009/07/alexandria-train-wreck-30-july-2009.html\"\u003efamily blog\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eAdditionally, the online Egyptian news site Youm7 has \u003ca href=\"http://www.youm7.com/News.asp?NewsID=123211\"\u003eposted an update\u003c/a\u003e (in Arabic). According to their report, the accident was caused by a brake failure as the train travelled from the nearby Sidi Gaber train station. It was indeed empty, fortunately, and there were no fatalities. Two of the crew members were injured in addition to a vendor—since there are snack booths at the end of each platform, he must have gotten smashed. There are conflicting statements as to the cause of the accident. Some claim neglect and disrepair; others sabotage. I\u0026rsquo;m leaning towards neglect—those trains are ancient.\u003c/p\u003e\n",
            "date_published": "2009-07-30T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2009/07/29/installing-pdftk-php/",
            "url": "https://www.shagunjhaver.com/blog/2009/07/29/installing-pdftk-php/",
            "title": "Installing pdftk-php",
            "summary": "A detailed, updated tutorial on how to install, use, and customize pdftk-php.php, which combines the power of pdftk and PHP, allowing you to serve dynamic PDF forms from the web.",
            "content_html": "\u003cp\u003eUpon popular request, I\u0026rsquo;ve decided to update the original tutorial for populating a LiveCycle PDF with PHP to apply to the new release of pdftk-php. The installation instructions should be mostly clear in the readme and in the inline comments in the example included with the script; this post is merely supplemental.\u003c/p\u003e\n\u003ch2 id=\"basic-usage\"\u003eBasic usage\u003c/h2\u003e\n\u003ch3 id=\"initial-set-up\"\u003eInitial set up\u003c/h3\u003e\n\u003cp\u003e\u003ca href=\"http://github.com/andrewheiss/pdftk-php/tree/master\" title=\"andrewheiss's pdftk-php at master - GitHub\"\u003eDownload the most recent version of pdftk-php from GitHub\u003c/a\u003e and \u003ca href=\"http://www.accesspdf.com/pdftk/\" title=\"pdftk - the pdf toolkit\"\u003edownload and install pdftk\u003c/a\u003e on your server.\u003c/p\u003e\n\u003cp\u003eUnzip the download from GitHub and place the folder on your server. I\u0026rsquo;ve placed mine in a folder called \u003ccode\u003epdftk-php\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eCreate a MySQL user and database and run the SQL found in \u003ccode\u003e/example/database.sql\u003c/code\u003e in a MySQL client (like phpMyAdmin) to create the sample database.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"example_query_in_phpmyadmin.png\" alt=\"Example Query in phpMyAdmin\" title=\"Example query in phpMyAdmin\"\u003e\u003c/p\u003e\n\u003cp\u003eModify the information in \u003ccode\u003eexample/_dbConfig.php\u003c/code\u003e so that the application can connect to your database.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-php\" data-lang=\"php\"\u003e$host \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;localhost\u0026#34;\u003c/span\u003e;\n$username \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;pdftk-user\u0026#34;\u003c/span\u003e;\n$password \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;supersecure\u0026#34;\u003c/span\u003e;\n$db_name \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;pdftk-php\u0026#34;\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eBrowse to the example site (in my case, http://localhost/pdftk-php/example/index.php) and add some entries to populate the database a little.\u003c/p\u003e\n\u003ch3 id=\"set-up-the-script\"\u003eSet up the script\u003c/h3\u003e\n\u003cp\u003eOpen \u003ccode\u003epdftk-php.php\u003c/code\u003e and insert the full path to your working pdftk installation at the beginning part of the \u003ccode\u003epassthru()\u003c/code\u003e command near line 71. Here are some examples for different scenarios on server platforms:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-php\" data-lang=\"php\"\u003e\u003cspan style=\"color:#75715e\"\u003e// On a typical Unix-based installation\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003epassthru\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;/usr/local/bin/pdftk ...\u0026#34;\u003c/span\u003e);\n\n\u003cspan style=\"color:#75715e\"\u003e// On Windows, with an absolute path\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003epassthru\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;c:\\pdftk\\pdftk.exe ...\u0026#34;\u003c/span\u003e);\n\n\u003cspan style=\"color:#75715e\"\u003e// On Windows, with a relative path (useful if you place pdftk.exe in the server folder structure)\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003epassthru\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;../pdftk.exe ...\u0026#34;\u003c/span\u003e);\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIf you\u0026rsquo;re on a Unix-based server and don\u0026rsquo;t know where pdftk is, type one of the following commands, which should result in the absolute path to the program:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003ewhich pdftk\n\u003cspan style=\"color:#75715e\"\u003e# or\u003c/span\u003e\nwhereis pdftk\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIn \u003ccode\u003eexample/download.php\u003c/code\u003e verify that the path to the required \u003ccode\u003epdftk-php.php\u003c/code\u003e is correct, near line 18. In the example, \u003ccode\u003epdftk-php.php\u003c/code\u003e is located a directory below the example directory. If you like to store your included files elsewhere, make sure that you modify the \u003ccode\u003erequire()\u003c/code\u003e path here.\u003c/p\u003e\n\u003cp\u003e\u003ccode\u003epdftk-php.php\u003c/code\u003e needs to be able to write to a temporary directory on your server in order to create a temporary FDF file. This directory is specified near line 58, with the \u003ccode\u003etempnam()\u003c/code\u003e function.\u003c/p\u003e\n\u003cp\u003eIf you are on a Windows server you should already be able to write to pretty much any directory (I think… I\u0026rsquo;ve never worked with IIS permissions), so you should be good to go. If you are on a Unix-based server you\u0026rsquo;ll need to be more explicit with directory permissions. To make things easier, create a temporary folder on your server and give it write permissions:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003ecd pdftk-php\nmkdir tmp\nchmod \u003cspan style=\"color:#ae81ff\"\u003e777\u003c/span\u003e tmp\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThen set the path in \u003ccode\u003etempnam()\u003c/code\u003e to the new temporary folder.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-php\" data-lang=\"php\"\u003e\u003cspan style=\"color:#75715e\"\u003e// If at the same level as download.php\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e$fdf_fn \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etempnam\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;tmp\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;fdf\u0026#34;\u003c/span\u003e);\n\n\u003cspan style=\"color:#75715e\"\u003e// If one directory behind download.php\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e$fdf_fn \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etempnam\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;../tmp\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;fdf\u0026#34;\u003c/span\u003e);\n\n\u003cspan style=\"color:#75715e\"\u003e// You can also use an absolute path\n\u003c/span\u003e\u003cspan style=\"color:#75715e\"\u003e\u003c/span\u003e$fdf_fn \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etempnam\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;/Library/WebServer/www/pdftk-php/tmp\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;fdf\u0026#34;\u003c/span\u003e);\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"set-up-the-pdf\"\u003eSet up the PDF\u003c/h3\u003e\n\u003cp\u003eCreate a fillable form in either Acrobat Professional or LiveCycle Designer, or use the included example PDF form. Give each field a unique and significant name so that you can work with the form more easily later on. You can modify field attributes by double clicking on the field using the Forms toolbar in Acrobat; in LiveCycle, use the Object panel.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"acrobat_form_field_options.png\" alt=\"Acrobat Form Field Options\" title=\"Acrobat Form Field Options\"\u003e\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"livecycle_form_field_options.png\" alt=\"LiveCycle Form Field Options\" title=\"LiveCycle Form Field Options\"\u003e\u003c/p\u003e\n\u003cp\u003eIf you are using LiveCycle, you\u0026rsquo;ll need to save the final PDF as a \u003cstrong\u003estatic\u003c/strong\u003e form compatible with Acrobat 7. pdftk doesn\u0026rsquo;t work with dynamic forms or PDFs from later versions of Acrobat.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"livecycle_save_options.png\" alt=\"LiveCycle Save Options\" title=\"LiveCycle Save Options\"\u003e\u003c/p\u003e\n\u003ch3 id=\"connect-pdf-to-script\"\u003eConnect PDF to script\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003eexample/download.php\u003c/code\u003e connects to your database, retrieves a row based on a passed GET variable, saves the data from the fetched row into variables, finally calling \u003ccode\u003epdftk-php.php\u003c/code\u003e, which does the heavy lifting of creating an FDF file and injecting it into the PDF.\u003c/p\u003e\n\u003cp\u003eStarting at around line 30 the script assigns the fetched values to variables. Each of those retrieved variables needs to be paired with a form field in your PDF (near line 39). In a basic Acrobat form this is simple:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-php\" data-lang=\"php\"\u003e$fdf_data_strings\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003earray\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;firstname\u0026#39;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u0026gt;\u003c/span\u003e $pdf_firstname,  \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;lastname\u0026#39;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u0026gt;\u003c/span\u003e $pdf_lastname, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;email\u0026#39;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u0026gt;\u003c/span\u003e $pdf_email);\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eLiveCycle tends to complicate the form names slightly. You can use pdftk from the command line to retrieve the official form field names. Run this command from the directory containing your PDF file:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003epdftk form.pdf dump_data_fields \u0026gt; form-fields.txt\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eWhen you open the resultant \u003ccode\u003e.txt\u003c/code\u003e file you should see a report of all the fields\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003e...\n---\nFieldType: Text\nFieldName: form1[0].#subform[0].firstname[0]\nFieldNameAlt: First name\u0026amp;#9;\nFieldFlags: 0\nFieldJustification: Left\n---\n...\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eUse those long, hairy \u003ccode\u003eFieldName\u003c/code\u003es in the \u003ccode\u003e$fdf_data_strings\u003c/code\u003e array, like so:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-php\" data-lang=\"php\"\u003e$fdf_data_strings\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003earray\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;form1[0].#subform[0].#area[0].FirstName[0]\u0026#39;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u0026gt;\u003c/span\u003e $pdf_firstname, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;form1[0].#subform[0].#area[0].LastName[0]\u0026#39;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u0026gt;\u003c/span\u003e $pdf_lastname, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;form1[0].#subform[0].#area[0].EMail[0]\u0026#39;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u0026gt;\u003c/span\u003e $pdf_email, );\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eFinally, check the values of \u003ccode\u003e$pdf_filename\u003c/code\u003e and \u003ccode\u003e$pdf_original\u003c/code\u003e near lines 62 and 65.\u003c/p\u003e\n\u003cp\u003eGo to http://localhost/pdftk-php/example/view.php and click on the download links for one of entries. You should be prompted to download a PDF file, dynamically generated using \u003ccode\u003epdftk-php.php\u003c/code\u003e. Success!\u003c/p\u003e\n\u003ch2 id=\"advanced-customization\"\u003eAdvanced customization\u003c/h2\u003e\n\u003ch3 id=\"using-checkboxes-or-radio-buttons\"\u003eUsing checkboxes or radio buttons\u003c/h3\u003e\n\u003cp\u003e\u003ccode\u003e$fdf_data_strings\u003c/code\u003e works great for text fields, but can\u0026rsquo;t handle radio buttons or check boxes. For that you\u0026rsquo;ll need to use the \u003ccode\u003e$fdf_data_names\u003c/code\u003e array near line 49.\u003c/p\u003e\n\u003cp\u003e\u003cem\u003eNB: The logic for manipulating the form data in PHP and MySQL might be a little convoluted and could easily be optimized, but it works for clear demonstration purposes.\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eTo demonstrate this how to do this, we\u0026rsquo;ll add a checkbox to our form and extend the database. Run this query in a MySQL client to add a couple columns to our table:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan style=\"color:#66d9ef\"\u003eALTER\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTABLE\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e`\u003c/span\u003eusers\u003cspan style=\"color:#f92672\"\u003e`\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eADD\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e`\u003c/span\u003eoption1\u003cspan style=\"color:#f92672\"\u003e`\u003c/span\u003e TINYINT( \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e ) \u003cspan style=\"color:#66d9ef\"\u003eNOT\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e, \u003cspan style=\"color:#66d9ef\"\u003eADD\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e`\u003c/span\u003eoption2\u003cspan style=\"color:#f92672\"\u003e`\u003c/span\u003e TINYINT( \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e ) \u003cspan style=\"color:#66d9ef\"\u003eNOT\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e ;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eOpen \u003ccode\u003e/example/example.pdf\u003c/code\u003e in Acrobat Professional and add two checkbox fields named \u003ccode\u003eoption1\u003c/code\u003e and \u003ccode\u003eoption2\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"ridiculously_huge_checkboxes_better.png\" alt=\"Huge Checkboxes\" title=\"Ridiculously huge checkboxes\"\u003e\u003c/p\u003e\n\u003cp\u003eWe need to modify our web form and the table that displays the data, just to make sure everything is getting saved to the database correctly.\u003c/p\u003e\n\u003cp\u003eFirst, make a couple changes to \u003ccode\u003eexample/index.php\u003c/code\u003e After the section near lines 104–107, add\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-html\" data-lang=\"html\"\u003e\u0026lt;\u003cspan style=\"color:#f92672\"\u003ep\u003c/span\u003e\u0026gt;\n    \u0026lt;\u003cspan style=\"color:#f92672\"\u003elabel\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efor\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;option1\u0026#34;\u003c/span\u003e\u0026gt;Option 1\u0026lt;/\u003cspan style=\"color:#f92672\"\u003elabel\u003c/span\u003e\u0026gt;\n    \u0026lt;\u003cspan style=\"color:#f92672\"\u003einput\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etype\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;checkbox\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ename\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;option1\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003evalue\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;1\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eid\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;option1\u0026#34;\u003c/span\u003e /\u0026gt;\n\u0026lt;/\u003cspan style=\"color:#f92672\"\u003ep\u003c/span\u003e\u0026gt;\n\u0026lt;\u003cspan style=\"color:#f92672\"\u003ep\u003c/span\u003e\u0026gt;\n    \u0026lt;\u003cspan style=\"color:#f92672\"\u003elabel\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efor\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;option2\u0026#34;\u003c/span\u003e\u0026gt;Option 2\u0026lt;/\u003cspan style=\"color:#f92672\"\u003elabel\u003c/span\u003e\u0026gt;\n    \u0026lt;\u003cspan style=\"color:#f92672\"\u003einput\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etype\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;checkbox\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ename\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;option2\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003evalue\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;1\u0026#34;\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eid\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;option2\u0026#34;\u003c/span\u003e /\u0026gt;\n\u0026lt;/\u003cspan style=\"color:#f92672\"\u003ep\u003c/span\u003e\u0026gt;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThen, up near the top of \u003ccode\u003eexample/index.php\u003c/code\u003e after line 34, add this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-php\" data-lang=\"php\"\u003e\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e ($_POST[\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;option1\u0026#39;\u003c/span\u003e] \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) {\n    $option1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n} \u003cspan style=\"color:#66d9ef\"\u003eelse\u003c/span\u003e {\n    $option1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n}\n\n\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e ($_POST[\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;option2\u0026#39;\u003c/span\u003e] \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) {\n    $option2 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e;\n} \u003cspan style=\"color:#66d9ef\"\u003eelse\u003c/span\u003e {\n    $option2 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e;\n}\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThis checks the value of the submitted checkboxes and sets the \u003ccode\u003e$optionx\u003c/code\u003e variables to either 1 or 0, which fit into the \u003ccode\u003eTINYINT\u003c/code\u003e columns in our table. You could use actual text as well and set the columns to \u003ccode\u003eVARCHAR\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eChange the SQL query from\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-php\" data-lang=\"php\"\u003e$sql \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;INSERT INTO users (firstname, lastname, email) VALUES (\u0026#39;\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e$firstname\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;, \u0026#39;\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e$lastname\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;, \u0026#39;\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e$email\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;)\u0026#34;\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eto\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-php\" data-lang=\"php\"\u003e$sql \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;INSERT INTO users (firstname, lastname, email, option1, option2) VALUES (\u0026#39;\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e$firstname\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;, \u0026#39;\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e$lastname\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;, \u0026#39;\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e$email\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;, \u0026#39;\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e$option1\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;, \u0026#39;\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e$option2\u003c/span\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;)\u0026#34;\u003c/span\u003e;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eGo ahead and insert some dummy submissions with boxes checked and unchecked to make sure everything is working.\u003c/p\u003e\n\u003cp\u003eOptionally we need to modify \u003ccode\u003eexample/view.php\u003c/code\u003e to show the stored values. Add the following table header cells after line 29:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-html\" data-lang=\"html\"\u003e\u003cspan style=\"color:#75715e\"\u003e\u0026lt;!-- Already here --\u0026gt;\u003c/span\u003e\u0026lt;\u003cspan style=\"color:#f92672\"\u003eth\u003c/span\u003e\u0026gt;E-mail Address\u0026lt;/\u003cspan style=\"color:#f92672\"\u003eth\u003c/span\u003e\u0026gt;\n   \u0026lt;\u003cspan style=\"color:#f92672\"\u003eth\u003c/span\u003e\u0026gt;Option 1\u0026lt;/\u003cspan style=\"color:#f92672\"\u003eth\u003c/span\u003e\u0026gt;\n   \u0026lt;\u003cspan style=\"color:#f92672\"\u003eth\u003c/span\u003e\u0026gt;Option 2\u0026lt;/\u003cspan style=\"color:#f92672\"\u003eth\u003c/span\u003e\u0026gt;\n\u003cspan style=\"color:#75715e\"\u003e\u0026lt;!-- Already here --\u0026gt;\u003c/span\u003e\u0026lt;\u003cspan style=\"color:#f92672\"\u003eth\u003c/span\u003e\u0026gt;Download PDF\u0026lt;/\u003cspan style=\"color:#f92672\"\u003eth\u003c/span\u003e\u0026gt;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIn the \u003ccode\u003ewhile\u003c/code\u003e loop a few lines later, add this code:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-html\" data-lang=\"html\"\u003e\u003cspan style=\"color:#75715e\"\u003e\u0026lt;!-- Already here --\u0026gt;\u003c/span\u003e\u0026lt;\u003cspan style=\"color:#f92672\"\u003etd\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#75715e\"\u003e\u0026lt;?php echo $user[\u0026#34;lastname\u0026#34;]; ?\u0026gt;\u003c/span\u003e\u0026lt;/\u003cspan style=\"color:#f92672\"\u003etd\u003c/span\u003e\u0026gt;\n\u0026lt;\u003cspan style=\"color:#f92672\"\u003etd\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#75715e\"\u003e\u0026lt;?php echo ($user[\u0026#39;option1\u0026#39;] == 1) ? \u0026#34;Yes\u0026#34; : \u0026#34;No\u0026#34;; ?\u0026gt;\u003c/span\u003e\u0026lt;/\u003cspan style=\"color:#f92672\"\u003etd\u003c/span\u003e\u0026gt;\n\u0026lt;\u003cspan style=\"color:#f92672\"\u003etd\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#75715e\"\u003e\u0026lt;?php echo ($user[\u0026#39;option2\u0026#39;] == 1) ? \u0026#34;Yes\u0026#34; : \u0026#34;No\u0026#34;; ?\u0026gt;\u003c/span\u003e\u0026lt;/\u003cspan style=\"color:#f92672\"\u003etd\u003c/span\u003e\u0026gt;\n\u003cspan style=\"color:#75715e\"\u003e\u0026lt;!-- Already here --\u0026gt;\u003c/span\u003e\u0026lt;\u003cspan style=\"color:#f92672\"\u003etd\u003c/span\u003e\u0026gt;\u003cspan style=\"color:#75715e\"\u003e\u0026lt;?php echo $user[\u0026#34;email\u0026#34;]; ?\u0026gt;\u003c/span\u003e\u0026lt;/\u003cspan style=\"color:#f92672\"\u003etd\u003c/span\u003e\u0026gt;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThis is just PHP ternary notation, which essentially says that if the value of \u003ccode\u003eoptionx\u003c/code\u003e is equal to one, echo \u0026ldquo;Yes,\u0026rdquo; otherwise, echo \u0026ldquo;No\u0026rdquo;.\u003c/p\u003e\n\u003cp\u003eFinally we need to modify \u003ccode\u003eexample/download.php\u003c/code\u003e to handle our checkboxes. Like I said above, the \u003ccode\u003e$fdf_data_names\u003c/code\u003e variable handles checkbox and radio button data. In PDF forms, the two allowed values for checkboxes are \u0026ldquo;Yes\u0026rdquo; and \u0026ldquo;Off\u0026rdquo; (not really opposites, but oh well), so you\u0026rsquo;ll need to set variables accordingly. Replace \u003ccode\u003e$fdf_data_names = array();\u003c/code\u003e near line 49, with this, which checks the values of \u003ccode\u003eoptionx\u003c/code\u003e and sets \u003ccode\u003e$pdf_optionx\u003c/code\u003e to either \u0026ldquo;Yes\u0026rdquo; or \u0026ldquo;Off\u0026rdquo; and then defines the \u003ccode\u003e$fdf_data_names\u003c/code\u003e array appropriately:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-php\" data-lang=\"php\"\u003e\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e ($data[\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;option1\u0026#39;\u003c/span\u003e] \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) {\n    $pdf_option1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Yes\u0026#34;\u003c/span\u003e;\n} \u003cspan style=\"color:#66d9ef\"\u003eelse\u003c/span\u003e {\n    $pdf_option1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Off\u0026#34;\u003c/span\u003e;\n}\n\n\u003cspan style=\"color:#66d9ef\"\u003eif\u003c/span\u003e ($data[\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;option2\u0026#39;\u003c/span\u003e] \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) {\n    $pdf_option2 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Yes\u0026#34;\u003c/span\u003e;\n} \u003cspan style=\"color:#66d9ef\"\u003eelse\u003c/span\u003e {\n    $pdf_option2 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Off\u0026#34;\u003c/span\u003e;\n}\n\n$fdf_data_names \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003earray\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;option1\u0026#39;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u0026gt;\u003c/span\u003e $pdf_option1, \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;option2\u0026#39;\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e=\u0026gt;\u003c/span\u003e $pdf_option2);\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAnd that should do it! Visit http://localhost/pdftk-php/example/view.php and download one of the forms. The checkboxes should populate perfectly.\u003c/p\u003e\n\u003ch3 id=\"other-types-of-form-fields\"\u003eOther types of form fields\u003c/h3\u003e\n\u003cp\u003eCombo boxes and radio buttons act similarly to checkboxes. If you run the \u003ccode\u003edump_data_fields\u003c/code\u003e command with pdftk again on a form with these more advanced options, you\u0026rsquo;ll see a few differences in the results.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003eFieldType: Text\nFieldName: email\nFieldFlags: 0\nFieldJustification: Left\n---\nFieldType: Button\nFieldName: option1\nFieldFlags: 0\nFieldValue: Yes\nFieldJustification: Left\nFieldStateOption: Off\nFieldStateOption: Yes\n---\nFieldType: Choice\nFieldName: favoriteColor\nFieldFlags: 131072\nFieldValue: blue\nFieldValueDefault: red\nFieldJustification: Left\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eYou can see the \u0026ldquo;Yes\u0026rdquo; vs. \u0026ldquo;Off\u0026rdquo; values in our checkbox (called \u0026ldquo;Button\u0026rdquo; in PDF lingo). Drop down lists (\u0026ldquo;Choice\u0026rdquo; in PDF-speak) have multiple values, specified by you when you create the field.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"combo_box_properties.png\" alt=\"Combo box properties\" title=\"Sample combo box properties in Acrobat\"\u003e\u003c/p\u003e\n\u003cp\u003eRadio buttons are hybrids. They are considered \u0026ldquo;Buttons,\u0026rdquo; like checkboxes, but can have custom values, like drop down lists.\u003c/p\u003e\n\u003cp\u003eYour final PHP script will need to take these different values into account and assign the correct values in the \u003ccode\u003e$fdf_data_names\u003c/code\u003e array.\u003c/p\u003e\n\u003ch2 id=\"conclusion\"\u003eConclusion\u003c/h2\u003e\n\u003cp\u003eYou can do a ton with the \u003ccode\u003epdftk-php.php\u003c/code\u003e class once you get it set up initially and get past the slight learning curve. If you have any questions, feel free to ask in the comments. If you find any problems, comment here or \u003ca href=\"http://github.com/andrewheiss/pdftk-php/issues\" title=\"Issues - andrewheiss/pdftk-php - GitHub\"\u003eopen an issue at the GitHub project page\u003c/a\u003e. Additionally, you can \u003ca href=\"http://github.com/andrewheiss/pdftk-php/tree/master\" title=\"andrewheiss's pdftk-php at master - GitHub\"\u003efork the project\u003c/a\u003e and contribute.\u003c/p\u003e\n\u003cp\u003eGood luck!\u003c/p\u003e\n",
            "date_published": "2009-07-29T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2009/07/28/on-narrowing-and-redefining-research/",
            "url": "https://www.shagunjhaver.com/blog/2009/07/28/on-narrowing-and-redefining-research/",
            "title": "On narrowing and redefining research",
            "summary": "After a year of deliberation, I may have finally decided what to write about for my thesis.",
            "content_html": "\u003cp\u003eI\u0026rsquo;ve been in Egypt for almost a year now, studiously working towards my MA in Middle East Studies. The supposed capstone of my time here at AUC—my thesis—now looms ahead somewhat menacingly. I get to spend the next several months researching and writing what will end up being my largest research project to date. It\u0026rsquo;ll also set the foundation for my (hopefully) future PhD plans.\u003c/p\u003e\n\u003cp\u003eThere\u0026rsquo;s only one problem: I don\u0026rsquo;t quite know what I\u0026rsquo;m writing it on.\u003c/p\u003e\n\u003cp\u003eAt BYU I double majored in Middle East Studies/Arabic (MESA) and Italian—an odd mix of modern history, political science, and renaissance poetry. Most of my research focused on finding literary and historic connections between the Middle East and Italy. I looked at the role of Sufism in the birth of Catholic mysticism, especially with Jacopone da Todi and St. Francis of Assisi. I looked at the Young Ottomans and their reliance on Mazzini\u0026rsquo;s \u003cem\u003eGiovine Italia\u003c/em\u003e ideology. I even \u003ca href=\"http://www.heissatopia.com/2007/03/symposium-humanitatum-2007.html\" title=\"Heissatopia: Symposium Humanitatum 2007\"\u003epresented a paper\u003c/a\u003e at a conference about the role of Mohammed in \u003cem\u003eInferno XXVIII\u003c/em\u003e in Dante\u0026rsquo;s \u003cem\u003eDivine Comedy,\u003c/em\u003e connecting it to proto-orientalism.\u003c/p\u003e\n\u003cp\u003eFun times :)\u003c/p\u003e\n\u003cp\u003eAt the same time, though, there was an inherent conflict in my research interests. I wrote my MESA capstone paper on the media coverage of the 2006 Israel/Lebanon war, where no Italian literature was involved :). I love media—I\u0026rsquo;m obsessed with the news, the internet, blogs, Twitter; anything shiny, new, and exciting.\u003c/p\u003e\n\u003cp\u003eI started my MA with the assumption that I\u0026rsquo;d have to choose one of these tracks—history or media. I dove headlong into the history track, writing a huge literature review on the history of the Italians in Egypt at the beginning of the 20th century. Large Italian communities in Cairo, Alexandria, and Ismailiyya sprang up after Napoleon\u0026rsquo;s 1798 invasion. Thousands of Italians were born and raised abroad in these cities, and many took part in the Egyptian nationalist movement, considering themselves more Egyptian than Italian, thus earning themselves the nickname \u003cem\u003emutamasirun\u003c/em\u003e (those who try to be Egyptian).\u003c/p\u003e\n\u003cp\u003eI was excited about this research until a new shiny thing took my attention away—Twitter. I started using Twitter more or less full time in January, which then introduced me to the large Egyptian Twitter community. Many of the Egyptian twitterers are also activist bloggers who have been arrested multiple times. I began to see the power and potential of the internet in political reform and change in the Middle East and switched research gears to focus on the Middle Eastern blogosphere. It was fascinating stuff, but I felt like I had turned my back on history :) Further complicating things, I had an amazing history seminar last semester that resulted in some awesomely fun archival research. I had a blast writing the paper. The primeval dichotomy of history vs. media reared its ugly head again.\u003c/p\u003e\n\u003cp\u003eSince I\u0026rsquo;m nearing the end of my MA, I\u0026rsquo;m looking at different PhD programs to go to once I\u0026rsquo;m done here. There are lots that look at bloggers and politics—even ones that look at bloggers and politics and the Middle East—but none do it with a historical approach (fancy that\u0026hellip; blogs have been around for something like four years and it\u0026rsquo;s not history yet :) ). I sent out dozens of e-mails to different professors asking about graduate programs and my potential research. Most responses were confused; \u003ccode\u003ehistory != new media\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eHowever, one professor at Cornell responded positively. He studies media in modern Egyptian history, specifically in the time period of my Italian \u003cem\u003emutamasirun\u003c/em\u003e.\u003c/p\u003e\n\u003cp\u003eI think I may have found a way to bridge the history/media studies gap. Now I just need to figure out exactly how to do it.\u003c/p\u003e\n\u003cp\u003eAwesome. :)\u003c/p\u003e\n\u003cp\u003eSo, sorry bloggers—I\u0026rsquo;ll keep following you as a tangential fascination, but my heart lies in history.\u003c/p\u003e\n",
            "date_published": "2009-07-28T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2009/07/19/converting-a-blogger-blog-to-indesign-tagged-text/",
            "url": "https://www.shagunjhaver.com/blog/2009/07/19/converting-a-blogger-blog-to-indesign-tagged-text/",
            "title": "Import a Blogger Blog to InDesign with Perl",
            "summary": "This Perl script lets you take a backed-up Blogger XML file and convert it to an InDesign Tagged Text file for book layout.",
            "content_html": "\u003cp\u003eOur family has a fairly sizable \u003ca href=\"http://www.heissatopia.com\" title=\"Heissatopia\"\u003eblog\u003c/a\u003e that we (actually, mostly my wife, Nancy) have kept updated for several years. Since it contains so much family history we wanted an easy way to preserve it in print form, just in case Blogger gets the boot from Google some day (not that that will ever really happen…).\u003c/p\u003e\n\u003cp\u003eSince we\u0026rsquo;re both hobbyist graphic designers—I taught a couple print layout and design classes as an undergrad at BYU and have made several books at \u003ca href=\"http://www.lulu.com\" title=\"Lulu.com\"\u003eLulu.com\u003c/a\u003e—we decided to layout and print each year of our blog, to keep for posterity.\u003c/p\u003e\n\u003cp\u003eA couple years ago Nancy attempted this with our smaller \u003ca href=\"http://andrewheiss.blogspot.com\" title=\"Adventures in Jordan\"\u003eJordan blog\u003c/a\u003e for a print publishing class she took at BYU. We spent the bulk of our time manually copying and pasting each post and the subsequent comments into a huge Word document. She then ran a long series of find/replaces to clean up the messy, inconsistent typography, and then finally placed it into Quark (that evil program). Through a series of unfortunate events, Quark crashed repeatedly and corrupted her file multiple times—she was lucky to get her first draft turned in for her final project (she got an A, though. Phew!).\u003c/p\u003e\n\u003cp\u003eI knew there had to be a faster, more efficient way to wrangle all the blog text, but this was back in 2006, before Blogger had an open API or options to backup a blog. Primitive, dark days indeed :).\u003c/p\u003e\n\u003cp\u003eHowever, last year, Blogger introduced a fantastic new option—the ability to backup and export your entire blog, comments and all. Blogger spits out an Atom-formatted XML file that you can use to recreate your blog later on (or possibly import onto other platforms, like WordPress, I think). This was the key to simplifying the daunting task of collecting the text for our blog books. All we needed was a way to mangle the text in the XML file to create an InDesign-ready file.\u003c/p\u003e\n\u003cp\u003eSo, I whipped up a semi-complicated Perl script that can parse an Atom-formatted XML file from Blogger and create a text file using InDesign Tagged Text to preapply paragraph and character styles. It also cleans up the typographic elements of the text, adding em and en dashes, removing empty paragraphs, etc. Additionally, it can add hidden index entries for each tag, essentially creating a barebones index for your book. And it only takes 10ish seconds to run on a large blog. It\u0026rsquo;s not perfect and could stand some good optimization, but it works.\u003c/p\u003e\n\u003cp\u003eAdditionally, since InDesign tagged text works with, well, text, it won\u0026rsquo;t place your images for you. Instead it will insert the location of the image (the \u003ccode\u003esrc=whatever.jpg\u003c/code\u003e of the \u003ccode\u003eimg\u003c/code\u003e tags) in between curly braces \u003ccode\u003e{ }\u003c/code\u003e. You\u0026rsquo;ll then need to manually place all the images later, deleting the braced text.\u003c/p\u003e\n\u003cp\u003eIn the future, the script could be changed to output XML, which does let you include pictures, but you\u0026rsquo;d have to have all your images on your hard drive already. The script could go and download all the linked images, but it\u0026rsquo;s not really a good idea to place low resolution, web-optimized images in a print document. In our case we have high-res copies of all the pictures on the blog stored on an external hard drive, so we just have to go and find and place the images we want. It takes more time, but it makes better quality documents in the end.\u003c/p\u003e\n\u003cp\u003eAlso, links are preserved as footnotes—all \u003ccode\u003ehref=\u0026quot;whatever.html\u0026quot;\u003c/code\u003es show up as the footnote text.\u003c/p\u003e\n\u003ch3 id=\"how-to-use-the-script\"\u003eHow to use the script\u003c/h3\u003e\n\u003cp\u003eFirst, download the script and its supporting files from \u003ca href=\"http://github.com/andrewheiss/Blogger-XML-to-InDesign/tree/master\" title=\"andrewheiss's Blogger-XML-to-InDesign at master - GitHub\"\u003eGithub\u003c/a\u003e. If you\u0026rsquo;re using Mac OS or Linux, make sure the main script file, \u003ccode\u003eformat_for_id.pl\u003c/code\u003e is executable—type \u003ccode\u003echmod +x format_for_id.pl\u003c/code\u003e at the terminal.\u003c/p\u003e\n\u003cp\u003eNext, make sure you have Perl installed on your system. If you are using Linux or Mac OS X, you\u0026rsquo;re good to go. If you\u0026rsquo;re using Windows, download and install \u003ca href=\"http://strawberryperl.com/\" title=\"Strawberry Perl\"\u003eStrawberry Perl for Windows\u003c/a\u003e. You can also use \u003ca href=\"http://www.activestate.com/activeperl/\" title=\"ActivePerl\"\u003eActivePerl\u003c/a\u003e, but installing modules is a little more difficult.\u003c/p\u003e\n\u003cp\u003eThe script uses several additional \u003ca href=\"http://en.wikipedia.org/wiki/Cpan\" title=\"CPAN - Wikipedia, the free encyclopedia\"\u003eCPAN modules\u003c/a\u003e that you\u0026rsquo;ll need to install. You\u0026rsquo;ll need to use the CPAN shell to do so.\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003eOn Windows with Strawberry Perl: open the packaged CPAN client in the Start Menu folder\u003c/li\u003e\n\u003cli\u003eOn Windows with ActivePerl: Good luck. There is a large repository of specially compiled CPAN modules for ActiveState, and reportedly there is a kind of CPAN shell, but I haven\u0026rsquo;t gotten either to work too well. Stick with Strawberry Perl. It\u0026rsquo;s better :)\u003c/li\u003e\n\u003cli\u003eOn Mac OS X: type \u003ccode\u003eperl -MCPAN -e shell\u003c/code\u003e at a terminal window\u003c/li\u003e\n\u003cli\u003eOn Linux: type \u003ccode\u003esudo cpan\u003c/code\u003e at a terminal window\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003e(If it\u0026rsquo;s your first time running the CPAN shell you\u0026rsquo;ll be asked to configure the installation environment. Choose the option to automatically configure everything.)\u003c/p\u003e\n\u003cp\u003eOnce everything is set up and you see the \u003ccode\u003ecpan\u0026gt;\u003c/code\u003e shell prompt, type \u003ccode\u003einstall Package::Name\u003c/code\u003e (eg. \u003ccode\u003einstall Date::Format\u003c/code\u003e) for each of the dependent CPAN packages listed at the beginning of \u003ccode\u003eformat_for_id.pl\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eLog in to your \u003ca href=\"http://www.blogger.com/home\" title=\"Blogger.com\"\u003eBlogger Dashboard\u003c/a\u003e and export your blog as an XML file by going to Settings \u0026gt; Basic \u0026gt; Export blog. Place the XML file in the script folder.\u003c/p\u003e\n\u003cp\u003eOpen \u003ccode\u003econfig.cfg\u003c/code\u003e with a text editor and change the settings as needed. Set the input file to your newly downloaded XML file, choose the year you want to extract, set an output file, and set the file header, either \u0026lt;\u003ccode\u003eUNICODE-MAC\u003c/code\u003e\u0026gt; or \u0026lt;\u003ccode\u003eUNICODE-WIN\u003c/code\u003e\u0026gt;, depending on what platform you use InDesign on.\u003c/p\u003e\n\u003cp\u003eFor now, leave all the style tags as they are so you can place the text into the example InDesign file and see how everything works. You can change them later and rerun the script\u003c/p\u003e\n\u003cp\u003eFinally, using the terminal or command prompt, navigate to the folder with the script and and run it by typing \u003ccode\u003eperl format_for_id.pl\u003c/code\u003e. If everything goes well you should have an output file at the location you specified, full of InDesign tags.\u003c/p\u003e\n\u003cp\u003eOpen up \u003ccode\u003eExample.indd\u003c/code\u003e in InDesign CS3 or above and place the generated text file. All the text should come in perfectly with all the needed paragraph and character styles applied. Bravo!\u003c/p\u003e\n\u003ch3 id=\"advanced-usage\"\u003eAdvanced usage\u003c/h3\u003e\n\u003cp\u003eObviously you\u0026rsquo;ll want to make some changes to the format of the output text. You might not want the post URL right after the tag—you might want it at the end, or not want it at all. With a little knowledge of Perl, you can edit the main script directly, mostly the \u003ccode\u003ecombineSortClean()\u003c/code\u003e sub near the end of the script, to change the order of the output elements.\u003c/p\u003e\n\u003cp\u003eYou can also disable tag indexing and allow the tags to be output with a paragraph style. Just comment and uncomment the appropriate sections in the code. The same goes for the author-specific character styles—comment and uncomment the needed lines in the script.\u003c/p\u003e\n\u003cp\u003eYou can rename the styles and use your own—just make sure the styles exist in your InDesign document before you place the output file. InDesign will throw away any tags that don\u0026rsquo;t already exist in the document.\u003c/p\u003e\n\u003cp\u003eI made the script for our specific blog, so it doesn\u0026rsquo;t take every possible paragraph or character style into account. If you want additional functionality, you\u0026rsquo;ll have to add it. Feel free to fork the project off of GitHub and add to/improve it. That\u0026rsquo;s why it\u0026rsquo;s open source :)\u003c/p\u003e\n\u003cp\u003eIf you have any questions, ask in the comments. Report any issues at the \u003ca href=\"http://github.com/andrewheiss/Blogger-XML-to-InDesign/issues\" title=\"Issues - andrewheiss/Blogger-XML-to-InDesign - GitHub\"\u003eproject GitHub page\u003c/a\u003e. I\u0026rsquo;ll try to respond quickly—I generally do, as evidenced by my \u003ca href=\"/blog/2007/10/06/populating-a-livecycle-pdf-with-php-and-mysql/\" title=\"Populating a LiveCycle PDF with PHP and MySQL  –   AndrewHeiss.com\"\u003epdftk-php project\u003c/a\u003e :)\u003c/p\u003e\n\u003cp\u003eGood luck!\u003c/p\u003e\n",
            "date_published": "2009-07-19T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2009/06/19/pdftk-php-officially-released/",
            "url": "https://www.shagunjhaver.com/blog/2009/06/19/pdftk-php-officially-released/",
            "title": "pdftk-php Officially Released",
            "summary": "After almost two years, I've officially developed and released pdftk-php--a script that lets you inject form data into a PDF with PHP.",
            "content_html": "\u003cp\u003eWow. It\u0026rsquo;s been almost two years since I wrote \u003ca href=\"/blog/2007/10/06/populating-a-livecycle-pdf-with-php-and-mysql/\" title=\"Populating a LiveCycle PDF with PHP and MySQL\"\u003ea little tutorial\u003c/a\u003e on how to use LiveCycle, PHP, and MySQL together to make a web application that served dynamic PDF forms. Since then it has become the number one page on this site. I still get a substantial number of comments a week here on the blog and via e-mail—many of those comments are stuck in my inbox, sent to me before I rebuilt my site on WordPress and enabled commenting.\u003c/p\u003e\n\u003cp\u003eUnfortunately, though, I wrote that tutorial as my first foray into the world of PHP/MySQL web development and had little idea of what I was really doing. Since then, however, I\u0026rsquo;ve done a fair amount of real-world web design and development, and even implemented this pdftk form system into a live, public-facing \u003ca href=\"http://mmlab.lib.byu.edu\" title=\"HBLL Multimedia Lab\"\u003eapplication\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eIn the interim, I\u0026rsquo;ve refined my system and released it as an open source PHP class, named \u003ca href=\"http://github.com/andrewheiss/pdftk-php/\" title=\"pdftk-php on GitHub\"\u003e\u003ccode\u003epdftk-php\u003c/code\u003e\u003c/a\u003e. The project is hosted at \u003ca href=\"http://github.com\" title=\"GitHub\"\u003eGitHub\u003c/a\u003e, a brilliant hosting service for collaborative projects, which uses Git, the best version control software I\u0026rsquo;ve ever used. Anyone can check out, or clone, the project, make any edits to the core set of classes, and merge those with the main project branch—it is now a true community project. If you don\u0026rsquo;t want to contribute, you can still \u003ca href=\"http://github.com/andrewheiss/pdftk-php/downloads\" title=\"Download pdftk-php at GitHub\"\u003edownload it from GitHub\u003c/a\u003e as a \u003ccode\u003e.zip\u003c/code\u003e or \u003ccode\u003e.tar\u003c/code\u003e file.\u003c/p\u003e\n\u003cp\u003eIncluded in the project is a (hopefully) extensively documented example application that you can set up on your own server.\u003c/p\u003e\n\u003cp\u003eI\u0026rsquo;m working on writing a new step-by-step tutorial on how to set everything up, akin to the old one. In theory, the new \u003ccode\u003epdftk-php\u003c/code\u003e should work with PDFs created in any program, not just LiveCycle. In the meantime, download \u003ccode\u003epdftk-php\u003c/code\u003e, try it out, and report any bugs here on the blog or \u003ca href=\"http://github.com/andrewheiss/pdftk-php/issues\" title=\"Report an issue at GitHub\"\u003edirectly at GitHub\u003c/a\u003e (where I hope to keep everything related to \u003ccode\u003epdftk-php\u003c/code\u003e from now on). Fork the project and contribute if you feel like it, too!\u003c/p\u003e\n\u003cp\u003eThanks and good luck!\u003c/p\u003e\n",
            "date_published": "2009-06-19T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2009/05/14/a-tale-of-three-taxis/",
            "url": "https://www.shagunjhaver.com/blog/2009/05/14/a-tale-of-three-taxis/",
            "title": "A Tale of Three Taxis",
            "summary": "Traffic in Cairo is horrible, especially when all the taxi drivers, the ubiquitous life-blood of the Egyptian streets, have a deathwish for you.",
            "content_html": "\u003cp\u003eTraffic in Cairo is horrible, especially when all the taxi drivers, the ubiquitous life-blood of the Egyptian streets, have a deathwish for you.\u003c/p\u003e\n\u003cp\u003eRead about my recent near misses at my post at our family blog, \u003ca href=\"http://www.heissatopia.com/2009/05/tale-of-three-taxis.html\" title=\"Heissatopia: A tale of three taxis\"\u003eHeissatopia\u003c/a\u003e.\u003c/p\u003e\n",
            "date_published": "2009-05-14T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2009/05/01/google-profile-business-cards/",
            "url": "https://www.shagunjhaver.com/blog/2009/05/01/google-profile-business-cards/",
            "title": "Google Profile Business Cards",
            "summary": "I got 25 Google Profile business cards for free. Woot!",
            "content_html": "\u003cp\u003eLook what I just ordered, for free:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"google-profile-business-card.png\" alt=\"Google Profile Business Card\"\u003e\u003c/p\u003e\n\u003cp\u003eAwesome :)\u003c/p\u003e\n\u003cp\u003eGoogle is giving packs of 25 of these away for free to promote their new \u003ca href=\"http://www.google.com/profiles/andrewheiss\" title=\"Andrew Heiss - Google Profile\"\u003eGoogle Profiles\u003c/a\u003e service. I think the profile idea is great—it makes finding people online so much easier and \u003ca href=\"http://lifehacker.com/5221323/google-profiles-give-you-control-over-what-google-says-about-you\" title=\"Lifehacker - Google Profiles Give You Control Over What Google Says About You - Google Profiles\"\u003egives you more control over what Google says about you.\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eToo bad I won\u0026rsquo;t get these until August when my mother-in-law comes to visit.\u003c/p\u003e\n",
            "date_published": "2009-05-01T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2009/04/26/typing-transliterated-arabic-quickly/",
            "url": "https://www.shagunjhaver.com/blog/2009/04/26/typing-transliterated-arabic-quickly/",
            "title": "Typing transliterated Arabic quickly",
            "summary": "Use text-replacement software to automate Arabic transliteration.",
            "content_html": "\u003cp\u003eSince Arabic doesn\u0026rsquo;t use the Latin alphabet, and lots of the letters don\u0026rsquo;t have Latin equivalents (خ, ع, ق, ط, for example), transliteration is necessary to show Arabic words and sounds in English writing. There is an easy way to type transliterated Arabic quickly, though, using macros to locate hidden Unicode characters used by many of the standard transliteration systems.\u003c/p\u003e\n\u003cp\u003eUnfortunately, there is no universally standard system for transliteration, and most systems use letters that aren\u0026rsquo;t found on normal keyboards. One of the rising systems in the Middle East, nicknamed \u003ca href=\"http://en.wikipedia.org/wiki/Arabic_Chat_Alphabet\"\u003eFranco Arab\u003c/a\u003e in Egypt, is my least favorite. It only uses standard English letters, meaning it\u0026rsquo;s useful for texting, e-mailing, and other things where it\u0026rsquo;s difficult to write in real Arabic script. Biggest problem: it\u0026rsquo;s ugly and hard to read.\u003c/p\u003e\n\u003cp\u003eFor example, the name Great Britain (بريطانيا العظمى) uses several non-Latin letters. Written in Franco it looks like this: \u003cem\u003ebri6ania al3o'6ma\u003c/em\u003e. For readers unfamiliar with Arabic (or even those who are, like me), it\u0026rsquo;s always hard to remember what the random uppercase letters and numbers mean.\u003c/p\u003e\n\u003cp\u003eFortunately, there are better systems. Here\u0026rsquo;s Great Britain written using the \u003ca href=\"https://www.cambridge.org/core/journals/international-journal-of-middle-east-studies/information/author-resources/ijmes-translation-and-transliteration-guide\"\u003eIJMES\u003c/a\u003e (International Journal of Middle East Studies) \u003ca href=\"https://www.cambridge.org/core/services/aop-file-manager/file/57d83390f6ea5a022234b400/TransChart.pdf\"\u003esystem\u003c/a\u003e, also used in the Encyclopedia of Islam: \u003cem\u003eBrīṭānīyā al-ʿuẓmá\u003c/em\u003e. Much easier to read.\u003c/p\u003e\n\u003cp\u003eSince the nonstandard Latin letters use Unicode glyphs, you need to use a font that has a full set of Unicode glyphs, like Times, Arial, Helvetica, and other standard fonts. You also have to hunt down all the special characters either in Word\u0026rsquo;s Insert Special Character dialog or in the Glyphs panel in InDesign.\u003c/p\u003e\n\u003cp\u003eYou can speed up the process of hunting for and inserting special characters by using a text substitution app like \u003ca href=\"http://lifehacker.com/software/texter/lifehacker-code-texter-windows-238306.php\"\u003eTexter\u003c/a\u003e for Windows (free, \u003ca href=\"http://github.com/adampash/texter/tree/master\"\u003eopen source\u003c/a\u003e) or \u003ca href=\"http://www.ergonis.com/products/typinator/\"\u003eTypinator\u003c/a\u003e for Mac (not free). These programs can replace abbreviations that you type with preset phrases. For example, if you wanted to quickly type today\u0026rsquo;s date you could set up a shortcut that would replace %date with the full date.\u003c/p\u003e\n\u003cp\u003eI set up a list of text replacements in my copy of Typinator that automatically change certain combinations of characters into IJMES standard transliterated rules. Here\u0026rsquo;s my list of text transformation rules (all with the prefix -ij, short for IJMES):\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e-ij'\u003c/code\u003e = ʿ\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e-ij`\u003c/code\u003e = ʾ\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e-ija\u003c/code\u003e = ā\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e-ijd\u003c/code\u003e = ḍ\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e-ijh\u003c/code\u003e = ḥ\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e-iji\u003c/code\u003e = ī\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e-ijs\u003c/code\u003e = ṣ\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e-ijt\u003c/code\u003e = ṭ\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e-iju\u003c/code\u003e = ū\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e-ijz\u003c/code\u003e = ẓ\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eHere\u0026rsquo;s a (very) quick example of this in action:\u003c/p\u003e\n\u003cdiv class=\"video-responsive\"\u003e\n\u003ciframe class=\"videoplayer\" src=\"https://player.vimeo.com/video/4337233\" frameborder=\"0\" allow=\"autoplay; fullscreen\" allowfullscreen\u003e\u003c/iframe\u003e\n\u003c/div\u003e\n\u003cp\u003eYou could set up similar rules for transliteration with different systems (even Franco), or even different languages. Typing IJMES transliterated words for academic papers just got infinitely easier.\u003c/p\u003e\n\u003cdiv class=\"alert alert-warning\"\u003e\nYou will probably only want to use IJMES transliteration in print because of font encoding issues on different platforms and browsers. For online text you'll have to stick with Franco or something like it.\n\u003c/div\u003e\n",
            "date_published": "2009-04-26T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2009/03/18/libya-obsolete-paradigms-and-rip-van-winkle/",
            "url": "https://www.shagunjhaver.com/blog/2009/03/18/libya-obsolete-paradigms-and-rip-van-winkle/",
            "title": "Libya, obsolete paradigms, and Rip Van Winkle",
            "summary": "Lisa Anderson's research of political systems in Libya reveals that standard Middle East Studies paradigms don't fully apply.",
            "content_html": "\u003cp\u003eI’m still experimenting with what I’m going to blog about here. I’m thinking of sticking with an odd mixture of technology and academia, which might work out well since I’m considering doing my upcoming thesis on technology in the Middle East, specifically blogging. So, here’s a purely academic post to start things off.\u003c/p\u003e\n\u003cp\u003eOn Tuesday Dr. Lisa Anderson, AUC’s Provost and former professor at Columbia University, came to speak at a faculty seminar at the Middle East Studies Center. She’s a political scientist by training and started her academic career by studying Libya. Her talk focused on the role of traditional social studies disciplines in the study of the Middle East.\u003c/p\u003e\n\u003cp\u003eGeneral social studies separated into more specialized disciplines in the early 1900s as progressive governments in the US and Europe became increasingly interested in understanding the dynamics of the social “here and now.” New disciplines of social studies emerged with the explicit purpose of improving governance, public administration, and economy. Economists researched and theorized how to stabilize and grow a capitalist economy; political scientists looked at the processes that created a stable democracy; sociologists tackled the dynamics of the changing progressive societies. Social scientists not explicitly concerned with the issues of “here and now” also emerged; those not interested in “here” entered anthropology while those not interested in “now” created the discipline of history.\u003c/p\u003e\n\u003cp\u003eOver the past century, scholarship in these disciplines has been rather entrenched along this foundational paradigm: research to improve capitalism and democracy. Because of this disciplinary emphasis and paradigm of US/Western-style economics and political systems, any research on other systems of government or economies are always done in terms of the “Western” social science paradigm.\u003c/p\u003e\n\u003cp\u003eFor example, every class I’ve taken on Middle East politics always focuses on the processes of democratization and the persistence of authoritarianism. Elections (fair or not), development of civil society, the emergence of political parties—these are signs of “political development” for a political scientist. Economists look at how liberalized a state’s economy is—how open for investment and primed for capitalism it is. In a way, strict disciplinary social studies of societies outside the US and Europe seem to place other countries on a linear progressive timeline; studies of Egyptian politics reveal how democratized Egypt is or isn’t.\u003c/p\u003e\n\u003cp\u003eNot all countries—not even Egypt—fit into this standard disciplinary framework. Did Nasser really care if his Arab Socialist revolution fit into a future program of democratization? No way. He didn’t even think of it. Arab political scientists don’t generally look at it that way.\u003c/p\u003e\n\u003cp\u003eThis theme of trying to fit the Middle Eastern peg in the academic square is well pronounced in Libya, which, because international sanctions for the past few decades, has been pretty isolated. According to Dr. Anderson, the case of Libya shows the limits of traditional Western social sciences.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"http://en.wikipedia.org/wiki/Muammar_al-Qaddafi\"\u003eMuammar Qaddafi\u003c/a\u003e, the crazy Libyan dictator surrounded by \u003ca href=\"http://lallalydia.blogspot.com/2007/12/modern-day-amazons-colonel-qaddafis.html\"\u003efemale bodyguards\u003c/a\u003e and who \u003ca href=\"http://en.wikipedia.org/wiki/Jamahiriya\"\u003emade up his country’s name\u003c/a\u003e, has ruled Libya for 40 years. He’s been operating with a unique paradigm of political and economic theory that doesn’t jive with the standard Western view. He published a three volume exposition of his political and social views in 1975 called \u003ca href=\"http://en.wikipedia.org/wiki/The_Green_Book\"\u003e\u003cem\u003eThe Green Book\u003c/em\u003e\u003c/a\u003e. Qaddafi’s view of Libya’s political paradigm is completely different from Western disciplinary political science. For Qaddafi, the ideal political system is more of a radical, romantic, Rousseauian world where each individual represents themselves and has an innate skepticism of the state. His theory of the Libyan economy makes no mention of the market, the main protagonist of “standard” economics. Sociologically, the individual in Qaddafi’s Libya is not the fundamental unit of analysis—the family or tribe is. In practice there are no political parties or parliaments in Libya; each community runs itself with town hall-esque meetings. His social theory seems to be working for the most part.\u003c/p\u003e\n\u003cp\u003eIn the 80s, because of different international incidents involving Libya, including \u003ca href=\"http://en.wikipedia.org/wiki/Pan_Am_flight_103\"\u003ethe bombing of Pan Am Flight 103 over Lockerbie\u003c/a\u003e, America and most of the international community imposed strict sanctions on Libya, aimed at isolating and punishing them. All relations between America and Libya were effectively destroyed and Libya entered what she called a \u003ca href=\"http://en.wikipedia.org/wiki/Rip_Van_Winkle\"\u003e“Rip Van Winkle”\u003c/a\u003e era; life continued in total isolation in Libya under Qaddafi’s political and social theory.\u003c/p\u003e\n\u003cp\u003eIn 2004 (about 20 years later…just like Rip Van Winkle, oddly enough) the sanctions eased and American and the rest of the world began diplomatic and academic contacts again. Because of the sanctions, Libya had missed out on the techno-political revolution of the internet. There were no banks; nobody knew what a credit card was. Dr. Anderson visited several universities in 2004 after this long isolation and found a globe in the center of the reference area of the library—North Asia was still labeled as the USSR.\u003c/p\u003e\n\u003cp\u003eDon’t go under international sanctions on the eve of a technological revolution. It’s not a good idea. At all.\u003c/p\u003e\n\u003cp\u003eAs the conflict and tension between Libya and the rest of the world began to thaw, American social scientists got excited. They could finally observe Libya’s progress in democratization and economic liberalization; Libya was on \u003cem\u003ethe\u003c/em\u003e path. Once the sanctions ended, Libya started assimilating into the new world order. It officially apologized for its limited involvement in the Lockerbie crash. It disbanded all attempts at a nuclear weapons program. It was given a rotating seat on the UN security council. Condoleezza Rice even visited and on the eve of George Bush’s presidency, in January 2009, the US and Libya exchanged ambassadors.\u003c/p\u003e\n\u003cp\u003eHowever, despite all this apparent liberalization and openness in Libyan politics and the subsequent disciplinary excitement in political science, Libyan experts like Lisa Anderson see a different reality. Qaddafi is following his own trajectory, totally outside the traditional paradigm. He’s not progressing towards democracy—he’s already got a pseduodemocratic Era of the Masses political and economic system and is happy with it. He’s realized that in order to continue with his social revolution, he has to be somewhat involved with the world, and so he presents a facade of integration.\u003c/p\u003e\n\u003cp\u003eFor example, when the Libyans ended their WMD program in 2006 and turned over all their nuclear material, all the machinery was still boxed up in crates. American politicians and political scientists applauded the IAEA for catching and stopping Libya before they could unpack anything. A widespread rumor/theory in both Libya and in academic and political circles, though, claims that Libya never had a program for WMD development. Their infrastructure and level of development couldn’t have handled such a large project. According to this theory, Libya bought the materials from North Korea so they could have something to turn over to the UN and the USA. So, they announced their weapons program, were condemned by the international community, bought some nuclear machinery from Korea, turned themselves in, reduced international sanctions, and improved their reputation in the world.\u003c/p\u003e\n\u003cp\u003eThe same theory applies to the Lockerbie apology. Two Libyans were partially responsible for the bombing, so the majority of the blame was placed on Libya, despite several other claims of responsibility from other international non-state actors. Most Libyans today fully believe that Libya had no real connection to the bombing, yet Libya settled on a large payout with the families of the victims and offered a full apology. Following the apology sanctions were further lightened.\u003c/p\u003e\n\u003cp\u003eLibya was merely paying cynical lip service to the absurd US-led world order. As Dr. Anderson stated:\u003c/p\u003e\n\u003cblockquote\u003e\n\u003cp\u003eIf you’re playing the game that cynically, are you really playing the game? Libya is just playing the game; they think it’s just nonsense.\u003c/p\u003e\n\u003c/blockquote\u003e\n\u003cp\u003eIf you’re studying a country that considers the “standard” world political, economic, and social system as an absurd game, can you really fully understand it if you study it using disciplines created by that system for the explicit purpose of improving the system? Standard Western political science is still stuck looking at the “here and now” of the early 1900s. Libya doesn’t fit the social science mold at all—traditional social sciences therefore fall flat on their faces.\u003c/p\u003e\n\u003cp\u003eI’ve found that the same principle can be applied to other countries in the Middle East. When Egypt held elections in 2005, President Mubarak allowed a second candidate to run for the first time ever. Disciplinary political scientists praised his move as an important step towards liberal democratization. Mubarak won by a landslide through rigged elections and imprisoned his opposing candidate, Ayman Nour.\u003c/p\u003e\n\u003cp\u003eGreat big step towards democracy, or false expectations rooted in a skewed and incorrect social science paradigm?\u003c/p\u003e\n",
            "date_published": "2009-03-18T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2009/03/15/do-not-succumb-to-economic-stupidity/",
            "url": "https://www.shagunjhaver.com/blog/2009/03/15/do-not-succumb-to-economic-stupidity/",
            "title": "Do not succumb to economic stupidity",
            "summary": "Listening to NPR's Planet Money economics podcast really does help to understand the current economic crisis.",
            "content_html": "\u003cp\u003eYikes. It’s been a week since I launched my new site and blog and I haven’t posted yet. I think this is partially because I don’t know what I’m going to be focusing on with this blog. Middle East Studies? Technology? Hmmm…\u003c/p\u003e\n\u003cp\u003eI’ve had this blog post on my mind for a while, though, so I’d better post it. The best part is that it has nothing to do with MES or tech topics.\u003c/p\u003e\n\u003cp\u003eI’ve felt somewhat immune and aloof from all the American economic troubles. We moved to Egypt in August, a few months after the Bear Stern collapse, but before the September Lehman Bros./Commercial Paper collapse and subsequent bailouts.\u003c/p\u003e\n\u003cp\u003eDespite the rigors of grad school, I’ve had plenty of time to study up on the causes of this crisis. Having a bus daily 45 minute–1 hour bus commute has given me plenty of time to follow some awesome podcasts. I’ll post about my podcast routine later, but suffice it to say, I feel way more informed about this crisis because of the time I’ve spent listening and studying.\u003c/p\u003e\n\u003cp\u003eThat doesn’t mean I know everything—or anything—about this crisis. I don’t fully comprehend all the crazy financial machinations that got us here. I can follow the news a bit better, though.\u003c/p\u003e\n\u003cp\u003eHere are some of the best resources I’ve found so far:\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eNPR’s Planet Money\u003c/strong\u003e: Amazing \u003ca href=\"http://www.npr.org/rss/podcast/podcast_detail.php?siteId=94411890\"\u003epodcast\u003c/a\u003e that comes out 3–4 times a week. Excellent reporting. Easy to understand. Awesome. \u003ca href=\"http://www.npr.org/money\"\u003eTheir blog rocks, too\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eThis American Life\u003c/strong\u003e: Normally their hour long radio shows highlight a variety of interesting stories on random topics and have little to do with news, but they cosponsor Planet Money and have dedicated two entire shows to the economic crisis, \u003ca href=\"http://www.thisamericanlife.org/Radio_Episode.aspx?sched=1242\"\u003eThe Giant Pool of Money\u003c/a\u003e and \u003ca href=\"http://www.thisamericanlife.org/Radio_Episode.aspx?sched=1285\"\u003eBad Bank\u003c/a\u003e. US Treasury Secretary Tim Geithner and Senator Max Baucus even \u003ca href=\"http://www.npr.org/blogs/money/2009/03/some_doll_house_or_other.html\"\u003epraised Bad Bank in front of a joint session of Congress\u003c/a\u003e. It was that good.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eThe Crisis of Credit\u003c/strong\u003e: \u003ca href=\"http://vimeo.com/3261363\"\u003eBrilliant 10 minute animation\u003c/a\u003e inspired by Planet Money.\u003c/p\u003e\n\u003cp\u003e\u003cstrong\u003eInside the Meltdown\u003c/strong\u003e: PBS did a \u003ca href=\"http://www.pbs.org/wgbh/pages/frontline/meltdown/\"\u003egreat hour long documentary\u003c/a\u003e on the crisis. Really good, as well.\u003c/p\u003e\n\u003cp\u003eSo check out those links and get informed. Found any other useful resources out there? Let us know in the comments…\u003c/p\u003e\n",
            "date_published": "2009-03-15T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2009/03/08/new-site-launched/",
            "url": "https://www.shagunjhaver.com/blog/2009/03/08/new-site-launched/",
            "title": "New site launched",
            "summary": "I finally converted my ancient, inefficient PHP-ish website to a mean, lean, WordPresss running CMS.",
            "content_html": "\u003cp\u003eTwo years ago I decided that it would be a good idea to start a personal website. I was always disappointed in \u003ca href=\"http://www.google.com/search?q=Andrew+Heiss\"\u003ethe Google results for my name\u003c/a\u003e, so I figured having my own web space and domain would help boost my ratings. Yes. I initially started this site for the sole purpose of \u003ca href=\"http://en.wikipedia.org/wiki/Egosurfing\"\u003eegogoogling\u003c/a\u003e. So much has changed since then…\u003c/p\u003e\n\u003cp\u003eMy first website was ugly. I had just started my foray into web design and barely knew anything—my CSS was rudimentary at best and I used scattered PHP includes to make a pseudo dynamic site. It was a mess.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"screenshot-of-old-site.png\" alt=\"Screenshot of old site\"\u003e\u003c/p\u003e\n\u003cp\u003eUgh. It was pretty embarrassing. I should have just killed it, but I couldn\u0026rsquo;t because of \u003ca href=\"http://www.andrewheiss.com/blog/2007/10/06/populating-a-livecycle-pdf-with-php-and-mysql/\"\u003eone tutorial\u003c/a\u003e I posted. That one post drives more than 80% of the traffic to this site, and I get almost daily e-mails with questions about it. My old site couldn\u0026rsquo;t handle the community that built up around it.\u003c/p\u003e\n\u003cp\u003eNow that I know a thing or two more about design, I\u0026rsquo;m finally revealing the newest incarnation of \u003ca href=\"http://www.andrewheiss.com/\"\u003eAndrewHeiss.com\u003c/a\u003e—a fully fledged, Wordpress-based site, with a blog, portfolio, and my general online identity hub.\u003c/p\u003e\n\u003cp\u003eThe design isn\u0026rsquo;t finished yet; there are a few last tweaks that need to get done. Let me know about any issues, problems, or suggestions in the comments.\u003c/p\u003e\n\u003cp\u003eOh, I\u0026rsquo;m still the top result for Andrew Heiss. Not that it\u0026rsquo;s hard\u0026hellip;\u003c/p\u003e\n",
            "date_published": "2009-03-08T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2007/10/06/populating-a-livecycle-pdf-with-php-and-mysql/",
            "url": "https://www.shagunjhaver.com/blog/2007/10/06/populating-a-livecycle-pdf-with-php-and-mysql/",
            "title": "Populating a LiveCycle PDF with PHP and MySQL",
            "summary": "Tutorial explaining how to populate a LiveCycle PDF form using PHP and MySQL.",
            "content_html": "\u003cdiv class=\"alert alert-warning\"\u003eThis tutorial is officially defunct. It is only here for archival purposes. The main script has been consolidated into one PHP class—\u003ca href=\"http://www.andrewheiss.com/blog/2009/06/19/pdftk-php-officially-released/\"\u003epdftk-php\u003c/a\u003e. Please see \u003ca href=\"http://www.andrewheiss.com/blog/2009/07/29/installing-pdftk-php/\"\u003ethe updated tutorial\u003c/a\u003e.\u003c/div\u003e\n\u003cp\u003eI work in the Harold B. Lee Library Multimedia Lab where we check out digital video and still cameras, tripods, external hard drives, digital voice recorders, and let people use $8,000 Quad Core Intel Macs. Expensive stuff…\u003c/p\u003e\n\u003cp\u003eTo insure a “you break it, you pay for it” system, we require all patrons to fill out a loan agreement that we then keep on file. We\u0026rsquo;ve been using this system for several years and now have more than a thousand forms—all completely unorganized and out of date. We have no way of knowing if a patron has graduated. We have no way of seeing if a patron has filled out a form previously.\u003c/p\u003e\n\u003cp\u003eSo, I volunteered to fix the problem and move the entire loan agreement system to an online database. I had dabbled in LiveCycle and PHP but had never touched MySQL. So I decided to figure it all out.\u003c/p\u003e\n\u003cp\u003eI\u0026rsquo;m assuming you already have a server set up with PHP and  MySQL. If not, you can download \u003ca href=\"http://www.wampserver.com/en/\"\u003eWAMP\u003c/a\u003e or \u003ca href=\"http://www.mamp.info/en/mamp.html\"\u003eMAMP\u003c/a\u003e and set up a local server on your computer for testing.\u003c/p\u003e\n\u003cp\u003eI\u0026rsquo;m also assuming you have some knowledge of HTML and PHP. If not, search for some PHP tutorials on Google and get a foundation there.\u003c/p\u003e\n\u003ch4 id=\"adobe-livecycle\"\u003eAdobe LiveCycle\u003c/h4\u003e\n\u003cp\u003eAdobe\u0026rsquo;s LiveCycle PDF Form software works great creating fillable PDF forms and then gathering the form data electronically. Collecting the data is relatively easy since LiveCycle uses semi-open file formats for data storage. For example, if you have an e-mail submit button in your LiveCycle form, a specially formatted XML file will be e-mailed to whatever address you set in the button properties. LiveCycle can then input that XML and repopulate an empty form.\u003c/p\u003e\n\u003cp\u003eAdobe even sells the LiveCycle Enterprise Suite, which is basically a specialized server made for generating and repopulating PDFs from submitted data. The Enterprise Suite is extremely expensive though\u003c/p\u003e\n\u003ch4 id=\"create-form-in-livecycle\"\u003eCreate form in LiveCycle\u003c/h4\u003e\n\u003cp\u003eUnfortunately LiveCycle Designer does not work like the rest of the Adobe CS3 products. I spend most of my time in InDesign, and from a typographic point of view, Designer is pathetic and a little difficult to work with.\u003c/p\u003e\n\u003cp\u003eCreating the form is relatively straightforward, regardless of the limitations. Drag text boxes and image boxes from the Library panel to add static text and images. Drag text input boxes from the Library to make fillable fields. Actually laying out and designing the form is not the scope of this tutorial, so I won\u0026rsquo;t go any further with that.\u003c/p\u003e\n\u003ch4 id=\"data-bindings\"\u003eData Bindings\u003c/h4\u003e\n\u003cp\u003eWhat concerns us most is data submission and population with form fields, so we need to set up our fields to work. If you click on a text field, you should have three tabs in the Object panel (if you don\u0026rsquo;t have an Object panel, go to Window \u0026gt; Object).\u003c/p\u003e\n\u003cp\u003eThe Field tab lets you set some basic properties for the field, like whether or not the field can have multiple lines, the line length, the display pattern for phone numbers or other number patterns, the caption, and a plethora of other things. The Value tab allows you to do some scripting for validation of your fields. I tried getting this to work, but since I\u0026rsquo;m not a programmer at all and don\u0026rsquo;t really know Javascript, I gave up.\u003c/p\u003e\n\u003cp\u003eThe Binding tab is the most important for our purposes. By default your field will have a basic name like \u003ccode\u003eTextField1\u003c/code\u003e. You should change the names of all your fields to a more canonical naming system, like FirstName, LastName, EMail, etc. You can also change the data patterns and formats for text, XHTML, or dates.\u003c/p\u003e\n\u003ch4 id=\"submit-through-http\"\u003eSubmit Through HTTP\u003c/h4\u003e\n\u003cp\u003eFor my purposes, I wanted patrons to be able to fill out this PDF from anywhere and then submit it online, regardless of e-mail accounts. To best do this, drag an HTTP Submit Button from the Standard section of your Library. For this button to do anything, you need to set a URL that will receive the data in the form of HTTP POST.\u003c/p\u003e\n\u003ch4 id=\"begin-setting-up-your-web-application\"\u003eBegin Setting Up Your Web Application\u003c/h4\u003e\n\u003cp\u003eI made several different PHP files in the process of getting this all to work. First I wanted to verify what the HTTP POST values were before I started trying to process them. I adapted this code from \u003ca href=\"http://blogs.adobe.com/stevex/2006/06/submit_to_php.html\"\u003eSteve Tibbett\u003c/a\u003e, an actual Adobe guy.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"dump.php.txt\"\u003eDownload text for dump.php\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eCreate a file called dump.php and paste this code into it (or remove the .txt extension). Set your HTTP Submit Button URL to dump.php (in my case it was http://localhost/PDFStuff/dump.php) and preview your PDF in Designer. Submit your data and you\u0026rsquo;ll see all the variables and the raw post data. \u003cem\u003eThis step is  only to verify that the HTTP POST variables actually match up with your Designer field names.\u003c/em\u003e\u003c/p\u003e\n\u003cp\u003eNow that we know that the HTTP POST variables are actually working, we need to save them to a database. You\u0026rsquo;ll need to first set up a MySQL table or database. Since I had never done this, I followed \u003ca href=\"http://www.phpeasystep.com/index.php\"\u003esome tutorials here\u003c/a\u003e, which were extremely helpful in understanding how to actually use MySQL.\u003c/p\u003e\n\u003cp\u003eUse PHPmyadmin and create a new PDFStuff database with a username and password and then create a table in it with the following command (or use the GUI form in PHPmyadmin to create the table—either way works):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sql\" data-lang=\"sql\"\u003e\u003cspan style=\"color:#66d9ef\"\u003eCREATE\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTABLE\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e`\u003c/span\u003ePDF_Loans\u003cspan style=\"color:#f92672\"\u003e`\u003c/span\u003e (\n\u003cspan style=\"color:#f92672\"\u003e`\u003c/span\u003eid\u003cspan style=\"color:#f92672\"\u003e`\u003c/span\u003e int(\u003cspan style=\"color:#ae81ff\"\u003e4\u003c/span\u003e) \u003cspan style=\"color:#66d9ef\"\u003eNOT\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e auto_increment \u003cspan style=\"color:#66d9ef\"\u003eprimary\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003ekey\u003c/span\u003e,\n\u003cspan style=\"color:#f92672\"\u003e`\u003c/span\u003eFirstName\u003cspan style=\"color:#f92672\"\u003e`\u003c/span\u003e varchar(\u003cspan style=\"color:#ae81ff\"\u003e65\u003c/span\u003e) \u003cspan style=\"color:#66d9ef\"\u003eNOT\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003edefault\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e,\n\u003cspan style=\"color:#f92672\"\u003e`\u003c/span\u003eLastName\u003cspan style=\"color:#f92672\"\u003e`\u003c/span\u003e varchar(\u003cspan style=\"color:#ae81ff\"\u003e65\u003c/span\u003e) \u003cspan style=\"color:#66d9ef\"\u003eNOT\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003edefault\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e,\n\u003cspan style=\"color:#f92672\"\u003e`\u003c/span\u003eEMail\u003cspan style=\"color:#f92672\"\u003e`\u003c/span\u003e varchar(\u003cspan style=\"color:#ae81ff\"\u003e65\u003c/span\u003e) \u003cspan style=\"color:#66d9ef\"\u003eNOT\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eNULL\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003edefault\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#39;\u0026#39;\u003c/span\u003e,\n) \u003cspan style=\"color:#66d9ef\"\u003eTYPE\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003eMyISAM AUTO_INCREMENT\u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e ;\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eYou now have a table in your database where we can store our PDF form variables. Paste this code into a file called insert.php and change the PHP variables as necessary, both for your MySQL connection information and your HTTP POST variables (here I just use FirstName, LastName, and Email).\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"insert.php.txt\"\u003eDownload text for insert.php\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eChange the URL of the HTTP POST button to insert.php (again, in my case it\u0026rsquo;s http://localhost/PDFStuff/insert.php) and try submitting some data with your PDF form. It should work.\u003c/p\u003e\n\u003ch4 id=\"viewing-data-in-the-database\"\u003eViewing Data in the Database\u003c/h4\u003e\n\u003cp\u003eTo actually see your submitted data, create a new php file  called view.php and paste this code in, changing it as necessary.\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"view.php.txt\"\u003eDownload text for view.php\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eThis page will take all the data from your database and display it in a table. You should see one record—the one you just added. There is also a column for a link to view the PDF, although the link is blank for now. Add several more through LiveCycle to make sure it\u0026rsquo;s working.\u003c/p\u003e\n\u003ch4 id=\"pdf-madness\"\u003ePDF Madness\u003c/h4\u003e\n\u003cp\u003eIf you\u0026rsquo;ve already had PHP/MySQL experience, all of that was easy. Now comes the tricky part—repopulating the PDF form from the MySQL.\u003c/p\u003e\n\u003cp\u003eTo get this to work, we need to convert the MySQL data into an FDF file, or the Adobe file format for storing form data. We then need to infuse the FDF file into our empty PDF form and allow the user to download it.\u003c/p\u003e\n\u003cp\u003eFortunately, someone else figured out the bulk of this, at \u003ca href=\"http://www.pdfhacks.com/\"\u003ewww.pdfhacks.com\u003c/a\u003e. Download \u003ca href=\"http://www.accesspdf.com/pdftk/\"\u003epdftk\u003c/a\u003e and \u003ca href=\"http://www.pdfhacks.com/forge_fdf/\"\u003eforge_fdf.php\u003c/a\u003e place them in your main site directory. Forge_fdf.php will take your data and transform it into an FDF file while fdftk will insert that FDF into your PDF. All you need to do is add some variables.\u003c/p\u003e\n\u003cp\u003eBefore creating your variables, you need to discover the real names for all of your fields. If you made your PDF in Acrobat, the field names \u003cem\u003eshould\u003c/em\u003e be identical, but if you used Designer, the official code-based names will be much longer. fdftk can discover those names for you and dump them in a text file.\u003c/p\u003e\n\u003cp\u003ePlace your empty PDF form in your main site folder. Open up a command prompt or terminal and run this command in the site folder, changing file names as necessary:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-sh\" data-lang=\"sh\"\u003e$ pdftk form.pdf dump_data_fields \u0026gt; form.pdf.fields\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eOpen up the newly created form.pdf.fields file in Notepad and you\u0026rsquo;ll see the automatic fdftk output, which will look something like this:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4\"\u003e\u003ccode class=\"language-text\" data-lang=\"text\"\u003eFieldType: Text\nFieldName: form1[0].#subform[0].#area[0].FirstName[0]\nFieldNameAlt: First Name:\nFieldFlags: 2\nFieldJustification: Left\n\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThe FieldName in this case is long and hairy, but we\u0026rsquo;ll need that full name for the data insertion to work.\u003c/p\u003e\n\u003ch4 id=\"dynamic-data-insertion\"\u003eDynamic Data Insertion\u003c/h4\u003e\n\u003cp\u003eNow we\u0026rsquo;re ready to put all the pieces together. Make a file called viewpdf.php and paste this code in, changing as necessary:\u003c/p\u003e\n\u003cp\u003e\u003ca href=\"viewpdf.php.txt\"\u003eDownload text for viewpdf.php\u003c/a\u003e\u003c/p\u003e\n\u003cp\u003eIf you don\u0026rsquo;t want the form flattened (i.e. you want to  maintain the form fields), take out the \u003ccode\u003e – flatten\u003c/code\u003e command.\u003c/p\u003e\n\u003cp\u003eNotice how the long names had to go in to the \u003ccode\u003e$fdf_data_strings\u003c/code\u003e array.\u003c/p\u003e\n\u003cp\u003eTo populate the PDF from your view.php table, you need to pass those long field names into viewpdf.php. Technically you would need to change the links in view.php to include the row id number for each row, so the PDF is generated using only the information from that row. Fortunately, we can have PHP and MySQL write all those links dynamically.\u003c/p\u003e\n\u003cp\u003eWe originally set up the database so that every time you insert a record, an auto-id number would be assigned. We can reference that id number to view the PDF for that specific row entry.\u003c/p\u003e\n\u003cp\u003eYou pass the id variable into the viewpdf.php file by adding \u003ccode\u003e?id=1\u003c/code\u003e onto the URL (for example, viewing the PDF for record number three would be \u003ccode\u003eviewpdf.php?id=3\u003c/code\u003e).\u003c/p\u003e\n\u003cp\u003ePHP and MySQL can automatically generate that messy link for every record in the table. Just replace \u003ccode\u003e\u0026lt;a href=\u0026quot;#\u0026quot;\u0026gt;View PDF\u0026lt;/a\u0026gt;\u003c/code\u003e in view.php with \u003ccode\u003e\u0026lt;a href=\u0026quot;viewpdf.php?id=\u0026lt;?php echo $rows['id']; ?\u0026gt;\u0026quot;\u0026gt;View PDF\u0026lt;/a\u0026gt;\u003c/code\u003e\u003c/p\u003e\n\u003cp\u003eOpen up view.php and see your dynamically generated table. You should have dynamic links that point to \u003ccode\u003eviewpdf.php?id=whatever\u003c/code\u003e. If you click on one of the links, the code in viewpdf.php will be processed for that row and a PDF will be generated and flattened and downloaded.\u003c/p\u003e\n\u003cp\u003eVoila!\u003c/p\u003e\n\u003cp\u003eI was only able to get this to work with text fields, although it is possible to do this with check boxes and other form elements. You\u0026rsquo;ll have to consult the fdftk documentation to see what variables need to be set for other form elements.\u003c/p\u003e\n\u003cp\u003eThis is a bare bones implementation of PDF population. In real life this is implemented a lot better—i.e. I have my view.php file accessible only after logging in and all the pages are styled with CSS to look nicer.\u003c/p\u003e\n\u003cp\u003eHopefully this all made sense. If you want to view the original tutorials I used for this, visit:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"http://www.mactech.com/articles/mactech/Vol.20/20.11/FillOnlinePDFFormsUsingHTML/index.html\"\u003eMacTech Tutorial\u003c/a\u003e—Explains how to do this using an HTML submission form rather than a PDF form. This was the basis for my tutorial.\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://accesspdf.com/html_pdf_form/\"\u003eMacTech Example\u003c/a\u003e—Working example of a PDF being populated by HTML.\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"http://www.phpeasystep.com/index.php\"\u003ePHPeasy\u003c/a\u003e—Basic PHP/MySQL tutorials.\u003c/li\u003e\n\u003c/ul\u003e\n",
            "date_published": "2007-10-06T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }, 
        {
            "id": "https://www.shagunjhaver.com/blog/2007/09/17/using-arabic-in-indesign-without-indesign-me/",
            "url": "https://www.shagunjhaver.com/blog/2007/09/17/using-arabic-in-indesign-without-indesign-me/",
            "title": "Using Arabic in InDesign without InDesign ME",
            "summary": "How to use the Glyphs panel in InDesign CS3 to insert Arabic text, despite the lack of support for Arabic.",
            "content_html": "\u003cp\u003eAbout a year ago I discovered to my dismay that using Arabic in InDesign was entirely impossible.\u003c/p\u003e\n\u003cp\u003eI wanted to make a type of dictionary for my Arabic 101 students, using an Excel spreadsheet full of Arabic words. When I placed any Arabic text, though, this happened:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"messed-up-text.png\" alt=\"Messed up Arabic text\"\u003e\u003c/p\u003e\n\u003cp\u003eWhile Microsoft and Apple have great right-to-left (RTL) language support built in, Adobe doesn\u0026rsquo;t. InDesign and Illustrator \u003cem\u003ecannot\u003c/em\u003e handle RTL text. Adobe has, however, outsourced their code to \u003ca href=\"http://www.winsoft.eu/\"\u003eWinSoft\u003c/a\u003e, who develops the Creative Suite ME (Middle Eastern edition), which \u003cem\u003edoes\u003c/em\u003e have excellent RTL support, especially through the use of their \u003ca href=\"https://en.wikipedia.org/wiki/Tasmeem\"\u003eTasmeem\u003c/a\u003e typesetting framework, recently highlighted in \u003ca href=\"http://www.saudiaramcoworld.com/issue/200704/keyboard.calligraphy.htm\"\u003eSaudi Aramco Magazine\u003c/a\u003e. However, I don\u0026rsquo;t want to buy the ME version for minimal Arabic use.\u003c/p\u003e\n\u003ch4 id=\"typing-backwards\"\u003eTyping backwards\u003c/h4\u003e\n\u003cp\u003eThe only way around this is to type the text in backwards: if you want the word alkitaab, you would have to type baatikla and InDesign \u003cem\u003eshould\u003c/em\u003e show it correctly.\u003c/p\u003e\n\u003cp\u003eThere\u0026rsquo;s one big caveat though—Arabic letters have different forms depending on where they show up in the word (initial, medial, final, or isolated).\u003c/p\u003e\n\u003cp\u003eThis typing-backwards, faux-RTL works great for Hebrew since almost every letter has the same shape no matter where they are in the word. In fact, \u003ca href=\"http://indesignsecrets.com/free-script-for-hebrew-or-arabic-text-in-regular-version-of-indesign.php\"\u003eInDesignSecrets.com mentioned a script\u003c/a\u003e that will take pasted Hebrew characters and reverse them automatically.\u003c/p\u003e\n\u003cp\u003eUnfortunately, Arabic is more complex. There is a clunky solution—hunt and peck with the glyphs panel. This workaround is \u003cem\u003enot\u003c/em\u003e useful for large amounts of Arabic text. If you want to design something with a substantial amount of Arabic, buy InDesign ME. (if you\u0026rsquo;re desperate, I guess you \u003cem\u003ecould\u003c/em\u003e do an entire book like this. It would just take several months to get the text done :) ).\u003c/p\u003e\n\u003ch4 id=\"typing-with-the-glyphs-panel\"\u003eTyping with the glyphs panel\u003c/h4\u003e\n\u003cp\u003eThe glyphs panel is a great and often underused panel in InDesign. It\u0026rsquo;s generally used for finding and inserting dingbat characters or other non-standard glyphs in a font. You can even save your most commonly used glyphs for easy access:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"custom-glyphs.png\" alt=\"Custom glyphs\"\u003e\u003c/p\u003e\n\u003cp\u003eYou can even type with the glyphs panel, which is how we get Arabic working in InDesign. This method also works for Illustrator and any other Adobe program with a glyphs panel.\u003c/p\u003e\n\u003cp\u003eTo activate the panel, go to Window \u0026gt; Type \u0026amp; Tables \u0026gt; Glyphs. Choose an Arabic font from the list in the bottom left corner of the panel to load that font into the panel. I like working with the \u003ca href=\"https://docs.microsoft.com/en-us/typography/font-list/arabic-typesetting\"\u003eArabic Typesetting\u003c/a\u003e font that comes with Office 2007 because of the dozens of alternate glyphs and ligatures that are available. Microsoft has an excellent collection of Arabic fonts as well.\u003c/p\u003e\n\u003cp\u003eYou should see normal Roman characters in the panel. Scroll down until you get the Arabic glyphs. Double click on a letter to insert it at your cursor.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"arabic-glyphs.png\" alt=\"Arabic glyph panel\"\u003e\u003c/p\u003e\n\u003cp\u003eHere\u0026rsquo;s where the magic starts. Many of the glyphs will have a black triangle in the bottom right corner of the grid box. This means that there are alternate glyphs for that character—in this case, different positions for the letter. Click and hold one of the boxes with alternate glyphs and you\u0026rsquo;ll see all the different possibilities for that letter.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"all-positions.png\" alt=\"All glyph positions\"\u003e\u003c/p\u003e\n\u003cp\u003eTo type a full Arabic word, insert the appropriately positioned letters in backwards order using the glyphs panel. Here\u0026rsquo;s a live example of this in action (sorry for the horrible quality):\u003c/p\u003e\n\u003cdiv class=\"video-responsive\"\u003e\n\u003ciframe class=\"videoplayer\" src=\"https://player.vimeo.com/video/3760188\" frameborder=\"0\" allow=\"autoplay; fullscreen\" allowfullscreen\u003e\u003c/iframe\u003e\n\u003c/div\u003e\n\u003cp\u003eYou can insert alternate glyphs and ligatures too:\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"more-alternate-glyphs.png\" alt=\"Alternate glyphs and ligatures\"\u003e\u003c/p\u003e\n\u003cp\u003eIf you use a decorative Arabic font, like Microsoft\u0026rsquo;s Diwani family (found in the \u003ca href=\"http://www.tucows.com/preview/872760/Arabic-Font-Pack\"\u003earafonts.exe\u003c/a\u003e font package), you can use the decorative swashes as well. You can even change the font after inserting the letters to another Arabic font and maintain the letters.\u003c/p\u003e\n\u003cp\u003eIn the end, you\u0026rsquo;ll have real Arabic text that can be manipulated just like normal InDesign text. It\u0026rsquo;s a clunky method, but it works, as seen \u003ca href=\"/other-projects/arabian-nights/\"\u003ehere\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eThis could all probably be automated with a script of sorts, but I\u0026rsquo;m no programmer.\u003c/p\u003e\n\u003cp\u003eIf anyone has comments or suggestions (or knows how to make a script for this), leave a comment below…\u003c/p\u003e",
            "date_published": "2007-09-17T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }
    ]
}

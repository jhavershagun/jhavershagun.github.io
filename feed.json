{
    "version": "https://jsonfeed.org/version/1",
    "title": "Shagun Jhaver",
    "home_page_url": "https://www.shagunjhaver.com/",
    "feed_url": "https://www.shagunjhaver.com/feed.json",
    "description": "Shagun Jhaver is an assistant professor at Rutgers University, researching content moderation and online harassment.",
    "icon": "https://www.shagunjhaver.com/profiles/square-bg.png",
    "items": [
        {
            "id": "https://www.shagunjhaver.com/blog/2021/01/15/msm-gee-multilevel/",
            "url": "https://www.shagunjhaver.com/blog/2021/01/15/msm-gee-multilevel/",
            "title": "Marginal structural models for panel data with GEE and multilevel models",
            "summary": "Use R to correctly close backdoor confounding in panel data with marginal structural models and inverse probability weights with both GEE and multilevel models",
            "content_html": "\u003cscript src=\"/blog/2021/01/15/msm-gee-multilevel/index_files/kePrint-0.0.1/kePrint.js\"\u003e\u003c/script\u003e\n\u003clink href=\"/blog/2021/01/15/msm-gee-multilevel/index_files/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" /\u003e\n\u003cscript src=\"/blog/2021/01/15/msm-gee-multilevel/index_files/kePrint-0.0.1/kePrint.js\"\u003e\u003c/script\u003e\n\u003clink href=\"/blog/2021/01/15/msm-gee-multilevel/index_files/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" /\u003e\n\u003cscript src=\"/blog/2021/01/15/msm-gee-multilevel/index_files/kePrint-0.0.1/kePrint.js\"\u003e\u003c/script\u003e\n\u003clink href=\"/blog/2021/01/15/msm-gee-multilevel/index_files/lightable-0.0.1/lightable.css\" rel=\"stylesheet\" /\u003e\n\u003cp\u003eSince my last two blog posts on \u003ca href=\"https://www.andrewheiss.com/blog/2020/12/01/ipw-binary-continuous/\"\u003ebinary and continuous inverse probability weights (IPWs)\u003c/a\u003e and \u003ca href=\"https://www.andrewheiss.com/blog/2020/12/03/ipw-tscs-msm/\"\u003emarginal structural models (MSMs) for time-series cross-sectional (TSCS) panel data\u003c/a\u003e, I’ve spent a ton of time trying to figure out why I couldn’t recover the exact causal effect I had built in to those examples when using panel data. It was a mystery, and it took weeks to figure out what was happening.\u003c/p\u003e\n\u003cp\u003eAfter poring through all sorts of articles on MSMs and TSCS data like \u003ca href=\"#ref-ThoemmesOng:2016\"\u003eThoemmes and Ong\u003c/a\u003e (\u003ca href=\"#ref-ThoemmesOng:2016\"\u003e2016\u003c/a\u003e) and \u003ca href=\"#ref-BlackwellGlynn:2018\"\u003eBlackwell and Glynn\u003c/a\u003e (\u003ca href=\"#ref-BlackwellGlynn:2018\"\u003e2018\u003c/a\u003e), along with all sorts of articles on the differences between \u003ca href=\"https://en.wikipedia.org/wiki/Generalized_estimating_equation\"\u003egeneralized estimating equations (GEEs)\u003c/a\u003e, which the epidemiology world (and everyone who does MSMs) seems to love, and multilevel models (which I find a lot more intuitive, and which can be done Bayesianly with \u003cstrong\u003ebrms\u003c/strong\u003e), I \u003cem\u003efinally\u003c/em\u003e figured out what was wrong and how to calculate correct IPWs for panel data.\u003c/p\u003e\n\u003cp\u003eThe main issue lies in the synthetic data I had created for those earlier blog posts. \u003ca href=\"https://www.andrewheiss.com/blog/2020/12/03/ipw-tscs-msm/#simulated-time-series-cross-sectional-data\"\u003eThere, I used the \u003cstrong\u003efabricatr\u003c/strong\u003e package to create a country-year panel\u003c/a\u003e, which seemed correct and great. However, it didn’t exactly match the data-generating process in situations where the value in one time period (like \u003ccode\u003e\\(X_t\\)\u003c/code\u003e) depends on the value from the previous time period (or \u003ccode\u003e\\(X_{t-1}\\)\u003c/code\u003e), or autocorrelation. As such, I couldn’t quite get the correct causal effects out (since the data didn’t show interdepdency across time).\u003c/p\u003e\n\u003cp\u003eAfter lots of struggle, though, I finally figured out a way to explicitly build this autocorrelation in. And thanks to this delightfully accessible article by \u003ca href=\"#ref-ThoemmesOng:2016\"\u003eThoemmes and Ong\u003c/a\u003e (\u003ca href=\"#ref-ThoemmesOng:2016\"\u003e2016\u003c/a\u003e) (\u003ca href=\"https://anthonyongphd.files.wordpress.com/2016/02/emerging-adulthood-2016-thoemmes-40-59.pdf\"\u003eungated free version here\u003c/a\u003e), I found clear code for MSMs that I could expand to test on more complex panel data.\u003c/p\u003e\n\u003cp\u003eIn this post, I’ll do a few things: (1) recreate the two-time-period example from Thoemmes and Ong’s appendix (which is stuck in a PDF and really hard to copy/paste out), (2) redo their two-period example with a tidier approach, and (3) expand their two-period approach to multiple years and replace GEEs with multilevel models.\u003c/p\u003e\n\u003cp\u003eHere we go!\u003c/p\u003e\n\u003ch2 id=\"contents----omit-in-toc---\"\u003eContents \u003c!-- omit in toc --\u003e\u003c/h2\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#synthetic-data-overview\"\u003eSynthetic data overview\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#original-two-period-thoemmes-and-ong-results\"\u003eOriginal two-period Thoemmes and Ong results\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#tidier-two-period-results\"\u003eTidier two-period results\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#expansion-to-multiple-period-data\"\u003eExpansion to multiple-period data\u003c/a\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ca href=\"#tricky-interdependent-data-generating-process\"\u003eTricky interdependent data generating process\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#multiple-period-marginal-structural-models\"\u003eMultiple-period marginal structural models\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#questions-for-the-future\"\u003eQuestions for the future\u003c/a\u003e\u003c/li\u003e\n\u003cli\u003e\u003ca href=\"#references\"\u003eReferences\u003c/a\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(tidyverse)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(broom)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(ggdag)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(dagitty)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(ipw)  \u003cspan style=\"color:#75715e\"\u003e# For automatically calculating IPWs\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(geepack)  \u003cspan style=\"color:#75715e\"\u003e# For GEE models\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(lme4)  \u003cspan style=\"color:#75715e\"\u003e# For mixed/multilevel models\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(broom.mixed)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003elibrary\u003c/span\u003e(kableExtra)\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch2 id=\"synthetic-data-overview\"\u003eSynthetic data overview\u003c/h2\u003e\n\u003cp\u003eIn their paper, Thoemmes and Ong create simulated data based on this DAG, with a time-varying treatment, a non-time-varying confounder, and a time-varying outcome (depression):\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# I generally prefer the easier-to-read formula syntax in dagify() (i.e. D1 ~ T1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# + C, etc.), but it doesn\u0026#39;t work with subscripted numbers like T[1], so we have\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# to use this dagitty syntax instead\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edepression_dag \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edagitty\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#39;dag {\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;C\u0026#34; [pos=\u0026#34;2.5,2\u0026#34;]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;T[1]\u0026#34; [pos=\u0026#34;1,1\u0026#34;]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;D[1]\u0026#34; [pos=\u0026#34;2,1\u0026#34;]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;T[2]\u0026#34; [pos=\u0026#34;3,1\u0026#34;]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;D[2]\u0026#34; [pos=\u0026#34;4,1\u0026#34;]\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;C\u0026#34; -\u0026gt; \u0026#34;D[1]\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;C\u0026#34; -\u0026gt; \u0026#34;D[2]\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;C\u0026#34; -\u0026gt; \u0026#34;T[1]\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;C\u0026#34; -\u0026gt; \u0026#34;T[2]\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;D[1]\u0026#34; -\u0026gt; \u0026#34;T[2]\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;T[1]\u0026#34; -\u0026gt; \u0026#34;D[1]\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;T[2]\u0026#34; -\u0026gt; \u0026#34;D[2]\u0026#34;\n\u003c/span\u003e\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#e6db74\"\u003e}\u0026#39;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003etidy_dagitty\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003eggplot\u003c/span\u003e(depression_dag, \u003cspan style=\"color:#a6e22e\"\u003eaes\u003c/span\u003e(x \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e x, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, xend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e xend, yend \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e yend)) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_edges\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_point\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;grey80\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e12\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003egeom_dag_text\u003c/span\u003e(color \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;black\u0026#34;\u003c/span\u003e, size \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e, parse \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#66d9ef\"\u003eTRUE\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003etheme_dag\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cimg src=\"/blog/2021/01/15/msm-gee-multilevel/index_files/figure-html/depression-dag-1.png\" width=\"75%\" style=\"display: block; margin: auto;\" /\u003e\n\u003cp\u003eEssentially earlier treatment ($T_1$) causes some level of depression ($D_1$), which causes later treatment ($T_2$), which causes later depression ($D_2$). This whole chain is influenced by some non-varying confounder ($C$).\u003c/p\u003e\n\u003ch2 id=\"original-two-period-thoemmes-and-ong-results\"\u003eOriginal two-period Thoemmes and Ong results\u003c/h2\u003e\n\u003cp\u003eHere’s the original code from the appendix of \u003ca href=\"#ref-ThoemmesOng:2016\"\u003eThoemmes and Ong\u003c/a\u003e (\u003ca href=\"#ref-ThoemmesOng:2016\"\u003e2016\u003c/a\u003e) for data with a time-varying continuous treatment and a confounder. It explicitly creates columns for \u003ccode\u003et1\u003c/code\u003e, \u003ccode\u003ed1\u003c/code\u003e, \u003ccode\u003et2\u003c/code\u003e, and \u003ccode\u003ed2\u003c/code\u003e, so it is easy to mathematically make it so that \u003ccode\u003et2\u003c/code\u003e is caused by \u003ccode\u003ed1\u003c/code\u003e.\u003c/p\u003e\n\u003cp\u003eBecause it’s only two time periods, they calculate the inverse probability weights in two formulas and then multiply them together:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003eWeights for the first time period:\u003c/p\u003e\n\u003cp\u003e$$\nw_1 = \\frac{\\phi(T_{i1})}{\\phi(T_{i1}\\ |\\ C)}\n$$\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eWeights for the second time period:\u003c/p\u003e\n\u003cp\u003e$$\nw_2 = \\frac{\\phi(T_{i2}\\ |\\ T_{i1})}{\\phi(T_{i2}\\ |\\ C, T_{i1}, D_{i1})}\n$$\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eFinal weights:\u003c/p\u003e\n\u003cp\u003e$$\nw = w_1 \\cdot w_2\n$$\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eHere’s their code:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##################################################################### \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# iptw demo with time-varying continuous treatment and confounder\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#####################################################################\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# Felix Thoemmes, October, 2015 \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#####################################################################\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#set seed to replicate results\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003eset.seed\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e12345\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#define sample size\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003en \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2000\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#define confounder c\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ec \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n,\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e,\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#define treatment at time 1 as function of confounder\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003et1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003ec \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n,\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e.99\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#define depression at time 1 as function of confounder and treat1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ed1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003ec \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.4\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003et1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n,\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e.822\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#define treatment at time 2 as function of confounder and dep1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003et2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003ec \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.4\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003ed1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.4\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003et1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n,\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e.5196\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#define outcome depression at time 2 as function of confounder, treat1, and dep1 \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ed2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003ec \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.4\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003et2 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.4\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003ed1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n,\u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e.4582\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#add ID variable to do mixed effects models later\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eid \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erep\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003elength\u003c/span\u003e(c))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edf1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003edata.frame\u003c/span\u003e(id, c, t1, d1, t2, d2)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#compute the weights for timepoint 1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#this is a continuous treatment\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#therefore we use densities of normal distributions\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#weights at time 1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ew1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(df1\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et1, \u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(t1 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)), \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(t1 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eresiduals)) \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(df1\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et1, \u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(t1 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e c)), \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(t1 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e c)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eresiduals))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#weights at time 2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ew2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(df1\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et2, \u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(t2 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t1)), \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(t2 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t1)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eresiduals)) \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(df1\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et2, \u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(t2 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e c \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e d1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t1)), \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(t2 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e c \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e d1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t1)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eresiduals)) \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#total weights are a product of all time-varying weights\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003ew \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e w1\u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003ew2\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#truncate weights at 5%\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003etw1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eifelse\u003c/span\u003e(w \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003equantile\u003c/span\u003e(w, probs \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.05\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003equantile\u003c/span\u003e(w, probs \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.05\u003c/span\u003e), w)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003etw1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eifelse\u003c/span\u003e(w \u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003equantile\u003c/span\u003e(w, probs \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.95\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003equantile\u003c/span\u003e(w, probs \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.95\u003c/span\u003e), tw1)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#truncate weights at 1%\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003etw2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eifelse\u003c/span\u003e(w \u003cspan style=\"color:#f92672\"\u003e\u0026lt;\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003equantile\u003c/span\u003e(w, probs \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.01\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003equantile\u003c/span\u003e(w, probs \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.01\u003c/span\u003e), w)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003etw2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eifelse\u003c/span\u003e(w \u003cspan style=\"color:#f92672\"\u003e\u0026gt;\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003equantile\u003c/span\u003e(w, probs \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e.99\u003c/span\u003e), \u003cspan style=\"color:#a6e22e\"\u003equantile\u003c/span\u003e(w, probs \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e0.99\u003c/span\u003e), tw2)\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThey they run a bunch of different outcome models with \u003ccode\u003egeeglm()\u003c/code\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eonly_t1 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(d2 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t1, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df1, id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erownames\u003c/span\u003e(df1))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eonly_t2 \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(d2 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t2, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df1, id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erownames\u003c/span\u003e(df1))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eboth_t \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(d2 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t2, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df1, id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erownames\u003c/span\u003e(df1))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eboth_t_c \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(d2 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t2 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e c \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e d1, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df1, id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erownames\u003c/span\u003e(df1))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003estab_ipw \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(d2 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t2, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df1, id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erownames\u003c/span\u003e(df1), weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e w)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003estab_ipw_1p \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(d2 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t2, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df1, id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erownames\u003c/span\u003e(df1), weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e tw2)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003estab_ipw_5p \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(d2 \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t1 \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t2, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df1, id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003erownames\u003c/span\u003e(df1), weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e tw1)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eresults \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etribble\u003c/span\u003e(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e`Method`, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e`T\u0026lt;sub\u0026gt;1\u0026lt;/sub\u0026gt; effect`, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e`T\u0026lt;sub\u0026gt;2\u0026lt;/sub\u0026gt; effect`,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;True effect\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.160\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.400\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Naive, only T1\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(only_t1), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t1\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#66d9ef\"\u003eNA\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Naive, only T2\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#66d9ef\"\u003eNA\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(only_t2), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t2\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Naive, both\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(both_t), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t1\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(both_t), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t2\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Naive, both + controls\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(both_t_c), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t1\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(both_t_c), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t2\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;IPW\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(stab_ipw), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t1\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(stab_ipw), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t2\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;IPW, 1% truncated\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(stab_ipw_1p), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t1\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(stab_ipw_1p), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t2\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;IPW, 5% truncated\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(stab_ipw_5p), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t1\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(stab_ipw_5p), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t2\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ctable style=\"width:70%; margin-left: auto; margin-right: auto;\" class=\" pure-table pure-table-horizontal\"\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align:left;\"\u003e\nMethod\n\u003c/th\u003e\n\u003cth style=\"text-align:right;\"\u003e\nT\u003csub\u003e1\u003c/sub\u003e effect\n\u003c/th\u003e\n\u003cth style=\"text-align:right;\"\u003e\nT\u003csub\u003e2\u003c/sub\u003e effect\n\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nTrue effect\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.160\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.400\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nNaive, only T1\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.423\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n—\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nNaive, only T2\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n—\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.649\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nNaive, both\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.048\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.623\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nNaive, both + controls\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.011\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.399\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nIPW\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.157\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.421\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nIPW, 1% truncated\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.154\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.434\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nIPW, 5% truncated\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.131\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.480\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003eAnd here’s all that compared to what they have in the paper:\u003c/p\u003e\n\u003cimg src=\"ThoemmesOng-Table2.png\" width=\"50%\" style=\"display: block; margin: auto;\" /\u003e\n\u003cp\u003eIt’s identical! I’m chalking any tiny differences up to the fact that \u003ccode\u003eset.seed()\u003c/code\u003e changed with R 4.0 and they used R 3.x in their paper. (Also the T2-only model is wrong, but that’s probably a typo—the “estimated scale parameter” from that model is 0.574 with an sd of 0.018, which lines up perfectly with the coefficient in the published table, so I think maybe the published paper has the wrong number in the table.)\u003c/p\u003e\n\u003cp\u003eAlso, there seems to be another typo in that table. The true effect of T1 in the table is 0.140, but in the text of the paper, it says the effect should be 0.160, which makes sense—that’s the product of 0.4 × 0.4, or each of the treatment coefficients ($0.4 \\times 0.4 = 0.16$).\u003c/p\u003e\n\u003cp\u003eRegardless of those super tiny insignificant typos, we did it! We have their exact results using marginal structural models and inverse probability weights.\u003c/p\u003e\n\u003ch2 id=\"tidier-two-period-results\"\u003eTidier two-period results\u003c/h2\u003e\n\u003cp\u003eThe code to generate that data isn’t very tidyverse-friendly and it creates a ton of intermediate vectors. Here’s a cleaner version with \u003cstrong\u003edplyr\u003c/strong\u003e:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003eset.seed\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e12345\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003en \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2000\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edf_nice \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003en,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                  c \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(t1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e c) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.99\u003c/span\u003e)),\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e         d1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e c) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e t1) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.822\u003c/span\u003e)),\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e         t2 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e c) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e d1) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e t1) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.5196\u003c/span\u003e)),\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e         d2 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e c) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e t2) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e d1) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.4582\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eAlso, this original data is wide, with explicit columns for each time period. Let’s make it tidy and pretend the time periods are years (\u003ccode\u003ey\u003c/code\u003e) and add some lagged columns:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edf_tidy \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e df_nice \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003epivot_longer\u003c/span\u003e(cols \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(t1, d1, t2, d2)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003eseparate\u003c/span\u003e(name, into \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;variable\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;y\u0026#34;\u003c/span\u003e), sep \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003epivot_wider\u003c/span\u003e(names_from \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;variable\u0026#34;\u003c/span\u003e, values_from \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;value\u0026#34;\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(id) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eacross\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(t, d), \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(lag \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e lag))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003eungroup\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(df_tidy)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 6 x 7\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##      id      c y           t       d  t_lag   d_lag\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;int\u0026gt;  \u0026lt;dbl\u0026gt; \u0026lt;chr\u0026gt;   \u0026lt;dbl\u0026gt;   \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;   \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## 1     1  0.586 1     -0.546  -1.11   NA     NA     \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## 2     1  0.586 2     -0.853  -1.73   -0.546 -1.11  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## 3     2  0.709 1      1.14    0.361  NA     NA     \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## 4     2  0.709 2     -0.0673 -1.30    1.14   0.361 \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## 5     3 -0.109 1     -0.584  -0.0822 NA     NA     \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## 6     3 -0.109 2     -0.932   0.535  -0.584 -0.0822\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThis is how panel data is typically structured, with rows repeated for each time period. This is good because we can figure out how to structure the weight models and outcome model in a way that uses this structure and compare it to the original \u003ccode\u003et1\u003c/code\u003e, \u003ccode\u003ed1\u003c/code\u003e, etc. models.\u003c/p\u003e\n\u003cp\u003eBecause there are only two time periods, the lagged columns here are missing a ton of data (since you can’t see what the value is for year 0), but it’ll still work.\u003c/p\u003e\n\u003cp\u003eWith the data like this, we can find the weights. We’ll do it both manually and with the \u003cstrong\u003eipw\u003c/strong\u003e package.\u003c/p\u003e\n\u003cp\u003eManually, we need to fit two models (a numerator and denominator) and then take the cumulative product of their probability distributions:\u003c/p\u003e\n\u003cp\u003e$$\nw = \\prod^t_{t = 1} \\frac{\\phi(T_{it} | T_{i, t-1}, C_i)}{\\phi(T_{it} | T_{i, t-1}, D_{i, t-1}, C_i)}\n$$\u003c/p\u003e\n\u003cp\u003eHere we go!\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# Remove NAs since ipwpoint() will complain\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edf_tidy_sans_na \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e df_tidy \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e!\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eis.na\u003c/span\u003e(t_lag))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# Manually\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# Numerator is lagged treatment + non-varying confounders\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003emodel_num \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(t \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e c,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_tidy_sans_na)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# Denominator is lagged treatment, lagged outcome, time-varying confounders +\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# non-varying confounders\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003emodel_denom \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elm\u003c/span\u003e(t \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e d_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e c, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                  data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_tidy_sans_na)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# Probability distributions\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003enum \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(df_tidy_sans_na\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e             \u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(model_num),\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e             \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eresiduals\u003c/span\u003e(model_num)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eden \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(df_tidy_sans_na\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e             \u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(model_denom),\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e             \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eresiduals\u003c/span\u003e(model_denom)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# Make num/den fraction and find cumulative product within each id\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edf_weights_manual \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e df_tidy_sans_na \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(weights_no_time \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e num \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e den) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(id) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(ipw \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecumprod\u003c/span\u003e(weights_no_time)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003eungroup\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# Automatically find weights with ipw::ipwpoint()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003etidy_weights_auto \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eipwpoint\u003c/span\u003e(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  exposure \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e t,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;gaussian\u0026#34;\u003c/span\u003e, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  numerator \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e c, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  denominator \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e d_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e c, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eas.data.frame\u003c/span\u003e(df_tidy_sans_na))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edf_weights_auto \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e df_tidy_sans_na \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(ipw \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e tidy_weights_auto\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eipw.weights)\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNow we can use these new weights in the outcome model:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003emodel_lags_manual \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(d \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t_lag, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_weights_manual,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                            id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e id, weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ipw)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003emodel_lags_auto \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(d \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t_lag, data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_weights_auto, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                          id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e id, weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ipw)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eresults \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etribble\u003c/span\u003e(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e`Method`, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e`T\u0026lt;sub\u0026gt;1\u0026lt;/sub\u0026gt; effect`, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e`T\u0026lt;sub\u0026gt;2\u0026lt;/sub\u0026gt; effect`,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;True effect\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.160\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.400\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;IPW, original\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(stab_ipw), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t1\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(stab_ipw), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t2\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;IPW, lagged, manual\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_lags_manual), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t_lag\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_lags_manual), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;IPW, lagged, automatic\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_lags_auto), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t_lag\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(model_lags_auto), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eacross\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003esprintf\u003c/span\u003e(\u003cspan style=\"color:#e6db74\"\u003e\u0026#34;%.3f\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003eround\u003c/span\u003e(., \u003cspan style=\"color:#ae81ff\"\u003e3\u003c/span\u003e)))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003eadd_row\u003c/span\u003e(`T\u0026lt;sub\u0026gt;1\u0026lt;/sub\u0026gt; effect` \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u0026lt;b\u0026gt;lag(T) effect\u0026lt;/b\u0026gt;\u0026#34;\u003c/span\u003e, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          `T\u0026lt;sub\u0026gt;2\u0026lt;/sub\u0026gt; effect` \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;\u0026lt;b\u0026gt;T effect\u0026lt;/b\u0026gt;\u0026#34;\u003c/span\u003e, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e          .after \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ctable style=\"width:70%; margin-left: auto; margin-right: auto;\" class=\" pure-table pure-table-horizontal\"\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align:left;\"\u003e\nMethod\n\u003c/th\u003e\n\u003cth style=\"text-align:left;\"\u003e\nT\u003csub\u003e1\u003c/sub\u003e effect\n\u003c/th\u003e\n\u003cth style=\"text-align:left;\"\u003e\nT\u003csub\u003e2\u003c/sub\u003e effect\n\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nTrue effect\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n0.160\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n0.400\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nIPW, original\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n0.157\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n0.421\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n—\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n\u003cb\u003elag(T) effect\u003c/b\u003e\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n\u003cb\u003eT effect\u003c/b\u003e\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nIPW, lagged, manual\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n0.150\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n0.441\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nIPW, lagged, automatic\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n0.150\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n0.441\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003eThose results aren’t identical (I don’t know why!), but they’re close-ish, so whatever. It worked! Instead of using explicit \u003ccode\u003et1\u003c/code\u003e, \u003ccode\u003ed1\u003c/code\u003e, etc. columns, we can do the same marginal structural model with just \u003ccode\u003et\u003c/code\u003e and \u003ccode\u003ed\u003c/code\u003e in a long data frame.\u003c/p\u003e\n\u003ch2 id=\"expansion-to-multiple-period-data\"\u003eExpansion to multiple-period data\u003c/h2\u003e\n\u003cp\u003eSince that’s all working, now we can do something a little/lot trickier—instead of manually specifying \u003ccode\u003e\\(T_1\\)\u003c/code\u003e and \u003ccode\u003e\\(T_2\\)\u003c/code\u003e, which isn’t really easily scalable to more time periods, we’ll construct the data more generally for any number of years\u003c/p\u003e\n\u003ch3 id=\"tricky-interdependent-data-generating-process\"\u003eTricky interdependent data generating process\u003c/h3\u003e\n\u003cp\u003eThe trick here is that we want to have any number of time periods, but also maintain the same DAG relationships. In the small data, these are the two general relationships:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003e\\(\\text{treatment}_t = (0.1 \\cdot \\text{confounder}) + (0.4 \\cdot \\text{depression}_{t-1}) + (0.4 \\cdot \\text{treatment}_{t-1}) + \\text{noise}\\)\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003e\\(\\text{depression}_t = (0.1 \\cdot \\text{confounder}) + (0.4 \\cdot \\text{treatment}_{t}) + (0.4 \\cdot \\text{depression}_{t-1}) + \\text{noise}\\)\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eOr in code:\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\u003ccode\u003et = (0.1 * c) + (0.4 * lag(d)) + (0.4 * lag(t)) + rnorm(n, 0, sqrt(0.5196))\u003c/code\u003e\u003c/li\u003e\n\u003cli\u003e\u003ccode\u003ed = (0.1 * c) + (0.4 * t) + (0.4 * lag(d)) + rnorm(n, 0, sqrt(0.4582))\u003c/code\u003e\u003c/li\u003e\n\u003c/ul\u003e\n\u003cp\u003eGenerating this data in a tidy \u003cstrong\u003edplyr\u003c/strong\u003e way is super tricky, since the \u003ccode\u003et\u003c/code\u003e and \u003ccode\u003ed\u003c/code\u003e columns are interdependent—the data has to be generated rowwise, but we also have to be able to look back a row to get the lagged values of \u003ccode\u003et\u003c/code\u003e and \u003ccode\u003ed\u003c/code\u003e. I’ve seen people like \u003ca href=\"#ref-BlackwellGlynn:2018\"\u003eBlackwell and Glynn\u003c/a\u003e (\u003ca href=\"#ref-BlackwellGlynn:2018\"\u003e2018\u003c/a\u003e) get around this by using a \u003ccode\u003efor\u003c/code\u003e loop to build the data, but I have an aversion to for loops in R \u003ca href=\"https://r4ds.had.co.nz/iteration.html#for-loops-vs.-functionals\"\u003esince \u003cstrong\u003epurrr\u003c/strong\u003e exists\u003c/a\u003e, so I spent way too much time trying to figure out a \u003cstrong\u003epurrr\u003c/strong\u003e-based way to do this. Others have tried this (like \u003ca href=\"https://community.rstudio.com/t/row-wise-iteration-in-a-dataframe-with-interdependent-variables/38778\"\u003ethis RStudio Community post\u003c/a\u003e), and I \u003ca href=\"https://twitter.com/andrewheiss/status/1347780639714664448\"\u003easked about it on Twitter\u003c/a\u003e, where I got a few cool solutions using \u003ccode\u003epurrr::accumulate()\u003c/code\u003e and \u003ccode\u003epurrr::reduce()\u003c/code\u003e, like \u003ca href=\"https://twitter.com/ianmoran011/status/1347849678696574977\"\u003ethis fancy \u003ccode\u003eaccumutate()\u003c/code\u003e function from Ian Moran\u003c/a\u003e and \u003ca href=\"https://gist.github.com/andrewheiss/89ae26a7a4682aff0ee9b7db1e92c326#gistcomment-3587810\"\u003ethese solutions from Miles McBain\u003c/a\u003e.\u003c/p\u003e\n\u003cp\u003eThere are no loops involved in those solutions, but phew that accumulate/reduce syntax is wonky and I can’t fully wrap my head around it (plus it makes it hard to carry over non-accumulated variables). So I resorted to a loop. Oooof.\u003c/p\u003e\n\u003cp\u003eIt works, though! Let’s test it on just one ID. We’ll generate just one row with \u003ccode\u003et1\u003c/code\u003e, \u003ccode\u003et2\u003c/code\u003e, \u003ccode\u003ed1\u003c/code\u003e, and \u003ccode\u003ed2\u003c/code\u003e, and we’ll remove the noise from each of the columns:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003eset.seed\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e12345\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003en \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# Remove all noise so that we can compare this with the function version\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edf_example \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etibble\u003c/span\u003e(id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003en,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                     c \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(n, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(t1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e c),\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e         d1 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e c) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e t1),\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e         t2 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e c) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e d1) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e t1),\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e         d2 \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e c) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e t2) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e d1))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edf_example\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 1 x 6\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##      id     c     t1     d1    t2    d2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;int\u0026gt; \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## 1     1 0.586 0.0586 0.0820 0.115 0.137\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThis isn’t tidy data, so technically there are two years here. We’ll keep \u003ccode\u003et1\u003c/code\u003e and \u003ccode\u003ed1\u003c/code\u003e as the initial values for year 1, then generate values for 5 years. If we do this right, the \u003ccode\u003et\u003c/code\u003e and \u003ccode\u003ed\u003c/code\u003e values for year 2 should be identical to \u003ccode\u003et2\u003c/code\u003e and \u003ccode\u003ed2\u003c/code\u003e here.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# Add a bunch of extra years with empty cells for t and d\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edf_multiple_years_empty \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e df_example \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(id, y, t \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e t1, d \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e d1, c) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003eadd_row\u003c/span\u003e(y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#75715e\"\u003e# c doesn\u0026#39;t vary across time\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e         c \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_example\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ec[1])\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edf_multiple_years_empty\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 5 x 5\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##      id     y       t       d     c\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;   \u0026lt;dbl\u0026gt;   \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## 1     1     1  0.0586  0.0820 0.586\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## 2     1     2 NA      NA      0.586\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## 3     1     3 NA      NA      0.586\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## 4     1     4 NA      NA      0.586\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## 5     1     5 NA      NA      0.586\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# Now we need to build the interdependent values for t and d with \u0026lt;gasp\u0026gt; a loop\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e#\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# The loop is inside this function---it skips the initial row and then\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# iteratively adds new rows. We can\u0026#39;t use neat things like lag(t), so instead\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# we use df$t[i - 1]\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# We omit the extra noise for now\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edgp \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(df) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003efor \u003c/span\u003e(i in \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003enrow\u003c/span\u003e(df)) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et[i] \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ec[i]) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ed[i \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e]) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et[i \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e])\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ed[i] \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ec[i]) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et[i]) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ed[i \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e])\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  df\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# Generate all 5 years\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edf_multiple_years_empty \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003edgp\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 5 x 5\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##      id     y      t      d     c\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## 1     1     1 0.0586 0.0820 0.586\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## 2     1     2 0.115  0.137  0.586\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## 3     1     3 0.159  0.177  0.586\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## 4     1     4 0.193  0.207  0.586\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## 5     1     5 0.219  0.229  0.586\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eIf this worked, the \u003ccode\u003et\u003c/code\u003e and \u003ccode\u003ed\u003c/code\u003e values for year 2 should be the same as \u003ccode\u003et2\u003c/code\u003e and \u003ccode\u003ed2\u003c/code\u003e here:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edf_example\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 1 x 6\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##      id     c     t1     d1    t2    d2\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##   \u0026lt;int\u0026gt; \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt; \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## 1     1 0.586 0.0586 0.0820 0.115 0.137\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eThey are!\u003c/p\u003e\n\u003cp\u003eSince we know it works, let’s generate a big dataset for playing with multi-year MSMs, this time with noise:\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003eset.seed\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1234\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# Make data for the first year\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edf_first_year \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eexpand_grid\u003c/span\u003e(id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e2000\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(c \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003en\u003c/span\u003e(), \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e),\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e         t \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e c) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003en\u003c/span\u003e(), \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.99\u003c/span\u003e)),\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e         d \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e c) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e t) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003en\u003c/span\u003e(), \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.822\u003c/span\u003e)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edf_first_year\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 2,000 x 5\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##       id     y      c        t       d\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##    \u0026lt;int\u0026gt; \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;    \u0026lt;dbl\u0026gt;   \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  1     1     1 -1.21  -1.09    -1.43  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  2     2     1  0.277 -0.0714  -0.739 \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  3     3     1  1.08  -0.00174 -0.0686\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  4     4     1 -2.35   0.952    1.88  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  5     5     1  0.429 -1.60     0.0373\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  6     6     1  0.506 -0.990    0.535 \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  7     7     1 -0.575 -1.79    -0.889 \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  8     8     1 -0.547  0.456   -1.14  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  9     9     1 -0.564 -0.500    0.386 \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## 10    10     1 -0.890 -1.92    -1.04  \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## # … with 1,990 more rows\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# Add empty years 2-5\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edf_panel_empty \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e df_first_year \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003ebind_rows\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eexpand_grid\u003c/span\u003e(id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e2000\u003c/span\u003e, y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#ae81ff\"\u003e5\u003c/span\u003e)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003earrange\u003c/span\u003e(id, y)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(df_panel_empty, \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 10 x 5\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##       id     y      c       t      d\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##    \u0026lt;int\u0026gt; \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;   \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  1     1     1 -1.21  -1.09   -1.43 \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  2     1     2 NA     NA      NA    \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  3     1     3 NA     NA      NA    \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  4     1     4 NA     NA      NA    \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  5     1     5 NA     NA      NA    \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  6     2     1  0.277 -0.0714 -0.739\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  7     2     2 NA     NA      NA    \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  8     2     3 NA     NA      NA    \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  9     2     4 NA     NA      NA    \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## 10     2     5 NA     NA      NA\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# Add noise to the fancy dgp() function\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edgp \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003efunction\u003c/span\u003e(df) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003efor \u003c/span\u003e(i in \u003cspan style=\"color:#ae81ff\"\u003e2\u003c/span\u003e\u003cspan style=\"color:#f92672\"\u003e:\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003enrow\u003c/span\u003e(df)) {\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et[i] \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ec[i]) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ed[i \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e]) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et[i \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e]) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.5196\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e    df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ed[i] \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ec[i]) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et[i]) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e0.4\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e*\u003c/span\u003e df\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003ed[i \u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003e \u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e]) \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ernorm\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003esqrt\u003c/span\u003e(\u003cspan style=\"color:#ae81ff\"\u003e0.4582\u003c/span\u003e))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  }\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  df\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e}\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# Run dgp() within each id\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edf_panel \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e df_panel_empty \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(id) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#75715e\"\u003e# This doesn\u0026#39;t vary with time, so repeat it across all the years\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(c \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e c[1]) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#75715e\"\u003e# Nest the data into a single cell in each row\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003enest\u003c/span\u003e() \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#75715e\"\u003e# Run dgp() on the nested cell (in a column named \u0026#34;data\u0026#34;)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(dgp \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003emap\u003c/span\u003e(data, dgp)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003eselect\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e-\u003c/span\u003edata) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#75715e\"\u003e# Unnest the nested dgp()-ed cells\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003eunnest\u003c/span\u003e(dgp) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#75715e\"\u003e# Add some lags\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eacross\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003ec\u003c/span\u003e(t, d), \u003cspan style=\"color:#a6e22e\"\u003elist\u003c/span\u003e(lag \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e lag))) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003eungroup\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#a6e22e\"\u003ehead\u003c/span\u003e(df_panel, \u003cspan style=\"color:#ae81ff\"\u003e10\u003c/span\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## # A tibble: 10 x 7\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##       id     y      c       t      d   t_lag  d_lag\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##    \u0026lt;int\u0026gt; \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;   \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;   \u0026lt;dbl\u0026gt;  \u0026lt;dbl\u0026gt;\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  1     1     1 -1.21  -1.09   -1.43  NA      NA    \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  2     1     2 -1.21  -1.11   -1.28  -1.09   -1.43 \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  3     1     3 -1.21  -1.83   -1.35  -1.11   -1.28 \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  4     1     4 -1.21  -1.62   -1.20  -1.83   -1.35 \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  5     1     5 -1.21  -1.62   -0.981 -1.62   -1.20 \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  6     2     1  0.277 -0.0714 -0.739 NA      NA    \u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  7     2     2  0.277  1.09    0.116 -0.0714 -0.739\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  8     2     3  0.277  1.43    0.562  1.09    0.116\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e##  9     2     4  0.277  0.584  -0.606  1.43    0.562\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e## 10     2     5  0.277 -0.881   0.603  0.584  -0.606\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ch3 id=\"multiple-period-marginal-structural-models\"\u003eMultiple-period marginal structural models\u003c/h3\u003e\n\u003cp\u003eCool cool cool. We have multi-period data where variables depend on their lagged values and other interdependent columns. Let’s build some MSMs!\u003c/p\u003e\n\u003cp\u003eWe’re going to build weights two different ways here. Because the data has a time-series cross-sectional structure (with multiple individuals across multiple years), the weight models need to account for that structure. Everywhere I’ve seen elsewhere uses generalized estimating equations (GEEs) for these models (and that’s what the \u003cstrong\u003eipw\u003c/strong\u003e package uses behind the scenes), but I’m a fan of multilevel models, so I’ll make weights with both to compare their results.\u003c/p\u003e\n\u003cp\u003eWe’ll use the same equation as before—the cumulative product of the ratio of two probability distributions:\u003c/p\u003e\n\u003cp\u003e$$\nw = \\prod^t_{t = 1} \\frac{\\phi(T_{it} | T_{i, t-1}, C_i)}{\\phi(T_{it} | T_{i, t-1}, D_{i, t-1}, C_i)}\n$$\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# Again, ipw complains about missing values, so get rid of them (i.e. all year 1)\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edf_panel_sans_na \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e df_panel \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#f92672\"\u003e!\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003eis.na\u003c/span\u003e(t_lag)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(y \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eas.numeric\u003c/span\u003e(y))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# Manually\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# Numerator is lagged treatment + non-varying confounders\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# ipw uses GEE models to account for panel structure, so use them here too\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003emodel_num_gee \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(t \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e c, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e id, waves \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, corstr \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ar1\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_panel_sans_na)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# But we can also use mixed models with lmer\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003emodel_num_multi \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elmer\u003c/span\u003e(t \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e c \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e id),\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                        data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_panel_sans_na)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# Denominator is lagged treatment, lagged outcome, time-varying confounders +\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# non-varying confounders\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003emodel_denom_gee \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(t \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e d_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e c, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                          id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e id, waves \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, corstr \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ar1\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                          data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_panel_sans_na)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003emodel_denom_multi \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elmer\u003c/span\u003e(t \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e d_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e c \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e id),\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                          data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_panel_sans_na)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# Probability distributions\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003enum_gee \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(df_panel_sans_na\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e             \u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(model_num_gee),\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e             \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eresiduals\u003c/span\u003e(model_num_gee)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eden_gee \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(df_panel_sans_na\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                 \u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(model_denom_gee),\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                 \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eresiduals\u003c/span\u003e(model_denom_gee)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003enum_multi \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(df_panel_sans_na\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                   \u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(model_num_multi),\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                   \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eresiduals\u003c/span\u003e(model_num_multi)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eden_multi \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ednorm\u003c/span\u003e(df_panel_sans_na\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003et,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                   \u003cspan style=\"color:#a6e22e\"\u003epredict\u003c/span\u003e(model_denom_multi),\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                   \u003cspan style=\"color:#a6e22e\"\u003esd\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003eresiduals\u003c/span\u003e(model_denom_multi)))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edf_panel_weights_manual \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e df_panel_sans_na \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(weights_no_time_gee \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e num_gee \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e den_gee,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e         weights_no_time_multi \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e num_multi \u003cspan style=\"color:#f92672\"\u003e/\u003c/span\u003e den_multi) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003egroup_by\u003c/span\u003e(id) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(ipw_gee \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecumprod\u003c/span\u003e(weights_no_time_gee),\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e         ipw_multi \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003ecumprod\u003c/span\u003e(weights_no_time_multi)) \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003eungroup\u003c/span\u003e()\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\u003cspan style=\"color:#75715e\"\u003e# Automatically with ipwtm()\u003c/span\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003epanel_weights_auto \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eipwtm\u003c/span\u003e(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  exposure \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e t,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  family \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;gaussian\u0026#34;\u003c/span\u003e, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  numerator \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e c, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  denominator \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e d_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e c, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e id,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  timevar \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  type \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;all\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  corstr \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;ar1\u0026#34;\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003eas.data.frame\u003c/span\u003e(df_panel_sans_na))\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003edf_panel_weights_auto \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e df_panel_sans_na \u003cspan style=\"color:#f92672\"\u003e%\u0026gt;%\u003c/span\u003e \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#a6e22e\"\u003emutate\u003c/span\u003e(ipw \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e panel_weights_auto\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eipw.weights)\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003cp\u003eNow we can build the outcome models, using both GEE and multilevel models.\u003c/p\u003e\n\u003cdiv class=\"highlight\"\u003e\u003cpre tabindex=\"0\" style=\"color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;\"\u003e\u003ccode class=\"language-r\" data-lang=\"r\"\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003em_manual_gee \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(d \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t_lag, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                       data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_panel_weights_manual,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                       id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e id, waves \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                       weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ipw_gee)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003em_auto_gee \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003egeeglm\u003c/span\u003e(d \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t_lag, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                     data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_panel_weights_auto, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                     id \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e id, waves \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e y, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                     weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ipw)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003em_lmer_manual_gee_wt \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elmer\u003c/span\u003e(d \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e id), \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                             data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_panel_weights_manual, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                             weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ipw_gee)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003em_lmer_auto_gee_wt \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elmer\u003c/span\u003e(d \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e id), \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                           data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_panel_weights_auto, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                           weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ipw)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003em_lmer_manual_multi_wt \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003elmer\u003c/span\u003e(d \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e t \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e t_lag \u003cspan style=\"color:#f92672\"\u003e+\u003c/span\u003e (\u003cspan style=\"color:#ae81ff\"\u003e1\u003c/span\u003e \u003cspan style=\"color:#f92672\"\u003e|\u003c/span\u003e id), \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                               data \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e df_panel_weights_manual, \n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e                               weights \u003cspan style=\"color:#f92672\"\u003e=\u003c/span\u003e ipw_multi)\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003eresults \u003cspan style=\"color:#f92672\"\u003e\u0026lt;-\u003c/span\u003e \u003cspan style=\"color:#a6e22e\"\u003etribble\u003c/span\u003e(\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e`Method`, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e`Weights`, \u003cspan style=\"color:#f92672\"\u003e~\u003c/span\u003e\u003cspan style=\"color:#a6e22e\"\u003e`lag\u003c/span\u003e(T) effect`, ~`T effect`,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;True effect\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#66d9ef\"\u003eNA\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.160\u003c/span\u003e, \u003cspan style=\"color:#ae81ff\"\u003e0.400\u003c/span\u003e,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Panel with GEE\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Manual GEE weights\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(m_manual_gee), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t_lag\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(m_manual_gee), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Panel with GEE\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Automatic GEE weights\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(m_auto_gee), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t_lag\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(m_auto_gee), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Panel with multilevel model\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Manual GEE weights\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(m_lmer_manual_gee_wt), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t_lag\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(m_lmer_manual_gee_wt), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Panel with multilevel model\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Automatic GEE weights\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(m_lmer_auto_gee_wt), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t_lag\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(m_lmer_auto_gee_wt), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate,\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e  \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Panel with multilevel model\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;Manual multilevel weights\u0026#34;\u003c/span\u003e, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(m_lmer_manual_multi_wt), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t_lag\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate, \u003cspan style=\"color:#a6e22e\"\u003efilter\u003c/span\u003e(\u003cspan style=\"color:#a6e22e\"\u003etidy\u003c/span\u003e(m_lmer_manual_multi_wt), term \u003cspan style=\"color:#f92672\"\u003e==\u003c/span\u003e \u003cspan style=\"color:#e6db74\"\u003e\u0026#34;t\u0026#34;\u003c/span\u003e)\u003cspan style=\"color:#f92672\"\u003e$\u003c/span\u003eestimate\n\u003c/span\u003e\u003c/span\u003e\u003cspan style=\"display:flex;\"\u003e\u003cspan\u003e)\n\u003c/span\u003e\u003c/span\u003e\u003c/code\u003e\u003c/pre\u003e\u003c/div\u003e\u003ctable style=\"width:90%; margin-left: auto; margin-right: auto;\" class=\" pure-table pure-table-horizontal\"\u003e\n\u003cthead\u003e\n\u003ctr\u003e\n\u003cth style=\"text-align:left;\"\u003e\nMethod\n\u003c/th\u003e\n\u003cth style=\"text-align:left;\"\u003e\nWeights\n\u003c/th\u003e\n\u003cth style=\"text-align:right;\"\u003e\nlag(T) effect\n\u003c/th\u003e\n\u003cth style=\"text-align:right;\"\u003e\nT effect\n\u003c/th\u003e\n\u003c/tr\u003e\n\u003c/thead\u003e\n\u003ctbody\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nTrue effect\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\n—\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.160\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.400\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nPanel with GEE\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nManual GEE weights\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.230\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.429\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nPanel with GEE\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nAutomatic GEE weights\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.230\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.429\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nPanel with multilevel model\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nManual GEE weights\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.195\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.408\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nPanel with multilevel model\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nAutomatic GEE weights\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.195\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.408\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003ctr\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nPanel with multilevel model\n\u003c/td\u003e\n\u003ctd style=\"text-align:left;\"\u003e\nManual multilevel weights\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.196\n\u003c/td\u003e\n\u003ctd style=\"text-align:right;\"\u003e\n0.414\n\u003c/td\u003e\n\u003c/tr\u003e\n\u003c/tbody\u003e\n\u003c/table\u003e\n\u003cp\u003ePhew.\u003c/p\u003e\n\u003cp\u003eAll of the models here are relatively close to the true effect for \u003ccode\u003e\\(T_t\\)\u003c/code\u003e! (Though they’re all sizably off for \u003ccode\u003e\\(T_{t-1}\\)\u003c/code\u003e, but I don’t know why).\u003c/p\u003e\n\u003cp\u003eImportantly, it seems that mixed models work just fine for both weights and outcome models, which means there’s probably no need to use GEE (and this can all be done Bayesianly with \u003ccode\u003ebrms()\u003c/code\u003e!).\u003c/p\u003e\n\u003cp\u003eIt works!\u003c/p\u003e\n\u003ch2 id=\"questions-for-the-future\"\u003eQuestions for the future\u003c/h2\u003e\n\u003cp\u003eI still have some lingering things to check (forthcoming in a future blog post):\u003c/p\u003e\n\u003cul\u003e\n\u003cli\u003e\n\u003cp\u003e\u003ccode\u003ey\u003c/code\u003e isn’t any any of the models: weights numerator, weights denominator, or outcome. If I include it in any of the models, the there’s perfect fit. That may be because there are no time-varying confounders? I think year might need to be in there somewhere, but I’m not sure. \u003ca href=\"#ref-BlackwellGlynn:2018\"\u003eBlackwell and Glynn\u003c/a\u003e (\u003ca href=\"#ref-BlackwellGlynn:2018\"\u003e2018\u003c/a\u003e) include year in the numerator and denominator for weights in their Swank Steinmo replication, but not in their Burgoon replication.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThis example has no time-varying confounders. I need to see how this all works with those.\u003c/p\u003e\n\u003c/li\u003e\n\u003cli\u003e\n\u003cp\u003eThis DAG for this example is pretty simple. I need to see what happens when there are \u003cem\u003ealso\u003c/em\u003e direct arrows from \u003ccode\u003e\\(T_{t-1} \\rightarrow T_{t}\\)\u003c/code\u003e and \u003ccode\u003e\\(D_{t-1} \\rightarrow D_{t}\\)\u003c/code\u003e.\u003c/p\u003e\n\u003c/li\u003e\n\u003c/ul\u003e\n\u003ch2 id=\"references\"\u003eReferences\u003c/h2\u003e\n\u003cdiv id=\"refs\" class=\"references csl-bib-body hanging-indent\"\u003e\n\u003cdiv id=\"ref-BlackwellGlynn:2018\" class=\"csl-entry\"\u003e\n\u003cp\u003eBlackwell, Matthew, and Adam N. Glynn. 2018. “How to Make Causal Inferences with Time-Series Cross-Sectional Data Under Selection on Observables.” \u003cem\u003eAmerican Political Science Review\u003c/em\u003e 112 (4): 1067–82. \u003ca href=\"https://doi.org/10.1017/s0003055418000357\"\u003ehttps://doi.org/10.1017/s0003055418000357\u003c/a\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003cdiv id=\"ref-ThoemmesOng:2016\" class=\"csl-entry\"\u003e\n\u003cp\u003eThoemmes, Felix, and Anthony D. Ong. 2016. “A Primer on Inverse Probability of Treatment Weighting and Marginal Structural Models.” \u003cem\u003eEmerging Adulthood\u003c/em\u003e 4 (1): 40–59. \u003ca href=\"https://doi.org/10.1177/2167696815621645\"\u003ehttps://doi.org/10.1177/2167696815621645\u003c/a\u003e.\u003c/p\u003e\n\u003c/div\u003e\n\u003c/div\u003e\n",
            "date_published": "2021-01-15T00:00:00Z",
            "author": {
                "name": "Shagun Jhaver"   
            }
        }
    ]
}

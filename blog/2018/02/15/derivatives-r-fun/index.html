<!DOCTYPE html>
<html lang="en"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">

    <meta name="author" content="Shagun Jhaver">
    <meta name="description" content="Use R to do things with derivatives, both with actual functions and with existing empirical data.">
    <meta name="keywords" content="r, ggplot, dataviz, economics">
    <meta name="generator" content="Hugo 0.88.1" />

    <title>
  Fun with empirical and function-based derivatives in R | Shagun Jhaver
</title>

    <link rel="canonical" href="https://www.shagunjhaver.com/blog/2018/02/15/derivatives-r-fun/">
    <link rel="alternate" type="application/atom+xml" title="Blog Posts" href="https://www.shagunjhaver.com/atom.xml">
    <link rel="alternate" type="application/json" title="JSON Feed" href="https://www.shagunjhaver.com/feed.json">

    <link rel="openid2.provider" href="https://www.google.com/accounts/o8/ud?source=profiles">
    <link rel="openid2.local_id" href="https://www.google.com/profiles/andrewheiss">

    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://www.shagunjhaver.com/blog/2018/02/15/derivatives-r-fun/plot-all-empirical-1.png"/>
    <meta name="twitter:site" content="@shagunjhaver"/>
    <meta name="twitter:title" content="Fun with empirical and function-based derivatives in R"/>
    <meta name="twitter:creator" content="@shagunjhaver"/>
    <meta name="twitter:description" content="Use R to do things with derivatives, both with actual functions and with existing empirical data."/>


    <meta property="og:title" content="Fun with empirical and function-based derivatives in R" />
<meta property="og:description" content="Use R to do things with derivatives, both with actual functions and with existing empirical data." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.shagunjhaver.com/blog/2018/02/15/derivatives-r-fun/" />
<meta property="og:image" content="https://www.shagunjhaver.com/blog/2018/02/15/derivatives-r-fun/plot-all-empirical-1.png" />
<meta property="article:published_time" content="2018-02-15T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-02-15T00:00:00+00:00" />

<meta property="article:author" content="https://www.facebook.com/shagun.jhaver" />
<meta property="article:publisher" content="https://www.facebook.com/shagun.jhaver" />
<meta property="article:section" content="blog" />
<meta property="article:tag" content="r" />
<meta property="article:tag" content="ggplot" />
<meta property="article:tag" content="dataviz" />
<meta property="article:tag" content="economics" />


    <meta itemprop="name" content="Fun with empirical and function-based derivatives in R">
<meta itemprop="description" content="Use R to do things with derivatives, both with actual functions and with existing empirical data."><meta itemprop="datePublished" content="2018-02-15T00:00:00+00:00" />
<meta itemprop="dateModified" content="2018-02-15T00:00:00+00:00" />
<meta itemprop="wordCount" content="1441"><meta itemprop="image" content="https://www.shagunjhaver.com/blog/2018/02/15/derivatives-r-fun/plot-all-empirical-1.png">
<meta itemprop="keywords" content="r,ggplot,dataviz,economics," />

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/pure-and-grids-responsive.min.css">
    <link rel="stylesheet" href="/css/ath-hugo.min.8bd4ca9cfb65245be6d4d5e8c998e1ac3888ce29fb6de24c81ee5129485d89e3.css" integrity="sha256-i9TKnPtlJFvm1NXoyZjhrDiIzin7beJMge5RKUhdieM=" crossorigin="anonymous" media="screen" />

    <script src="https://kit.fontawesome.com/f9d343c40d.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">    

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=dLX2MbQJLG">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=dLX2MbQJLG">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=dLX2MbQJLG">
    <link rel="manifest" href="/site.webmanifest?v=dLX2MbQJLG">
    <link rel="mask-icon" href="/safari-pinned-tab.svg?v=dLX2MbQJLG" color="#cf4446">
    <link rel="shortcut icon" href="/favicon.ico?v=dLX2MbQJLG">
    <meta name="msapplication-TileColor" content="#170c3a">
    <meta name="theme-color" content="#170c3a">

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-527449-5', 'auto');
      ga('send', 'pageview');
    </script>
</head>

<body>

    <div id="layout" class="pure-g">
        <div id="sidebar" class="pure-u-1 pure-u-md-1-4">
            <header>
                <h1 class="title"><a href="/">Shagun Jhaver</a></h1>
                <h2 class="minibio">Social computing, CSCW, HCI, content moderation, and online harassment</h2>

                <nav id="main-nav">
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a class="nav-link" href="/">About</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/cv/">CV</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/research/">Research</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/teaching/">Teaching</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/news/">News</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/now/">Now</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/work-with-me/">Work with me!</a>
                        </li>
                    </ul>
                </nav>
            </header>

        </div> 
    
        <div id="content" class="pure-u-1 pure-u-md-3-4">
        
  <section>
    <article class="content-single">
        <header class="post-header">
            <h1 class="post-title">Fun with empirical and function-based derivatives in R</h1>

            <div class="post-meta pure-g">
                <div class="pure-u-1-2">
                    <span class="posted-on">
                        <i class="far fa-calendar-alt" aria-hidden="true"></i>
                        <time datetime='2018-02-15T00:00:00Z'>
                            Thursday, February 15, 2018
                        </time>
                    </span>
                </div>
                <div class="reading-time pure-u-1-2">
                    <i class="far fa-clock" aria-hidden="true"></i>
                    7-minute read
                </div>
            </div>
        </header>
    
        <script src="/blog/2018/02/15/derivatives-r-fun/index_files/kePrint-0.0.1/kePrint.js"></script>
<link href="/blog/2018/02/15/derivatives-r-fun/index_files/lightable-0.0.1/lightable.css" rel="stylesheet" />
<p><span class="small">(<a href="https://github.com/andrewheiss/derivatives-r-fun">See this notebook on GitHub</a>)</span></p>
<hr>
<p><em>tl;dr</em>: Use functions like <code>Deriv::Deriv()</code>, <code>splinefun()</code>, <code>approxfun()</code>, and <code>uniroot()</code> to do things with derivatives in R, both with actual functions and with existing empirical data</p>
<hr>
<p>A typical microeconomics problem involves finding the optimal price and quantity of a product, given its demand and cost across different quantities. You can optimize this price and quantity and maximize profit by finding the point where the marginal cost and the marginal revenue (or the first derivatives of the cost and revenue functions) are equal to each other.</p>
<p>For instance, the demand for some product can be defined as <code>\(Q = 10 - 2P\)</code> (where <code>\(Q =\)</code> quantity and <code>\(P =\)</code> price). The revenue you get from selling that product is defined as <code>\(R = PQ\)</code> (just multiplying price Ã— quantity), so through some algebraic trickery and rearranging of Ps and Qs, you can create a revenue function for this demand curve: <code>\(R = 5Q - 0.5Q^2\)</code>. The cost function for this product can be defined as <code>\(C = 0.25Q + 0.5Q^2\)</code>.</p>
<p>To figure out the optimal profit, we set the marginal cost and marginal revenue equations equal to each other and solve for Q. Here, <code>\(\frac{dC}{dQ} = MC = 0.25 + 0.5Q\)</code> and <code>\(\frac{dR}{dQ} = MR = 5 - Q\)</code>, so with algebra we can find the optimal point:</p>
<p>$$
<code>\begin{aligned} MC &amp;= MR \\ 0.25 + 0.5Q &amp;= 5 - Q \\ 1.5Q &amp;= 4.75 \\ Q &amp;= 3.1\overline{66} \end{aligned}</code>
$$</p>
<p>Phew. Calculus.</p>
<p>Doing this in R is fairly straightforward and far more flexible and far less algebra-intensive. First, define the functions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(tidyverse)
<span style="color:#a6e22e">library</span>(Deriv)
<span style="color:#a6e22e">library</span>(pander)

demand <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(q) <span style="color:#ae81ff">5</span> <span style="color:#f92672">-</span> (<span style="color:#ae81ff">0.5</span> <span style="color:#f92672">*</span> q)
revenue <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(q) (<span style="color:#ae81ff">5</span> <span style="color:#f92672">-</span> <span style="color:#ae81ff">0.5</span> <span style="color:#f92672">*</span> q) <span style="color:#f92672">*</span> q

cost <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">function</span>(q) (<span style="color:#ae81ff">0.25</span> <span style="color:#f92672">*</span> q) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.5</span> <span style="color:#f92672">*</span> q)^2
</code></pre></div><p>Plotting these functions is easy with <code>geom_function()</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">ggplot</span>(data <span style="color:#f92672">=</span> <span style="color:#a6e22e">tibble</span>(x <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">10</span>), <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> x)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_function</span>(fun <span style="color:#f92672">=</span> cost, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">aes</span>(color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Total cost&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_function</span>(fun <span style="color:#f92672">=</span> revenue, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">aes</span>(color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Total revenue&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Quantity&#34;</span>, y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Price&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_y_continuous</span>(labels <span style="color:#f92672">=</span> scales<span style="color:#f92672">::</span>dollar) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_color_manual</span>(values <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Total cost&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;red&#34;</span>, <span style="color:#e6db74">&#34;Total revenue&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blue&#34;</span>),
                     name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Function&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_light</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme</span>(legend.position <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bottom&#34;</span>)
</code></pre></div><p><img src="/blog/2018/02/15/derivatives-r-fun/index_files/figure-html/plot-functions-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Then, using <code>Deriv::Deriv()</code>, create derivative functions for the marginal cost and marginal revenue equations:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">mr <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">Deriv</span>(revenue, <span style="color:#e6db74">&#34;q&#34;</span>)
mc <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">Deriv</span>(cost, <span style="color:#e6db74">&#34;q&#34;</span>)
</code></pre></div><p>We can also plot these:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">ggplot</span>(data <span style="color:#f92672">=</span> <span style="color:#a6e22e">tibble</span>(x <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">10</span>), <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> x)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_function</span>(fun <span style="color:#f92672">=</span> mc, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">aes</span>(color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Marginal cost&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_function</span>(fun <span style="color:#f92672">=</span> mr, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, <span style="color:#a6e22e">aes</span>(color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Marginal revenue&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Quantity&#34;</span>, y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Price&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_y_continuous</span>(labels <span style="color:#f92672">=</span> scales<span style="color:#f92672">::</span>dollar) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_color_manual</span>(values <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Marginal cost&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;red&#34;</span>, <span style="color:#e6db74">&#34;Marginal revenue&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blue&#34;</span>),
                     name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Function&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">coord_cartesian</span>(ylim <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">6</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_light</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme</span>(legend.position <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bottom&#34;</span>)
</code></pre></div><p><img src="/blog/2018/02/15/derivatives-r-fun/index_files/figure-html/plot-marginal-functions-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Finally, use the <code>uniroot()</code> function to look for the point where <code>mc</code> and <code>mr</code> intersect within a given range (here I&rsquo;m looking between 1 and 10 since the demand curve goes negative after <code>\(Q =\)</code> 10):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">optimal_q <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">uniroot</span>(<span style="color:#a6e22e">function</span>(x) <span style="color:#a6e22e">mc</span>(x) <span style="color:#f92672">-</span> <span style="color:#a6e22e">mr</span>(x), <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">10</span>))
optimal_q<span style="color:#f92672">$</span>root
<span style="color:#75715e">## [1] 3.166667</span>
</code></pre></div><p>It&rsquo;s the same answer!</p>
<p>We can then plug <code>optimal_q$root</code> back into the marginal revenue and demand functions to find the optimal price (in a competitive market, the price should be equal to the marginal revenue, but this happens to be a monopoly, so the actual price is higher, but that&rsquo;s totally unrelated to the topic here):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">mr</span>(optimal_q<span style="color:#f92672">$</span>root)
<span style="color:#75715e">## [1] 1.833333</span>
<span style="color:#a6e22e">demand</span>(optimal_q<span style="color:#f92672">$</span>root)
<span style="color:#75715e">## [1] 3.416667</span>
<span style="color:#75715e"># oh noes monopolies</span>
</code></pre></div><p><strong>However! Wait! Stop!</strong> This is all well and fine if you have precise formulas for demand and cost. But real life is far messier than this. What if you don&rsquo;t know the underlying equations?</p>
<p>Often in economics, you have a set of quantities and prices based on empirical data. Market research and surveys can estimate the demand for a product, and tracking how fixed and variable costs change over time can estimate the costs for a product, but this data is all empirically based and not based in actual formulas.</p>
<p>For instance, suppose you have this table of prices, quantities, and costs (which is actually really based on the demand and cost functions from earlier):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">costs_revenues <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tibble</span>(Quantity <span style="color:#f92672">=</span> <span style="color:#a6e22e">seq</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">10</span>, <span style="color:#ae81ff">1</span>),
                         Price <span style="color:#f92672">=</span> <span style="color:#a6e22e">demand</span>(Quantity),
                         `Total Revenue` <span style="color:#f92672">=</span> <span style="color:#a6e22e">revenue</span>(Quantity),
                         `Total Cost` <span style="color:#f92672">=</span> <span style="color:#a6e22e">cost</span>(Quantity),
                         Profit <span style="color:#f92672">=</span> `Total Revenue` <span style="color:#f92672">-</span> `Total Cost`)
</code></pre></div><table class=" pure-table pure-table-horizontal" style="margin-left: auto; margin-right: auto;">
 <thead>
  <tr>
   <th style="text-align:right;"> Quantity </th>
   <th style="text-align:left;"> Price </th>
   <th style="text-align:left;"> Total Revenue </th>
   <th style="text-align:left;"> Total Cost </th>
   <th style="text-align:left;"> Profit </th>
  </tr>
 </thead>
<tbody>
  <tr>
   <td style="text-align:right;"> 0 </td>
   <td style="text-align:left;"> $5.00 </td>
   <td style="text-align:left;"> $0.00 </td>
   <td style="text-align:left;"> $0.00 </td>
   <td style="text-align:left;"> $0.00 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 1 </td>
   <td style="text-align:left;"> $4.50 </td>
   <td style="text-align:left;"> $4.50 </td>
   <td style="text-align:left;"> $0.50 </td>
   <td style="text-align:left;"> $4.00 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 2 </td>
   <td style="text-align:left;"> $4.00 </td>
   <td style="text-align:left;"> $8.00 </td>
   <td style="text-align:left;"> $1.50 </td>
   <td style="text-align:left;"> $6.50 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 3 </td>
   <td style="text-align:left;"> $3.50 </td>
   <td style="text-align:left;"> $10.50 </td>
   <td style="text-align:left;"> $3.00 </td>
   <td style="text-align:left;"> $7.50 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 4 </td>
   <td style="text-align:left;"> $3.00 </td>
   <td style="text-align:left;"> $12.00 </td>
   <td style="text-align:left;"> $5.00 </td>
   <td style="text-align:left;"> $7.00 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 5 </td>
   <td style="text-align:left;"> $2.50 </td>
   <td style="text-align:left;"> $12.50 </td>
   <td style="text-align:left;"> $7.50 </td>
   <td style="text-align:left;"> $5.00 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 6 </td>
   <td style="text-align:left;"> $2.00 </td>
   <td style="text-align:left;"> $12.00 </td>
   <td style="text-align:left;"> $10.50 </td>
   <td style="text-align:left;"> $1.50 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 7 </td>
   <td style="text-align:left;"> $1.50 </td>
   <td style="text-align:left;"> $10.50 </td>
   <td style="text-align:left;"> $14.00 </td>
   <td style="text-align:left;"> -$3.50 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 8 </td>
   <td style="text-align:left;"> $1.00 </td>
   <td style="text-align:left;"> $8.00 </td>
   <td style="text-align:left;"> $18.00 </td>
   <td style="text-align:left;"> -$10.00 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 9 </td>
   <td style="text-align:left;"> $0.50 </td>
   <td style="text-align:left;"> $4.50 </td>
   <td style="text-align:left;"> $22.50 </td>
   <td style="text-align:left;"> -$18.00 </td>
  </tr>
  <tr>
   <td style="text-align:right;"> 10 </td>
   <td style="text-align:left;"> $0.00 </td>
   <td style="text-align:left;"> $0.00 </td>
   <td style="text-align:left;"> $27.50 </td>
   <td style="text-align:left;"> -$27.50 </td>
  </tr>
</tbody>
</table>
<p>We can still use R to find the optimal quantity, <em><strong>even without actual formulas</strong></em>. R has two base functions for approximating functions based on existing data. <code>approxfun()</code> will try to fit data linearly, and <code>splinefun()</code> will try to fit data with cubic splines (i.e. it can handle curvy lines better than <code>approxfun()</code>).</p>
<p>First, we can plot the revenue and cost columns to see their shape:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">costs_revenues_plot <span style="color:#f92672">&lt;-</span> costs_revenues <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">select</span>(Quantity, <span style="color:#a6e22e">starts_with</span>(<span style="color:#e6db74">&#34;Total&#34;</span>)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">gather</span>(Variable, Price, <span style="color:#f92672">-</span>Quantity)

<span style="color:#a6e22e">ggplot</span>(costs_revenues_plot, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> Quantity, y <span style="color:#f92672">=</span> Price, color <span style="color:#f92672">=</span> Variable)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_line</span>(size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_y_continuous</span>(labels <span style="color:#f92672">=</span> scales<span style="color:#f92672">::</span>dollar) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_color_manual</span>(values <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;red&#34;</span>, <span style="color:#e6db74">&#34;blue&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_light</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme</span>(legend.position <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bottom&#34;</span>)
</code></pre></div><p><img src="/blog/2018/02/15/derivatives-r-fun/index_files/figure-html/empirical-cost-revenue-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Because both variables are curvilinear, it&rsquo;s probably best to approximate their functions using splines with <code>splinefun()</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">cost_empirical <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">splinefun</span>(x <span style="color:#f92672">=</span> costs_revenues<span style="color:#f92672">$</span>Quantity, 
                            y <span style="color:#f92672">=</span> costs_revenues<span style="color:#f92672">$</span>`Total Cost`)

revenue_empirical <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">splinefun</span>(x <span style="color:#f92672">=</span> costs_revenues<span style="color:#f92672">$</span>Quantity, 
                               y <span style="color:#f92672">=</span> costs_revenues<span style="color:#f92672">$</span>`Total Revenue`)
</code></pre></div><p>If we compare the empirically-based functions with their real-life counterparts, we can see that the approximation worked great:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">cost</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">10</span>)
<span style="color:#75715e">##  [1]  0.5  1.5  3.0  5.0  7.5 10.5 14.0 18.0 22.5 27.5</span>
<span style="color:#a6e22e">cost_empirical</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">10</span>)
<span style="color:#75715e">##  [1]  0.5  1.5  3.0  5.0  7.5 10.5 14.0 18.0 22.5 27.5</span>

<span style="color:#a6e22e">revenue</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">10</span>)
<span style="color:#75715e">##  [1]  4.5  8.0 10.5 12.0 12.5 12.0 10.5  8.0  4.5  0.0</span>
<span style="color:#a6e22e">revenue_empirical</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">10</span>)
<span style="color:#75715e">##  [1]  4.5  8.0 10.5 12.0 12.5 12.0 10.5  8.0  4.5  0.0</span>
</code></pre></div><p>Determining the marginal cost and revenue functions from these approximations is surprisingly easy because <code>splinefun()</code> objects have a built-in mechanism for returning derivatives with a <code>deriv</code> argument:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">mc</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">10</span>)
<span style="color:#75715e">##  [1] 0.75 1.25 1.75 2.25 2.75 3.25 3.75 4.25 4.75 5.25</span>
<span style="color:#a6e22e">cost_empirical</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">10</span>, deriv <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>)
<span style="color:#75715e">##  [1] 0.75 1.25 1.75 2.25 2.75 3.25 3.75 4.25 4.75 5.25</span>

<span style="color:#a6e22e">mr</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">10</span>)
<span style="color:#75715e">##  [1]  4  3  2  1  0 -1 -2 -3 -4 -5</span>
<span style="color:#a6e22e">revenue_empirical</span>(<span style="color:#ae81ff">1</span><span style="color:#f92672">:</span><span style="color:#ae81ff">10</span>, deriv <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>)
<span style="color:#75715e">##  [1]  4  3  2  1  0 -1 -2 -3 -4 -5</span>
</code></pre></div><p>Magic!</p>
<p>We can plot these empirically-approximated marginal functions and see that they intersect, as expected:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">ggplot</span>(data <span style="color:#f92672">=</span> <span style="color:#a6e22e">tibble</span>(x <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">10</span>), <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> x)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_function</span>(fun <span style="color:#f92672">=</span> cost_empirical, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, args <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>(deriv <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>),
                <span style="color:#a6e22e">aes</span>(color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Marginal cost&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_function</span>(fun <span style="color:#f92672">=</span> revenue_empirical, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, args <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>(deriv <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>),
                <span style="color:#a6e22e">aes</span>(color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Marginal revenue&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Quantity&#34;</span>, y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Price&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_y_continuous</span>(labels <span style="color:#f92672">=</span> scales<span style="color:#f92672">::</span>dollar) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_color_manual</span>(values <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Marginal cost&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;red&#34;</span>, <span style="color:#e6db74">&#34;Marginal revenue&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blue&#34;</span>),
                     name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Empirical function&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">coord_cartesian</span>(ylim <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">6</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_light</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme</span>(legend.position <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bottom&#34;</span>)
</code></pre></div><p><img src="/blog/2018/02/15/derivatives-r-fun/index_files/figure-html/plot-empirical-marginal-functions-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>Finally, we can use <code>uniroot()</code> to find where these two functions intersect:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">optimal_q_empirical <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">uniroot</span>(<span style="color:#a6e22e">function</span>(x) <span style="color:#a6e22e">cost_empirical</span>(x, deriv <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">-</span> 
                                 <span style="color:#a6e22e">revenue_empirical</span>(x, deriv <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>), <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">10</span>))
optimal_q_empirical<span style="color:#f92672">$</span>root
<span style="color:#75715e">## [1] 3.166667</span>
</code></pre></div><p>It&rsquo;s the same!</p>
<p>And just like before, we can find the optimal price, given this quantity. But first we have to create an empirical function for the demand. The demand variable is linear here, so we can use <code>approxfun()</code>, but <code>splinefun()</code> works just fine too (and it has built-in derivative capabilities, while <code>approxfun()</code> doesn&rsquo;t).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">revenue_empirical</span>(optimal_q_empirical<span style="color:#f92672">$</span>root, deriv <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>)
<span style="color:#75715e">## [1] 1.833333</span>

demand_empricial_spline <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">splinefun</span>(x <span style="color:#f92672">=</span> costs_revenues<span style="color:#f92672">$</span>Quantity,
                                     y <span style="color:#f92672">=</span> costs_revenues<span style="color:#f92672">$</span>Price)

demand_empricial_approx <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">approxfun</span>(x <span style="color:#f92672">=</span> costs_revenues<span style="color:#f92672">$</span>Quantity,
                                     y <span style="color:#f92672">=</span> costs_revenues<span style="color:#f92672">$</span>Price)

<span style="color:#a6e22e">demand_empricial_spline</span>(optimal_q_empirical<span style="color:#f92672">$</span>root)
<span style="color:#75715e">## [1] 3.416667</span>
<span style="color:#a6e22e">demand_empricial_approx</span>(optimal_q_empirical<span style="color:#f92672">$</span>root)
<span style="color:#75715e">## [1] 3.416667</span>
<span style="color:#75715e"># oh noes monopolies again</span>
</code></pre></div><p>We can plot all of these things together:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">ggplot</span>(data <span style="color:#f92672">=</span> <span style="color:#a6e22e">tibble</span>(x <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span><span style="color:#f92672">:</span><span style="color:#ae81ff">10</span>), <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> x)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_function</span>(fun <span style="color:#f92672">=</span> demand_empricial_spline, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>,
                <span style="color:#a6e22e">aes</span>(color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Demand&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_function</span>(fun <span style="color:#f92672">=</span> cost_empirical, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, args <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>(deriv <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>),
                <span style="color:#a6e22e">aes</span>(color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Marginal cost&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_function</span>(fun <span style="color:#f92672">=</span> revenue_empirical, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, args <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>(deriv <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>),
                <span style="color:#a6e22e">aes</span>(color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Marginal revenue&#34;</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_vline</span>(xintercept <span style="color:#f92672">=</span> optimal_q_empirical<span style="color:#f92672">$</span>root, 
             color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;grey50&#34;</span>, linetype <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;dashed&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_hline</span>(yintercept <span style="color:#f92672">=</span> <span style="color:#a6e22e">revenue_empirical</span>(optimal_q_empirical<span style="color:#f92672">$</span>root, deriv <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>), 
             color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;grey50&#34;</span>, linetype <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;dashed&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Quantity&#34;</span>, y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Price&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_y_continuous</span>(labels <span style="color:#f92672">=</span> scales<span style="color:#f92672">::</span>dollar) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_color_manual</span>(values <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;Marginal cost&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;red&#34;</span>, <span style="color:#e6db74">&#34;Marginal revenue&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;blue&#34;</span>,
                                <span style="color:#e6db74">&#34;Demand&#34;</span> <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;darkgreen&#34;</span>),
                     name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Function&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">coord_cartesian</span>(ylim <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">6</span>)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_light</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme</span>(legend.position <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bottom&#34;</span>)
</code></pre></div><p><img src="/blog/2018/02/15/derivatives-r-fun/index_files/figure-html/plot-all-empirical-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>In this case, the empirical solution and the function-based solution are identical, but that&rsquo;s only because I created the empirical data from the functions. In real life, though, this same process should work on any empirical price, quantity, and cost data.</p>

    
        <footer>
            <div class="tags">
    <i class="fas fa-tags" aria-hidden="true"></i>&ensp;
    <a href="/blog/tags/r/">r</a>
    <span class="separator">â€¢</span>
    <a href="/blog/tags/ggplot/">ggplot</a>
    <span class="separator">â€¢</span>
    <a href="/blog/tags/dataviz/">dataviz</a>
    <span class="separator">â€¢</span>
    <a href="/blog/tags/economics/">economics</a></div>

        </footer>

        <div id="comments">
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                 
                var disqus_shortname = 'andrewheisscom';
                var disqus_title = document.title;
                var disqus_url = 'https:\/\/www.shagunjhaver.com\/blog\/2018\/02\/15\/derivatives-r-fun\/';

                 
                (function () {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
                    Disqus.</a></noscript>
        </div>
    </article>
</section>

  

<script src="/js/math-code.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js"></script>
<script>
    MathJax = {
        tex: {
            inlineMath: [
                ['$', '$'], ['\\(', '\\)']
            ],
            processEscapes: true,
            processEnvironments: true
        },
        options: {
            skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
        }
    };
</script>

        </div> 
    </div> 
    
    <div id="footer">
        <footer>
    <ul class="links">
        <li>
            <a href="mailto:shagun.jhaver@rutgers.edu" aria-label="E-mail"   >
                <i class="fa fa-envelope" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://medium.com/@shagunjhaver" aria-label="Medium"   >
                <i class="fab fa-medium" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://scholar.google.com/citations?user=OgtKT6UAAAAJ" aria-label="Google Scholar"   >
                <i class="ai ai-google-scholar" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://dl.acm.org/author_page.cfm?id=99658987207" aria-label="ACM Digital Library"   >
                <i class="ai ai-acmdl-square" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://github.com/shaguniitb" aria-label="GitHub"   >
                <i class="fab fa-github" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://twitter.com/shagunjhaver" aria-label="Twitter"   >
                <i class="fab fa-twitter" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://www.facebook.com/shagun.jhaver" aria-label="Facebook"   >
                <i class="fab fa-facebook" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://www.linkedin.com/in/shagun-jhaver/" aria-label="LinkedIn"   >
                <i class="fab fa-linkedin" aria-hidden="true"></i>
            </a>
        </li>
    </ul>

    <p class="colophon"> <i class="fas fa-map-marker-alt"></i> New Brunswick, NJ </p>
    <p class="colophon">ORCID iD: <a href="https://orcid.org/0000-0002-6728-7101">0000-0002-6728-7101</a></p>

   <p class="colophon">
    This site is a derivative of <a href="https://github.com/andrewheiss/ath-hugo">ath-hugo</a> by Andrew Heiss, used under CC <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">4.0</a>.
   </p>


    <p class="colophon"><a href="https://github.com/shaguniitb/ath-hugo">Code for site</a></p>
</footer>

    </div>

</body>

</html>

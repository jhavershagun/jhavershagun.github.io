<!DOCTYPE html>
<html lang="en"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">

    <meta name="author" content="Shagun Jhaver">
    <meta name="description" content="Use tidyverse functions to correctly meld and pool multiply imputed model output.">
    <meta name="keywords" content="r, imputation, tidyverse">
    <meta name="generator" content="Hugo 0.88.1" />

    <title>
  Meld regression output from multiple imputations with tidyverse | Shagun Jhaver
</title>

    <link rel="canonical" href="https://www.shagunjhaver.com/blog/2018/03/07/amelia-tidy-melding/">
    <link rel="alternate" type="application/atom+xml" title="Blog Posts" href="https://www.shagunjhaver.com/atom.xml">
    <link rel="alternate" type="application/json" title="JSON Feed" href="https://www.shagunjhaver.com/feed.json">

    <link rel="openid2.provider" href="https://www.google.com/accounts/o8/ud?source=profiles">
    <link rel="openid2.local_id" href="https://www.google.com/profiles/andrewheiss">

    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://www.shagunjhaver.com/profiles/twitter-card-large.png?v=1"/>
    <meta name="twitter:site" content="@shagunjhaver"/>
    <meta name="twitter:title" content="Meld regression output from multiple imputations with tidyverse"/>
    <meta name="twitter:creator" content="@shagunjhaver"/>
    <meta name="twitter:description" content="Use tidyverse functions to correctly meld and pool multiply imputed model output."/>


    <meta property="og:title" content="Meld regression output from multiple imputations with tidyverse" />
<meta property="og:description" content="Use tidyverse functions to correctly meld and pool multiply imputed model output." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.shagunjhaver.com/blog/2018/03/07/amelia-tidy-melding/" />
<meta property="og:image" content="https://www.shagunjhaver.com/profiles/twitter-card-large.png"/>
<meta property="article:published_time" content="2018-03-07T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-03-07T00:00:00+00:00" />

<meta property="article:author" content="https://www.facebook.com/shagun.jhaver" />
<meta property="article:publisher" content="https://www.facebook.com/shagun.jhaver" />
<meta property="article:section" content="blog" />
<meta property="article:tag" content="r" />
<meta property="article:tag" content="imputation" />
<meta property="article:tag" content="tidyverse" />


    <meta itemprop="name" content="Meld regression output from multiple imputations with tidyverse">
<meta itemprop="description" content="Use tidyverse functions to correctly meld and pool multiply imputed model output."><meta itemprop="datePublished" content="2018-03-07T00:00:00+00:00" />
<meta itemprop="dateModified" content="2018-03-07T00:00:00+00:00" />
<meta itemprop="wordCount" content="1885"><meta itemprop="image" content="https://www.shagunjhaver.com/profiles/twitter-card-large.png"/>
<meta itemprop="keywords" content="r,imputation,tidyverse," />

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/pure-and-grids-responsive.min.css">
    <link rel="stylesheet" href="/css/ath-hugo.min.c5619237d890aa972042ca0497d2594d6f3f34b1746c377f560f5096573fb6e3.css" integrity="sha256-xWGSN9iQqpcgQsoEl9JZTW8/NLF0bDd/Vg9Qllc/tuM=" crossorigin="anonymous" media="screen" />

    <script src="https://kit.fontawesome.com/f9d343c40d.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">    

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=dLX2MbQJLG">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=dLX2MbQJLG">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=dLX2MbQJLG">
    <link rel="manifest" href="/site.webmanifest?v=dLX2MbQJLG">
    <link rel="mask-icon" href="/safari-pinned-tab.svg?v=dLX2MbQJLG" color="#cf4446">
    <link rel="shortcut icon" href="/favicon.ico?v=dLX2MbQJLG">
    <meta name="msapplication-TileColor" content="#170c3a">
    <meta name="theme-color" content="#170c3a">

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-527449-5', 'auto');
      ga('send', 'pageview');
    </script>
</head>

<body>

    <div id="layout" class="pure-g">
        <div id="sidebar" class="pure-u-1 pure-u-md-1-4">
            <header>
                <h1 class="title"><a href="/">Shagun Jhaver</a></h1>
                <h2 class="minibio">Social computing, CSCW, HCI, content moderation, and online harassment</h2>

                <nav id="main-nav">
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a class="nav-link" href="/">About</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/cv/">CV</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/blog/">Blog</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/research/">Research</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/teaching/">Teaching</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/talks/">Talks</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/now/">Now</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/uses/">Uses</a>
                        </li>
                    </ul>
                </nav>
            </header>

        </div> 
    
        <div id="content" class="pure-u-1 pure-u-md-3-4">
        
  <section>
    <article class="content-single">
        <header class="post-header">
            <h1 class="post-title">Meld regression output from multiple imputations with tidyverse</h1>

            <div class="post-meta pure-g">
                <div class="pure-u-1-2">
                    <span class="posted-on">
                        <i class="far fa-calendar-alt" aria-hidden="true"></i>
                        <time datetime='2018-03-07T00:00:00Z'>
                            Wednesday, March 7, 2018
                        </time>
                    </span>
                </div>
                <div class="reading-time pure-u-1-2">
                    <i class="far fa-clock" aria-hidden="true"></i>
                    9-minute read
                </div>
            </div>
        </header>
    
        <p><span class="small">(<a href="https://github.com/andrewheiss/amelia-tidy-melding">See this notebook on GitHub</a>)</span></p>
<hr>
<p>Missing data can significantly influence the results of normal regression models, since the default in R and most other statistical packages is to throw away any rows with missing variables. To avoid unnecessarily throwing out data, it&rsquo;s helpful to impute missing values. One of the best ways to do this is to build a separate regression model to make predictions that fill in the gaps in data. This isn&rsquo;t always accurate, so it&rsquo;s best to make many iterations of predictions (in imputation parlance, <code>\(m\)</code> is the number of imputations done to a dataset). After making <code>\(m\)</code> datasets, you can use this data by (1) running statistical tests on each imputation individually and then (2) pooling those results into a single number. The <a href="https://cran.r-project.org/web/packages/Amelia/vignettes/amelia.pdf">excellent Amelia vignette</a> details the theory and mechanics of how to use multiple imputation, and it&rsquo;s a fantastic resource.</p>
<p>There are several packages for dealing with missing data in R, including <a href="https://cran.r-project.org/package=mi"><code>mi</code></a>, <a href="https://cran.r-project.org/package=mice"><code>mice</code></a>, and <a href="https://cran.r-project.org/package=Amelia"><code>Amelia</code></a>, and Thomas Leeper has <a href="http://thomasleeper.com/Rcourse/Tutorials/mi.html">a short overview of how to use all three</a>. I&rsquo;m partial to <a href="https://gking.harvard.edu/amelia">Amelia</a>, since it&rsquo;s designed to work well with time series-cross sectional data and can deal with complicated features like country-year observations.</p>
<p>Because Amelia is written by Gary King, et al., it works with <a href="https://zeligproject.org/">Zelig</a>, a separate framework that&rsquo;s designed to simplify modeling in R. With Zelig + Amelia, you can combine all of the <code>\(m\)</code> imputations automatically with whatever Zelig uses for printing model results. I&rsquo;m not a huge fan of Zelig, though, and I prefer using <code>lm()</code>, <code>glm()</code>, <code>stan_glm()</code>, and gang on my own, thank you very much.</p>
<p>However, doing it on my own means there&rsquo;s a little more work involved with combining coefficients and parameters across imputations. Fortunately, the <a href="https://www.tidyverse.org/">tidyverse</a>—specifically its ability to store models within data frames—makes it really easy to deal with models based on imputed data. Here&rsquo;s how to do it using tidy functions. The code for this whole process can be greatly simplified in real life. You technically don&rsquo;t need all these intermediate steps, though they&rsquo;re helpful for seeing what&rsquo;s going on behind the scenes.</p>
<p>We&rsquo;ll start by working with some basic example imputed data frame from Amelia&rsquo;s built-in data. We create 5 imputed datasets defining countries and years as cross sections and time series, and we log GDP per capita in the predictive model:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(tidyverse)
<span style="color:#a6e22e">library</span>(Amelia)
<span style="color:#a6e22e">library</span>(broom)

<span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">1234</span>)
<span style="color:#a6e22e">data</span>(africa)
imp_amelia <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">amelia</span>(x <span style="color:#f92672">=</span> africa, m <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>, cs <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;country&#34;</span>, ts <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;year&#34;</span>, 
                     logs <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gdp_pc&#34;</span>, p2s <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>)
</code></pre></div><p>The resulting object contains a list of data frames, and each imputed dataset is stored in a list slot named &ldquo;imputations&rdquo; or <code>imp_amelia$imputations</code>. We can combine these all into one big data frame with <code>bind_rows()</code>, group by the imputation number ($m$), and nest them into imputation-specific rows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># unclass() is necessary because bind_rows() will complain when dealing with</span>
<span style="color:#75715e"># lists with the &#34;amelia&#34; class, which is what amelia() returns</span>
all_imputations <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">bind_rows</span>(<span style="color:#a6e22e">unclass</span>(imp_amelia<span style="color:#f92672">$</span>imputations), .id <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;m&#34;</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">group_by</span>(m) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">nest</span>()

all_imputations
<span style="color:#75715e">## # A tibble: 5 x 2</span>
<span style="color:#75715e">## # Groups:   m [5]</span>
<span style="color:#75715e">##   m     data              </span>
<span style="color:#75715e">##   &lt;chr&gt; &lt;list&gt;            </span>
<span style="color:#75715e">## 1 imp1  &lt;tibble [120 × 7]&gt;</span>
<span style="color:#75715e">## 2 imp2  &lt;tibble [120 × 7]&gt;</span>
<span style="color:#75715e">## 3 imp3  &lt;tibble [120 × 7]&gt;</span>
<span style="color:#75715e">## 4 imp4  &lt;tibble [120 × 7]&gt;</span>
<span style="color:#75715e">## 5 imp5  &lt;tibble [120 × 7]&gt;</span>
</code></pre></div><p>With this nested data, we can use <code>purrr::map()</code> to run models and return tidy summaries of those models directly in the data frame:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">models_imputations <span style="color:#f92672">&lt;-</span> all_imputations <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">mutate</span>(model <span style="color:#f92672">=</span> data <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">map</span>(<span style="color:#f92672">~</span> <span style="color:#a6e22e">lm</span>(gdp_pc <span style="color:#f92672">~</span> trade <span style="color:#f92672">+</span> civlib, data <span style="color:#f92672">=</span> .)),
         tidied <span style="color:#f92672">=</span> model <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">map</span>(<span style="color:#f92672">~</span> <span style="color:#a6e22e">tidy</span>(., conf.int <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)),
         glance <span style="color:#f92672">=</span> model <span style="color:#f92672">%&gt;%</span> <span style="color:#a6e22e">map</span>(<span style="color:#f92672">~</span> <span style="color:#a6e22e">glance</span>(.)))

models_imputations
<span style="color:#75715e">## # A tibble: 5 x 5</span>
<span style="color:#75715e">## # Groups:   m [5]</span>
<span style="color:#75715e">##   m     data               model  tidied           glance           </span>
<span style="color:#75715e">##   &lt;chr&gt; &lt;list&gt;             &lt;list&gt; &lt;list&gt;           &lt;list&gt;           </span>
<span style="color:#75715e">## 1 imp1  &lt;tibble [120 × 7]&gt; &lt;lm&gt;   &lt;tibble [3 × 7]&gt; &lt;tibble [1 × 12]&gt;</span>
<span style="color:#75715e">## 2 imp2  &lt;tibble [120 × 7]&gt; &lt;lm&gt;   &lt;tibble [3 × 7]&gt; &lt;tibble [1 × 12]&gt;</span>
<span style="color:#75715e">## 3 imp3  &lt;tibble [120 × 7]&gt; &lt;lm&gt;   &lt;tibble [3 × 7]&gt; &lt;tibble [1 × 12]&gt;</span>
<span style="color:#75715e">## 4 imp4  &lt;tibble [120 × 7]&gt; &lt;lm&gt;   &lt;tibble [3 × 7]&gt; &lt;tibble [1 × 12]&gt;</span>
<span style="color:#75715e">## 5 imp5  &lt;tibble [120 × 7]&gt; &lt;lm&gt;   &lt;tibble [3 × 7]&gt; &lt;tibble [1 × 12]&gt;</span>
</code></pre></div><p>Having the models structured like this makes it easy to access coefficients for models from individual imputations, like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">models_imputations <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">filter</span>(m <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;imp1&#34;</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">unnest</span>(tidied)
<span style="color:#75715e">## # A tibble: 3 x 11</span>
<span style="color:#75715e">## # Groups:   m [1]</span>
<span style="color:#75715e">##   m     data   model term  estimate std.error statistic  p.value conf.low conf.high glance</span>
<span style="color:#75715e">##   &lt;chr&gt; &lt;list&gt; &lt;lis&gt; &lt;chr&gt;    &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt; &lt;list&gt;</span>
<span style="color:#75715e">## 1 imp1  &lt;tibb… &lt;lm&gt;  (Int…    114.      97.7       1.17 2.44e- 1    -79.0     308.  &lt;tibb…</span>
<span style="color:#75715e">## 2 imp1  &lt;tibb… &lt;lm&gt;  trade     18.1      1.25     14.4  9.65e-28     15.6      20.6 &lt;tibb…</span>
<span style="color:#75715e">## 3 imp1  &lt;tibb… &lt;lm&gt;  civl…   -631.     182.       -3.46 7.47e- 4   -993.     -270.  &lt;tibb…</span>
</code></pre></div><p>More importantly, we can access the coefficients for all the models, which is essential for combining and averaging the coefficients across all five imputations.</p>
<p>Pooling or melding coefficients from many models is a little trickier than just averaging them all together (as delightfully easy as that would be). <a href="https://doi.org/10.1002/9780470316696">Donald Rubin (1987)</a> outlines an algorithm/set of rules for combining the results from multiply imputed datasets that reflects the averages and accounts for differences in standard errors. Rubin&rsquo;s rules are essentially a fancier, more robust way of averaging coefficients and other quantities of interest across imputations.</p>
<p>Amelia has a built-in function for using Rubin&rsquo;s rules named <code>mi.meld()</code> that accepts two m-by-k matrices (one for coefficients and one for standard errors) like so:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">      coef1  coef2  coefn
imp1  x      x      x
imp2  x      x      x
impn  x      x      x
</code></pre></div><p>We can use some dplyr/tidyr magic to wrangle the regression results into this form:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Create a wide data frame of just the coefficients and standard errors</span>
params <span style="color:#f92672">&lt;-</span> models_imputations <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">unnest</span>(tidied) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">select</span>(m, term, estimate, std.error) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">gather</span>(key, value, estimate, std.error) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">spread</span>(term, value) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">ungroup</span>()
params
<span style="color:#75715e">## # A tibble: 10 x 5</span>
<span style="color:#75715e">##    m     key       `(Intercept)` civlib trade</span>
<span style="color:#75715e">##    &lt;chr&gt; &lt;chr&gt;             &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;</span>
<span style="color:#75715e">##  1 imp1  estimate          114.   -631. 18.1 </span>
<span style="color:#75715e">##  2 imp1  std.error          97.7   182.  1.25</span>
<span style="color:#75715e">##  3 imp2  estimate          123.   -626. 18.0 </span>
<span style="color:#75715e">##  4 imp2  std.error          96.8   181.  1.24</span>
<span style="color:#75715e">##  5 imp3  estimate          114.   -633. 18.2 </span>
<span style="color:#75715e">##  6 imp3  std.error          96.5   181.  1.24</span>
<span style="color:#75715e">##  7 imp4  estimate          119.   -651. 18.2 </span>
<span style="color:#75715e">##  8 imp4  std.error          95.4   180.  1.22</span>
<span style="color:#75715e">##  9 imp5  estimate          132.   -648. 18.0 </span>
<span style="color:#75715e">## 10 imp5  std.error          95.2   180.  1.22</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Extract just the coefficients</span>
just_coefs <span style="color:#f92672">&lt;-</span> params <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">filter</span>(key <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;estimate&#34;</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">select</span>(<span style="color:#f92672">-</span>m, <span style="color:#f92672">-</span>key)
just_coefs
<span style="color:#75715e">## # A tibble: 5 x 3</span>
<span style="color:#75715e">##   `(Intercept)` civlib trade</span>
<span style="color:#75715e">##           &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;</span>
<span style="color:#75715e">## 1          114.  -631.  18.1</span>
<span style="color:#75715e">## 2          123.  -626.  18.0</span>
<span style="color:#75715e">## 3          114.  -633.  18.2</span>
<span style="color:#75715e">## 4          119.  -651.  18.2</span>
<span style="color:#75715e">## 5          132.  -648.  18.0</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Extract just the standard errors</span>
just_ses <span style="color:#f92672">&lt;-</span> params <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">filter</span>(key <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;std.error&#34;</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">select</span>(<span style="color:#f92672">-</span>m, <span style="color:#f92672">-</span>key)
just_ses
<span style="color:#75715e">## # A tibble: 5 x 3</span>
<span style="color:#75715e">##   `(Intercept)` civlib trade</span>
<span style="color:#75715e">##           &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;</span>
<span style="color:#75715e">## 1          97.7   182.  1.25</span>
<span style="color:#75715e">## 2          96.8   181.  1.24</span>
<span style="color:#75715e">## 3          96.5   181.  1.24</span>
<span style="color:#75715e">## 4          95.4   180.  1.22</span>
<span style="color:#75715e">## 5          95.2   180.  1.22</span>
</code></pre></div><p>We can then use these matrices in <code>mi.meld()</code>, which returns a list with two slots—<code>q.mi</code> and <code>se.mi</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">coefs_melded <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">mi.meld</span>(just_coefs, just_ses)
coefs_melded
<span style="color:#75715e">## $q.mi</span>
<span style="color:#75715e">##      (Intercept) civlib trade</span>
<span style="color:#75715e">## [1,]         121   -638  18.1</span>
<span style="color:#75715e">## </span>
<span style="color:#75715e">## $se.mi</span>
<span style="color:#75715e">##      (Intercept) civlib trade</span>
<span style="color:#75715e">## [1,]        96.7    181  1.24</span>
</code></pre></div><p>Armed with these, we can create our regression summary table with some more dplyr wizardry. To calculate the p-value and confidence intervals, we need to extract the degrees of freedom from one of the imputed models</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">model_degree_freedom <span style="color:#f92672">&lt;-</span> models_imputations <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">unnest</span>(glance) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">filter</span>(m <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;imp1&#34;</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">pull</span>(df.residual)

melded_summary <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">as.data.frame</span>(<span style="color:#a6e22e">cbind</span>(<span style="color:#a6e22e">t</span>(coefs_melded<span style="color:#f92672">$</span>q.mi),
                                      <span style="color:#a6e22e">t</span>(coefs_melded<span style="color:#f92672">$</span>se.mi))) <span style="color:#f92672">%&gt;%</span>
  magrittr<span style="color:#f92672">::</span><span style="color:#a6e22e">set_colnames</span>(<span style="color:#a6e22e">c</span>(<span style="color:#e6db74">&#34;estimate&#34;</span>, <span style="color:#e6db74">&#34;std.error&#34;</span>)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">mutate</span>(term <span style="color:#f92672">=</span> <span style="color:#a6e22e">rownames</span>(.)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">select</span>(term, <span style="color:#a6e22e">everything</span>()) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">mutate</span>(statistic <span style="color:#f92672">=</span> estimate <span style="color:#f92672">/</span> std.error,
         conf.low <span style="color:#f92672">=</span> estimate <span style="color:#f92672">+</span> std.error <span style="color:#f92672">*</span> <span style="color:#a6e22e">qt</span>(<span style="color:#ae81ff">0.025</span>, model_degree_freedom),
         conf.high <span style="color:#f92672">=</span> estimate <span style="color:#f92672">+</span> std.error <span style="color:#f92672">*</span> <span style="color:#a6e22e">qt</span>(<span style="color:#ae81ff">0.975</span>, model_degree_freedom),
         p.value <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">pt</span>(<span style="color:#a6e22e">abs</span>(statistic), model_degree_freedom, lower.tail <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>))

melded_summary
<span style="color:#75715e">##          term estimate std.error statistic conf.low conf.high  p.value</span>
<span style="color:#75715e">## 1 (Intercept)    120.6     96.67      1.25    -70.9     312.0 2.15e-01</span>
<span style="color:#75715e">## 2      civlib   -637.8    181.13     -3.52   -996.6    -279.1 6.13e-04</span>
<span style="color:#75715e">## 3       trade     18.1      1.24     14.63     15.6      20.5 3.45e-28</span>
</code></pre></div><p>Hooray! Correctly melded coefficients and standard errors!</p>
<p>But what do we do about the other model details, like <code>\(R^2\)</code> and the F-statistic? How do we report those?</p>
<p>According to <a href="https://lists.gking.harvard.edu/pipermail/amelia/2016-July/001249.html">a post on the Amelia mailing list</a>, there are two ways. First, we can use a fancy method for combining <code>\(R^2\)</code> and adjusted <code>\(R^2\)</code> described by <a href="https://doi.org/10.1080/02664760802553000">Ofer Harel (2009)</a>. Second, we can just take the average of the <code>\(R^2\)</code>s from all the imputed models. The results should be roughly the same.</p>
<p>Harel&rsquo;s method involves two steps:</p>
<ol>
<li>In each complete data set, calculate the <code>\(R^2\)</code>, take its square root ($R$), transform <code>\(R\)</code> with a Fisher z-transformation ($Q = \frac{1}{2} \log_{e}(\frac{1 + R}{1 - R})$), and calculate the variance of <code>\(R^2\)</code> (which is <code>\(\frac{1}{\text{degrees of freedom}}\)</code>)</li>
<li>Meld the resulting <code>\(Q\)</code> and variance using Rubin&rsquo;s rules (<code>mi.meld()</code>; this creates <code>\(Q_a\)</code>), undo the z-transformation ($R_a = (\frac{-1 + \exp(2Q_a)}{1 + \exp(2Q_a)})^2$), and square it ($R_a^2$)</li>
</ol>
<p>That looks complicated, but it&rsquo;s fairly easy with some dplyr magic. Here&rsquo;s how to do it for adjusted <code>\(R^2\)</code> (the same process works for regular <code>\(R^2\)</code> too):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Step 1: in each complete data set, calculate R2, take its square root,</span>
<span style="color:#75715e"># transform it with Fisher z-transformation, and calculate the variance of R2\</span>
r2s <span style="color:#f92672">&lt;-</span> models_imputations <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">unnest</span>(glance) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">select</span>(m, adj.r.squared, df.residual) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">mutate</span>(R <span style="color:#f92672">=</span> <span style="color:#a6e22e">sqrt</span>(adj.r.squared),  <span style="color:#75715e"># Regular R</span>
         Q <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.5</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">log</span>((R <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">/</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> R)),  <span style="color:#75715e"># Fisher z-transformation</span>
         se <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">/</span> df.residual)  <span style="color:#75715e"># R2 variance</span>
r2s
<span style="color:#75715e">## # A tibble: 5 x 6</span>
<span style="color:#75715e">## # Groups:   m [5]</span>
<span style="color:#75715e">##   m     adj.r.squared df.residual     R     Q      se</span>
<span style="color:#75715e">##   &lt;chr&gt;         &lt;dbl&gt;       &lt;int&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 imp1          0.643         117 0.802  1.10 0.00855</span>
<span style="color:#75715e">## 2 imp2          0.648         117 0.805  1.11 0.00855</span>
<span style="color:#75715e">## 3 imp3          0.652         117 0.807  1.12 0.00855</span>
<span style="color:#75715e">## 4 imp4          0.660         117 0.812  1.13 0.00855</span>
<span style="color:#75715e">## 5 imp5          0.654         117 0.808  1.12 0.00855</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Step 2: combine the results using Rubin&#39;s rules (mi.meld()), inverse transform</span>
<span style="color:#75715e"># the value, and square it</span>

<span style="color:#75715e"># Meld the R2 values with mi.meld()</span>
Q_melded <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">mi.meld</span>(<span style="color:#a6e22e">as.matrix</span>(r2s<span style="color:#f92672">$</span>Q), <span style="color:#a6e22e">as.matrix</span>(r2s<span style="color:#f92672">$</span>se))

<span style="color:#75715e"># Inverse transform Q to R and square it</span>
r2_melded <span style="color:#f92672">&lt;-</span> ((<span style="color:#a6e22e">exp</span>(<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> Q_melded<span style="color:#f92672">$</span>q.mi) <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">/</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">+</span> <span style="color:#a6e22e">exp</span>(<span style="color:#ae81ff">2</span> <span style="color:#f92672">*</span> Q_melded<span style="color:#f92672">$</span>q.mi)))^2
r2_melded
<span style="color:#75715e">##       [,1]</span>
<span style="color:#75715e">## [1,] 0.651</span>
</code></pre></div><p>The correctly pooled/melded <code>\(R^2\)</code> is thus 0.651. Neat.</p>
<p>How does this compare to just the average of all the <code>\(R^2\)</code>s from all the imputations?</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">r2s_avg <span style="color:#f92672">&lt;-</span> models_imputations <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">ungroup</span>() <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">unnest</span>(glance) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">summarize</span>(adj.r.squared_avg <span style="color:#f92672">=</span> <span style="color:#a6e22e">mean</span>(adj.r.squared)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">pull</span>(adj.r.squared_avg)
r2s_avg
<span style="color:#75715e">## [1] 0.651</span>
</code></pre></div><p>The incorrectly averaged <code>\(R^2\)</code> is 0.651, which is basically identical to the correctly melded 0.651. This is probably because the models from the five imputed models are already fairly similar—there might be more variance in <code>\(R^2\)</code> in data that&rsquo;s less neat. But for this situation, the two approaches are essentially the same. Other model diagnostics like the F-statistic can probably be pooled just with averages as well. I haven&rsquo;t found any specific algorithms for melding them with fancy math.</p>
<p>So, in summary, combine the coefficients and standard errors from multiply imputed models with <code>mi.meld()</code> and combine other model parameters like <code>\(R^2\)</code> either with Harel&rsquo;s fancy method or by simply averaging them.</p>

    
        <footer>
            <div class="tags">
    <i class="fas fa-tags" aria-hidden="true"></i>&ensp;
    <a href="/blog/tags/r/">r</a>
    <span class="separator">•</span>
    <a href="/blog/tags/imputation/">imputation</a>
    <span class="separator">•</span>
    <a href="/blog/tags/tidyverse/">tidyverse</a></div>

        </footer>

        <div id="comments">
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                 
                var disqus_shortname = 'andrewheisscom';
                var disqus_title = document.title;
                var disqus_url = 'https:\/\/www.shagunjhaver.com\/blog\/2018\/03\/07\/amelia-tidy-melding\/';

                 
                (function () {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
                    Disqus.</a></noscript>
        </div>
    </article>
</section>

  

<script src="/js/math-code.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js"></script>
<script>
    MathJax = {
        tex: {
            inlineMath: [
                ['$', '$'], ['\\(', '\\)']
            ],
            processEscapes: true,
            processEnvironments: true
        },
        options: {
            skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
        }
    };
</script>

        </div> 
    </div> 
    
    <div id="footer">
        <footer>
    <ul class="links">
        <li>
            <a href="mailto:shagun.jhaver@rutgers.edu" aria-label="E-mail"   >
                <i class="fa fa-envelope" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://medium.com/@shagunjhaver" aria-label="Medium"   >
                <i class="fab fa-medium" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://scholar.google.com/citations?user=OgtKT6UAAAAJ" aria-label="Google Scholar"   >
                <i class="ai ai-google-scholar" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://dl.acm.org/author_page.cfm?id=99658987207" aria-label="ACM Digital Library"   >
                <i class="ai ai-acmdl-square" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://github.com/shaguniitb" aria-label="GitHub"   >
                <i class="fab fa-github" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://twitter.com/shagunjhaver" aria-label="Twitter"   >
                <i class="fab fa-twitter" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://www.facebook.com/shagun.jhaver" aria-label="Facebook"   >
                <i class="fab fa-facebook" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://www.linkedin.com/in/shagun-jhaver/" aria-label="LinkedIn"   >
                <i class="fab fa-linkedin" aria-hidden="true"></i>
            </a>
        </li>
    </ul>

    <p class="colophon"> <i class="fas fa-map-marker-alt"></i> New Brunswick, NJ </p>
    <p class="colophon">ORCID iD: <a href="https://orcid.org/0000-0002-6728-7101">0000-0002-6728-7101</a></p>

   <p class="colophon">
    This site is a derivative of <a href="https://github.com/andrewheiss/ath-hugo">ath-hugo</a> by Andrew Heiss, used under CC <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">4.0</a>.
   </p>


    <p class="colophon"><a href="https://github.com/shaguniitb/ath-hugo">Code for site</a></p>
</footer>

    </div>

</body>

</html>

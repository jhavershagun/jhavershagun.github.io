<!DOCTYPE html>
<html lang="en"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">

    <meta name="author" content="Shagun Jhaver">
    <meta name="description" content="Use regression, inverse probability weighting, and matching to close confounding backdoors and find causation in observational data">
    <meta name="keywords" content="r, ggplot, tidyverse, DAGs, causal inference, do calculus">
    <meta name="generator" content="Hugo 0.88.1" />

    <title>
  Ways to close backdoors in DAGs | Shagun Jhaver
</title>

    <link rel="canonical" href="https://www.shagunjhaver.com/blog/2020/02/25/closing-backdoors-dags/">
    <link rel="alternate" type="application/atom+xml" title="Blog Posts" href="https://www.shagunjhaver.com/atom.xml">
    <link rel="alternate" type="application/json" title="JSON Feed" href="https://www.shagunjhaver.com/feed.json">

    <link rel="openid2.provider" href="https://www.google.com/accounts/o8/ud?source=profiles">
    <link rel="openid2.local_id" href="https://www.google.com/profiles/andrewheiss">

    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://www.shagunjhaver.com/blog/2020/02/25/closing-backdoors-dags/load-libraries-make-dag-1.png"/>
    <meta name="twitter:site" content="@shagunjhaver"/>
    <meta name="twitter:title" content="Ways to close backdoors in DAGs"/>
    <meta name="twitter:creator" content="@shagunjhaver"/>
    <meta name="twitter:description" content="Use regression, inverse probability weighting, and matching to close confounding backdoors and find causation in observational data"/>


    <meta property="og:title" content="Ways to close backdoors in DAGs" />
<meta property="og:description" content="Use regression, inverse probability weighting, and matching to close confounding backdoors and find causation in observational data" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.shagunjhaver.com/blog/2020/02/25/closing-backdoors-dags/" />
<meta property="og:image" content="https://www.shagunjhaver.com/blog/2020/02/25/closing-backdoors-dags/load-libraries-make-dag-1.png" />
<meta property="article:published_time" content="2020-02-25T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-02-25T00:00:00+00:00" />

<meta property="article:author" content="https://www.facebook.com/shagun.jhaver" />
<meta property="article:publisher" content="https://www.facebook.com/shagun.jhaver" />
<meta property="article:section" content="blog" />
<meta property="article:tag" content="r" />
<meta property="article:tag" content="ggplot" />
<meta property="article:tag" content="tidyverse" />
<meta property="article:tag" content="DAGs" />
<meta property="article:tag" content="causal inference" />
<meta property="article:tag" content="do calculus" />


    <meta itemprop="name" content="Ways to close backdoors in DAGs">
<meta itemprop="description" content="Use regression, inverse probability weighting, and matching to close confounding backdoors and find causation in observational data"><meta itemprop="datePublished" content="2020-02-25T00:00:00+00:00" />
<meta itemprop="dateModified" content="2020-02-25T00:00:00+00:00" />
<meta itemprop="wordCount" content="5580"><meta itemprop="image" content="https://www.shagunjhaver.com/blog/2020/02/25/closing-backdoors-dags/load-libraries-make-dag-1.png">
<meta itemprop="keywords" content="r,ggplot,tidyverse,DAGs,causal inference,do calculus," />

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/pure-and-grids-responsive.min.css">
    <link rel="stylesheet" href="/css/ath-hugo.min.fd8cb76e3e71e1679716940ae61a1383ae9edd503b072df4bc3f709182421c76.css" integrity="sha256-/Yy3bj5x4WeXFpQK5hoTg66e3VA7By30vD9wkYJCHHY=" crossorigin="anonymous" media="screen" />

    <script src="https://kit.fontawesome.com/f9d343c40d.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">    

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=dLX2MbQJLG">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=dLX2MbQJLG">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=dLX2MbQJLG">
    <link rel="manifest" href="/site.webmanifest?v=dLX2MbQJLG">
    <link rel="mask-icon" href="/safari-pinned-tab.svg?v=dLX2MbQJLG" color="#cf4446">
    <link rel="shortcut icon" href="/favicon.ico?v=dLX2MbQJLG">
    <meta name="msapplication-TileColor" content="#170c3a">
    <meta name="theme-color" content="#170c3a">

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-527449-5', 'auto');
      ga('send', 'pageview');
    </script>
</head>

<body>

    <div id="layout" class="pure-g">
        <div id="sidebar" class="pure-u-1 pure-u-md-1-4">
            <header>
                <h1 class="title"><a href="/">Shagun Jhaver</a></h1>
                <h2 class="minibio">Social computing, CSCW, HCI, content moderation, and online harassment</h2>

                <nav id="main-nav">
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a class="nav-link" href="/">About</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/cv/">CV</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/blog/">Blog</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/research/">Research</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/teaching/">Teaching</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/talks/">Talks</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/now/">Now</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/uses/">Uses</a>
                        </li>
                    </ul>
                </nav>
            </header>

        </div> 
    
        <div id="content" class="pure-u-1 pure-u-md-3-4">
        
  <section>
    <article class="content-single">
        <header class="post-header">
            <h1 class="post-title">Ways to close backdoors in DAGs</h1>

            <div class="post-meta pure-g">
                <div class="pure-u-1-2">
                    <span class="posted-on">
                        <i class="far fa-calendar-alt" aria-hidden="true"></i>
                        <time datetime='2020-02-25T00:00:00Z'>
                            Tuesday, February 25, 2020
                        </time>
                    </span>
                </div>
                <div class="reading-time pure-u-1-2">
                    <i class="far fa-clock" aria-hidden="true"></i>
                    27-minute read
                </div>
            </div>
        </header>
    
        <p><span class="small">(<a href="https://github.com/andrewheiss/closing-backdoors-dags">See this notebook on GitHub</a>)</span></p>
<hr>
<p>I’ve been teaching <a href="https://evalsp20.classes.andrewheiss.com/">program evaluation</a> in the MPA/MPP program at GSU for the past semester and a half, and since I was given free rein over how to teach it, I decided to make it as modern and cutting edge as possible. To do this, I’ve infused the class with modern causal inference techniques (commonly known as the <a href="https://bigthink.com/errors-we-live-by/judea-pearls-the-book-of-why-brings-news-of-a-new-science-of-causes">“causal revolution”</a>), focused on the language of <a href="https://cran.r-project.org/web/packages/ggdag/vignettes/intro-to-dags.html">directed acyclic graphs (DAGs)</a>, <a href="https://www.inference.vc/untitled/">do-calculus</a>, confounding, colliding, and the rest of Judea Pearl’s world of finding causation in observational data.</p>
<p>However, I was never taught this approach in any of my doctoral classes, and I’m entirely self-taught. I read <a href="https://www.amazon.com/Book-Why-Science-Cause-Effect/dp/046509760X/"><em>The Book of Why</em></a> in March 2019, and I’ve thrown myself into every possible journal article, blog post, and online course I’ve come across in order to understand how to isolate and identify causal effects. It’s been hard, but thanks to an incredibly welcoming community of economists, epidemiologists, and political scientists on Twitter, I’m getting it! (And so are my students!)</p>
<p>The purpose of this post isn’t to introduce causal models and DAGs and confounders vs. colliders and all that. For that kind of introduction, consult any (or all!) of these resources:</p>
<ul>
<li>Nick Huntington-Klein&rsquo;s <a href="http://www.nickchk.com/econ305.html">ECON 305: Economics, Causality, and Analytics course</a> (especially lectures 13–18)</li>
<li>Julia M. Rohrer, “Thinking Clearly About Correlations and Causation: Graphical Causal Models for Observational Data,” Advances in Methods and Practices in <em>Psychological Science</em> 1, no. 1 (March 2018): 27–42, doi: <a href="https://doi.org/10.1177/2515245917745629">10.1177/2515245917745629</a></li>
<li>Miguel A. Hernán and James M. Robbins, <em>Causal Inference: What If</em> (CRC Press, 2020), <a href="https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/">https://www.hsph.harvard.edu/miguel-hernan/causal-inference-book/</a></li>
<li>Paul Hünermund and Elias Bareinboim, “Causal Inference and Data-Fusion in Econometrics,” December 19, 2019, arXiv: 1912.09104 [econ.EM], <a href="https://arxiv.org/abs/1912.09104">https://arxiv.org/abs/1912.09104</a></li>
<li>Felix Elwert, “Graphical Causal Models,” chap. 13 in <em>Handbook of Causal Analysis for Social Research</em>, ed. Stephen L. Morgan (New York: Springer, 2013), 245–273, doi: <a href="https://doi.org/10.1007/978-94-007-6094-3_13">10.1007/978-94-007-6094-3_13</a></li>
<li>Julian Schuessler and Peter Selb, “Graphical Causal Models for Survey Inference” (December 17, 2019), doi: <a href="https://doi.org/10.31235/osf.io/hbg3m">10.31235/osf.io/hbg3m</a>, <a href="https://osf.io/preprints/socarxiv/hbg3m/">https://osf.io/preprints/socarxiv/hbg3m/</a></li>
<li>Scott Cunningham, “Directed acyclical graphs” in <em>Causal Inference: The Mixtape</em> (2018), <a href="https://www.scunning.com/mixtape.html">https://www.scunning.com/mixtape.html</a></li>
<li>Paul Hünermund, “Causal Inference with Directed Acyclic Graphs,” <a href="https://www.udemy.com/course/causal-data-science/?referralCode=4FB57D92601437BEB794">Udemy</a></li>
<li>Jason A. Roy, “A Crash Course in Causality: Inferring Causal Effects from Observational Data,” <a href="https://www.coursera.org/learn/crash-course-in-causality/home/welcome">Coursera</a></li>
</ul>
<p>Instead, this post is a practical example of how exactly you can isolate causal effects by closing backdoor paths and adjusting for confounders in observational data. At its core, DAG-based causal inference involves isolating relationships—if some variable causes both your treatment and your outcome (thus confounding it), you can deal with that common cause in some statistical way and isolate the treatment–outcome effect. There’s no one right way to statistically deal with confounding, so here I show a few different ways to do it.</p>
<p>To make this more concrete and practical, I use simulated data from a hypothetical program, but I use actual variable names rather than the $x$, $y$, and $z$ variables that are common in tutorials and articles about DAGs. Here, our outcome $y$ is a final grade, $x$ is a special math camp, and $z$ is all the possible confounders of the effect of the math camp on the grade.</p>
<p>Like <a href="https://www.andrewheiss.com/blog/2019/01/29/diff-means-half-dozen-ways/">my post showing a bunch of different ways to test differences in means</a>, this is mostly a resource to my students and to future me. <a href="https://github.com/andrewheiss/closing-backdoors-dags/issues">Please feel free to comment and make corrections or additions at GitHub!</a></p>
<p>Here’s a tl;dr table of contents since this is a little long:</p>
<ul>
<li><a href="#example-program">Example program</a></li>
<li><a href="#simulated-data">Simulated data</a></li>
<li><a href="#incorrect-correlation-is-not-causation-estimate">Incorrect “correlation is not causation” estimate</a></li>
<li><a href="#adjustment-using-forbidden-unmeasured-variable">Adjustment using forbidden unmeasured variable</a></li>
<li><a href="#adjustment-using-educated-guess-based-naive-matching">Adjustment using educated-guess-based naive matching</a></li>
<li><a href="#brief-interlude-matching--slightly-simpler-dag">Brief interlude: Matching + slightly simpler DAG</a></li>
<li><a href="#adjustment-using-inverse-probability-weighting-ipw">Adjustment using inverse probability weighting (IPW)</a></li>
<li><a href="#adjustment-using-matching-with-mahalanobis-distance">Adjustment using matching (with Mahalanobis distance)</a></li>
<li><a href="#someday-when-im-smarter-do-calculus">Someday when I’m smarter: <em>do</em>-calculus</a></li>
<li><a href="#comparison-of-all-methods">Comparison of all methods</a></li>
</ul>
<h2 id="example-program">Example program</h2>
<p>We’ll refer to a hypothetical math camp program throughout all these examples. Many policy schools offer a brief math camp in the weeks before students begin their graduate degrees, with the hope that it will help students be more prepared in math-heavy classes like statistics and microeconomics. For these examples, we’re interested in answering one question: what is the causal effect of attending math camp on final student outcomes?</p>
<p>We can use <a href="https://cran.r-project.org/web/packages/ggdag/vignettes/intro-to-ggdag.html"><strong>ggdag</strong></a> to draw a simplified causal model that explains what causes final student outcomes (it’s probably wrong, but whatever). I added all the fancy bells and whistles to the graph object here just for the sake of reference. In reality, you don’t need labels or coordinates or the individual <code>geom_dag_*()</code> layers and you can just do <code>ggdag(math_camp_dag)</code> to get a basic graph, but for fun I’ve included everything you need for a publication-worthy graph.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(tidyverse)  <span style="color:#75715e"># ggplot, dplyr, %&gt;%, and friends</span>
<span style="color:#a6e22e">library</span>(ggdag)  <span style="color:#75715e"># Make DAGs with ggplot</span>
<span style="color:#a6e22e">library</span>(dagitty)  <span style="color:#75715e"># Do basic DAG math</span>
<span style="color:#a6e22e">library</span>(broom)  <span style="color:#75715e"># For converting model output to data frames</span>

node_details <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tribble</span>(
  <span style="color:#f92672">~</span>name, <span style="color:#f92672">~</span>label, <span style="color:#f92672">~</span>x, <span style="color:#f92672">~</span>y,
  <span style="color:#e6db74">&#34;math_camp&#34;</span>, <span style="color:#e6db74">&#34;Math camp&#34;</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span>,
  <span style="color:#e6db74">&#34;final_grade&#34;</span>, <span style="color:#e6db74">&#34;Final grade&#34;</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">1</span>,
  <span style="color:#e6db74">&#34;needs_camp&#34;</span>, <span style="color:#e6db74">&#34;Needs camp&#34;</span>, <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>,
  <span style="color:#e6db74">&#34;gre_quant&#34;</span>, <span style="color:#e6db74">&#34;GRE quantitative&#34;</span>, <span style="color:#ae81ff">2.5</span>, <span style="color:#ae81ff">2</span>,
  <span style="color:#e6db74">&#34;gre_verbal&#34;</span>, <span style="color:#e6db74">&#34;GRE verbal&#34;</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">2</span>,
  <span style="color:#e6db74">&#34;background&#34;</span>, <span style="color:#e6db74">&#34;Background&#34;</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">3</span>,
  <span style="color:#e6db74">&#34;undergraduate_gpa&#34;</span>, <span style="color:#e6db74">&#34;Undergraduate GPA&#34;</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">3</span>
)

node_labels <span style="color:#f92672">&lt;-</span> node_details<span style="color:#f92672">$</span>label
<span style="color:#a6e22e">names</span>(node_labels) <span style="color:#f92672">&lt;-</span> node_details<span style="color:#f92672">$</span>name

math_camp_dag <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dagify</span>(final_grade <span style="color:#f92672">~</span> math_camp <span style="color:#f92672">+</span> gre_quant <span style="color:#f92672">+</span> gre_verbal <span style="color:#f92672">+</span> 
                          undergraduate_gpa <span style="color:#f92672">+</span> background,
                        math_camp <span style="color:#f92672">~</span> needs_camp, 
                        needs_camp <span style="color:#f92672">~</span> background <span style="color:#f92672">+</span> undergraduate_gpa <span style="color:#f92672">+</span> gre_quant,
                        gre_quant <span style="color:#f92672">~</span> background <span style="color:#f92672">+</span> undergraduate_gpa,
                        gre_verbal <span style="color:#f92672">~</span> background <span style="color:#f92672">+</span> undergraduate_gpa,
                        undergraduate_gpa <span style="color:#f92672">~</span> background,
                        exposure <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;math_camp&#34;</span>,
                        outcome <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;final_grade&#34;</span>,
                        latent <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;background&#34;</span>,
                        coords <span style="color:#f92672">=</span> node_details,
                        labels <span style="color:#f92672">=</span> node_labels)

<span style="color:#75715e"># Turn DAG into a tidy data frame for plotting</span>
math_camp_dag_tidy <span style="color:#f92672">&lt;-</span> math_camp_dag <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">tidy_dagitty</span>() <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">node_status</span>()   <span style="color:#75715e"># Add column for exposure/outcome/latent</span>

status_colors <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(exposure <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#0074D9&#34;</span>, outcome <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#FF4136&#34;</span>, latent <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;grey50&#34;</span>)

<span style="color:#75715e"># Fancier graph</span>
<span style="color:#a6e22e">ggplot</span>(math_camp_dag_tidy, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> x, y <span style="color:#f92672">=</span> y, xend <span style="color:#f92672">=</span> xend, yend <span style="color:#f92672">=</span> yend)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_dag_edges</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_dag_point</span>(<span style="color:#a6e22e">aes</span>(color <span style="color:#f92672">=</span> status)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_dag_label_repel</span>(<span style="color:#a6e22e">aes</span>(label <span style="color:#f92672">=</span> label, fill <span style="color:#f92672">=</span> status), seed <span style="color:#f92672">=</span> <span style="color:#ae81ff">1234</span>,
                       color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;white&#34;</span>, fontface <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bold&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_color_manual</span>(values <span style="color:#f92672">=</span> status_colors, na.value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;grey20&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_fill_manual</span>(values <span style="color:#f92672">=</span> status_colors, na.value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;grey20&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">guides</span>(color <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>, fill <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>) <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">theme_dag</span>()
</code></pre></div><p><img src="load-libraries-make-dag-1.png" alt="DAG for math camp example"></p>
<p>We can tell a fairly complex story using this graph. Your final grade in the program is caused by a host of things, including your quantitative and verbal GRE scores (<a href="https://www.sciencemag.org/careers/2017/06/gres-dont-predict-grad-school-success-what-does">PROBABLY DEFINITELY NOT in real life</a>, but go with it), your undergraduate GPA, and your unmeasured background factors (age, parental income, math anxiety, level of interest in the program, etc.). Your undergraduate GPA is determined by your background, and your GRE scores are determined by both your undergraduate GPA and your background. Because this math camp program is open to anyone, there is self-selection in who chooses to do it. We can pretend that this is decided by your undergraduate GPA, your quantitative GRE score, and your background. If the program was need-based and only offered to people with low GRE scores, we could draw an arrow from GRE quantitative to math camp, but we don’t. Finally, needing the math camp causes people to do it.</p>
<p>There is a direct path between our treatment and outcome (math camp → final grade), but there is also some possible backdoor confounding. Both GRE quantitative and undergraduate GPA have arrows pointing to final grade and math camp (through “needs camp”), which means they’re a common cause, and background is both a confounder <em>and</em> unmeasurable. But we don’t need to give up! If we adjust or control for “needs camp,” we can block the association between background, GRE quantitative, and undergraduate GPA. With this backdoor closed, we’ve isolated the math camp → final grade relationship and can find the causal effect.</p>
<p>However, we don’t really have a measure for needing math camp—we can’t read peoples’ minds and see if they need the program—so while it’d be great to just include a <code>needs_camp</code> variable in a regression model, we’ll have to use other techniques to close the backdoor.</p>
<p>You can find the backdoors automatically with Dagitty (draw the DAG there and notice red arrows between the unblocked confounders), or with functions in the <a href="https://cran.r-project.org/package=dagitty"><strong>dagitty</strong> R package</a>. If you run <code>paths(math_camp_dag)</code>, you can see that the only node pointing back into <code>math_camp</code> is <code>needs_camp</code>, and if you run <code>adjustmentSets(math_camp_dag)</code>, you’ll see that <code>needs_camp</code> is the only required adjustment set:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">paths</span>(math_camp_dag)
<span style="color:#75715e">## $paths</span>
<span style="color:#75715e">##  [1] &#34;math_camp -&gt; final_grade&#34;</span>
<span style="color:#75715e">##  [2] &#34;math_camp &lt;- needs_camp &lt;- background -&gt; final_grade&#34;</span>
<span style="color:#75715e">##  [3] &#34;math_camp &lt;- needs_camp &lt;- background -&gt; gre_quant -&gt; final_grade&#34;</span>
<span style="color:#75715e">##  [4] &#34;math_camp &lt;- needs_camp &lt;- background -&gt; gre_quant &lt;- undergraduate_gpa -&gt; final_grade&#34;</span>
<span style="color:#75715e">##  [5] &#34;math_camp &lt;- needs_camp &lt;- background -&gt; gre_quant &lt;- undergraduate_gpa -&gt; gre_verbal -&gt; final_grade&#34;</span>
<span style="color:#75715e">##  [6] &#34;math_camp &lt;- needs_camp &lt;- background -&gt; gre_verbal -&gt; final_grade&#34;</span>
<span style="color:#75715e">##  ...</span>
<span style="color:#75715e">##</span>
<span style="color:#75715e">## $open</span>
<span style="color:#75715e">##  [1]  TRUE  TRUE  TRUE FALSE FALSE  TRUE FALSE FALSE  TRUE  TRUE  TRUE</span>
<span style="color:#75715e">## [12]  TRUE  TRUE  TRUE FALSE  TRUE  TRUE  TRUE  TRUE FALSE  TRUE  TRUE</span>
<span style="color:#75715e">## [23]  TRUE  TRUE FALSE FALSE  TRUE FALSE FALSE  TRUE  TRUE  TRUE</span>

<span style="color:#a6e22e">adjustmentSets</span>(math_camp_dag)
<span style="color:#75715e">##  { needs_camp }</span>
</code></pre></div><h2 id="simulated-data">Simulated data</h2>
<p>Assuming this causal graph is correct (it’s probably not, but again, go with it), we can simulate data that reflects these causal relationships. There are a host of R packages for simulating data (like <a href="https://github.com/trinker/wakefield"><strong>wakefield</strong></a>, <a href="https://www.rdatagen.net/page/simstudy/"><strong>simstudy</strong></a>, and <a href="https://declaredesign.org/r/fabricatr/"><strong>fabricatr</strong></a>), but here I do it a little more manually using <code>MASS::mvrnorm()</code> to use a <a href="https://stats.stackexchange.com/a/164476/3025">multivariate normal distribution to generate continuous variables that have a specific mean, standard deviation, and relationship with other variables</a>.</p>
<p>Because data generation is beyond the scope of this post, the code below is heavily annotated. Importantly, the various <code>mutate()</code> commands that create the <code>math_camp</code> data below create relationships between the confounders, treatment, and outcome. We also create a <code>needs_camp</code> variable that is true if <strong>both</strong> a student’s quantitative GRE score is less than the average <em>and</em> if their undergraduate GPA is less than the average. We also build in some noncompliance: 80% of those who need math camp do it; 20% of those who don’t need it do it.</p>
<p>For the sake of simplicity, the outcome here (<code>final_grade</code>) isn’t GPA or anything—it’s an arbitrary number between 120 and 160 (though we could rescale it to something else).</p>
<p><strong>Most importantly</strong>, we force the math camp program to cause a <strong>10 point increase</strong> in students’ final grades. This is our baseline average treatment effect that we want to be able to find using different backdoor adjustment techniques.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Make these random draws the same every time</span>
<span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">1234</span>)

<span style="color:#75715e"># Create 2,000 rows</span>
num <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">2000</span>

<span style="color:#75715e"># Create confounder variables that are related to each other</span>
mu <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(undergrad_gpa <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, gre_verbal <span style="color:#f92672">=</span> <span style="color:#ae81ff">160</span>, gre_quant <span style="color:#f92672">=</span> <span style="color:#ae81ff">145</span>)
stddev <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(undergrad_gpa <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.5</span>, gre_verbal <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>, gre_quant <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>)

<span style="color:#75715e"># Correlation matrix: undergrad GPA and verbal GRE have a correlation of 0.8;</span>
<span style="color:#75715e"># undergrad GPA and quantitative GRE have a correlation of 0.6, and verbal GRE</span>
<span style="color:#75715e"># and quantitative GRE have a correlation of 0.4</span>
cor_matrix <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">matrix</span>(<span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">1.0</span>, <span style="color:#ae81ff">0.8</span>, <span style="color:#ae81ff">0.6</span>,
                       <span style="color:#ae81ff">0.8</span>, <span style="color:#ae81ff">1.0</span>, <span style="color:#ae81ff">0.4</span>,
                       <span style="color:#ae81ff">0.6</span>, <span style="color:#ae81ff">0.4</span>, <span style="color:#ae81ff">1.0</span>),
                     ncol <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>)

<span style="color:#75715e"># Convert correlation matrix to covariance matrix using fancy math</span>
cov_matrix <span style="color:#f92672">&lt;-</span> stddev <span style="color:#f92672">%*%</span> <span style="color:#a6e22e">t</span>(stddev) <span style="color:#f92672">*</span> cor_matrix

<span style="color:#75715e"># Draw random numbers</span>
confounders <span style="color:#f92672">&lt;-</span> MASS<span style="color:#f92672">::</span><span style="color:#a6e22e">mvrnorm</span>(n <span style="color:#f92672">=</span> num, mu <span style="color:#f92672">=</span> mu, Sigma <span style="color:#f92672">=</span> cov_matrix, empirical <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">as_tibble</span>() <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Truncate values so they&#39;re within 130-170 range for GRE and less than 4.0 for GPA</span>
  <span style="color:#a6e22e">mutate_at</span>(<span style="color:#a6e22e">vars</span>(gre_verbal, gre_quant),
            <span style="color:#f92672">~</span><span style="color:#a6e22e">case_when</span>(
              . <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">170</span> <span style="color:#f92672">~</span> <span style="color:#ae81ff">170</span>,
              . <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">130</span> <span style="color:#f92672">~</span> <span style="color:#ae81ff">130</span>,
              <span style="color:#66d9ef">TRUE</span> <span style="color:#f92672">~</span> .
            )) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">mutate</span>(undergrad_gpa <span style="color:#f92672">=</span> <span style="color:#a6e22e">ifelse</span>(undergrad_gpa <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">4</span>, undergrad_gpa))

<span style="color:#75715e"># Make official dataset of simulated values</span>
math_camp <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tibble</span>(id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>num) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">bind_cols</span>(confounders) <span style="color:#f92672">%&gt;%</span>  <span style="color:#75715e"># Bring in confounders</span>
  <span style="color:#75715e"># People need math camp if their GRE and GPA is lower than the average</span>
  <span style="color:#a6e22e">mutate</span>(needs_camp <span style="color:#f92672">=</span> gre_quant <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">mean</span>(gre_quant) <span style="color:#f92672">&amp;</span> 
           undergrad_gpa <span style="color:#f92672">&lt;</span> <span style="color:#a6e22e">mean</span>(undergrad_gpa)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Build in some noncompliance: 80% of those who need math camp do it; 20% of</span>
  <span style="color:#75715e"># those who don&#39;t need it do it.</span>
  <span style="color:#a6e22e">mutate</span>(math_camp <span style="color:#f92672">=</span> <span style="color:#a6e22e">case_when</span>(
    needs_camp <span style="color:#f92672">==</span> <span style="color:#66d9ef">TRUE</span> <span style="color:#f92672">~</span> <span style="color:#a6e22e">rbinom</span>(<span style="color:#a6e22e">n</span>(), <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0.8</span>),
    needs_camp <span style="color:#f92672">==</span> <span style="color:#66d9ef">FALSE</span> <span style="color:#f92672">~</span> <span style="color:#a6e22e">rbinom</span>(<span style="color:#a6e22e">n</span>(), <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0.2</span>)
  )) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Create random error in grades</span>
  <span style="color:#a6e22e">mutate</span>(grade_noise <span style="color:#f92672">=</span> <span style="color:#a6e22e">rnorm</span>(num, <span style="color:#ae81ff">15</span>, <span style="color:#ae81ff">5</span>)) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Create final grade based on all the arrows going into the node in the DAG.</span>
  <span style="color:#75715e"># There&#39;s a 10 point causal effect</span>
  <span style="color:#a6e22e">mutate</span>(final_grade <span style="color:#f92672">=</span> (<span style="color:#ae81ff">0.3</span> <span style="color:#f92672">*</span> gre_verbal) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">0.5</span> <span style="color:#f92672">*</span> gre_quant) <span style="color:#f92672">+</span> 
           (<span style="color:#ae81ff">0.4</span> <span style="color:#f92672">*</span> undergrad_gpa) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">10</span> <span style="color:#f92672">*</span> math_camp) <span style="color:#f92672">+</span> grade_noise) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">mutate</span>(math_camp <span style="color:#f92672">=</span> <span style="color:#a6e22e">as.logical</span>(math_camp))  <span style="color:#75715e"># Make true/false</span>
</code></pre></div><p>Phew. That’s a lot of code to make fake data, but it worked! We can look at the first few rows:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">head</span>(math_camp)

<span style="color:#75715e">## # A tibble: 6 x 8</span>
<span style="color:#75715e">##      id undergrad_gpa gre_verbal gre_quant needs_camp math_camp grade_noise</span>
<span style="color:#75715e">##   &lt;int&gt;         &lt;dbl&gt;      &lt;dbl&gt;     &lt;dbl&gt; &lt;lgl&gt;      &lt;lgl&gt;           &lt;dbl&gt;</span>
<span style="color:#75715e">## 1     1          3.90       170       151. FALSE      FALSE            13.5</span>
<span style="color:#75715e">## 2     2          3.20       163.      143. FALSE      FALSE            13.2</span>
<span style="color:#75715e">## 3     3          2.83       162.      140. TRUE       TRUE             10.4</span>
<span style="color:#75715e">## 4     4          2.63       144.      154. FALSE      FALSE            17.0</span>
<span style="color:#75715e">## 5     5          3.24       170       148. FALSE      FALSE            16.4</span>
<span style="color:#75715e">## 6     6          2.95       167.      146. FALSE      FALSE            19.0</span>
<span style="color:#75715e">## # … with 1 more variable: final_grade &lt;dbl&gt;</span>
</code></pre></div><p>About 40% of the students participated in math camp:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">math_camp <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">count</span>(math_camp) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(prop <span style="color:#f92672">=</span> n <span style="color:#f92672">/</span> <span style="color:#a6e22e">sum</span>(n))

<span style="color:#75715e">## # A tibble: 2 x 3</span>
<span style="color:#75715e">##   math_camp     n  prop</span>
<span style="color:#75715e">##   &lt;lgl&gt;     &lt;int&gt; &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 FALSE      1182 0.591</span>
<span style="color:#75715e">## 2 TRUE        818 0.409</span>
</code></pre></div><h2 id="incorrect-correlation-is-not-causation-estimate">Incorrect “correlation is not causation” estimate</h2>
<p>We can take an initial stab at finding the causal effect of the program by comparing the average final grades for those who did math camp and those who didn’t. At first glance, it looks like math camp participants have a higher grade!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">math_camp <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">group_by</span>(math_camp) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">summarize</span>(avg <span style="color:#f92672">=</span> <span style="color:#a6e22e">mean</span>(final_grade))

<span style="color:#75715e">## # A tibble: 2 x 2</span>
<span style="color:#75715e">##   math_camp   avg</span>
<span style="color:#75715e">##   &lt;lgl&gt;     &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 FALSE      138.</span>
<span style="color:#75715e">## 2 TRUE       144.</span>
</code></pre></div><p>The distribution of scores is higher for those who did the program:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">ggplot</span>(math_camp, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> final_grade, fill <span style="color:#f92672">=</span> math_camp)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_histogram</span>(binwidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;white&#34;</span>) <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">guides</span>(fill <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">facet_wrap</span>(<span style="color:#a6e22e">vars</span>(math_camp), ncol <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_light</span>()
</code></pre></div><p><img src="plot-distributions-wrong-1.png" alt="Naive, wrong distributions"></p>
<p>We can run a simple linear regression model to estimate the exact effect:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">model_wrong <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(final_grade <span style="color:#f92672">~</span> math_camp, data <span style="color:#f92672">=</span> math_camp)
<span style="color:#a6e22e">tidy</span>(model_wrong)

<span style="color:#75715e">## # A tibble: 2 x 5</span>
<span style="color:#75715e">##   term          estimate std.error statistic   p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)     138.       0.185     744.  0.       </span>
<span style="color:#75715e">## 2 math_campTRUE     6.54     0.290      22.6 8.48e-101</span>
</code></pre></div><p>Based on this model, participating in the program is associated with 6.5 more points in your final grade. Neat.</p>
<p>This is wrong, though, since there are confounders at play that cause both attendance at math camp and final grade. We need to adjust for those to get the actual causal effect.</p>
<h2 id="adjustment-using-forbidden-unmeasured-variable">Adjustment using forbidden unmeasured variable</h2>
<p>The backdoor confounder we have to worry about is <code>needs_camp</code>. We created this variable when we generated the data, so for fun, we can include it in the regression model as a control variable to adjust for it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">model_adj_needs_camp <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(final_grade <span style="color:#f92672">~</span> math_camp <span style="color:#f92672">+</span> needs_camp, data <span style="color:#f92672">=</span> math_camp)
<span style="color:#a6e22e">tidy</span>(model_adj_needs_camp)

<span style="color:#75715e">## # A tibble: 3 x 5</span>
<span style="color:#75715e">##   term           estimate std.error statistic   p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;             &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)      139.       0.174     798.  0.       </span>
<span style="color:#75715e">## 2 math_campTRUE     10.2      0.320      31.9 2.79e-181</span>
<span style="color:#75715e">## 3 needs_campTRUE    -6.69     0.329     -20.3 1.28e- 83</span>
</code></pre></div><p>The coefficient for <code>math_campTRUE</code> is now ≈10, which is what it should be! Adjusting for needing math camp isolated the causal effect.</p>
<p>But we can’t do that in real life. We don’t know what needing math camp looks like in actual data, so we need to use other techniques.</p>
<h2 id="adjustment-using-educated-guess-based-naive-matching">Adjustment using educated-guess-based naive matching</h2>
<p>One possible approach to guessing the need for math camp is to create groups of students based on what we think might be driving the need for camp. We know from the causal model that quantitative GRE scores and undergraduate GPAs partially cause needing the program. We can assume that people with lower test scores or lower GPAs need the camp and create our own guess about what the threshold might be.</p>
<p>Let’s look at the distribution of GRE scores and see if there’s any pattern about why people may have chosen to do the program:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">ggplot</span>(math_camp, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> gre_quant, fill <span style="color:#f92672">=</span> math_camp)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_histogram</span>(binwidth <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;white&#34;</span>) <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">guides</span>(fill <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">facet_wrap</span>(<span style="color:#a6e22e">vars</span>(math_camp), ncol <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_light</span>()
</code></pre></div><p><img src="gre-math-camp-1.png" alt="Quantitative GRE score across math camp participation"></p>
<p>There’s a pretty noticable break in the distribution of GRE scores for those who did the program: lots of people who scored under 145ish did the program, while not a lot of people who scored over 145 did. Without knowing anything about what completely causes math camp need, we can pretend that 145 is some sort of threshold of need and use that as our confounder:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">math_camp_guessed_need <span style="color:#f92672">&lt;-</span> math_camp <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(maybe_needs_camp <span style="color:#f92672">=</span> gre_quant <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">145</span>)

model_adj_needs_camp_guess <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(final_grade <span style="color:#f92672">~</span> math_camp <span style="color:#f92672">+</span> maybe_needs_camp, 
                                 data <span style="color:#f92672">=</span> math_camp_guessed_need)
<span style="color:#a6e22e">tidy</span>(model_adj_needs_camp_guess)

<span style="color:#75715e">## # A tibble: 3 x 5</span>
<span style="color:#75715e">##   term                 estimate std.error statistic   p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;                   &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)            140.       0.197     708.  0.       </span>
<span style="color:#75715e">## 2 math_campTRUE            8.70     0.292      29.8 4.41e-162</span>
<span style="color:#75715e">## 3 maybe_needs_campTRUE    -5.33     0.287     -18.6 2.36e- 71</span>
</code></pre></div><p>After adjusting for our possible needing camp confounder, the causal effect is now 8.7, which is closer to 10! It’s still not entirely correct, but we’re getting closer.</p>
<h2 id="brief-interlude-matching--slightly-simpler-dag">Brief interlude: Matching + slightly simpler DAG</h2>
<p>We just attempted to guess what the “needs camp” node might be based on the nodes flowing into it. If you notice, though, the “needs camp” node is an intermediate node on the path between GPA and GRE scores and actually participating in the math camp program. If we can guess what causes people to enroll in the program, that’s roughly the same as predicting their need for the camp.</p>
<p>Additionally, predicting enrollment in the program directly (rather than the desire to enroll) lets us use better matching techniques. Our guess of needing camp was pretty naive—it’d be more accurate if we incorporated other variables (like GPA and background) into our manual grouping. But the intuition of trying to group manually was correct—we looked at the factors that caused needing math camp and guessed that some things make it more likely. We can make this process more formal by building an actual model that predicts the likelihood of treatment.</p>
<p>To do this, we can remove the “needs camp” node, since it wasn’t doing much in the model and since we can use confounders like GPA and quantitative GRE to estimate the probability of enrollment in math camp directly. Here’s a slightly simpler version without “needs camp” and “background”:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">node_details_simpler <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tribble</span>(
  <span style="color:#f92672">~</span>name, <span style="color:#f92672">~</span>label, <span style="color:#f92672">~</span>x, <span style="color:#f92672">~</span>y,
  <span style="color:#e6db74">&#34;math_camp&#34;</span>, <span style="color:#e6db74">&#34;Math camp&#34;</span>, <span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">1</span>,
  <span style="color:#e6db74">&#34;final_grade&#34;</span>, <span style="color:#e6db74">&#34;Final grade&#34;</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">1</span>,
  <span style="color:#e6db74">&#34;gre_quant&#34;</span>, <span style="color:#e6db74">&#34;GRE quantitative&#34;</span>, <span style="color:#ae81ff">2.5</span>, <span style="color:#ae81ff">2</span>,
  <span style="color:#e6db74">&#34;gre_verbal&#34;</span>, <span style="color:#e6db74">&#34;GRE verbal&#34;</span>, <span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">2</span>,
  <span style="color:#e6db74">&#34;undergraduate_gpa&#34;</span>, <span style="color:#e6db74">&#34;Undergraduate GPA&#34;</span>, <span style="color:#ae81ff">4</span>, <span style="color:#ae81ff">3</span>
)

node_labels_simpler <span style="color:#f92672">&lt;-</span> node_details_simpler<span style="color:#f92672">$</span>label
<span style="color:#a6e22e">names</span>(node_labels_simpler) <span style="color:#f92672">&lt;-</span> node_details_simpler<span style="color:#f92672">$</span>name

math_camp_dag_simpler <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dagify</span>(final_grade <span style="color:#f92672">~</span> math_camp <span style="color:#f92672">+</span> gre_quant <span style="color:#f92672">+</span> gre_verbal <span style="color:#f92672">+</span> 
                                  undergraduate_gpa,
                                math_camp <span style="color:#f92672">~</span> undergraduate_gpa <span style="color:#f92672">+</span> gre_quant,
                                gre_quant <span style="color:#f92672">~</span> undergraduate_gpa,
                                gre_verbal <span style="color:#f92672">~</span> undergraduate_gpa,
                                exposure <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;math_camp&#34;</span>,
                                outcome <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;final_grade&#34;</span>,
                                coords <span style="color:#f92672">=</span> node_details,
                                labels <span style="color:#f92672">=</span> node_labels)

<span style="color:#75715e"># Turn DAG into a tidy data frame for plotting</span>
math_camp_dag_simpler_tidy <span style="color:#f92672">&lt;-</span> math_camp_dag_simpler <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">tidy_dagitty</span>() <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">node_status</span>()   <span style="color:#75715e"># Add column for exposure/outcome</span>

status_colors <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">c</span>(exposure <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#0074D9&#34;</span>, outcome <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#FF4136&#34;</span>, latent <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;grey50&#34;</span>)

<span style="color:#75715e"># Fancier graph</span>
<span style="color:#a6e22e">ggplot</span>(math_camp_dag_simpler_tidy, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> x, y <span style="color:#f92672">=</span> y, xend <span style="color:#f92672">=</span> xend, yend <span style="color:#f92672">=</span> yend)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_dag_edges</span>() <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_dag_point</span>(<span style="color:#a6e22e">aes</span>(color <span style="color:#f92672">=</span> status)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_dag_label_repel</span>(<span style="color:#a6e22e">aes</span>(label <span style="color:#f92672">=</span> label, fill <span style="color:#f92672">=</span> status), seed <span style="color:#f92672">=</span> <span style="color:#ae81ff">1234</span>,
                       color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;white&#34;</span>, fontface <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;bold&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_color_manual</span>(values <span style="color:#f92672">=</span> status_colors, na.value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;grey20&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_fill_manual</span>(values <span style="color:#f92672">=</span> status_colors, na.value <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;grey20&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">guides</span>(color <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>, fill <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>) <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">theme_dag</span>()
</code></pre></div><p><img src="simpler-dag-1.png" alt="Simpler math camp DAG"></p>
<h2 id="adjustment-using-inverse-probability-weighting-ipw">Adjustment using inverse probability weighting (IPW)</h2>
<p>One common method for matching the assignment to treatment based on confounders that is quite popular in epidemiology is to use inverse probability weighting (IPW). To estimate causal effects with IPW, we follow a two-step process. In the first step, we use the confounders to estimate propensity scores for each observation, or the probability of that observation going to math camp given other characteristics.</p>
<p>A common way to generate propensity scores is to use logistic regression. Here we build a model estimating participation in math camp based on undergraduate GPA and quantitative GRE scores. We then use <code>augment()</code> to plug the GPA and GRE values for each observation into the model and generate a predicted probability:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">needs_camp_model <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">glm</span>(math_camp <span style="color:#f92672">~</span> undergrad_gpa <span style="color:#f92672">+</span> gre_quant, data <span style="color:#f92672">=</span> math_camp, 
                        family <span style="color:#f92672">=</span> <span style="color:#a6e22e">binomial</span>(link <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;logit&#34;</span>))

math_camp_propensities <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">augment</span>(needs_camp_model, math_camp, type.predict <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;response&#34;</span>) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#a6e22e">mutate</span>(p_camp <span style="color:#f92672">=</span> .fitted)  <span style="color:#75715e"># Rename column</span>

math_camp_propensities <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">select</span>(id, undergrad_gpa, gre_quant, math_camp, p_camp) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">head</span>()

<span style="color:#75715e">## # A tibble: 6 x 5</span>
<span style="color:#75715e">##      id undergrad_gpa gre_quant math_camp p_camp</span>
<span style="color:#75715e">##   &lt;int&gt;         &lt;dbl&gt;     &lt;dbl&gt; &lt;lgl&gt;      &lt;dbl&gt;</span>
<span style="color:#75715e">## 1     1          3.90      151. FALSE     0.0969</span>
<span style="color:#75715e">## 2     2          3.20      143. FALSE     0.371 </span>
<span style="color:#75715e">## 3     3          2.83      140. TRUE      0.554 </span>
<span style="color:#75715e">## 4     4          2.63      154. FALSE     0.291 </span>
<span style="color:#75715e">## 5     5          3.24      148. FALSE     0.258 </span>
<span style="color:#75715e">## 6     6          2.95      146. FALSE     0.371</span>
</code></pre></div><p>We have a new column <code>p_camp</code> that shows the probability of going to camp based on grades and test scores. Our first person has a high GPA and high GRE score, so they have a 9% chance of going to math camp, while person 3 has a low GPA and low test score, so they’re more likely to need it.</p>
<p>In the second step, we incorporate these predicted probabilities into our causal effect estimation by converting them into weights, which creates a pseduo-population of observations (i.e. some student observations are more important than others for estimating the causal effect). What this means practically is that people with a low likelihood of attending math camp who <em>do</em> attend it anyway should be treated as more important than those who follow expectations, since those with higher weights are more likely to influence the overall causal effect.</p>
<p>There are a whole bunch of different weighting techniques, and <a href="https://livefreeordichotomize.com/">Lucy D’Agostino McGowan</a> covers them in depth <a href="https://livefreeordichotomize.com/2019/01/17/understanding-propensity-score-weighting/">in her excellent blog post here</a> (see also <a href="https://www.rdatagen.net/post/potential-outcomes-confounding/">this</a>). For the sake of this example, we’ll calculate weights that are appropriate for estimating two different causal quantities. Here, $i$ represents an individual student, $e_i$ represents the propensity score for an individual needing/participating in math camp, or the treatment $Z_i$:</p>
<ul>
<li>Average treatment effect (ATE): overall average effect, or the difference in potential outcomes when the Z = 1 and Z = 0. Formula for weights: $\frac{Z_i}{e_i} + \frac{1 - Z_i}{1 - e_i}$</li>
<li>Average treatment effect among the overlap population (ATO): effect of math camp across observations that overlap (i.e. those who are both likely and unlikely to need math camp). Formula for weights: $(1-e_i)Z_i + e_i(1-Z_i)$</li>
</ul>
<!-- end list -->
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">math_camp_propensities <span style="color:#f92672">&lt;-</span> math_camp_propensities <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(w_ate <span style="color:#f92672">=</span> (math_camp <span style="color:#f92672">/</span> p_camp) <span style="color:#f92672">+</span> ((<span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> math_camp) <span style="color:#f92672">/</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> p_camp)),
         w_ato <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> p_camp) <span style="color:#f92672">*</span> math_camp <span style="color:#f92672">+</span> p_camp <span style="color:#f92672">*</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> math_camp))

math_camp_propensities <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">select</span>(id, p_camp, w_ate, w_ato) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">head</span>()

<span style="color:#75715e">## # A tibble: 6 x 4</span>
<span style="color:#75715e">##      id p_camp w_ate  w_ato</span>
<span style="color:#75715e">##   &lt;int&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;</span>
<span style="color:#75715e">## 1     1 0.0969  1.11 0.0969</span>
<span style="color:#75715e">## 2     2 0.371   1.59 0.371 </span>
<span style="color:#75715e">## 3     3 0.554   1.80 0.446 </span>
<span style="color:#75715e">## 4     4 0.291   1.41 0.291 </span>
<span style="color:#75715e">## 5     5 0.258   1.35 0.258 </span>
<span style="color:#75715e">## 6     6 0.371   1.59 0.371</span>
</code></pre></div><p>Finally, we can incorporate these weights into a regression model. Note how we’re using <code>math_camp</code> as the only explanatory variable. Because we used undergraduate GPA and quantitative GRE scores to estimate the propensity scores for needing camp (and receiving the program), including the weights should be enough to close the “needs camp” back door:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">model_ipw_ate <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(final_grade <span style="color:#f92672">~</span> math_camp, 
                    data <span style="color:#f92672">=</span> math_camp_propensities, weights <span style="color:#f92672">=</span> w_ate)
<span style="color:#a6e22e">tidy</span>(model_ipw_ate)

<span style="color:#75715e">## # A tibble: 2 x 5</span>
<span style="color:#75715e">##   term          estimate std.error statistic   p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)      137.      0.222     614.  0.       </span>
<span style="color:#75715e">## 2 math_campTRUE     10.9     0.308      35.3 8.75e-213</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">model_ipw_ato <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(final_grade <span style="color:#f92672">~</span> math_camp, 
                    data <span style="color:#f92672">=</span> math_camp_propensities, weights <span style="color:#f92672">=</span> w_ato)
<span style="color:#a6e22e">tidy</span>(model_ipw_ato)

<span style="color:#75715e">## # A tibble: 2 x 5</span>
<span style="color:#75715e">##   term          estimate std.error statistic   p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)      136.      0.203     672.  0.       </span>
<span style="color:#75715e">## 2 math_campTRUE     10.0     0.286      35.0 1.02e-209</span>
</code></pre></div><p>Both of these causal estimates are pretty spot on, with the ATO providing an answer incredibly close to the true value of 10. Neat!</p>
<p>If we had other backdoors to adjust for, we could include them in the propensity score model as well. We can do all our backdoor adjustment in the logit model, generate propensity scores, generate inverse probability weights, and then use the weights in a simple regression model to find the actual causal effect.</p>
<h2 id="adjustment-using-matching-with-mahalanobis-distance">Adjustment using matching (with Mahalanobis distance)</h2>
<p>We can use other methods to find matches in the data to estimate the probability of attending math camp. There’s a whole world of other statistical methods for creating matches; inverse probability weights are just one method.</p>
<p>While matching based on propensity scores (i.e. building some model to generate predicted probabilities for the likelihood of treatment and matching observations that have similar propensities) is popular, it can cause problems when you use it for causal identification. Following <a href="https://www.youtube.com/watch?v=rBv39pK1iEs">Gary King’s suggestions</a>, we can match with other techniques. (Again, covering what all these do goes beyond the scope of this post, but there are some excellent resources out there, like <a href="https://www.youtube.com/watch?v=rBv39pK1iEs">this highly accessible video by Gary King</a>.)</p>
<p>One popular technique in political science is to match based on <a href="https://en.wikipedia.org/wiki/Mahalanobis_distance">Mahalanobis</a> (or <a href="https://en.wikipedia.org/wiki/Euclidean_distance">Euclidean</a>) distance. We can use <code>matchit()</code> from the <strong>MatchIt</strong> library to group students with similar needs. Instead of creating a new grouping variable like we did before for <code>needs_camp</code>, because we know that undergrad GPA and quantitative GRE scores cause needing math camp, and that needing math camp is the only path into actually doing the program, we can model the probability of treatment by using undergrad GPA and quantitative GRE.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(MatchIt)  <span style="color:#75715e"># For matching stuff</span>

matched <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">matchit</span>(math_camp <span style="color:#f92672">~</span> undergrad_gpa <span style="color:#f92672">+</span> gre_quant, data <span style="color:#f92672">=</span> math_camp,
                   method <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;nearest&#34;</span>, distance <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mahalanobis&#34;</span>, replace <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)
matched

<span style="color:#75715e">## </span>
<span style="color:#75715e">## Call: </span>
<span style="color:#75715e">## matchit(formula = math_camp ~ undergrad_gpa + gre_quant, data = math_camp, </span>
<span style="color:#75715e">##     method = &#34;nearest&#34;, distance = &#34;mahalanobis&#34;, replace = TRUE)</span>
<span style="color:#75715e">## </span>
<span style="color:#75715e">## Sample sizes:</span>
<span style="color:#75715e">##           Control Treated</span>
<span style="color:#75715e">## All          1182     818</span>
<span style="color:#75715e">## Matched       366     818</span>
<span style="color:#75715e">## Unmatched     816       0</span>
<span style="color:#75715e">## Discarded       0       0</span>
</code></pre></div><p>By matching this way, we found 366 people who didn’t do math camp who look similar to those who did, which means we can arguably say that those who didn’t do it didn’t need to. If we want, we can see which observations were matched:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">head</span>(matched<span style="color:#f92672">$</span>match.matrix)

<span style="color:#75715e">##    1     </span>
<span style="color:#75715e">## 3  &#34;1864&#34;</span>
<span style="color:#75715e">## 7  &#34;646&#34; </span>
<span style="color:#75715e">## 9  &#34;586&#34; </span>
<span style="color:#75715e">## 12 &#34;83&#34;  </span>
<span style="color:#75715e">## 15 &#34;244&#34; </span>
<span style="color:#75715e">## 20 &#34;1815&#34;</span>
</code></pre></div><p>And we can extract the details from the match:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">math_camp_matched <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">match.data</span>(matched)
<span style="color:#a6e22e">head</span>(math_camp_matched)

<span style="color:#75715e">##    id undergrad_gpa gre_verbal gre_quant needs_camp math_camp grade_noise</span>
<span style="color:#75715e">## 3   3      2.828828   161.6843  140.4169       TRUE      TRUE    10.37564</span>
<span style="color:#75715e">## 5   5      3.244684   170.0000  147.9607      FALSE     FALSE    16.40707</span>
<span style="color:#75715e">## 7   7      3.757950   170.0000  151.4425      FALSE      TRUE    24.01470</span>
<span style="color:#75715e">## 9   9      3.085583   162.4533  149.3013      FALSE      TRUE    21.00359</span>
<span style="color:#75715e">## 12 12      3.300517   167.0163  152.7640      FALSE      TRUE    15.10616</span>
<span style="color:#75715e">## 15 15      3.809366   170.0000  141.3918      FALSE      TRUE    12.68628</span>
<span style="color:#75715e">##    final_grade distance   weights</span>
<span style="color:#75715e">## 3     140.2209       NA 1.0000000</span>
<span style="color:#75715e">## 5     142.6853       NA 0.4474328</span>
<span style="color:#75715e">## 7     162.2392       NA 1.0000000</span>
<span style="color:#75715e">## 9     155.6245       NA 1.0000000</span>
<span style="color:#75715e">## 12    152.9133       NA 1.0000000</span>
<span style="color:#75715e">## 15    145.9059       NA 1.0000000</span>
</code></pre></div><p>We have one new column in this data: <code>weights</code>. Observations are now weighted differently based on how distant they are from their matches—observations who attended math camp that are similar to those who didn’t have a higher weight. This weighting creates a pseudo-population of students (i.e. some student observations are more important than others for estimating the causal effect), just like we did with IPW.</p>
<p>We can incorporate these weights into a regression model. Note how we’re using <code>math_camp</code> as the only explanatory variable. Because we used matching to guess the likelihood of needing camp (and receiving the program), including the weights should be enough to close the “needs camp” back door:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">model_matched <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(final_grade <span style="color:#f92672">~</span> math_camp, data <span style="color:#f92672">=</span> math_camp_matched, weights <span style="color:#f92672">=</span> weights)
<span style="color:#a6e22e">tidy</span>(model_matched)

<span style="color:#75715e">## # A tibble: 2 x 5</span>
<span style="color:#75715e">##   term          estimate std.error statistic   p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;            &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)      134.      0.338     398.  0.       </span>
<span style="color:#75715e">## 2 math_campTRUE     10.0     0.407      24.7 7.68e-109</span>
</code></pre></div><p>And look at that! The coefficient for <code>math_campTRUE</code> is 10, which is what the true causal effect is.</p>
<p>Matching with Mahalanobis distance isn’t the only technique available—depending on the context of your actual data (and how complicated you want to get), you could use other algorithms like coarsened exact matching (CEM), optimal matching, or other techniques included in the <strong>MatchIt</strong> package.</p>
<p>One potential downside to matching is that it throws away data. Notice how there are only 1,184 rows in the <code>math_camp_matched</code> dataset, while using inverse probability weights let us use the full 2,000 rows in the original data.</p>
<h2 id="someday-when-im-smarter-do-calculus">Someday when I’m smarter: <em>do</em>-calculus</h2>
<p>Finally, Judea Pearl’s most important contribution to the world of causal inference is a <a href="https://plato.stanford.edu/entries/causal-models/do-calculus.html">complete set of three axioms</a> (or rules) that allow us to convert equations with a $do(\cdot)$ operator into something estimatable with observational data.</p>
<p><em>Very</em> briefly, the <em>do</em> operator lets us define interventions (like programs and policies) in mathematical formulas. For instance, in our ongoing example, we’re interested in $Pr(\text{Grade} | do(\text{Math camp}))$, or the probability distribution of final grades given that someone <em>does</em> math camp. Math camp is an intervention, and in a randomized controlled trial, we’d be able to control who got to <em>do</em> it, and thereby estimate the causal effect.</p>
<p>Given observational data, though, we’re left only with the ability to calculate $Pr(\text{Grade} | \text{Math camp})$, or the probability distribution of final grades given math camp. Because there’s no $do(\cdot)$ here, we can’t isolate the effect entirely if there are confounders like GRE and GPA. We tried that earlier in the “correlation isn’t causation” section and found an incorrect program effect.</p>
<p>The three rules of Pearl’s <em>do</em>-calculus allows us to chop up causal diagrams in systematic ways that can remove the $do(\cdot)$. The reason closing backdoors by adjusting for confounders works is because the approach follows one of the <em>do</em>-calculus rules that removes $do(\cdot)$ from $Pr(\text{Grade} | do(\text{Math camp}))$. For instance (and apologies for using X, Y, and Z instead of actual variables!), in a DAG with one confounder (Z)…</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">backdoor_dag <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dagify</span>(Y <span style="color:#f92672">~</span> X <span style="color:#f92672">+</span> Z,
                       X <span style="color:#f92672">~</span> Z,
                       exposure <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;X&#34;</span>,
                       outcome <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Y&#34;</span>,
                       coords <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>(x <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(X <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, Y <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>, Z <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>),
                                     y <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(X <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, Y <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, Z <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)))

<span style="color:#a6e22e">ggdag</span>(backdoor_dag) <span style="color:#f92672">+</span> 
  <span style="color:#a6e22e">theme_dag</span>()
</code></pre></div><p><img src="do-calculus-tiny-dag-1.png" alt="Tiny XYZ DAG"></p>
<p>…the <em>do</em>-calculus version of backdoor adjustment is:</p>
<p>$$
P(Y | do(X)) = \sum_Z P(Y | X, Z) \times P(Z)
$$</p>
<p>In other words, we can remove the $do(\cdot)$ if we multiply the probability distribution of Y given both X and Z by the probability distribution of Z, and then add all those values up for every value of Z. If X, Y, and Z were all binary, we’d be able to write the $do$-free version of the causal effect like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># P(y|do(x=1)) = P(y|x=1, z=1)*P(z=1) + P(y|x=1, z=0)*P(z=0)</span>
<span style="color:#a6e22e">mean</span>(y[x <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;</span> z <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>]) <span style="color:#f92672">*</span> <span style="color:#a6e22e">mean</span>(z <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span> <span style="color:#a6e22e">mean</span>(y[x <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span> <span style="color:#f92672">&amp;</span> z <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>]) <span style="color:#f92672">*</span> <span style="color:#a6e22e">mean</span>(z <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>)
</code></pre></div><p>There are fancy algorithms that can determine the exact adjustment formula for a given DAG, and the <strong>causaleffect</strong> package lets you use these algorithms in R. Here’s the <em>do</em>-calculus version of our math camp example. Unfortunately we have to rewrite the DAG with a different syntax for it to work:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(causaleffect)
<span style="color:#a6e22e">library</span>(igraph)

math_dag <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">graph.formula</span>(grade <span style="color:#f92672">+-</span> undergradGPA, 
                          grade <span style="color:#f92672">+-</span> GREquant, 
                          grade <span style="color:#f92672">+-</span> GREverbal,
                          grade <span style="color:#f92672">+-</span> mathcamp,
                          mathcamp <span style="color:#f92672">+-</span> GREquant,
                          mathcamp <span style="color:#f92672">+-</span> undergradGPA,
                          GREquant <span style="color:#f92672">+-</span> undergradGPA,
                          GREverbal <span style="color:#f92672">+-</span> undergradGPA,
                      simplify <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>)
<span style="color:#75715e"># plot(math_dag)  # Plot this</span>

<span style="color:#75715e"># expr returns a LaTeX formula; simp simplifies the formula through repeated</span>
<span style="color:#75715e"># application of the rules of do-calculus</span>
do_calc_formula <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">causal.effect</span>(y <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;grade&#34;</span>, x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mathcamp&#34;</span>,
                                 G <span style="color:#f92672">=</span> math_dag, expr <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>, simp <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)
</code></pre></div><p>This produces the following <em>do</em>-calculus-based adjustment formula:</p>
<div style="font-size: 60%;">
$$
\sum_{GREquant,undergradGPA}P(grade|undergradGPA,GREquant,mathcamp)P(GREquant|undergradGPA)P(undergradGPA)
$$
</div>
<p>Neat! We still need to adjust for GRE quantitative scores and undergrad GPA, and if we somehow multiply the three probability distributions (final grade given GPA, GRE, and mathcamp, GRE given GPA, and GPA), we’ll have a $do(\cdot)$-free version of the causal effect.</p>
<p><strong>Unfortunately I have absolutely no idea how to do this with R.</strong> Continuous variables blow up the math in <em>do</em>-calculus equations and I don&rsquo;t know how to deal with that.</p>
<h2 id="comparison-of-all-methods">Comparison of all methods</h2>
<p>Phew. We just used naive matching, inverse probability weighting, and Mahalanobis matching to estimate the causal effect of a hypothetical math camp program on final grades using only observational data. How’d we do?!</p>
<p>Here are all the estimates we have, along with a blue dotted line for the truth. Adjusting for backdoor confounders allows us to get far more accurate and identified causal results than when we leave things unadjusted, and we get the most accurate results when we explicitly attempt to match treated and untreated observations (as with do with the IPW ATO and with Mahalanobis matching). That’s likely not always the case—lots of these methods depend on the relationships between the different nodes in the graph, and it’s possible that they don’t work when there are non-linear relationships.</p>
<p>But in this case, at least, we can prove causation with observational data, which is really neat!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(ggstance)

all_models <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tribble</span>(
  <span style="color:#f92672">~</span>method, <span style="color:#f92672">~</span>model,
  <span style="color:#e6db74">&#34;Wrong correlation-not-causation&#34;</span>, model_wrong,
  <span style="color:#e6db74">&#34;Forbidden needs camp&#34;</span>, model_adj_needs_camp,
  <span style="color:#e6db74">&#34;Educated guess needs camp&#34;</span>, model_adj_needs_camp_guess,
  <span style="color:#e6db74">&#34;Inverse probability weighting ATE&#34;</span>, model_ipw_ate,
  <span style="color:#e6db74">&#34;Inverse probability weighting ATO&#34;</span>, model_ipw_ato,
  <span style="color:#e6db74">&#34;Mahalanobis matching&#34;</span>, model_matched
) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#75715e"># Extract coefficient for math_camp from each model</span>
  <span style="color:#a6e22e">mutate</span>(tidied <span style="color:#f92672">=</span> <span style="color:#a6e22e">map</span>(model, <span style="color:#f92672">~</span><span style="color:#a6e22e">tidy</span>(., conf.int <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)),
         effect <span style="color:#f92672">=</span> <span style="color:#a6e22e">map</span>(tidied, <span style="color:#f92672">~</span><span style="color:#a6e22e">filter</span>(., term <span style="color:#f92672">==</span> <span style="color:#e6db74">&#34;math_campTRUE&#34;</span>))) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">unnest</span>(effect) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">select</span>(<span style="color:#f92672">-</span>model, <span style="color:#f92672">-</span>tidied) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(method <span style="color:#f92672">=</span> <span style="color:#a6e22e">fct_inorder</span>(method))

<span style="color:#a6e22e">ggplot</span>(all_models, <span style="color:#a6e22e">aes</span>(x <span style="color:#f92672">=</span> estimate, y <span style="color:#f92672">=</span> <span style="color:#a6e22e">fct_rev</span>(method), color <span style="color:#f92672">=</span> method)) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_vline</span>(xintercept <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>, size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, linetype <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;dashed&#34;</span>, color <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;#0074D9&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">geom_pointrangeh</span>(<span style="color:#a6e22e">aes</span>(xmin <span style="color:#f92672">=</span> conf.low, xmax <span style="color:#f92672">=</span> conf.high), size <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">scale_color_viridis_d</span>(option <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;plasma&#34;</span>, end <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.9</span>, guide <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">labs</span>(x <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Causal effect&#34;</span>, y <span style="color:#f92672">=</span> <span style="color:#66d9ef">NULL</span>, caption <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Dotted line shows true effect&#34;</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_light</span>()
</code></pre></div><p><img src="compare-everything-1.png" alt="Comparison of all causal effects"></p>

    
        <footer>
            <div class="tags">
    <i class="fas fa-tags" aria-hidden="true"></i>&ensp;
    <a href="/blog/tags/r/">r</a>
    <span class="separator">•</span>
    <a href="/blog/tags/ggplot/">ggplot</a>
    <span class="separator">•</span>
    <a href="/blog/tags/tidyverse/">tidyverse</a>
    <span class="separator">•</span>
    <a href="/blog/tags/dags/">DAGs</a>
    <span class="separator">•</span>
    <a href="/blog/tags/causal-inference/">causal inference</a>
    <span class="separator">•</span>
    <a href="/blog/tags/do-calculus/">do calculus</a></div>

        </footer>

        <div id="comments">
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                 
                var disqus_shortname = 'andrewheisscom';
                var disqus_title = document.title;
                var disqus_url = 'https:\/\/www.shagunjhaver.com\/blog\/2020\/02\/25\/closing-backdoors-dags\/';

                 
                (function () {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
                    Disqus.</a></noscript>
        </div>
    </article>
</section>

  

<script src="/js/math-code.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js"></script>
<script>
    MathJax = {
        tex: {
            inlineMath: [
                ['$', '$'], ['\\(', '\\)']
            ],
            processEscapes: true,
            processEnvironments: true
        },
        options: {
            skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
        }
    };
</script>

        </div> 
    </div> 
    
    <div id="footer">
        <footer>
    <ul class="links">
        <li>
            <a href="mailto:shagun.jhaver@rutgers.edu" aria-label="E-mail"   >
                <i class="fa fa-envelope" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://medium.com/@shagunjhaver" aria-label="Medium"   >
                <i class="fab fa-medium" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://scholar.google.com/citations?user=OgtKT6UAAAAJ" aria-label="Google Scholar"   >
                <i class="ai ai-google-scholar" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://dl.acm.org/author_page.cfm?id=99658987207" aria-label="ACM Digital Library"   >
                <i class="ai ai-acmdl-square" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://github.com/shaguniitb" aria-label="GitHub"   >
                <i class="fab fa-github" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://twitter.com/shagunjhaver" aria-label="Twitter"   >
                <i class="fab fa-twitter" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://www.facebook.com/shagun.jhaver" aria-label="Facebook"   >
                <i class="fab fa-facebook" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://www.linkedin.com/in/shagun-jhaver/" aria-label="LinkedIn"   >
                <i class="fab fa-linkedin" aria-hidden="true"></i>
            </a>
        </li>
    </ul>

    <p class="colophon"> <i class="fas fa-map-marker-alt"></i> New Brunswick, NJ </p>
    <p class="colophon">ORCID iD: <a href="https://orcid.org/0000-0002-6728-7101">0000-0002-6728-7101</a></p>

   <p class="colophon">
    This site is a derivative of <a href="https://github.com/andrewheiss/ath-hugo">ath-hugo</a> by Andrew Heiss, used under CC <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">4.0</a>.
   </p>


    <p class="colophon"><a href="https://github.com/shaguniitb/ath-hugo">Code for site</a></p>
</footer>

    </div>

</body>

</html>

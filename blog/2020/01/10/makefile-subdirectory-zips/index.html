<!DOCTYPE html>
<html lang="en"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">

    <meta name="author" content="Shagun Jhaver">
    <meta name="description" content="Use a Makefile to automatically zip up all subdirectories in a given folder *while also* accounting for dependencies">
    <meta name="keywords" content="blogdown, r, rmarkdown, markdown, make">
    <meta name="generator" content="Hugo 0.88.1" />

    <title>
  Automatically zip up subdirectories with Make | Shagun Jhaver
</title>

    <link rel="canonical" href="https://www.shagunjhaver.com/blog/2020/01/10/makefile-subdirectory-zips/">
    <link rel="alternate" type="application/atom+xml" title="Blog Posts" href="https://www.shagunjhaver.com/atom.xml">
    <link rel="alternate" type="application/json" title="JSON Feed" href="https://www.shagunjhaver.com/feed.json">

    <link rel="openid2.provider" href="https://www.google.com/accounts/o8/ud?source=profiles">
    <link rel="openid2.local_id" href="https://www.google.com/profiles/andrewheiss">

    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://www.shagunjhaver.com/blog/2020/01/10/makefile-subdirectory-zips/makefile-subdirectory-zips.png"/>
    <meta name="twitter:site" content="@shagunjhaver"/>
    <meta name="twitter:title" content="Automatically zip up subdirectories with Make"/>
    <meta name="twitter:creator" content="@shagunjhaver"/>
    <meta name="twitter:description" content="Use a Makefile to automatically zip up all subdirectories in a given folder *while also* accounting for dependencies"/>


    <meta property="og:title" content="Automatically zip up subdirectories with Make" />
<meta property="og:description" content="Use a Makefile to automatically zip up all subdirectories in a given folder *while also* accounting for dependencies" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.shagunjhaver.com/blog/2020/01/10/makefile-subdirectory-zips/" />
<meta property="og:image" content="https://www.shagunjhaver.com/blog/2020/01/10/makefile-subdirectory-zips/makefile-subdirectory-zips.png" />
<meta property="article:published_time" content="2020-01-10T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-01-10T00:00:00+00:00" />

<meta property="article:author" content="https://www.facebook.com/shagun.jhaver" />
<meta property="article:publisher" content="https://www.facebook.com/shagun.jhaver" />
<meta property="article:section" content="blog" />
<meta property="article:tag" content="blogdown" />
<meta property="article:tag" content="r" />
<meta property="article:tag" content="rmarkdown" />
<meta property="article:tag" content="markdown" />
<meta property="article:tag" content="make" />


    <meta itemprop="name" content="Automatically zip up subdirectories with Make">
<meta itemprop="description" content="Use a Makefile to automatically zip up all subdirectories in a given folder *while also* accounting for dependencies"><meta itemprop="datePublished" content="2020-01-10T00:00:00+00:00" />
<meta itemprop="dateModified" content="2020-01-10T00:00:00+00:00" />
<meta itemprop="wordCount" content="2616"><meta itemprop="image" content="https://www.shagunjhaver.com/blog/2020/01/10/makefile-subdirectory-zips/makefile-subdirectory-zips.png">
<meta itemprop="keywords" content="blogdown,r,rmarkdown,markdown,make," />

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/pure-and-grids-responsive.min.css">
    <link rel="stylesheet" href="/css/ath-hugo.min.8bd4ca9cfb65245be6d4d5e8c998e1ac3888ce29fb6de24c81ee5129485d89e3.css" integrity="sha256-i9TKnPtlJFvm1NXoyZjhrDiIzin7beJMge5RKUhdieM=" crossorigin="anonymous" media="screen" />

    <script src="https://kit.fontawesome.com/f9d343c40d.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">    

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=dLX2MbQJLG">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=dLX2MbQJLG">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=dLX2MbQJLG">
    <link rel="manifest" href="/site.webmanifest?v=dLX2MbQJLG">
    <link rel="mask-icon" href="/safari-pinned-tab.svg?v=dLX2MbQJLG" color="#cf4446">
    <link rel="shortcut icon" href="/favicon.ico?v=dLX2MbQJLG">
    <meta name="msapplication-TileColor" content="#170c3a">
    <meta name="theme-color" content="#170c3a">

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-527449-5', 'auto');
      ga('send', 'pageview');
    </script>
</head>

<body>

    <div id="layout" class="pure-g">
        <div id="sidebar" class="pure-u-1 pure-u-md-1-4">
            <header>
                <h1 class="title"><a href="/">Shagun Jhaver</a></h1>
                <h2 class="minibio">Social computing, CSCW, HCI, content moderation, and online harassment</h2>

                <nav id="main-nav">
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a class="nav-link" href="/">About</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/cv/">CV</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/research/">Research</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/teaching/">Teaching</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/news/">News</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/now/">Now</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/work-with-me/">Work with me!</a>
                        </li>
                    </ul>
                </nav>
            </header>

        </div> 
    
        <div id="content" class="pure-u-1 pure-u-md-3-4">
        
  <section>
    <article class="content-single">
        <header class="post-header">
            <h1 class="post-title">Automatically zip up subdirectories with Make</h1>

            <div class="post-meta pure-g">
                <div class="pure-u-1-2">
                    <span class="posted-on">
                        <i class="far fa-calendar-alt" aria-hidden="true"></i>
                        <time datetime='2020-01-10T00:00:00Z'>
                            Friday, January 10, 2020
                        </time>
                    </span>
                </div>
                <div class="reading-time pure-u-1-2">
                    <i class="far fa-clock" aria-hidden="true"></i>
                    13-minute read
                </div>
            </div>
        </header>
    
        <p><a href="https://github.com/andrewheiss/makefile-subdirectory-zips">See this notebook on GitHub</a>. You can (and should) download the project from there if you want to follow along and try this out.</p>
<hr>
<p><a href="#tldr-final-makefile">tl;dr: Skip to the completed example.</a></p>
<hr>
<p>I use <a href="https://bookdown.org/yihui/blogdown"><strong>blogdown</strong></a> to generate the websites for <a href="https://www.andrewheiss.com/teaching/">all the courses I teach</a>, and it’s delightful to not have to worry about databases and server configurations. I use a <a href="https://www.gnu.org/software/make/"><code>Makefile</code></a> to run the requisite commands with <code>make deploy</code>, which creates a magical incantation: R, <a href="https://bookdown.org/yihui/blogdown"><strong>blogdown</strong></a>, and <a href="https://gohugo.io/">Hugo</a> parse <a href="https://rmarkdown.rstudio.com/">R Markdown</a> files and generate a complete HTML site, which then gets synced <a href="https://evalsp20.classes.andrewheiss.com/">to my server</a>, all with minimal input from me.</p>
<p>There are occasional points of friction, though. One that I’ve suffered through for the past few years is the creation and distribution of zipped files. I teach students R, and R projects rarely consist of a single file. To make it easier to distribute problem sets and projects to students, I zip these subfolders into single files like <code>problem_set_1.zip</code>, so they just have to download one thing. Creating <code>.zip</code> files on macOS is trivial—right click on a folder, choose “Compress {foldername}”, and you’re done.</p>
<p>But it’s tedious when you have lots of folders to zip, and even more tedious to remember to rezip folders where you’ve made changes. SO MANY TIMES I’ve fixed errors in R scripts or data but then have forgotten to rezip the project, and students end up downloading the uncorrected version of projects. Moreover, macOS includes hidden <code>.DS_Store</code> files when it zips up folders, and R and RStudio create their own invisible files and folders, like <code>.Rhistory</code> and <code>.Rproj.user/</code>. To avoid shipping these out to students, I typically go to the terminal, manually delete the unwanted invisible files, and <em>then</em> zip up the directory. But once again, I regularly forget to do this and end up including unwanted files.</p>
<p>I figured that since I’m already using a <code>Makefile</code> to generate and upload the course website, I’d try to use the magical power of Make to automatically zip up project folders as I build the site <em>and</em> update them only if there are any changes. And it turns out that it’s possible, though the end result looks really cryptic (as do all <code>Makefiles</code>, really).</p>
<p>What follows here is a step-by-step didactic explanation of how I built a set of <code>Makefile</code> recipes to automatically zip up all the directories within a given directory, excluding invisible files (i.e. any file or directory that begins with a <code>.</code>), and only zipping up directories that have been modified since the last time Make was run. <a href="#tldr-final-makefile">You can also skip to the end to see the finished <code>Makefile</code>.</a></p>
<h2 id="folder-structure">Folder structure</h2>
<p>The example here assumes the project subdirectories live in a folder called <code>static/projects/</code>, since that mimics <strong>blogdown</strong>/Hugo (any files in the <code>static/</code> directory do not get processed by knitr when you build the site). Here’s the example folder structure with three problem set projects:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">static
└── projects
    ├── problem_set_1
    │   ├── data
    │   │   └── stuff.csv
    │   ├── problem_set_1.Rproj
    │   └── work.Rmd
    ├── problem_set_2
    │   ├── data
    │   │   └── other_stuff.csv
    │   ├── problem_set_2.Rproj
    │   └── work.Rmd
    └── problem_set_3
        ├── code.R
        ├── data
        │   └── more_stuff.csv
        ├── problem_set_3.Rproj
        └── work.Rmd
</code></pre></div><p>In the end, what I want is something like this, with <code>.zip</code> files for each of the problem set folders (starred):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">static
└── projects
    ├── problem_set_1
    │   ├── data
    │   │   └── stuff.csv
    │   ├── problem_set_1.Rproj
    │   └── work.Rmd
    ├── ⭐️ problem_set_1.zip
    ├── problem_set_2
    │   ├── data
    │   │   └── other_stuff.csv
    │   ├── problem_set_2.Rproj
    │   └── work.Rmd
    ├── ⭐️ problem_set_2.zip
    ├── problem_set_3
    │   ├── code.R
    │   ├── data
    │   │   └── more_stuff.csv
    │   ├── problem_set_3.Rproj
    │   └── work.Rmd
    └── ⭐️ problem_set_3.zip
</code></pre></div><h2 id="basic-approach">Basic approach</h2>
<p>The basic syntax for <code>Makefile</code> recipes is fairly simple:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#a6e22e">file_to_create</span><span style="color:#f92672">:</span> dependencies
    stuff to run to create file using dependencies
</code></pre></div><p>If I want to create a zipped file of one problem set project, I can add this to a file named <code>Makefile</code> (no extension), and then run <code>make static/projects/problem_set_1.zip</code> from the terminal:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#a6e22e">static/projects/problem_set_1.zip</span><span style="color:#f92672">:</span>
    zip -r static/projects/problem_set_1.zip static/projects/problem_set_1
</code></pre></div><p>The <code>-r</code> flag means that all subdirectories in <code>static/projects/problem_set_1</code> will be included. If I type <code>make static/projects/problem_set_1.zip</code> from the terminal, it should compress the folder and all its subfolders into a single <code>.zip</code> file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">&gt; make static/projects/problem_set_1.zip

zip -r static/projects/problem_set_1.zip static/projects/problem_set_1
  adding: static/projects/problem_set_1/ (stored 0%)
  adding: static/projects/problem_set_1/work.Rmd (stored 0%)
  adding: static/projects/problem_set_1/.DS_Store (deflated 97%)
  adding: static/projects/problem_set_1/problem_set_1.Rproj (deflated 28%)
  adding: static/projects/problem_set_1/data/ (stored 0%)
  adding: static/projects/problem_set_1/data/stuff.csv (stored 0%)
</code></pre></div><h2 id="problems-with-the-basic-approach">Problems with the basic approach</h2>
<p>However, there are a few issues:</p>
<ol>
<li>If I run this again, <code>zip</code> will add files to the <code>.zip</code>. If any were deleted from the actual folder, they’ll stay inside the <code>.zip</code> file (i.e. the folder and the <code>.zip</code> file won’t be synchronized).</li>
<li>This will include files and folders that begin with <code>.</code> (like <code>.Rhistory</code> and <code>.Rproj.user/</code>), and I don’t want those.</li>
<li>The command will include all the parent folders in the zipped file. After I extract it, the actual files will be nested inside <code>static/projects/</code>.</li>
<li>There are no dependencies, so this will happen every time I run <code>make static/projects/problem_set_1.zip</code>, even if nothing changed.</li>
<li>This is for a single target only. In theory, I’d need to manually add separate entries for each folder in <code>static/projects</code>, and that’s tedious.</li>
</ol>
<h2 id="tweaking-the-zip-recipe">Tweaking the <code>zip</code> recipe</h2>
<p>We can fix the first two issues with some adjustments to the <code>zip</code> command. Adding the <code>-FS</code> flag (<em>f</em>ile <em>s</em>ync) will ensure that <code>zip</code> syncs the files between the source directory and the zipped files, and including the <code>-x</code> flag allows us to exclude patterns of files from the zipped file. Doing this will both sync files and exclude files/folders with a <code>.</code> prefix:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#a6e22e">static/projects/problem_set_1.zip</span><span style="color:#f92672">:</span>
    zip -FSr static/projects/problem_set_1.zip static/projects/problem_set_1 -x static/projects/problem_set_1/.<span style="color:#ae81ff">\*</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">&gt; make static/projects/problem_set_1.zip

zip -FSr static/projects/problem_set_1.zip static/projects/problem_set_1 -x static/projects/problem_set_1/.\*
  adding: static/projects/problem_set_1/ (stored 0%)
  adding: static/projects/problem_set_1/work.Rmd (stored 0%)
  adding: static/projects/problem_set_1/problem_set_1.Rproj (deflated 28%)
  adding: static/projects/problem_set_1/data/ (stored 0%)
  adding: static/projects/problem_set_1/data/stuff.csv (stored 0%)
</code></pre></div><p>The third issue with parent folders can’t be solved directly with <code>zip</code>. The problem occurs because we’re running <code>make</code> from the root of the project, so it’s including the whole nested file structure. To solve this, we can have <code>make</code> navigate to <code>static/projects</code> before zipping anything, which then simplifies the filenames in the command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#a6e22e">static/projects/problem_set_1.zip</span><span style="color:#f92672">:</span>
    cd static/projects <span style="color:#f92672">&amp;&amp;</span> zip -FSr problem_set_1.zip problem_set_1 -x problem_set_1/.<span style="color:#ae81ff">\*</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">&gt; make static/projects/problem_set_1.zip

cd static/projects &amp;&amp; zip -FSr problem_set_1.zip problem_set_1 -x problem_set_1/.\*
  adding: problem_set_1/ (stored 0%)
  adding: problem_set_1/work.Rmd (stored 0%)
  adding: problem_set_1/problem_set_1.Rproj (deflated 28%)
  adding: problem_set_1/data/ (stored 0%)
  adding: problem_set_1/data/stuff.csv (stored 0%)
</code></pre></div><p>No more nested parent folders!</p>
<h2 id="adding-dependencies">Adding dependencies</h2>
<p>Right now, there are no dependencies, which means that <code>make</code> will run <code>zip</code> regardless of whether it needs to. Even if nothing is changed in the <code>problem_set_1</code> folder, a new <code>.zip</code> file will get created (and it’ll get reuploaded to the server because it’ll have a new creation date, which means there will be a lot of unnecessary uploading of potentially large files).</p>
<p>Normally, we’d have to define dependencies like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#a6e22e">static/projects/problem_set_1.zip</span><span style="color:#f92672">:</span> {DEPENDENT FILES}
    cd static/projects <span style="color:#f92672">&amp;&amp;</span> zip -FSr problem_set_1.zip problem_set_1 -x problem_set_1/.<span style="color:#ae81ff">\*</span>
</code></pre></div><p>There’s no way to use a folder as a dependency, which means we need to list all the possible files in the project:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#a6e22e">static/projects/problem_set_1.zip</span><span style="color:#f92672">:</span> static/projects/problem_set_1/work.Rmd static/projects/problem_set_1/problem_set_1.Rproj static/projects/problem_set_1/data/stuff.csv
    cd static/projects <span style="color:#f92672">&amp;&amp;</span> zip -FSr problem_set_1.zip problem_set_1 -x problem_set_1/.<span style="color:#ae81ff">\*</span>
</code></pre></div><p>And that’s horrifically long and awful.</p>
<p>Instead of manually typing out all the dependencies, we can use a little <code>bash</code> trick to get a list of all the files in the folder and generate the list of dependencies using <a href="https://www.gnu.org/software/make/manual/html_node/Shell-Function.html"><code>$(shell ...)</code></a>. To see this in action more easily, it’s helpful to assign this shell command to a variable and create a new temporary target to show it</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make">FILES_IN_FOLDER <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>shell find static/projects/problem_set_1 -type f<span style="color:#66d9ef">)</span>

<span style="color:#a6e22e">debug</span><span style="color:#f92672">:</span>
    @echo <span style="color:#66d9ef">$(</span>FILES_IN_FOLDER<span style="color:#66d9ef">)</span>
</code></pre></div><p>Now if you run <code>make debug</code>, you should see a list of all the files in the given folder (since that list was stored as <code>FILES_IN_FOLDER</code>; the <code>@</code> in front of <code>echo</code> suppresses the actual call to <code>echo</code>, so you should just see the output of the command).</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">&gt; make debug

static/projects/problem_set_1/work.Rmd static/projects/problem_set_1/.DS_Store static/projects/problem_set_1/problem_set_1.Rproj static/projects/problem_set_1/data/stuff.csv
</code></pre></div><p>You might see that it found invisible files like <code>static/projects/problem_set_1/.DS_Store</code>. We don’t want to include those as dependencies (especially files in <code>.Rproj.user</code>, since those get modified every time you do anything in RStudio), so we can modify the <code>find</code> command to exclude files that start with <code>.</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make">FILES_IN_FOLDER <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>shell find static/projects/problem_set_1 -type f ! -path <span style="color:#e6db74">&#34;static/projects/problem_set_1/.*&#34;</span><span style="color:#66d9ef">)</span>

<span style="color:#a6e22e">debug</span><span style="color:#f92672">:</span>
    @echo <span style="color:#66d9ef">$(</span>FILES_IN_FOLDER<span style="color:#66d9ef">)</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">&gt; make debug

static/projects/problem_set_1/work.Rmd static/projects/problem_set_1/problem_set_1.Rproj static/projects/problem_set_1/data/stuff.csv
</code></pre></div><p>With that <code>$(shell ...)</code> magic working, we can include it in the recipe as a dependency:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#a6e22e">static/projects/problem_set_1.zip</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">$(</span>shell find static/projects/problem_set_1 -type f ! -path &#34;static/projects/problem_set_1/.*&#34;<span style="color:#66d9ef">)</span>
    cd static/projects <span style="color:#f92672">&amp;&amp;</span> zip -FSr problem_set_1.zip problem_set_1 -x problem_set_1/.<span style="color:#ae81ff">\*</span>
</code></pre></div><p>HOWEVER, this still won’t quite work. Put simply (and likely incorrectly, but it makes sense) <code>make</code> expands <code>$()</code> variables after it determines dependency rules, so it will treat <code>$(shell ...)</code> like an actual dependency instead of treating the <em>output</em> of <code>$(shell ...)</code> as dependencies. To get around this, we can enable <a href="http://www.gnu.org/software/make/manual/make.html#Secondary-Expansion">secondary expansion</a> (<a href="https://stackoverflow.com/a/21950971/120898">see also</a>), which delays the creation of dependency rules until after <code>$(shell ...)</code> is run. To enable it, include <code>.SECONDEXPANSION:</code> somewhere and then use <code>$$()</code> instead of <code>$()</code> when expanding variables:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#a6e22e">.SECONDEXPANSION</span><span style="color:#f92672">:</span>

<span style="color:#a6e22e">static/projects/problem_set_1.zip</span><span style="color:#f92672">:</span> $<span style="color:#66d9ef">$(</span>shell find static/projects/problem_set_1 -type f ! -path &#34;static/projects/problem_set_1/.*&#34;<span style="color:#66d9ef">)</span>
    cd static/projects <span style="color:#f92672">&amp;&amp;</span> zip -FSr problem_set_1.zip problem_set_1 -x problem_set_1/.<span style="color:#ae81ff">\*</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">&gt; make static/projects/problem_set_1.zip

cd static/projects &amp;&amp; zip -FSr problem_set_1.zip problem_set_1 -x problem_set_1/.\*
  adding: problem_set_1/ (stored 0%)
  adding: problem_set_1/work.Rmd (stored 0%)
  adding: problem_set_1/problem_set_1.Rproj (deflated 28%)
  adding: problem_set_1/data/ (stored 0%)
  adding: problem_set_1/data/stuff.csv (stored 0%)
</code></pre></div><p>Phew. Now all the non-invisible files inside <code>problem_set_1/</code> are dependencies. If I run it again without changing anything, nothing should get zipped:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">&gt; make static/projects/problem_set_1.zip

make: `static/projects/problem_set_1.zip&#39; is up to date.
</code></pre></div><h2 id="automatic-variables">Automatic variables</h2>
<p>Everything’s working great so far! We’ve addressed <a href="#problems-with-the-basic-approach">the first 4 of the 5 issues we found before</a>. The only thing we have left is automating this so we don’t have to make another target recipe for <code>static/projects/problem_set_2.zip</code> and <code>static/projects/problem_set_3.zip</code> and so on. In the end, we want to be able to type <code>make zip_projects</code> and have <code>make</code> compress each of the subfolders automatically, based on changes in dependencies. To do this, we can use <a href="http://www.gnu.org/software/make/manual/html_node/Automatic-Variables.html">automatic variables</a> (<a href="https://stackoverflow.com/a/3220288/120898">see also</a>) to generate targets on the fly. Here’s how we do this.</p>
<p>First, we can generate a list of all the subdirectories we want to compress, and then modify that list so that it becomes a list of all the targets we want to create (i.e. <code>problem_set_1.zip</code>, <code>problem_set_2.zip</code>, and so on). We’ll use some built-in <code>make</code> functions for manipulating text and searching for files to create some variables. Again, it’s easiest to see what these variables actually are if you create a temporary target like debug. Check the documentation for <a href="https://www.gnu.org/software/make/manual/html_node/Text-Functions.html"><code>$(filter ...)</code></a>, <a href="https://www.gnu.org/software/make/manual/html_node/File-Name-Functions.html"><code>$(wildcard ...)</code></a>, <a href="https://www.gnu.org/software/make/manual/html_node/Text-Functions.html"><code>$(patsubst ...)</code></a>, and <a href="https://www.gnu.org/software/make/manual/html_node/File-Name-Functions.html"><code>$(addsuffix ...)</code></a> for more details about what these functions do.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make">TO_ZIP_DIRS <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>filter %/, <span style="color:#66d9ef">$(</span>wildcard static/projects/*/<span style="color:#66d9ef">))</span>  <span style="color:#75715e"># Find all directories in static/projects</span>
TO_ZIP_NAMES <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>patsubst %/,%,<span style="color:#66d9ef">$(</span>TO_ZIP_DIRS<span style="color:#66d9ef">))</span>  <span style="color:#75715e"># Remove trailing /</span>
ZIP_TARGETS <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>addsuffix .zip,<span style="color:#66d9ef">$(</span>TO_ZIP_NAMES<span style="color:#66d9ef">))</span>  <span style="color:#75715e"># Add .zip</span>

<span style="color:#a6e22e">debug</span><span style="color:#f92672">:</span>
    @echo <span style="color:#66d9ef">$(</span>TO_ZIP_DIRS<span style="color:#66d9ef">)</span>
    @echo <span style="color:#66d9ef">$(</span>TO_ZIP_NAMES<span style="color:#66d9ef">)</span>
    @echo <span style="color:#66d9ef">$(</span>ZIP_TARGETS<span style="color:#66d9ef">)</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">&gt; make debug

static/projects/problem_set_1/ static/projects/problem_set_2/ static/projects/problem_set_3/
static/projects/problem_set_1 static/projects/problem_set_2 static/projects/problem_set_3
static/projects/problem_set_1.zip static/projects/problem_set_2.zip static/projects/problem_set_3.zip
</code></pre></div><p>Neat. <code>$(ZIP_TARGETS)</code> now has a list of zipped files that we want to create. We can use that list as an actual target in a recipe. For now, we’ll just use <code>echo</code> so we can see what’s going on with the variable names. Note how I created a new target called <code>zip_projects</code>—this is what we’ll actually run in the terminal. It will look at the list in <code>$(ZIP_TARGETS)</code> and run the appropriate recipe for each one (which for now means it’ll just print the name of the file). Also notice the <code>$@</code>. This represents the name of the target that is passed to the recipe. Run <code>make zip_projects</code> and you should see a list of future filenames:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#a6e22e">$(ZIP_TARGETS)</span><span style="color:#f92672">:</span>
    @echo $@

<span style="color:#a6e22e">zip_projects</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">$(</span>ZIP_TARGETS<span style="color:#66d9ef">)</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">&gt; make zip_projects

static/projects/problem_set_1.zip
static/projects/problem_set_2.zip
static/projects/problem_set_3.zip
</code></pre></div><p>Next we need to modify the big hairy <code>cd static/projects &amp;&amp; zip -FSr problem_set_1.zip problem_set_1 -x problem_set_1/.\*</code> command to use the automatic names in <code>$(ZIP_TARGETS)</code>. We have access to the full target name (<code>static/projects/problem_set_1.zip</code>) as the special <code>$@</code> variable. We can use other built-in functions to extract pieces of that string. Specifically, we need these things:</p>
<ul>
<li><code>static/projects</code>, or the level below the base name of the future <code>.zip</code> file</li>
<li><code>problem_set_1.zip</code>, or the parent-directory-less name of the future <code>.zip</code> file</li>
<li><code>problem_set_1</code>, or the parent-directory-less and extension-less name of the future <code>.zip</code> file</li>
</ul>
<p>We can extract each of those with different <a href="https://www.gnu.org/software/make/manual/html_node/File-Name-Functions.html">file name functions</a>:</p>
<ul>
<li><code>$(basename $@)</code> will lead to <code>static/projects/problem_set_1</code>. We can navigate to this folder with <code>cd</code> and then move back a level with <code>..</code> to get <code>static/projects</code></li>
<li><code>$(notdir $@)</code> will lead to <code>problem_set_1.zip</code></li>
<li><code>$(notdir $(basename $@))</code> will lead to <code>problem_set_1</code></li>
</ul>
<p>You can check all these by adding them to the recipe temporarily:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#a6e22e">$(ZIP_TARGETS)</span><span style="color:#f92672">:</span>
    @echo $@
    @echo <span style="color:#66d9ef">$(</span>basename $@<span style="color:#66d9ef">)</span>
    @echo <span style="color:#66d9ef">$(</span>notdir $@<span style="color:#66d9ef">)</span>
    @echo <span style="color:#66d9ef">$(</span>notdir <span style="color:#66d9ef">$(</span>basename $@<span style="color:#66d9ef">))</span>

<span style="color:#a6e22e">zip_projects</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">$(</span>ZIP_TARGETS<span style="color:#66d9ef">)</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">&gt; make zip_projects

static/projects/problem_set_1.zip
static/projects/problem_set_1
problem_set_1.zip
problem_set_1
static/projects/problem_set_2.zip
static/projects/problem_set_2
problem_set_2.zip
problem_set_2
static/projects/problem_set_3.zip
static/projects/problem_set_3
problem_set_3.zip
problem_set_3
</code></pre></div><p>With all those pieces of filenames, we can replace the hardcoded values of our hairy <code>zip</code> command with automatic versions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#a6e22e">$(ZIP_TARGETS)</span><span style="color:#f92672">:</span>
    cd <span style="color:#66d9ef">$(</span>basename $@<span style="color:#66d9ef">)</span>/.. <span style="color:#f92672">&amp;&amp;</span> zip -FSr <span style="color:#66d9ef">$(</span>notdir $@<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>notdir <span style="color:#66d9ef">$(</span>basename $*<span style="color:#66d9ef">))</span> -x <span style="color:#66d9ef">$(</span>notdir <span style="color:#66d9ef">$(</span>basename $*<span style="color:#66d9ef">))</span>/.<span style="color:#ae81ff">\*</span>
</code></pre></div><div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">&gt; make zip_projects

cd static/projects/problem_set_1/.. &amp;&amp; zip -FSr problem_set_1.zip problem_set_1 -x problem_set_1/.\*
  adding: problem_set_1/ (stored 0%)
  adding: problem_set_1/work.Rmd (stored 0%)
  adding: problem_set_1/problem_set_1.Rproj (deflated 28%)
  adding: problem_set_1/data/ (stored 0%)
  adding: problem_set_1/data/stuff.csv (stored 0%)
cd static/projects/problem_set_2/.. &amp;&amp; zip -FSr problem_set_2.zip problem_set_2 -x problem_set_2/.\*
  adding: problem_set_2/ (stored 0%)
  adding: problem_set_2/work.Rmd (stored 0%)
  adding: problem_set_2/problem_set_2.Rproj (deflated 28%)
  adding: problem_set_2/data/ (stored 0%)
  adding: problem_set_2/data/other_stuff.csv (stored 0%)
cd static/projects/problem_set_3/.. &amp;&amp; zip -FSr problem_set_3.zip problem_set_3 -x problem_set_3/.\*
  adding: problem_set_3/ (stored 0%)
  adding: problem_set_3/work.Rmd (stored 0%)
  adding: problem_set_3/code.R (stored 0%)
  adding: problem_set_3/problem_set_3.Rproj (deflated 28%)
  adding: problem_set_3/data/ (stored 0%)
  adding: problem_set_3/data/more_stuff.csv (stored 0%)
</code></pre></div><p>Holy moly! It zipped each individual folder! We’re almost done! The only thing we’re missing is dependencies—right now, if we run this again, it’ll rezip everything again, which we don’t want. We need to add our <code>$$(shell ..)</code> incantation as a dependency, but we need to make it specific to each target: i.e. it needs to generate a list of dependent files for each of the future zip files (only the contents of <code>problem_set_1</code> when making <code>problem_set_1.zip</code>, etc.). To make that work, we can use a <code>%</code> wildcard in the dependency definition:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make"><span style="color:#a6e22e">$(ZIP_TARGETS)</span><span style="color:#f92672">:</span> %.zip : $<span style="color:#66d9ef">$(</span>shell find % -type f ! -path &#34;%/.*&#34;<span style="color:#66d9ef">)</span>
    cd <span style="color:#66d9ef">$(</span>basename $@<span style="color:#66d9ef">)</span>/.. <span style="color:#f92672">&amp;&amp;</span> zip -FSr <span style="color:#66d9ef">$(</span>notdir $@<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>notdir <span style="color:#66d9ef">$(</span>basename $@<span style="color:#66d9ef">))</span> -x <span style="color:#66d9ef">$(</span>notdir <span style="color:#66d9ef">$(</span>basename $@<span style="color:#66d9ef">))</span>/.<span style="color:#ae81ff">\*</span>
</code></pre></div><p>If we manually delete any zipped files and run <code>make zip_projects</code>, it’ll generate them as expected. Where this is magical, though, is if I edit one of the files (like <code>word.Rmd</code> in <code>problem_set_1</code>) and then rerun <code>make zip_projects</code>, it will <em>only</em> rezip that project:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">&gt; make zip_projects

cd static/projects/problem_set_1/.. &amp;&amp; zip -FSr problem_set_1.zip problem_set_1 -x problem_set_1/.\*
updating: problem_set_1/work.Rmd (stored 0%)
</code></pre></div><p>And that’s it! We’re done!</p>
<p>The final recipe is <em>extraordinarily</em> cryptic, but because we built it up slowly, we should know what each of the pieces (<code>$@</code>, <code>%</code>, <code>$(ZIP_TARGETS)</code>, <code>$(basename $@)</code>, etc.) are.</p>
<h3 id="tldr-final-makefile">tl;dr final <code>Makefile</code></h3>
<p>Here’s the complete final <code>Makefile</code> without all the intermediate steps:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-make" data-lang="make">TO_ZIP_DIRS <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>filter %/, <span style="color:#66d9ef">$(</span>wildcard static/projects/*/<span style="color:#66d9ef">))</span>  <span style="color:#75715e"># Find all directories in static/projects</span>
TO_ZIP_NAMES <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>patsubst %/,%,<span style="color:#66d9ef">$(</span>TO_ZIP_DIRS<span style="color:#66d9ef">))</span>  <span style="color:#75715e"># Remove trailing /</span>
ZIP_TARGETS <span style="color:#f92672">=</span> <span style="color:#66d9ef">$(</span>addsuffix .zip,<span style="color:#66d9ef">$(</span>TO_ZIP_NAMES<span style="color:#66d9ef">))</span>  <span style="color:#75715e"># Add .zip</span>

<span style="color:#a6e22e">.SECONDEXPANSION</span><span style="color:#f92672">:</span>

<span style="color:#a6e22e">$(ZIP_TARGETS)</span><span style="color:#f92672">:</span> %.zip : $<span style="color:#66d9ef">$(</span>shell find % -type f ! -path &#34;%/.*&#34;<span style="color:#66d9ef">)</span>
    cd <span style="color:#66d9ef">$(</span>basename $@<span style="color:#66d9ef">)</span>/.. <span style="color:#f92672">&amp;&amp;</span> zip -FSr <span style="color:#66d9ef">$(</span>notdir $@<span style="color:#66d9ef">)</span> <span style="color:#66d9ef">$(</span>notdir <span style="color:#66d9ef">$(</span>basename $@<span style="color:#66d9ef">))</span> -x <span style="color:#66d9ef">$(</span>notdir <span style="color:#66d9ef">$(</span>basename $@<span style="color:#66d9ef">))</span>/.<span style="color:#ae81ff">\*</span>

<span style="color:#a6e22e">zip_projects</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">$(</span>ZIP_TARGETS<span style="color:#66d9ef">)</span>
</code></pre></div><p>You can incorporate this into any other <code>Makefile</code>, <a href="https://github.com/andrewheiss/evalsp20.classes.andrewheiss.com/blob/master/Makefile">like this one that I use for building a course website</a>. There, the <code>zip_projects</code> target is a dependency of the <code>build</code> target, so I just have to run <code>make build</code> to automatically zip everything up <em>and</em> build the site with <strong>blogdown</strong>.</p>
<p>Perfection. Any subfolder in <code>static/projects/</code> will automatically be zipped up with no input from me. No more accidentally forgetting to zip up things or include invisible files!</p>

    
        <footer>
            <div class="tags">
    <i class="fas fa-tags" aria-hidden="true"></i>&ensp;
    <a href="/blog/tags/blogdown/">blogdown</a>
    <span class="separator">•</span>
    <a href="/blog/tags/r/">r</a>
    <span class="separator">•</span>
    <a href="/blog/tags/rmarkdown/">rmarkdown</a>
    <span class="separator">•</span>
    <a href="/blog/tags/markdown/">markdown</a>
    <span class="separator">•</span>
    <a href="/blog/tags/make/">make</a></div>

        </footer>

        <div id="comments">
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                 
                var disqus_shortname = 'andrewheisscom';
                var disqus_title = document.title;
                var disqus_url = 'https:\/\/www.shagunjhaver.com\/blog\/2020\/01\/10\/makefile-subdirectory-zips\/';

                 
                (function () {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
                    Disqus.</a></noscript>
        </div>
    </article>
</section>

  

        </div> 
    </div> 
    
    <div id="footer">
        <footer>
    <ul class="links">
        <li>
            <a href="mailto:shagun.jhaver@rutgers.edu" aria-label="E-mail"   >
                <i class="fa fa-envelope" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://medium.com/@shagunjhaver" aria-label="Medium"   >
                <i class="fab fa-medium" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://scholar.google.com/citations?user=OgtKT6UAAAAJ" aria-label="Google Scholar"   >
                <i class="ai ai-google-scholar" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://dl.acm.org/author_page.cfm?id=99658987207" aria-label="ACM Digital Library"   >
                <i class="ai ai-acmdl-square" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://github.com/shaguniitb" aria-label="GitHub"   >
                <i class="fab fa-github" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://twitter.com/shagunjhaver" aria-label="Twitter"   >
                <i class="fab fa-twitter" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://www.facebook.com/shagun.jhaver" aria-label="Facebook"   >
                <i class="fab fa-facebook" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://www.linkedin.com/in/shagun-jhaver/" aria-label="LinkedIn"   >
                <i class="fab fa-linkedin" aria-hidden="true"></i>
            </a>
        </li>
    </ul>

    <p class="colophon"> <i class="fas fa-map-marker-alt"></i> New Brunswick, NJ </p>
    <p class="colophon">ORCID iD: <a href="https://orcid.org/0000-0002-6728-7101">0000-0002-6728-7101</a></p>

   <p class="colophon">
    This site is a derivative of <a href="https://github.com/andrewheiss/ath-hugo">ath-hugo</a> by Andrew Heiss, used under CC <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">4.0</a>.
   </p>


    <p class="colophon"><a href="https://github.com/shaguniitb/ath-hugo">Code for site</a></p>
</footer>

    </div>

</body>

</html>

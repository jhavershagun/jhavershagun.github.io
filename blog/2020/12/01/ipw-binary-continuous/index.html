<!DOCTYPE html>
<html lang="en"
      xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Language" content="en">

    <meta name="author" content="Shagun Jhaver">
    <meta name="description" content="Use R to close backdoor confounding by generating and using inverse probability weights for both binary and continuous treatments">
    <meta name="keywords" content="r, tidyverse, causal inference, DAGs, do calculus, inverse probability weighting">
    <meta name="generator" content="Hugo 0.88.1" />

    <title>
  Generating inverse probability weights for both binary and continuous treatments | Shagun Jhaver
</title>

    <link rel="canonical" href="https://www.shagunjhaver.com/blog/2020/12/01/ipw-binary-continuous/">
    <link rel="alternate" type="application/atom+xml" title="Blog Posts" href="https://www.shagunjhaver.com/atom.xml">
    <link rel="alternate" type="application/json" title="JSON Feed" href="https://www.shagunjhaver.com/feed.json">

    <link rel="openid2.provider" href="https://www.google.com/accounts/o8/ud?source=profiles">
    <link rel="openid2.local_id" href="https://www.google.com/profiles/andrewheiss">

    <meta name="twitter:card" content="summary_large_image"/>
    <meta name="twitter:image" content="https://www.shagunjhaver.com/profiles/twitter-card-large.png?v=1"/>
    <meta name="twitter:site" content="@shagunjhaver"/>
    <meta name="twitter:title" content="Generating inverse probability weights for both binary and continuous treatments"/>
    <meta name="twitter:creator" content="@shagunjhaver"/>
    <meta name="twitter:description" content="Use R to close backdoor confounding by generating and using inverse probability weights for both binary and continuous treatments"/>


    <meta property="og:title" content="Generating inverse probability weights for both binary and continuous treatments" />
<meta property="og:description" content="Use R to close backdoor confounding by generating and using inverse probability weights for both binary and continuous treatments" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://www.shagunjhaver.com/blog/2020/12/01/ipw-binary-continuous/" />
<meta property="og:image" content="https://www.shagunjhaver.com/profiles/twitter-card-large.png"/>
<meta property="article:published_time" content="2020-12-01T00:00:00+00:00" />
<meta property="article:modified_time" content="2020-12-01T00:00:00+00:00" />

<meta property="article:author" content="https://www.facebook.com/shagun.jhaver" />
<meta property="article:publisher" content="https://www.facebook.com/shagun.jhaver" />
<meta property="article:section" content="blog" />
<meta property="article:tag" content="r" />
<meta property="article:tag" content="tidyverse" />
<meta property="article:tag" content="causal inference" />
<meta property="article:tag" content="DAGs" />
<meta property="article:tag" content="do calculus" />
<meta property="article:tag" content="inverse probability weighting" />


    <meta itemprop="name" content="Generating inverse probability weights for both binary and continuous treatments">
<meta itemprop="description" content="Use R to close backdoor confounding by generating and using inverse probability weights for both binary and continuous treatments"><meta itemprop="datePublished" content="2020-12-01T00:00:00+00:00" />
<meta itemprop="dateModified" content="2020-12-01T00:00:00+00:00" />
<meta itemprop="wordCount" content="3754"><meta itemprop="image" content="https://www.shagunjhaver.com/profiles/twitter-card-large.png"/>
<meta itemprop="keywords" content="r,tidyverse,causal inference,DAGs,do calculus,inverse probability weighting," />

    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Slab:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:ital,wght@0,400;0,700;1,400;1,700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/pure-and-grids-responsive.min.css">
    <link rel="stylesheet" href="/css/ath-hugo.min.fd8cb76e3e71e1679716940ae61a1383ae9edd503b072df4bc3f709182421c76.css" integrity="sha256-/Yy3bj5x4WeXFpQK5hoTg66e3VA7By30vD9wkYJCHHY=" crossorigin="anonymous" media="screen" />

    <script src="https://kit.fontawesome.com/f9d343c40d.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jpswalsh/academicons@1/css/academicons.min.css">    

    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png?v=dLX2MbQJLG">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png?v=dLX2MbQJLG">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png?v=dLX2MbQJLG">
    <link rel="manifest" href="/site.webmanifest?v=dLX2MbQJLG">
    <link rel="mask-icon" href="/safari-pinned-tab.svg?v=dLX2MbQJLG" color="#cf4446">
    <link rel="shortcut icon" href="/favicon.ico?v=dLX2MbQJLG">
    <meta name="msapplication-TileColor" content="#170c3a">
    <meta name="theme-color" content="#170c3a">

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-527449-5', 'auto');
      ga('send', 'pageview');
    </script>
</head>

<body>

    <div id="layout" class="pure-g">
        <div id="sidebar" class="pure-u-1 pure-u-md-1-4">
            <header>
                <h1 class="title"><a href="/">Shagun Jhaver</a></h1>
                <h2 class="minibio">Social computing, CSCW, HCI, content moderation, and online harassment</h2>

                <nav id="main-nav">
                    <ul class="nav-list">
                        <li class="nav-item">
                            <a class="nav-link" href="/">About</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/cv/">CV</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/research/">Research</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/teaching/">Teaching</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/news/">News</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/now/">Now</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="/work-with-me/">Work with me!</a>
                        </li>
                    </ul>
                </nav>
            </header>

        </div> 
    
        <div id="content" class="pure-u-1 pure-u-md-3-4">
        
  <section>
    <article class="content-single">
        <header class="post-header">
            <h1 class="post-title">Generating inverse probability weights for both binary and continuous treatments</h1>

            <div class="post-meta pure-g">
                <div class="pure-u-1-2">
                    <span class="posted-on">
                        <i class="far fa-calendar-alt" aria-hidden="true"></i>
                        <time datetime='2020-12-01T00:00:00Z'>
                            Tuesday, December 1, 2020
                        </time>
                    </span>
                </div>
                <div class="reading-time pure-u-1-2">
                    <i class="far fa-clock" aria-hidden="true"></i>
                    18-minute read
                </div>
            </div>
        </header>
    
        <p>My <a href="https://evalf20.classes.andrewheiss.com/">program evaluation class</a> is basically a fun wrapper around topics in causal inference and econometrics. I’m a big fan of Judea Pearl-style <a href="https://bigthink.com/errors-we-live-by/judea-pearls-the-book-of-why-brings-news-of-a-new-science-of-causes">“causal revolution”</a> causal graphs (or <a href="https://cran.r-project.org/web/packages/ggdag/vignettes/intro-to-dags.html">DAGs</a>), and they’ve made it easier for both me and my students to understand econometric approaches like diff-in-diff, regression discontinuity, and instrumental variables.</p>
<p>DAGs are also incredibly helpful for doing causal inference with observational data <em>without</em> needing a specific quasi-experimental situation. As I show <a href="/blog/2020/02/25/closing-backdoors-dags/">in this blog post</a> (and in <a href="/research/chapters/heiss-causal-inference-2021/">this new textbook chapter!</a>), you can use DAGs to identify confounders that distort the relationship (i.e. open up backdoors) between treatment and outcome. You can then use statistical methods to close those backdoors and adjust for the confounding. In both that blog post and the chapter, I show how to do this with matching and with inverse probability weighting (IPW).</p>
<p>However, those examples assume that the treatment is binary. This is fine—lots of social programs <em>are</em> binary (used program/didn’t use program), and the math for creating inverse probability weights with binary treatment variables is fairly straightforward. However, treatment variables are also often <em>not</em> binary, especially outside of program evaluation.</p>
<p>In my own research, I’m working on a couple projects right now where the “treatment” is a count of anti-NGO legal restrictions in a country. I want to be able to use DAGs and inverse probability weighting to adjust for confounders, but I can’t use the IPW stuff I’ve been teaching because that variable isn’t binary! This research project gets even more complicated because it involves time-series cross-sectional (TSCS) data with both time-varying and time-invarying confounders, which opens up a whole other can of worms that I’ll figure out soon following <a href="#ref-BlackwellGlynn:2018">Blackwell and Glynn</a> (<a href="#ref-BlackwellGlynn:2018">2018</a>).</p>
<p>So I had to teach myself how to do IPW with continuous variables. This post shows how to calculate IPWs for both binary and continuous treatments, both manually and with a couple different R packages (<a href="https://cran.r-project.org/package=ipw"><strong>ipw</strong></a> and <a href="https://github.com/ngreifer/WeightIt"><strong>WeightIt</strong></a>).</p>
<h2 id="contents----omit-in-toc---">Contents <!-- omit in toc --></h2>
<ul>
<li><a href="#binary-treatments">Binary treatments</a>
<ul>
<li><a href="#example-data">Example data</a></li>
<li><a href="#ipw-manually-binary-treatment">IPW manually, binary treatment</a></li>
<li><a href="#ipw-with-the-ipw-package-binary-treatment">IPW with the <strong>ipw</strong> package, binary treatment</a></li>
<li><a href="#ipw-with-the-weightit-package-binary-treatment">IPW with the <strong>WeightIt</strong> package, binary treatment</a></li>
</ul>
</li>
<li><a href="#continuous-treatments">Continuous treatments</a>
<ul>
<li><a href="#example-data-1">Example data</a></li>
<li><a href="#ipw-manually-continuous-treatment">IPW manually, continuous treatment</a></li>
<li><a href="#ipw-with-the-ipw-package-continuous-treatment">IPW with the <strong>ipw</strong> package, continuous treatment</a></li>
<li><a href="#ipw-with-the-weightit-package-continuous-treatment">IPW with the <strong>WeightIt</strong> package, continuous treatment</a></li>
</ul>
</li>
<li><a href="#references">References</a></li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">library</span>(tidyverse)
<span style="color:#a6e22e">library</span>(broom)
<span style="color:#a6e22e">library</span>(scales)
<span style="color:#a6e22e">library</span>(ggdag)
<span style="color:#a6e22e">library</span>(dagitty)
<span style="color:#a6e22e">library</span>(truncnorm)
<span style="color:#a6e22e">library</span>(ipw)
<span style="color:#a6e22e">library</span>(WeightIt)
</code></pre></div><h2 id="binary-treatments">Binary treatments</h2>
<h3 id="example-data">Example data</h3>
<p>For this example, we’ll generate a DAG for a hypothetical program where bed net use causes a reduction in malaria risk. That relationship is confounded by both income and health, and income influences health. Income and health both increase the probability of net usage.</p>
<p>The treatment here is binary: either people use nets or they don’t.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">mosquito_dag <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dagify</span>(mal <span style="color:#f92672">~</span> net <span style="color:#f92672">+</span> inc <span style="color:#f92672">+</span> hlth,
                       net <span style="color:#f92672">~</span> inc <span style="color:#f92672">+</span> hlth,
                       hlth <span style="color:#f92672">~</span> inc,
                       coords <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>(x <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(mal <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>, net <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, inc <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, hlth <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>),
                                     y <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(mal <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, net <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, inc <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, hlth <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)),
                       exposure <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;net&#34;</span>,
                       outcome <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mal&#34;</span>)

<span style="color:#a6e22e">ggdag_status</span>(mosquito_dag) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">guides</span>(color <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_dag</span>()
</code></pre></div><p><img src="/blog/2020/12/01/ipw-binary-continuous/index_files/figure-html/dag-binary-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>We’ll measure these nodes like so:</p>
<ul>
<li><strong>Malaria risk</strong>: scale from 0–100, mostly around 40, but ranging from 10ish to 80ish. Best to use a Beta distribution.</li>
<li><strong>Net use</strong>: binary 0/1, TRUE/FALSE variable, where 50% of people use nets. Best to use a binomial distribution. However, since we want to use other variables that increase the likelihood of using a net, we’ll generate a latent continuous variable, rescale it to 0–1, and then use it as probabilities in <code>rbinom()</code> and assign people to treatment based on those probabilities.</li>
<li><strong>Income</strong>: weekly income, measured in dollars, mostly around 500 ± 300. Best to use a normal distribution.</li>
<li><strong>Health</strong>: scale from 0–100, mostly around 70, but ranging from 50ish to 100. Best to use a Beta distribution.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Make this randomness consistent</span>
<span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">1234</span>)

<span style="color:#75715e"># Simulate 1138 people (just for fun)</span>
n_people <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1138</span>

net_data <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tibble</span>(
  <span style="color:#75715e"># Make an ID column (not necessary, but nice to have)</span>
  id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>n_people,
  <span style="color:#75715e"># Generate income variable: normal, 500 ± 300</span>
  income <span style="color:#f92672">=</span> <span style="color:#a6e22e">rnorm</span>(n_people, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">500</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">75</span>)
) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#75715e"># Generate health variable: beta, centered around 70ish</span>
  <span style="color:#a6e22e">mutate</span>(health_base <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbeta</span>(n_people, shape1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>, shape2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>,
         <span style="color:#75715e"># Health increases by 0.02 for every dollar in income</span>
         health_income_effect <span style="color:#f92672">=</span> income <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.02</span>,
         <span style="color:#75715e"># Make the final health score and add some noise</span>
         health <span style="color:#f92672">=</span> health_base <span style="color:#f92672">+</span> health_income_effect <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(n_people, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>),
         <span style="color:#75715e"># Rescale so it doesn&#39;t go above 100</span>
         health <span style="color:#f92672">=</span> <span style="color:#a6e22e">rescale</span>(health, to <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#a6e22e">min</span>(health), <span style="color:#ae81ff">100</span>))) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#75715e"># Generate net variable based on income, health, and random noise</span>
  <span style="color:#a6e22e">mutate</span>(net_score <span style="color:#f92672">=</span> (<span style="color:#ae81ff">0.5</span> <span style="color:#f92672">*</span> income) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">1.5</span> <span style="color:#f92672">*</span> health) <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(n_people, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">15</span>),
         <span style="color:#75715e"># Scale net score down to 0.05 to 0.95 to create a probability of using a net</span>
         net_probability <span style="color:#f92672">=</span> <span style="color:#a6e22e">rescale</span>(net_score, to <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">0.05</span>, <span style="color:#ae81ff">0.95</span>)),
         <span style="color:#75715e"># Randomly generate a 0/1 variable using that probability</span>
         net <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbinom</span>(n_people, <span style="color:#ae81ff">1</span>, net_probability)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#75715e"># Finally generate a malaria risk variable based on income, health, net use,</span>
  <span style="color:#75715e"># and random noise</span>
  <span style="color:#a6e22e">mutate</span>(malaria_risk_base <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbeta</span>(n_people, shape1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>, shape2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>,
         <span style="color:#75715e"># Risk goes down by 10 when using a net. Because we rescale things,</span>
         <span style="color:#75715e"># though, we have to make the effect a lot bigger here so it scales</span>
         <span style="color:#75715e"># down to -10. Risk also decreases as health and income go up. I played</span>
         <span style="color:#75715e"># with these numbers until they created reasonable coefficients.</span>
         malaria_effect <span style="color:#f92672">=</span> (<span style="color:#ae81ff">-30</span> <span style="color:#f92672">*</span> net) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">-1.9</span> <span style="color:#f92672">*</span> health) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">-0.1</span> <span style="color:#f92672">*</span> income),
         <span style="color:#75715e"># Make the final malaria risk score and add some noise</span>
         malaria_risk <span style="color:#f92672">=</span> malaria_risk_base <span style="color:#f92672">+</span> malaria_effect <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(n_people, <span style="color:#ae81ff">0</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>),
         <span style="color:#75715e"># Rescale so it doesn&#39;t go below 0,</span>
         malaria_risk <span style="color:#f92672">=</span> <span style="color:#a6e22e">rescale</span>(malaria_risk, to <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">70</span>))) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">select</span>(<span style="color:#f92672">-</span><span style="color:#a6e22e">c</span>(health_base, health_income_effect, net_score, net_probability, 
            malaria_risk_base, malaria_effect))

<span style="color:#a6e22e">head</span>(net_data)
<span style="color:#75715e">## # A tibble: 6 x 5</span>
<span style="color:#75715e">##      id income health   net malaria_risk</span>
<span style="color:#75715e">##   &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;int&gt;        &lt;dbl&gt;</span>
<span style="color:#75715e">## 1     1   409.   63.1     0         45.1</span>
<span style="color:#75715e">## 2     2   521.   83.5     1         23.4</span>
<span style="color:#75715e">## 3     3   581.   73.0     0         36.5</span>
<span style="color:#75715e">## 4     4   324.   60.6     0         58.7</span>
<span style="color:#75715e">## 5     5   532.   73.4     1         32.7</span>
<span style="color:#75715e">## 6     6   538.   42.6     0         52.5</span>
</code></pre></div><h3 id="ipw-manually-binary-treatment">IPW manually, binary treatment</h3>
<p>If we just look at the effect of nets on malaria risk without any statistical adjustment, we see that nets cause a decrease of 13 points in malaria risk. This is wrong though because there’s confounding.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Wrong correlation-is-not-causation effect</span>
model_net_naive <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(malaria_risk <span style="color:#f92672">~</span> net, data <span style="color:#f92672">=</span> net_data)
<span style="color:#a6e22e">tidy</span>(model_net_naive)
<span style="color:#75715e">## # A tibble: 2 x 5</span>
<span style="color:#75715e">##   term        estimate std.error statistic   p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)     41.9     0.413     102.  0.       </span>
<span style="color:#75715e">## 2 net            -13.6     0.572     -23.7 2.90e-101</span>
</code></pre></div><p>According to <em>do</em>-calculus logic, we need to adjust for both income and health:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">adjustmentSets</span>(mosquito_dag)
<span style="color:#75715e">## { hlth, inc }</span>
</code></pre></div><p>We’ll do that with inverse probability weighting. First we’ll use the health and income confounders to predict the treatment, or net use, and then we’ll generate propensity scores. We’ll then use those propensity scores to generate inverse probability weights following this formula:</p>
<p>$$
\frac{\text{Treatment}}{\text{Propensity}} - \frac{1 - \text{Treatment}}{1 - \text{Propensity}}
$$</p>
<p>This formula will calculate weights for the average treatment effect (ATE). <a href="https://livefreeordichotomize.com/2019/01/17/understanding-propensity-score-weighting/#how-do-we-incorporate-a-propensity-score-in-a-weight">Lucy D’Agostino McGowan has formulas for a bunch of different IPWs</a>, including the average treatment on the treated (ATT), average treatment among the controls (ATC), and other effects.</p>
<p>Here’s how we do that with R:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Logit model to predict net use</span>
model_predict_net <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">glm</span>(net <span style="color:#f92672">~</span> income <span style="color:#f92672">+</span> health,
                         family <span style="color:#f92672">=</span> <span style="color:#a6e22e">binomial</span>(link <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;logit&#34;</span>),
                         data <span style="color:#f92672">=</span> net_data)

<span style="color:#75715e"># Generate propensity scores and IPWs</span>
net_data_ipw <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">augment_columns</span>(model_predict_net, net_data,
                                type.predict <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;response&#34;</span>) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">rename</span>(propensity <span style="color:#f92672">=</span> .fitted) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(ipw <span style="color:#f92672">=</span> (net <span style="color:#f92672">/</span> propensity) <span style="color:#f92672">+</span> ((<span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> net) <span style="color:#f92672">/</span> (<span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> propensity)))

net_data_ipw <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">select</span>(id, income, health, net, malaria_risk, propensity, ipw) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">head</span>()
<span style="color:#75715e">## # A tibble: 6 x 7</span>
<span style="color:#75715e">##      id income health   net malaria_risk propensity   ipw</span>
<span style="color:#75715e">##   &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;int&gt;        &lt;dbl&gt;      &lt;dbl&gt; &lt;dbl&gt;</span>
<span style="color:#75715e">## 1     1   409.   63.1     0         45.1      0.380  1.61</span>
<span style="color:#75715e">## 2     2   521.   83.5     1         23.4      0.628  1.59</span>
<span style="color:#75715e">## 3     3   581.   73.0     0         36.5      0.659  2.93</span>
<span style="color:#75715e">## 4     4   324.   60.6     0         58.7      0.266  1.36</span>
<span style="color:#75715e">## 5     5   532.   73.4     1         32.7      0.597  1.68</span>
<span style="color:#75715e">## 6     6   538.   42.6     0         52.5      0.459  1.85</span>
</code></pre></div><p>Finally we’ll use those weights in a regression model to find the ATE. After adjusting for confounding and closing the backdoor paths opened by income and health, <strong>the effect of nets is -10.5</strong>, which is more accurate than the naive estimate we found before. Yay!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">model_net_ipw <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(malaria_risk <span style="color:#f92672">~</span> net, data <span style="color:#f92672">=</span> net_data_ipw, weights <span style="color:#f92672">=</span> ipw)
<span style="color:#a6e22e">tidy</span>(model_net_ipw)
<span style="color:#75715e">## # A tibble: 2 x 5</span>
<span style="color:#75715e">##   term        estimate std.error statistic  p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)     40.4     0.409      98.8 0.      </span>
<span style="color:#75715e">## 2 net            -10.5     0.578     -18.3 1.83e-65</span>
</code></pre></div><h3 id="ipw-with-the-ipw-package-binary-treatment">IPW with the <strong>ipw</strong> package, binary treatment</h3>
<p>Instead of running a logistic regression model and generating propensity scores by hand, we can use the <strong>ipw</strong> package to generate that <code>ipw</code> column automatically. Specify the confounders in the <code>denominator</code> argument. There’s a <code>numerator</code> argument too that we can use for generating stabilized weights, but we’ll skip that for now.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># ipwpoint() can&#39;t handle tibbles! Force net_data to be a data.frame</span>
weights_ipwpoint <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ipwpoint</span>(
  exposure <span style="color:#f92672">=</span> net,
  family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;binomial&#34;</span>,  <span style="color:#75715e"># The treatment is binary</span>
  link <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;logit&#34;</span>,
  denominator <span style="color:#f92672">=</span> <span style="color:#f92672">~</span> income <span style="color:#f92672">+</span> health,
  data <span style="color:#f92672">=</span> <span style="color:#a6e22e">as.data.frame</span>(net_data)
)

<span style="color:#75715e"># They&#39;re the same!</span>
<span style="color:#a6e22e">head</span>(weights_ipwpoint<span style="color:#f92672">$</span>ipw.weights)
<span style="color:#75715e">## [1] 1.61 1.59 2.93 1.36 1.68 1.85</span>
<span style="color:#a6e22e">head</span>(net_data_ipw<span style="color:#f92672">$</span>ipw)
<span style="color:#75715e">## [1] 1.61 1.59 2.93 1.36 1.68 1.85</span>
</code></pre></div><p>The resulting <code>weights</code> object here is a standalone object, and you can do other things with it like <code>summary()</code>. We can add the weights back into the main data and then fit the final model (<em>technically</em> we don’t need to—we could just say <code>weights = weights_ipwpoint$ipw.weights</code> and it would work just fine, but I don’t like working with standalone vectors and prefer to have them be columns, just so everything is all together in one place).</p>
<p>We get the same ATE of -10.5.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">net_data_ipwpoint <span style="color:#f92672">&lt;-</span> net_data <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(ipw <span style="color:#f92672">=</span> weights_ipwpoint<span style="color:#f92672">$</span>ipw.weights)

model_net_ipwpoint <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(malaria_risk <span style="color:#f92672">~</span> net, 
                         data <span style="color:#f92672">=</span> net_data_ipwpoint, weights <span style="color:#f92672">=</span> ipw)
<span style="color:#a6e22e">tidy</span>(model_net_ipwpoint)
<span style="color:#75715e">## # A tibble: 2 x 5</span>
<span style="color:#75715e">##   term        estimate std.error statistic  p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)     40.4     0.409      98.8 0.      </span>
<span style="color:#75715e">## 2 net            -10.5     0.578     -18.3 1.83e-65</span>
</code></pre></div><h3 id="ipw-with-the-weightit-package-binary-treatment">IPW with the <strong>WeightIt</strong> package, binary treatment</h3>
<p>We can also use <a href="https://ngreifer.github.io/WeightIt/articles/WeightIt.html">the <strong>WeightIt</strong> package</a> to generate weights. It has slightly different syntax and can find all sorts of different estimands beyond the ATE (like <a href="https://livefreeordichotomize.com/2019/01/17/understanding-propensity-score-weighting/#how-do-we-incorporate-a-propensity-score-in-a-weight">most of the ones Lucy has listed</a>). It can also handle a bunch of different methods beyond propensity scores. <strong>WeightIt</strong> can also handle tibbles, which is nice. It <em>also</em> provides a bunch of other summary information (if you use <code>summary()</code>), like effective sample sizes (ESS) in the treated/untreated groups and covariate balance.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">weights_weightit <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">weightit</span>(net <span style="color:#f92672">~</span> income <span style="color:#f92672">+</span> health,  <span style="color:#75715e"># Model net use with confounders</span>
                             data <span style="color:#f92672">=</span> net_data, 
                             estimand <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ATE&#34;</span>,  <span style="color:#75715e"># Find the ATE</span>
                             method <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ps&#34;</span>)  <span style="color:#75715e"># Build weights with propensity scores</span>
weights_weightit
<span style="color:#75715e">## A weightit object</span>
<span style="color:#75715e">##  - method: &#34;ps&#34; (propensity score weighting)</span>
<span style="color:#75715e">##  - number of obs.: 1138</span>
<span style="color:#75715e">##  - sampling weights: none</span>
<span style="color:#75715e">##  - treatment: 2-category</span>
<span style="color:#75715e">##  - estimand: ATE</span>
<span style="color:#75715e">##  - covariates: income, health</span>

<span style="color:#75715e"># See even more details here</span>
<span style="color:#75715e"># summary(weights_weightit)</span>

<span style="color:#75715e"># Same as the other methods!</span>
<span style="color:#a6e22e">head</span>(weights_weightit<span style="color:#f92672">$</span>weights)
<span style="color:#75715e">## [1] 1.61 1.59 2.93 1.36 1.68 1.85</span>
</code></pre></div><p>As with <strong>ipw</strong>, we can add the weights to the dataset and run the model to find the same -10.5 ATE:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">net_data_weightit <span style="color:#f92672">&lt;-</span> net_data <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(ipw <span style="color:#f92672">=</span> weights_weightit<span style="color:#f92672">$</span>weights)

model_net_weightit <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(malaria_risk <span style="color:#f92672">~</span> net, 
                         data <span style="color:#f92672">=</span> net_data_weightit, weights <span style="color:#f92672">=</span> ipw)
<span style="color:#a6e22e">tidy</span>(model_net_weightit)
<span style="color:#75715e">## # A tibble: 2 x 5</span>
<span style="color:#75715e">##   term        estimate std.error statistic  p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)     40.4     0.409      98.8 0.      </span>
<span style="color:#75715e">## 2 net            -10.5     0.578     -18.3 1.83e-65</span>
</code></pre></div><h2 id="continuous-treatments">Continuous treatments</h2>
<h3 id="example-data-1">Example data</h3>
<p>Inverse probability weights work with continuous treatment variables too, but the math is a <del>little</del> lot trickier. For this example, we’ll generate a DAG for a hypothetical program where poorer families are given cash grants that they can spend on malaria prevention supplies, like mosquito nets, chemical treatments, and medication. It’s a voluntary program—people self select into it, and we’ll assume that people with lower health scores and lower income will sign up. The amount of the grant depends on income.</p>
<p>The treatment here is continuous: people get different amounts of anti-malaria grant money. For the sake of simplicity here, everyone gets some grant money. I’m not even going to try multilevel zero-inflated models or anything (<a href="https://vuorre.netlify.app/post/2019/02/18/analyze-analog-scale-ratings-with-zero-one-inflated-beta-models/">though those are cool!</a>).</p>
<p>The DAG looks the same as before (since we’re trying to keep things super simple here):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">grant_dag <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dagify</span>(mal <span style="color:#f92672">~</span> grant <span style="color:#f92672">+</span> inc <span style="color:#f92672">+</span> hlth,
                    grant <span style="color:#f92672">~</span> inc <span style="color:#f92672">+</span> hlth,
                    hlth <span style="color:#f92672">~</span> inc,
                    coords <span style="color:#f92672">=</span> <span style="color:#a6e22e">list</span>(x <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(mal <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>, grant <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, inc <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, hlth <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>),
                                  y <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(mal <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, grant <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span>, inc <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>, hlth <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>)),
                    exposure <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;grant&#34;</span>,
                    outcome <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;mal&#34;</span>)

<span style="color:#a6e22e">ggdag_status</span>(grant_dag) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">guides</span>(color <span style="color:#f92672">=</span> <span style="color:#66d9ef">FALSE</span>) <span style="color:#f92672">+</span>
  <span style="color:#a6e22e">theme_dag</span>()
</code></pre></div><p><img src="/blog/2020/12/01/ipw-binary-continuous/index_files/figure-html/dag-continuous-1.png" width="75%" style="display: block; margin: auto;" /></p>
<p>We’ll measure these nodes like so:</p>
<ul>
<li><strong>Malaria risk</strong>: scale from 0–100, mostly around 40, but ranging from 10ish to 80ish. Best to use a Beta distribution.</li>
<li><strong>Grant</strong>: amount between 5 and 40, centered around 20ish.</li>
<li><strong>Income</strong>: weekly income, measured in dollars, mostly around 500 ± 300. Best to use a normal distribution.</li>
<li><strong>Health</strong>: scale from 0–100, mostly around 70, but ranging from 50ish to 100. Best to use a Beta distribution.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Make this randomness consistent</span>
<span style="color:#a6e22e">set.seed</span>(<span style="color:#ae81ff">1234</span>)

<span style="color:#75715e"># Simulate 1504 people</span>
n_people <span style="color:#f92672">&lt;-</span> <span style="color:#ae81ff">1504</span>

grant_data <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">tibble</span>(
  <span style="color:#75715e"># Make an ID column (not necessary, but nice to have)</span>
  id <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>n_people,
  <span style="color:#75715e"># Generate income variable: normal, 500 ± 300</span>
  income <span style="color:#f92672">=</span> <span style="color:#a6e22e">rnorm</span>(n_people, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">500</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">75</span>)
) <span style="color:#f92672">%&gt;%</span>
  <span style="color:#75715e"># Generate health variable: beta, centered around 70ish</span>
  <span style="color:#a6e22e">mutate</span>(health_base <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbeta</span>(n_people, shape1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span>, shape2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>,
         <span style="color:#75715e"># Health increases by 0.02 for every dollar in income</span>
         health_income_effect <span style="color:#f92672">=</span> income <span style="color:#f92672">*</span> <span style="color:#ae81ff">0.02</span>,
         <span style="color:#75715e"># Make the final health score and add some noise</span>
         health <span style="color:#f92672">=</span> health_base <span style="color:#f92672">+</span> health_income_effect <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(n_people, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>),
         <span style="color:#75715e"># Rescale so it doesn&#39;t go above 100</span>
         health <span style="color:#f92672">=</span> <span style="color:#a6e22e">rescale</span>(health, to <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#a6e22e">min</span>(health), <span style="color:#ae81ff">100</span>))) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#75715e"># Generate grant variable</span>
  <span style="color:#a6e22e">mutate</span>(grant_base <span style="color:#f92672">=</span> <span style="color:#a6e22e">rtruncnorm</span>(n_people, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">18</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>, a <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>, b <span style="color:#f92672">=</span> <span style="color:#ae81ff">40</span>),
         <span style="color:#75715e"># Grants are higher for people with lower incomes; higher for people with lower health</span>
         grant_effect <span style="color:#f92672">=</span> (income <span style="color:#f92672">*</span> <span style="color:#ae81ff">-0.25</span>) <span style="color:#f92672">+</span> (health <span style="color:#f92672">*</span> <span style="color:#ae81ff">-0.5</span>),
         <span style="color:#75715e"># Make the final grant amount + noise + rescale it back down</span>
         grant <span style="color:#f92672">=</span> grant_base <span style="color:#f92672">+</span> grant_effect <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(n_people, mean <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">8</span>),
         grant <span style="color:#f92672">=</span> <span style="color:#a6e22e">round</span>(<span style="color:#a6e22e">rescale</span>(grant, to <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">40</span>)), <span style="color:#ae81ff">0</span>)) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#75715e"># Finally generate a malaria risk variable based on income, health, grant amount,</span>
  <span style="color:#75715e"># and random noise</span>
  <span style="color:#a6e22e">mutate</span>(malaria_risk_base <span style="color:#f92672">=</span> <span style="color:#a6e22e">rbeta</span>(n_people, shape1 <span style="color:#f92672">=</span> <span style="color:#ae81ff">4</span>, shape2 <span style="color:#f92672">=</span> <span style="color:#ae81ff">5</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">100</span>,
         <span style="color:#75715e"># Risk goes down as grant money goes up. I played with these numbers</span>
         <span style="color:#75715e"># until they created reasonable coefficients.</span>
         malaria_effect <span style="color:#f92672">=</span> (<span style="color:#ae81ff">-40</span> <span style="color:#f92672">*</span> grant) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">-25</span> <span style="color:#f92672">*</span> health) <span style="color:#f92672">+</span> (<span style="color:#ae81ff">-0.05</span> <span style="color:#f92672">*</span> income),
         <span style="color:#75715e"># Make the final malaria risk score and add some noise</span>
         malaria_risk <span style="color:#f92672">=</span> malaria_risk_base <span style="color:#f92672">+</span> malaria_effect <span style="color:#f92672">+</span> <span style="color:#a6e22e">rnorm</span>(n_people, <span style="color:#ae81ff">0</span>, sd <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>),
         <span style="color:#75715e"># Rescale so it doesn&#39;t go below 0,</span>
         malaria_risk <span style="color:#f92672">=</span> <span style="color:#a6e22e">rescale</span>(malaria_risk, to <span style="color:#f92672">=</span> <span style="color:#a6e22e">c</span>(<span style="color:#ae81ff">5</span>, <span style="color:#ae81ff">70</span>))) <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">select</span>(<span style="color:#f92672">-</span><span style="color:#a6e22e">c</span>(health_base, health_income_effect, grant_base, grant_effect, 
            malaria_risk_base, malaria_effect))

<span style="color:#a6e22e">head</span>(grant_data)
<span style="color:#75715e">## # A tibble: 6 x 5</span>
<span style="color:#75715e">##      id income health grant malaria_risk</span>
<span style="color:#75715e">##   &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;        &lt;dbl&gt;</span>
<span style="color:#75715e">## 1     1   409.   70.2    27         26.3</span>
<span style="color:#75715e">## 2     2   521.   75.3    18         33.3</span>
<span style="color:#75715e">## 3     3   581.   62.6    20         42.3</span>
<span style="color:#75715e">## 4     4   324.   83.9    28         11.8</span>
<span style="color:#75715e">## 5     5   532.   74.3    20         31.8</span>
<span style="color:#75715e">## 6     6   538.   75.9    15         36.2</span>
</code></pre></div><h3 id="ipw-manually-continuous-treatment">IPW manually, continuous treatment</h3>
<p>If we just look at the effect of grants on malaria risk without any adjustment, every extra grant dollar causes a drop of 0.4 malaria risk points. Once again, though, this is wrong because of confounding.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Wrong correlation-is-not-causation effect</span>
model_grant_naive <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(malaria_risk <span style="color:#f92672">~</span> grant, data <span style="color:#f92672">=</span> grant_data)
<span style="color:#a6e22e">tidy</span>(model_grant_naive)
<span style="color:#75715e">## # A tibble: 2 x 5</span>
<span style="color:#75715e">##   term        estimate std.error statistic   p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)   44.2      1.35       32.8  2.56e-178</span>
<span style="color:#75715e">## 2 grant         -0.417    0.0615     -6.78 1.69e- 11</span>
</code></pre></div><p>According to <em>do</em>-calculus logic, we again need to adjust for both income and health:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#a6e22e">adjustmentSets</span>(grant_dag)
<span style="color:#75715e">## { hlth, inc }</span>
</code></pre></div><p>Here’s where the math gets tricky. When we worked with a binary treatment, we calculated the propensity score for each observation and then used this formula to generate inverse probability weights:</p>
<p>$$
\frac{\text{Treatment}}{\text{Propensity}} - \frac{1 - \text{Treatment}}{1 - \text{Propensity}}
$$</p>
<p>We can’t do that with continuous treatment variables, though, since we don’t really have propensity scores. Instead, we use this hairy-but-not-too-scary formula (from <a href="#ref-NaimiMoodieAuger:2014">Naimi et al.</a> (<a href="#ref-NaimiMoodieAuger:2014">2014</a>); <a href="http://www.jayskaufman.com/uploads/3/0/8/9/30891283/naimi_constructing_ipw_for_continuous_exposures_epidemiology_2014.pdf">ungated version here</a>; also <a href="https://meghapsimatrix.com/post/continuous-r-rmarkdown/">see this for another R example</a>):</p>
<p>$$
\text{IPW} = \frac{f_X (X; \mu_1, \sigma^2_1)}{f_{X | C} (X | C = c; \mu_2, \sigma^2_2)}
$$</p>
<p>Phew. That’s a lot of math, but it’s not too bad if we take it apart:</p>
<ul>
<li><code>\(X\)</code> stands for the continuous exposure or treatment variable</li>
<li><code>\(C\)</code> stands for the confounders</li>
<li>The <code>\(f_\cdot (\cdot)\)</code> function in both the numerator and denominator stands for a probability density function with a mean of <code>\(\mu\)</code> and a variance of <code>\(\sigma^2\)</code></li>
<li>The numerator <code>\(f_X (X; \mu_1, \sigma^2_1)\)</code> refers to the probability distribution of just the treatment variable (technically you could just use 1 as the numerator, but that can lead to unstable weights—using the probability distribution of the treatment helps stabilize the weights)</li>
<li>The denominator <code>\(f_{X | C} (X | C = c; \mu_2, \sigma^2_2)\)</code> refers to the probability distribution of the treatment variable explained by the confounders</li>
</ul>
<p>(Fun fact: I’m like 85% sure that the <code>\(\frac{\text{Treatment}}{\text{Propensity}} - \frac{1 - \text{Treatment}}{1 - \text{Propensity}}\)</code> formula is just an algebraically rearranged and simplified version of this fancier equation)</p>
<p>We can calculate each element of this fraction and then generate the inverse probability weights. Here’s how to do that with R:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># The numerator is the probability distribution of just the treatment variable.</span>
<span style="color:#75715e"># We&#39;ll use a normal distribution for it (hence dnorm()). We need to feed</span>
<span style="color:#75715e"># dnorm() the grant amount for each person, the predicted value from a simple</span>
<span style="color:#75715e"># grant ~ 1 model, and the sd of the residuals from that model</span>
model_num <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(grant <span style="color:#f92672">~</span> <span style="color:#ae81ff">1</span>, data <span style="color:#f92672">=</span> grant_data)
num <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dnorm</span>(grant_data<span style="color:#f92672">$</span>grant,
             <span style="color:#a6e22e">predict</span>(model_num),
             <span style="color:#a6e22e">sd</span>(model_num<span style="color:#f92672">$</span>residuals))

<span style="color:#75715e"># The denominator is the probability distribution of the treatment variable</span>
<span style="color:#75715e"># explained by the confounders. We&#39;ll again use a normal distribution for it.</span>
<span style="color:#75715e"># We&#39;ll feed dnorm() the grant amount, the predicted value from a model that</span>
<span style="color:#75715e"># includes the confounders, and the sd of the residuals from that model</span>
model_den <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(grant <span style="color:#f92672">~</span> health <span style="color:#f92672">+</span> income, data <span style="color:#f92672">=</span> grant_data)
den <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">dnorm</span>(grant_data<span style="color:#f92672">$</span>grant,
             <span style="color:#a6e22e">predict</span>(model_den),
             <span style="color:#a6e22e">sd</span>(model_den<span style="color:#f92672">$</span>residuals))

<span style="color:#75715e"># Finally, we make actual IPW weights by building the fraction</span>
grant_data_ipw <span style="color:#f92672">&lt;-</span> grant_data <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(ipw <span style="color:#f92672">=</span> num <span style="color:#f92672">/</span> den)

<span style="color:#a6e22e">head</span>(grant_data_ipw)
<span style="color:#75715e">## # A tibble: 6 x 6</span>
<span style="color:#75715e">##      id income health grant malaria_risk   ipw</span>
<span style="color:#75715e">##   &lt;int&gt;  &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt;        &lt;dbl&gt; &lt;dbl&gt;</span>
<span style="color:#75715e">## 1     1   409.   70.2    27         26.3 0.288</span>
<span style="color:#75715e">## 2     2   521.   75.3    18         33.3 0.492</span>
<span style="color:#75715e">## 3     3   581.   62.6    20         42.3 0.687</span>
<span style="color:#75715e">## 4     4   324.   83.9    28         11.8 0.177</span>
<span style="color:#75715e">## 5     5   532.   74.3    20         31.8 0.499</span>
<span style="color:#75715e">## 6     6   538.   75.9    15         36.2 0.748</span>
</code></pre></div><p>Now we can use the weights to find the ATE just like we did with the binary treatment:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">model_grant_ipw <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(malaria_risk <span style="color:#f92672">~</span> grant, data <span style="color:#f92672">=</span> grant_data_ipw, weights <span style="color:#f92672">=</span> ipw)
<span style="color:#a6e22e">tidy</span>(model_grant_ipw)
<span style="color:#75715e">## # A tibble: 2 x 5</span>
<span style="color:#75715e">##   term        estimate std.error statistic   p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)    58.4     1.79        32.6 1.95e-176</span>
<span style="color:#75715e">## 2 grant          -1.11    0.0806     -13.7 1.45e- 40</span>
</code></pre></div><p>Each dollar of grant money thus <strong>causes a drop of -1.1 malaria risk points</strong>. Neato!</p>
<h3 id="ipw-with-the-ipw-package-continuous-treatment">IPW with the <strong>ipw</strong> package, continuous treatment</h3>
<p>Manually creating the numerator and denominator can get tedious though. We can use the <code>ipwpoint()</code> function from <strong>ipw</strong> to generate continuous weights in one step. Instead of specifying a binomial treatment like we did before, we’ll use a Gaussian (normal) family. We also specify both the numerator and denominator. It will generate identical weights.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">weights_continuous_ipwpoint <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">ipwpoint</span>(
  exposure <span style="color:#f92672">=</span> grant,
  family <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;gaussian&#34;</span>,
  numerator <span style="color:#f92672">=</span> <span style="color:#f92672">~</span> <span style="color:#ae81ff">1</span>,
  denominator <span style="color:#f92672">=</span> <span style="color:#f92672">~</span> health <span style="color:#f92672">+</span> income,
  data <span style="color:#f92672">=</span> <span style="color:#a6e22e">as.data.frame</span>(grant_data)
)

<span style="color:#75715e"># Same values!</span>
<span style="color:#a6e22e">head</span>(grant_data_ipw<span style="color:#f92672">$</span>ipw)
<span style="color:#75715e">## [1] 0.288 0.492 0.687 0.177 0.499 0.748</span>
<span style="color:#a6e22e">head</span>(weights_continuous_ipwpoint<span style="color:#f92672">$</span>ipw.weights)
<span style="color:#75715e">## [1] 0.288 0.492 0.687 0.177 0.499 0.748</span>
</code></pre></div><p>We can then put those weights into the dataset and run a model with them. We get the same ATE of -1.1:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">grant_data_ipwpoint <span style="color:#f92672">&lt;-</span> grant_data <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(ipw <span style="color:#f92672">=</span> weights_continuous_ipwpoint<span style="color:#f92672">$</span>ipw.weights)

model_grant_ipwpoint <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(malaria_risk <span style="color:#f92672">~</span> grant, 
                           data <span style="color:#f92672">=</span> grant_data_ipwpoint, weights <span style="color:#f92672">=</span> ipw)
<span style="color:#a6e22e">tidy</span>(model_grant_ipwpoint)
<span style="color:#75715e">## # A tibble: 2 x 5</span>
<span style="color:#75715e">##   term        estimate std.error statistic   p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)    58.4     1.79        32.6 1.95e-176</span>
<span style="color:#75715e">## 2 grant          -1.11    0.0806     -13.7 1.45e- 40</span>
</code></pre></div><h3 id="ipw-with-the-weightit-package-continuous-treatment">IPW with the <strong>WeightIt</strong> package, continuous treatment</h3>
<p>The <strong>WeightIt</strong> package also handles continuous weights. The syntax is a lot simpler—there’s no need to worry about numerators and denominators.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">weights_weightit <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">weightit</span>(grant <span style="color:#f92672">~</span> income <span style="color:#f92672">+</span> health,  <span style="color:#75715e"># Model grant amount with confounders</span>
                             data <span style="color:#f92672">=</span> grant_data, 
                             stabilize <span style="color:#f92672">=</span> <span style="color:#66d9ef">TRUE</span>)
weights_weightit
<span style="color:#75715e">## A weightit object</span>
<span style="color:#75715e">##  - method: &#34;ps&#34; (propensity score weighting)</span>
<span style="color:#75715e">##  - number of obs.: 1504</span>
<span style="color:#75715e">##  - sampling weights: none</span>
<span style="color:#75715e">##  - treatment: continuous</span>
<span style="color:#75715e">##  - covariates: income, health</span>

<span style="color:#75715e"># See even more details here</span>
<span style="color:#75715e"># summary(weights_weightit)</span>

<span style="color:#75715e"># Not the same as the other methods :(</span>
<span style="color:#a6e22e">head</span>(weights_weightit<span style="color:#f92672">$</span>weights)
<span style="color:#75715e">## [1] 0.580 0.990 1.384 0.356 1.005 1.506</span>
</code></pre></div><p>However(!), for mathy reasons I don’t understand, the weights it generates are not the same as what we get when doing it by hand or with <code>ipwpoint()</code>. In fact, they’re almost exactly twice as large as the manual and <code>ipwpoint()</code> weights:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r"><span style="color:#75715e"># Manual weights</span>
<span style="color:#a6e22e">head</span>(grant_data_ipw<span style="color:#f92672">$</span>ipw)
<span style="color:#75715e">## [1] 0.288 0.492 0.687 0.177 0.499 0.748</span>

<span style="color:#75715e"># weightit() weights / 2</span>
<span style="color:#a6e22e">head</span>(weights_weightit<span style="color:#f92672">$</span>weights) <span style="color:#f92672">/</span> <span style="color:#ae81ff">2</span>
<span style="color:#75715e">## [1] 0.290 0.495 0.692 0.178 0.502 0.753</span>
</code></pre></div><p>Surely there’s an argument to <code>weightit()</code> that I’m missing somewhere.</p>
<p>Regardless, for more mathy reasons I don’t understand, the ATE is identical even though the weights are roughly doubled:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-r" data-lang="r">grant_data_weightit <span style="color:#f92672">&lt;-</span> grant_data <span style="color:#f92672">%&gt;%</span> 
  <span style="color:#a6e22e">mutate</span>(ipw <span style="color:#f92672">=</span> weights_weightit<span style="color:#f92672">$</span>weights)

model_grant_weightit <span style="color:#f92672">&lt;-</span> <span style="color:#a6e22e">lm</span>(malaria_risk <span style="color:#f92672">~</span> grant, 
                           data <span style="color:#f92672">=</span> grant_data_weightit, weights <span style="color:#f92672">=</span> ipw)
<span style="color:#a6e22e">tidy</span>(model_grant_weightit)
<span style="color:#75715e">## # A tibble: 2 x 5</span>
<span style="color:#75715e">##   term        estimate std.error statistic   p.value</span>
<span style="color:#75715e">##   &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;</span>
<span style="color:#75715e">## 1 (Intercept)    58.4     1.79        32.6 1.95e-176</span>
<span style="color:#75715e">## 2 grant          -1.11    0.0806     -13.7 1.45e- 40</span>
</code></pre></div><h2 id="references">References</h2>
<div id="refs" class="references csl-bib-body hanging-indent">
<div id="ref-BlackwellGlynn:2018" class="csl-entry">
<p>Blackwell, Matthew, and Adam N. Glynn. 2018. “How to Make Causal Inferences with Time-Series Cross-Sectional Data Under Selection on Observables.” <em>American Political Science Review</em> 112 (4): 1067–82. <a href="https://doi.org/10.1017/s0003055418000357">https://doi.org/10.1017/s0003055418000357</a>.</p>
</div>
<div id="ref-NaimiMoodieAuger:2014" class="csl-entry">
<p>Naimi, Ashley I., Erica E. M. Moodie, Nathalie Auger, and Jay S. Kaufman. 2014. “Constructing Inverse Probability Weights for Continuous Exposures; a Comparison of Methods.” <em>Epidemiology</em> 25 (2): 292–99. <a href="https://doi.org/10.1097/eDe.0000000000000053">https://doi.org/10.1097/eDe.0000000000000053</a>.</p>
</div>
</div>

    
        <footer>
            <div class="tags">
    <i class="fas fa-tags" aria-hidden="true"></i>&ensp;
    <a href="/blog/tags/r/">r</a>
    <span class="separator">•</span>
    <a href="/blog/tags/tidyverse/">tidyverse</a>
    <span class="separator">•</span>
    <a href="/blog/tags/causal-inference/">causal inference</a>
    <span class="separator">•</span>
    <a href="/blog/tags/dags/">DAGs</a>
    <span class="separator">•</span>
    <a href="/blog/tags/do-calculus/">do calculus</a>
    <span class="separator">•</span>
    <a href="/blog/tags/inverse-probability-weighting/">inverse probability weighting</a></div>

        </footer>

        <div id="comments">
            <div id="disqus_thread"></div>
            <script type="text/javascript">
                 
                var disqus_shortname = 'andrewheisscom';
                var disqus_title = document.title;
                var disqus_url = 'https:\/\/www.shagunjhaver.com\/blog\/2020\/12\/01\/ipw-binary-continuous\/';

                 
                (function () {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
                    Disqus.</a></noscript>
        </div>
    </article>
</section>

  

<script src="/js/math-code.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js"></script>
<script>
    MathJax = {
        tex: {
            inlineMath: [
                ['$', '$'], ['\\(', '\\)']
            ],
            processEscapes: true,
            processEnvironments: true
        },
        options: {
            skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
        }
    };
</script>

        </div> 
    </div> 
    
    <div id="footer">
        <footer>
    <ul class="links">
        <li>
            <a href="mailto:shagun.jhaver@rutgers.edu" aria-label="E-mail"   >
                <i class="fa fa-envelope" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://medium.com/@shagunjhaver" aria-label="Medium"   >
                <i class="fab fa-medium" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://scholar.google.com/citations?user=OgtKT6UAAAAJ" aria-label="Google Scholar"   >
                <i class="ai ai-google-scholar" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://dl.acm.org/author_page.cfm?id=99658987207" aria-label="ACM Digital Library"   >
                <i class="ai ai-acmdl-square" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://github.com/shaguniitb" aria-label="GitHub"   >
                <i class="fab fa-github" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://twitter.com/shagunjhaver" aria-label="Twitter"   >
                <i class="fab fa-twitter" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://www.facebook.com/shagun.jhaver" aria-label="Facebook"   >
                <i class="fab fa-facebook" aria-hidden="true"></i>
            </a>
        </li>
        <li>
            <a href="https://www.linkedin.com/in/shagun-jhaver/" aria-label="LinkedIn"   >
                <i class="fab fa-linkedin" aria-hidden="true"></i>
            </a>
        </li>
    </ul>

    <p class="colophon"> <i class="fas fa-map-marker-alt"></i> New Brunswick, NJ </p>
    <p class="colophon">ORCID iD: <a href="https://orcid.org/0000-0002-6728-7101">0000-0002-6728-7101</a></p>

   <p class="colophon">
    This site is a derivative of <a href="https://github.com/andrewheiss/ath-hugo">ath-hugo</a> by Andrew Heiss, used under CC <a href="https://creativecommons.org/licenses/by-sa/4.0/legalcode">4.0</a>.
   </p>


    <p class="colophon"><a href="https://github.com/shaguniitb/ath-hugo">Code for site</a></p>
</footer>

    </div>

</body>

</html>
